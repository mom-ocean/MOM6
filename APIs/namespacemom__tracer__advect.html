<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_tracer_advect Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__tracer__advect.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_tracer_advect Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This program contains the subroutines that advect tracers along coordinate surfaces. </p>
<p>This program contains the subroutines that advect tracers horizontally (i.e. along layers).</p>
<h1><a class="anchor" id="section_mom_advect_intro"></a>
section_mom_advect_intro</h1>
<ul>
<li>advect_tracer advects tracer concentrations using a combination of the modified flux advection scheme from Easter (Mon. Wea. Rev., 1993) with tracer distributions given by the monotonic modified van Leer scheme proposed by Lin et al. (Mon. Wea. Rev., 1994). This scheme conserves the total amount of tracer while avoiding spurious maxima and minima of the tracer concentration. If a higher order accuracy scheme is needed, suggest monotonic piecewise parabolic method, as described in Carpenter et al. (MWR, 1990).</li>
<li>advect_tracer has 4 arguments, described below. This subroutine determines the volume of a layer in a grid cell at the previous instance when the tracer concentration was changed, so it is essential that the volume fluxes should be correct. It is also important that the tracer advection occurs before each calculation of the diabatic forcing. </li>
</ul>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__tracer__advect_1_1tracer__advect__cs.html">tracer_advect_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure for this module.  <a href="structmom__tracer__advect_1_1tracer__advect__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a4c97e84c1a3c433d0c2e84b57926bc08"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a4c97e84c1a3c433d0c2e84b57926bc08">advect_tracer</a> (h_end, uhtr, vhtr, OBC, dt, G, GV, CS, Reg, h_prev_opt, max_iter_in, x_first_in, uhr_out, vhr_out, h_out)</td></tr>
<tr class="memdesc:a4c97e84c1a3c433d0c2e84b57926bc08"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine time steps the tracer concentration using a monotonic, conservative, weakly diffusive scheme.  <a href="#a4c97e84c1a3c433d0c2e84b57926bc08">More...</a><br /></td></tr>
<tr class="separator:a4c97e84c1a3c433d0c2e84b57926bc08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a642efcd418e9c8abfeff1f3c9fb79122"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a642efcd418e9c8abfeff1f3c9fb79122">advect_x</a> (Tr, hprev, uhr, uh_neglect, OBC, domore_u, ntr, Idt, is, ie, js, je, k, G, GV, usePPM, useHuynh)</td></tr>
<tr class="memdesc:a642efcd418e9c8abfeff1f3c9fb79122"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does 1-d flux-form advection in the zonal direction using a monotonic piecewise linear scheme.  <a href="#a642efcd418e9c8abfeff1f3c9fb79122">More...</a><br /></td></tr>
<tr class="separator:a642efcd418e9c8abfeff1f3c9fb79122"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ad4bd56b70992ba99f6dce298ff15fa"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a6ad4bd56b70992ba99f6dce298ff15fa">advect_y</a> (Tr, hprev, vhr, vh_neglect, OBC, domore_v, ntr, Idt, is, ie, js, je, k, G, GV, usePPM, useHuynh)</td></tr>
<tr class="memdesc:a6ad4bd56b70992ba99f6dce298ff15fa"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does 1-d flux-form advection using a monotonic piecewise linear scheme.  <a href="#a6ad4bd56b70992ba99f6dce298ff15fa">More...</a><br /></td></tr>
<tr class="separator:a6ad4bd56b70992ba99f6dce298ff15fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e4b29db7016edd0aa8acf9f60f3e919"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a9e4b29db7016edd0aa8acf9f60f3e919">tracer_advect_init</a> (Time, G, param_file, diag, CS)</td></tr>
<tr class="memdesc:a9e4b29db7016edd0aa8acf9f60f3e919"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize lateral tracer advection module.  <a href="#a9e4b29db7016edd0aa8acf9f60f3e919">More...</a><br /></td></tr>
<tr class="separator:a9e4b29db7016edd0aa8acf9f60f3e919"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e466a8a34546bb9265a74ff0209df47"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a2e466a8a34546bb9265a74ff0209df47">tracer_advect_end</a> (CS)</td></tr>
<tr class="memdesc:a2e466a8a34546bb9265a74ff0209df47"><td class="mdescLeft">&#160;</td><td class="mdescRight">Close the tracer advection module.  <a href="#a2e466a8a34546bb9265a74ff0209df47">More...</a><br /></td></tr>
<tr class="separator:a2e466a8a34546bb9265a74ff0209df47"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a951134d3dcb3508f71abb05dc39837cc"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a951134d3dcb3508f71abb05dc39837cc">id_clock_advect</a></td></tr>
<tr class="separator:a951134d3dcb3508f71abb05dc39837cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6590ebd9b76b6d5fea6d13e2deb0c271"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a6590ebd9b76b6d5fea6d13e2deb0c271">id_clock_pass</a></td></tr>
<tr class="separator:a6590ebd9b76b6d5fea6d13e2deb0c271"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f1598f314da682e38e10f560bb94428"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__tracer__advect.html#a4f1598f314da682e38e10f560bb94428">id_clock_sync</a></td></tr>
<tr class="separator:a4f1598f314da682e38e10f560bb94428"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a4c97e84c1a3c433d0c2e84b57926bc08"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4c97e84c1a3c433d0c2e84b57926bc08">&#9670;&nbsp;</a></span>advect_tracer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_advect::advect_tracer </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tracer__advect_1_1tracer__advect__cs.html">tracer_advect_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_registry_type), pointer&#160;</td>
          <td class="paramname"><em>Reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), optional&#160;</td>
          <td class="paramname"><em>h_prev_opt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, optional&#160;</td>
          <td class="paramname"><em>max_iter_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, optional&#160;</td>
          <td class="paramname"><em>x_first_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>uhr_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>vhr_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), optional&#160;</td>
          <td class="paramname"><em>h_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This routine time steps the tracer concentration using a monotonic, conservative, weakly diffusive scheme. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_end</td><td>layer thickness after advection (m or kg m-2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">uhtr</td><td>accumulated volume/mass flux through zonal face (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">vhtr</td><td>accumulated volume/mass flux through merid face (m3 or kg)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>specifies whether, where, and what OBCs are used</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time increment (seconds)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure for module</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">reg</td><td>pointer to tracer registry</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">h_prev_opt</td><td>layer thickness before advection (m or kg m-2)</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">uhr_out</td><td>accumulated volume/mass flux through zonal face (m3 or kg)</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">vhr_out</td><td>accumulated volume/mass flux through merid face (m3 or kg)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">h_out</td><td>layer thickness before advection (m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">49</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__tracer__advect_8F90_source.html#l00318">advect_x()</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00582">advect_y()</a>, <a class="el" href="MOM__domains_8F90_source.html#l01201">mom_domains::do_group_pass()</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00039">id_clock_advect</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00040">id_clock_pass</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00041">id_clock_sync</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__offline__main_8F90_source.html#l00181">mom_offline_main::offline_advection_ale()</a>, and <a class="el" href="MOM__offline__main_8F90_source.html#l00388">mom_offline_main::offline_redistribute_residual()</a>.</p>
<div class="fragment"><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(inout)</span> :: g<span class="comment">     !&lt; ocean grid structure</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">    !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: h_end<span class="comment"> !&lt; layer thickness after advection (m or kg m-2)</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: uhtr<span class="comment">  !&lt; accumulated volume/mass flux through zonal face (m3 or kg)</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: vhtr<span class="comment">  !&lt; accumulated volume/mass flux through merid face (m3 or kg)</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),                      <span class="keywordtype">pointer</span>       :: obc<span class="comment">   !&lt; specifies whether, where, and what OBCs are used</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">    !&lt; time increment (seconds)</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordtype">type</span>(tracer_advect_cs),                    <span class="keywordtype">pointer</span>       :: cs<span class="comment">    !&lt; control structure for module</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordtype">type</span>(tracer_registry_type),                <span class="keywordtype">pointer</span>       :: reg<span class="comment">   !&lt; pointer to tracer registry</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">optional</span>      :: h_prev_opt<span class="comment"> !&lt; layer thickness before advection (m or kg m-2)</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  <span class="keywordtype">integer</span>,                                   <span class="keywordtype">optional</span>      :: max_iter_in</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">logical</span>,                                   <span class="keywordtype">optional</span>      :: x_first_in</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>    :: uhr_out<span class="comment">  !&lt; accumulated volume/mass flux through zonal face (m3 or kg)</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>    :: vhr_out<span class="comment">  !&lt; accumulated volume/mass flux through merid face (m3 or kg)</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">optional</span>      :: h_out<span class="comment"> !&lt; layer thickness before advection (m or kg m-2)</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordtype">type</span>(tracer_type) :: tr(max_fields_) <span class="comment">! The array of registered tracers</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    hprev           <span class="comment">! cell volume at the end of previous tracer change (m3)</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    uhr             <span class="comment">! The remaining zonal thickness flux (m3)</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    vhr             <span class="comment">! The remaining meridional thickness fluxes (m3)</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordtype">real</span> :: uh_neglect(szib_(g),szj_(g)) <span class="comment">! uh_neglect and vh_neglect are the</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="keywordtype">real</span> :: vh_neglect(szi_(g),szjb_(g)) <span class="comment">! magnitude of remaining transports that</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                                       <span class="comment">! can be simply discarded (m3 or kg).</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordtype">real</span> :: landvolfill                   <span class="comment">! An arbitrary? nonzero cell volume, m3.</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordtype">real</span> :: idt                           <span class="comment">! 1/dt in s-1.</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordtype">logical</span> :: domore_u(szj_(g),szk_(g))  <span class="comment">! domore__ indicate whether there is more</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keywordtype">logical</span> :: domore_v(szjb_(g),szk_(g)) <span class="comment">! advection to be done in the corresponding</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                        <span class="comment">! row or column.</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="keywordtype">logical</span> :: x_first            <span class="comment">! If true, advect in the x-direction first.</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordtype">integer</span> :: max_iter           <span class="comment">! maximum number of iterations in each layer</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">integer</span> :: domore_k(szk_(g))</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">integer</span> :: stencil            <span class="comment">! stencil of the advection scheme</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">integer</span> :: nsten_halo         <span class="comment">! number of stencils that fit in the halos</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, isd, ied, jsd, jed, nz, itt, ntr, do_any</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">integer</span> :: isv, iev, jsv, jev <span class="comment">! The valid range of the indices.</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  domore_u(:,:) = .false.</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  domore_v(:,:) = .false.</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  landvolfill = 1.0e-20         <span class="comment">! This is arbitrary, but must be positive.</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  stencil = 2                   <span class="comment">! The scheme&#39;s stencil; 2 for PLM and PPM:H3</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_advect: &quot;</span>// &amp;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;       <span class="stringliteral">&quot;tracer_advect_init must be called before advect_tracer.&quot;</span>)</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(reg)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_advect: &quot;</span>// &amp;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;       <span class="stringliteral">&quot;register_tracer must be called before advect_tracer.&quot;</span>)</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordflow">if</span> (reg%ntr==0) <span class="keywordflow">return</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_advect)</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  x_first = (mod(g%first_direction,2) == 0)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="comment">! increase stencil size for Colella &amp; Woodward PPM</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordflow">if</span> (cs%usePPM .and. .not. cs%useHuynh) stencil = 3</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  ntr = reg%ntr</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordflow">do</span> m=1,ntr ; tr(m) = reg%Tr(m) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  idt = 1.0/dt</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  max_iter = 2*int(ceiling(dt/cs%dt)) + 1</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">present</span>(max_iter_in)) max_iter = max_iter_in</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">present</span>(x_first_in))  x_first = x_first_in</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keyword">call </span>create_group_pass(cs%pass_uhr_vhr_t_hprev, uhr, vhr, g%Domain)</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="keyword">call </span>create_group_pass(cs%pass_uhr_vhr_t_hprev, hprev, g%Domain)</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_uhr_vhr_t_hprev, tr(m)%t, g%Domain)</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">!$OMP parallel default(none) shared(nz,jsd,jed,IsdB,IedB,uhr,jsdB,jedB,Isd,Ied,vhr, &amp;</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">!$OMP                               hprev,domore_k,js,je,is,ie,uhtr,vhtr,G,GV,h_end,&amp;</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">!$OMP                               uh_neglect,vh_neglect,ntr,Tr,h_prev_opt)</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">! This initializes the halos of uhr and vhr because pass_vector might do</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">! calculations on them, even though they are never used.</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">do</span> k = 1, nz</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keywordflow">do</span> j = jsd,  jed;  <span class="keywordflow">do</span> i = isdb, iedb; uhr(i,j,k) = 0.0;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">do</span> j = jsdb, jedb; <span class="keywordflow">do</span> i = isd,  ied;  vhr(i,j,k) = 0.0;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">do</span> j = jsd,  jed;  <span class="keywordflow">do</span> i = isd,  ied;  hprev(i,j,k) = 0.0;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    domore_k(k)=1</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">!  Put the remaining (total) thickness fluxes into uhr and vhr.</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie ; uhr(i,j,k) = uhtr(i,j,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie ; vhr(i,j,k) = vhtr(i,j,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">present</span>(h_prev_opt)) <span class="keywordflow">then</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="comment">!   This loop reconstructs the thickness field the last time that the</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="comment">! tracers were updated, probably just after the diabatic forcing.  A useful</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="comment">! diagnostic could be to compare this reconstruction with that older value.</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;          hprev(i,j,k) = max(0.0, g%areaT(i,j)*h_end(i,j,k) + &amp;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;               ((uhr(i,j,k) - uhr(i-1,j,k)) + (vhr(i,j,k) - vhr(i,j-1,k))))</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="comment">! In the case that the layer is now dramatically thinner than it was previously,</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">! add a bit of mass to avoid truncation errors.  This will lead to</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="comment">! non-conservation of tracers</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;          hprev(i,j,k) = hprev(i,j,k) + &amp;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;                         max(0.0, 1.0e-13*hprev(i,j,k) - g%areaT(i,j)*h_end(i,j,k))</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        hprev(i,j,k) = h_prev_opt(i,j,k);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied-1</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    uh_neglect(i,j) = gv%H_subroundoff*min(g%areaT(i,j),g%areaT(i+1,j))</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordflow">do</span> j=jsd,jed-1 ; <span class="keywordflow">do</span> i=isd,ied</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    vh_neglect(i,j) = gv%H_subroundoff*min(g%areaT(i,j),g%areaT(i,j+1))</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="comment">! initialize diagnostic fluxes and tendencies</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad_x)) <span class="keywordflow">then</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        tr(m)%ad_x(i,j,k) = 0.0</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad_y)) <span class="keywordflow">then</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        tr(m)%ad_y(i,j,k) = 0.0</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%advection_xy)) <span class="keywordflow">then</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        tr(m)%advection_xy(i,j,k) = 0.0</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad2d_x)) <span class="keywordflow">then</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied ; tr(m)%ad2d_x(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad2d_y)) <span class="keywordflow">then</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isd,ied ; tr(m)%ad2d_y(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  isv = is ; iev = ie ; jsv = js ; jev = je</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keywordflow">do</span> itt=1,max_iter</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">if</span> (isv &gt; is-stencil) <span class="keywordflow">then</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_uhr_vhr_t_hprev, g%Domain)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      nsten_halo = min(is-isd,ied-ie,js-jsd,jed-je)/stencil</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      isv = is-nsten_halo*stencil ; jsv = js-nsten_halo*stencil</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      iev = ie+nsten_halo*stencil ; jev = je+nsten_halo*stencil</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="comment">! Reevaluate domore_u &amp; domore_v unless the valid range is the same size as</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="comment">! before.  Also, do this if there is Strang splitting.</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <span class="keywordflow">if</span> ((nsten_halo &gt; 1) .or. (itt==1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(nz,domore_k,jsv,jev,domore_u,isv,iev,stencil, &amp;</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">!$OMP                                  uhr,domore_v,vhr)</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">if</span> (domore_k(k) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;          <span class="keywordflow">do</span> j=jsv,jev ; <span class="keywordflow">if</span> (.not.domore_u(j,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <span class="keywordflow">do</span> i=isv+stencil-1,iev-stencil; <span class="keywordflow">if</span> (uhr(i,j,k) /= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;              domore_u(j,k) = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i-loop</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;          <span class="keywordflow">do</span> j=jsv+stencil-1,jev-stencil ; <span class="keywordflow">if</span> (.not.domore_v(j,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;            <span class="keywordflow">do</span> i=isv+stencil,iev-stencil; <span class="keywordflow">if</span> (vhr(i,j,k) /= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;              domore_v(j,k) = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i-loop</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;          <span class="comment">!   At this point, domore_k is global.  Change it so that it indicates</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;          <span class="comment">! whether any work is needed on a layer on this processor.</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;          domore_k(k) = 0</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;          <span class="keywordflow">do</span> j=jsv,jev ; <span class="keywordflow">if</span> (domore_u(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;          <span class="keywordflow">do</span> j=jsv+stencil-1,jev-stencil ; <span class="keywordflow">if</span> (domore_v(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! k-loop</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="comment">! Set the range of valid points after this iteration.</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    isv = isv + stencil ; iev = iev - stencil</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    jsv = jsv + stencil ; jev = jev - stencil</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(nz,domore_k,x_first,Tr,hprev,uhr,uh_neglect,  &amp;</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">!$OMP                                  OBC,domore_u,ntr,Idt,isv,iev,jsv,jev,stencil, &amp;</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">!$OMP                                  G,GV,CS,vhr,vh_neglect,domore_v)</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="comment">!  To ensure positive definiteness of the thickness at each iteration, the</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="comment">!  mass fluxes out of each layer are checked each step, and limited to keep</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">!  the thicknesses positive.  This means that several iterations may be required</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="comment">!  for all the transport to happen.  The sum over domore_k keeps the processors</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment">!  synchronized.  This may not be very efficient, but it should be reliable.</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">if</span> (domore_k(k) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      <span class="keywordflow">if</span> (x_first) <span class="keywordflow">then</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">! First, advect zonally.</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="keyword">call </span>advect_x(tr, hprev, uhr, uh_neglect, obc, domore_u, ntr, idt, &amp;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                      isv, iev, jsv-stencil, jev+stencil, k, g, gv, cs%usePPM, cs%useHuynh)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="comment">!  Next, advect meridionally.</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keyword">call </span>advect_y(tr, hprev, vhr, vh_neglect, obc, domore_v, ntr, idt, &amp;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                      isv, iev, jsv, jev, k, g, gv, cs%usePPM, cs%useHuynh)</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        domore_k(k) = 0</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordflow">do</span> j=jsv-stencil,jev+stencil ; <span class="keywordflow">if</span> (domore_u(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="keywordflow">do</span> j=jsv-1,jev ; <span class="keywordflow">if</span> (domore_v(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="comment">! First, advect meridionally.</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="keyword">call </span>advect_y(tr, hprev, vhr, vh_neglect, obc, domore_v, ntr, idt, &amp;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                      isv-stencil, iev+stencil, jsv, jev, k, g, gv, cs%usePPM, cs%useHuynh)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="comment">! Next, advect zonally.</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keyword">call </span>advect_x(tr, hprev, uhr, uh_neglect, obc, domore_u, ntr, idt, &amp;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                      isv, iev, jsv, jev, k, g, gv, cs%usePPM, cs%useHuynh)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        domore_k(k) = 0</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="keywordflow">do</span> j=jsv,jev ; <span class="keywordflow">if</span> (domore_u(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keywordflow">do</span> j=jsv-1,jev ; <span class="keywordflow">if</span> (domore_v(j,k)) domore_k(k) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! End of k-loop</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="comment">! If the advection just isn&#39;t finishing after max_iter, move on.</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">if</span> (itt &gt;= max_iter) <span class="keywordflow">then</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="comment">! Exit if there are no layers that need more iterations.</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="keywordflow">if</span> (isv &gt; is-stencil) <span class="keywordflow">then</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;      do_any = 0</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_sync)</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keyword">call </span>sum_across_pes(domore_k(:), nz)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_sync)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; do_any = do_any + domore_k(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <span class="keywordflow">if</span> (do_any == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keywordflow">exit</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! Iterations loop</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">present</span>(uhr_out)) uhr_out(:,:,:) = uhr(:,:,:)</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">present</span>(vhr_out)) vhr_out(:,:,:) = vhr(:,:,:)</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">present</span>(h_out)) h_out(:,:,:) = hprev(:,:,:)</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_advect)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tracer__advect_a4c97e84c1a3c433d0c2e84b57926bc08_cgraph.svg" width="596" height="235"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tracer__advect_a4c97e84c1a3c433d0c2e84b57926bc08_icgraph.svg" width="375" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a642efcd418e9c8abfeff1f3c9fb79122"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a642efcd418e9c8abfeff1f3c9fb79122">&#9670;&nbsp;</a></span>advect_x()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tracer_advect::advect_x </td>
          <td>(</td>
          <td class="paramtype">type(tracer_type), dimension(ntr), intent(inout)&#160;</td>
          <td class="paramname"><em>Tr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>hprev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>uhr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed), intent(inout)&#160;</td>
          <td class="paramname"><em>uh_neglect</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, dimension( g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>domore_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ntr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Idt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>is</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ie</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>js</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>je</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>usePPM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>useHuynh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does 1-d flux-form advection in the zonal direction using a monotonic piecewise linear scheme. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00318">318</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">advect_tracer()</a>.</p>
<div class="fragment"><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keywordtype">type</span>(tracer_type), <span class="keywordtype">dimension(ntr)</span>,         <span class="keywordtype">intent(inout)</span> :: tr</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: hprev</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: uhr</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;   <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>,        <span class="keywordtype">intent(inout)</span> :: uh_neglect</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),                      <span class="keywordtype">pointer</span>       :: obc</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZJ_(G),SZK_(G))</span>,       <span class="keywordtype">intent(inout)</span> :: domore_u</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: idt</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keywordtype">integer</span>,                                   <span class="keywordtype">intent(in)</span>    :: ntr, is, ie, js, je,k</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="keywordtype">logical</span>,                                   <span class="keywordtype">intent(in)</span>    :: useppm, usehuynh</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),ntr)</span> :: &amp;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    slope_x             <span class="comment">! The concentration slope per grid point in units of</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                        <span class="comment">! concentration (nondim.).</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),ntr)</span> :: &amp;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    flux_x              <span class="comment">! The tracer flux across a boundary in m3*conc or kg*conc.</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordtype">real</span> :: maxslope      <span class="comment">! The maximum concentration slope per grid point</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                        <span class="comment">! consistent with monotonicity, in conc. (nondim.).</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="keywordtype">real</span> :: hup, hlos     <span class="comment">! hup is the upwind volume, hlos is the</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                        <span class="comment">! part of that volume that might be lost</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                        <span class="comment">! due to advection out the other side of</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                        <span class="comment">! the grid box, both in m3 or kg.</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordtype">real</span> :: uhh(szib_(g)) <span class="comment">! The zonal flux that occurs during the</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                        <span class="comment">! current iteration, in m3 or kg.</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    hlst, ihnew, &amp;      <span class="comment">! Work variables with units of m3 or kg and m-3 or kg-1.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    cfl                 <span class="comment">! A nondimensional work variable.</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordtype">real</span> :: min_h         <span class="comment">! The minimum thickness that can be realized during</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                        <span class="comment">! any of the passes, in m or kg m-2.</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  <span class="keywordtype">real</span> :: h_neglect     <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                        <span class="comment">! in roundoff and can be neglected, in m.</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szib_(g))     <span class="comment">! If true, work on given points.</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  <span class="keywordtype">logical</span> :: do_any_i</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordtype">integer</span> :: i, j, m, n, i_up, stencil</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="keywordtype">real</span> :: ar, al, dmx, dmn, tp, tc, tm, da, ma, a6</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordtype">logical</span> :: useplmslope</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  useplmslope = .not. (useppm .and. usehuynh)</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="comment">! stencil for calculating slope values</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  stencil = 1</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  <span class="keywordflow">if</span> (useppm .and. .not. usehuynh) stencil = 2</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  min_h = 0.1*gv%Angstrom</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">! do I=is-1,ie ; ts2(I) = 0.0 ; enddo</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordflow">do</span> i=is-1,ie ; cfl(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">if</span> (domore_u(j,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    domore_u(j,k) = .false.</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">! Calculate the i-direction profiles (slopes) of each tracer that</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">! is being advected.</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    <span class="keywordflow">if</span> (useplmslope) <span class="keywordflow">then</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;      <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is-stencil,ie+stencil</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;       <span class="comment">!if (ABS(Tr(m)%t(i+1,j,k)-Tr(m)%t(i,j,k)) &lt; &amp;</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;       <span class="comment">!    ABS(Tr(m)%t(i,j,k)-Tr(m)%t(i-1,j,k))) then</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;       <span class="comment">!  maxslope = 4.0*(Tr(m)%t(i+1,j,k)-Tr(m)%t(i,j,k))</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;       <span class="comment">!else</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;       <span class="comment">!  maxslope = 4.0*(Tr(m)%t(i,j,k)-Tr(m)%t(i-1,j,k))</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;       <span class="comment">!endif</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;       <span class="comment">!if ((Tr(m)%t(i+1,j,k)-Tr(m)%t(i,j,k)) * (Tr(m)%t(i,j,k)-Tr(m)%t(i-1,j,k)) &lt; 0.0) then</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;       <span class="comment">!  slope_x(i,m) = 0.0</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;       <span class="comment">!elseif (ABS(Tr(m)%t(i+1,j,k)-Tr(m)%t(i-1,j,k))&lt;ABS(maxslope)) then</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;       <span class="comment">!  slope_x(i,m) = G%mask2dCu(I,j)*G%mask2dCu(I-1,j) * &amp;</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;       <span class="comment">!                 0.5*(Tr(m)%t(i+1,j,k)-Tr(m)%t(i-1,j,k))</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;       <span class="comment">!else</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;       <span class="comment">!  slope_x(i,m) = G%mask2dCu(I,j)*G%mask2dCu(I-1,j) * 0.5*maxslope</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;       <span class="comment">!endif</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        tp = tr(m)%t(i+1,j,k) ; tc = tr(m)%t(i,j,k) ; tm = tr(m)%t(i-1,j,k)</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        dmx = max( tp, tc, tm ) - tc</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        dmn= tc - min( tp, tc, tm )</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        slope_x(i,m) = g%mask2dCu(i,j)*g%mask2dCu(i-1,j) * &amp;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            sign( min(0.5*abs(tp-tm), 2.0*dmx, 2.0*dmn), tp-tm )</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! usePLMslope</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="comment">! Calculate the i-direction fluxes of each tracer, using as much</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="comment">! the minimum of the remaining mass flux (uhr) and the half the mass</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="comment">! in the cell plus whatever part of its half of the mass flux that</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    <span class="comment">! the flux through the other side does not require.</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      <span class="keywordflow">if</span> (uhr(i,j,k) == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        uhh(i) = 0.0</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        cfl(i) = 0.0</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      <span class="keywordflow">elseif</span> (uhr(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        hup = hprev(i+1,j,k) - g%areaT(i+1,j)*min_h</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        hlos = max(0.0,uhr(i+1,j,k))</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">if</span> ((((hup - hlos) + uhr(i,j,k)) &lt; 0.0) .and. &amp;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            ((0.5*hup + uhr(i,j,k)) &lt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;          uhh(i) = min(-0.5*hup,-hup+hlos,0.0)</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;          domore_u(j,k) = .true.</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;          uhh(i) = uhr(i,j,k)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;       <span class="comment">!ts2(I) = 0.5*(1.0 + uhh(I)/(hprev(i+1,j,k)+h_neglect))</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        cfl(i) = - uhh(i)/(hprev(i+1,j,k)+h_neglect) <span class="comment">! CFL is positive</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        hup = hprev(i,j,k) - g%areaT(i,j)*min_h</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        hlos = max(0.0,-uhr(i-1,j,k))</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">if</span> ((((hup - hlos) - uhr(i,j,k)) &lt; 0.0) .and. &amp;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            ((0.5*hup - uhr(i,j,k)) &lt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;          uhh(i) = max(0.5*hup,hup-hlos,0.0)</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;          domore_u(j,k) = .true.</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;          uhh(i) = uhr(i,j,k)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;       <span class="comment">!ts2(I) = 0.5*(1.0 - uhh(I)/(hprev(i,j,k)+h_neglect))</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        cfl(i) = uhh(i)/(hprev(i,j,k)+h_neglect) <span class="comment">! CFL is positive</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordflow">if</span> (useppm) <span class="keywordflow">then</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="comment">! centre cell depending on upstream direction</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">if</span> (uhh(i) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          i_up = i</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          i_up = i+1</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="comment">! Implementation of PPM-H3</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        tp = tr(m)%t(i_up+1,j,k) ; tc = tr(m)%t(i_up,j,k) ; tm = tr(m)%t(i_up-1,j,k)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">if</span> (usehuynh) <span class="keywordflow">then</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          al = ( 5.*tc + ( 2.*tm - tp ) )/6. <span class="comment">! H3 estimate</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;          al = max( min(tc,tm), al) ; al = min( max(tc,tm), al) <span class="comment">! Bound</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;          ar = ( 5.*tc + ( 2.*tp - tm ) )/6. <span class="comment">! H3 estimate</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          ar = max( min(tc,tp), ar) ; ar = min( max(tc,tp), ar) <span class="comment">! Bound</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;          al = 0.5 * ((tm + tc) + (slope_x(i_up-1,m) - slope_x(i_up,m)) / 3.)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;          ar = 0.5 * ((tc + tp) + (slope_x(i_up,m) - slope_x(i_up+1,m)) / 3.)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        da = ar - al ; ma = 0.5*( ar + al )</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <span class="keywordflow">if</span> (g%mask2dCu(i_up,j)*g%mask2dCu(i_up-1,j)*(tp-tc)*(tc-tm) &lt;= 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;           al = tc ; ar = tc <span class="comment">! PCM for local extremum and bounadry cells</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="keywordflow">elseif</span> ( da*(tc-ma) &gt; (da*da)/6. ) <span class="keywordflow">then</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;           al = 3.*tc - 2.*ar</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="keywordflow">elseif</span> ( da*(tc-ma) &lt; - (da*da)/6. ) <span class="keywordflow">then</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;           ar = 3.*tc - 2.*al</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        a6 = 6.*tc - 3. * (ar + al) <span class="comment">! Curvature</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        <span class="keywordflow">if</span> (uhh(i) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;          flux_x(i,m) = uhh(i)*( ar - 0.5 * cfl(i) * ( &amp;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;               ( ar - al ) - a6 * ( 1. - 2./3. * cfl(i) ) ) )</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;          flux_x(i,m) = uhh(i)*( al + 0.5 * cfl(i) * ( &amp;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;               ( ar - al ) + a6 * ( 1. - 2./3. * cfl(i) ) ) )</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! PLM</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;      <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">if</span> (uhh(i) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;          <span class="comment">! Indirect implementation of PLM</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;         <span class="comment">!aL = Tr(m)%t(i,j,k) - 0.5 * slope_x(i,m)</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;         <span class="comment">!aR = Tr(m)%t(i,j,k) + 0.5 * slope_x(i,m)</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*( aR - 0.5 * (aR-aL) * CFL(I) )</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;         <span class="comment">!aR = Tr(m)%t(i,j,k) + 0.5 * slope_x(i,m)</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*( aR - 0.5 * slope_x(i,m) * CFL(I) )</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;          tc = tr(m)%t(i,j,k)</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;          flux_x(i,m) = uhh(i)*( tc + 0.5 * slope_x(i,m) * ( 1. - cfl(i) ) )</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;          <span class="comment">! Original implementation of PLM</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*(Tr(m)%t(i,j,k) + slope_x(i,m)*ts2(I))</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;          <span class="comment">! Indirect implementation of PLM</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;         <span class="comment">!aL = Tr(m)%t(i+1,j,k) - 0.5 * slope_x(i+1,m)</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;         <span class="comment">!aR = Tr(m)%t(i+1,j,k) + 0.5 * slope_x(i+1,m)</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*( aL + 0.5 * (aR-aL) * CFL(I) )</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;         <span class="comment">!aL = Tr(m)%t(i+1,j,k) - 0.5 * slope_x(i+1,m)</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*( aL + 0.5 * slope_x(i+1,m) * CFL(I) )</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;          tc = tr(m)%t(i+1,j,k)</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;          flux_x(i,m) = uhh(i)*( tc - 0.5 * slope_x(i+1,m) * ( 1. - cfl(i) ) )</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;          <span class="comment">! Original implementation of PLM</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;         <span class="comment">!flux_x(I,m) = uhh(I)*(Tr(m)%t(i+1,j,k) - slope_x(i+1,m)*ts2(I))</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;       <span class="comment">!ts2(I) = 0.5*(1.0 - uhh(I)/(hprev(i,j,k)+h_neglect))</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! usePPM</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%OBC_pe) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%specified_u_BCs_exist_globally) <span class="keywordflow">then</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;      <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_E_or_W) <span class="keywordflow">then</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;          <span class="keywordflow">if</span> (j &gt;= obc%segment(n)%HI%jsd .and. j&lt;= obc%segment(n)%HI%jed) <span class="keywordflow">then</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            <span class="comment">! Tracer fluxes are set to prescribed values only for inflows from masked areas.</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;            <span class="keywordflow">if</span> ((uhr(i,j,k) &gt; 0.0) .and. (g%mask2dT(i,j) &lt; 0.5) .or. &amp;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                (uhr(i,j,k) &lt; 0.0) .and. (g%mask2dT(i+1,j) &lt; 0.5)) <span class="keywordflow">then</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;              uhh(i) = uhr(i,j,k)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;              <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%OBC_in_u)) <span class="keywordflow">then</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;                  flux_x(i,m) = uhh(i)*tr(m)%OBC_in_u(i,j,k)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                <span class="keywordflow">else</span> ; flux_x(i,m) = uhh(i)*tr(m)%OBC_inflow_conc ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="comment">! Calculate new tracer concentration in each cell after accounting</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="comment">! for the i-direction fluxes.</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      uhr(i,j,k) = uhr(i,j,k) - uhh(i)</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      <span class="keywordflow">if</span> (abs(uhr(i,j,k)) &lt; uh_neglect(i,j)) uhr(i,j,k) = 0.0</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      <span class="keywordflow">if</span> ((uhh(i) /= 0.0) .or. (uhh(i-1) /= 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        do_i(i) = .true.</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        hlst(i) = hprev(i,j,k)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        hprev(i,j,k) = hprev(i,j,k) - (uhh(i) - uhh(i-1))</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">if</span> (hprev(i,j,k) &lt;= 0.0) <span class="keywordflow">then</span> ; do_i(i) = .false.</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">elseif</span> (hprev(i,j,k) &lt; h_neglect*g%areaT(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;          hlst(i) = hlst(i) + (h_neglect*g%areaT(i,j) - hprev(i,j,k))</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;          ihnew(i) = 1.0 / (h_neglect*g%areaT(i,j))</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">else</span> ;  ihnew(i) = 1.0 / hprev(i,j,k) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        do_i(i) = .false.</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">! update tracer concentration from i-flux and save some diagnostics</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="comment">! update tracer</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((do_i(i)) .and. (ihnew(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        tr(m)%t(i,j,k) = (tr(m)%t(i,j,k) * hlst(i) - &amp;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                          (flux_x(i,m) - flux_x(i-1,m))) * ihnew(i)</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      <span class="comment">! diagnostics</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad_x)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        tr(m)%ad_x(i,j,k) = tr(m)%ad_x(i,j,k) + flux_x(i,m)*idt</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad2d_x)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        tr(m)%ad2d_x(i,j) = tr(m)%ad2d_x(i,j) + flux_x(i,m)*idt</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      <span class="comment">! diagnose convergence of flux_x (do not use the Ihnew(i) part of the logic).</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      <span class="comment">! division by areaT to get into W/m2 for heat and kg/(s*m2) for salt.</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%advection_xy)) <span class="keywordflow">then</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;          tr(m)%advection_xy(i,j,k) = tr(m)%advection_xy(i,j,k) - (flux_x(i,m) - flux_x(i-1,m)) * idt * g%IareaT(i,j)</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! End of j-loop.</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tracer__advect_a642efcd418e9c8abfeff1f3c9fb79122_icgraph.svg" width="568" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a6ad4bd56b70992ba99f6dce298ff15fa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6ad4bd56b70992ba99f6dce298ff15fa">&#9670;&nbsp;</a></span>advect_y()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tracer_advect::advect_y </td>
          <td>(</td>
          <td class="paramtype">type(tracer_type), dimension(ntr), intent(inout)&#160;</td>
          <td class="paramname"><em>Tr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>hprev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>vhr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb), intent(inout)&#160;</td>
          <td class="paramname"><em>vh_neglect</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, dimension( g %jsdb: g %jedb, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>domore_v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ntr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Idt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>is</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ie</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>js</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>je</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>usePPM</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>useHuynh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does 1-d flux-form advection using a monotonic piecewise linear scheme. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00582">582</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">advect_tracer()</a>.</p>
<div class="fragment"><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordtype">type</span>(tracer_type), <span class="keywordtype">dimension(ntr)</span>,         <span class="keywordtype">intent(inout)</span> :: tr</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: hprev</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: vhr</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>,         <span class="keywordtype">intent(inout)</span> :: vh_neglect</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),                      <span class="keywordtype">pointer</span>       :: obc</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZJB_(G),SZK_(G))</span>,      <span class="keywordtype">intent(inout)</span> :: domore_v</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: idt</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">integer</span>,                                   <span class="keywordtype">intent(in)</span>    :: ntr, is, ie, js, je,k</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  <span class="keywordtype">logical</span>,                                   <span class="keywordtype">intent(in)</span>    :: useppm, usehuynh</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),ntr,SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    slope_y                     <span class="comment">! The concentration slope per grid point in units of</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                                <span class="comment">! concentration (nondim.).</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),ntr,SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    flux_y                      <span class="comment">! The tracer flux across a boundary in m3 * conc or kg*conc.</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordtype">real</span> :: maxslope              <span class="comment">! The maximum concentration slope per grid point</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                                <span class="comment">! consistent with monotonicity, in conc. (nondim.).</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;  <span class="keywordtype">real</span> :: vhh(szi_(g),szjb_(g)) <span class="comment">! The meridional flux that occurs during the</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                                <span class="comment">! current iteration, in m3 or kg.</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  <span class="keywordtype">real</span> :: hup, hlos             <span class="comment">! hup is the upwind volume, hlos is the</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                                <span class="comment">! part of that volume that might be lost</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                                <span class="comment">! due to advection out the other side of</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                                <span class="comment">! the grid box, both in m3 or kg.</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    hlst, ihnew, &amp;      <span class="comment">! Work variables with units of m3 or kg and m-3 or kg-1.</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    cfl                 <span class="comment">! A nondimensional work variable.</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;  <span class="keywordtype">real</span> :: min_h         <span class="comment">! The minimum thickness that can be realized during</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                        <span class="comment">! any of the passes, in m or kg m-2.</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  <span class="keywordtype">real</span> :: h_neglect     <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                        <span class="comment">! in roundoff and can be neglected, in m.</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  <span class="keywordtype">logical</span> :: do_j_tr(szj_(g))   <span class="comment">! If true, calculate the tracer profiles.</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szib_(g))     <span class="comment">! If true, work on given points.</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <span class="keywordtype">logical</span> :: do_any_i</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  <span class="keywordtype">integer</span> :: i, j, j2, m, n, j_up, stencil</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="keywordtype">real</span> :: ar, al, dmx, dmn, tp, tc, tm, da, ma, a6</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <span class="keywordtype">logical</span> :: useplmslope</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  useplmslope = .not. (useppm .and. usehuynh)</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="comment">! stencil for calculating slope values</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  stencil = 1</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="keywordflow">if</span> (useppm .and. .not. usehuynh) stencil = 2</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  min_h = 0.1*gv%Angstrom</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="comment">!do i=is,ie ; ts2(i) = 0.0 ; enddo</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="comment">! We conditionally perform work on tracer points: calculating the PLM slope,</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="comment">! and updating tracer concentration within a cell</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  <span class="comment">! this depends on whether there is a flux which would affect this tracer point,</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="comment">! as indicated by domore_v. In the case of PPM reconstruction, a flux requires</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  <span class="comment">! slope calculations at the two tracer points on either side (as indicated by</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="comment">! the stencil variable), so we account for this with the do_j_tr flag array</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="comment">!</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;  <span class="comment">! Note: this does lead to unnecessary work in updating tracer concentrations,</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  <span class="comment">! since that doesn&#39;t need a wider stencil with the PPM advection scheme, but</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  <span class="comment">! this would require an additional loop, etc.</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;  do_j_tr(:) = .false.</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">if</span> (domore_v(j,k)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j2=1-stencil,stencil ; do_j_tr(j+j2) = .true. ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="comment">! Calculate the j-direction profiles (slopes) of each tracer that</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="comment">! is being advected.</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordflow">if</span> (useplmslope) <span class="keywordflow">then</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">do</span> j=js-stencil,je+stencil ; <span class="keywordflow">if</span> (do_j_tr(j)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="comment">!if (ABS(Tr(m)%t(i,j+1,k)-Tr(m)%t(i,j,k)) &lt; &amp;</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="comment">!    ABS(Tr(m)%t(i,j,k)-Tr(m)%t(i,j-1,k))) then</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;      <span class="comment">!  maxslope = 4.0*(Tr(m)%t(i,j+1,k)-Tr(m)%t(i,j,k))</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;      <span class="comment">!else</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      <span class="comment">!  maxslope = 4.0*(Tr(m)%t(i,j,k)-Tr(m)%t(i,j-1,k))</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      <span class="comment">!endif</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;      <span class="comment">!if ((Tr(m)%t(i,j+1,k)-Tr(m)%t(i,j,k))*(Tr(m)%t(i,j,k)-Tr(m)%t(i,j-1,k)) &lt; 0.0) then</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      <span class="comment">!  slope_y(i,m,j) = 0.0</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      <span class="comment">!elseif (ABS(Tr(m)%t(i,j+1,k)-Tr(m)%t(i,j-1,k))&lt;ABS(maxslope)) then</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      <span class="comment">!  slope_y(i,m,j) = G%mask2dCv(i,J) * G%mask2dCv(i,J-1) * &amp;</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      <span class="comment">!                 0.5*(Tr(m)%t(i,j+1,k)-Tr(m)%t(i,j-1,k))</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;      <span class="comment">!else</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <span class="comment">!  slope_y(i,m,j) = G%mask2dCv(i,J) * G%mask2dCv(i,J-1) * 0.5*maxslope</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="comment">!endif</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;       tp = tr(m)%t(i,j+1,k) ; tc = tr(m)%t(i,j,k) ; tm = tr(m)%t(i,j-1,k)</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;       dmx = max( tp, tc, tm ) - tc</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;       dmn= tc - min( tp, tc, tm )</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;       slope_y(i,m,j) = g%mask2dCv(i,j)*g%mask2dCv(i,j-1) * &amp;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;           sign( min(0.5*abs(tp-tm), 2.0*dmx, 2.0*dmn), tp-tm )</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! End of i-, m-, &amp; j- loops.</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! usePLMslope</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  <span class="comment">! Calculate the j-direction fluxes of each tracer, using as much</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  <span class="comment">! the minimum of the remaining mass flux (vhr) and the half the mass</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  <span class="comment">! in the cell plus whatever part of its half of the mass flux that</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="comment">! the flux through the other side does not require.</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">if</span> (domore_v(j,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    domore_v(j,k) = .false.</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;      <span class="keywordflow">if</span> (vhr(i,j,k) == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        vhh(i,j) = 0.0</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        cfl(i) = 0.0</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;      <span class="keywordflow">elseif</span> (vhr(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        hup = hprev(i,j+1,k) - g%areaT(i,j+1)*min_h</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        hlos = max(0.0,vhr(i,j+1,k))</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        <span class="keywordflow">if</span> ((((hup - hlos) + vhr(i,j,k)) &lt; 0.0) .and. &amp;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;            ((0.5*hup + vhr(i,j,k)) &lt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;          vhh(i,j) = min(-0.5*hup,-hup+hlos,0.0)</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;          domore_v(j,k) = .true.</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;          vhh(i,j) = vhr(i,j,k)</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;       <span class="comment">!ts2(i) = 0.5*(1.0 + vhh(i,J) / (hprev(i,j+1,k)+h_neglect))</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        cfl(i) = - vhh(i,j) / (hprev(i,j+1,k)+h_neglect) <span class="comment">! CFL is positive</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        hup = hprev(i,j,k) - g%areaT(i,j)*min_h</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        hlos = max(0.0,-vhr(i,j-1,k))</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="keywordflow">if</span> ((((hup - hlos) - vhr(i,j,k)) &lt; 0.0) .and. &amp;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            ((0.5*hup - vhr(i,j,k)) &lt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          vhh(i,j) = max(0.5*hup,hup-hlos,0.0)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;          domore_v(j,k) = .true.</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;          vhh(i,j) = vhr(i,j,k)</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;       <span class="comment">!ts2(i) = 0.5*(1.0 - vhh(i,J) / (hprev(i,j,k)+h_neglect))</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        cfl(i) = vhh(i,j) / (hprev(i,j,k)+h_neglect) <span class="comment">! CFL is positive</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keywordflow">if</span> (useppm) <span class="keywordflow">then</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="comment">! centre cell depending on upstream direction</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <span class="keywordflow">if</span> (vhh(i,j) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;          j_up = j</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          j_up = j + 1</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        <span class="comment">! Implementation of PPM-H3</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        tp = tr(m)%t(i,j_up+1,k) ; tc = tr(m)%t(i,j_up,k) ; tm = tr(m)%t(i,j_up-1,k)</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="keywordflow">if</span> (usehuynh) <span class="keywordflow">then</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;          al = ( 5.*tc + ( 2.*tm - tp ) )/6. <span class="comment">! H3 estimate</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;          al = max( min(tc,tm), al) ; al = min( max(tc,tm), al) <span class="comment">! Bound</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;          ar = ( 5.*tc + ( 2.*tp - tm ) )/6. <span class="comment">! H3 estimate</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;          ar = max( min(tc,tp), ar) ; ar = min( max(tc,tp), ar) <span class="comment">! Bound</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;          al = 0.5 * ((tm + tc) + (slope_y(i,m,j_up-1) - slope_y(i,m,j_up)) / 3.)</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;          ar = 0.5 * ((tc + tp) + (slope_y(i,m,j_up) - slope_y(i,m,j_up+1)) / 3.)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        da = ar - al ; ma = 0.5*( ar + al )</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">if</span> (g%mask2dCv(i,j_up)*g%mask2dCv(i,j_up-1)*(tp-tc)*(tc-tm) &lt;= 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;          al = tc ; ar = tc <span class="comment">! PCM for local extremum and bounadry cells</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="keywordflow">elseif</span> ( da*(tc-ma) &gt; (da*da)/6. ) <span class="keywordflow">then</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;          al = 3.*tc - 2.*ar</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keywordflow">elseif</span> ( da*(tc-ma) &lt; - (da*da)/6. ) <span class="keywordflow">then</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          ar = 3.*tc - 2.*al</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        a6 = 6.*tc - 3. * (ar + al) <span class="comment">! Curvature</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        <span class="keywordflow">if</span> (vhh(i,j) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;          flux_y(i,m,j) = vhh(i,j)*( ar - 0.5 * cfl(i) * ( &amp;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;               ( ar - al ) - a6 * ( 1. - 2./3. * cfl(i) ) ) )</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;          flux_y(i,m,j) = vhh(i,j)*( al + 0.5 * cfl(i) * ( &amp;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;               ( ar - al ) + a6 * ( 1. - 2./3. * cfl(i) ) ) )</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! PLM</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="keywordflow">if</span> (vhh(i,j) &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;          <span class="comment">! Indirect implementation of PLM</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;         <span class="comment">!aL = Tr(m)%t(i,j,k) - 0.5 * slope_y(i,m,j)</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;         <span class="comment">!aR = Tr(m)%t(i,j,k) + 0.5 * slope_y(i,m,j)</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*( aR - 0.5 * (aR-aL) * CFL(i) )</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;         <span class="comment">!aR = Tr(m)%t(i,j,k) + 0.5 * slope_y(i,m,j)</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*(aR - 0.5 * slope_y(i,m,j)*CFL(i))</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;          tc = tr(m)%t(i,j,k)</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;          flux_y(i,m,j) = vhh(i,j)*( tc + 0.5 * slope_y(i,m,j) * ( 1. - cfl(i) ) )</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;          <span class="comment">! Original implementation of PLM</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*(Tr(m)%t(i,j,k) + slope_y(i,m,j)*ts2(i))</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;          <span class="comment">! Indirect implementation of PLM</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;         <span class="comment">!aL = Tr(m)%t(i,j+1,k) - 0.5 * slope_y(i,m,j+1)</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;         <span class="comment">!aR = Tr(m)%t(i,j+1,k) + 0.5 * slope_y(i,m,j+1)</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*( aL + 0.5 * (aR-aL) * CFL(i) )</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;         <span class="comment">!aL = Tr(m)%t(i,j+1,k) - 0.5 * slope_y(i,m,j+1)</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*( aL + 0.5 * slope_y(i,m,j+1)*CFL(i) )</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;          <span class="comment">! Alternative implementation of PLM</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;          tc = tr(m)%t(i,j+1,k)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;          flux_y(i,m,j) = vhh(i,j)*( tc - 0.5 * slope_y(i,m,j+1) * ( 1. - cfl(i) ) )</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;          <span class="comment">! Original implementation of PLM</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;         <span class="comment">!flux_y(i,m,J) = vhh(i,J)*(Tr(m)%t(i,j+1,k) - slope_y(i,m,j+1)*ts2(i))</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! usePPM</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%OBC_pe) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%specified_v_BCs_exist_globally) <span class="keywordflow">then</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S) <span class="keywordflow">then</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;          <span class="keywordflow">if</span> (j &gt;= obc%segment(n)%HI%JsdB .and. j&lt;= obc%segment(n)%HI%JedB) <span class="keywordflow">then</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;            i = obc%segment(n)%HI%isd</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            <span class="comment">! Tracer fluxes are set to prescribed values only for inflows from masked areas.</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="keywordflow">if</span> ((vhr(i,j,k) &gt; 0.0) .and. (g%mask2dT(i,j) &lt; 0.5) .or. &amp;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                (vhr(i,j,k) &lt; 0.0) .and. (g%mask2dT(i,j+1) &lt; 0.5)) <span class="keywordflow">then</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;              vhh(i,j) = vhr(i,j,k)</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;              <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%OBC_in_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                  flux_y(i,m,j) = vhh(i,j)*tr(m)%OBC_in_v(i,j,k)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                <span class="keywordflow">else</span> ; flux_y(i,m,j) = vhh(i,j)*tr(m)%OBC_inflow_conc ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! not domore_v.</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; vhh(i,j) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">do</span> i=is,ie ; flux_y(i,m,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! End of j-loop</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    vhr(i,j,k) = vhr(i,j,k) - vhh(i,j)</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="keywordflow">if</span> (abs(vhr(i,j,k)) &lt; vh_neglect(i,j)) vhr(i,j,k) = 0.0</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="comment">! Calculate new tracer concentration in each cell after accounting</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="comment">! for the j-direction fluxes.</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">if</span> (do_j_tr(j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      <span class="keywordflow">if</span> ((vhh(i,j) /= 0.0) .or. (vhh(i,j-1) /= 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        do_i(i) = .true.</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        hlst(i) = hprev(i,j,k)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        hprev(i,j,k) = max(hprev(i,j,k) - (vhh(i,j) - vhh(i,j-1)), 0.0)</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="keywordflow">if</span> (hprev(i,j,k) &lt;= 0.0) <span class="keywordflow">then</span> ; do_i(i) = .false.</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        <span class="keywordflow">elseif</span> (hprev(i,j,k) &lt; h_neglect*g%areaT(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;          hlst(i) = hlst(i) + (h_neglect*g%areaT(i,j) - hprev(i,j,k))</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;          ihnew(i) = 1.0 / (h_neglect*g%areaT(i,j))</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        <span class="keywordflow">else</span> ;  ihnew(i) = 1.0 / hprev(i,j,k) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;      <span class="keywordflow">else</span> ; do_i(i) = .false. ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="comment">! update tracer and save some diagnostics</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        tr(m)%t(i,j,k) = (tr(m)%t(i,j,k) * hlst(i) - &amp;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                          (flux_y(i,m,j) - flux_y(i,m,j-1))) * ihnew(i)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      <span class="comment">! diagnostics</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad_y)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        tr(m)%ad_y(i,j,k) = tr(m)%ad_y(i,j,k) + flux_y(i,m,j)*idt</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%ad2d_y)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        tr(m)%ad2d_y(i,j) = tr(m)%ad2d_y(i,j) + flux_y(i,m,j)*idt</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;      <span class="comment">! diagnose convergence of flux_y and add to convergence of flux_x.</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;      <span class="comment">! division by areaT to get into W/m2 for heat and kg/(s*m2) for salt.</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%advection_xy)) <span class="keywordflow">then</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;          tr(m)%advection_xy(i,j,k) = tr(m)%advection_xy(i,j,k) - (flux_y(i,m,j) - flux_y(i,m,j-1))* idt * g%IareaT(i,j)</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! End of j-loop.</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tracer__advect_a6ad4bd56b70992ba99f6dce298ff15fa_icgraph.svg" width="568" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a2e466a8a34546bb9265a74ff0209df47"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e466a8a34546bb9265a74ff0209df47">&#9670;&nbsp;</a></span>tracer_advect_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_advect::tracer_advect_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__tracer__advect_1_1tracer__advect__cs.html">tracer_advect_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Close the tracer advection module. </p>

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00912">912</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="keywordtype">type</span>(tracer_advect_cs), <span class="keywordtype">pointer</span> :: cs</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a9e4b29db7016edd0aa8acf9f60f3e919"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e4b29db7016edd0aa8acf9f60f3e919">&#9670;&nbsp;</a></span>tracer_advect_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_advect::tracer_advect_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__tracer__advect_1_1tracer__advect__cs.html">tracer_advect_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize lateral tracer advection module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>open file to parse for model parameters</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>regulates diagnostic output</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00858">858</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__tracer__advect_8F90_source.html#l00039">id_clock_advect</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00040">id_clock_pass</a>, <a class="el" href="MOM__tracer__advect_8F90_source.html#l00041">id_clock_sync</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: time<span class="comment">        !&lt; current model time</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">           !&lt; ocean grid structure</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment">  !&lt; open file to parse for model parameters</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">        !&lt; regulates diagnostic output</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="keywordtype">type</span>(tracer_advect_cs),  <span class="keywordtype">pointer</span>       :: cs<span class="comment">          !&lt; module control structure</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">save</span> :: init_calls = 0</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_tracer_advect&quot;</span> <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="keywordtype">character(len=256)</span> :: mesg    <span class="comment">! Message for error messages.</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;tracer_advect_init called with associated control structure.&quot;</span>)</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT&quot;</span>, cs%dt, fail_if_missing=.true., &amp;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;          desc=<span class="stringliteral">&quot;The (baroclinic) dynamics time step.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, default=.false.)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TRACER_ADVECTION_SCHEME&quot;</span>, mesg, &amp;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;          desc=<span class="stringliteral">&quot;The horizontal transport scheme for tracers:\n&quot;</span>//&amp;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;          <span class="stringliteral">&quot;  PLM    - Piecewise Linear Method\n&quot;</span>//&amp;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;          <span class="stringliteral">&quot;  PPM:H3 - Piecewise Parabolic Method (Huyhn 3rd order)\n&quot;</span>// &amp;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;          <span class="stringliteral">&quot;  PPM    - Piecewise Parabolic Method (Colella-Woodward)&quot;</span> &amp;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;          , default=<span class="stringliteral">&#39;PLM&#39;</span>)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="keywordflow">select case</span> (trim(mesg))</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PLM&quot;</span>)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;      cs%usePPM = .false.</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PPM:H3&quot;</span>)</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      cs%usePPM = .true.</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      cs%useHuynh = .true.</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PPM&quot;</span>)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      cs%usePPM = .true.</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;      cs%useHuynh = .false.</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_advect, tracer_advect_init: &quot;</span>//&amp;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;           <span class="stringliteral">&quot;Unknown TRACER_ADVECTION_SCHEME = &quot;</span>//trim(mesg))</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;  id_clock_advect = cpu_clock_id(<span class="stringliteral">&#39;(Ocean advect tracer)&#39;</span>, grain=clock_module)</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  id_clock_pass = cpu_clock_id(<span class="stringliteral">&#39;(Ocean tracer halo updates)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;  id_clock_sync = cpu_clock_id(<span class="stringliteral">&#39;(Ocean tracer global synch)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__tracer__advect_a9e4b29db7016edd0aa8acf9f60f3e919_cgraph.svg" width="535" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a951134d3dcb3508f71abb05dc39837cc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a951134d3dcb3508f71abb05dc39837cc">&#9670;&nbsp;</a></span>id_clock_advect</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_advect::id_clock_advect</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00039">39</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">advect_tracer()</a>, and <a class="el" href="MOM__tracer__advect_8F90_source.html#l00858">tracer_advect_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keywordtype">integer</span> :: id_clock_advect</div></div><!-- fragment -->
</div>
</div>
<a id="a6590ebd9b76b6d5fea6d13e2deb0c271"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6590ebd9b76b6d5fea6d13e2deb0c271">&#9670;&nbsp;</a></span>id_clock_pass</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_advect::id_clock_pass</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00040">40</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">advect_tracer()</a>, and <a class="el" href="MOM__tracer__advect_8F90_source.html#l00858">tracer_advect_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keywordtype">integer</span> :: id_clock_pass</div></div><!-- fragment -->
</div>
</div>
<a id="a4f1598f314da682e38e10f560bb94428"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f1598f314da682e38e10f560bb94428">&#9670;&nbsp;</a></span>id_clock_sync</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_advect::id_clock_sync</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__tracer__advect_8F90_source.html#l00041">41</a> of file <a class="el" href="MOM__tracer__advect_8F90_source.html">MOM_tracer_advect.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">advect_tracer()</a>, and <a class="el" href="MOM__tracer__advect_8F90_source.html#l00858">tracer_advect_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keywordtype">integer</span> :: id_clock_sync</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__tracer__advect.html">mom_tracer_advect</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
