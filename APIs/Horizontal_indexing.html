<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: Horizontal indexing and memory</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Horizontal_indexing.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Horizontal indexing and memory </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Conventions for staggering of variables and loops over 2d/3d arrays</p>
<p>MOM6 is written in Fortran90 and uses the <code>i,j,k</code> order of indexing. <code>i</code> corresponds to the fastest index (stride-1 in memory) and thus should be the inner-most loop variable. We often refer to the i-direction as the x- or zonal direction, and similarly to the j-direction as y- or meridional direction. The model can use curvilinear grids/coordinates in the horizontal and so these labels have loose meanings but convenient.</p>
<h1><a class="anchor" id="Staggering"></a>
Loops and staggered variables</h1>
<p>Many variables are staggered horizontally with respect to each other. The dynamics and tracer equations are discretized on an Arakawa C grid. Staggered variables must still have integer indices and we use a north-east convention centered on the h-points. These means a variable with indices <code>i,j</code> will be either collocated, to the east, to the north, or to the north-east of the h-point with the same indices.</p>
<div class="image">
<img src="Arakawa_C_grid.png" alt="Arakawa_C_grid.png"/>
<div class="caption">
MOM6 uses an Arakawa C grid staggering of variables with a North-East indexing convention. "Cells" refer to the control volumes around tracer- or h-point located variables unless labelled otherwise.</div></div>
<h2><a class="anchor" id="Soft_convention"></a>
Soft convention for loop variables</h2>
<p>To ease reading the code we use a "soft" convection (soft because there is no syntax checking) where an upper-case index variable can be interpreted as the lower-case index variable plus \(\frac{1}{2}\).</p>
<p>For example, when a loop is over h-points collocated variables</p><ul>
<li>the do-loop statements will be for lower-case <code>i,j</code> variables</li>
<li>references to h-point variables will be <code>h(i,j)</code>, <code>D(i+1,j)</code>, etc.</li>
<li>references to u-point variables will be <code>u(I,j)</code> (meaning \(u_{i+\frac{1}{2},j}\)), <code>u(I-1,j)</code> (meaning \(u_{i-\frac{1}{2},j}\)), etc.</li>
<li>references to v-point variables will be <code>v(i,J)</code> (meaning \(v_{i,j+\frac{1}{2}}\)), <code>u(I-1,j)</code> (meaning \(u_{i,j-\frac{1}{2}}\)), etc.</li>
<li>references to q-point variables will be <code>q(I,J)</code> (meaning \(q_{i+\frac{1}{2},j+\frac{1}{2}}\)), etc.</li>
</ul>
<p>In contrast, when a loop is over u-points collocated variables</p><ul>
<li>the do-loop statements will be for upper-case <code>I</code> and lower-case <code>j</code> variables</li>
<li>the expression \( u_{i+\frac{1}{2},j} ( h_{i,j} + h_{i+1,j} ) \) is <code>u(I,j) * ( h(i,j) + h(i+1,j)</code>.</li>
</ul>
<h1><a class="anchor" id="Memory"></a>
Declaration of variables</h1>
<div class="image">
<img src="Horizontal_NE_indexing_nonsym.png" alt="Horizontal_NE_indexing_nonsym.png"/>
<div class="caption">
Non-symmetric mode: All arrays are declared with the same shape (isd:ied,jsd:jed).</div></div>
<div class="image">
<img src="Horizontal_NE_indexing_sym.png" alt="Horizontal_NE_indexing_sym.png"/>
<div class="caption">
Symmetric mode: Arrays have different shapes depending on their staggering location on the Arakawa C grid.</div></div>
<p>A field is described by 2D or 3D arrays which are distributed across parallel processors. Each processor only sees a small window of the global field. The processor "owns" the computational domain (red in above figure) but arrays are extended horizontally with halos which are intermittently updated with the values from neighboring processors. The halo regions (blue in above figure) may not always be up-to-date. Data in halo regions (blue in above figure) will be overwritten my mpp_updates.</p>
<p>MOM6 has two memory models, "symmetric" and "non-symmetric". In non-symmetric mode all arrays are given the same shape. The consequence of this is that there are fewer staggered variables to the south-west of the computational domain. An operator applied at h-point locations involving u- or v- point data can not have as wide a stencil on the south-west side of the processor domain as it can on the north-east side.</p>
<p>In symmetric mode, declarations are dependent on the variables staggered location on the Arakawa C grid. This allows loops to be symmetric and stencils to be applied more uniformly.</p>
<p>In the code, declarations are consistent with the symmetric memory model. The non-symmetric mode is implemented by setting the start values of the staggered data domain to be the same as the non-staggered start value.</p>
<p>The horizontal index type (<a class="el" href="structmom__hor__index_1_1hor__index__type.html" title="Container for horizontal index ranges for data, computational and global domains. ...">mom_hor_index::hor_index_type</a>) provides the data domain start values. The values are also copied into the <a class="el" href="structmom__grid_1_1ocean__grid__type.html" title="Ocean grid type. See mom_grid for details. ">mom_grid::ocean_grid_type</a> for convenience although we might deprecate this convenience in the future.</p>
<p>Declarations of h-point data take the form:</p><ul>
<li><code>real, dimension(HI%isd:HI%ied, HI%jsd:HI%jed) :: D !&lt; Depth at h-points (m)</code></li>
<li><code>real, dimension(HI%isd:HI%ied, HI%jsd:HI%jed, GV%ke) :: h !&lt; Layer thickness (H units)</code></li>
</ul>
<p>Declarations of u-point data take the form:</p><ul>
<li><code>real, dimension(HI%IsdB:HI%IedB, HI%jsd:HI%jed) :: Du !&lt; Depth at u-points (m)</code></li>
<li><code>real, dimension(HI%IsdB:HI%IedB, HI%jsd:HI%jed, GV%ke) :: h !&lt; Zonal flow (m/s)</code></li>
</ul>
<p>Declarations of v-point data take the form:</p><ul>
<li><code>real, dimension(HI%isd:HI%ied, HI%JsdB:HI%JedB) :: Dv !&lt; Depth at v-points (m)</code></li>
<li><code>real, dimension(HI%isd:HI%ied, HI%JsdB:HI%JedB, GV%ke) :: h !&lt; Zonal flow (m/s)</code></li>
</ul>
<p>Declarations of q-point data take the form:</p><ul>
<li><code>real, dimension(HI%IsdB:HI%IedB, HI%JsdB:HI%JedB) :: Dq !&lt; Depth at q-points (m)</code></li>
<li><code>real, dimension(HI%IsdB:HI%IedB, HI%JsdB:HI%JedB, GV%ke) :: vort !&lt; Vertical componentof vorticity (s-1)</code></li>
</ul>
<p>The file <a class="el" href="MOM__memory__macros_8h.html" title="Memory macros. ">MOM_memory_macros.h</a> provides the macros <code>SZI_</code>, <code>SZJ_</code>, <code>SZIB_</code> and <code>SZJB_</code> that help make the above more concise:</p><ul>
<li><code>real, dimension(<a class="el" href="MOM__memory__macros_8h.html#a778d74c20afedc458a527b6d5ca06fdc">SZI_(HI)</a>, <a class="el" href="MOM__memory__macros_8h.html#a982673508fcf471cd799850a8ec04cca">SZJ_(HI)</a>) :: D !&lt; Depth at h-points (m)</code></li>
<li><code>real, dimension(<a class="el" href="MOM__memory__macros_8h.html#a368ddc75628f875f9628830c26651e18">SZIB_(HI)</a>, <a class="el" href="MOM__memory__macros_8h.html#a982673508fcf471cd799850a8ec04cca">SZJ_(HI)</a>) :: Du !&lt; Depth at u-points (m)</code></li>
<li><code>real, dimension(<a class="el" href="MOM__memory__macros_8h.html#a778d74c20afedc458a527b6d5ca06fdc">SZI_(HI)</a>, <a class="el" href="MOM__memory__macros_8h.html#a2c9d3957c5b3b5e1b650ae0bc4250531">SZJB_(HI)</a>) :: Dv !&lt; Depth at v-points (m)</code></li>
<li><code>real, dimension(<a class="el" href="MOM__memory__macros_8h.html#a368ddc75628f875f9628830c26651e18">SZIB_(HI)</a>, <a class="el" href="MOM__memory__macros_8h.html#a2c9d3957c5b3b5e1b650ae0bc4250531">SZJB_(HI)</a>) :: Dq !&lt; Depth at q-points (m)</code></li>
</ul>
<p>See <a class="el" href="MOM__memory__macros_8h.html" title="Memory macros. ">MOM_memory_macros.h</a> for the complete list of macros used in various memory modes.</p>
<h1><a class="anchor" id="Global_index"></a>
Calculating a global index</h1>
<p>For the most part MOM6 code should be independent of an equivalent absolute global index. There are exceptions and when the global index of a cell <code>i,j</code> is needed is can be calculated as follows:</p>
<p><code>i_global = i + HI%idg_offset</code></p>
<p>Before the <a class="el" href="structmom__hor__index_1_1hor__index__type.html" title="Container for horizontal index ranges for data, computational and global domains. ...">mom_hor_index::hor_index_type</a> was introduced, this conversion was done use variables in the <a class="el" href="structmom__grid_1_1ocean__grid__type.html" title="Ocean grid type. See mom_grid for details. ">mom_grid::ocean_grid_type</a>:</p>
<p><code>i_global = (i-G%isd) + G%isd_global</code></p>
<p>which is no longer preferred.</p>
<p>Note that a global index only makes sense for a rectangular global domain. If the domain is a Mosaic of connected tiles (e.g. size tiles of a cube) the global indices (i,j) become meaningless. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
