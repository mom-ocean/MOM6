<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_set_diffusivity Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__set__diffusivity.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_set_diffusivity Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__set__diffusivity_1_1diffusivity__diags.html">diffusivity_diags</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a8b1f646393f0ec717ca690e4f04d96e8"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a8b1f646393f0ec717ca690e4f04d96e8">set_diffusivity</a> (u, v, h, u_h, v_h, tv, fluxes, optics, visc, dt, G, GV, CS, Kd, Kd_int)</td></tr>
<tr class="separator:a8b1f646393f0ec717ca690e4f04d96e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a17d34181e20efe93c91a24baba5f1359"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a17d34181e20efe93c91a24baba5f1359">find_tke_to_kd</a> (h, tv, dRho_int, N2_lay, j, dt, G, GV, CS, TKE_to_Kd, maxTKE, kb)</td></tr>
<tr class="separator:a17d34181e20efe93c91a24baba5f1359"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3280e9e2ed60f24be11cb2308dd5a22d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a3280e9e2ed60f24be11cb2308dd5a22d">find_n2</a> (h, tv, T_f, S_f, fluxes, j, G, GV, CS, dRho_int, N2_lay, N2_int, N2_bot)</td></tr>
<tr class="separator:a3280e9e2ed60f24be11cb2308dd5a22d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79611c5775b154d49d3219efde90055c"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a79611c5775b154d49d3219efde90055c">double_diffusion</a> (tv, h, T_f, S_f, j, G, GV, CS, Kd_T_dd, Kd_S_dd)</td></tr>
<tr class="memdesc:a79611c5775b154d49d3219efde90055c"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine sets the additional diffusivities of temperature and salinity due to double diffusion, using the same functional form as is used in MOM4.1, and taken from an NCAR technical note (REF?) that updates what was in Large et al. (1994). All the coefficients here should probably be made run-time variables rather than hard-coded constants.  <a href="#a79611c5775b154d49d3219efde90055c">More...</a><br /></td></tr>
<tr class="separator:a79611c5775b154d49d3219efde90055c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaad945a967cee858d63180245b0e57de"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#aaad945a967cee858d63180245b0e57de">add_drag_diffusivity</a> (h, u, v, tv, fluxes, visc, j, TKE_to_Kd, maxTKE, kb, G, GV, CS, Kd, Kd_int, Kd_BBL)</td></tr>
<tr class="memdesc:aaad945a967cee858d63180245b0e57de"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine adds diffusion sustained by flow energy extracted by bottom drag.  <a href="#aaad945a967cee858d63180245b0e57de">More...</a><br /></td></tr>
<tr class="separator:aaad945a967cee858d63180245b0e57de"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae07e002beec2b76c8cdb1bc52ecfa81f"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#ae07e002beec2b76c8cdb1bc52ecfa81f">add_lotw_bbl_diffusivity</a> (h, u, v, tv, fluxes, visc, j, N2_int, G, GV, CS, Kd, Kd_int, Kd_BBL)</td></tr>
<tr class="memdesc:ae07e002beec2b76c8cdb1bc52ecfa81f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates a BBL diffusivity use a Prandtl number 1 diffusivitiy with a law of the wall turbulent viscosity, up to a BBL height where the energy used for mixing has consumed the mechanical TKE input.  <a href="#ae07e002beec2b76c8cdb1bc52ecfa81f">More...</a><br /></td></tr>
<tr class="separator:ae07e002beec2b76c8cdb1bc52ecfa81f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7ab975ff8ad030b18eb1b294be1947b5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a7ab975ff8ad030b18eb1b294be1947b5">add_mlrad_diffusivity</a> (h, fluxes, j, G, GV, CS, Kd, TKE_to_Kd, Kd_int)</td></tr>
<tr class="memdesc:a7ab975ff8ad030b18eb1b294be1947b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine adds effects of mixed layer radiation to the layer diffusivities.  <a href="#a7ab975ff8ad030b18eb1b294be1947b5">More...</a><br /></td></tr>
<tr class="separator:a7ab975ff8ad030b18eb1b294be1947b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a46f446c690ca20950b890cb71594998a"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a46f446c690ca20950b890cb71594998a">add_int_tide_diffusivity</a> (h, N2_bot, j, TKE_to_Kd, max_TKE, G, GV, CS, dd, N2_lay, Kd, Kd_int)</td></tr>
<tr class="memdesc:a46f446c690ca20950b890cb71594998a"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine adds the effect of internal-tide-driven mixing to the layer diffusivities. The mechanisms considered are (1) local dissipation of internal waves generated by the barotropic flow ("itidal"), (2) local dissipation of internal waves generated by the propagating low modes (rays) of the internal tide ("lowmode"), and (3) local dissipation of internal lee waves. Will eventually need to add diffusivity due to other wave-breaking processes (e.g. Bottom friction, Froude-number-depending breaking, PSI, etc.).  <a href="#a46f446c690ca20950b890cb71594998a">More...</a><br /></td></tr>
<tr class="separator:a46f446c690ca20950b890cb71594998a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc501881a7f9adb5f38c533685857d08"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#acc501881a7f9adb5f38c533685857d08">set_bbl_tke</a> (u, v, h, fluxes, visc, G, GV, CS)</td></tr>
<tr class="memdesc:acc501881a7f9adb5f38c533685857d08"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates several properties related to bottom boundary layer turbulence.  <a href="#acc501881a7f9adb5f38c533685857d08">More...</a><br /></td></tr>
<tr class="separator:acc501881a7f9adb5f38c533685857d08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1b3a63b8470de5a3d9ba9706376281b"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#ae1b3a63b8470de5a3d9ba9706376281b">set_density_ratios</a> (h, tv, kb, G, GV, CS, j, ds_dsp1, rho_0)</td></tr>
<tr class="separator:ae1b3a63b8470de5a3d9ba9706376281b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac0a2a098bc7dc3b087a4bae87511b7ca"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#ac0a2a098bc7dc3b087a4bae87511b7ca">set_diffusivity_init</a> (Time, G, GV, param_file, diag, CS, diag_to_Z_CSp, int_tide_CSp)</td></tr>
<tr class="separator:ac0a2a098bc7dc3b087a4bae87511b7ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace82f133d3cee42aa36ec10bcce79e75"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#ace82f133d3cee42aa36ec10bcce79e75">set_diffusivity_end</a> (CS)</td></tr>
<tr class="separator:ace82f133d3cee42aa36ec10bcce79e75"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a80f458341a9ec8a2f451e35a3ea1612a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a80f458341a9ec8a2f451e35a3ea1612a">stlaurent_profile_string</a> = &quot;STLAURENT_02&quot;</td></tr>
<tr class="separator:a80f458341a9ec8a2f451e35a3ea1612a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3aa76d970d677e933cbb9136e1d289f4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a> *(20), parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a3aa76d970d677e933cbb9136e1d289f4">polzin_profile_string</a> = &quot;POLZIN_09&quot;</td></tr>
<tr class="separator:a3aa76d970d677e933cbb9136e1d289f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20f73bebea2d715292b7297239260127"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a20f73bebea2d715292b7297239260127">stlaurent_02</a> = 1</td></tr>
<tr class="separator:a20f73bebea2d715292b7297239260127"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad5f2d1a5a67a348fcc175baf848204e7"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#ad5f2d1a5a67a348fcc175baf848204e7">polzin_09</a> = 2</td></tr>
<tr class="separator:ad5f2d1a5a67a348fcc175baf848204e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b2144f31cb69fe2481815545253d7c9"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__set__diffusivity.html#a6b2144f31cb69fe2481815545253d7c9">id_clock_kappashear</a></td></tr>
<tr class="separator:a6b2144f31cb69fe2481815545253d7c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="aaad945a967cee858d63180245b0e57de"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaad945a967cee858d63180245b0e57de">&#9670;&nbsp;</a></span>add_drag_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::add_drag_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>maxTKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( g %isd: g %ied), intent(in)&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), pointer&#160;</td>
          <td class="paramname"><em>Kd_BBL</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This routine adds diffusion sustained by flow energy extracted by bottom drag. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity, in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity, in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01428">1428</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: u<span class="comment">    !&lt; The zonal velocity, in m s-1</span></div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: v<span class="comment">    !&lt; The meridional velocity, in m s-1</span></div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                     <span class="keywordtype">intent(in)</span>    :: tv</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  <span class="keywordtype">type</span>(forcing),                             <span class="keywordtype">intent(in)</span>    :: fluxes</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),                       <span class="keywordtype">intent(in)</span>    :: visc</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  <span class="keywordtype">integer</span>,                                   <span class="keywordtype">intent(in)</span>    :: j</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,          <span class="keywordtype">intent(in)</span>    :: tke_to_kd, maxtke</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G))</span>,               <span class="keywordtype">intent(in)</span>    :: kb</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                  <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: kd</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: kd_int</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,                    <span class="keywordtype">pointer</span>       :: kd_bbl</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;<span class="comment">! This routine adds diffusion sustained by flow energy extracted by bottom drag.</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    rint          <span class="comment">! coordinate density of an interface (kg/m3)</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    htot, &amp;       <span class="comment">! total thickness above or below a layer, or the</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;                  <span class="comment">! integrated thickness in the BBL (meter)</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    rho_htot, &amp;   <span class="comment">! running integral with depth of density (kg/m2)</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    gh_sum_top, &amp; <span class="comment">! BBL value of g&#39;h that can be supported by</span></div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                  <span class="comment">! the local ustar, times R0_g (kg/m2)</span></div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    rho_top, &amp;    <span class="comment">! density at top of the BBL (kg/m3)</span></div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    tke, &amp;        <span class="comment">! turbulent kinetic energy available to drive</span></div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;                  <span class="comment">! bottom-boundary layer mixing in a layer (m3/s3)</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    i2decay       <span class="comment">! inverse of twice the TKE decay scale (1/m)</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <span class="keywordtype">real</span>    :: tke_to_layer   <span class="comment">! TKE used to drive mixing in a layer (m3/s3)</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  <span class="keywordtype">real</span>    :: tke_ray        <span class="comment">! TKE from layer Rayleigh drag used to drive mixing in layer (m3/s3)</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <span class="keywordtype">real</span>    :: tke_here       <span class="comment">! TKE that goes into mixing in this layer (m3/s3)</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordtype">real</span>    :: drl, drbot     <span class="comment">! temporaries holding density differences (kg/m3)</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keywordtype">real</span>    :: cdrag_sqrt     <span class="comment">! square root of the drag coefficient (nondimensional)</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <span class="keywordtype">real</span>    :: ustar_h        <span class="comment">! value of ustar at a thickness point (m/s)</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  <span class="keywordtype">real</span>    :: absf           <span class="comment">! average absolute Coriolis parameter around a thickness point (1/s)</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordtype">real</span>    :: r0_g           <span class="comment">! Rho0 / G_Earth (kg s2 m-2)</span></div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  <span class="keywordtype">real</span>    :: i_rho0         <span class="comment">! 1 / RHO0</span></div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  <span class="keywordtype">real</span>    :: delta_kd       <span class="comment">! increment to Kd from the bottom boundary layer mixing (m2/s)</span></div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  <span class="keywordtype">logical</span> :: rayleigh_drag  <span class="comment">! Set to true if Rayleigh drag velocities</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                            <span class="comment">! defined in visc, on the assumption that this</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                            <span class="comment">! extracted energy also drives diapycnal mixing.</span></div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordtype">logical</span> :: domore, do_i(szi_(g))</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;  <span class="keywordtype">logical</span> :: do_diag_kd_bbl</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz, i_rem, kb_min</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;  do_diag_kd_bbl = <span class="keyword">associated</span>(kd_bbl)</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%bottomdraglaw .and. (cs%BBL_effic&gt;0.0))) <span class="keywordflow">return</span></div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;  cdrag_sqrt = sqrt(cs%cdrag)</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  tke_ray = 0.0 ; rayleigh_drag = .false.</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%Ray_u) .and. <span class="keyword">associated</span>(visc%Ray_v)) rayleigh_drag = .true.</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  i_rho0 = 1.0/gv%Rho0</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  r0_g = gv%Rho0/gv%g_Earth</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="keywordflow">do</span> k=2,nz ; rint(k) = 0.5*(gv%Rlay(k-1)+gv%Rlay(k)) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;  kb_min = max(gv%nk_rho_varies+1,2)</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;  <span class="comment">! The turbulence decay scale is 0.5*ustar/f from K&amp;E &amp; MOM_vertvisc.F90</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;  <span class="comment">! Any turbulence that makes it into the mixed layers is assumed</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="comment">! to be relatively small and is discarded.</span></div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    ustar_h = visc%ustar_BBL(i,j)</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%ustar_tidal)) &amp;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;      ustar_h = ustar_h + fluxes%ustar_tidal(i,j)</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;    absf = 0.25*((abs(g%CoriolisBu(i-1,j-1)) + abs(g%CoriolisBu(i,j))) + &amp;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                 (abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j-1))))</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    <span class="keywordflow">if</span> ((ustar_h &gt; 0.0) .and. (absf &gt; 0.5*cs%IMax_decay*ustar_h))  <span class="keywordflow">then</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;      i2decay(i) = absf / ustar_h</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;      <span class="comment">! The maximum decay scale should be something of order 200 m.</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;      <span class="comment">! If ustar_h = 0, this is land so this value doesn&#39;t matter.</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;      i2decay(i) = 0.5*cs%IMax_decay</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    tke(i) = ((cs%BBL_effic * cdrag_sqrt) * &amp;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;              exp(-i2decay(i)*(gv%H_to_m*h(i,j,nz))) ) * &amp;</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;             visc%TKE_BBL(i,j)</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%TKE_tidal)) &amp;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;      tke(i) = tke(i) + fluxes%TKE_tidal(i,j) * i_rho0 * &amp;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;           (cs%BBL_effic * exp(-i2decay(i)*(gv%H_to_m*h(i,j,nz))))</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    <span class="comment">! Distribute the work over a BBL of depth 20^2 ustar^2 / g&#39; following</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    <span class="comment">! Killworth &amp; Edwards (1999) and Zilitikevich &amp; Mironov (1996).</span></div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    <span class="comment">! Rho_top is determined by finding the density where</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    <span class="comment">! integral(bottom, Z) (rho(z&#39;) - rho(Z)) dz&#39; = rho_0 400 ustar^2 / g</span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    gh_sum_top(i) = r0_g * 400.0 * ustar_h**2</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    do_i(i) = (g%mask2dT(i,j) &gt; 0.5)</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    htot(i) = gv%H_to_m*h(i,j,nz)</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;    rho_htot(i) = gv%Rlay(nz)*(gv%H_to_m*h(i,j,nz))</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;    rho_top(i) = gv%Rlay(1)</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;    <span class="keywordflow">if</span> (cs%bulkmixedlayer .and. do_i(i)) rho_top(i) = gv%Rlay(kb(i)-1)</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;  <span class="keywordflow">do</span> k=nz-1,2,-1 ; domore = .false.</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;      htot(i) = htot(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;      rho_htot(i) = rho_htot(i) + gv%Rlay(k)*(gv%H_to_m*h(i,j,k))</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;      <span class="keywordflow">if</span> (htot(i)*gv%Rlay(k-1) &lt;= (rho_htot(i) - gh_sum_top(i))) <span class="keywordflow">then</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        <span class="comment">! The top of the mixing is in the interface atop the current layer.</span></div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;        rho_top(i) = (rho_htot(i) - gh_sum_top(i)) / htot(i)</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        do_i(i) = .false.</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      <span class="keywordflow">elseif</span> (k &lt;= kb(i)) <span class="keywordflow">then</span> ; do_i(i) = .false.</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;      <span class="keywordflow">else</span> ; domore = .true. ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    <span class="keywordflow">if</span> (.not.domore) <span class="keywordflow">exit</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k-loop</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; do_i(i) = (g%mask2dT(i,j) &gt; 0.5) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  <span class="keywordflow">do</span> k=nz-1,kb_min,-1</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    i_rem = 0</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;      <span class="keywordflow">if</span> (k&lt;kb(i)) <span class="keywordflow">then</span> ; do_i(i) = .false. ; cycle ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;      i_rem = i_rem + 1  <span class="comment">! Count the i-rows that are still being worked on.</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;      <span class="comment">!   Apply vertical decay of the turbulent energy.  This energy is</span></div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;      <span class="comment">! simply lost.</span></div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      tke(i) = tke(i) * exp(-i2decay(i) * (gv%H_to_m*(h(i,j,k) + h(i,j,k+1))))</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="comment">!      if (maxEnt(i,k) &lt;= 0.0) cycle</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;      <span class="keywordflow">if</span> (maxtke(i,k) &lt;= 0.0) cycle</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;  <span class="comment">! This is an analytic integral where diffusity is a quadratic function of</span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  <span class="comment">! rho that goes asymptotically to 0 at Rho_top (vaguely following KPP?).</span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      <span class="keywordflow">if</span> (tke(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        <span class="keywordflow">if</span> (rint(k) &lt;= rho_top(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;          tke_to_layer = tke(i)</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;          drl = rint(k+1) - rint(k) ; drbot = rint(k+1) - rho_top(i)</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;          tke_to_layer = tke(i) * drl * (3.0*drbot*(rint(k) - rho_top(i)) +&amp;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                                         drl**2) / drbot**3</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;      <span class="keywordflow">else</span> ; tke_to_layer = 0.0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;      <span class="comment">! TKE_Ray has been initialized to 0 above.</span></div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;      <span class="keywordflow">if</span> (rayleigh_drag) tke_ray = 0.5*cs%BBL_effic * g%IareaT(i,j) * &amp;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;            ((g%areaCu(i-1,j) * visc%Ray_u(i-1,j,k) * u(i-1,j,k)**2 + &amp;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;              g%areaCu(i,j)   * visc%Ray_u(i,j,k)   * u(i,j,k)**2) + &amp;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;             (g%areaCv(i,j-1) * visc%Ray_v(i,j-1,k) * v(i,j-1,k)**2 + &amp;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;              g%areaCv(i,j)   * visc%Ray_v(i,j,k)   * v(i,j,k)**2))</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;      <span class="keywordflow">if</span> (tke_to_layer + tke_ray &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;        <span class="keywordflow">if</span> (cs%BBL_mixing_as_max) <span class="keywordflow">then</span></div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;          <span class="keywordflow">if</span> (tke_to_layer + tke_ray &gt; maxtke(i,k)) &amp;</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;              tke_to_layer = maxtke(i,k) - tke_ray</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;          tke(i) = tke(i) - tke_to_layer</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;          <span class="keywordflow">if</span> (kd(i,j,k) &lt; (tke_to_layer+tke_ray)*tke_to_kd(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;            delta_kd = (tke_to_layer+tke_ray)*tke_to_kd(i,k) - kd(i,j,k)</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;            <span class="keywordflow">if</span> ((cs%Kd_max &gt;= 0.0) .and. (delta_kd &gt; cs%Kd_max)) <span class="keywordflow">then</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;              delta_kd = cs%Kd_Max</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;              kd(i,j,k) = kd(i,j,k) + delta_kd</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;              kd(i,j,k) = (tke_to_layer+tke_ray)*tke_to_kd(i,k)</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            kd_int(i,j,k) = kd_int(i,j,k) + 0.5*delta_kd</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5*delta_kd</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;            <span class="keywordflow">if</span> (do_diag_kd_bbl) <span class="keywordflow">then</span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;              kd_bbl(i,j,k) = kd_bbl(i,j,k) + 0.5*delta_kd</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;              kd_bbl(i,j,k+1) = kd_bbl(i,j,k+1) + 0.5*delta_kd</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;          <span class="keywordflow">if</span> (kd(i,j,k) &gt;= maxtke(i,k)*tke_to_kd(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            tke_here = 0.0</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            tke(i) = tke(i) + tke_ray</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;          <span class="keywordflow">elseif</span> (kd(i,j,k) + (tke_to_layer+tke_ray)*tke_to_kd(i,k) &gt; &amp;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;                  maxtke(i,k)*tke_to_kd(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;            tke_here = ((tke_to_layer+tke_ray) + kd(i,j,k)/tke_to_kd(i,k)) - &amp;</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                       maxtke(i,k)</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            tke(i) = tke(i) - tke_here + tke_ray</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;            tke_here = tke_to_layer + tke_ray</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            tke(i) = tke(i) - tke_to_layer</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;          <span class="keywordflow">if</span> (tke(i) &lt; 0.0) tke(i) = 0.0 <span class="comment">! This should be unnecessary?</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;          <span class="keywordflow">if</span> (tke_here &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;            delta_kd = tke_here*tke_to_kd(i,k)</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;            <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) delta_kd = min(delta_kd, cs%Kd_max)</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;            kd(i,j,k) = kd(i,j,k) + delta_kd</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;            kd_int(i,j,k) = kd_int(i,j,k) + 0.5*delta_kd</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;            kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5*delta_kd</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            <span class="keywordflow">if</span> (do_diag_kd_bbl) <span class="keywordflow">then</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;              kd_bbl(i,j,k) = kd_bbl(i,j,k) + 0.5*delta_kd</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;              kd_bbl(i,j,k+1) = kd_bbl(i,j,k+1) + 0.5*delta_kd</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;      <span class="comment">! This may be risky - in the case that there are exactly zero</span></div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;      <span class="comment">! velocities at 4 neighboring points, but nonzero velocities</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;      <span class="comment">! above the iterations would stop too soon. I don&#39;t see how this</span></div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      <span class="comment">! could happen in practice. RWH</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;      <span class="keywordflow">if</span> ((tke(i)&lt;= 0.0) .and. (tke_ray == 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        do_i(i) = .false. ; i_rem = i_rem - 1</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;    <span class="keywordflow">if</span> (i_rem == 0) <span class="keywordflow">exit</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k-loop</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_aaad945a967cee858d63180245b0e57de_icgraph.svg" width="344" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a46f446c690ca20950b890cb71594998a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a46f446c690ca20950b890cb71594998a">&#9670;&nbsp;</a></span>add_int_tide_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::add_int_tide_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>N2_bot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>max_TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1diffusivity__diags.html">diffusivity_diags</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>dd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>N2_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Kd_int</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine adds the effect of internal-tide-driven mixing to the layer diffusivities. The mechanisms considered are (1) local dissipation of internal waves generated by the barotropic flow ("itidal"), (2) local dissipation of internal waves generated by the propagating low modes (rays) of the internal tide ("lowmode"), and (3) local dissipation of internal lee waves. Will eventually need to add diffusivity due to other wave-breaking processes (e.g. Bottom friction, Froude-number-depending breaking, PSI, etc.). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01921">1921</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00364">polzin_09</a>, and <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00363">stlaurent_02</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,                 <span class="keywordtype">intent(in)</span>    :: n2_bot</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: n2_lay</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: j</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: tke_to_kd, max_tke</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                 <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;  <span class="keywordtype">type</span>(diffusivity_diags),                  <span class="keywordtype">intent(inout)</span> :: dd</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: kd</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: kd_int</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;  <span class="comment">! This subroutine adds the effect of internal-tide-driven mixing to the layer diffusivities.</span></div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;  <span class="comment">! The mechanisms considered are (1) local dissipation of internal waves generated by the</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;  <span class="comment">! barotropic flow (&quot;itidal&quot;), (2) local dissipation of internal waves generated by the propagating</span></div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;  <span class="comment">! low modes (rays) of the internal tide (&quot;lowmode&quot;), and (3) local dissipation of internal lee waves.</span></div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;  <span class="comment">! Will eventually need to add diffusivity due to other wave-breaking processes (e.g. Bottom friction,</span></div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;  <span class="comment">! Froude-number-depending breaking, PSI, etc.).</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;    htot,             &amp; <span class="comment">! total thickness above or below a layer, or the</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;                        <span class="comment">! integrated thickness in the BBL (meter)</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    htot_wkb,         &amp; <span class="comment">! distance from top to bottom (meter) WKB scaled</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    tke_itidal_bot,   &amp; <span class="comment">! internal tide TKE at ocean bottom (m3/s3)</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    tke_niku_bot,     &amp; <span class="comment">! lee-wave TKE at ocean bottom (m3/s3)</span></div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    tke_lowmode_bot,  &amp; <span class="comment">! internal tide TKE at ocean bottom lost from all remote low modes (m3/s3) (BDM)</span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    inv_int,          &amp; <span class="comment">! inverse of TKE decay for int tide over the depth of the ocean (nondim)</span></div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    inv_int_lee,      &amp; <span class="comment">! inverse of TKE decay for lee waves over the depth of the ocean (nondim)</span></div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    inv_int_low,      &amp; <span class="comment">! inverse of TKE decay for low modes over the depth of the ocean (nondim) (BDM)</span></div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    z0_polzin,        &amp; <span class="comment">! TKE decay scale in Polzin formulation (meter)</span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    z0_polzin_scaled, &amp; <span class="comment">! TKE decay scale in Polzin formulation (meter)</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;                        <span class="comment">! multiplied by N2_bot/N2_meanz to be coherent with the WKB scaled z</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;                        <span class="comment">! z*=int(N2/N2_bot) * N2_bot/N2_meanz = int(N2/N2_meanz)</span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;                        <span class="comment">! z0_Polzin_scaled = z0_Polzin * N2_bot/N2_meanz</span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;    n2_meanz,         &amp; <span class="comment">! vertically averaged squared buoyancy frequency (1/s2) for WKB scaling</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    tke_itidal_rem,   &amp; <span class="comment">! remaining internal tide TKE (from barotropic source)</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    tke_niku_rem,     &amp; <span class="comment">! remaining lee-wave TKE</span></div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    tke_lowmode_rem,  &amp; <span class="comment">! remaining internal tide TKE (from propagating low mode source) (BDM)</span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    tke_frac_top,     &amp; <span class="comment">! fraction of bottom TKE that should appear at top of a layer (nondim)</span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;    tke_frac_top_lee, &amp; <span class="comment">! fraction of bottom TKE that should appear at top of a layer (nondim)</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;    tke_frac_top_lowmode, &amp;</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;                        <span class="comment">! fraction of bottom TKE that should appear at top of a layer (nondim) (BDM)</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    z_from_bot,       &amp; <span class="comment">! distance from bottom (meter)</span></div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;    z_from_bot_wkb      <span class="comment">! distance from bottom (meter), WKB scaled</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;  <span class="keywordtype">real</span> :: i_rho0        <span class="comment">! 1 / RHO0, (m3/kg)</span></div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;  <span class="keywordtype">real</span> :: kd_add        <span class="comment">! diffusivity to add in a layer (m2/sec)</span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;  <span class="keywordtype">real</span> :: tke_itide_lay <span class="comment">! internal tide TKE imparted to a layer (from barotropic) (m3/s3)</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;  <span class="keywordtype">real</span> :: tke_niku_lay  <span class="comment">! lee-wave TKE imparted to a layer (m3/s3)</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  <span class="keywordtype">real</span> :: tke_lowmode_lay <span class="comment">! internal tide TKE imparted to a layer (from low mode) (m3/s3) (BDM)</span></div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;  <span class="keywordtype">real</span> :: frac_used     <span class="comment">! fraction of TKE that can be used in a layer (nondim)</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;  <span class="keywordtype">real</span> :: izeta         <span class="comment">! inverse of TKE decay scale (1/meter)</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  <span class="keywordtype">real</span> :: izeta_lee     <span class="comment">! inverse of TKE decay scale for lee waves (1/meter)</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;  <span class="keywordtype">real</span> :: z0_psl        <span class="comment">! temporary variable with units of meter</span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;  <span class="keywordtype">real</span> :: tke_lowmode_tot <span class="comment">! TKE from all low modes (W/m2) (BDM)</span></div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;  <span class="keywordtype">logical</span> :: use_polzin, use_simmons</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;  <span class="keywordtype">integer</span> :: a, fr, m</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation)) <span class="keywordflow">return</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; htot(i) = 0.0 ; inv_int(i) = 0.0 ; inv_int_lee(i) = 0.0 ; inv_int_low(i) = 0.0 ;<span class="keywordflow">enddo</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;    htot(i) = htot(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;  i_rho0 = 1.0/gv%Rho0</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;  use_polzin = ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09)) .or. &amp;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;                (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09)) .or. &amp;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;                (cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == polzin_09)))</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;  use_simmons = ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == stlaurent_02)) .or. &amp;</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;                 (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == stlaurent_02)) .or. &amp;</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;                 (cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == stlaurent_02)))</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;  <span class="comment">! Calculate parameters for vertical structure of dissipation</span></div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  <span class="comment">! Simmons:</span></div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;  <span class="keywordflow">if</span> ( use_simmons ) <span class="keywordflow">then</span></div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    izeta = 1.0 / max(cs%Int_tide_decay_scale, gv%H_subroundoff*gv%H_to_m)</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    izeta_lee = 1.0 / max(cs%Int_tide_decay_scale*cs%Decay_scale_factor_lee, &amp;</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;                          gv%H_subroundoff*gv%H_to_m)</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;      cs%Nb(i,j) = sqrt(n2_bot(i))</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) dd%N2_bot(i,j) = n2_bot(i)</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;      <span class="keywordflow">if</span> ( cs%Int_tide_dissipation ) <span class="keywordflow">then</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;        <span class="keywordflow">if</span> (izeta*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span> <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;          inv_int(i) = 1.0 / (1.0 - exp(-izeta*htot(i)))</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;      <span class="keywordflow">if</span> ( cs%Lee_wave_dissipation ) <span class="keywordflow">then</span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;        <span class="keywordflow">if</span> (izeta_lee*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span>  <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;          inv_int_lee(i) = 1.0 / (1.0 - exp(-izeta_lee*htot(i)))</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;      <span class="keywordflow">if</span> ( cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;        <span class="keywordflow">if</span> (izeta*htot(i) &gt; 1.0e-14) <span class="keywordflow">then</span> <span class="comment">! L&#39;Hospital&#39;s version of Adcroft&#39;s reciprocal rule.</span></div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;          inv_int_low(i) = 1.0 / (1.0 - exp(-izeta*htot(i)))</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;      z_from_bot(i) = gv%H_to_m*h(i,j,nz)</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Simmons</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;  <span class="comment">! Polzin:</span></div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;  <span class="keywordflow">if</span> ( use_polzin ) <span class="keywordflow">then</span></div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    <span class="comment">! WKB scaling of the vertical coordinate</span></div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; n2_meanz(i)=0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;      n2_meanz(i) = n2_meanz(i) + n2_lay(i,k)*gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;      n2_meanz(i) = n2_meanz(i) / (htot(i) + gv%H_subroundoff*gv%H_to_m)</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_meanz))  dd%N2_meanz(i,j) = n2_meanz(i)</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    <span class="comment">! WKB scaled z*(z=H) z* at the surface using the modified Polzin WKB scaling</span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; htot_wkb(i) = htot(i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;<span class="comment">!    do i=is,ie ; htot_WKB(i) = 0.0 ; enddo</span></div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="comment">!    do k=1,nz ; do i=is,ie</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="comment">!      htot_WKB(i) = htot_WKB(i) + GV%H_to_m*h(i,j,k)*N2_lay(i,k) / N2_meanz(i)</span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;<span class="comment">!    enddo ; enddo</span></div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    <span class="comment">! htot_WKB(i) = htot(i) ! Nearly equivalent and simpler</span></div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;      cs%Nb(i,j) = sqrt(n2_bot(i))</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;      <span class="keywordflow">if</span> ((cs%tideamp(i,j) &gt; 0.0) .and. &amp;</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;          (cs%kappa_itides**2 * cs%h2(i,j) * cs%Nb(i,j)**3 &gt; 1.0e-14) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;        z0_polzin(i) = cs%Polzin_decay_scale_factor * cs%Nu_Polzin * &amp;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                       cs%Nbotref_Polzin**2 * cs%tideamp(i,j) / &amp;</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;                     ( cs%kappa_itides**2 * cs%h2(i,j) * cs%Nb(i,j)**3 )</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;        <span class="keywordflow">if</span> (z0_polzin(i) &lt; cs%Polzin_min_decay_scale) &amp;</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;          z0_polzin(i) = cs%Polzin_min_decay_scale</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;        <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14  ) <span class="keywordflow">then</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;          z0_polzin_scaled(i) = z0_polzin(i)*cs%Nb(i,j)**2 / n2_meanz(i)</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;          z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="keywordflow">if</span> (z0_polzin_scaled(i) &gt; (cs%Polzin_decay_scale_max_factor * htot(i)) ) &amp;</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;          z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;        z0_polzin(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;        z0_polzin_scaled(i) = cs%Polzin_decay_scale_max_factor * htot(i)</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale)) &amp;</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        dd%Polzin_decay_scale(i,j) = z0_polzin(i)</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale_scaled)) &amp;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;        dd%Polzin_decay_scale_scaled(i,j) = z0_polzin_scaled(i)</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) dd%N2_bot(i,j) = cs%Nb(i,j)*cs%Nb(i,j)</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;      <span class="keywordflow">if</span> ( cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14) <span class="keywordflow">then</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;          inv_int(i) = ( z0_polzin_scaled(i) / htot_wkb(i) ) + 1</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;      <span class="keywordflow">if</span> ( cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14) <span class="keywordflow">then</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;          inv_int_lee(i) = ( z0_polzin_scaled(i)*cs%Decay_scale_factor_lee / htot_wkb(i) ) + 1</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;      <span class="keywordflow">if</span> ( cs%Lowmode_itidal_dissipation .and. (cs%int_tide_profile == polzin_09) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        <span class="comment">! For the Polzin formulation, this if loop prevents the vertical</span></div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        <span class="comment">! flux of energy dissipation from having NaN values</span></div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        <span class="keywordflow">if</span> (htot_wkb(i) &gt; 1.0e-14) <span class="keywordflow">then</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;          inv_int_low(i) = ( z0_polzin_scaled(i) / htot_wkb(i) ) + 1</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;      z_from_bot(i) = gv%H_to_m*h(i,j,nz)</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;      <span class="comment">! Use the new formulation for WKB scaling.  N2 is referenced to its</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;      <span class="comment">! vertical mean.</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;      <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        z_from_bot_wkb(i) = gv%H_to_m*h(i,j,nz)*n2_lay(i,nz) / n2_meanz(i)</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;      <span class="keywordflow">else</span> ; z_from_bot_wkb(i) = 0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="keywordflow">  endif</span>  <span class="comment">! Polzin</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;  <span class="comment">! Calculate/get dissipation values at bottom</span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;  <span class="comment">! Both Polzin and Simmons:</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    <span class="comment">! Dissipation of locally trapped internal tide (non-propagating high modes)</span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    tke_itidal_bot(i) = min(cs%TKE_itidal(i,j)*cs%Nb(i,j),cs%TKE_itide_max)</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_itidal_used)) &amp;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;      dd%TKE_itidal_used(i,j) = tke_itidal_bot(i)</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    tke_itidal_bot(i) = (i_rho0 * cs%Mu_itides * cs%Gamma_itides) * tke_itidal_bot(i)</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <span class="comment">! Dissipation of locally trapped lee waves</span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;    tke_niku_bot(i) = 0.0</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;      tke_niku_bot(i) = (i_rho0 * cs%Mu_itides * cs%Gamma_lee) * cs%TKE_Niku(i,j)</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;    <span class="comment">! Dissipation of propagating internal tide (baroclinic low modes; rays) (BDM)</span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    tke_lowmode_tot    = 0.0</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;    tke_lowmode_bot(i) = 0.0</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <span class="keywordflow">if</span> (cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;      <span class="comment">! get loss rate due to wave drag on low modes (already multiplied by q)</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;      <span class="keyword">call </span>get_lowmode_loss(i,j,g,cs%int_tide_CSp,<span class="stringliteral">&quot;WaveDrag&quot;</span>,tke_lowmode_tot)</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;      tke_lowmode_bot(i) = cs%Mu_itides * i_rho0 * tke_lowmode_tot</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    <span class="comment">! Vertical energy flux at bottom</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;    tke_itidal_rem(i)  = inv_int(i)     * tke_itidal_bot(i)</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;    tke_niku_rem(i)    = inv_int_lee(i) * tke_niku_bot(i)</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;    tke_lowmode_rem(i) = inv_int_low(i) * tke_lowmode_bot(i)</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,nz) = tke_itidal_rem(i) <span class="comment">!why is this here? BDM</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;  <span class="comment">! Estimate the work that would be done by mixing in each layer.</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;  <span class="comment">! Simmons:</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;  <span class="keywordflow">if</span> ( use_simmons ) <span class="keywordflow">then</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    <span class="keywordflow">do</span> k=nz-1,2,-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;      <span class="keywordflow">if</span> (max_tke(i,k) &lt;= 0.0) cycle</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;      z_from_bot(i) = z_from_bot(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;      <span class="comment">! Fraction of bottom flux predicted to reach top of this layer</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;      tke_frac_top(i)         = inv_int(i)     * exp(-izeta * z_from_bot(i))</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      tke_frac_top_lee(i)     = inv_int_lee(i) * exp(-izeta_lee * z_from_bot(i))</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;      tke_frac_top_lowmode(i) = inv_int_low(i) * exp(-izeta * z_from_bot(i))</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;      <span class="comment">! Actual influx at bottom of layer minus predicted outflux at top of layer to give</span></div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;      <span class="comment">! predicted power expended</span></div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;      tke_itide_lay   = tke_itidal_rem(i)  - tke_itidal_bot(i) * tke_frac_top(i)</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;      tke_niku_lay    = tke_niku_rem(i)    - tke_niku_bot(i)   * tke_frac_top_lee(i)</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;      tke_lowmode_lay = tke_lowmode_rem(i) - tke_lowmode_bot(i)* tke_frac_top_lowmode(i)</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;      <span class="comment">! Actual power expended may be less than predicted if stratification is weak; adjust</span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;      <span class="keywordflow">if</span> (tke_itide_lay + tke_niku_lay + tke_lowmode_lay &gt; max_tke(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;         frac_used = max_tke(i,k) / (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;         tke_itide_lay   = frac_used * tke_itide_lay</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;         tke_niku_lay    = frac_used * tke_niku_lay</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;         tke_lowmode_lay = frac_used * tke_lowmode_lay</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;      <span class="comment">! Calculate vertical flux available to bottom of layer above</span></div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;      tke_itidal_rem(i)  = tke_itidal_rem(i)  - tke_itide_lay</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;      tke_niku_rem(i)    = tke_niku_rem(i)    - tke_niku_lay</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;      tke_lowmode_rem(i) = tke_lowmode_rem(i) - tke_lowmode_lay</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;      <span class="comment">! Convert power to diffusivity</span></div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;      kd_add  = tke_to_kd(i,k) * (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;      <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;      kd(i,j,k) = kd(i,j,k) + kd_add</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;        kd_int(i,j,k)   = kd_int(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;        kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;      <span class="comment">! diagnostics</span></div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;        <span class="comment">! If at layers, dd%Kd_itidal is just TKE_to_Kd(i,k) * TKE_itide_lay</span></div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        kd_add = tke_to_kd(i,k) * tke_itide_lay</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_itidal(i,j,k)   = dd%Kd_itidal(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_itidal(i,j,k+1) = dd%Kd_itidal(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_work)) &amp;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;        dd%Kd_itidal_work(i,j,k) = gv%Rho0 * tke_itide_lay</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,k) = tke_itidal_rem(i)</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keywordflow">then</span></div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="comment">! If at layers, dd%Kd_Niku(i,j,K) is just TKE_to_Kd(i,k) * TKE_Niku_lay</span></div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;        kd_add = tke_to_kd(i,k) * tke_niku_lay</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        <span class="keywordflow">if</span> (k&gt;1) dd%Kd_Niku(i,j,k)    = dd%Kd_Niku(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_Niku(i,j,k+1) = dd%Kd_Niku(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="comment">!     if (associated(dd%Kd_Niku)) dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) &amp;</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;        dd%Kd_Niku_work(i,j,k) = gv%Rho0 * tke_niku_lay</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keywordflow">then</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;        <span class="comment">! If at layers, dd%Kd_lowmode is just TKE_to_Kd(i,k) * TKE_lowmode_lay</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;        kd_add = tke_to_kd(i,k) * tke_lowmode_lay</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_lowmode(i,j,k)   = dd%Kd_lowmode(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_lowmode(i,j,k+1) = dd%Kd_lowmode(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode_work)) &amp;</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;        dd%Kd_lowmode_work(i,j,k) = gv%Rho0 * tke_lowmode_lay</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) dd%Fl_lowmode(i,j,k) = tke_lowmode_rem(i)</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Simmons</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;  <span class="comment">! Polzin:</span></div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;  <span class="keywordflow">if</span> ( use_polzin ) <span class="keywordflow">then</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    <span class="keywordflow">do</span> k=nz-1,2,-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;      <span class="keywordflow">if</span> (max_tke(i,k) &lt;= 0.0) cycle</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;      z_from_bot(i) = z_from_bot(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;      <span class="keywordflow">if</span> (n2_meanz(i) &gt; 1.0e-14 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;        z_from_bot_wkb(i) = z_from_bot_wkb(i) + gv%H_to_m*h(i,j,k)*n2_lay(i,k)/n2_meanz(i)</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;      <span class="keywordflow">else</span> ; z_from_bot_wkb(i) = 0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;      <span class="comment">! Fraction of bottom flux predicted to reach top of this layer</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;      tke_frac_top(i)     = ( inv_int(i) * z0_polzin_scaled(i) ) / &amp;</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;                            ( z0_polzin_scaled(i) + z_from_bot_wkb(i) )</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;      z0_psl = z0_polzin_scaled(i)*cs%Decay_scale_factor_lee</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;      tke_frac_top_lee(i) = (inv_int_lee(i) * z0_psl) / (z0_psl + z_from_bot_wkb(i))</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;      tke_frac_top_lowmode(i) = ( inv_int_low(i) * z0_polzin_scaled(i) ) / &amp;</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;                            ( z0_polzin_scaled(i) + z_from_bot_wkb(i) )</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;      <span class="comment">! Actual influx at bottom of layer minus predicted outflux at top of layer to give</span></div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;      <span class="comment">! predicted power expended</span></div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;      tke_itide_lay   = tke_itidal_rem(i)  - tke_itidal_bot(i) *tke_frac_top(i)</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;      tke_niku_lay    = tke_niku_rem(i)    - tke_niku_bot(i)   * tke_frac_top_lee(i)</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;      tke_lowmode_lay = tke_lowmode_rem(i) - tke_lowmode_bot(i)*tke_frac_top_lowmode(i)</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;      <span class="comment">! Actual power expended may be less than predicted if stratification is weak; adjust</span></div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;      <span class="keywordflow">if</span> (tke_itide_lay + tke_niku_lay + tke_lowmode_lay &gt; max_tke(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;        frac_used = max_tke(i,k) / (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;        tke_itide_lay   = frac_used * tke_itide_lay</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;        tke_niku_lay    = frac_used * tke_niku_lay</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;        tke_lowmode_lay = frac_used * tke_lowmode_lay</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;      <span class="comment">! Calculate vertical flux available to bottom of layer above</span></div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;      tke_itidal_rem(i)  = tke_itidal_rem(i)  - tke_itide_lay</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;      tke_niku_rem(i)    = tke_niku_rem(i)    - tke_niku_lay</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;      tke_lowmode_rem(i) = tke_lowmode_rem(i) - tke_lowmode_lay</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;      <span class="comment">! Convert power to diffusivity</span></div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;      kd_add  = tke_to_kd(i,k) * (tke_itide_lay + tke_niku_lay + tke_lowmode_lay)</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;      <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;      kd(i,j,k) = kd(i,j,k) + kd_add</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        kd_int(i,j,k)   = kd_int(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;        kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;      <span class="comment">! diagnostics</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keywordflow">then</span></div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        <span class="comment">! If at layers, this is just dd%Kd_itidal(i,j,K) = TKE_to_Kd(i,k) * TKE_itide_lay</span></div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        kd_add = tke_to_kd(i,k) * tke_itide_lay</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_itidal(i,j,k)   = dd%Kd_itidal(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_itidal(i,j,k+1) = dd%Kd_itidal(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_work)) &amp;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;        dd%Kd_itidal_work(i,j,k) = gv%Rho0 * tke_itide_lay</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) dd%Fl_itidal(i,j,k) = tke_itidal_rem(i)</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keywordflow">then</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;        <span class="comment">! If at layers, this is just dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        kd_add = tke_to_kd(i,k) * tke_niku_lay</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;        <span class="keywordflow">if</span> (k&gt;1) dd%Kd_Niku(i,j,k)    = dd%Kd_Niku(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_Niku(i,j,k+1) = dd%Kd_Niku(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;   <span class="comment">!  if (associated(dd%Kd_Niku)) dd%Kd_Niku(i,j,K) = TKE_to_Kd(i,k) * TKE_Niku_lay</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) dd%Kd_Niku_work(i,j,k) = gv%Rho0 * tke_niku_lay</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keywordflow">then</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;        <span class="comment">! If at layers, dd%Kd_lowmode is just TKE_to_Kd(i,k) * TKE_lowmode_lay</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;        <span class="comment">! The following sets the interface diagnostics.</span></div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;        kd_add = tke_to_kd(i,k) * tke_lowmode_lay</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;        <span class="keywordflow">if</span> (cs%Kd_max &gt;= 0.0) kd_add = min(kd_add, cs%Kd_max)</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;        <span class="keywordflow">if</span> (k&gt;1)  dd%Kd_lowmode(i,j,k)   = dd%Kd_lowmode(i,j,k)   + 0.5*kd_add</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;        <span class="keywordflow">if</span> (k&lt;nz) dd%Kd_lowmode(i,j,k+1) = dd%Kd_lowmode(i,j,k+1) + 0.5*kd_add</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode_work)) &amp;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;        dd%Kd_lowmode_work(i,j,k) = gv%Rho0 * tke_lowmode_lay</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) dd%Fl_lowmode(i,j,k) = tke_lowmode_rem(i)</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="keywordflow">    enddo</span> ; enddo;</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Polzin</span></div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a46f446c690ca20950b890cb71594998a_icgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ae07e002beec2b76c8cdb1bc52ecfa81f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae07e002beec2b76c8cdb1bc52ecfa81f">&#9670;&nbsp;</a></span>add_lotw_bbl_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::add_lotw_bbl_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>N2_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), pointer&#160;</td>
          <td class="paramname"><em>Kd_BBL</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates a BBL diffusivity use a Prandtl number 1 diffusivitiy with a law of the wall turbulent viscosity, up to a BBL height where the energy used for mixing has consumed the mechanical TKE input. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>u component of flow (m s-1)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>v component of flow (m s-1)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness (m or kg m-2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamic variables structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Surface fluxes structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Vertical viscosity structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index of row to work on</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n2_int</td><td>Square of Brunt-Vaisala at interfaces (s-2)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Diffusivity control structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd</td><td>Layer net diffusivity (m2 s-1)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kd_int</td><td>Interface net diffusivity (m2 s-1)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">kd_bbl</td><td>Interface BBL diffusivity (m2 s-1) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01648">1648</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                        <span class="keywordtype">intent(in)</span>    :: g<span class="comment"> !&lt; Grid structure</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                      <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Vertical grid structure</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>,    <span class="keywordtype">intent(in)</span>    :: u<span class="comment"> !&lt; u component of flow (m s-1)</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>,    <span class="keywordtype">intent(in)</span>    :: v<span class="comment"> !&lt; v component of flow (m s-1)</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,     <span class="keywordtype">intent(in)</span>    :: h<span class="comment"> !&lt; Layer thickness (m or kg m-2)</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                        <span class="keywordtype">intent(in)</span>    :: tv<span class="comment"> !&lt; Thermodynamic variables structure</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;  <span class="keywordtype">type</span>(forcing),                                <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment"> !&lt; Surface fluxes structure</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),                          <span class="keywordtype">intent(in)</span>    :: visc<span class="comment"> !&lt; Vertical viscosity structure</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;  <span class="keywordtype">integer</span>,                                      <span class="keywordtype">intent(in)</span>    :: j<span class="comment"> !&lt; j-index of row to work on</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>,           <span class="keywordtype">intent(in)</span>    :: n2_int<span class="comment"> !&lt; Square of Brunt-Vaisala at interfaces (s-2)</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                     <span class="keywordtype">pointer</span>       :: cs<span class="comment"> !&lt; Diffusivity control structure</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,     <span class="keywordtype">intent(inout)</span> :: kd<span class="comment"> !&lt; Layer net diffusivity (m2 s-1)</span></div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>,   <span class="keywordtype">intent(inout)</span> :: kd_int<span class="comment"> !&lt; Interface net diffusivity (m2 s-1)</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,                       <span class="keywordtype">pointer</span>       :: kd_bbl<span class="comment"> !&lt; Interface BBL diffusivity (m2 s-1)</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;  <span class="keywordtype">real</span> :: tke_column       <span class="comment">! net TKE input into the column (m3 s-3)</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;  <span class="keywordtype">real</span> :: tke_to_layer     <span class="comment">! TKE used to drive mixing in a layer (m3 s-3)</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;  <span class="keywordtype">real</span> :: tke_ray          <span class="comment">! TKE from a layer Rayleigh drag used to drive mixing in that layer (m3 s-3)</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;  <span class="keywordtype">real</span> :: tke_remaining    <span class="comment">! remaining TKE available for mixing in this layer and above (m3 s-3)</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;  <span class="keywordtype">real</span> :: tke_consumed     <span class="comment">! TKE used for mixing in this layer (m3 s-3)</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;  <span class="keywordtype">real</span> :: tke_kd_wall      <span class="comment">! TKE associated with unlimited law of the wall mixing (m3 s-3)</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;  <span class="keywordtype">real</span> :: cdrag_sqrt       <span class="comment">! square root of the drag coefficient (nondimensional)</span></div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;  <span class="keywordtype">real</span> :: ustar            <span class="comment">! value of ustar at a thickness point (m/s)</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;  <span class="keywordtype">real</span> :: ustar2           <span class="comment">! square of ustar, for convenience (m2/s2)</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;  <span class="keywordtype">real</span> :: absf             <span class="comment">! average absolute value of Coriolis parameter around a thickness point (1/sec)</span></div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;  <span class="keywordtype">real</span> :: dh, dhm1         <span class="comment">! thickness of layers k and k-1, respecitvely (meter)</span></div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;  <span class="keywordtype">real</span> :: z                <span class="comment">! distance to interface k from bottom (meter)</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;  <span class="keywordtype">real</span> :: d_minus_z        <span class="comment">! distance to interface k from surface (meter)</span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;  <span class="keywordtype">real</span> :: total_thickness  <span class="comment">! total thickness of water column (meter)</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;  <span class="keywordtype">real</span> :: idecay           <span class="comment">! inverse of decay scale used for &quot;Joule heating&quot; loss of TKE with height (1/m)</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;  <span class="keywordtype">real</span> :: kd_wall          <span class="comment">! Law of the wall diffusivity (m2/s)</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;  <span class="keywordtype">real</span> :: kd_lower         <span class="comment">! diffusivity for lower interface (m2/sec)</span></div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;  <span class="keywordtype">real</span> :: ustar_d          <span class="comment">! u* x D  (m2/s)</span></div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;  <span class="keywordtype">real</span> :: i_rho0           <span class="comment">! 1 / rho0</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  <span class="keywordtype">real</span> :: n2_min           <span class="comment">! Minimum value of N2 to use in calculation of TKE_Kd_wall (1/s2)</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;  <span class="keywordtype">logical</span> :: rayleigh_drag <span class="comment">! Set to true if there are Rayleigh drag velocities defined in visc, on</span></div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;                           <span class="comment">! the assumption that this extracted energy also drives diapycnal mixing.</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;  <span class="keywordtype">integer</span> :: i, k, km1</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: von_karm = 0.41 <span class="comment">! Von Karman constant (http://en.wikipedia.org/wiki/Von_Karman_constant)</span></div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;  <span class="keywordtype">logical</span> :: do_diag_kd_bbl</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%bottomdraglaw .and. (cs%BBL_effic&gt;0.0))) <span class="keywordflow">return</span></div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;  do_diag_kd_bbl = <span class="keyword">associated</span>(kd_bbl)</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;  n2_min = 0.</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;  <span class="keywordflow">if</span> (cs%LOTW_BBL_use_omega) n2_min = (cs%omega**2)</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;  <span class="comment">! Determine whether to add Rayleigh drag contribution to TKE</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;  rayleigh_drag = .false.</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%Ray_u) .and. <span class="keyword">associated</span>(visc%Ray_v)) rayleigh_drag = .true.</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;  i_rho0 = 1.0/gv%Rho0</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;  cdrag_sqrt = sqrt(cs%cdrag)</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;  tke_ray = 0. <span class="comment">! In case Rayleigh_drag is not used.</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;  <span class="keywordflow">do</span> i=g%isc,g%iec <span class="comment">! Developed in single-column mode</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;    <span class="comment">! Column-wise parameters.</span></div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    absf = 0.25*((abs(g%CoriolisBu(i-1,j-1)) + abs(g%CoriolisBu(i,j))) + &amp;</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                 (abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j-1)))) <span class="comment">! Non-zero on equator!</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    <span class="comment">! u* at the bottom, in m s-1.</span></div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    ustar = visc%ustar_BBL(i,j)</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    ustar2 = ustar**2</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    <span class="comment">! In add_drag_diffusivity(), fluxes%ustar_tidal is added in. This might be double counting</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    <span class="comment">! since ustar_BBL should already include all contributions to u*? -AJA</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%ustar_tidal)) ustar = ustar + fluxes%ustar_tidal(i,j)</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <span class="comment">! The maximum decay scale should be something of order 200 m. We use the smaller of u*/f and</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    <span class="comment">! (IMax_decay)^-1 as the decay scale. If ustar = 0, this is land so this value doesn&#39;t matter.</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    idecay = cs%IMax_decay</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <span class="keywordflow">if</span> ((ustar &gt; 0.0) .and. (absf &gt; cs%IMax_decay*ustar)) idecay = absf / ustar</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    <span class="comment">! Energy input at the bottom, in m3 s-3.</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <span class="comment">! (Note that visc%TKE_BBL is in m3 s-3, set in set_BBL_TKE().)</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;    <span class="comment">! I am still unsure about sqrt(cdrag) in this expressions - AJA</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    tke_column = cdrag_sqrt * visc%TKE_BBL(i,j)</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    <span class="comment">! Add in tidal dissipation energy at the bottom, in m3 s-3.</span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    <span class="comment">! Note that TKE_tidal is in W m-2.</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%TKE_tidal)) tke_column = tke_column + fluxes%TKE_tidal(i,j) * i_rho0</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    tke_column = cs%BBL_effic * tke_column <span class="comment">! Only use a fraction of the mechanical dissipation for mixing.</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    tke_remaining = tke_column</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    total_thickness = ( sum(h(i,j,:)) + gv%H_subroundoff )* gv%H_to_m <span class="comment">! Total column thickness, in m.</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    ustar_d = ustar * total_thickness</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;    z = 0.</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    kd_lower = 0. <span class="comment">! Diffusivity on bottom boundary.</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    <span class="comment">! Work upwards from the bottom, accumulating work used until it exceeds the available TKE input</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;    <span class="comment">! at the bottom.</span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    <span class="keywordflow">do</span> k=g%ke,2,-1</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;      dh = gv%H_to_m * h(i,j,k) <span class="comment">! Thickness of this level in m.</span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;      km1 = max(k-1, 1)</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;      dhm1 = gv%H_to_m * h(i,j,km1) <span class="comment">! Thickness of level above in m.</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;      <span class="comment">! Add in additional energy input from bottom-drag against slopes (sides)</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;      <span class="keywordflow">if</span> (rayleigh_drag) tke_remaining = tke_remaining + 0.5*cs%BBL_effic * g%IareaT(i,j) * &amp;</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;            ((g%areaCu(i-1,j) * visc%Ray_u(i-1,j,k) * u(i-1,j,k)**2 + &amp;</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;              g%areaCu(i,j)   * visc%Ray_u(i,j,k)   * u(i,j,k)**2) + &amp;</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;             (g%areaCv(i,j-1) * visc%Ray_v(i,j-1,k) * v(i,j-1,k)**2 + &amp;</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;              g%areaCv(i,j)   * visc%Ray_v(i,j,k)   * v(i,j,k)**2))</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;      <span class="comment">! Exponentially decay TKE across the thickness of the layer.</span></div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;      <span class="comment">! This is energy loss in addition to work done as mixing, apparently to Joule heating.</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;      tke_remaining = exp(-idecay*dh) * tke_remaining</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;      z = z + h(i,j,k)*gv%H_to_m <span class="comment">! Distance between upper interface of layer and the bottom, in m.</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;      d_minus_z = max(total_thickness - z, 0.) <span class="comment">! Thickness above layer, m.</span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;      <span class="comment">! Diffusivity using law of the wall, limited by rotation, at height z, in m2/s.</span></div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;      <span class="comment">! This calculation is at the upper interface of the layer</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;      <span class="keywordflow">if</span> ( ustar_d + absf * ( z * d_minus_z ) == 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;        kd_wall = 0.</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;        kd_wall = ( ( von_karm * ustar2 ) * ( z * d_minus_z ) )/( ustar_d + absf * ( z * d_minus_z ) )</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;      <span class="comment">! TKE associated with Kd_wall, in m3 s-2.</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;      <span class="comment">! This calculation if for the volume spanning the interface.</span></div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;      tke_kd_wall = kd_wall * 0.5 * (dh + dhm1) * max(n2_int(i,k), n2_min)</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;      <span class="comment">! Now bound Kd such that the associated TKE is no greater than available TKE for mixing.</span></div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;      <span class="keywordflow">if</span> (tke_kd_wall&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;        tke_consumed = min(tke_kd_wall, tke_remaining)</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        kd_wall = (tke_consumed/tke_kd_wall) * kd_wall <span class="comment">! Scale Kd so that only TKE_consumed is used.</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        <span class="comment">! Either N2=0 or dh = 0.</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        <span class="keywordflow">if</span> (tke_remaining&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;          kd_wall = cs%Kd_max</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;          kd_wall = 0.</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;        tke_consumed = 0.</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;      <span class="comment">! Now use up the appropriate about of TKE associated with the diffusivity chosen</span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;      tke_remaining = tke_remaining - tke_consumed <span class="comment">! Note this will be non-negative</span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;      <span class="comment">! Add this BBL diffusivity to the model net diffusivity.</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;      kd_int(i,j,k) = kd_int(i,j,k) + kd_wall</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;      kd(i,j,k) = kd(i,j,k) + 0.5*(kd_wall + kd_lower)</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;      kd_lower = kd_wall <span class="comment">! Store for next level up.</span></div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;      <span class="keywordflow">if</span> (do_diag_kd_bbl) kd_bbl(i,j,k) = kd_wall</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! k</span></div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! i</span></div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_ae07e002beec2b76c8cdb1bc52ecfa81f_icgraph.svg" width="367" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a7ab975ff8ad030b18eb1b294be1947b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7ab975ff8ad030b18eb1b294be1947b5">&#9670;&nbsp;</a></span>add_mlrad_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::add_mlrad_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)+1), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Kd_int</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This routine adds effects of mixed layer radiation to the layer diffusivities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01797">1797</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;  <span class="keywordtype">type</span>(forcing),                            <span class="keywordtype">intent(in)</span>    :: fluxes</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: j</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                 <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: kd</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: tke_to_kd</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: kd_int</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;<span class="comment">! This routine adds effects of mixed layer radiation to the layer diffusivities.</span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;</div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> ::         &amp;</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;                         h_ml,        &amp;</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;                         tke_ml_flux, &amp;</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;                         i_decay,     &amp;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;                         kd_mlr_ml</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;  <span class="keywordtype">real</span> :: f_sq, h_ml_sq, ustar_sq, kd_mlr, c1_6</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;  <span class="keywordtype">real</span> :: omega2            <span class="comment">! rotation rate squared (1/s2)</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;  <span class="keywordtype">real</span> :: z1                <span class="comment">! layer thickness times I_decay (nondim)</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  <span class="keywordtype">real</span> :: dzl               <span class="comment">! thickness converted to meter</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;  <span class="keywordtype">real</span> :: i_decay_len2_tke  <span class="comment">! squared inverse decay lengthscale for</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;                            <span class="comment">! TKE, as used in the mixed layer code (1/m2)</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;  <span class="keywordtype">real</span> :: h_neglect         <span class="comment">! negligibly small thickness (meter)</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;  <span class="keywordtype">logical</span> :: do_any, do_i(szi_(g))</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz, kml</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;  omega2    = cs%Omega**2</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;  c1_6      = 1.0 / 6.0</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;  kml       = gv%nkml</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;  h_neglect = gv%H_subroundoff*gv%H_to_m</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;  <span class="keywordflow">if</span> (.not.cs%ML_radiation) <span class="keywordflow">return</span></div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; h_ml(i) = 0.0 ; do_i(i) = (g%mask2dT(i,j) &gt; 0.5) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;  <span class="keywordflow">do</span> k=1,kml ; <span class="keywordflow">do</span> i=is,ie ; h_ml(i) = h_ml(i) + gv%H_to_m*h(i,j,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    <span class="keywordflow">if</span> (cs%ML_omega_frac &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;      f_sq = 4.0*omega2</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;      f_sq = 0.25*((g%CoriolisBu(i,j)**2 + g%CoriolisBu(i-1,j-1)**2) + &amp;</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;                   (g%CoriolisBu(i,j-1)**2 + g%CoriolisBu(i-1,j)**2))</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;      <span class="keywordflow">if</span> (cs%ML_omega_frac &gt; 0.0) &amp;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        f_sq = cs%ML_omega_frac*4.0*omega2 + (1.0-cs%ML_omega_frac)*f_sq</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    ustar_sq = max(fluxes%ustar(i,j), cs%ustar_min)**2</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;    tke_ml_flux(i) = (cs%mstar*cs%ML_rad_coeff)*(ustar_sq*fluxes%ustar(i,j))</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    i_decay_len2_tke = cs%TKE_decay**2 * (f_sq / ustar_sq)</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <span class="keywordflow">if</span> (cs%ML_rad_TKE_decay) &amp;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;      tke_ml_flux(i) = tke_ml_flux(i) * exp(-h_ml(i) * sqrt(i_decay_len2_tke))</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="comment">! Calculate the inverse decay scale</span></div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;    h_ml_sq = (cs%ML_rad_efold_coeff * (h_ml(i)+h_neglect))**2</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;    i_decay(i) = sqrt((i_decay_len2_tke * h_ml_sq + 1.0) / h_ml_sq)</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;    <span class="comment">! Average the dissipation layer kml+1, using</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    <span class="comment">! a more accurate Taylor series approximations for very thin layers.</span></div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    z1 = (gv%H_to_m*h(i,j,kml+1)) * i_decay(i)</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    <span class="keywordflow">if</span> (z1 &gt; 1e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;      kd_mlr = (tke_ml_flux(i) * tke_to_kd(i,kml+1)) * &amp;</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;               (1.0 - exp(-z1))</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;      kd_mlr = (tke_ml_flux(i) * tke_to_kd(i,kml+1)) * &amp;</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;               (z1 * (1.0 - z1 * (0.5 - c1_6*z1)))</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;    kd_mlr_ml(i) = min(kd_mlr,cs%ML_rad_kd_max)</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    tke_ml_flux(i) = tke_ml_flux(i) * exp(-z1)</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;  <span class="keywordflow">do</span> k=1,kml+1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    kd(i,j,k) = kd(i,j,k) + kd_mlr_ml(i)</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">do</span> k=2,kml+1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;      kd_int(i,j,k) = kd_int(i,j,k) + kd_mlr_ml(i)</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    <span class="keywordflow">if</span> (kml&lt;=nz-1) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;      kd_int(i,j,kml+2) = kd_int(i,j,kml+2) + 0.5*kd_mlr_ml(i)</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  <span class="keywordflow">do</span> k=kml+2,nz-1</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;    do_any = .false.</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;      dzl = gv%H_to_m*h(i,j,k) ;  z1 = dzl*i_decay(i)</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;      <span class="keywordflow">if</span> (z1 &gt; 1e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;        kd_mlr = (tke_ml_flux(i) * tke_to_kd(i,k)) * &amp;</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;                 ((1.0 - exp(-z1)) / dzl)</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;        kd_mlr = (tke_ml_flux(i) * tke_to_kd(i,k)) * &amp;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;                 (i_decay(i) * (1.0 - z1 * (0.5 - c1_6*z1)))</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;      kd_mlr = min(kd_mlr,cs%ML_rad_kd_max)</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;      kd(i,j,k) =  kd(i,j,k) + kd_mlr</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;        kd_int(i,j,k) = kd_int(i,j,k) + 0.5*kd_mlr</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;        kd_int(i,j,k+1) = kd_int(i,j,k+1) + 0.5*kd_mlr</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;      tke_ml_flux(i) = tke_ml_flux(i) * exp(-z1)</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;      <span class="keywordflow">if</span> (tke_ml_flux(i) * i_decay(i) &lt; 0.1*cs%Kd_min*omega2) <span class="keywordflow">then</span></div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;        do_i(i) = .false.</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;      <span class="keywordflow">else</span> ; do_any = .true. ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    <span class="keywordflow">if</span> (.not.do_any) <span class="keywordflow">exit</span></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a7ab975ff8ad030b18eb1b294be1947b5_icgraph.svg" width="351" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a79611c5775b154d49d3219efde90055c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79611c5775b154d49d3219efde90055c">&#9670;&nbsp;</a></span>double_diffusion()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::double_diffusion </td>
          <td>(</td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>T_f</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>S_f</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(out)&#160;</td>
          <td class="paramname"><em>Kd_T_dd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(out)&#160;</td>
          <td class="paramname"><em>Kd_S_dd</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine sets the additional diffusivities of temperature and salinity due to double diffusion, using the same functional form as is used in MOM4.1, and taken from an NCAR technical note (REF?) that updates what was in Large et al. (1994). All the coefficients here should probably be made run-time variables rather than hard-coded constants. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Find reference for NCAR tech note above. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields; absent fields have NULL ptrs.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">t_f</td><td>layer temp in C with the values in massless layers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">s_f</td><td>Layer salinities in PPT with values in massless</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>Meridional index upon which to work.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Module control structure.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd_t_dd</td><td>Interface double diffusion diapycnal</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd_s_dd</td><td>Interface double diffusion diapycnal </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01322">1322</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),    <span class="keywordtype">intent(in)</span>  :: g<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">intent(in)</span>  :: gv<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),    <span class="keywordtype">intent(in)</span>  :: tv<span class="comment">  !&lt; Structure containing pointers to any available</span></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;<span class="comment">                                               !! thermodynamic fields; absent fields have NULL</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;<span class="comment">                                               !! ptrs.</span></div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                            <span class="keywordtype">intent(in)</span>  :: h<span class="comment">   !&lt; Layer thicknesses, in H (usually m or kg m-2).</span></div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                            <span class="keywordtype">intent(in)</span>  :: t_f<span class="comment"> !&lt; layer temp in C with the values in massless layers</span></div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="comment">                                               !! filled vertically by diffusion.</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                            <span class="keywordtype">intent(in)</span>  :: s_f<span class="comment"> !&lt; Layer salinities in PPT with values in massless</span></div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="comment">                                               !! layers filled vertically by diffusion.</span></div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordtype">integer</span>,                  <span class="keywordtype">intent(in)</span>  :: j<span class="comment">   !&lt; Meridional index upon which to work.</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs), <span class="keywordtype">pointer</span>     :: cs<span class="comment">  !&lt; Module control structure.</span></div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>,       &amp;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                            <span class="keywordtype">intent(out)</span> :: kd_t_dd<span class="comment"> !&lt; Interface double diffusion diapycnal</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="comment">                                               !! diffusivity for temp (m2/sec).</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>,       &amp;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                            <span class="keywordtype">intent(out)</span> :: kd_s_dd<span class="comment"> !&lt; Interface double diffusion diapycnal</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="comment">                                               !! diffusivity for saln (m2/sec).</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="comment">!  (in)      tv      - structure containing pointers to any available</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="comment">!                      thermodynamic fields; absent fields have NULL ptrs</span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="comment">!  (in)      h       - layer thickness (m or kg m-2)</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="comment">!  (in)      T_f     - layer temp in C with the values in massless layers</span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;<span class="comment">!                      filled vertically by diffusion</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;<span class="comment">!  (in)      S_f     - layer salinities in PPT with values in massless layers</span></div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;<span class="comment">!                      filled vertically by diffusion</span></div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;<span class="comment">!  (in)      G       - ocean grid structure</span></div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;<span class="comment">!  (in)      GV      - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;<span class="comment">!  (in)      CS      - module control structure</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="comment">!  (in)      j       - meridional index upon which to work</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="comment">!  (out)     Kd_T_dd - interface double diffusion diapycnal diffusivity for temp (m2/sec)</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="comment">!  (out)     Kd_S_dd - interface double diffusion diapycnal diffusivity for saln (m2/sec)</span></div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="comment">! This subroutine sets the additional diffusivities of temperature and</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">! salinity due to double diffusion, using the same functional form as is</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="comment">! used in MOM4.1, and taken from an NCAR technical note (###REF?) that updates</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="comment">! what was in Large et al. (1994).  All the coefficients here should probably</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="comment">! be made run-time variables rather than hard-coded constants.</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    drho_dt,  &amp;    <span class="comment">! partial derivatives of density wrt temp (kg m-3 degC-1)</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    drho_ds,  &amp;    <span class="comment">! partial derivatives of density wrt saln (kg m-3 PPT-1)</span></div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;    pres,     &amp;    <span class="comment">! pressure at each interface (Pa)</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    temp_int, &amp;    <span class="comment">! temp and saln at interfaces</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    salin_int</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;  <span class="keywordtype">real</span> ::  alpha_dt <span class="comment">! density difference between layers due to temp diffs (kg/m3)</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  <span class="keywordtype">real</span> ::  beta_ds  <span class="comment">! density difference between layers due to saln diffs (kg/m3)</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <span class="keywordtype">real</span>  :: rrho    <span class="comment">! vertical density ratio</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  <span class="keywordtype">real</span>  :: diff_dd <span class="comment">! factor for double-diffusion</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  <span class="keywordtype">real</span>  :: prandtl <span class="comment">! flux ratio for diffusive convection regime</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: rrho0  = 1.9          <span class="comment">! limit for double-diffusive density ratio</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: dsfmax = 1.e-4        <span class="comment">! max diffusivity in case of salt fingering</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: kv_molecular = 1.5e-6 <span class="comment">! molecular viscosity  (m2/sec)</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keywordflow">then</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;      pres(i) = 0.0 ; kd_t_dd(i,1) = 0.0 ; kd_s_dd(i,1) = 0.0</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;      kd_t_dd(i,nz+1) = 0.0 ; kd_s_dd(i,nz+1) = 0.0</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        pres(i) = pres(i) + gv%H_to_Pa*h(i,j,k-1)</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        temp_int(i) = 0.5 * (t_f(i,j,k-1) + t_f(i,j,k))</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        salin_int(i) = 0.5 * (s_f(i,j,k-1) + s_f(i,j,k))</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;      <span class="keyword">call </span>calculate_density_derivs(temp_int, salin_int, pres, &amp;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;             drho_dt(:), drho_ds(:), is, ie-is+1, tv%eqn_of_state)</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        alpha_dt = -1.0*drho_dt(i) * (t_f(i,j,k-1) - t_f(i,j,k))</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        beta_ds  = drho_ds(i) * (s_f(i,j,k-1) - s_f(i,j,k))</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <span class="keywordflow">if</span> ((alpha_dt &gt; beta_ds) .and. (beta_ds &gt; 0.0)) <span class="keywordflow">then</span>  <span class="comment">! salt finger case</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;          rrho = min(alpha_dt/beta_ds,rrho0)</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;          diff_dd = 1.0 - ((rrho-1.0)/(rrho0-1.0))</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;          diff_dd = dsfmax*diff_dd*diff_dd*diff_dd</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;          kd_t_dd(i,k) = 0.7*diff_dd</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;          kd_s_dd(i,k) = diff_dd</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        <span class="keywordflow">elseif</span> ((alpha_dt &lt; 0.) .and. (beta_ds &lt; 0.) .and. (alpha_dt &gt; beta_ds)) <span class="keywordflow">then</span> <span class="comment">! diffusive convection</span></div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;          rrho = alpha_dt/beta_ds</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;          diff_dd = kv_molecular*0.909*exp(4.6*exp(-0.54*(1/rrho-1)))</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;          prandtl = 0.15*rrho</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;          <span class="keywordflow">if</span> (rrho &gt; 0.5) prandtl = (1.85-0.85/rrho)*rrho</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;          kd_t_dd(i,k) = diff_dd</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;          kd_s_dd(i,k) = prandtl*diff_dd</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;          kd_t_dd(i,k) = 0.0 ; kd_s_dd(i,k) = 0.0</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a79611c5775b154d49d3219efde90055c_icgraph.svg" width="336" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a3280e9e2ed60f24be11cb2308dd5a22d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3280e9e2ed60f24be11cb2308dd5a22d">&#9670;&nbsp;</a></span>find_n2()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::find_n2 </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>T_f</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>S_f</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(out)&#160;</td>
          <td class="paramname"><em>dRho_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>N2_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(out)&#160;</td>
          <td class="paramname"><em>N2_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>N2_bot</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01162">1162</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(in)</span>   :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>   :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>   :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                    <span class="keywordtype">intent(in)</span>   :: tv</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>   :: t_f, s_f</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keywordtype">type</span>(forcing),                            <span class="keywordtype">intent(in)</span>   :: fluxes</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>   :: j</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                 <span class="keywordtype">pointer</span>      :: cs</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>,       <span class="keywordtype">intent(out)</span>  :: drho_int, n2_int</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,         <span class="keywordtype">intent(out)</span>  :: n2_lay</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,                 <span class="keywordtype">intent(out)</span>  :: n2_bot</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    drho_int_unfilt, &amp; <span class="comment">! unfiltered density differences across interfaces</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    drho_dt,         &amp; <span class="comment">! partial derivative of density wrt temp (kg m-3 degC-1)</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    drho_ds            <span class="comment">! partial derivative of density wrt saln (kg m-3 PPT-1)</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    pres,      &amp;  <span class="comment">! pressure at each interface (Pa)</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    temp_int,  &amp;  <span class="comment">! temperature at each interface (degC)</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    salin_int, &amp;  <span class="comment">! salinity at each interface (PPT)</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    drho_bot,  &amp;</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    h_amp,     &amp;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    hb,        &amp;</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    z_from_bot</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <span class="keywordtype">real</span> :: rml_base  <span class="comment">! density of the deepest variable density layer</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  <span class="keywordtype">real</span> :: dz_int    <span class="comment">! thickness associated with an interface (meter)</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordtype">real</span> :: g_rho0    <span class="comment">! gravitation acceleration divided by Bouss reference density (m4 s-2 kg-1)</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  <span class="keywordtype">real</span> :: h_neglect <span class="comment">! negligibly small thickness, in the same units as h.</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szi_(g)), do_any</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  g_rho0    = gv%g_Earth / gv%Rho0</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  <span class="comment">! Find the (limited) density jump across each interface.</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    drho_int(i,1) = 0.0 ; drho_int(i,nz+1) = 0.0</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    drho_int_unfilt(i,1) = 0.0 ; drho_int_unfilt(i,nz+1) = 0.0</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keywordflow">then</span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%p_surf)) <span class="keywordflow">then</span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; pres(i) = fluxes%p_surf(i,j) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; pres(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        pres(i) = pres(i) + gv%H_to_Pa*h(i,j,k-1)</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        temp_int(i) = 0.5 * (t_f(i,j,k) + t_f(i,j,k-1))</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        salin_int(i) = 0.5 * (s_f(i,j,k) + s_f(i,j,k-1))</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;      <span class="keyword">call </span>calculate_density_derivs(temp_int, salin_int, pres, &amp;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;               drho_dt(:,k), drho_ds(:,k), is, ie-is+1, tv%eqn_of_state)</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        drho_int(i,k) = max(drho_dt(i,k)*(t_f(i,j,k) - t_f(i,j,k-1)) + &amp;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;                            drho_ds(i,k)*(s_f(i,j,k) - s_f(i,j,k-1)), 0.0)</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        drho_int_unfilt(i,k) = max(drho_dt(i,k)*(tv%T(i,j,k) - tv%T(i,j,k-1)) + &amp;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                            drho_ds(i,k)*(tv%S(i,j,k) - tv%S(i,j,k-1)), 0.0)</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;      drho_int(i,k) = gv%Rlay(k) - gv%Rlay(k-1)</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <span class="comment">! Set the buoyancy frequencies.</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    n2_lay(i,k) = g_rho0 * 0.5*(drho_int(i,k) + drho_int(i,k+1)) / &amp;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                  (gv%H_to_m*(h(i,j,k) + h_neglect))</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; n2_int(i,1) = 0.0 ; n2_int(i,nz+1) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;  <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    n2_int(i,k) = g_rho0 * drho_int(i,k) / &amp;</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                  (0.5*gv%H_to_m*(h(i,j,k-1) + h(i,j,k) + h_neglect))</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="comment">! Find the bottom boundary layer stratification, and use this in the deepest layers.</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    hb(i) = 0.0 ; drho_bot(i) = 0.0</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    z_from_bot(i) = 0.5*gv%H_to_m*h(i,j,nz)</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    do_i(i) = (g%mask2dT(i,j) &gt; 0.5)</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;      h_amp(i) = sqrt(cs%h2(i,j)) <span class="comment">! for computing Nb</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      h_amp(i) = 0.0</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  <span class="keywordflow">do</span> k=nz,2,-1</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    do_any = .false.</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      dz_int = 0.5*gv%H_to_m*(h(i,j,k) + h(i,j,k-1))</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;      z_from_bot(i) = z_from_bot(i) + dz_int <span class="comment">! middle of the layer above</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      hb(i) = hb(i) + dz_int</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;      drho_bot(i) = drho_bot(i) + drho_int(i,k)</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      <span class="keywordflow">if</span> (z_from_bot(i) &gt; h_amp(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;        <span class="keywordflow">if</span> (k&gt;2) <span class="keywordflow">then</span></div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;          <span class="comment">! Always include at least one full layer.</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;          hb(i) = hb(i) + 0.5*gv%H_to_m*(h(i,j,k-1) + h(i,j,k-2))</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;          drho_bot(i) = drho_bot(i) + drho_int(i,k-1)</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        do_i(i) = .false.</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        do_any = .true.</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    <span class="keywordflow">if</span> (.not.do_any) <span class="keywordflow">exit</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="keywordflow">if</span> (hb(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;      n2_bot(i) = (g_rho0 * drho_bot(i)) / hb(i)</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    <span class="keywordflow">else</span> ;  n2_bot(i) = 0.0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    z_from_bot(i) = 0.5*gv%H_to_m*h(i,j,nz)</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    do_i(i) = (g%mask2dT(i,j) &gt; 0.5)</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  <span class="keywordflow">do</span> k=nz,2,-1</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    do_any = .false.</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      dz_int = 0.5*gv%H_to_m*(h(i,j,k) + h(i,j,k-1))</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;      z_from_bot(i) = z_from_bot(i) + dz_int <span class="comment">! middle of the layer above</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;      n2_int(i,k) = n2_bot(i)</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;      <span class="keywordflow">if</span> (k&gt;2) n2_lay(i,k-1) = n2_bot(i)</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;      <span class="keywordflow">if</span> (z_from_bot(i) &gt; h_amp(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordflow">if</span> (k&gt;2) n2_int(i,k-1) = n2_bot(i)</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        do_i(i) = .false.</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        do_any = .true.</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;    <span class="keywordflow">if</span> (.not.do_any) <span class="keywordflow">exit</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keywordflow">then</span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;      drho_int(i,k) = drho_int_unfilt(i,k)</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a3280e9e2ed60f24be11cb2308dd5a22d_icgraph.svg" width="336" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a17d34181e20efe93c91a24baba5f1359"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a17d34181e20efe93c91a24baba5f1359">&#9670;&nbsp;</a></span>find_tke_to_kd()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::find_tke_to_kd </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(in)&#160;</td>
          <td class="paramname"><em>dRho_int</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>N2_lay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>TKE_to_Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>maxTKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>kb</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00971">971</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02437">set_density_ratios()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>.</p>
<div class="fragment"><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                 <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>   :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                   <span class="keywordtype">intent(in)</span>    :: tv</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>,      <span class="keywordtype">intent(in)</span>    :: drho_int</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,        <span class="keywordtype">intent(in)</span>    :: n2_lay</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="keywordtype">integer</span>,                                 <span class="keywordtype">intent(in)</span>    :: j</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <span class="keywordtype">real</span>,                                    <span class="keywordtype">intent(in)</span>    :: dt</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,        <span class="keywordtype">intent(out)</span>   :: tke_to_kd, maxtke</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G))</span>,             <span class="keywordtype">intent(out)</span>   :: kb</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    ds_dsp1, &amp;    <span class="comment">! coordinate variable (sigma-2) difference across an</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                  <span class="comment">! interface divided by the difference across the interface</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                  <span class="comment">! below it (nondimensional)</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    dsp1_ds, &amp;    <span class="comment">! inverse coordinate variable (sigma-2) difference</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                  <span class="comment">! across an interface times the difference across the</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                  <span class="comment">! interface above it (nondimensional)</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    rho_0,   &amp;    <span class="comment">! Layer potential densities relative to surface pressure (kg/m3)</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    maxent        <span class="comment">! maxEnt is the maximum value of entrainment from below (with</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                  <span class="comment">! compensating entrainment from above to keep the layer</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                  <span class="comment">! density from changing) that will not deplete all of the</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                  <span class="comment">! layers above or below a layer within a timestep (meter)</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    htot,    &amp;    <span class="comment">! total thickness above or below a layer, or the</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                  <span class="comment">! integrated thickness in the BBL (meter)</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    mfkb,    &amp;    <span class="comment">! total thickness in the mixed and buffer layers</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                  <span class="comment">! times ds_dsp1 (meter)</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    p_ref,   &amp;    <span class="comment">! array of tv%P_Ref pressures</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    rcv_kmb, &amp;    <span class="comment">! coordinate density in the lowest buffer layer</span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    p_0           <span class="comment">! An array of 0 pressures</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  <span class="keywordtype">real</span> :: dh_max      <span class="comment">! maximum amount of entrainment a layer could</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                      <span class="comment">! undergo before entraining all fluid in the layers</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                      <span class="comment">! above or below (meter)</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;  <span class="keywordtype">real</span> :: drho_lay    <span class="comment">! density change across a layer (kg/m3)</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;  <span class="keywordtype">real</span> :: omega2      <span class="comment">! rotation rate squared (1/s2)</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="keywordtype">real</span> :: g_rho0      <span class="comment">! gravitation accel divided by Bouss ref density (m4 s-2 kg-1)</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="keywordtype">real</span> :: i_rho0      <span class="comment">! inverse of Boussinesq reference density (m3/kg)</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  <span class="keywordtype">real</span> :: i_dt        <span class="comment">! 1/dt (1/sec)</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  <span class="keywordtype">real</span> :: h_neglect   <span class="comment">! negligibly small thickness (units as h)</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;  <span class="keywordtype">real</span> :: hn2po2      <span class="comment">! h * (N^2 + Omega^2), in m s-2.</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szi_(g))</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, nz, i_rem, kmb, kb_min</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  i_dt      = 1.0/dt</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  omega2    = cs%Omega**2</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;  g_rho0    = gv%g_Earth / gv%Rho0</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;  i_rho0    = 1.0/gv%Rho0</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;  <span class="comment">! Simple but coordinate-independent estimate of Kd/TKE</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  <span class="keywordflow">if</span> (cs%simple_TKE_to_Kd) <span class="keywordflow">then</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;      hn2po2 = ( gv%H_to_m * h(i,j,k) ) * ( n2_lay(i,k) + omega2 ) <span class="comment">! Units of m s-2.</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;      <span class="keywordflow">if</span> (hn2po2&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        tke_to_kd(i,k) = 1./ hn2po2 <span class="comment">! Units of s2 m-1.</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      else; tke_to_kd(i,k) = 0.;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      <span class="comment">! The maximum TKE conversion we allow is really a statement</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      <span class="comment">! about the upper diffusivity we allow. Kd_max must be set.</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      maxtke(i,k) = hn2po2 * cs%Kd_max <span class="comment">! Units of m3 s-3.</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    kb(is:ie) = -1 <span class="comment">! kb should not be used by any code in non-layered mode -AJA</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="comment">! Determine kb - the index of the shallowest active interior layer.</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordflow">if</span> (cs%bulkmixedlayer) <span class="keywordflow">then</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    kmb = gv%nk_rho_varies</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; p_0(i) = 0.0 ; p_ref(i) = tv%P_Ref ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,k),tv%S(:,j,k),p_0,rho_0(:,k),&amp;</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                             is,ie-is+1,tv%eqn_of_state)</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keyword">call </span>calculate_density(tv%T(:,j,kmb),tv%S(:,j,kmb),p_ref,rcv_kmb,&amp;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                           is,ie-is+1,tv%eqn_of_state)</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    kb_min = kmb+1</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;      <span class="comment">!   Determine the next denser layer than the buffer layer in the</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;      <span class="comment">! coordinate density (sigma-2).</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;      <span class="keywordflow">do</span> k=kmb+1,nz-1 ; <span class="keywordflow">if</span> (rcv_kmb(i) &lt;= gv%Rlay(k)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;      kb(i) = k</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="comment">!   Backtrack, in case there are massive layers above that are stable</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    <span class="comment">! in sigma-0.</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;      <span class="keywordflow">do</span> k=kb(i)-1,kmb+1,-1</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        <span class="keywordflow">if</span> (rho_0(i,kmb) &gt; rho_0(i,k)) <span class="keywordflow">exit</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        <span class="keywordflow">if</span> (h(i,j,k)&gt;2.0*gv%Angstrom) kb(i) = k</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <span class="keyword">call </span>set_density_ratios(h, tv, kb, g, gv, cs, j, ds_dsp1, rho_0)</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  <span class="keywordflow">else</span> <span class="comment">! not bulkmixedlayer</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    kb_min = 2 ; kmb = 0</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; kb(i) = 1 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="keyword">call </span>set_density_ratios(h, tv, kb, g, gv, cs, j, ds_dsp1)</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="comment">! Determine maxEnt - the maximum permitted entrainment from below by each</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="comment">! interior layer.</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    dsp1_ds(i,k) = 1.0 / ds_dsp1(i,k)</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; dsp1_ds(i,nz) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <span class="keywordflow">if</span> (cs%bulkmixedlayer) <span class="keywordflow">then</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    kmb = gv%nk_rho_varies</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      htot(i) = gv%H_to_m*h(i,j,kmb)</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      mfkb(i) = 0.0</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      <span class="keywordflow">if</span> (kb(i) &lt; nz) &amp;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        mfkb(i) = ds_dsp1(i,kb(i)) * (gv%H_to_m*(h(i,j,kmb) - gv%Angstrom))</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="keywordflow">do</span> k=1,kmb-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;      htot(i) = htot(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;      mfkb(i) = mfkb(i) + ds_dsp1(i,k+1)*(gv%H_to_m*(h(i,j,k) - gv%Angstrom))</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="keywordflow">do</span> i=is,i</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;      maxent(i,1) = 0.0 ; htot(i) = gv%H_to_m*(h(i,j,1) - gv%Angstrom)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;  <span class="keywordflow">do</span> k=kb_min,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keywordflow">if</span> (k == kb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      maxent(i,kb(i))= mfkb(i)</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <span class="keywordflow">elseif</span> (k &gt; kb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;      maxent(i,k) = (1.0/dsp1_ds(i,k))*(maxent(i,k-1) + htot(i))</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;<span class="comment">!        maxEnt(i,k) = ds_dsp1(i,k)*(maxEnt(i,k-1) + htot(i)) ! BITWISE CHG</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      htot(i) = htot(i) + gv%H_to_m*(h(i,j,k) - gv%Angstrom)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    htot(i) = gv%H_to_m*(h(i,j,nz) - gv%Angstrom) ; maxent(i,nz) = 0.0</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    do_i(i) = (g%mask2dT(i,j) &gt; 0.5)</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;  <span class="keywordflow">do</span> k=nz-1,kb_min,-1</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    i_rem = 0</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      <span class="keywordflow">if</span> (k&lt;kb(i)) <span class="keywordflow">then</span> ; do_i(i) = .false. ; cycle ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      i_rem = i_rem + 1  <span class="comment">! Count the i-rows that are still being worked on.</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;      maxent(i,k) = min(maxent(i,k),dsp1_ds(i,k+1)*maxent(i,k+1) + htot(i))</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;      htot(i) = htot(i) + gv%H_to_m*(h(i,j,k) - gv%Angstrom)</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="keywordflow">if</span> (i_rem == 0) <span class="keywordflow">exit</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k-loop</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="comment">! Now set maxTKE and TKE_to_Kd.</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    maxtke(i,1) = 0.0 ; tke_to_kd(i,1) = 0.0</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    maxtke(i,nz) = 0.0 ; tke_to_kd(i,nz) = 0.0</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keywordflow">do</span> k=2,kmb ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    maxtke(i,k) = 0.0</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    tke_to_kd(i,k) = 1.0 / ((n2_lay(i,k) + omega2) * &amp;</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                            (gv%H_to_m*(h(i,j,k) + h_neglect)))</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;  <span class="keywordflow">do</span> k=kmb+1,kb_min-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <span class="comment">!   These are the properties in the deeper mixed and buffer layers, and</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <span class="comment">! should perhaps be revisited.</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    maxtke(i,k) = 0.0 ; tke_to_kd(i,k) = 0.0</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordflow">do</span> k=kb_min,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="keywordflow">if</span> (k&lt;kb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;      maxtke(i,k) = 0.0</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;      tke_to_kd(i,k) = 0.0</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      <span class="comment">! maxTKE is found by determining the kappa that gives maxEnt.</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      <span class="comment">! ### This should be 1 / G_Earth * (delta rho_InSitu)</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <span class="comment">!  kappa_max = I_dt * dRho_int(i,K+1) * maxEnt(i,k) * &amp;</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      <span class="comment">!             (GV%H_to_m*h(i,j,k) + dh_max) / dRho_lay</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      <span class="comment">!  maxTKE(i,k) = GV%g_Earth * dRho_lay * kappa_max</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      <span class="comment">! dRho_int should already be non-negative, so the max is redundant?</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;      dh_max = maxent(i,k) * (1.0 + dsp1_ds(i,k))</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      drho_lay = 0.5 * max(drho_int(i,k) + drho_int(i,k+1), 0.0)</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      maxtke(i,k) = i_dt * ((gv%g_Earth * i_rho0) * &amp;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;          (0.5*max(drho_int(i,k+1) + dsp1_ds(i,k)*drho_int(i,k),0.0))) * &amp;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                   ((gv%H_to_m*h(i,j,k) + dh_max) * maxent(i,k))</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;      tke_to_kd(i,k) = 1.0 / (g_rho0 * drho_lay + &amp;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                              cs%Omega**2 * gv%H_to_m*(h(i,j,k) + h_neglect))</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a17d34181e20efe93c91a24baba5f1359_cgraph.svg" width="336" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a17d34181e20efe93c91a24baba5f1359_icgraph.svg" width="336" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="acc501881a7f9adb5f38c533685857d08"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc501881a7f9adb5f38c533685857d08">&#9670;&nbsp;</a></span>set_bbl_tke()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_set_diffusivity::set_bbl_tke </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(inout)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine calculates several properties related to bottom boundary layer turbulence. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity, in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity, in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02306">2306</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: u<span class="comment">    !&lt; The zonal velocity, in m s-1</span></div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: v<span class="comment">    !&lt; The meridional velocity, in m s-1</span></div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2)</span></div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;  <span class="keywordtype">type</span>(forcing),                             <span class="keywordtype">intent(in)</span>    :: fluxes</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),                       <span class="keywordtype">intent(inout)</span> :: visc</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),                  <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;  <span class="comment">! This subroutine calculates several properties related to bottom</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;  <span class="comment">! boundary layer turbulence.</span></div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;    htot          <span class="comment">! total thickness above or below a layer, or the</span></div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;                  <span class="comment">! integrated thickness in the BBL (meter)</span></div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    uhtot, &amp;      <span class="comment">! running integral of u in the BBL (m2/s)</span></div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;    ustar, &amp;      <span class="comment">! bottom boundary layer turbulence speed (m/s)</span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    u2_bbl        <span class="comment">! square of the mean zonal velocity in the BBL (m2/s2)</span></div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;  <span class="keywordtype">real</span> :: vhtot(szi_(g)) <span class="comment">! running integral of v in the BBL (m2/sec)</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;    vstar, &amp; <span class="comment">! ustar at at v-points in 2 j-rows (m/s)</span></div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;    v2_bbl   <span class="comment">! square of average meridional velocity in BBL (m2/s2)</span></div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;  <span class="keywordtype">real</span> :: cdrag_sqrt  <span class="comment">! square root of the drag coefficient (nondim)</span></div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;  <span class="keywordtype">real</span> :: hvel        <span class="comment">! thickness at velocity points (meter)</span></div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;  <span class="keywordtype">logical</span> :: domore, do_i(szi_(g))</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;set_BBL_TKE: &quot;</span>//&amp;</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;  <span class="keywordflow">if</span> (.not.cs%bottomdraglaw .or. (cs%BBL_effic&lt;=0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%ustar_BBL)) <span class="keywordflow">then</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; visc%ustar_BBL(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%TKE_BBL)) <span class="keywordflow">then</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie ; visc%TKE_BBL(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;  cdrag_sqrt = sqrt(cs%cdrag)</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;<span class="comment">!$OMP parallel default(none) shared(cdrag_sqrt,is,ie,js,je,nz,visc,CS,G,GV,vstar,h,v, &amp;</span></div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;<span class="comment">!$OMP                               v2_bbl,u) &amp;</span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="comment">!$OMP                       private(do_i,vhtot,htot,domore,hvel,uhtot,ustar,u2_bbl)</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;  <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    <span class="comment">! Determine ustar and the square magnitude of the velocity in the</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="comment">! bottom boundary layer. Together these give the TKE source and</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    <span class="comment">! vertical decay scale.</span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((g%mask2dCv(i,j) &gt; 0.5) .and. (cdrag_sqrt*visc%bbl_thick_v(i,j) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;      do_i(i) = .true. ; vhtot(i) = 0.0 ; htot(i) = 0.0</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;      vstar(i,j) = visc%kv_bbl_v(i,j)/(cdrag_sqrt*visc%bbl_thick_v(i,j))</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;      do_i(i) = .false. ; vstar(i,j) = 0.0 ; htot(i) = 0.0</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;      domore = .false.</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;        hvel = 0.5*gv%H_to_m*(h(i,j,k) + h(i,j+1,k))</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;        <span class="keywordflow">if</span> ((htot(i) + hvel) &gt;= visc%bbl_thick_v(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;          vhtot(i) = vhtot(i) + (visc%bbl_thick_v(i,j) - htot(i))*v(i,j,k)</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;          htot(i) = visc%bbl_thick_v(i,j)</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;          do_i(i) = .false.</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;          vhtot(i) = vhtot(i) + hvel*v(i,j,k)</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;          htot(i) = htot(i) + hvel</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;          domore = .true.</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;      <span class="keywordflow">if</span> (.not.domore) <span class="keywordflow">exit</span></div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((g%mask2dCv(i,j) &gt; 0.5) .and. (htot(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;      v2_bbl(i,j) = (vhtot(i)*vhtot(i))/(htot(i)*htot(i))</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;      v2_bbl(i,j) = 0.0</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie ; <span class="keywordflow">if</span> ((g%mask2dCu(i,j) &gt; 0.5) .and. (cdrag_sqrt*visc%bbl_thick_u(i,j) &gt; 0.0))  <span class="keywordflow">then</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;      do_i(i) = .true. ; uhtot(i) = 0.0 ; htot(i) = 0.0</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;      ustar(i) = visc%kv_bbl_u(i,j)/(cdrag_sqrt*visc%bbl_thick_u(i,j))</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;      do_i(i) = .false. ; ustar(i) = 0.0 ; htot(i) = 0.0</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1 ; domore = .false.</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        hvel = 0.5*gv%H_to_m*(h(i,j,k) + h(i+1,j,k))</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;        <span class="keywordflow">if</span> ((htot(i) + hvel) &gt;= visc%bbl_thick_u(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;          uhtot(i) = uhtot(i) + (visc%bbl_thick_u(i,j) - htot(i))*u(i,j,k)</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;          htot(i) = visc%bbl_thick_u(i,j)</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;          do_i(i) = .false.</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;          uhtot(i) = uhtot(i) + hvel*u(i,j,k)</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;          htot(i) = htot(i) + hvel</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;          domore = .true.</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;      <span class="keywordflow">if</span> (.not.domore) <span class="keywordflow">exit</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie ; <span class="keywordflow">if</span> ((g%mask2dCu(i,j) &gt; 0.5) .and. (htot(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;      u2_bbl(i) = (uhtot(i)*uhtot(i))/(htot(i)*htot(i))</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;      u2_bbl(i) = 0.0</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;      visc%ustar_BBL(i,j) = sqrt(0.5*g%IareaT(i,j) * &amp;</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;                ((g%areaCu(i-1,j)*(ustar(i-1)*ustar(i-1)) + &amp;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;                  g%areaCu(i,j)*(ustar(i)*ustar(i))) + &amp;</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;                 (g%areaCv(i,j-1)*(vstar(i,j-1)*vstar(i,j-1)) + &amp;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;                  g%areaCv(i,j)*(vstar(i,j)*vstar(i,j))) ) )</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;      visc%TKE_BBL(i,j) = (((g%areaCu(i-1,j)*(ustar(i-1)*u2_bbl(i-1)) + &amp;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;                    g%areaCu(i,j) * (ustar(i)*u2_bbl(i))) + &amp;</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;                   (g%areaCv(i,j-1)*(vstar(i,j-1)*v2_bbl(i,j-1)) + &amp;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;                    g%areaCv(i,j) * (vstar(i,j)*v2_bbl(i,j))))*g%IareaT(i,j))</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae1b3a63b8470de5a3d9ba9706376281b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1b3a63b8470de5a3d9ba9706376281b">&#9670;&nbsp;</a></span>set_density_ratios()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_set_diffusivity::set_density_ratios </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( g %isd: g %ied), intent(in)&#160;</td>
          <td class="paramname"><em>kb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(out)&#160;</td>
          <td class="paramname"><em>ds_dsp1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>rho_0</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Structure containing pointers to any available thermodynamic fields; absent fields have NULL ptrs.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kb</td><td>Index of lightest layer denser than the buffer layer.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure returned by previous call to diabatic_entrain_init.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>Meridional index upon which to work.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ds_dsp1</td><td>Coordinate variable (sigma-2) difference across an interface divided by the difference across the interface below it (nondimensional)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_0</td><td>Layer potential densities relative to </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02437">2437</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00971">find_tke_to_kd()</a>.</p>
<div class="fragment"><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),            <span class="keywordtype">intent(in)</span>   :: g<span class="comment">  !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),          <span class="keywordtype">intent(in)</span>   :: gv<span class="comment"> !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;                                    <span class="keywordtype">intent(in)</span>   :: h<span class="comment">  !&lt; Layer thicknesses, in H (usually m</span></div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="comment">                                                       !! or kg m-2).</span></div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),            <span class="keywordtype">intent(in)</span>   :: tv<span class="comment"> !&lt; Structure containing pointers to any</span></div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;<span class="comment">                                                       !! available thermodynamic fields; absent</span></div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;<span class="comment">                                                       !! fields have NULL ptrs.</span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G))</span>,      <span class="keywordtype">intent(in)</span>   :: kb<span class="comment"> !&lt; Index of lightest layer denser than the</span></div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;<span class="comment">                                                       !! buffer layer.</span></div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),         <span class="keywordtype">pointer</span>      :: cs<span class="comment"> !&lt; Control structure returned by previous</span></div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="comment">                                                       !! call to diabatic_entrain_init.</span></div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;  <span class="keywordtype">integer</span>,                          <span class="keywordtype">intent(in)</span>   :: j<span class="comment">  !&lt; Meridional index upon which to work.</span></div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(out)</span>  :: ds_dsp1<span class="comment"> !&lt; Coordinate variable (sigma-2)</span></div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="comment">                                                       !! difference across an interface divided by</span></div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="comment">                                                       !! the difference across the interface below</span></div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;<span class="comment">                                                       !! it (nondimensional)</span></div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>   :: rho_0<span class="comment"> !&lt; Layer potential densities relative to</span></div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment">                                                       !! surface press (kg/m3).</span></div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="comment">!  (in)      h       - layer thickness (meter)</span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;<span class="comment">!  (in)      tv      - structure containing pointers to any available</span></div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="comment">!                      thermodynamic fields; absent fields have NULL ptrs</span></div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;<span class="comment">!  (in)      kb      - index of lightest layer denser than the buffer layer</span></div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;<span class="comment">!  (in)      G       - ocean grid structure</span></div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;<span class="comment">!  (in)      CS      - control structure returned by previous call to diabatic_entrain_init</span></div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;<span class="comment">!  (in)      j       - meridional index upon which to work</span></div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;<span class="comment">!  (in)      ds_dsp1 - coordinate variable (sigma-2) difference across an</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="comment">!                      interface divided by the difference across the interface</span></div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="comment">!                      below it (nondimensional)</span></div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="comment">!  (in)      rho_0   - layer potential densities relative to surface press (kg/m3)</span></div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;  <span class="keywordtype">real</span> :: g_r0                     <span class="comment">! g_R0 is g/Rho (m4 kg-1 s-2)</span></div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;  <span class="keywordtype">real</span> :: eps, tmp                 <span class="comment">! nondimensional temproray variables</span></div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;  <span class="keywordtype">real</span> :: a(szk_(g)), a_0(szk_(g)) <span class="comment">! nondimensional temporary variables</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;  <span class="keywordtype">real</span> :: p_ref(szi_(g))           <span class="comment">! an array of tv%P_Ref pressures</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;  <span class="keywordtype">real</span> :: rcv(szi_(g),szk_(g))     <span class="comment">! coordinate density in the mixed and buffer layers (kg/m3)</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;  <span class="keywordtype">real</span> :: i_drho                   <span class="comment">! temporary variable (m3/kg)</span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;  <span class="keywordtype">integer</span> :: i, k, k3, is, ie, nz, kmb</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  <span class="keywordflow">do</span> k=2,nz-1</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;    <span class="keywordflow">if</span> (gv%g_prime(k+1)/=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;        ds_dsp1(i,k) = gv%g_prime(k) / gv%g_prime(k+1)</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        ds_dsp1(i,k) = 1.</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;  <span class="keywordflow">if</span> (cs%bulkmixedlayer) <span class="keywordflow">then</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;    g_r0 = gv%g_Earth/gv%Rho0</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;    kmb = gv%nk_rho_varies</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;    eps = 0.1</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; p_ref(i) = tv%P_Ref ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;    <span class="keywordflow">do</span> k=1,kmb</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,k),tv%S(:,j,k),p_ref,rcv(:,k),&amp;</div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;                             is,ie-is+1,tv%eqn_of_state)</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;      <span class="keywordflow">if</span> (kb(i) &lt;= nz-1) <span class="keywordflow">then</span></div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;<span class="comment">!   Set up appropriately limited ratios of the reduced gravities of the</span></div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;<span class="comment">! interfaces above and below the buffer layer and the next denser layer.</span></div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;        k = kb(i)</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;        i_drho = g_r0 / gv%g_prime(k+1)</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;        <span class="comment">! The indexing convention for a is appropriate for the interfaces.</span></div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;        <span class="keywordflow">do</span> k3=1,kmb</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;          a(k3+1) = (gv%Rlay(k) - rcv(i,k3)) * i_drho</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;        <span class="keywordflow">if</span> ((<span class="keyword">present</span>(rho_0)) .and. (a(kmb+1) &lt; 2.0*eps*ds_dsp1(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;<span class="comment">!   If the buffer layer nearly matches the density of the layer below in the</span></div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;<span class="comment">! coordinate variable (sigma-2), use the sigma-0-based density ratio if it is</span></div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;<span class="comment">! greater (and stable).</span></div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;          <span class="keywordflow">if</span> ((rho_0(i,k) &gt; rho_0(i,kmb)) .and. &amp;</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;              (rho_0(i,k+1) &gt; rho_0(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;            i_drho = 1.0 / (rho_0(i,k+1)-rho_0(i,k))</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;            a_0(kmb+1) = min((rho_0(i,k)-rho_0(i,kmb)) * i_drho, ds_dsp1(i,k))</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;            <span class="keywordflow">if</span> (a_0(kmb+1) &gt; a(kmb+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;              <span class="keywordflow">do</span> k3=2,kmb</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;                a_0(k3) = a_0(kmb+1) + (rho_0(i,kmb)-rho_0(i,k3-1)) * i_drho</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;              <span class="keywordflow">if</span> (a(kmb+1) &lt;= eps*ds_dsp1(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;                <span class="keywordflow">do</span> k3=2,kmb+1 ; a(k3) = a_0(k3) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;<span class="comment">! Alternative...  tmp = 0.5*(1.0 - cos(PI*(a(K2+1)/(eps*ds_dsp1(i,k)) - 1.0)) )</span></div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;                tmp = a(kmb+1)/(eps*ds_dsp1(i,k)) - 1.0</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;                <span class="keywordflow">do</span> k3=2,kmb+1 ; a(k3) = tmp*a(k3) + (1.0-tmp)*a_0(k3) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;        ds_dsp1(i,k) = max(a(kmb+1),1e-5)</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;        <span class="keywordflow">do</span> k3=2,kmb</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;<span class="comment">!           ds_dsp1(i,k3) = MAX(a(k3),1e-5)</span></div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;          <span class="comment">! Deliberately treat convective instabilies of the upper mixed</span></div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;          <span class="comment">! and buffer layers with respect to the deepest buffer layer as</span></div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;          <span class="comment">! though they don&#39;t exist.  They will be eliminated by the upcoming</span></div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;          <span class="comment">! call to the mixedlayer code anyway.</span></div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;          <span class="comment">! The indexing convention is appropriate for the interfaces.</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;          ds_dsp1(i,k3) = max(a(k3),ds_dsp1(i,k))</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! (kb(i) &lt;= nz-1)</span></div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! I-loop.</span></div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! bulkmixedlayer</span></div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_ae1b3a63b8470de5a3d9ba9706376281b_icgraph.svg" width="523" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a8b1f646393f0ec717ca690e4f04d96e8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8b1f646393f0ec717ca690e4f04d96e8">&#9670;&nbsp;</a></span>set_diffusivity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_set_diffusivity::set_diffusivity </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>u_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>v_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(optics_type), pointer&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(inout)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Kd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)+1), intent(out), optional&#160;</td>
          <td class="paramname"><em>Kd_int</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Structure with pointers to thermodynamic fields. Out is for tvTempxPmE.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Structure of surface fluxes that may be used.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">visc</td><td>Structure containing vertical viscosities, bottom boundary layer properies, and related fields.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment (sec).</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Module control structure.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd</td><td>Diapycnal diffusivity of each layer (m2/sec).</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">kd_int</td><td>Diapycnal diffusivity at each interface </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">373</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01428">add_drag_diffusivity()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01921">add_int_tide_diffusivity()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01648">add_lotw_bbl_diffusivity()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01797">add_mlrad_diffusivity()</a>, <a class="el" href="MOM__diag__to__Z_8F90_source.html#l00811">mom_diag_to_z::calc_zint_diags()</a>, <a class="el" href="MOM__cvmix__shear_8F90_source.html#l00048">mom_cvmix_shear::calculate_cvmix_shear()</a>, <a class="el" href="MOM__kappa__shear_8F90_source.html#l00122">mom_kappa_shear::calculate_kappa_shear()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00126">mom_error_handler::calltree_enter()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00147">mom_error_handler::calltree_leave()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00157">mom_error_handler::calltree_waypoint()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01322">double_diffusion()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01162">find_n2()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00971">find_tke_to_kd()</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00367">id_clock_kappashear</a>, <a class="el" href="MOM__intrinsic__functions_8F90_source.html#l00020">mom_intrinsic_functions::invcosh()</a>, and <a class="el" href="MOM__thickness__diffuse_8F90_source.html#l01585">mom_thickness_diffuse::vert_fill_ts()</a>.</p>
<div class="fragment"><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),     <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                             <span class="keywordtype">intent(in)</span>    :: u<span class="comment">    !&lt; The zonal velocity, in m s-1.</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                             <span class="keywordtype">intent(in)</span>    :: v<span class="comment">    !&lt; The meridional velocity, in m s-1.</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                             <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thicknesses, in H (usually m or kg m-2).</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                             <span class="keywordtype">intent(in)</span>    :: u_h</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                             <span class="keywordtype">intent(in)</span>    :: v_h</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),     <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">   !&lt; Structure with pointers to thermodynamic</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">                                                   !! fields. Out is for tv%TempxPmE.</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordtype">type</span>(forcing),             <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment"> !&lt; Structure of surface fluxes that may be</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">                                                   !! used.</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordtype">type</span>(optics_type),         <span class="keywordtype">pointer</span>       :: optics</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),       <span class="keywordtype">intent(inout)</span> :: visc<span class="comment"> !&lt; Structure containing vertical viscosities,</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">                                                   !! bottom boundary layer properies, and related</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">                                                   !! fields.</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="keywordtype">real</span>,                      <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; Time increment (sec).</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs),  <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; Module control structure.</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                             <span class="keywordtype">intent(out)</span>   :: kd<span class="comment">   !&lt; Diapycnal diffusivity of each layer (m2/sec).</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, &amp;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                   <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>   :: kd_int<span class="comment"> !&lt; Diapycnal diffusivity at each interface</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">                                                   !! (m2/sec).</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">!  (in)      u      - zonal velocity (m/s)</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">!  (in)      v      - meridional velocity (m/s)</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">!  (in)      h      - Layer thickness (m or kg/m2)</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">!  (in)      tv     - structure with pointers to thermodynamic fields</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!  (in)      fluxes - structure of surface fluxes that may be used</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">!  (in)      visc   - structure containing vertical viscosities, bottom boundary</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">!                     layer properies, and related fields</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">!  (in)      dt     - time increment (sec)</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">!  (in)      G      - ocean grid structure</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">!  (in)      GV     - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">!  (in)      CS     - module control structure</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">!  (in)      j      - meridional index upon which to work</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">!  (out)     Kd     - diapycnal diffusivity of each layer (m2/sec)</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">!  (out,opt) Kd_int - diapycnal diffusivity at each interface (m2/sec)</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    depth, &amp;      <span class="comment">! distance from surface of an interface (meter)</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    n2_bot        <span class="comment">! bottom squared buoyancy frequency (1/s2)</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    kd_sfc        <span class="comment">! surface value of the diffusivity (m2/s)</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordtype">type</span>(diffusivity_diags) :: dd <span class="comment">! structure w/ arrays of pointers to avail diags</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    t_f, s_f      <span class="comment">! temperature and salinity (deg C and ppt);</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                  <span class="comment">! massless layers filled vertically by diffusion.</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    n2_lay, &amp;     <span class="comment">! squared buoyancy frequency associated with layers (1/s2)</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    maxtke, &amp;     <span class="comment">! energy required to entrain to h_max (m3/s3)</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    tke_to_kd     <span class="comment">! conversion rate (~1.0 / (G_Earth + dRho_lay)) between</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                  <span class="comment">! TKE dissipated within a layer and Kd in that layer, in</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                  <span class="comment">! m2 s-1 / m3 s-3 = s2 m-1.</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    n2_int,   &amp;   <span class="comment">! squared buoyancy frequency associated at interfaces (1/s2)</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    drho_int, &amp;   <span class="comment">! locally ref potential density difference across interfaces (in s-2) smg: or kg/m3?</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    kt_extra, &amp;   <span class="comment">! double difusion diffusivity on temperature (m2/sec)</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    ks_extra      <span class="comment">! double difusion diffusivity on salinity (m2/sec)</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordtype">real</span> :: i_trans       <span class="comment">! inverse of the transitional for Bryan-Lewis (1/m)</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="keywordtype">real</span> :: depth_c       <span class="comment">! depth of the center of a layer (meter)</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">real</span> :: i_hmix        <span class="comment">! inverse of fixed mixed layer thickness (1/m)</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordtype">real</span> :: i_rho0        <span class="comment">! inverse of Boussinesq density (m3/kg)</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordtype">real</span> :: i_x30         <span class="comment">! 2/acos(2) = 1/(sin(30 deg) * acosh(1/sin(30 deg)))</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">real</span> :: abs_sin       <span class="comment">! absolute value of sine of latitude (nondim)</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">real</span> :: atan_fn_sfc   <span class="comment">! surface value of Bryan-Lewis profile (nondim)</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">real</span> :: atan_fn_lay   <span class="comment">! value of Bryan-Lewis profile in layer middle (nondim)</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">real</span> :: i_atan_fn     <span class="comment">! inverse of change in Bryan-Lewis profile from surface to infinite depth (nondim)</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">real</span> :: deg_to_rad    <span class="comment">! factor converting degrees to radians, pi/180.</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">real</span> :: dissip        <span class="comment">! local variable for dissipation calculations (W/m3)</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keywordtype">real</span> :: omega2        <span class="comment">! squared absolute rotation rate (1/s2)</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keywordtype">real</span> :: i_2omega      <span class="comment">! 1/(2 Omega) (sec)</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordtype">real</span> :: n_2omega</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordtype">real</span> :: n02_n2</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordtype">real</span> :: epsilon</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordtype">logical</span>   :: use_eos      <span class="comment">! If true, compute density from T/S using equation of state.</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <span class="keywordtype">type</span>(p3d) :: z_ptrs(6)    <span class="comment">! pointers to diagns to be interpolated into depth space</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordtype">integer</span>   :: kb(szi_(g))  <span class="comment">! The index of the lightest layer denser than the</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                            <span class="comment">! buffer layer.</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordtype">integer</span>   :: num_z_diags  <span class="comment">! number of diagns to be interpolated to depth space</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordtype">integer</span>   :: z_ids(6)     <span class="comment">! id numbers of diagns to be interpolated to depth space</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordtype">logical</span>   :: showcalltree <span class="comment">! If true, show the call tree.</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keywordtype">real</span>      :: kappa_fill   <span class="comment">! diffusivity used to fill massless layers</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="keywordtype">real</span>      :: dt_fill      <span class="comment">! timestep used to fill massless layers</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = g%ke</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  showcalltree = calltree_showquery()</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;set_diffusivity(), MOM_set_diffusivity.F90&quot;</span>)</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;set_diffusivity: &quot;</span>//&amp;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  i_rho0     = 1.0/gv%Rho0</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  kappa_fill = 1.e-3 <span class="comment">! m2 s-1</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;  dt_fill    = 7200.</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  deg_to_rad = atan(1.0)/45.0 <span class="comment">! = PI/180</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  omega2     = cs%Omega*cs%Omega</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  i_2omega   = 0.5/cs%Omega</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  epsilon    = 1.e-10</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  use_eos = <span class="keyword">associated</span>(tv%eqn_of_state)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="keywordflow">if</span> ((cs%double_diffusion) .and. &amp;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      .not.(<span class="keyword">associated</span>(visc%Kd_extra_T) .and. <span class="keyword">associated</span>(visc%Kd_extra_S)) ) &amp;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;set_diffusivity: visc%Kd_extra_T and &quot;</span>//&amp;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;         <span class="stringliteral">&quot;visc%Kd_extra_S must be associated when DOUBLE_DIFFUSION is true.&quot;</span>)</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="comment">! Set up arrays for diagnostics.</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">if</span> ((cs%id_N2 &gt; 0) .or. (cs%id_N2_z &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keyword">allocate</span>(dd%N2_3d(isd:ied,jsd:jed,nz+1)) ; dd%N2_3d(:,:,:) = 0.0</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_itidal &gt; 0) .or. (cs%id_Kd_itidal_z &gt; 0) .or. &amp;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      (cs%id_Kd_Itidal_work &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_itidal(isd:ied,jsd:jed,nz+1)) ; dd%Kd_itidal(:,:,:) = 0.0</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_lowmode &gt; 0) .or. (cs%id_Kd_lowmode_z &gt; 0) .or. &amp;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      (cs%id_Kd_lowmode_work &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_lowmode(isd:ied,jsd:jed,nz+1)) ; dd%Kd_lowmode(:,:,:) = 0.0</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Fl_itidal &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keyword">allocate</span>(dd%Fl_itidal(isd:ied,jsd:jed,nz+1)) ; dd%Fl_itidal(:,:,:) = 0.0</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Fl_lowmode &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keyword">allocate</span>(dd%Fl_lowmode(isd:ied,jsd:jed,nz+1)) ; dd%Fl_lowmode(:,:,:) = 0.0</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Polzin_decay_scale &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keyword">allocate</span>(dd%Polzin_decay_scale(isd:ied,jsd:jed))</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    dd%Polzin_decay_scale(:,:) = 0.0</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_Polzin_decay_scale_scaled &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="keyword">allocate</span>(dd%Polzin_decay_scale_scaled(isd:ied,jsd:jed))</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    dd%Polzin_decay_scale_scaled(:,:) = 0.0</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_N2_bot &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keyword">allocate</span>(dd%N2_bot(isd:ied,jsd:jed)) ; dd%N2_bot(:,:) = 0.0</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="keywordflow">if</span> ( (cs%id_N2_meanz &gt; 0) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keyword">allocate</span>(dd%N2_meanz(isd:ied,jsd:jed)) ; dd%N2_meanz(:,:) = 0.0</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_Niku &gt; 0) .or. (cs%id_Kd_Niku_z &gt; 0) .or. &amp;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      (cs%id_Kd_Niku_work &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Niku(isd:ied,jsd:jed,nz+1)) ; dd%Kd_Niku(:,:,:) = 0.0</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_user &gt; 0) .or. (cs%id_Kd_user_z &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_user(isd:ied,jsd:jed,nz+1)) ; dd%Kd_user(:,:,:) = 0.0</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_work &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_work(isd:ied,jsd:jed,nz)) ; dd%Kd_work(:,:,:) = 0.0</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Niku_work &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Niku_work(isd:ied,jsd:jed,nz)) ; dd%Kd_Niku_work(:,:,:) = 0.0</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Itidal_work &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Itidal_work(isd:ied,jsd:jed,nz))</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    dd%Kd_Itidal_work(:,:,:) = 0.0</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_Lowmode_Work &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_Lowmode_Work(isd:ied,jsd:jed,nz))</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    dd%Kd_Lowmode_Work(:,:,:) = 0.0</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="keywordflow">if</span> (cs%id_TKE_itidal &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keyword">allocate</span>(dd%TKE_Itidal_used(isd:ied,jsd:jed)) ; dd%TKE_Itidal_used(:,:) = 0.</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="keywordflow">if</span> (cs%id_maxTKE &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keyword">allocate</span>(dd%maxTKE(isd:ied,jsd:jed,nz)) ; dd%maxTKE(:,:,:) = 0.0</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordflow">if</span> (cs%id_TKE_to_Kd &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keyword">allocate</span>(dd%TKE_to_Kd(isd:ied,jsd:jed,nz)) ; dd%TKE_to_Kd(:,:,:) = 0.0</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  <span class="keywordflow">if</span> ((cs%id_KT_extra &gt; 0) .or. (cs%id_KT_extra_z &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keyword">allocate</span>(dd%KT_extra(isd:ied,jsd:jed,nz+1)) ; dd%KT_extra(:,:,:) = 0.0</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  <span class="keywordflow">if</span> ((cs%id_KS_extra &gt; 0) .or. (cs%id_KS_extra_z &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keyword">allocate</span>(dd%KS_extra(isd:ied,jsd:jed,nz+1)) ; dd%KS_extra(:,:,:) = 0.0</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="keywordflow">if</span> ((cs%id_Kd_BBL &gt; 0) .or. (cs%id_Kd_BBL_z &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keyword">allocate</span>(dd%Kd_BBL(isd:ied,jsd:jed,nz+1)) ; dd%Kd_BBL(:,:,:) = 0.0</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="comment">! Smooth the properties through massless layers.</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      <span class="keyword">call </span>hchksum(tv%T, <span class="stringliteral">&quot;before vert_fill_TS tv%T&quot;</span>,g%HI)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="keyword">call </span>hchksum(tv%S, <span class="stringliteral">&quot;before vert_fill_TS tv%S&quot;</span>,g%HI)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      <span class="keyword">call </span>hchksum(h, <span class="stringliteral">&quot;before vert_fill_TS h&quot;</span>,g%HI, scale=gv%H_to_m)</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keyword">call </span>vert_fill_ts(h, tv%T, tv%S, kappa_fill, dt_fill, t_f, s_f, g, gv)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      <span class="keyword">call </span>hchksum(tv%T, <span class="stringliteral">&quot;after vert_fill_TS tv%T&quot;</span>,g%HI)</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;      <span class="keyword">call </span>hchksum(tv%S, <span class="stringliteral">&quot;after vert_fill_TS tv%S&quot;</span>,g%HI)</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      <span class="keyword">call </span>hchksum(h, <span class="stringliteral">&quot;after vert_fill_TS h&quot;</span>,g%HI, scale=gv%H_to_m)</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordflow">if</span> (cs%useKappaShear) <span class="keywordflow">then</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      <span class="keyword">call </span>hchksum(u_h, <span class="stringliteral">&quot;before calc_KS u_h&quot;</span>,g%HI)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;      <span class="keyword">call </span>hchksum(v_h, <span class="stringliteral">&quot;before calc_KS v_h&quot;</span>,g%HI)</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_kappashear)</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="comment">! Changes: visc%Kd_turb, visc%TKE_turb (not clear that TKE_turb is used as input ????)</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="comment">! Sets visc%Kv_turb</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keyword">call </span>calculate_kappa_shear(u_h, v_h, h, tv, fluxes%p_surf, visc%Kd_turb, visc%TKE_turb, &amp;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                               visc%Kv_turb, dt, g, gv, cs%kappaShear_CSp)</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_kappashear)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      <span class="keyword">call </span>hchksum(visc%Kd_turb, <span class="stringliteral">&quot;after calc_KS visc%Kd_turb&quot;</span>,g%HI)</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      <span class="keyword">call </span>hchksum(visc%Kv_turb, <span class="stringliteral">&quot;after calc_KS visc%Kv_turb&quot;</span>,g%HI)</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="keyword">call </span>hchksum(visc%TKE_turb, <span class="stringliteral">&quot;after calc_KS visc%TKE_turb&quot;</span>,g%HI)</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with calculate_kappa_shear (set_diffusivity)&quot;</span>)</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160; <span class="keywordflow">elseif</span> (cs%useCVMix) <span class="keywordflow">then</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">!NOTE{BGR}: this needs cleaned up.  Works in 1D case, not tested outside.</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keyword">call </span>calculate_cvmix_shear(u_h, v_h, h, tv, visc%Kd_turb, visc%Kv_turb,g,gv,cs%CVMix_shear_CSp)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  <span class="keywordflow">elseif</span> (<span class="keyword">associated</span>(visc%Kv_turb)) <span class="keywordflow">then</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    visc%Kv_turb(:,:,:) = 0. <span class="comment">! needed if calculate_kappa_shear is not enabled</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">!   Calculate the diffusivity, Kd, for each layer.  This would be</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">! the appropriate place to add a depth-dependent parameterization or</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">! another explicit parameterization of Kd.</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  <span class="keywordflow">if</span> (cs%Bryan_Lewis_diffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,CS,Kd_sfc)</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;      kd_sfc(i,j) = cs%Kd_Bryan_Lewis_surface</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,CS,Kd_sfc)</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;      kd_sfc(i,j) = cs%Kd</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <span class="keywordflow">if</span> (cs%Henyey_IGW_background) <span class="keywordflow">then</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    i_x30 = 2.0 / invcosh(cs%N0_2Omega*2.0) <span class="comment">! This is evaluated at 30 deg.</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,Kd_sfc,CS,G,deg_to_rad,epsilon,I_x30) &amp;</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment">!$OMP                          private(abs_sin)</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;      abs_sin = abs(sin(g%geoLatT(i,j)*deg_to_rad))</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      kd_sfc(i,j) = max(cs%Kd_min, kd_sfc(i,j) * &amp;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;           ((abs_sin * invcosh(cs%N0_2Omega/max(epsilon,abs_sin))) * i_x30) )</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="keywordflow">elseif</span> (cs%Kd_tanh_lat_fn) <span class="keywordflow">then</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,Kd_sfc,CS,G)</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      <span class="comment">!   The transition latitude and latitude range are hard-scaled here, since</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;      <span class="comment">! this is not really intended for wide-spread use, but rather for</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;      <span class="comment">! comparison with CM2M / CM2.1 settings.</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;      kd_sfc(i,j) = max(cs%Kd_min, kd_sfc(i,j) * (1.0 + &amp;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;          cs%Kd_tanh_lat_scale * 0.5*tanh((abs(g%geoLatT(i,j)) - 35.0)/5.0) ))</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>hchksum(kd_sfc,<span class="stringliteral">&quot;Kd_sfc&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,G,GV,CS,h,tv,T_f,S_f,fluxes,dd, &amp;</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">!$OMP                                  Kd,Kd_sfc,epsilon,deg_to_rad,I_2Omega,visc,    &amp;</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">!$OMP                                  Kd_int,dt,u,v,Omega2)   &amp;</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="comment">!$OMP                          private(dRho_int,I_trans,atan_fn_sfc,I_atan_fn,atan_fn_lay, &amp;</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">!$OMP                                  I_Hmix,depth_c,depth,N2_lay, N2_int, N2_bot,        &amp;</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="comment">!$OMP                                  I_x30,abs_sin,N_2Omega,N02_N2,KT_extra, KS_extra,   &amp;</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="comment">!$OMP                                  TKE_to_Kd,maxTKE,dissip,kb)</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="comment">! Set up variables related to the stratification.</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keyword">call </span>find_n2(h, tv, t_f, s_f, fluxes, j, g, gv, cs, drho_int, n2_lay, n2_int, n2_bot)</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_3d)) <span class="keywordflow">then</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie ; dd%N2_3d(i,j,k) = n2_int(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="comment">! Set up the background diffusivity.</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="keywordflow">if</span> (cs%Bryan_Lewis_diffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      i_trans = 1.0 / cs%Bryan_Lewis_width_trans</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      atan_fn_sfc = atan(cs%Bryan_Lewis_depth_cent*i_trans)</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      i_atan_fn = 1.0 / (2.0*atan(1.0) + atan_fn_sfc)</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; depth(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        atan_fn_lay = atan((cs%Bryan_Lewis_depth_cent - &amp;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                            (depth(i)+0.5*gv%H_to_m*h(i,j,k)))*i_trans)</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        kd(i,j,k) = kd_sfc(i,j) + (cs%Kd_Bryan_Lewis_deep - kd_sfc(i,j)) * &amp;</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                                  (atan_fn_sfc - atan_fn_lay) * i_atan_fn</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        depth(i) = depth(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">elseif</span> ((.not.cs%bulkmixedlayer) .and. (cs%Kd /= cs%Kdml)) <span class="keywordflow">then</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;      i_hmix = 1.0 / cs%Hmix</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; depth(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        depth_c = depth(i) + 0.5*gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="keywordflow">if</span> (depth_c &lt;= cs%Hmix) <span class="keywordflow">then</span> ; kd(i,j,k) = cs%Kdml</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="keywordflow">elseif</span> (depth_c &gt;= 2.0*cs%Hmix) <span class="keywordflow">then</span> ; kd(i,j,k) = kd_sfc(i,j)</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;          kd(i,j,k) = ((kd_sfc(i,j) - cs%Kdml) * i_hmix) * depth_c + &amp;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                      (2.0*cs%Kdml - kd_sfc(i,j))</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        depth(i) = depth(i) + gv%H_to_m*h(i,j,k)</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="keywordflow">elseif</span> (cs%Henyey_IGW_background_new) <span class="keywordflow">then</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;      i_x30 = 2.0 / invcosh(cs%N0_2Omega*2.0) <span class="comment">! This is evaluated at 30 deg.</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        abs_sin = max(epsilon,abs(sin(g%geoLatT(i,j)*deg_to_rad)))</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        n_2omega = max(abs_sin,sqrt(n2_lay(i,k))*i_2omega)</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        n02_n2 = (cs%N0_2Omega/n_2omega)**2</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        kd(i,j,k) = max(cs%Kd_min, kd_sfc(i,j) * &amp;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;             ((abs_sin * invcosh(n_2omega/abs_sin)) * i_x30)*n02_n2)</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        kd(i,j,k) = kd_sfc(i,j)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">if</span> (cs%double_diffusion) <span class="keywordflow">then</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;      <span class="keyword">call </span>double_diffusion(tv, h, t_f, s_f, j, g, gv, cs, kt_extra, ks_extra)</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="keywordflow">if</span> (ks_extra(i,k) &gt; kt_extra(i,k)) <span class="keywordflow">then</span> <span class="comment">! salt fingering</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;          kd(i,j,k-1) = kd(i,j,k-1) + 0.5*kt_extra(i,k)</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;          kd(i,j,k)   = kd(i,j,k)   + 0.5*kt_extra(i,k)</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;          visc%Kd_extra_S(i,j,k) = ks_extra(i,k)-kt_extra(i,k)</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;          visc%Kd_extra_T(i,j,k) = 0.0</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordflow">elseif</span> (kt_extra(i,k) &gt; 0.0) <span class="keywordflow">then</span> <span class="comment">! double-diffusive convection</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;          kd(i,j,k-1) = kd(i,j,k-1) + 0.5*ks_extra(i,k)</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;          kd(i,j,k)   = kd(i,j,k)   + 0.5*ks_extra(i,k)</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;          visc%Kd_extra_T(i,j,k) = kt_extra(i,k)-ks_extra(i,k)</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;          visc%Kd_extra_S(i,j,k) = 0.0</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="keywordflow">else</span> <span class="comment">! There is no double diffusion at this interface.</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;          visc%Kd_extra_T(i,j,k) = 0.0</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;          visc%Kd_extra_S(i,j,k) = 0.0</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keyword">      end</span>do; enddo</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%KT_extra)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        dd%KT_extra(i,j,k) = kt_extra(i,k)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%KS_extra)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        dd%KS_extra(i,j,k) = ks_extra(i,k)</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="comment">! Add the input turbulent diffusivity.</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="keywordflow">if</span> (cs%useKappaShear .or. cs%useCVMix) <span class="keywordflow">then</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;          kd_int(i,j,k) = visc%Kd_turb(i,j,k) + 0.5*(kd(i,j,k-1) + kd(i,j,k))</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;          kd_int(i,j,1) = visc%Kd_turb(i,j,1) <span class="comment">! This isn&#39;t actually used. It could be 0.</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          kd_int(i,j,nz+1) = 0.0</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        kd(i,j,k) = kd(i,j,k) + 0.5*(visc%Kd_turb(i,j,k) + visc%Kd_turb(i,j,k+1))</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;          kd_int(i,j,1) = kd(i,j,1) ; kd_int(i,j,nz+1) = 0.0</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;          kd_int(i,j,k) = 0.5*(kd(i,j,k-1) + kd(i,j,k))</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keyword">call </span>find_tke_to_kd(h, tv, drho_int, n2_lay, j, dt, g, gv, cs, tke_to_kd, &amp;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                        maxtke, kb)</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%maxTKE)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      dd%maxTKE(i,j,k) = maxtke(i,k)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_to_Kd)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;      dd%TKE_to_Kd(i,j,k) = tke_to_kd(i,k)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="comment">! Add the ML_Rad diffusivity.</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordflow">if</span> (cs%ML_radiation) &amp;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      <span class="keyword">call </span>add_mlrad_diffusivity(h, fluxes, j, g, gv, cs, kd, tke_to_kd, kd_int)</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="comment">! Add the Nikurashin and / or tidal bottom-driven mixing</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. cs%Lowmode_itidal_dissipation) &amp;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      <span class="keyword">call </span>add_int_tide_diffusivity(h, n2_bot, j, tke_to_kd, maxtke, g, gv, cs, &amp;</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                                    dd, n2_lay, kd, kd_int)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="comment">! This adds the diffusion sustained by the energy extracted from the flow</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="comment">! by the bottom drag.</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">if</span> (cs%bottomdraglaw .and. (cs%BBL_effic&gt;0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <span class="keywordflow">if</span> (cs%use_LOTW_BBL_diffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keyword">call </span>add_lotw_bbl_diffusivity(h, u, v, tv, fluxes, visc, j, n2_int, g, gv, cs,  &amp;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                                      kd, kd_int, dd%Kd_BBL)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="keyword">call </span>add_drag_diffusivity(h, u, v, tv, fluxes, visc, j, tke_to_kd, &amp;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                                  maxtke, kb, g, gv, cs, kd, kd_int, dd%Kd_BBL)</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keywordflow">if</span> (cs%limit_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;      <span class="comment">! This calculates the dissipation ONLY from Kd calculated in this routine</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;      <span class="comment">! dissip has units of W/m3 (kg/m3 * m2/s * 1/s2 = J/s/m3)</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;      <span class="comment">!   1) a global constant,</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;      <span class="comment">!   2) a dissipation proportional to N (aka Gargett) and</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;      <span class="comment">!   3) dissipation corresponding to a (nearly) constant diffusivity.</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        dissip = max( cs%dissip_min, &amp;   <span class="comment">! Const. floor on dissip.</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                      cs%dissip_N0 + cs%dissip_N1 * sqrt(n2_lay(i,k)), &amp; <span class="comment">! Floor aka Gargett</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                      cs%dissip_N2 * n2_lay(i,k) ) <span class="comment">! Floor of Kd_min*rho0/F_Ri</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        kd(i,j,k) = max( kd(i,j,k) , &amp;  <span class="comment">! Apply floor to Kd</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;           dissip * (cs%FluxRi_max / (gv%Rho0 * (n2_lay(i,k) + omega2))) )</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;      <span class="comment">! This calculates the dissipation ONLY from Kd calculated in this routine</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;      <span class="comment">! dissip has units of W/m3 (kg/m3 * m2/s * 1/s2 = J/s/m3)</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;      <span class="comment">!   1) a global constant,</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;      <span class="comment">!   2) a dissipation proportional to N (aka Gargett) and</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      <span class="comment">!   3) dissipation corresponding to a (nearly) constant diffusivity.</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        dissip = max( cs%dissip_min, &amp;   <span class="comment">! Const. floor on dissip.</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                      cs%dissip_N0 + cs%dissip_N1 * sqrt(n2_int(i,k)), &amp; <span class="comment">! Floor aka Gargett</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                      cs%dissip_N2 * n2_int(i,k) ) <span class="comment">! Floor of Kd_min*rho0/F_Ri</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        kd_int(i,j,k) = max( kd_int(i,j,k) , &amp;  <span class="comment">! Apply floor to Kd</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;           dissip * (cs%FluxRi_max / (gv%Rho0 * (n2_int(i,k) + omega2))) )</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_work)) <span class="keywordflow">then</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        dd%Kd_Work(i,j,k)  = gv%Rho0 * kd(i,j,k) * n2_lay(i,k) * &amp;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                             gv%H_to_m*h(i,j,k)  <span class="comment">! Watt m-2 s or kg s-3</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keyword">call </span>hchksum(kd,<span class="stringliteral">&quot;BBL Kd&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keywordflow">if</span> (cs%useKappaShear) <span class="keyword">call </span>hchksum(visc%Kd_turb,<span class="stringliteral">&quot;Turbulent Kd&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%kv_bbl_u) .and. <span class="keyword">associated</span>(visc%kv_bbl_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;BBL Kv_bbl_[uv]&quot;</span>, visc%kv_bbl_u, visc%kv_bbl_v, &amp;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                    g%HI, 0, symmetric=.true.)</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%bbl_thick_u) .and. <span class="keyword">associated</span>(visc%bbl_thick_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;BBL bbl_thick_[uv]&quot;</span>, visc%bbl_thick_u, &amp;</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                    visc%bbl_thick_v, g%HI, 0, symmetric=.true.)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%Ray_u) .and. <span class="keyword">associated</span>(visc%Ray_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;Ray_[uv]&quot;</span>, visc%Ray_u, visc%Ray_v, g%HI, 0, symmetric=.true.)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="keywordflow">if</span> (cs%Kd_add &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(kd_int)) <span class="keywordflow">then</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,Kd_int,CS,Kd)</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        kd_int(i,j,k) = kd_int(i,j,k) + cs%Kd_add</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        kd(i,j,k) = kd(i,j,k) + cs%Kd_add</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,CS,Kd)</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        kd(i,j,k) = kd(i,j,k) + cs%Kd_add</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  <span class="keywordflow">if</span> (cs%user_change_diff) <span class="keywordflow">then</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keyword">call </span>user_change_diff(h, tv, g, cs%user_change_diff_CSp, kd, kd_int, &amp;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                          t_f, s_f, dd%Kd_user)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_layer &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_layer, kd, cs%diag)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  num_z_diags = 0</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_itidal  &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_itidal,  dd%TKE_itidal_used, cs%diag)</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_leewave &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_leewave, cs%TKE_Niku,        cs%diag)</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="keywordflow">if</span> (cs%id_Nb          &gt; 0) <span class="keyword">call </span>post_data(cs%id_Nb,      cs%Nb,      cs%diag)</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2          &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2,      dd%N2_3d,   cs%diag)</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_bot      &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2_bot,  dd%N2_bot,  cs%diag)</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_meanz    &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2_meanz,dd%N2_meanz,cs%diag)</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    <span class="keywordflow">if</span> (cs%id_Fl_itidal &gt; 0) <span class="keyword">call </span>post_data(cs%id_Fl_itidal, dd%Fl_itidal, cs%diag)</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_itidal &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_itidal, dd%Kd_itidal, cs%diag)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Niku   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_Niku,   dd%Kd_Niku,   cs%diag)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_lowmode&gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_lowmode, dd%Kd_lowmode, cs%diag)</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordflow">if</span> (cs%id_Fl_lowmode&gt; 0) <span class="keyword">call </span>post_data(cs%id_Fl_lowmode, dd%Fl_lowmode, cs%diag)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_user   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_user,   dd%Kd_user,   cs%diag)</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Work   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_Work,   dd%Kd_Work,   cs%diag)</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Itidal_Work &gt; 0) &amp;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Kd_Itidal_Work, dd%Kd_Itidal_Work, cs%diag)</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Niku_Work &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_Niku_Work, dd%Kd_Niku_Work, cs%diag)</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Lowmode_Work &gt; 0) &amp;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Kd_Lowmode_Work, dd%Kd_Lowmode_Work, cs%diag)</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keywordflow">if</span> (cs%id_maxTKE &gt; 0) <span class="keyword">call </span>post_data(cs%id_maxTKE, dd%maxTKE, cs%diag)</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_to_Kd &gt; 0) <span class="keyword">call </span>post_data(cs%id_TKE_to_Kd, dd%TKE_to_Kd, cs%diag)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">if</span> (cs%id_Polzin_decay_scale &gt; 0 ) &amp;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Polzin_decay_scale, dd%Polzin_decay_scale, cs%diag)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordflow">if</span> (cs%id_Polzin_decay_scale_scaled &gt; 0 ) &amp;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Polzin_decay_scale_scaled, dd%Polzin_decay_scale_scaled, cs%diag)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_itidal_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      num_z_diags        = num_z_diags + 1</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;      z_ids(num_z_diags) = cs%id_Kd_itidal_z</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%Kd_itidal</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_Niku_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;      num_z_diags        = num_z_diags + 1</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      z_ids(num_z_diags) = cs%id_Kd_Niku_z</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%Kd_Niku</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_lowmode_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;      num_z_diags        = num_z_diags + 1</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      z_ids(num_z_diags) = cs%id_Kd_lowmode_z</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%Kd_lowmode</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="keywordflow">if</span> (cs%id_N2_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      num_z_diags = num_z_diags + 1</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      z_ids(num_z_diags) = cs%id_N2_z</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%N2_3d</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kd_user_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;      num_z_diags        = num_z_diags + 1</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;      z_ids(num_z_diags) = cs%id_Kd_user_z</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%Kd_user</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordflow">if</span> (cs%id_KT_extra &gt; 0) <span class="keyword">call </span>post_data(cs%id_KT_extra, dd%KT_extra, cs%diag)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordflow">if</span> (cs%id_KS_extra &gt; 0) <span class="keyword">call </span>post_data(cs%id_KS_extra, dd%KS_extra, cs%diag)</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_BBL &gt; 0)   <span class="keyword">call </span>post_data(cs%id_Kd_BBL, dd%Kd_BBL, cs%diag)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordflow">if</span> (cs%id_KT_extra_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;      num_z_diags = num_z_diags + 1</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;      z_ids(num_z_diags) = cs%id_KT_extra_z</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%KT_extra</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="keywordflow">if</span> (cs%id_KS_extra_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      num_z_diags = num_z_diags + 1</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      z_ids(num_z_diags) = cs%id_KS_extra_z</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%KS_extra</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_BBL_z &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;      num_z_diags = num_z_diags + 1</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;      z_ids(num_z_diags) = cs%id_Kd_BBL_z</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;      z_ptrs(num_z_diags)%p =&gt; dd%KS_extra</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  <span class="keywordflow">if</span> (num_z_diags &gt; 0) &amp;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="keyword">call </span>calc_zint_diags(h, z_ptrs, z_ids, num_z_diags, g, gv, cs%diag_to_Z_CSp)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_3d)) <span class="keyword">deallocate</span>(dd%N2_3d)</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_itidal)) <span class="keyword">deallocate</span>(dd%Kd_itidal)</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_lowmode)) <span class="keyword">deallocate</span>(dd%Kd_lowmode)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_itidal)) <span class="keyword">deallocate</span>(dd%Fl_itidal)</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Fl_lowmode)) <span class="keyword">deallocate</span>(dd%Fl_lowmode)</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale)) <span class="keyword">deallocate</span>(dd%Polzin_decay_scale)</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Polzin_decay_scale_scaled)) <span class="keyword">deallocate</span>(dd%Polzin_decay_scale_scaled)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_bot)) <span class="keyword">deallocate</span>(dd%N2_bot)</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%N2_meanz)) <span class="keyword">deallocate</span>(dd%N2_meanz)</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_work)) <span class="keyword">deallocate</span>(dd%Kd_work)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_user)) <span class="keyword">deallocate</span>(dd%Kd_user)</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku)) <span class="keyword">deallocate</span>(dd%Kd_Niku)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Niku_work)) <span class="keyword">deallocate</span>(dd%Kd_Niku_work)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Itidal_Work))  <span class="keyword">deallocate</span>(dd%Kd_Itidal_Work)</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_Lowmode_Work)) <span class="keyword">deallocate</span>(dd%Kd_Lowmode_Work)</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_itidal_used)) <span class="keyword">deallocate</span>(dd%TKE_itidal_used)</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%maxTKE)) <span class="keyword">deallocate</span>(dd%maxTKE)</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%TKE_to_Kd)) <span class="keyword">deallocate</span>(dd%TKE_to_Kd)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%KT_extra)) <span class="keyword">deallocate</span>(dd%KT_extra)</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%KS_extra)) <span class="keyword">deallocate</span>(dd%KS_extra)</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(dd%Kd_BBL)) <span class="keyword">deallocate</span>(dd%Kd_BBL)</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;set_diffusivity()&quot;</span>)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__set__diffusivity_a8b1f646393f0ec717ca690e4f04d96e8_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ace82f133d3cee42aa36ec10bcce79e75"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ace82f133d3cee42aa36ec10bcce79e75">&#9670;&nbsp;</a></span>set_diffusivity_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_set_diffusivity::set_diffusivity_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l03212">3212</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs), <span class="keywordtype">pointer</span> :: cs</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;</div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;  <span class="keywordflow">if</span> (cs%user_change_diff) &amp;</div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;    <span class="keyword">call </span>user_change_diff_end(cs%user_change_diff_CSp)</div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="ac0a2a098bc7dc3b087a4bae87511b7ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac0a2a098bc7dc3b087a4bae87511b7ca">&#9670;&nbsp;</a></span>set_diffusivity_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_set_diffusivity::set_diffusivity_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__set__diffusivity_1_1set__diffusivity__cs.html">set_diffusivity_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_to_z_cs), pointer&#160;</td>
          <td class="paramname"><em>diag_to_Z_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(int_tide_cs), pointer&#160;</td>
          <td class="paramname"><em>int_tide_CSp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>structure used to regulate diagnostic output.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>pointer set to point to the module control structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">diag_to_z_csp</td><td>pointer to the Z-diagnostics control structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">int_tide_csp</td><td>pointer to the internal tides control structure (BDM) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">2555</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00367">id_clock_kappashear</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00364">polzin_09</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00362">polzin_profile_string</a>, <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00363">stlaurent_02</a>, and <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00361">stlaurent_profile_string</a>.</p>
<div class="fragment"><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;  <span class="keywordtype">type</span>(time_type),          <span class="keywordtype">intent(in)</span>    :: time</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),    <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;  <span class="keywordtype">type</span>(param_file_type),    <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="comment">                                                  !! parameters.</span></div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>,  <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; structure used to regulate diagnostic output.</span></div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;  <span class="keywordtype">type</span>(set_diffusivity_cs), <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; pointer set to point to the module control</span></div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;<span class="comment">                                                  !! structure.</span></div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;  <span class="keywordtype">type</span>(diag_to_z_cs),       <span class="keywordtype">pointer</span>       :: diag_to_z_csp<span class="comment"> !&lt; pointer to the Z-diagnostics control</span></div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;<span class="comment">                                                  !! structure.</span></div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;  <span class="keywordtype">type</span>(int_tide_cs),        <span class="keywordtype">pointer</span>       :: int_tide_csp<span class="comment">  !&lt; pointer to the internal tides control</span></div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;<span class="comment">                                                  !! structure (BDM)</span></div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;<span class="comment">!  (in)      Time          - current model time</span></div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;<span class="comment">!  (in)      G             - ocean grid structure</span></div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;<span class="comment">!  (in)      param_file    - structure indicating open file to parse for params</span></div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;<span class="comment">!  (in)      diag          - structure used to regulate diagnostic output</span></div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;<span class="comment">!  (in/out)  CS            - pointer set to point to the module control structure</span></div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;<span class="comment">!  (in)      diag_to_Z_CSp - pointer to the Z-diagnostics control structure</span></div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;<span class="comment">!  (in)      int_tide_CSp  - pointer to the internal tides control structure (BDM)</span></div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;  <span class="keywordtype">real</span> :: decay_length, utide, zbot, hamp</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;  <span class="keywordtype">type</span>(vardesc) :: vd</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;  <span class="keywordtype">logical</span> :: read_tideamp, ml_use_omega</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_set_diffusivity&quot;</span>  <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;  <span class="keywordtype">character(len=20)</span>  :: tmpstr</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;  <span class="keywordtype">character(len=200)</span> :: filename, tideamp_file, h2_file, niku_tke_input_file</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;  <span class="keywordtype">real</span> :: niku_scale <span class="comment">! local variable for scaling the Nikurashin TKE flux data</span></div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;  <span class="keywordtype">real</span> :: omega_frac_dflt</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;diabatic_entrain_init called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;                            <span class="stringliteral">&quot;control structure.&quot;</span>)</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(int_tide_csp))  cs%int_tide_CSp  =&gt; int_tide_csp</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(diag_to_z_csp)) cs%diag_to_Z_CSp =&gt; diag_to_z_csp</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;</div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;  <span class="comment">! These default values always need to be set.</span></div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;  cs%BBL_mixing_as_max = .true.</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;  cs%Kdml = 0.0 ; cs%cdrag = 0.003 ; cs%BBL_effic = 0.0 ;</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;  cs%bulkmixedlayer = (gv%nkml &gt; 0)</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;</div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR&quot;</span>, cs%inputdir, default=<span class="stringliteral">&quot;.&quot;</span>)</div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;  cs%inputdir = slasher(cs%inputdir)</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;FLUX_RI_MAX&quot;</span>, cs%FluxRi_max, &amp;</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;                 <span class="stringliteral">&quot;The flux Richardson number where the stratification is \n&quot;</span>//&amp;</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;                 <span class="stringliteral">&quot;large enough that N2 &gt; omega2.  The full expression for \n&quot;</span>//&amp;</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;                 <span class="stringliteral">&quot;the Flux Richardson number is usually \n&quot;</span>//&amp;</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;                 <span class="stringliteral">&quot;FLUX_RI_MAX*N2/(N2+OMEGA2).&quot;</span>, default=0.2)</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OMEGA&quot;</span>, cs%omega, &amp;</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;                 <span class="stringliteral">&quot;The rotation rate of the earth.&quot;</span>, units=<span class="stringliteral">&quot;s-1&quot;</span>, &amp;</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;                 default=7.2921e-5)</div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RADIATION&quot;</span>, cs%ML_radiation, &amp;</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;                 <span class="stringliteral">&quot;If true, allow a fraction of TKE available from wind \n&quot;</span>//&amp;</div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;                 <span class="stringliteral">&quot;work to penetrate below the base of the mixed layer \n&quot;</span>//&amp;</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;                 <span class="stringliteral">&quot;with a vertical decay scale determined by the minimum \n&quot;</span>//&amp;</div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;                 <span class="stringliteral">&quot;of: (1) The depth of the mixed layer, (2) an Ekman \n&quot;</span>//&amp;</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;                 <span class="stringliteral">&quot;length scale.&quot;</span>, default=.false.)</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;  <span class="keywordflow">if</span> (cs%ML_radiation) <span class="keywordflow">then</span></div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;    <span class="comment">! This give a minimum decay scale that is typically much less than Angstrom.</span></div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    cs%ustar_min = 2e-4*cs%omega*(gv%Angstrom + gv%H_subroundoff)</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RAD_EFOLD_COEFF&quot;</span>, cs%ML_rad_efold_coeff, &amp;</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;                 <span class="stringliteral">&quot;A coefficient that is used to scale the penetration \n&quot;</span>//&amp;</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;                 <span class="stringliteral">&quot;depth for turbulence below the base of the mixed layer. \n&quot;</span>//&amp;</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;                 <span class="stringliteral">&quot;This is only used if ML_RADIATION is true.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;                 default=0.2)</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RAD_KD_MAX&quot;</span>, cs%ML_rad_kd_max, &amp;</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;                 <span class="stringliteral">&quot;The maximum diapycnal diffusivity due to turbulence \n&quot;</span>//&amp;</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;                 <span class="stringliteral">&quot;radiated from the base of the mixed layer. \n&quot;</span>//&amp;</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;                 <span class="stringliteral">&quot;This is only used if ML_RADIATION is true.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, &amp;</div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;                 default=1.0e-3)</div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RAD_COEFF&quot;</span>, cs%ML_rad_coeff, &amp;</div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;                 <span class="stringliteral">&quot;The coefficient which scales MSTAR*USTAR^3 to obtain \n&quot;</span>//&amp;</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;                 <span class="stringliteral">&quot;the energy available for mixing below the base of the \n&quot;</span>//&amp;</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;                 <span class="stringliteral">&quot;mixed layer. This is only used if ML_RADIATION is true.&quot;</span>, &amp;</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RAD_APPLY_TKE_DECAY&quot;</span>, cs%ML_rad_TKE_decay, &amp;</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;                 <span class="stringliteral">&quot;If true, apply the same exponential decay to ML_rad as \n&quot;</span>//&amp;</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;                 <span class="stringliteral">&quot;is applied to the other surface sources of TKE in the \n&quot;</span>//&amp;</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;                 <span class="stringliteral">&quot;mixed layer code. This is only used if ML_RADIATION is true.&quot;</span>,&amp;</div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;                 default=.true.)</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR&quot;</span>, cs%mstar, &amp;</div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;                 <span class="stringliteral">&quot;The ratio of the friction velocity cubed to the TKE \n&quot;</span>//&amp;</div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;                 <span class="stringliteral">&quot;input to the mixed layer.&quot;</span>, <span class="stringliteral">&quot;units=nondim&quot;</span>, default=1.2)</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_DECAY&quot;</span>, cs%TKE_decay, &amp;</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;                 <span class="stringliteral">&quot;The ratio of the natural Ekman depth to the TKE decay scale.&quot;</span>, &amp;</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2.5)</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_USE_OMEGA&quot;</span>, ml_use_omega, &amp;</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;                 <span class="stringliteral">&quot;If true, use the absolute rotation rate instead of the \n&quot;</span>//&amp;</div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;                 <span class="stringliteral">&quot;vertical component of rotation when setting the decay \n&quot;</span>//&amp;</div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;                 <span class="stringliteral">&quot;scale for turbulence.&quot;</span>, default=.false., do_not_log=.true.)</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;    omega_frac_dflt = 0.0</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;    <span class="keywordflow">if</span> (ml_use_omega) <span class="keywordflow">then</span></div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;ML_USE_OMEGA is depricated; use ML_OMEGA_FRAC=1.0 instead.&quot;</span>)</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;      omega_frac_dflt = 1.0</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_OMEGA_FRAC&quot;</span>, cs%ML_omega_frac, &amp;</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;                   <span class="stringliteral">&quot;When setting the decay scale for turbulence, use this \n&quot;</span>//&amp;</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;                   <span class="stringliteral">&quot;fraction of the absolute rotation rate blended with the \n&quot;</span>//&amp;</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;                   <span class="stringliteral">&quot;local value of f, as sqrt((1-of)*f^2 + of*4*omega^2).&quot;</span>, &amp;</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;                   units=<span class="stringliteral">&quot;nondim&quot;</span>, default=omega_frac_dflt)</div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOTTOMDRAGLAW&quot;</span>, cs%bottomdraglaw, &amp;</div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;                 <span class="stringliteral">&quot;If true, the bottom stress is calculated with a drag \n&quot;</span>//&amp;</div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;                 <span class="stringliteral">&quot;law of the form c_drag*|u|*u. The velocity magnitude \n&quot;</span>//&amp;</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;                 <span class="stringliteral">&quot;may be an assumed value or it may be based on the \n&quot;</span>//&amp;</div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;                 <span class="stringliteral">&quot;actual velocity in the bottommost HBBL, depending on \n&quot;</span>//&amp;</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;                 <span class="stringliteral">&quot;LINEAR_DRAG.&quot;</span>, default=.true.)</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;  <span class="keywordflow">if</span>  (cs%bottomdraglaw) <span class="keywordflow">then</span></div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CDRAG&quot;</span>, cs%cdrag, &amp;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;                 <span class="stringliteral">&quot;The drag coefficient relating the magnitude of the \n&quot;</span>//&amp;</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;                 <span class="stringliteral">&quot;velocity field to the bottom stress. CDRAG is only used \n&quot;</span>//&amp;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;                 <span class="stringliteral">&quot;if BOTTOMDRAGLAW is true.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.003)</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BBL_EFFIC&quot;</span>, cs%BBL_effic, &amp;</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;                 <span class="stringliteral">&quot;The efficiency with which the energy extracted by \n&quot;</span>//&amp;</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;                 <span class="stringliteral">&quot;bottom drag drives BBL diffusion.  This is only \n&quot;</span>//&amp;</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;                 <span class="stringliteral">&quot;used if BOTTOMDRAGLAW is true.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.20)</div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BBL_MIXING_MAX_DECAY&quot;</span>, decay_length, &amp;</div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;                 <span class="stringliteral">&quot;The maximum decay scale for the BBL diffusion, or 0 \n&quot;</span>//&amp;</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;                 <span class="stringliteral">&quot;to allow the mixing to penetrate as far as \n&quot;</span>//&amp;</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;                 <span class="stringliteral">&quot;stratification and rotation permit.  The default is 0. \n&quot;</span>//&amp;</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;                 <span class="stringliteral">&quot;This is only used if BOTTOMDRAGLAW is true.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, &amp;</div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;                 default=0.0)</div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;</div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;    cs%IMax_decay = 1.0/200.0</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;    <span class="keywordflow">if</span> (decay_length &gt; 0.0) cs%IMax_decay = 1.0/decay_length</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BBL_MIXING_AS_MAX&quot;</span>, cs%BBL_mixing_as_max, &amp;</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;                 <span class="stringliteral">&quot;If true, take the maximum of the diffusivity from the \n&quot;</span>//&amp;</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;                 <span class="stringliteral">&quot;BBL mixing and the other diffusivities. Otherwise, \n&quot;</span>//&amp;</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;                 <span class="stringliteral">&quot;diffusiviy from the BBL_mixing is simply added.&quot;</span>, &amp;</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;                 default=.true.)</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_LOTW_BBL_DIFFUSIVITY&quot;</span>, cs%use_LOTW_BBL_diffusivity, &amp;</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;                 <span class="stringliteral">&quot;If true, uses a simple, imprecise but non-coordinate dependent, model\n&quot;</span>//&amp;</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;                 <span class="stringliteral">&quot;of BBL mixing diffusivity based on Law of the Wall. Otherwise, uses\n&quot;</span>//&amp;</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;                 <span class="stringliteral">&quot;the original BBL scheme.&quot;</span>, default=.false.)</div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;    <span class="keywordflow">if</span> (cs%use_LOTW_BBL_diffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LOTW_BBL_USE_OMEGA&quot;</span>, cs%LOTW_BBL_use_omega, &amp;</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;                 <span class="stringliteral">&quot;If true, use the maximum of Omega and N for the TKE to diffusion\n&quot;</span>//&amp;</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;                 <span class="stringliteral">&quot;calculation. Otherwise, N is N.&quot;</span>, default=.true.)</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;    cs%use_LOTW_BBL_diffusivity = .false. <span class="comment">! This parameterization depends on a u* from viscous BBL</span></div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;  cs%id_Kd_BBL = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_BBL&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;       <span class="stringliteral">&#39;Bottom Boundary Layer Diffusivity&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SIMPLE_TKE_TO_KD&quot;</span>, cs%simple_TKE_to_Kd, &amp;</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;                 <span class="stringliteral">&quot;If true, uses a simple estimate of Kd/TKE that will\n&quot;</span>//&amp;</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;                 <span class="stringliteral">&quot;work for arbitrary vertical coordinates. If false,\n&quot;</span>//&amp;</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;                 <span class="stringliteral">&quot;calculates Kd/TKE and bounds based on exact energetics/n&quot;</span>//&amp;</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;                 <span class="stringliteral">&quot;for an isopycnal layer-formulation.&quot;</span>, &amp;</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;                 default=.false.)</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BRYAN_LEWIS_DIFFUSIVITY&quot;</span>, &amp;</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;                                cs%Bryan_Lewis_diffusivity, &amp;</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;                 <span class="stringliteral">&quot;If true, use a Bryan &amp; Lewis (JGR 1979) like tanh \n&quot;</span>//&amp;</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;                 <span class="stringliteral">&quot;profile of background diapycnal diffusivity with depth.&quot;</span>, &amp;</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;                 default=.false.)</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;  <span class="keywordflow">if</span> (cs%Bryan_Lewis_diffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_BRYAN_LEWIS_DEEP&quot;</span>, &amp;</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;                                  cs%Kd_Bryan_Lewis_deep, &amp;</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;                 <span class="stringliteral">&quot;The abyssal value of a Bryan-Lewis diffusivity profile. \n&quot;</span>//&amp;</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;                 <span class="stringliteral">&quot;KD_BRYAN_LEWIS_DEEP is only used if \n&quot;</span>//&amp;</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;                 <span class="stringliteral">&quot;BRYAN_LEWIS_DIFFUSIVITY is true.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, &amp;</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_BRYAN_LEWIS_SURFACE&quot;</span>, &amp;</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;                                  cs%Kd_Bryan_Lewis_surface, &amp;</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;                 <span class="stringliteral">&quot;The surface value of a Bryan-Lewis diffusivity profile. \n&quot;</span>//&amp;</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;                 <span class="stringliteral">&quot;KD_BRYAN_LEWIS_SURFACE is only used if \n&quot;</span>//&amp;</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;                 <span class="stringliteral">&quot;BRYAN_LEWIS_DIFFUSIVITY is true.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, &amp;</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BRYAN_LEWIS_DEPTH_CENT&quot;</span>, &amp;</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;                                  cs%Bryan_Lewis_depth_cent, &amp;</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;                 <span class="stringliteral">&quot;The depth about which the transition in the Bryan-Lewis \n&quot;</span>//&amp;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;                 <span class="stringliteral">&quot;profile is centered. BRYAN_LEWIS_DEPTH_CENT is only \n&quot;</span>//&amp;</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;                 <span class="stringliteral">&quot;used if BRYAN_LEWIS_DIFFUSIVITY is true.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, &amp;</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BRYAN_LEWIS_WIDTH_TRANS&quot;</span>, &amp;</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;                                  cs%Bryan_Lewis_width_trans, &amp;</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;                 <span class="stringliteral">&quot;The width of the transition in the Bryan-Lewis \n&quot;</span>//&amp;</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;                 <span class="stringliteral">&quot;profile. BRYAN_LEWIS_WIDTH_TRANS is only \n&quot;</span>//&amp;</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;                 <span class="stringliteral">&quot;used if BRYAN_LEWIS_DIFFUSIVITY is true.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, &amp;</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HENYEY_IGW_BACKGROUND&quot;</span>, &amp;</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;                                cs%Henyey_IGW_background, &amp;</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;                 <span class="stringliteral">&quot;If true, use a latitude-dependent scaling for the near \n&quot;</span>//&amp;</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;                 <span class="stringliteral">&quot;surface background diffusivity, as described in \n&quot;</span>//&amp;</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;                 <span class="stringliteral">&quot;Harrison &amp; Hallberg, JPO 2008.&quot;</span>, default=.false.)</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HENYEY_IGW_BACKGROUND_NEW&quot;</span>, &amp;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;                                cs%Henyey_IGW_background_new, &amp;</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;                 <span class="stringliteral">&quot;If true, use a better latitude-dependent scaling for the\n&quot;</span>//&amp;</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;                 <span class="stringliteral">&quot;background diffusivity, as described in \n&quot;</span>//&amp;</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;                 <span class="stringliteral">&quot;Harrison &amp; Hallberg, JPO 2008.&quot;</span>, default=.false.)</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;  <span class="keywordflow">if</span> (cs%Henyey_IGW_background .and. cs%Henyey_IGW_background_new) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;                 <span class="stringliteral">&quot;set_diffusivity_init: HENYEY_IGW_BACKGROUND and HENYEY_IGW_BACKGROUND_NEW &quot;</span>// &amp;</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;                 <span class="stringliteral">&quot;are mutually exclusive. Set only one or none.&quot;</span>)</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;  <span class="keywordflow">if</span> (cs%Henyey_IGW_background) &amp;</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HENYEY_N0_2OMEGA&quot;</span>, cs%N0_2Omega, &amp;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;                  <span class="stringliteral">&quot;The ratio of the typical Buoyancy frequency to twice \n&quot;</span>//&amp;</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;                  <span class="stringliteral">&quot;the Earth&#39;s rotation period, used with the Henyey \n&quot;</span>//&amp;</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;                  <span class="stringliteral">&quot;scaling from the mixing.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=20.0)</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;N2_FLOOR_IOMEGA2&quot;</span>, cs%N2_FLOOR_IOMEGA2, &amp;</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;                  <span class="stringliteral">&quot;The floor applied to N2(k) scaled by Omega^2:\n&quot;</span>//&amp;</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;                  <span class="stringliteral">&quot;\tIf =0., N2(k) is simply positive definite.\n&quot;</span>//&amp;</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;                  <span class="stringliteral">&quot;\tIf =1., N2(k) &gt; Omega^2 everywhere.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;                  default=1.0)</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_TANH_LAT_FN&quot;</span>, &amp;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;                                  cs%Kd_tanh_lat_fn, &amp;</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;                 <span class="stringliteral">&quot;If true, use a tanh dependence of Kd_sfc on latitude, \n&quot;</span>//&amp;</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;                 <span class="stringliteral">&quot;like CM2.1/CM2M.  There is no physical justification \n&quot;</span>//&amp;</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;                 <span class="stringliteral">&quot;for this form, and it can not be used with \n&quot;</span>//&amp;</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;                 <span class="stringliteral">&quot;HENYEY_IGW_BACKGROUND.&quot;</span>, default=.false.)</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;  <span class="keywordflow">if</span> (cs%Kd_tanh_lat_fn) &amp;</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_TANH_LAT_SCALE&quot;</span>, &amp;</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;                                  cs%Kd_tanh_lat_scale, &amp;</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;                 <span class="stringliteral">&quot;A nondimensional scaling for the range ofdiffusivities \n&quot;</span>//&amp;</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;                 <span class="stringliteral">&quot;with KD_TANH_LAT_FN. Valid values are in the range of \n&quot;</span>//&amp;</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;                 <span class="stringliteral">&quot;-2 to 2; 0.4 reproduces CM2M.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KV&quot;</span>, cs%Kv, &amp;</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;                 <span class="stringliteral">&quot;The background kinematic viscosity in the interior. \n&quot;</span>//&amp;</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;                 <span class="stringliteral">&quot;The molecular value, ~1e-6 m2 s-1, may be used.&quot;</span>, &amp;</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD&quot;</span>, cs%Kd, &amp;</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;                 <span class="stringliteral">&quot;The background diapycnal diffusivity of density in the \n&quot;</span>//&amp;</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;                 <span class="stringliteral">&quot;interior. Zero or the molecular value, ~1e-7 m2 s-1, \n&quot;</span>//&amp;</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;                 <span class="stringliteral">&quot;may be used.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_MIN&quot;</span>, cs%Kd_min, &amp;</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;                 <span class="stringliteral">&quot;The minimum diapycnal diffusivity.&quot;</span>, &amp;</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.01*cs%Kd)</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_MAX&quot;</span>, cs%Kd_max, &amp;</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;                 <span class="stringliteral">&quot;The maximum permitted increment for the diapycnal \n&quot;</span>//&amp;</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;                 <span class="stringliteral">&quot;diffusivity from TKE-based parameterizations, or a \n&quot;</span>//&amp;</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;                 <span class="stringliteral">&quot;negative value for no limit.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=-1.0)</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;  <span class="keywordflow">if</span> (cs%simple_TKE_to_Kd .and. cs%Kd_max&lt;=0.) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;         <span class="stringliteral">&quot;set_diffusivity_init: To use SIMPLE_TKE_TO_KD, KD_MAX must be set to &gt;0.&quot;</span>)</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_ADD&quot;</span>, cs%Kd_add, &amp;</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;                 <span class="stringliteral">&quot;A uniform diapycnal diffusivity that is added \n&quot;</span>//&amp;</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;                 <span class="stringliteral">&quot;everywhere without any filtering or scaling.&quot;</span>, &amp;</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;  <span class="keywordflow">if</span> (cs%use_LOTW_BBL_diffusivity .and. cs%Kd_max&lt;=0.) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;                 <span class="stringliteral">&quot;set_diffusivity_init: KD_MAX must be set (positive) when &quot;</span>// &amp;</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;                 <span class="stringliteral">&quot;USE_LOTW_BBL_DIFFUSIVITY=True.&quot;</span>)</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;  <span class="keywordflow">if</span> (cs%bulkmixedlayer) <span class="keywordflow">then</span></div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    <span class="comment">! Check that Kdml is not set when using bulk mixed layer</span></div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KDML&quot;</span>, cs%Kdml, default=-1.)</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;    <span class="keywordflow">if</span> (cs%Kdml&gt;0.) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;                 <span class="stringliteral">&quot;set_diffusivity_init: KDML cannot be set when using&quot;</span>// &amp;</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;                 <span class="stringliteral">&quot;bulk mixed layer.&quot;</span>)</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;    cs%Kdml = cs%Kd <span class="comment">! This is not used with a bulk mixed layer, but also</span></div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;                    <span class="comment">! cannot be a NaN.</span></div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KDML&quot;</span>, cs%Kdml, &amp;</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;                 <span class="stringliteral">&quot;If BULKMIXEDLAYER is false, KDML is the elevated \n&quot;</span>//&amp;</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;                 <span class="stringliteral">&quot;diapycnal diffusivity in the topmost HMIX of fluid. \n&quot;</span>//&amp;</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;                 <span class="stringliteral">&quot;KDML is only used if BULKMIXEDLAYER is false.&quot;</span>, &amp;</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=cs%Kd)</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HMIX_FIXED&quot;</span>, cs%Hmix, &amp;</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;                 <span class="stringliteral">&quot;The prescribed depth over which the near-surface \n&quot;</span>//&amp;</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;                 <span class="stringliteral">&quot;viscosity and diffusivity are elevated when the bulk \n&quot;</span>//&amp;</div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;                 <span class="stringliteral">&quot;mixed layer is not used.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, &amp;</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;                 <span class="stringliteral">&quot;If true, write out verbose debugging data.&quot;</span>, default=.false.)</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_DISSIPATION&quot;</span>, cs%Int_tide_dissipation, &amp;</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;                 <span class="stringliteral">&quot;If true, use an internal tidal dissipation scheme to \n&quot;</span>//&amp;</div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of St. Laurent \n&quot;</span>//&amp;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;                 <span class="stringliteral">&quot;et al. (2002) and Simmons et al. (2004).&quot;</span>, default=.false.)</div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_PROFILE&quot;</span>, tmpstr, &amp;</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;                 <span class="stringliteral">&quot;INT_TIDE_PROFILE selects the vertical profile of energy \n&quot;</span>//&amp;</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;                 <span class="stringliteral">&quot;dissipation with INT_TIDE_DISSIPATION. Valid values are:\n&quot;</span>//&amp;</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;                 <span class="stringliteral">&quot;\t STLAURENT_02 - Use the St. Laurent et al exponential \n&quot;</span>//&amp;</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.\n&quot;</span>//&amp;</div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;                 <span class="stringliteral">&quot;\t POLZIN_09 - Use the Polzin WKB-streched algebraic \n&quot;</span>//&amp;</div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.&quot;</span>, &amp;</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;                 default=stlaurent_profile_string)</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    tmpstr = uppercase(tmpstr)</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;    <span class="keywordflow">select case</span> (tmpstr)</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;      <span class="keywordflow">case</span> (stlaurent_profile_string) ; cs%int_tide_profile = stlaurent_02</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;      <span class="keywordflow">case</span> (polzin_profile_string) ; cs%int_tide_profile = polzin_09</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;<span class="keywordflow">      case default</span></div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;set_diffusivity_init: Unrecognized setting &quot;</span>// &amp;</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;            <span class="stringliteral">&quot;#define INT_TIDE_PROFILE &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;<span class="keywordflow">    end select</span></div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEE_WAVE_DISSIPATION&quot;</span>, cs%Lee_wave_dissipation, &amp;</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;                 <span class="stringliteral">&quot;If true, use an lee wave driven dissipation scheme to \n&quot;</span>//&amp;</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of Nikurashin \n&quot;</span>//&amp;</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;                 <span class="stringliteral">&quot;(2010) and using the St. Laurent et al. (2002) \n&quot;</span>//&amp;</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;                 <span class="stringliteral">&quot;and Simmons et al. (2004) vertical profile&quot;</span>, default=.false.)</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  <span class="keywordflow">if</span> (cs%lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEE_WAVE_PROFILE&quot;</span>, tmpstr, &amp;</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;                 <span class="stringliteral">&quot;LEE_WAVE_PROFILE selects the vertical profile of energy \n&quot;</span>//&amp;</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;                 <span class="stringliteral">&quot;dissipation with LEE_WAVE_DISSIPATION. Valid values are:\n&quot;</span>//&amp;</div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;                 <span class="stringliteral">&quot;\t STLAURENT_02 - Use the St. Laurent et al exponential \n&quot;</span>//&amp;</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.\n&quot;</span>//&amp;</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;                 <span class="stringliteral">&quot;\t POLZIN_09 - Use the Polzin WKB-streched algebraic \n&quot;</span>//&amp;</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;                 <span class="stringliteral">&quot;\t                decay profile.&quot;</span>, &amp;</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;                 default=stlaurent_profile_string)</div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;    tmpstr = uppercase(tmpstr)</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;    <span class="keywordflow">select case</span> (tmpstr)</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;      <span class="keywordflow">case</span> (stlaurent_profile_string) ; cs%lee_wave_profile = stlaurent_02</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;      <span class="keywordflow">case</span> (polzin_profile_string) ; cs%lee_wave_profile = polzin_09</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;<span class="keywordflow">      case default</span></div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;set_diffusivity_init: Unrecognized setting &quot;</span>// &amp;</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;            <span class="stringliteral">&quot;#define LEE_WAVE_PROFILE &quot;</span>//trim(tmpstr)//<span class="stringliteral">&quot; found in input file.&quot;</span>)</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;<span class="keywordflow">    end select</span></div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_LOWMODE_DISSIPATION&quot;</span>, cs%Lowmode_itidal_dissipation, &amp;</div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;                 <span class="stringliteral">&quot;If true, consider mixing due to breaking low modes that \n&quot;</span>//&amp;</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;                 <span class="stringliteral">&quot;have been remotely generated; as with itidal drag on the \n&quot;</span>//&amp;</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;                 <span class="stringliteral">&quot;barotropic tide, use an internal tidal dissipation scheme to \n&quot;</span>//&amp;</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;                 <span class="stringliteral">&quot;drive diapycnal mixing, along the lines of St. Laurent \n&quot;</span>//&amp;</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;                 <span class="stringliteral">&quot;et al. (2002) and Simmons et al. (2004).&quot;</span>, default=.false.)</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;  <span class="keywordflow">if</span> ((cs%Int_tide_dissipation .and. (cs%int_tide_profile == polzin_09)) .or. &amp;</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;      (cs%lee_wave_dissipation .and. (cs%lee_wave_profile == polzin_09))) <span class="keywordflow">then</span></div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NU_POLZIN&quot;</span>, cs%Nu_Polzin, &amp;</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a \n&quot;</span>//&amp;</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;                 <span class="stringliteral">&quot;non-dimensional constant in the expression for the \n&quot;</span>//&amp;</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;                 <span class="stringliteral">&quot;vertical scale of decay for the tidal energy dissipation.&quot;</span>, &amp;</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0697)</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NBOTREF_POLZIN&quot;</span>, cs%Nbotref_Polzin, &amp;</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is the \n&quot;</span>//&amp;</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;                 <span class="stringliteral">&quot;Rreference value of the buoyancy frequency at the ocean \n&quot;</span>//&amp;</div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;                 <span class="stringliteral">&quot;bottom in the Polzin formulation for the vertical \n&quot;</span>//&amp;</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;                 <span class="stringliteral">&quot;scale of decay for the tidal energy dissipation.&quot;</span>, &amp;</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;                 units=<span class="stringliteral">&quot;s-1&quot;</span>, default=9.61e-4)</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_DECAY_SCALE_FACTOR&quot;</span>, &amp;</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;                 cs%Polzin_decay_scale_factor, &amp;</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a \n&quot;</span>//&amp;</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;                 <span class="stringliteral">&quot;scale factor for the vertical scale of decay of the tidal \n&quot;</span>//&amp;</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;                 <span class="stringliteral">&quot;energy dissipation.&quot;</span>, default=1.0, units=<span class="stringliteral">&quot;nondim&quot;</span>)</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_SCALE_MAX_FACTOR&quot;</span>, &amp;</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;                 cs%Polzin_decay_scale_max_factor, &amp;</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is a factor \n&quot;</span>//&amp;</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;                 <span class="stringliteral">&quot;to limit the vertical scale of decay of the tidal \n&quot;</span>//&amp;</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;                 <span class="stringliteral">&quot;energy dissipation to POLZIN_DECAY_SCALE_MAX_FACTOR \n&quot;</span>//&amp;</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;                 <span class="stringliteral">&quot;times the depth of the ocean.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;POLZIN_MIN_DECAY_SCALE&quot;</span>, cs%Polzin_min_decay_scale, &amp;</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;                 <span class="stringliteral">&quot;When the Polzin decay profile is used, this is the \n&quot;</span>//&amp;</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;                 <span class="stringliteral">&quot;minimum vertical decay scale for the vertical profile\n&quot;</span>//&amp;</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;                 <span class="stringliteral">&quot;of internal tide dissipation with the Polzin (2009) formulation&quot;</span>, &amp;</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USER_CHANGE_DIFFUSIVITY&quot;</span>, cs%user_change_diff, &amp;</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;                 <span class="stringliteral">&quot;If true, call user-defined code to change the diffusivity.&quot;</span>, &amp;</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;                 default=.false.)</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DISSIPATION_MIN&quot;</span>, cs%dissip_min, &amp;</div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;                 <span class="stringliteral">&quot;The minimum dissipation by which to determine a lower \n&quot;</span>//&amp;</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;                 <span class="stringliteral">&quot;bound of Kd (a floor).&quot;</span>, units=<span class="stringliteral">&quot;W m-3&quot;</span>, default=0.0)</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DISSIPATION_N0&quot;</span>, cs%dissip_N0, &amp;</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;                 <span class="stringliteral">&quot;The intercept when N=0 of the N-dependent expression \n&quot;</span>//&amp;</div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;                 <span class="stringliteral">&quot;used to set a minimum dissipation by which to determine \n&quot;</span>//&amp;</div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;                 <span class="stringliteral">&quot;a lower bound of Kd (a floor): A in eps_min = A + B*N.&quot;</span>, &amp;</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;                 units=<span class="stringliteral">&quot;W m-3&quot;</span>, default=0.0)</div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DISSIPATION_N1&quot;</span>, cs%dissip_N1, &amp;</div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;                 <span class="stringliteral">&quot;The coefficient multiplying N, following Gargett, used to \n&quot;</span>//&amp;</div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;                 <span class="stringliteral">&quot;set a minimum dissipation by which to determine a lower \n&quot;</span>//&amp;</div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;                 <span class="stringliteral">&quot;bound of Kd (a floor): B in eps_min = A + B*N&quot;</span>, &amp;</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;                 units=<span class="stringliteral">&quot;J m-3&quot;</span>, default=0.0)</div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DISSIPATION_KD_MIN&quot;</span>, cs%dissip_Kd_min, &amp;</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;                 <span class="stringliteral">&quot;The minimum vertical diffusivity applied as a floor.&quot;</span>, &amp;</div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;  cs%limit_dissipation = (cs%dissip_min&gt;0.) .or. (cs%dissip_N1&gt;0.) .or. &amp;</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;                         (cs%dissip_N0&gt;0.) .or. (cs%dissip_Kd_min&gt;0.)</div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;  cs%dissip_N2 = 0.0</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;  <span class="keywordflow">if</span> (cs%FluxRi_max &gt; 0.0) &amp;</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;    cs%dissip_N2 = cs%dissip_Kd_min * gv%Rho0 / cs%FluxRi_max</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INT_TIDE_DECAY_SCALE&quot;</span>, cs%Int_tide_decay_scale, &amp;</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;                 <span class="stringliteral">&quot;The decay scale away from the bottom for tidal TKE with \n&quot;</span>//&amp;</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;                 <span class="stringliteral">&quot;the new coding when INT_TIDE_DISSIPATION is used.&quot;</span>, &amp;</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MU_ITIDES&quot;</span>, cs%Mu_itides, &amp;</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;                 <span class="stringliteral">&quot;A dimensionless turbulent mixing efficiency used with \n&quot;</span>//&amp;</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;                 <span class="stringliteral">&quot;INT_TIDE_DISSIPATION, often 0.2.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GAMMA_ITIDES&quot;</span>, cs%Gamma_itides, &amp;</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;                 <span class="stringliteral">&quot;The fraction of the internal tidal energy that is \n&quot;</span>//&amp;</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;                 <span class="stringliteral">&quot;dissipated locally with INT_TIDE_DISSIPATION.  \n&quot;</span>//&amp;</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;                 <span class="stringliteral">&quot;THIS NAME COULD BE BETTER.&quot;</span>, &amp;</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.3333)</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIN_ZBOT_ITIDES&quot;</span>, cs%min_zbot_itides, &amp;</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;                 <span class="stringliteral">&quot;Turn off internal tidal dissipation when the total \n&quot;</span>//&amp;</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;                 <span class="stringliteral">&quot;ocean depth is less than this value.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%Nb,isd,ied,jsd,jed)</div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%h2,isd,ied,jsd,jed)</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%TKE_itidal,isd,ied,jsd,jed)</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%mask_itidal,isd,ied,jsd,jed) ; cs%mask_itidal(:,:) = 1.0</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_ITIDES&quot;</span>, cs%kappa_itides, &amp;</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;                 <span class="stringliteral">&quot;A topographic wavenumber used with INT_TIDE_DISSIPATION. \n&quot;</span>//&amp;</div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;                 <span class="stringliteral">&quot;The default is 2pi/10 km, as in St.Laurent et al. 2002.&quot;</span>, &amp;</div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;                 units=<span class="stringliteral">&quot;m-1&quot;</span>, default=8.e-4*atan(1.0))</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;UTIDE&quot;</span>, cs%utide, &amp;</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;                 <span class="stringliteral">&quot;The constant tidal amplitude used with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%tideamp,is,ie,js,je) ; cs%tideamp(:,:) = cs%utide</div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;</div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KAPPA_H2_FACTOR&quot;</span>, cs%kappa_h2_factor, &amp;</div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;                 <span class="stringliteral">&quot;A scaling factor for the roughness amplitude with n&quot;</span>//&amp;</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;                 <span class="stringliteral">&quot;INT_TIDE_DISSIPATION.&quot;</span>,  units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_ITIDE_MAX&quot;</span>, cs%TKE_itide_max, &amp;</div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;                 <span class="stringliteral">&quot;The maximum internal tide energy source availble to mix \n&quot;</span>//&amp;</div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;                 <span class="stringliteral">&quot;above the bottom boundary layer with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;                 units=<span class="stringliteral">&quot;W m-2&quot;</span>,  default=1.0e3)</div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;</div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_TIDEAMP&quot;</span>, read_tideamp, &amp;</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;                 <span class="stringliteral">&quot;If true, read a file (given by TIDEAMP_FILE) containing \n&quot;</span>//&amp;</div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;                 <span class="stringliteral">&quot;the tidal amplitude with INT_TIDE_DISSIPATION.&quot;</span>, default=.false.)</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;    <span class="keywordflow">if</span> (read_tideamp) <span class="keywordflow">then</span></div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIDEAMP_FILE&quot;</span>, tideamp_file, &amp;</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the spatially varying \n&quot;</span>//&amp;</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;                 <span class="stringliteral">&quot;tidal amplitudes with INT_TIDE_DISSIPATION.&quot;</span>, default=<span class="stringliteral">&quot;tideamp.nc&quot;</span>)</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;      filename = trim(cs%inputdir) // trim(tideamp_file)</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;      <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/TIDEAMP_FILE&quot;</span>, filename)</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;      <span class="keyword">call </span>read_data(filename, <span class="stringliteral">&#39;tideamp&#39;</span>, cs%tideamp, &amp;</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;                     domain=g%domain%mpp_domain, timelevel=1)</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;H2_FILE&quot;</span>, h2_file, &amp;</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the sub-grid-scale \n&quot;</span>//&amp;</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;                 <span class="stringliteral">&quot;topographic roughness amplitude with INT_TIDE_DISSIPATION.&quot;</span>, &amp;</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;    filename = trim(cs%inputdir) // trim(h2_file)</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/H2_FILE&quot;</span>, filename)</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;    <span class="keyword">call </span>read_data(filename, <span class="stringliteral">&#39;h2&#39;</span>, cs%h2, domain=g%domain%mpp_domain, &amp;</div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;                   timelevel=1)</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;      <span class="keywordflow">if</span> (g%bathyT(i,j) &lt; cs%min_zbot_itides) cs%mask_itidal(i,j) = 0.0</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;      cs%tideamp(i,j) = cs%tideamp(i,j) * cs%mask_itidal(i,j) * g%mask2dT(i,j)</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;      <span class="comment">! Restrict rms topo to 10 percent of column depth.</span></div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;      zbot = g%bathyT(i,j)</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;      hamp = sqrt(cs%h2(i,j))</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;      hamp = min(0.1*zbot,hamp)</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;      cs%h2(i,j) = hamp*hamp</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;      utide = cs%tideamp(i,j)</div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;      <span class="comment">! Compute the fixed part of internal tidal forcing; units are [kg s-2] here.</span></div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;      cs%TKE_itidal(i,j) = 0.5*cs%kappa_h2_factor*gv%Rho0*&amp;</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;           cs%kappa_itides*cs%h2(i,j)*utide*utide</div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;<span class="keyword">    end</span>do; enddo</div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;  cs%id_Kd_layer = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Kd_layer&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;      <span class="stringliteral">&#39;Diapycnal diffusivity of layers (as set)&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;  <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;</div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NIKURASHIN_TKE_INPUT_FILE&quot;</span>,niku_tke_input_file, &amp;</div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;                 <span class="stringliteral">&quot;The path to the file containing the TKE input from lee \n&quot;</span>//&amp;</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;                 <span class="stringliteral">&quot;wave driven mixing. Used with LEE_WAVE_DISSIPATION.&quot;</span>, &amp;</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NIKURASHIN_SCALE&quot;</span>,niku_scale, &amp;</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;                 <span class="stringliteral">&quot;A non-dimensional factor by which to scale the lee-wave \n&quot;</span>//&amp;</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;                 <span class="stringliteral">&quot;driven TKE input. Used with LEE_WAVE_DISSIPATION.&quot;</span>, &amp;</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    filename = trim(cs%inputdir) // trim(niku_tke_input_file)</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR/NIKURASHIN_TKE_INPUT_FILE&quot;</span>, &amp;</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;                   filename)</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    <span class="keyword">call </span>safe_alloc_ptr(cs%TKE_Niku,is,ie,js,je); cs%TKE_Niku(:,:) = 0.0</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;    <span class="keyword">call </span>read_data(filename, <span class="stringliteral">&#39;TKE_input&#39;</span>, cs%TKE_Niku, &amp;</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;                   domain=g%domain%mpp_domain, timelevel=1 ) <span class="comment">! ??? timelevel -aja</span></div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;    cs%TKE_Niku(:,:) = niku_scale * cs%TKE_Niku(:,:)</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GAMMA_NIKURASHIN&quot;</span>,cs%Gamma_lee, &amp;</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;                 <span class="stringliteral">&quot;The fraction of the lee wave energy that is dissipated \n&quot;</span>//&amp;</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;                 <span class="stringliteral">&quot;locally with LEE_WAVE_DISSIPATION.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;                 default=0.3333)</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DECAY_SCALE_FACTOR_LEE&quot;</span>,cs%Decay_scale_factor_lee, &amp;</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;                 <span class="stringliteral">&quot;Scaling for the vertical decay scaleof the local \n&quot;</span>//&amp;</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;                 <span class="stringliteral">&quot;dissipation of lee waves dissipation.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;                 default=1.0)</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;    cs%id_TKE_leewave = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_leewave&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;        <span class="stringliteral">&#39;Lee wave Driven Turbulent Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    cs%id_Kd_Niku = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Nikurashin&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;         <span class="stringliteral">&#39;Lee Wave Driven Diffusivity&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;    cs%Decay_scale_factor_lee = -9.e99 <span class="comment">! This should never be used if CS%Lee_wave_dissipation = False</span></div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;</div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .or. cs%Lee_wave_dissipation .or. &amp;</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;      cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;    cs%id_TKE_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_itidal&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;        <span class="stringliteral">&#39;Internal Tide Driven Turbulent Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;    cs%id_maxTKE = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;maxTKE&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;           <span class="stringliteral">&#39;Maximum layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;    cs%id_TKE_to_Kd = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;TKE_to_Kd&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;           <span class="stringliteral">&#39;Convert TKE to Kd&#39;</span>, <span class="stringliteral">&#39;second2 meter&#39;</span>)</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;    cs%id_Nb = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Nb&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;         <span class="stringliteral">&#39;Bottom Buoyancy Frequency&#39;</span>, <span class="stringliteral">&#39;sec-1&#39;</span>)</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    cs%id_Kd_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_itides&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;         <span class="stringliteral">&#39;Internal Tide Driven Diffusivity&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    cs%id_Kd_lowmode = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_lowmode&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;         <span class="stringliteral">&#39;Internal Tide Driven Diffusivity (from propagating low modes)&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;</div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;    cs%id_Fl_itidal = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Fl_itides&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;        <span class="stringliteral">&#39;Vertical flux of tidal turbulent dissipation&#39;</span>, <span class="stringliteral">&#39;meter3 sec-3&#39;</span>)</div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;</div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;    cs%id_Fl_lowmode = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Fl_lowmode&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;         <span class="stringliteral">&#39;Vertical flux of tidal turbulent dissipation (from propagating low modes)&#39;</span>, <span class="stringliteral">&#39;meter3 sec-3&#39;</span>)</div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;</div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;    cs%id_Polzin_decay_scale = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Polzin_decay_scale&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;         <span class="stringliteral">&#39;Vertical decay scale for the tidal turbulent dissipation with Polzin scheme&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;</div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;    cs%id_Polzin_decay_scale_scaled = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Polzin_decay_scale_scaled&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;         <span class="stringliteral">&#39;Vertical decay scale for the tidal turbulent dissipation with Polzin scheme, scaled by N2_bot/N2_meanz&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;</div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;    cs%id_N2_bot = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2_b&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;         <span class="stringliteral">&#39;Bottom Buoyancy frequency squared&#39;</span>, <span class="stringliteral">&#39;s-2&#39;</span>)</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;    cs%id_N2_meanz = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2_meanz&#39;</span>,diag%axesT1,time, &amp;</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;         <span class="stringliteral">&#39;Buoyancy frequency squared averaged over the water column&#39;</span>, <span class="stringliteral">&#39;s-2&#39;</span>)</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    cs%id_Kd_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Work&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;         <span class="stringliteral">&#39;Work done by Diapycnal Mixing&#39;</span>, <span class="stringliteral">&#39;Watts m-2&#39;</span>)</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;    cs%id_Kd_Itidal_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Itidal_Work&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;         <span class="stringliteral">&#39;Work done by Internal Tide Diapycnal Mixing&#39;</span>, <span class="stringliteral">&#39;Watts m-2&#39;</span>)</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    cs%id_Kd_Niku_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Nikurashin_Work&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;         <span class="stringliteral">&#39;Work done by Nikurashin Lee Wave Drag Scheme&#39;</span>, <span class="stringliteral">&#39;Watts m-2&#39;</span>)</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;    cs%id_Kd_Lowmode_Work = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_Lowmode_Work&#39;</span>,diag%axesTL,time, &amp;</div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;         <span class="stringliteral">&#39;Work done by Internal Tide Diapycnal Mixing (low modes)&#39;</span>, <span class="stringliteral">&#39;Watts m-2&#39;</span>)</div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;    cs%id_N2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;N2&#39;</span>,diag%axesTi,time,            &amp;</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;         <span class="stringliteral">&#39;Buoyancy frequency squared&#39;</span>, <span class="stringliteral">&#39;sec-2&#39;</span>, cmor_field_name=<span class="stringliteral">&#39;obvfsq&#39;</span>,          &amp;</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;          cmor_units=<span class="stringliteral">&#39;s-2&#39;</span>, cmor_long_name=<span class="stringliteral">&#39;Square of seawater buoyancy frequency&#39;</span>,&amp;</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;          cmor_standard_name=<span class="stringliteral">&#39;square_of_brunt_vaisala_frequency_in_sea_water&#39;</span>)</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;    <span class="keywordflow">if</span> (cs%user_change_diff) &amp;</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;      cs%id_Kd_user = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;Kd_user&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;           <span class="stringliteral">&#39;User-specified Extra Diffusivity&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(diag_to_z_csp)) <span class="keywordflow">then</span></div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;      vd = var_desc(<span class="stringliteral">&quot;N2&quot;</span>, <span class="stringliteral">&quot;second-2&quot;</span>,&amp;</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;                    <span class="stringliteral">&quot;Buoyancy frequency, interpolated to z&quot;</span>, z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;      cs%id_N2_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;      vd = var_desc(<span class="stringliteral">&quot;Kd_itides&quot;</span>,<span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;                    <span class="stringliteral">&quot;Internal Tide Driven Diffusivity, interpolated to z&quot;</span>, z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;      cs%id_Kd_itidal_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;      <span class="keywordflow">if</span> (cs%Lee_wave_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;         vd = var_desc(<span class="stringliteral">&quot;Kd_Nikurashin&quot;</span>, <span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;                       <span class="stringliteral">&quot;Lee Wave Driven Diffusivity, interpolated to z&quot;</span>, z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;         cs%id_Kd_Niku_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;      <span class="keywordflow">if</span> (cs%Lowmode_itidal_dissipation) <span class="keywordflow">then</span></div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;        vd = var_desc(<span class="stringliteral">&quot;Kd_lowmode&quot;</span>,<span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;                  <span class="stringliteral">&quot;Internal Tide Driven Diffusivity (from low modes), interpolated to z&quot;</span>,&amp;</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;                  z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;        cs%id_Kd_lowmode_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;      <span class="keywordflow">if</span> (cs%user_change_diff) &amp;</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;        cs%id_Kd_user_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DOUBLE_DIFFUSION&quot;</span>, cs%double_diffusion, &amp;</div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;                 <span class="stringliteral">&quot;If true, increase diffusivitives for temperature or salt \n&quot;</span>//&amp;</div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;                 <span class="stringliteral">&quot;based on double-diffusive paramaterization from MOM4/KPP.&quot;</span>, &amp;</div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;                 default=.false.)</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;  <span class="keywordflow">if</span> (cs%double_diffusion) <span class="keywordflow">then</span></div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_RRHO_SALT_FINGERS&quot;</span>, cs%Max_Rrho_salt_fingers, &amp;</div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;                 <span class="stringliteral">&quot;Maximum density ratio for salt fingering regime.&quot;</span>, &amp;</div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;                 default=2.55, units=<span class="stringliteral">&quot;nondim&quot;</span>)</div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_SALT_DIFF_SALT_FINGERS&quot;</span>, cs%Max_salt_diff_salt_fingers, &amp;</div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;                 <span class="stringliteral">&quot;Maximum salt diffusivity for salt fingering regime.&quot;</span>, &amp;</div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;                 default=1.e-4, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>)</div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KV_MOLECULAR&quot;</span>, cs%Kv_molecular, &amp;</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;                 <span class="stringliteral">&quot;Molecular viscosity for calculation of fluxes under \n&quot;</span>//&amp;</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;                 <span class="stringliteral">&quot;double-diffusive convection.&quot;</span>, default=1.5e-6, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>)</div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;    <span class="comment">! The default molecular viscosity follows the CCSM4.0 and MOM4p1 defaults.</span></div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;    cs%id_KT_extra = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;KT_extra&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;         <span class="stringliteral">&#39;Double-diffusive diffusivity for temperature&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;    cs%id_KS_extra = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;KS_extra&#39;</span>,diag%axesTi,time, &amp;</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;         <span class="stringliteral">&#39;Double-diffusive diffusivity for salinity&#39;</span>, <span class="stringliteral">&#39;meter2 sec-1&#39;</span>)</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(diag_to_z_csp)) <span class="keywordflow">then</span></div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;      vd = var_desc(<span class="stringliteral">&quot;KT_extra&quot;</span>, <span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;                    <span class="stringliteral">&quot;Double-Diffusive Temperature Diffusivity, interpolated to z&quot;</span>, &amp;</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;                    z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;      cs%id_KT_extra_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;      vd = var_desc(<span class="stringliteral">&quot;KS_extra&quot;</span>, <span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;                    <span class="stringliteral">&quot;Double-Diffusive Salinity Diffusivity, interpolated to z&quot;</span>,&amp;</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;                    z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;      cs%id_KS_extra_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;      vd = var_desc(<span class="stringliteral">&quot;Kd_BBL&quot;</span>, <span class="stringliteral">&quot;meter2 second-1&quot;</span>, &amp;</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;                    <span class="stringliteral">&quot;Bottom Boundary Layer Diffusivity&quot;</span>, z_grid=<span class="stringliteral">&#39;z&#39;</span>)</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;      cs%id_Kd_BBL_z = register_zint_diag(vd, cs%diag_to_Z_CSp, time)</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;</div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;  <span class="keywordflow">if</span> (cs%Int_tide_dissipation .and. cs%Bryan_Lewis_diffusivity) &amp;</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;    <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;MOM_Set_Diffusivity: &quot;</span>// &amp;</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;         <span class="stringliteral">&quot;Bryan-Lewis and internal tidal dissipation are both enabled. Choose one.&quot;</span>)</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;  <span class="keywordflow">if</span> (cs%Henyey_IGW_background .and. cs%Kd_tanh_lat_fn) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;    <span class="stringliteral">&quot;Set_diffusivity: KD_TANH_LAT_FN can not be used with HENYEY_IGW_BACKGROUND.&quot;</span>)</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;</div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;  <span class="keywordflow">if</span> (cs%user_change_diff) <span class="keywordflow">then</span></div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;    <span class="keyword">call </span>user_change_diff_init(time, g, param_file, diag, cs%user_change_diff_CSp)</div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;  cs%useKappaShear = kappa_shear_init(time, g, gv, param_file, cs%diag, cs%kappaShear_CSp)</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;  <span class="keywordflow">if</span> (cs%useKappaShear) &amp;</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;    id_clock_kappashear = cpu_clock_id(<span class="stringliteral">&#39;(Ocean kappa_shear)&#39;</span>, grain=clock_module)</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;  cs%useCVMix = cvmix_shear_init(time, g, gv, param_file, cs%diag, cs%CVMix_shear_CSp)</div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;</div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a6b2144f31cb69fe2481815545253d7c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b2144f31cb69fe2481815545253d7c9">&#9670;&nbsp;</a></span>id_clock_kappashear</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_set_diffusivity::id_clock_kappashear</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00367">367</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00373">set_diffusivity()</a>, and <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">set_diffusivity_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="keywordtype">integer</span> :: id_clock_kappashear</div></div><!-- fragment -->
</div>
</div>
<a id="ad5f2d1a5a67a348fcc175baf848204e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad5f2d1a5a67a348fcc175baf848204e7">&#9670;&nbsp;</a></span>polzin_09</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_set_diffusivity::polzin_09 = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00364">364</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01921">add_int_tide_diffusivity()</a>, and <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">set_diffusivity_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: polzin_09    = 2</div></div><!-- fragment -->
</div>
</div>
<a id="a3aa76d970d677e933cbb9136e1d289f4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3aa76d970d677e933cbb9136e1d289f4">&#9670;&nbsp;</a></span>polzin_profile_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_set_diffusivity::polzin_profile_string = &quot;POLZIN_09&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00362">362</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">set_diffusivity_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">character*(20), parameter :: POLZIN_PROFILE_STRING = &quot;POLZIN_09&quot;</span></div></div><!-- fragment -->
</div>
</div>
<a id="a20f73bebea2d715292b7297239260127"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a20f73bebea2d715292b7297239260127">&#9670;&nbsp;</a></span>stlaurent_02</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_set_diffusivity::stlaurent_02 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00363">363</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l01921">add_int_tide_diffusivity()</a>, and <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">set_diffusivity_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keywordtype">integer</span>,        <span class="keywordtype">parameter</span> :: stlaurent_02 = 1</div></div><!-- fragment -->
</div>
</div>
<a id="a80f458341a9ec8a2f451e35a3ea1612a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a80f458341a9ec8a2f451e35a3ea1612a">&#9670;&nbsp;</a></span>stlaurent_profile_string</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>*(20), parameter mom_set_diffusivity::stlaurent_profile_string = &quot;STLAURENT_02&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__set__diffusivity_8F90_source.html#l00361">361</a> of file <a class="el" href="MOM__set__diffusivity_8F90_source.html">MOM_set_diffusivity.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__set__diffusivity_8F90_source.html#l02555">set_diffusivity_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">character*(20), parameter :: STLAURENT_PROFILE_STRING = &quot;STLAURENT_02&quot;</span></div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__set__diffusivity.html">mom_set_diffusivity</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
