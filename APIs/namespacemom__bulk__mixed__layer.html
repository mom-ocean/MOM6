<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_bulk_mixed_layer Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__bulk__mixed__layer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_bulk_mixed_layer Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:af4ea9156c3759dd0328f0f994fe64e71"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#af4ea9156c3759dd0328f0f994fe64e71">bulkmixedlayer</a> (h_3d, u_3d, v_3d, tv, fluxes, dt, ea, eb, G, GV, CS, optics, Hml, aggregate_FW_forcing, dt_diag, last_call)</td></tr>
<tr class="memdesc:af4ea9156c3759dd0328f0f994fe64e71"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine partially steps the bulk mixed layer model. The following processes are executed, in the order listed.  <a href="#af4ea9156c3759dd0328f0f994fe64e71">More...</a><br /></td></tr>
<tr class="separator:af4ea9156c3759dd0328f0f994fe64e71"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac898a46c7996492a4cd3ee45ebfd1b2e"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#ac898a46c7996492a4cd3ee45ebfd1b2e">convective_adjustment</a> (h, u, v, R0, Rcv, T, S, eps, d_eb, dKE_CA, cTKE, j, G, GV, CS, nz_conv)</td></tr>
<tr class="memdesc:ac898a46c7996492a4cd3ee45ebfd1b2e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does instantaneous convective entrainment into the buffer layers and mixed layers to remove hydrostatic instabilities. Any water that is lighter than currently in the mixed- or buffer- layer is entrained.  <a href="#ac898a46c7996492a4cd3ee45ebfd1b2e">More...</a><br /></td></tr>
<tr class="separator:ac898a46c7996492a4cd3ee45ebfd1b2e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a071010a461d5ae9440b063aadf4e2f88"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a071010a461d5ae9440b063aadf4e2f88">mixedlayer_convection</a> (h, d_eb, htot, Ttot, Stot, uhtot, vhtot, R0_tot, Rcv_tot, u, v, T, S, R0, Rcv, eps, dR0_dT, dRcv_dT, dR0_dS, dRcv_dS, netMassInOut, netMassOut, Net_heat, Net_salt, nsw, Pen_SW_bnd, opacity_band, Conv_en, dKE_FC, j, ksort, G, GV, CS, tv, fluxes, dt, aggregate_FW_forcing)</td></tr>
<tr class="memdesc:a071010a461d5ae9440b063aadf4e2f88"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine causes the mixed layer to entrain to the depth of free convection. The depth of free convection is the shallowest depth at which the fluid is denser than the average of the fluid above.  <a href="#a071010a461d5ae9440b063aadf4e2f88">More...</a><br /></td></tr>
<tr class="separator:a071010a461d5ae9440b063aadf4e2f88"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a665aff6a1571290883752364eb5aa129"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a665aff6a1571290883752364eb5aa129">find_starting_tke</a> (htot, h_CA, fluxes, Conv_En, cTKE, dKE_FC, dKE_CA, TKE, TKE_river, Idecay_len_TKE, cMKE, dt, Idt_diag, j, ksort, G, GV, CS)</td></tr>
<tr class="memdesc:a665aff6a1571290883752364eb5aa129"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine determines the TKE available at the depth of free convection to drive mechanical entrainment.  <a href="#a665aff6a1571290883752364eb5aa129">More...</a><br /></td></tr>
<tr class="separator:a665aff6a1571290883752364eb5aa129"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18320524267554e0417f02af24ede6c3"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a18320524267554e0417f02af24ede6c3">mechanical_entrainment</a> (h, d_eb, htot, Ttot, Stot, uhtot, vhtot, R0_tot, Rcv_tot, u, v, T, S, R0, Rcv, eps, dR0_dT, dRcv_dT, cMKE, Idt_diag, nsw, Pen_SW_bnd, opacity_band, TKE, Idecay_len_TKE, j, ksort, G, GV, CS)</td></tr>
<tr class="memdesc:a18320524267554e0417f02af24ede6c3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates mechanically driven entrainment.  <a href="#a18320524267554e0417f02af24ede6c3">More...</a><br /></td></tr>
<tr class="separator:a18320524267554e0417f02af24ede6c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae4325155d260533b923ba910557945f3"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#ae4325155d260533b923ba910557945f3">sort_ml</a> (h, R0, eps, G, GV, CS, ksort)</td></tr>
<tr class="memdesc:ae4325155d260533b923ba910557945f3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine generates an array of indices that are sorted by layer density.  <a href="#ae4325155d260533b923ba910557945f3">More...</a><br /></td></tr>
<tr class="separator:ae4325155d260533b923ba910557945f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1378659bc97b52e065a7cfe44166504d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a1378659bc97b52e065a7cfe44166504d">resort_ml</a> (h, T, S, R0, Rcv, RcvTgt, eps, d_ea, d_eb, ksort, G, GV, CS, dR0_dT, dR0_dS, dRcv_dT, dRcv_dS)</td></tr>
<tr class="memdesc:a1378659bc97b52e065a7cfe44166504d"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine actually moves properties between layers to achieve a resorted state, with all of the resorted water either moved into the correct interior layers or in the top nkmb layers.  <a href="#a1378659bc97b52e065a7cfe44166504d">More...</a><br /></td></tr>
<tr class="separator:a1378659bc97b52e065a7cfe44166504d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a46fd0f8d6109e0d4f7e4da971f2ab663"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a46fd0f8d6109e0d4f7e4da971f2ab663">mixedlayer_detrain_2</a> (h, T, S, R0, Rcv, RcvTgt, dt, dt_diag, d_ea, j, G, GV, CS, dR0_dT, dR0_dS, dRcv_dT, dRcv_dS, max_BL_det)</td></tr>
<tr class="memdesc:a46fd0f8d6109e0d4f7e4da971f2ab663"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine moves any water left in the former mixed layers into the two buffer layers and may also move buffer layer water into the interior isopycnal layers.  <a href="#a46fd0f8d6109e0d4f7e4da971f2ab663">More...</a><br /></td></tr>
<tr class="separator:a46fd0f8d6109e0d4f7e4da971f2ab663"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9e6f68b38815279808b9fa52cfc6e65"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#ad9e6f68b38815279808b9fa52cfc6e65">mixedlayer_detrain_1</a> (h, T, S, R0, Rcv, RcvTgt, dt, dt_diag, d_ea, d_eb, j, G, GV, CS, dRcv_dT, dRcv_dS, max_BL_det)</td></tr>
<tr class="memdesc:ad9e6f68b38815279808b9fa52cfc6e65"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine moves any water left in the former mixed layers into the single buffer layers and may also move buffer layer water into the interior isopycnal layers.  <a href="#ad9e6f68b38815279808b9fa52cfc6e65">More...</a><br /></td></tr>
<tr class="separator:ad9e6f68b38815279808b9fa52cfc6e65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7ec83a26f4ae95305e414057235a1e69"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a7ec83a26f4ae95305e414057235a1e69">bulkmixedlayer_init</a> (Time, G, GV, param_file, diag, CS)</td></tr>
<tr class="separator:a7ec83a26f4ae95305e414057235a1e69"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98199335f3bf2b2153c35957d753b867"><td class="memItemLeft" align="right" valign="top">real function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a98199335f3bf2b2153c35957d753b867">ef4</a> (H, E, L, dR_de)</td></tr>
<tr class="memdesc:a98199335f3bf2b2153c35957d753b867"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine returns an approximation to the integral R = exp(-L*(H+E)) integral(LH to L(H+E)) L/(1-(1+x)exp(-x)) dx. The approximation to the integrand is good to within -2% at x~.3 and +25% at x~3.5, but the exponential deemphasizes the importance of large x. When L=0, EF4 returns E/((H+E)*H).  <a href="#a98199335f3bf2b2153c35957d753b867">More...</a><br /></td></tr>
<tr class="separator:a98199335f3bf2b2153c35957d753b867"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a834f8c8f259f53f30654ad9273eee648"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a834f8c8f259f53f30654ad9273eee648">id_clock_detrain</a> =0</td></tr>
<tr class="separator:a834f8c8f259f53f30654ad9273eee648"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afadd63132ed4d2785d2771dfe33e64d8"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#afadd63132ed4d2785d2771dfe33e64d8">id_clock_mech</a> =0</td></tr>
<tr class="separator:afadd63132ed4d2785d2771dfe33e64d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaeabff634c035ff4b91e5ea695123a34"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#aaeabff634c035ff4b91e5ea695123a34">id_clock_conv</a> =0</td></tr>
<tr class="separator:aaeabff634c035ff4b91e5ea695123a34"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8e92dc75114e33498ee9318edbb784d4"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a8e92dc75114e33498ee9318edbb784d4">id_clock_adjustment</a> =0</td></tr>
<tr class="separator:a8e92dc75114e33498ee9318edbb784d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a238ec53eac28b48ba8ab226296b363f0"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a238ec53eac28b48ba8ab226296b363f0">id_clock_eos</a> =0</td></tr>
<tr class="separator:a238ec53eac28b48ba8ab226296b363f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa27ed6a6317d7f8031d7c0207fe42c52"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#aa27ed6a6317d7f8031d7c0207fe42c52">id_clock_resort</a> =0</td></tr>
<tr class="separator:aa27ed6a6317d7f8031d7c0207fe42c52"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af833f821fed6dc29921f131d80a27b6e"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#af833f821fed6dc29921f131d80a27b6e">id_clock_pass</a> =0</td></tr>
<tr class="separator:af833f821fed6dc29921f131d80a27b6e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6627a99604f22dd946977416da9f1420"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a6627a99604f22dd946977416da9f1420">num_msg</a> = 0</td></tr>
<tr class="separator:a6627a99604f22dd946977416da9f1420"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a95c01658ab4d38a3ff111da62296d52c"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__bulk__mixed__layer.html#a95c01658ab4d38a3ff111da62296d52c">max_msg</a> = 2</td></tr>
<tr class="separator:a95c01658ab4d38a3ff111da62296d52c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="af4ea9156c3759dd0328f0f994fe64e71"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4ea9156c3759dd0328f0f994fe64e71">&#9670;&nbsp;</a></span>bulkmixedlayer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_bulk_mixed_layer::bulkmixedlayer </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v_3d</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(optics_type), pointer&#160;</td>
          <td class="paramname"><em>optics</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>Hml</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>aggregate_FW_forcing</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>last_call</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine partially steps the bulk mixed layer model. The following processes are executed, in the order listed. </p>
<ol type="1">
<li>Undergo convective adjustment into mixed layer.</li>
<li>Apply surface heating and cooling.</li>
<li>Starting from the top, entrain whatever fluid the TKE budget permits. Penetrating shortwave radiation is also applied at this point.</li>
<li>If there is any unentrained fluid that was formerly in the mixed layer, detrain this fluid into the buffer layer. This is equivalent to the mixed layer detraining to the Monin- Obukhov depth.</li>
<li>Divide the fluid in the mixed layer evenly into CSnkml pieces.</li>
<li>Split the buffer layer if appropriate. Layers 1 to nkml are the mixed layer, nkml+1 to nkml+nkbl are the buffer layers. The results of this subroutine are mathematically identical if there are multiple pieces of the mixed layer with the same density or if there is just a single layer. There is no stability limit on the time step.</li>
</ol>
<p>The key parameters for the mixed layer are found in the control structure. These include mstar, nstar, nstar2, pen_SW_frac, pen_SW_scale, and TKE_decay. For the Oberhuber (1993) mixed layer, the values of these are: pen_SW_frac = 0.42, pen_SW_scale = 15.0 m, mstar = 1.25, nstar = 1, TKE_decay = 2.5, conv_decay = 0.5 TKE_decay is 1/kappa in eq. 28 of Oberhuber (1993), while conv_decay is 1/mu. Conv_decay has been eliminated in favor of the well-calibrated form for the efficiency of penetrating convection from Wang (2003). For a traditional Kraus-Turner mixed layer, the values are: pen_SW_frac = 0.0, pen_SW_scale = 0.0 m, mstar = 1.25, nstar = 0.4, TKE_decay = 0.0, conv_decay = 0.0</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_3d</td><td>Layer thickness, in m or kg m-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u_3d</td><td>Zonal velocities interpolated to h points,</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v_3d</td><td>Zonal velocities interpolated to h points,</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields. Absent fields have NULL ptrs.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields have NULL ptrs.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment, in s.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ea</td><td>The amount of fluid moved downward into a</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eb</td><td>The amount of fluid moved upward into a</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">optics</td><td>The structure containing the inverse of the vertical absorption decay scale for penetrating shortwave radiation, in m-1.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">hml</td><td>active mixed layer depth</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_diag</td><td>The diagnostic time step, which may be less than dt if there are two callse to mixedlayer, in s.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">last_call</td><td>if true, this is the last call to mixedlayer in the current time step, so diagnostics will be written. The default is .true. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">227</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__shortwave__abs_8F90_source.html#l00060">mom_shortwave_abs::absorbremainingsw()</a>, <a class="el" href="MOM__EOS_8F90_source.html#l00214">mom_eos::calculate_density_derivs()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00917">convective_adjustment()</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01968">mom_diag_mediator::diag_update_remap_grids()</a>, <a class="el" href="MOM__domains_8F90_source.html#l01201">mom_domains::do_group_pass()</a>, <a class="el" href="MOM__forcing__type_8F90_source.html#l00278">mom_forcing_type::extractfluxes1d()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01431">find_starting_tke()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_adjustment</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_conv</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_detrain</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_eos</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_mech</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_pass</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_resort</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01641">mechanical_entrainment()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01073">mixedlayer_convection()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03332">mixedlayer_detrain_1()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l02408">mixedlayer_detrain_2()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l02055">resort_ml()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01987">sort_ml()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00235">mom_diabatic_driver::diabatic()</a>.</p>
<div class="fragment"><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),      <span class="keywordtype">intent(inout)</span> :: g<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                              <span class="keywordtype">intent(inout)</span> :: h_3d<span class="comment">   !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">                                                      !! (Intent in/out) The units of h are</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">                                                      !! referred to as H below.</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                              <span class="keywordtype">intent(in)</span>    :: u_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points,</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">                                                      !! m s-1.</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                              <span class="keywordtype">intent(in)</span>    :: v_3d<span class="comment">   !&lt; Zonal velocities interpolated to h points,</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">                                                      !! m s-1.</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),      <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">     !&lt; A structure containing pointers to any</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">                                                      !! available thermodynamic fields. Absent</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">                                                      !! fields have NULL ptrs.</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keywordtype">type</span>(forcing),              <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">                                                      !! possible forcing fields.  Unused fields</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">                                                      !! have NULL ptrs.</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="keywordtype">real</span>,                       <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; Time increment, in s.</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                              <span class="keywordtype">intent(inout)</span> :: ea<span class="comment">     !&lt; The amount of fluid moved downward into a</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">                                                      !! layer; this should be increased due to</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">                                                      !! mixed layer detrainment, in the same units</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">                                                      !! as h - usually m or kg m-2 (i.e., H).</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                              <span class="keywordtype">intent(inout)</span> :: eb<span class="comment">     !&lt; The amount of fluid moved upward into a</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">                                                      !! layer; this should be increased due to</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">                                                      !! mixed layer entrainment, in the same units</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">                                                      !! as h - usually m or kg m-2 (i.e., H).</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),    <span class="keywordtype">pointer</span>       :: cs<span class="comment">     !&lt; The control structure returned by a</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">                                                      !! previous call to mixedlayer_init.</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordtype">type</span>(optics_type),          <span class="keywordtype">pointer</span>       :: optics<span class="comment"> !&lt; The structure containing the inverse of the</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">                                                      !! vertical absorption decay scale for</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">                                                      !! penetrating shortwave radiation, in m-1.</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,       <span class="keywordtype">pointer</span>       :: hml<span class="comment">    !&lt; active mixed layer depth</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="keywordtype">logical</span>,                    <span class="keywordtype">intent(in)</span>    :: aggregate_fw_forcing</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keywordtype">real</span>,                       <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: dt_diag<span class="comment">   !&lt; The diagnostic time step,</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">                                                      !! which may be less than dt if there are</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">                                                      !! two callse to mixedlayer, in s.</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordtype">logical</span>,                    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: last_call<span class="comment"> !&lt; if true, this is the last call</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">                                                      !! to mixedlayer in the current time step, so</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">                                                      !! diagnostics will be written. The default is</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">                                                      !! .true.</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">!    This subroutine partially steps the bulk mixed layer model.</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">!  The following processes are executed, in the order listed.</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">!    1. Undergo convective adjustment into mixed layer.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">!    2. Apply surface heating and cooling.</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">!    3. Starting from the top, entrain whatever fluid the TKE budget</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">!       permits.  Penetrating shortwave radiation is also applied at</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">!       this point.</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">!    4. If there is any unentrained fluid that was formerly in the</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">!       mixed layer, detrain this fluid into the buffer layer.  This</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">!       is equivalent to the mixed layer detraining to the Monin-</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">!       Obukhov depth.</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">!    5. Divide the fluid in the mixed layer evenly into CS%nkml pieces.</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">!    6. Split the buffer layer if appropriate.</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">! Layers 1 to nkml are the mixed layer, nkml+1 to nkml+nkbl are the</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">! buffer layers. The results of this subroutine are mathematically</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">! identical if there are multiple pieces of the mixed layer with</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">! the same density or if there is just a single layer. There is no</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">! stability limit on the time step.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">!   The key parameters for the mixed layer are found in the control structure.</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">! These include mstar, nstar, nstar2, pen_SW_frac, pen_SW_scale, and TKE_decay.</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">!   For the Oberhuber (1993) mixed layer, the values of these are:</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">!      pen_SW_frac = 0.42, pen_SW_scale = 15.0 m, mstar = 1.25,</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">!      nstar = 1, TKE_decay = 2.5, conv_decay = 0.5</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">!  TKE_decay is 1/kappa in eq. 28 of Oberhuber (1993), while conv_decay is 1/mu.</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">!  Conv_decay has been eliminated in favor of the well-calibrated form for the</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">!  efficiency of penetrating convection from Wang (2003).</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">!    For a traditional Kraus-Turner mixed layer, the values are:</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">!      pen_SW_frac = 0.0, pen_SW_scale = 0.0 m, mstar = 1.25,</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">!      nstar = 0.4, TKE_decay = 0.0, conv_decay = 0.0</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">! Arguments: h_3d - Layer thickness, in m or kg m-2. (Intent in/out)</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">!                   The units of h are referred to as H below.</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">!  (in)      u_3d - Zonal velocities interpolated to h points, m s-1.</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">!  (in)      v_3d - Zonal velocities interpolated to h points, m s-1.</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">!  (in/out)  tv - A structure containing pointers to any available</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">!                 thermodynamic fields. Absent fields have NULL ptrs.</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">!  (in)      fluxes - A structure containing pointers to any possible</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">!                     forcing fields.  Unused fields have NULL ptrs.</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">!  (in)      dt - Time increment, in s.</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">!  (in/out)  ea - The amount of fluid moved downward into a layer; this should</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">!                 be increased due to mixed layer detrainment, in the same units</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">!                 as h - usually m or kg m-2 (i.e., H).</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">!  (in/out)  eb - The amount of fluid moved upward into a layer; this should</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">!                 be increased due to mixed layer entrainment, in the same units</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">!                 as h - usually m or kg m-2 (i.e., H).</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">!                 mixedlayer_init.</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">!  (in)      optics - The structure containing the inverse of the vertical</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">!                     absorption decay scale for penetrating shortwave</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">!                     radiation, in m-1.</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">!  (in,opt)  dt_diag - The diagnostic time step, which may be less than dt</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">!                      if there are two callse to mixedlayer, in s.</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">!  (in,opt)  last_call - if true, this is the last call to mixedlayer in the</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">!                        current time step, so diagnostics will be written.</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">!                        The default is .true.</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    eaml, &amp;     <span class="comment">!   The amount of fluid moved downward into a layer due to mixed</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                <span class="comment">! mixed layer detrainment, in m. (I.e. entrainment from above.)</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    ebml        <span class="comment">!   The amount of fluid moved upward into a layer due to mixed</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="comment">! mixed layer detrainment, in m. (I.e. entrainment from below.)</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  <span class="comment">! If there is resorting, the vertical coordinate for these variables is the</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="comment">! new, sorted index space.  Here layer 0 is an initially massless layer that</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <span class="comment">! will be used to hold the new mixed layer properties.</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span> :: &amp;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    h, &amp;        <span class="comment">!   The layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    t, &amp;        <span class="comment">!   The layer temperatures, in deg C.</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    s, &amp;        <span class="comment">!   The layer salinities, in psu.</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    r0, &amp;       <span class="comment">!   The potential density referenced to the surface, in kg m-3.</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    rcv         <span class="comment">!   The coordinate variable potential density, in kg m-3.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    u, &amp;        <span class="comment">!   The zonal velocity, in m s-1.</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    v, &amp;        <span class="comment">!   The meridional velocity, in m s-1.</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    h_orig, &amp;   <span class="comment">!   The original thickness in m or kg m-2.</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    d_eb, &amp;     <span class="comment">!   The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                <span class="comment">! below, in H.  The sign convention is that positive values of</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                <span class="comment">! d_eb correspond to a gain in mass by a layer by upward motion.</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    d_ea, &amp;     <span class="comment">!   The upward increase across a layer in the entrainment from</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                <span class="comment">! above, in H.  The sign convention is that positive values of</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                <span class="comment">! d_ea mean a net gain in mass by a layer from downward motion.</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    eps         <span class="comment">! The (small) thickness that must remain in a layer, in H.</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    ksort       <span class="comment">!   The sorted k-index that each original layer goes to.</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    h_miss      <span class="comment">!   The summed absolute mismatch, in m.</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    tke, &amp;      <span class="comment">!   The turbulent kinetic energy available for mixing over a</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                <span class="comment">! time step, in m3 s-2.</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    conv_en, &amp;  <span class="comment">!   The turbulent kinetic energy source due to mixing down to</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                <span class="comment">! the depth of free convection, in m3 s-2.</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    htot, &amp;     <span class="comment">!   The total depth of the layers being considered for</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                <span class="comment">! entrainment, in H.</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    r0_tot, &amp;   <span class="comment">!   The integrated potential density referenced to the surface</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                <span class="comment">! of the layers which are fully entrained, in H kg m-3.</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    rcv_tot, &amp;  <span class="comment">!   The integrated coordinate value potential density of the</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                <span class="comment">! layers that are fully entrained, in H kg m-3.</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    ttot, &amp;     <span class="comment">!   The integrated temperature of layers which are fully</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                <span class="comment">! entrained, in H K.</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    stot, &amp;     <span class="comment">!   The integrated salt of layers which are fully entrained,</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                <span class="comment">! in H PSU.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    uhtot, &amp;    <span class="comment">!   The depth integrated zonal and meridional velocities in the</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    vhtot, &amp;    <span class="comment">! mixed layer, in H m s-1.</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    netmassinout, &amp;  <span class="comment">! The net mass flux (if non-Boussinsq) or volume flux (if</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                     <span class="comment">! Boussinesq - i.e. the fresh water flux (P+R-E)) into the</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                     <span class="comment">! ocean over a time step, in H.</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    netmassout,   &amp;  <span class="comment">! The mass flux (if non-Boussinsq) or volume flux (if</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                     <span class="comment">! Boussinesq) over a time step from evaporating fresh water (H)</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    net_heat, &amp; <span class="comment">!   The net heating at the surface over a time step in K H.  Any</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                <span class="comment">! penetrating shortwave radiation is not included in Net_heat.</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    net_salt, &amp; <span class="comment">! The surface salt flux into the ocean over a time step, psu H.</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    idecay_len_tke, &amp;  <span class="comment">! The inverse of a turbulence decay length scale, in H-1.</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    p_ref, &amp;    <span class="comment">!   Reference pressure for the potential density governing mixed</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                <span class="comment">! layer dynamics, almost always 0 (or 1e5) Pa.</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    p_ref_cv, &amp; <span class="comment">!   Reference pressure for the potential density which defines</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                <span class="comment">! the coordinate variable, set to P_Ref, in Pa.</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    dr0_dt, &amp;   <span class="comment">!   Partial derivative of the mixed layer potential density with</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="comment">! temperature, in units of kg m-3 K-1.</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    drcv_dt, &amp;  <span class="comment">!   Partial derivative of the coordinate variable potential</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                <span class="comment">! density in the mixed layer with temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    dr0_ds, &amp;   <span class="comment">!   Partial derivative of the mixed layer potential density with</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                <span class="comment">! salinity, in units of kg m-3 psu-1.</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    drcv_ds, &amp;  <span class="comment">!   Partial derivative of the coordinate variable potential</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                <span class="comment">! density in the mixed layer with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;    tke_river   <span class="comment">! The turbulent kinetic energy available for mixing at rivermouths over a</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                <span class="comment">! time step, in m3 s-2.</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(max(CS%nsw,1),SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    pen_sw_bnd  <span class="comment">!   The penetrating fraction of the shortwave heating integrated</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                <span class="comment">! over a time step in each band, in K H.</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(max(CS%nsw,1),SZI_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    opacity_band <span class="comment">! The opacity in each band, in H-1. The indicies are band, i, k.</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordtype">real</span> :: cmke(2,szi_(g)) <span class="comment">! Coefficients of HpE and HpE^2 in calculating the</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                          <span class="comment">! denominator of MKE_rate, in m-1 and m-2.</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="keywordtype">real</span> :: irho0         <span class="comment">! 1.0 / rho_0</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordtype">real</span> :: inkml, inkmlm1<span class="comment">!  1.0 / REAL(nkml) and  1.0 / REAL(nkml-1)</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">real</span> :: ih            <span class="comment">!   The inverse of a thickness, in H-1.</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordtype">real</span> :: idt           <span class="comment">!   The inverse of the timestep in s-1.</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordtype">real</span> :: idt_diag      <span class="comment">!   The inverse of the timestep used for diagnostics in s-1.</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordtype">real</span> :: rmixconst</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    dke_fc, &amp;   <span class="comment">!   The change in mean kinetic energy due to free convection,</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                <span class="comment">! in m3 s-2.</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    h_ca        <span class="comment">!   The depth to which convective adjustment has gone in H.</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    dke_ca, &amp;   <span class="comment">!   The change in mean kinetic energy due to convective</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <span class="comment">! adjustment, in m3 s-2.</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    ctke        <span class="comment">!   The turbulent kinetic energy source due to convective</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                <span class="comment">! adjustment, m3 s-2.</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    hsfc_max, &amp; <span class="comment">! The thickness of the surface region (mixed and buffer layers)</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                <span class="comment">! after entrainment but before any buffer layer detrainment, m.</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    hsfc_used, &amp; <span class="comment">! The thickness of the surface region after buffer layer</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                <span class="comment">! detrainment, in units of m.</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    hsfc_min, &amp; <span class="comment">! The minimum thickness of the surface region based on the</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                <span class="comment">! new mixed layer depth and the previous thickness of the</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                <span class="comment">! neighboring water columns, in m.</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    h_sum, &amp;    <span class="comment">! The total thickness of the water column, in H.</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    hmbl_prev   <span class="comment">! The previous thickness of the mixed and buffer layers, in H.</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    hsfc, &amp;     <span class="comment">!   The thickness of the surface region (mixed and buffer</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                <span class="comment">! layers before detrainment in to the interior, in H.</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    max_bl_det  <span class="comment">!   If non-negative, the maximum amount of entrainment from</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                <span class="comment">! the buffer layers that will be allowed this time step, in H.</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordtype">real</span> :: dhsfc, dhd <span class="comment">! Local copies of nondimensional parameters.</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordtype">real</span> :: h_nbr <span class="comment">! A minimum thickness based on neighboring thicknesses, in H.</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">real</span> :: absf_x_h  <span class="comment">! The absolute value of f times the mixed layer thickness,</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                    <span class="comment">! in units of m s-1.</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordtype">real</span> :: ku_star   <span class="comment">! Ustar times the Von Karmen constant, in m s-1.</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">real</span> :: dt__diag <span class="comment">! A copy of dt_diag (if present) or dt, in s.</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">logical</span> :: write_diags  <span class="comment">! If true, write out diagnostics with this step.</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">logical</span> :: reset_diags  <span class="comment">! If true, zero out the accumulated diagnostics.</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz, nkmb, n</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">integer</span> :: nsw    <span class="comment">! The number of bands of penetrating shortwave radiation.</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixed_layer: &quot;</span>//&amp;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordflow">if</span> (gv%nkml &lt; 1) <span class="keywordflow">return</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">ASSOCIATED</span>(tv%eqn_of_state)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="stringliteral">&quot;MOM_mixed_layer: Temperature, salinity and an equation of state &quot;</span>//&amp;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      <span class="stringliteral">&quot;must now be used.&quot;</span>)</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">if</span> (.NOT. <span class="keyword">ASSOCIATED</span>(fluxes%ustar)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      <span class="stringliteral">&quot;MOM_mixed_layer: No surface TKE fluxes (ustar) defined in mixedlayer!&quot;</span>)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  inkml = 1.0 / <span class="keywordtype">REAL</span>(cs%nkml)</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordflow">if</span> (cs%nkml &gt; 1) inkmlm1 = 1.0 / <span class="keywordtype">REAL</span>(cs%nkml-1)</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  irho0 = 1.0 / gv%Rho0</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  dt__diag = dt ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag)) dt__diag = dt_diag</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  idt = 1.0/dt</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  idt_diag = 1.0 / dt__diag</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  write_diags = .true. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(last_call)) write_diags = last_call</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  p_ref(:) = 0.0 ; p_ref_cv(:) = tv%P_Ref</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  nsw = cs%nsw</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  <span class="keywordflow">if</span> (cs%limit_det .or. (cs%id_Hsfc_min &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,nkmb,h_sum,hmbl_prev,h_3d,nz)</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      h_sum(i,j) = 0.0 ; hmbl_prev(i,j) = 0.0</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="keywordflow">do</span> k=1,nkmb ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        h_sum(i,j) = h_sum(i,j) + h_3d(i,j,k)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        hmbl_prev(i,j) = hmbl_prev(i,j) + h_3d(i,j,k)</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="keywordflow">do</span> k=nkmb+1,nz ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        h_sum(i,j) = h_sum(i,j) + h_3d(i,j,k)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_h_sum_hmbl_prev, h_sum,g%Domain)</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_h_sum_hmbl_prev, hmbl_prev,g%Domain)</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_h_sum_hmbl_prev, g%Domain)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="comment">! Determine whether to zero out diagnostics before accumulation.</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  reset_diags = .true.</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_diag) .and. write_diags .and. (dt__diag &gt; dt)) &amp;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    reset_diags = .false.  <span class="comment">! This is the second call to mixedlayer.</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keywordflow">if</span> (reset_diags) <span class="keywordflow">then</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,CS)</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        cs%diag_TKE_wind(i,j) = 0.0 ; cs%diag_TKE_RiBulk(i,j) = 0.0</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        cs%diag_TKE_conv(i,j) = 0.0 ; cs%diag_TKE_pen_SW(i,j) = 0.0</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        cs%diag_TKE_mixing(i,j) = 0.0 ; cs%diag_TKE_mech_decay(i,j) = 0.0</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        cs%diag_TKE_conv_decay(i,j) = 0.0 ; cs%diag_TKE_conv_s2(i,j) = 0.0</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) <span class="keywordflow">then</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        cs%diag_PE_detrain(i,j) = 0.0</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) <span class="keywordflow">then</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        cs%diag_PE_detrain2(i,j) = 0.0</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordflow">if</span> (cs%ML_resort) <span class="keywordflow">then</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; h_ca(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; dke_ca(i,k) = 0.0 ; ctke(i,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  max_bl_det(:) = -1</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,nz,h_3d,u_3d,v_3d,nkmb,G,GV,nsw,optics,      &amp;</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">!$OMP                               CS,tv,fluxes,Irho0,dt,Idt_diag,Ih,write_diags,           &amp;</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">!$OMP                               hmbl_prev,h_sum,Hsfc_min,Hsfc_max,dt__diag,              &amp;</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">!$OMP                               Hsfc_used,Inkmlm1,Inkml,ea,eb,h_miss,Hml,                &amp;</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">!$OMP                               id_clock_EOS,id_clock_resort,id_clock_adjustment,        &amp;</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">!$OMP                               id_clock_conv,id_clock_mech,id_clock_detrain,aggregate_FW_forcing ) &amp;</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">!$OMP                  firstprivate(dKE_CA,cTKE,h_CA,max_BL_det,p_ref,p_ref_cv)              &amp;</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">!$OMP                       private(h,h_orig,u,v,eps,T,S,opacity_band,d_ea,d_eb,             &amp;</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">!$OMP                               dR0_dT,dR0_dS,dRcv_dT,dRcv_dS,R0,Rcv,ksort,              &amp;</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">!$OMP                               RmixConst,TKE_river,netMassInOut, NetMassOut,            &amp;</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">!$OMP                               Net_heat, Net_salt, htot,TKE,Pen_SW_bnd,Ttot,Stot, uhtot,&amp;</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">!$OMP                               vhtot, R0_tot, Rcv_tot,Conv_en,dKE_FC,Idecay_len_TKE,    &amp;</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">!$OMP                               cMKE,Hsfc,dHsfc,dHD,H_nbr,kU_Star,absf_x_H,              &amp;</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">!$OMP                               ebml,eaml)</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="comment">! Copy the thicknesses and other fields to 2-d arrays.</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      h(i,k) = h_3d(i,j,k) ; u(i,k) = u_3d(i,j,k) ; v(i,k) = v_3d(i,j,k)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;      h_orig(i,k) = h_3d(i,j,k)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      eps(i,k) = 0.0 ; <span class="keywordflow">if</span> (k &gt; nkmb) eps(i,k) = gv%Angstrom</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      t(i,k) = tv%T(i,j,k) ; s(i,k) = tv%S(i,j,k)</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      <span class="keywordflow">do</span> n=1,nsw</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        opacity_band(n,i,k) = gv%H_to_m*optics%opacity_band(n,i,j,k)</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      d_ea(i,k) = 0.0 ; d_eb(i,k) = 0.0</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordflow">if</span>(id_clock_eos&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_eos)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="comment">! Calculate an estimate of the mid-mixed layer pressure (in Pa)</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; p_ref(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keywordflow">do</span> k=1,cs%nkml ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      p_ref(i) = p_ref(i) + 0.5*gv%H_to_Pa*h(i,k)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="keyword">call </span>calculate_density_derivs(t(:,1), s(:,1), p_ref, dr0_dt, dr0_ds, &amp;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                                  is, ie-is+1, tv%eqn_of_state)</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="keyword">call </span>calculate_density_derivs(t(:,1), s(:,1), p_ref_cv, drcv_dt, drcv_ds, &amp;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                                  is, ie-is+1, tv%eqn_of_state)</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      <span class="keyword">call </span>calculate_density(t(:,k), s(:,k), p_ref, r0(:,k), is, ie-is+1, &amp;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                             tv%eqn_of_state)</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      <span class="keyword">call </span>calculate_density(t(:,k), s(:,k), p_ref_cv, rcv(:,k), is, &amp;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                             ie-is+1, tv%eqn_of_state)</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">if</span>(id_clock_eos&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_eos)</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <span class="keywordflow">if</span> (cs%ML_resort) <span class="keywordflow">then</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;      <span class="keywordflow">if</span>(id_clock_resort&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_resort)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      <span class="keywordflow">if</span> (cs%ML_presort_nz_conv_adj &gt; 0) &amp;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="keyword">call </span>convective_adjustment(h(:,1:), u, v, r0(:,1:), rcv(:,1:), t(:,1:), &amp;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                                   s(:,1:), eps, d_eb, dke_ca, ctke, j, g, gv, cs, &amp;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                                   cs%ML_presort_nz_conv_adj)</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="keyword">call </span>sort_ml(h(:,1:), r0(:,1:), eps, g, gv, cs, ksort)</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      <span class="keywordflow">if</span>(id_clock_resort&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_resort)</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; ksort(i,k) = k ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      <span class="keywordflow">if</span>(id_clock_adjustment&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_adjustment)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      <span class="comment">!  Undergo instantaneous entrainment into the buffer layers and mixed layers</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      <span class="comment">! to remove hydrostatic instabilities.  Any water that is lighter than</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">! currently in the mixed or buffer layer is entrained.</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="keyword">call </span>convective_adjustment(h(:,1:), u, v, r0(:,1:), rcv(:,1:), t(:,1:), &amp;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                                 s(:,1:), eps, d_eb, dke_ca, ctke, j, g, gv, cs)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; h_ca(i) = h(i,1) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      <span class="keywordflow">if</span>(id_clock_adjustment&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_adjustment)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%lrunoff) .and. cs%do_rivermix) <span class="keywordflow">then</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;      <span class="comment">! Here we add an additional source of TKE to the mixed layer where river</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;      <span class="comment">! is present to simulate unresolved estuaries. The TKE input is diagnosed</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      <span class="comment">! as follows:</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="comment">!   TKE_river[m3 s-3] = 0.5*rivermix_depth*g*Irho0*drho_ds*</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;      <span class="comment">!                       River*(Samb - Sriver) = CS%mstar*U_star^3</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      <span class="comment">! where River is in units of m s-1.</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;      <span class="comment">! Samb = Ambient salinity at the mouth of the estuary</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="comment">! rivermix_depth =  The prescribed depth over which to mix river inflow</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="comment">! drho_ds = The gradient of density wrt salt at the ambient surface salinity.</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="comment">! Sriver = 0 (i.e. rivers are assumed to be pure freshwater)</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      rmixconst = 0.5*cs%rivermix_depth*gv%g_Earth*irho0**2</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        tke_river(i) = max(0.0, rmixconst*dr0_ds(i)* &amp;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            (fluxes%lrunoff(i,j) + fluxes%frunoff(i,j)) * s(i,1))</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; tke_river(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">if</span>(id_clock_conv&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_conv)</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="comment">! The surface forcing is contained in the fluxes type.</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="comment">! We aggregate the thermodynamic forcing for a time step into the following:</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="comment">! netMassInOut = water (H units) added/removed via surface fluxes</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="comment">! netMassOut   = water (H units) removed via evaporating surface fluxes</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="comment">! net_heat     = heat (degC * H) via surface fluxes</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="comment">! net_salt     = salt ( g(salt)/m2 for non-Bouss and ppt*m/s for Bouss ) via surface fluxes</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="comment">! Pen_SW_bnd   = components to penetrative shortwave radiation</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keyword">call </span>extractfluxes1d(g, gv, fluxes, optics, nsw, j, dt, &amp;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                  cs%H_limit_fluxes, cs%use_river_heat_content, cs%use_calving_heat_content, &amp;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                  h(:,1:), t(:,1:), netmassinout, netmassout, net_heat, net_salt, pen_sw_bnd,&amp;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                  tv, aggregate_fw_forcing)</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="comment">! This subroutine causes the mixed layer to entrain to depth of free convection.</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    <span class="keyword">call </span>mixedlayer_convection(h(:,1:), d_eb, htot, ttot, stot, uhtot, vhtot, &amp;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                               r0_tot, rcv_tot, u, v, t(:,1:), s(:,1:),       &amp;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                               r0(:,1:), rcv(:,1:), eps,                      &amp;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                               dr0_dt, drcv_dt, dr0_ds, drcv_ds,              &amp;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                               netmassinout, netmassout, net_heat, net_salt,  &amp;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                               nsw, pen_sw_bnd, opacity_band, conv_en,        &amp;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                               dke_fc, j, ksort, g, gv, cs, tv, fluxes, dt,       &amp;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                               aggregate_fw_forcing)</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="keywordflow">if</span>(id_clock_conv&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_conv)</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="comment">!   Now the mixed layer undergoes mechanically forced entrainment.</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">! The mixed layer may entrain down to the Monin-Obukhov depth if the</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="comment">! surface is becoming lighter, and is effectively detraining.</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="comment">!    First the TKE at the depth of free convection that is available</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="comment">!  to drive mixing is calculated.</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordflow">if</span>(id_clock_mech&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_mech)</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keyword">call </span>find_starting_tke(htot, h_ca, fluxes, conv_en, ctke, dke_fc, dke_ca, &amp;</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                           tke, tke_river, idecay_len_tke, cmke, dt, idt_diag, &amp;</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                           j, ksort, g, gv, cs)</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="comment">! Here the mechanically driven entrainment occurs.</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keyword">call </span>mechanical_entrainment(h(:,1:), d_eb, htot, ttot, stot, uhtot, vhtot, &amp;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                                r0_tot, rcv_tot, u, v, t(:,1:), s(:,1:), r0(:,1:), rcv(:,1:), eps, dr0_dt, drcv_dt, &amp;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;                                cmke, idt_diag, nsw, pen_sw_bnd, opacity_band, tke, &amp;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                                idecay_len_tke, j, ksort, g, gv, cs)</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="keyword">call </span>absorbremainingsw(g, gv, h(:,1:), opacity_band, nsw, j, dt, cs%H_limit_fluxes, &amp;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                           cs%correct_absorption, cs%absorb_all_SW, &amp;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                           t(:,1:), pen_sw_bnd, eps, ksort, htot, ttot)</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) - idt_diag*tke(i)</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keywordflow">if</span>(id_clock_mech&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_mech)</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="comment">! Calculate the homogeneous mixed layer properties and store them in layer 0.</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (htot(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      ih = 1.0 / htot(i)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      r0(i,0) = r0_tot(i) * ih ; rcv(i,0) = rcv_tot(i) * ih</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      t(i,0) = ttot(i) * ih ; s(i,0) = stot(i) * ih</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      h(i,0) = htot(i)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! This may not ever be needed?</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      t(i,0) = t(i,1) ; s(i,0) = s(i,1) ; r0(i,0) = r0(i,1) ; rcv(i,0) = rcv(i,1)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      h(i,0) = htot(i)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="keywordflow">if</span> (write_diags .and. <span class="keyword">ALLOCATED</span>(cs%ML_depth)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      cs%ML_depth(i,j) = h(i,0) * gv%H_to_m</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(hml)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      hml(i,j) = g%mask2dT(i,j) * (h(i,0) * gv%H_to_m)</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">! At this point, return water to the original layers, but constrained to</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment">! still be sorted.  After this point, all the water that is in massive</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="comment">! interior layers will be denser than water remaining in the mixed- and</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">! buffer-layers.  To achieve this, some of these variable density layers</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="comment">! might be split between two isopycnal layers that are denser than new</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">! mixed layer or any remaining water from the old mixed- or buffer-layers.</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">! Alternately, if there are fewer than nkbl of the old buffer or mixed layers</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">! with any mass, relatively light interior layers might be transferred to</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">! these unused layers (but not currently in the code).</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">if</span> (cs%ML_resort) <span class="keywordflow">then</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;      <span class="keywordflow">if</span>(id_clock_resort&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_resort)</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;      <span class="keyword">call </span>resort_ml(h(:,0:), t(:,0:), s(:,0:), r0(:,0:), rcv(:,0:), gv%Rlay, eps, &amp;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                     d_ea, d_eb, ksort, g, gv, cs, dr0_dt, dr0_ds, drcv_dt, drcv_ds)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      <span class="keywordflow">if</span>(id_clock_resort&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_resort)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">if</span> (cs%limit_det .or. (cs%id_Hsfc_max &gt; 0) .or. (cs%id_Hsfc_min &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; hsfc(i) = h(i,0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      <span class="keywordflow">do</span> k=1,nkmb ; <span class="keywordflow">do</span> i=is,ie ; hsfc(i) = hsfc(i) + h(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      <span class="keywordflow">if</span> (cs%limit_det .or. (cs%id_Hsfc_min &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        dhsfc = cs%lim_det_dH_sfc ; dhd = cs%lim_det_dH_bathy</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;          h_nbr = min(dhsfc*max(hmbl_prev(i-1,j), hmbl_prev(i+1,j), &amp;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;                                hmbl_prev(i,j-1), hmbl_prev(i,j+1)), &amp;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                      max(hmbl_prev(i-1,j) - dhd*min(h_sum(i,j),h_sum(i-1,j)), &amp;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                          hmbl_prev(i+1,j) - dhd*min(h_sum(i,j),h_sum(i+1,j)), &amp;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                          hmbl_prev(i,j-1) - dhd*min(h_sum(i,j),h_sum(i,j-1)), &amp;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                          hmbl_prev(i,j+1) - dhd*min(h_sum(i,j),h_sum(i,j+1))) )</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;          hsfc_min(i,j) = gv%H_to_m*max(h(i,0), min(hsfc(i), h_nbr))</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;          <span class="keywordflow">if</span> (cs%limit_det) max_bl_det(i) = max(0.0, hsfc(i)-h_nbr)</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      <span class="keywordflow">if</span> (cs%id_Hsfc_max &gt; 0) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        hsfc_max(i,j) = hsfc(i)*gv%H_to_m</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">! Move water left in the former mixed layer into the buffer layer and</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment">! from the buffer layer into the interior.  These steps might best be</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment">! treated in conjuction.</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordflow">if</span>(id_clock_detrain&gt;0) <span class="keyword">call </span>cpu_clock_begin(id_clock_detrain)</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">if</span> (cs%nkbl == 1) <span class="keywordflow">then</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;      <span class="keyword">call </span>mixedlayer_detrain_1(h(:,0:), t(:,0:), s(:,0:), r0(:,0:), rcv(:,0:), &amp;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                                gv%Rlay, dt, dt__diag, d_ea, d_eb, j, g, gv, cs, &amp;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                                drcv_dt, drcv_ds, max_bl_det)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keywordflow">elseif</span> (cs%nkbl == 2) <span class="keywordflow">then</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      <span class="keyword">call </span>mixedlayer_detrain_2(h(:,0:), t(:,0:), s(:,0:), r0(:,0:), rcv(:,0:), &amp;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                                gv%Rlay, dt, dt__diag, d_ea, j, g, gv, cs, &amp;</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                                dr0_dt, dr0_ds, drcv_dt, drcv_ds, max_bl_det)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! CS%nkbl not = 1 or 2</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      <span class="comment">! This code only works with 1 or 2 buffer layers.</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixed_layer: CS%nkbl must be 1 or 2 for now.&quot;</span>)</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">if</span>(id_clock_detrain&gt;0) <span class="keyword">call </span>cpu_clock_end(id_clock_detrain)</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_used &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; hsfc_used(i,j) = h(i,0)*gv%H_to_m ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;      <span class="keywordflow">do</span> k=cs%nkml+1,nkmb ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        hsfc_used(i,j) = hsfc_used(i,j) + h(i,k)*gv%H_to_m</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="comment">! Now set the properties of the layers in the mixed layer in the original</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="comment">! 3-d variables.</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">if</span> (cs%Resolve_Ekman .and. (cs%nkml&gt;1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      <span class="comment">! The thickness of the topmost piece of the mixed layer is given by</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;      <span class="comment">! h_1 = H / (3 + sqrt(|f|*H^2/2*nu_max)), which asymptotes to the Ekman</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      <span class="comment">! layer depth and 1/3 of the mixed layer depth.  This curve has been</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;      <span class="comment">! determined to maximize the impact of the Ekman transport in the mixed</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;      <span class="comment">! layer TKE budget with nkml=2.  With nkml=3, this should also be used,</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      <span class="comment">! as the third piece will then optimally describe mixed layer</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      <span class="comment">! restratification.  For nkml&gt;=4 the whole strategy should be revisited.</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        ku_star = 0.41*fluxes%ustar(i,j) <span class="comment">! Maybe could be replaced with u*+w*?</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%ustar_shelf) .and. &amp;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="keyword">associated</span>(fluxes%frac_shelf_h)) <span class="keywordflow">then</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          <span class="keywordflow">if</span> (fluxes%frac_shelf_h(i,j) &gt; 0.0) &amp;</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            ku_star = (1.0 - fluxes%frac_shelf_h(i,j)) * ku_star + &amp;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                      fluxes%frac_shelf_h(i,j) * (0.41*fluxes%ustar_shelf(i,j))</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        absf_x_h = 0.25 * h(i,0) * &amp;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            ((abs(g%CoriolisBu(i,j)) + abs(g%CoriolisBu(i-1,j-1))) + &amp;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;             (abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i-1,j))))</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        <span class="comment">! If the mixed layer vertical viscosity specification is changed in</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="comment">! MOM_vert_friction.F90, this line will have to be modified accordingly.</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        h_3d(i,j,1) = h(i,0) / (3.0 + sqrt(absf_x_h*(absf_x_h + 2.0*ku_star) / &amp;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;                                         (ku_star**2)) )</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordflow">do</span> k=2,cs%nkml</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;          <span class="comment">! The other layers are evenly distributed through the mixed layer.</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;          h_3d(i,j,k) = (h(i,0)-h_3d(i,j,1)) * inkmlm1</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;          d_ea(i,k) = d_ea(i,k) + h_3d(i,j,k)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;          d_ea(i,1) = d_ea(i,1) - h_3d(i,j,k)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        h_3d(i,j,1) = h(i,0) * inkml</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      <span class="keywordflow">do</span> k=2,cs%nkml ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        h_3d(i,j,k) = h(i,0) * inkml</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        d_ea(i,k) = d_ea(i,k) + h_3d(i,j,k)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        d_ea(i,1) = d_ea(i,1) - h_3d(i,j,k)</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; h(i,0) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordflow">do</span> k=1,cs%nkml ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;      tv%T(i,j,k) = t(i,0) ; tv%S(i,j,k) = s(i,0)</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="comment">! These sum needs to be done in the original layer space.</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="comment">! The treatment of layer 1 is atypical because evaporation shows up as</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">! negative ea(i,1), and because all precipitation goes straight into layer 1.</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="comment">! The code is ordered so that any roundoff errors in ea are lost the surface.</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="comment">!    do i=is,ie ; eaml(i,1) = 0.0 ; enddo</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="comment">!    do k=2,nz ; do i=is,ie ; eaml(i,k) = eaml(i,k-1) - d_ea(i,k-1) ; enddo ; enddo</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="comment">!    do i=is,ie ; eaml(i,1) = netMassInOut(i) ; enddo</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">! eaml(i,nz) is derived from  h(i,nz) - h_orig(i,nz) = eaml(i,nz) - ebml(i,nz-1)</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      ebml(i,nz) = 0.0</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      eaml(i,nz) = (h(i,nz) - h_orig(i,nz)) - d_eb(i,nz)</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      ebml(i,k) = ebml(i,k+1) - d_eb(i,k+1)</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      eaml(i,k) = eaml(i,k+1) + d_ea(i,k)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; eaml(i,1) = netmassinout(i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="comment">! Copy the interior thicknesses and other fields back to the 3-d arrays.</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keywordflow">do</span> k=cs%nkml+1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      h_3d(i,j,k) = h(i,k); tv%T(i,j,k) = t(i,k) ; tv%S(i,j,k) = s(i,k)</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;      ea(i,j,k) = ea(i,j,k) + eaml(i,k)</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      eb(i,j,k) = eb(i,j,k) + ebml(i,k)</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordflow">if</span> (cs%id_h_mismatch &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        h_miss(i,j) = abs(h_3d(i,j,1) - (h_orig(i,1) + &amp;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;          (eaml(i,1) + (ebml(i,1) - eaml(i,1+1)))))</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;      <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        h_miss(i,j) = h_miss(i,j) + abs(h_3d(i,j,k) - (h_orig(i,k) + &amp;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;          ((eaml(i,k) - ebml(i,k-1)) + (ebml(i,k) - eaml(i,k+1)))))</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        h_miss(i,j) = h_miss(i,j) + abs(h_3d(i,j,nz) - (h_orig(i,nz) + &amp;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;          ((eaml(i,nz) - ebml(i,nz-1)) + ebml(i,nz))))</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        h_miss(i,j) = gv%H_to_m * h_miss(i,j)</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j loop</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="comment">! Whenever thickness changes let the diag manager know, target grids</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="comment">! for vertical remapping may need to be regenerated.</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  <span class="comment">! This needs to happen after the H update and before the next post_data.</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="keyword">call </span>diag_update_remap_grids(cs%diag)</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="keywordflow">if</span> (write_diags) <span class="keywordflow">then</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="keywordflow">if</span> (cs%id_ML_depth &gt; 0) &amp;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;      <span class="keyword">call </span>post_data(cs%id_ML_depth, cs%ML_depth, cs%diag)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_wind &gt; 0) &amp;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_wind, cs%diag_TKE_wind, cs%diag)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_RiBulk &gt; 0) &amp;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_RiBulk, cs%diag_TKE_RiBulk, cs%diag)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv &gt; 0) &amp;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv, cs%diag_TKE_conv, cs%diag)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_pen_SW &gt; 0) &amp;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_pen_SW, cs%diag_TKE_pen_SW, cs%diag)</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mixing &gt; 0) &amp;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_mixing, cs%diag_TKE_mixing, cs%diag)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_mech_decay &gt; 0) &amp;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_mech_decay, cs%diag_TKE_mech_decay, cs%diag)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv_decay &gt; 0) &amp;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv_decay, cs%diag_TKE_conv_decay, cs%diag)</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="keywordflow">if</span> (cs%id_TKE_conv_s2 &gt; 0) &amp;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      <span class="keyword">call </span>post_data(cs%id_TKE_conv_s2, cs%diag_TKE_conv_s2, cs%diag)</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keywordflow">if</span> (cs%id_PE_detrain &gt; 0) &amp;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      <span class="keyword">call </span>post_data(cs%id_PE_detrain, cs%diag_PE_detrain, cs%diag)</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">if</span> (cs%id_PE_detrain2 &gt; 0) &amp;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;      <span class="keyword">call </span>post_data(cs%id_PE_detrain2, cs%diag_PE_detrain2, cs%diag)</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">if</span> (cs%id_h_mismatch &gt; 0) &amp;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;      <span class="keyword">call </span>post_data(cs%id_h_mismatch, h_miss, cs%diag)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_used &gt; 0) &amp;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Hsfc_used, hsfc_used, cs%diag)</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_max &gt; 0) &amp;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Hsfc_max, hsfc_max, cs%diag)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="keywordflow">if</span> (cs%id_Hsfc_min &gt; 0) &amp;</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;      <span class="keyword">call </span>post_data(cs%id_Hsfc_min, hsfc_min, cs%diag)</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_af4ea9156c3759dd0328f0f994fe64e71_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_af4ea9156c3759dd0328f0f994fe64e71_icgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a7ec83a26f4ae95305e414057235a1e69"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7ec83a26f4ae95305e414057235a1e69">&#9670;&nbsp;</a></span>bulkmixedlayer_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_bulk_mixed_layer::bulkmixedlayer_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>A structure that is used to regulate diagnostic output.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">3647</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_adjustment</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_conv</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_detrain</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_eos</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">id_clock_mech</a>, <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_pass</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">id_clock_resort</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l01789">mom_diabatic_driver::diabatic_driver_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: time</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;<span class="comment">                                                 !! parameters.</span></div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; A structure that is used to regulate diagnostic</span></div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;<span class="comment">                                                 !! output.</span></div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs), <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; A pointer that is set to point to the control</span></div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;<span class="comment">                                                 !! structure for this module.</span></div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;<span class="comment">! Arguments: Time - The current model time.</span></div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;<span class="comment">!  (in)      param_file - A structure indicating the open file to parse for</span></div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;<span class="comment">!                         model parameter values.</span></div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;<span class="comment">!  (in)      diag - A structure that is used to regulate diagnostic output.</span></div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;<span class="comment">!  (in/out)  CS - A pointer that is set to point to the control structure</span></div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;<span class="comment">!                  for this module</span></div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_mixed_layer&quot;</span>  <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;  <span class="keywordtype">real</span> :: omega_frac_dflt, ustar_min_dflt</div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;  <span class="keywordtype">logical</span> :: use_temperature, use_omega</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;</div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;mixedlayer_init called with an associated&quot;</span>// &amp;</div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;</div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;  cs%Time =&gt; time</div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;</div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;  <span class="keywordflow">if</span> (gv%nkml &lt; 1) <span class="keywordflow">return</span></div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;</div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;<span class="comment">! Set default, read and log parameters</span></div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;  cs%nkml = gv%nkml</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;NKML&quot;</span>, cs%nkml, &amp;</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;                 <span class="stringliteral">&quot;The number of sublayers within the mixed layer if \n&quot;</span>//&amp;</div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;                 <span class="stringliteral">&quot;BULKMIXEDLAYER is true.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2)</div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;  cs%nkbl = gv%nk_rho_varies - gv%nkml</div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;NKBL&quot;</span>, cs%nkbl, &amp;</div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;                 <span class="stringliteral">&quot;The number of variable density buffer layers if \n&quot;</span>//&amp;</div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;                 <span class="stringliteral">&quot;BULKMIXEDLAYER is true.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2)</div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MSTAR&quot;</span>, cs%mstar, &amp;</div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;                 <span class="stringliteral">&quot;The ratio of the friction velocity cubed to the TKE \n&quot;</span>//&amp;</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;                 <span class="stringliteral">&quot;input to the mixed layer.&quot;</span>, <span class="stringliteral">&quot;units=nondim&quot;</span>, default=1.2)</div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NSTAR&quot;</span>, cs%nstar, &amp;</div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;                 <span class="stringliteral">&quot;The portion of the buoyant potential energy imparted by \n&quot;</span>//&amp;</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;                 <span class="stringliteral">&quot;surface fluxes that is available to drive entrainment \n&quot;</span>//&amp;</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;                 <span class="stringliteral">&quot;at the base of mixed layer when that energy is positive.&quot;</span>, &amp;</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.15)</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BULK_RI_ML&quot;</span>, cs%bulk_Ri_ML, &amp;</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;                 <span class="stringliteral">&quot;The efficiency with which mean kinetic energy released \n&quot;</span>//&amp;</div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;                 <span class="stringliteral">&quot;by mechanically forced entrainment of the mixed layer \n&quot;</span>//&amp;</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;                 <span class="stringliteral">&quot;is converted to turbulent kinetic energy.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>,&amp;</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ABSORB_ALL_SW&quot;</span>, cs%absorb_all_sw, &amp;</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;                 <span class="stringliteral">&quot;If true,  all shortwave radiation is absorbed by the \n&quot;</span>//&amp;</div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;                 <span class="stringliteral">&quot;ocean, instead of passing through to the bottom mud.&quot;</span>, &amp;</div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;                 default=.false.)</div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TKE_DECAY&quot;</span>, cs%TKE_decay, &amp;</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;                 <span class="stringliteral">&quot;TKE_DECAY relates the vertical rate of decay of the \n&quot;</span>//&amp;</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;                 <span class="stringliteral">&quot;TKE available for mechanical entrainment to the natural \n&quot;</span>//&amp;</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;                 <span class="stringliteral">&quot;Ekman depth.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=2.5)</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NSTAR2&quot;</span>, cs%nstar2, &amp;</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;                 <span class="stringliteral">&quot;The portion of any potential energy released by \n&quot;</span>//&amp;</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;                 <span class="stringliteral">&quot;convective adjustment that is available to drive \n&quot;</span>//&amp;</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;                 <span class="stringliteral">&quot;entrainment at the base of mixed layer. By default \n&quot;</span>//&amp;</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;                 <span class="stringliteral">&quot;NSTAR2=NSTAR.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=cs%nstar)</div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BULK_RI_CONVECTIVE&quot;</span>, cs%bulk_Ri_convective, &amp;</div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;                 <span class="stringliteral">&quot;The efficiency with which convectively released mean \n&quot;</span>//&amp;</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;                 <span class="stringliteral">&quot;kinetic energy is converted to turbulent kinetic \n&quot;</span>//&amp;</div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;                 <span class="stringliteral">&quot;energy.  By default BULK_RI_CONVECTIVE=BULK_RI_ML.&quot;</span>, &amp;</div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=cs%bulk_Ri_ML)</div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HMIX_MIN&quot;</span>, cs%Hmix_min, &amp;</div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;                 <span class="stringliteral">&quot;The minimum mixed layer depth if the mixed layer depth \n&quot;</span>//&amp;</div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;                 <span class="stringliteral">&quot;is determined dynamically.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;</div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LIMIT_BUFFER_DETRAIN&quot;</span>, cs%limit_det, &amp;</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;                 <span class="stringliteral">&quot;If true, limit the detrainment from the buffer layers \n&quot;</span>//&amp;</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;                 <span class="stringliteral">&quot;to not be too different from the neighbors.&quot;</span>, default=.false.)</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ALLOWED_DETRAIN_TEMP_CHG&quot;</span>, cs%Allowed_T_chg, &amp;</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;                 <span class="stringliteral">&quot;The amount by which temperature is allowed to exceed \n&quot;</span>//&amp;</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;                 <span class="stringliteral">&quot;previous values during detrainment.&quot;</span>, units=<span class="stringliteral">&quot;K&quot;</span>, default=0.5)</div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ALLOWED_DETRAIN_SALT_CHG&quot;</span>, cs%Allowed_S_chg, &amp;</div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;                 <span class="stringliteral">&quot;The amount by which salinity is allowed to exceed \n&quot;</span>//&amp;</div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;                 <span class="stringliteral">&quot;previous values during detrainment.&quot;</span>, units=<span class="stringliteral">&quot;PSU&quot;</span>, default=0.1)</div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_DT_DS_WEIGHT&quot;</span>, cs%dT_dS_wt, &amp;</div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;                 <span class="stringliteral">&quot;When forced to extrapolate T &amp; S to match the layer \n&quot;</span>//&amp;</div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;                 <span class="stringliteral">&quot;densities, this factor (in deg C / PSU) is combined \n&quot;</span>//&amp;</div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;                 <span class="stringliteral">&quot;with the derivatives of density with T &amp; S to determine \n&quot;</span>//&amp;</div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;                 <span class="stringliteral">&quot;what direction is orthogonal to density contours. It \n&quot;</span>//&amp;</div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;                 <span class="stringliteral">&quot;should be a typical value of (dR/dS) / (dR/dT) in \n&quot;</span>//&amp;</div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;                 <span class="stringliteral">&quot;oceanic profiles.&quot;</span>, units=<span class="stringliteral">&quot;degC PSU-1&quot;</span>, default=6.0)</div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BUFFER_LAYER_EXTRAP_LIMIT&quot;</span>, cs%BL_extrap_lim, &amp;</div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;                 <span class="stringliteral">&quot;A limit on the density range over which extrapolation \n&quot;</span>//&amp;</div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;                 <span class="stringliteral">&quot;can occur when detraining from the buffer layers, \n&quot;</span>//&amp;</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;                 <span class="stringliteral">&quot;relative to the density range within the mixed and \n&quot;</span>//&amp;</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;                 <span class="stringliteral">&quot;buffer layers, when the detrainment is going into the \n&quot;</span>//&amp;</div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;                 <span class="stringliteral">&quot;lightest interior layer, nondimensional, or a negative \n&quot;</span>//&amp;</div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;                 <span class="stringliteral">&quot;value not to apply this limit.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default = -1.0)</div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEPTH_LIMIT_FLUXES&quot;</span>, cs%H_limit_fluxes, &amp;</div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;                 <span class="stringliteral">&quot;The surface fluxes are scaled away when the total ocean \n&quot;</span>//&amp;</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;                 <span class="stringliteral">&quot;depth is less than DEPTH_LIMIT_FLUXES.&quot;</span>, &amp;</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.1*cs%Hmix_min)</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OMEGA&quot;</span>,cs%omega, &amp;</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;                 <span class="stringliteral">&quot;The rotation rate of the earth.&quot;</span>, units=<span class="stringliteral">&quot;s-1&quot;</span>, &amp;</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;                 default=7.2921e-5)</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_USE_OMEGA&quot;</span>, use_omega, &amp;</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;                 <span class="stringliteral">&quot;If true, use the absolute rotation rate instead of the \n&quot;</span>//&amp;</div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;                 <span class="stringliteral">&quot;vertical component of rotation when setting the decay \n&quot;</span>//&amp;</div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;                 <span class="stringliteral">&quot;scale for turbulence.&quot;</span>, default=.false., do_not_log=.true.)</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;  omega_frac_dflt = 0.0</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;  <span class="keywordflow">if</span> (use_omega) <span class="keywordflow">then</span></div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;ML_USE_OMEGA is depricated; use ML_OMEGA_FRAC=1.0 instead.&quot;</span>)</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;    omega_frac_dflt = 1.0</div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_OMEGA_FRAC&quot;</span>, cs%omega_frac, &amp;</div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;                 <span class="stringliteral">&quot;When setting the decay scale for turbulence, use this \n&quot;</span>//&amp;</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;                 <span class="stringliteral">&quot;fraction of the absolute rotation rate blended with the \n&quot;</span>//&amp;</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                 <span class="stringliteral">&quot;local value of f, as sqrt((1-of)*f^2 + of*4*omega^2).&quot;</span>, &amp;</div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=omega_frac_dflt)</div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_RESORT&quot;</span>, cs%ML_resort, &amp;</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;                 <span class="stringliteral">&quot;If true, resort the topmost layers by potential density \n&quot;</span>//&amp;</div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;                 <span class="stringliteral">&quot;before the mixed layer calculations.&quot;</span>, default=.false.)</div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  <span class="keywordflow">if</span> (cs%ML_resort) &amp;</div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ML_PRESORT_NK_CONV_ADJ&quot;</span>, cs%ML_presort_nz_conv_adj, &amp;</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;                 <span class="stringliteral">&quot;Convectively mix the first ML_PRESORT_NK_CONV_ADJ \n&quot;</span>//&amp;</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;                 <span class="stringliteral">&quot;layers before sorting when ML_RESORT is true.&quot;</span>, &amp;</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0, fail_if_missing=.true.) <span class="comment">! Fail added by AJA.</span></div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;  <span class="comment">! This gives a minimum decay scale that is typically much less than Angstrom.</span></div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;  ustar_min_dflt = 2e-4*cs%omega*(gv%Angstrom_z + gv%H_to_m*gv%H_subroundoff)</div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BML_USTAR_MIN&quot;</span>, cs%ustar_min, &amp;</div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;                 <span class="stringliteral">&quot;The minimum value of ustar that should be used by the \n&quot;</span>//&amp;</div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;                 <span class="stringliteral">&quot;bulk mixed layer model in setting vertical TKE decay \n&quot;</span>//&amp;</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;                 <span class="stringliteral">&quot;scales. This must be greater than 0.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, &amp;</div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;                 default=ustar_min_dflt)</div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;  <span class="keywordflow">if</span> (cs%ustar_min&lt;=0.0) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;BML_USTAR_MIN must be positive.&quot;</span>)</div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RESOLVE_EKMAN&quot;</span>, cs%Resolve_Ekman, &amp;</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;                 <span class="stringliteral">&quot;If true, the NKML&gt;1 layers in the mixed layer are \n&quot;</span>//&amp;</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;                 <span class="stringliteral">&quot;chosen to optimally represent the impact of the Ekman \n&quot;</span>//&amp;</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;                 <span class="stringliteral">&quot;transport on the mixed layer TKE budget.  Otherwise, \n&quot;</span>//&amp;</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;                 <span class="stringliteral">&quot;the sublayers are distributed uniformly through the \n&quot;</span>//&amp;</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;                 <span class="stringliteral">&quot;mixed layer.&quot;</span>, default=.false.)</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CORRECT_ABSORPTION_DEPTH&quot;</span>, cs%correct_absorption, &amp;</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;                 <span class="stringliteral">&quot;If true, the average depth at which penetrating shortwave \n&quot;</span>//&amp;</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;                 <span class="stringliteral">&quot;radiation is absorbed is adjusted to match the average \n&quot;</span>//&amp;</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;                 <span class="stringliteral">&quot;heating depth of an exponential profile by moving some \n&quot;</span>//&amp;</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;                 <span class="stringliteral">&quot;of the heating upward in the water column.&quot;</span>, default=.false.)</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DO_RIVERMIX&quot;</span>, cs%do_rivermix, &amp;</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;                 <span class="stringliteral">&quot;If true, apply additional mixing whereever there is \n&quot;</span>//&amp;</div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;                 <span class="stringliteral">&quot;runoff, so that it is mixed down to RIVERMIX_DEPTH, \n&quot;</span>//&amp;</div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;                 <span class="stringliteral">&quot;if the ocean is that deep.&quot;</span>, default=.false.)</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;  <span class="keywordflow">if</span> (cs%do_rivermix) &amp;</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;RIVERMIX_DEPTH&quot;</span>, cs%rivermix_depth, &amp;</div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;                 <span class="stringliteral">&quot;The depth to which rivers are mixed if DO_RIVERMIX is \n&quot;</span>//&amp;</div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;                 <span class="stringliteral">&quot;defined.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_RIVER_HEAT_CONTENT&quot;</span>, cs%use_river_heat_content, &amp;</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;                 <span class="stringliteral">&quot;If true, use the fluxes%runoff_Hflx field to set the \n&quot;</span>//&amp;</div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;                 <span class="stringliteral">&quot;heat carried by runoff, instead of using SST*CP*liq_runoff.&quot;</span>, &amp;</div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;                 default=.false.)</div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_CALVING_HEAT_CONTENT&quot;</span>, cs%use_calving_heat_content, &amp;</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;                 <span class="stringliteral">&quot;If true, use the fluxes%calving_Hflx field to set the \n&quot;</span>//&amp;</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;                 <span class="stringliteral">&quot;heat carried by runoff, instead of using SST*CP*froz_runoff.&quot;</span>, &amp;</div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;                 default=.false.)</div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;</div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ALLOW_CLOCKS_IN_OMP_LOOPS&quot;</span>, &amp;</div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;                 cs%allow_clocks_in_omp_loops, &amp;</div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;                 <span class="stringliteral">&quot;If true, clocks can be called from inside loops that can \n&quot;</span>//&amp;</div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;                 <span class="stringliteral">&quot;be threaded. To run with multiple threads, set to False.&quot;</span>, &amp;</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;                 default=.true.)</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;  cs%id_ML_depth = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;h_ML&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;      time, <span class="stringliteral">&#39;Surface mixed layer depth&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;  cs%id_TKE_wind = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_wind&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;      time, <span class="stringliteral">&#39;Wind-stirring source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;  cs%id_TKE_RiBulk = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_RiBulk&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;      time, <span class="stringliteral">&#39;Mean kinetic energy source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;  cs%id_TKE_conv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_conv&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;      time, <span class="stringliteral">&#39;Convective source of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;  cs%id_TKE_pen_SW = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_pen_SW&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing penetrative shortwave radation through the mixed layer&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;  cs%id_TKE_mixing = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_mixing&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;      time, <span class="stringliteral">&#39;TKE consumed by mixing that deepens the mixed layer&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;  cs%id_TKE_mech_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_mech_decay&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;      time, <span class="stringliteral">&#39;Mechanical energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;  cs%id_TKE_conv_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_conv_decay&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;      time, <span class="stringliteral">&#39;Convective energy decay sink of mixed layer TKE&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;  cs%id_TKE_conv_s2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;TKE_conv_s2&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;      time, <span class="stringliteral">&#39;Spurious source of mixed layer TKE from sigma2&#39;</span>, <span class="stringliteral">&#39;meter3 second-3&#39;</span>)</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;  cs%id_PE_detrain = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;PE_detrain&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;      time, <span class="stringliteral">&#39;Spurious source of potential energy from mixed layer detrainment&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;  cs%id_PE_detrain2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;PE_detrain2&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;      time, <span class="stringliteral">&#39;Spurious source of potential energy from mixed layer only detrainment&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;  cs%id_h_mismatch = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;h_miss_ML&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;      time, <span class="stringliteral">&#39;Summed absolute mismatch in entrainment terms&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;  cs%id_Hsfc_used = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Hs_used&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;      time, <span class="stringliteral">&#39;Surface region thickness that is used&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;  cs%id_Hsfc_max = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Hs_max&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;      time, <span class="stringliteral">&#39;Maximum surface region thickness&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;  cs%id_Hsfc_min = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Hs_min&#39;</span>, diag%axesT1, &amp;</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;      time, <span class="stringliteral">&#39;Minimum surface region thickness&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160; <span class="comment">!CS%lim_det_dH_sfc = 0.5 ; CS%lim_det_dH_bathy = 0.2 ! Technically these should not get used if limit_det is false?</span></div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;  <span class="keywordflow">if</span> (cs%limit_det .or. (cs%id_Hsfc_min &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LIMIT_BUFFER_DET_DH_SFC&quot;</span>, cs%lim_det_dH_sfc, &amp;</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;                 <span class="stringliteral">&quot;The fractional limit in the change between grid points \n&quot;</span>//&amp;</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;                 <span class="stringliteral">&quot;of the surface region (mixed &amp; buffer layer) thickness.&quot;</span>, &amp;</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.5)</div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LIMIT_BUFFER_DET_DH_BATHY&quot;</span>, cs%lim_det_dH_bathy, &amp;</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;                 <span class="stringliteral">&quot;The fraction of the total depth by which the thickness \n&quot;</span>//&amp;</div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;                 <span class="stringliteral">&quot;of the surface region (mixed &amp; buffer layer) is allowed \n&quot;</span>//&amp;</div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;                 <span class="stringliteral">&quot;to change between grid points.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.2)</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENABLE_THERMODYNAMICS&quot;</span>, use_temperature, &amp;</div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                 <span class="stringliteral">&quot;If true, temperature and salinity are used as state \n&quot;</span>//&amp;</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;                 <span class="stringliteral">&quot;variables.&quot;</span>, default=.true.)</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;  cs%nsw = 0</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;  <span class="keywordflow">if</span> (use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PEN_SW_NBANDS&quot;</span>, cs%nsw, default=1)</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;</div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;</div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;  <span class="keywordflow">if</span> (max(cs%id_TKE_wind, cs%id_TKE_RiBulk, cs%id_TKE_conv, &amp;</div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;          cs%id_TKE_mixing, cs%id_TKE_pen_SW, cs%id_TKE_mech_decay, &amp;</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;          cs%id_TKE_conv_decay) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_wind, isd, ied, jsd, jed)</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_RiBulk, isd, ied, jsd, jed)</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv, isd, ied, jsd, jed)</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_pen_SW, isd, ied, jsd, jed)</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mixing, isd, ied, jsd, jed)</div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_mech_decay, isd, ied, jsd, jed)</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv_decay, isd, ied, jsd, jed)</div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;    <span class="keyword">call </span>safe_alloc_alloc(cs%diag_TKE_conv_s2, isd, ied, jsd, jed)</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;</div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;    cs%TKE_diagnostics = .true.</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;  <span class="keywordflow">if</span> (cs%id_PE_detrain &gt; 0) <span class="keyword">call </span>safe_alloc_alloc(cs%diag_PE_detrain, isd, ied, jsd, jed)</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;  <span class="keywordflow">if</span> (cs%id_PE_detrain2 &gt; 0) <span class="keyword">call </span>safe_alloc_alloc(cs%diag_PE_detrain2, isd, ied, jsd, jed)</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;  <span class="keywordflow">if</span> (cs%id_ML_depth &gt; 0) <span class="keyword">call </span>safe_alloc_alloc(cs%ML_depth, isd, ied, jsd, jed)</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;  <span class="keywordflow">if</span>(cs%allow_clocks_in_omp_loops) <span class="keywordflow">then</span></div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;    id_clock_detrain = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer detrain)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;    id_clock_mech = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer mechanical entrainment)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;    id_clock_conv = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer convection)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;    <span class="keywordflow">if</span> (cs%ML_resort) <span class="keywordflow">then</span></div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;      id_clock_resort = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer resorting)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;      id_clock_adjustment = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer convective adjustment)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;    id_clock_eos = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer EOS)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;</div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;  <span class="keywordflow">if</span> (cs%limit_det .or. (cs%id_Hsfc_min &gt; 0)) &amp;</div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;      id_clock_pass = cpu_clock_id(<span class="stringliteral">&#39;(Ocean mixed layer halo updates)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;</div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;</div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;<span class="comment">!  if (CS%limit_det) then</span></div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;<span class="comment">!  endif</span></div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a7ec83a26f4ae95305e414057235a1e69_icgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ac898a46c7996492a4cd3ee45ebfd1b2e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac898a46c7996492a4cd3ee45ebfd1b2e">&#9670;&nbsp;</a></span>convective_adjustment()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::convective_adjustment </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(out)&#160;</td>
          <td class="paramname"><em>dKE_CA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(out)&#160;</td>
          <td class="paramname"><em>cTKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>nz_conv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does instantaneous convective entrainment into the buffer layers and mixed layers to remove hydrostatic instabilities. Any water that is lighter than currently in the mixed- or buffer- layer is entrained. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">u</td><td>Zonal velocities interpolated to h points, m s-1.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>Zonal velocities interpolated to h points, m s-1.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Layer temperatures, in deg C.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">r0</td><td>Potential density referenced to surface pressure, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rcv</td><td>The coordinate defining potential density, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_eb</td><td>The downward increase across a layer in the entrainment from below, in H. Positive values go with mass gain by a layer.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dke_ca</td><td>The vertically integrated change in kinetic energy due to convective adjustment, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ctke</td><td>The buoyant turbulent kinetic energy source due to convective adjustment, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nz_conv</td><td>If present, the number of layers over which to do convective adjustment (perhaps CSnkml). </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00917">917</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),             <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),           <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">    !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="comment">                                                           !! (Intent in/out)  The units of h are</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="comment">                                                           !! referred to as H below.</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: u<span class="comment">    !&lt; Zonal velocities interpolated to h</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;<span class="comment">                                                           !! points, m s-1.</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: v<span class="comment">    !&lt; Zonal velocities interpolated to h</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">                                                           !! points, m s-1.</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: t<span class="comment">    !&lt; Layer temperatures, in deg C.</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: s</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: r0<span class="comment">   !&lt; Potential density referenced to</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">                                                           !! surface pressure, in kg m-3.</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: rcv<span class="comment">  !&lt; The coordinate defining potential</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">                                                           !! density, in kg m-3.</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: d_eb<span class="comment"> !&lt; The downward increase across a layer</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">                                                           !! in the entrainment from below, in H.</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="comment">                                                           !! Positive values go with mass gain by</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment">                                                           !! a layer.</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>    :: eps</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(out)</span>   :: dke_ca<span class="comment"> !&lt; The vertically integrated change in</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment">                                                           !! kinetic energy due to convective</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment">                                                           !! adjustment, in m3 s-2.</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(out)</span>   :: ctke<span class="comment"> !&lt; The buoyant turbulent kinetic energy</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment">                                                           !! source due to convective adjustment,</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">                                                           !! in m3 s-2.</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: j<span class="comment">    !&lt; The j-index to work on.</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),           <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; The control structure for this module.</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordtype">integer</span>,                 <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: nz_conv<span class="comment"> !&lt; If present, the number of layers</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="comment">                                                           !! over which to do convective adjustment</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">                                                           !! (perhaps CS%nkml).</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="comment">!   This subroutine does instantaneous convective entrainment into the buffer</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="comment">! layers and mixed layers to remove hydrostatic instabilities.  Any water that</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment">! is lighter than currently in the mixed- or buffer- layer is entrained.</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="comment">!                of h are referred to as H below.</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="comment">!  (in/out)  u - Zonal velocities interpolated to h points, m s-1.</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="comment">!  (in/out)  v - Zonal velocities interpolated to h points, m s-1.</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment">!  (in/out)  R0 - Potential density referenced to surface pressure, in kg m-3.</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="comment">!  (in/out)  Rcv - The coordinate defining potential density, in kg m-3.</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment">!  (in/out)  T - Layer temperatures, in deg C.</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="comment">!  (in/out)  S - Layer salinities, in psu.</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment">!  (in/out)  d_eb - The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment">!                   below, in H. Positive values go with mass gain by a layer.</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment">!  (out)     dKE_CA - The vertically integrated change in kinetic energy due</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment">!                     to convective adjustment, in m3 s-2.</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="comment">!  (out)     cTKE - The buoyant turbulent kinetic energy source due to</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment">!                   convective adjustment, in m3 s-2.</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="comment">!  (in)      j - The j-index to work on.</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="comment">!  (in)      ksort - The density-sorted k-indicies.</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="comment">!  (in)      CS - The control structure for this module.</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;<span class="comment">!  (in,opt)  nz_conv - If present, the number of layers over which to do</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="comment">!                      convective adjustment (perhaps CS%nkml).</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    htot, &amp;     <span class="comment">!   The total depth of the layers being considered for</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                <span class="comment">! entrainment, in H.</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    r0_tot, &amp;   <span class="comment">!   The integrated potential density referenced to the surface</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                <span class="comment">! of the layers which are fully entrained, in H kg m-3.</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    rcv_tot, &amp;  <span class="comment">!   The integrated coordinate value potential density of the</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                <span class="comment">! layers that are fully entrained, in H kg m-3.</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    ttot, &amp;     <span class="comment">!   The integrated temperature of layers which are fully</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                <span class="comment">! entrained, in H K.</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    stot, &amp;     <span class="comment">!   The integrated salt of layers which are fully entrained,</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                <span class="comment">! in H PSU.</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    uhtot, &amp;    <span class="comment">!   The depth integrated zonal and meridional velocities in</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    vhtot, &amp;    <span class="comment">! the mixed layer, in H m s-1.</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    ke_orig, &amp;  <span class="comment">!   The total mean kinetic energy in the mixed layer before</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                <span class="comment">! convection, H m2 s-2.</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    h_orig_k1   <span class="comment">!   The depth of layer k1 before convective adjustment, in H.</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  <span class="keywordtype">real</span> :: h_ent <span class="comment">!   The thickness from a layer that is entrained, in H.</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="keywordtype">real</span> :: ih    <span class="comment">!   The inverse of a thickness, in H-1.</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="keywordtype">real</span> :: g_h2_2rho0  <span class="comment">! Half the gravitational acceleration times the</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                      <span class="comment">! square of the conversion from H to m divided</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                      <span class="comment">! by the mean density, in m6 s-2 H-2 kg-1.</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, k1, nzc, nkmb</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  g_h2_2rho0 = (gv%g_Earth * gv%H_to_m**2) / (2.0 * gv%Rho0)</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  nzc = nz ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(nz_conv)) nzc = nz_conv</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment">!   Undergo instantaneous entrainment into the buffer layers and mixed layers</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="comment">! to remove hydrostatic instabilities.  Any water that is lighter than currently</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="comment">! in the layer is entrained.</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;  <span class="keywordflow">do</span> k1=min(nzc-1,nkmb),1,-1</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      h_orig_k1(i) = h(i,k1)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;      ke_orig(i) = 0.5*h(i,k1)*(u(i,k1)**2 + v(i,k1)**2)</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;      uhtot(i) = h(i,k1)*u(i,k1) ; vhtot(i) = h(i,k1)*v(i,k1)</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;      r0_tot(i) = r0(i,k1) * h(i,k1)</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;      ctke(i,k1) = 0.0 ; dke_ca(i,k1) = 0.0</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;      rcv_tot(i) = rcv(i,k1) * h(i,k1)</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;      ttot(i) = t(i,k1) * h(i,k1) ; stot(i) = s(i,k1) * h(i,k1)</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keywordflow">do</span> k=k1+1,nzc</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">if</span> ((h(i,k) &gt; eps(i,k)) .and. (r0_tot(i) &gt; h(i,k1)*r0(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;          h_ent = h(i,k)-eps(i,k)</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;          ctke(i,k1) = ctke(i,k1) + (h_ent * g_h2_2rho0 * &amp;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                   (r0_tot(i) - h(i,k1)*r0(i,k)) * cs%nstar2)</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          <span class="keywordflow">if</span> (k &lt; nkmb) <span class="keywordflow">then</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;            ctke(i,k1) = ctke(i,k1) + ctke(i,k)</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;            dke_ca(i,k1) = dke_ca(i,k1) + dke_ca(i,k)</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;          r0_tot(i) = r0_tot(i) + h_ent * r0(i,k)</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;          ke_orig(i) = ke_orig(i) + 0.5*h_ent* &amp;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;              (u(i,k)*u(i,k) + v(i,k)*v(i,k))</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;          uhtot(i) = uhtot(i) + h_ent*u(i,k)</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;          vhtot(i) = vhtot(i) + h_ent*v(i,k)</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;          rcv_tot(i) = rcv_tot(i) + h_ent * rcv(i,k)</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;          ttot(i) = ttot(i) + h_ent * t(i,k)</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          stot(i) = stot(i) + h_ent * s(i,k)</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;          h(i,k1) = h(i,k1) + h_ent ; h(i,k) = eps(i,k)</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;          d_eb(i,k) = d_eb(i,k) - h_ent</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;          d_eb(i,k1) = d_eb(i,k1) + h_ent</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">! Determine the temperature, salinity, and velocities of the mixed or buffer</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">! layer in question, if it has entrained.</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h(i,k1) &gt; h_orig_k1(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      ih = 1.0 / h(i,k1)</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;      r0(i,k1) = r0_tot(i) * ih</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;      u(i,k1) = uhtot(i) * ih ; v(i,k1) = vhtot(i) * ih</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;      dke_ca(i,k1) = dke_ca(i,k1) + gv%H_to_m * (cs%bulk_Ri_convective * &amp;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;           (ke_orig(i) - 0.5*h(i,k1)*(u(i,k1)**2 + v(i,k1)**2)))</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;      rcv(i,k1) = rcv_tot(i) * ih</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;      t(i,k1) = ttot(i) * ih ; s(i,k1) = stot(i) * ih</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">! If lower mixed or buffer layers are massless, give them the properties of the</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="comment">! layer above.</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  <span class="keywordflow">do</span> k=2,min(nzc,nkmb) ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h(i,k) == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    r0(i,k) = r0(i,k-1)</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    rcv(i,k) = rcv(i,k-1) ; t(i,k) = t(i,k-1) ; s(i,k) = s(i,k-1)</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_ac898a46c7996492a4cd3ee45ebfd1b2e_icgraph.svg" width="572" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a98199335f3bf2b2153c35957d753b867"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a98199335f3bf2b2153c35957d753b867">&#9670;&nbsp;</a></span>ef4()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real function mom_bulk_mixed_layer::ef4 </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>H</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout), optional&#160;</td>
          <td class="paramname"><em>dR_de</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine returns an approximation to the integral R = exp(-L*(H+E)) integral(LH to L(H+E)) L/(1-(1+x)exp(-x)) dx. The approximation to the integrand is good to within -2% at x~.3 and +25% at x~3.5, but the exponential deemphasizes the importance of large x. When L=0, EF4 returns E/((H+E)*H). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Total thickness, in m or kg m-2. (Intent in) The units of h are referred to as H below.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">e</td><td>Entrainment, in units of H.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">l</td><td>The e-folding scale in H-1.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dr_de</td><td>The partial derivative of the result R with E, in H-2. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03920">3920</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01641">mechanical_entrainment()</a>.</p>
<div class="fragment"><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>              :: h<span class="comment"> !&lt; Total thickness, in m or kg m-2. (Intent in) The units of h</span></div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;<span class="comment">                                   !! are referred to as H below.</span></div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>              :: e<span class="comment"> !&lt; Entrainment, in units of H.</span></div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>              :: l<span class="comment"> !&lt; The e-folding scale in H-1.</span></div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span>, <span class="keywordtype">optional</span> :: dr_de<span class="comment"> !&lt; The partial derivative of the result R with E, in H-2.</span></div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;<span class="keywordtype">real</span> :: ef4</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;<span class="comment">! This subroutine returns an approximation to the integral</span></div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;<span class="comment">!   R = exp(-L*(H+E)) integral(LH to L(H+E)) L/(1-(1+x)exp(-x)) dx.</span></div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;<span class="comment">! The approximation to the integrand is good to within -2% at x~.3</span></div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;<span class="comment">! and +25% at x~3.5, but the exponential deemphasizes the importance of</span></div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;<span class="comment">! large x.  When L=0, EF4 returns E/((H+E)*H).</span></div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;<span class="comment">! Arguments: h - Total thickness, in m or kg m-2. (Intent in)  The units</span></div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;<span class="comment">!                of h are referred to as H below.</span></div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;<span class="comment">!  (in)      E - Entrainment, in units of H.</span></div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;<span class="comment">!  (in)      L - The e-folding scale in H-1.</span></div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;<span class="comment">!  (out)     dR_de - the partial derivative of the result R with E, in H-2.</span></div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;<span class="comment">! (return value) R - The integral, in units of H-1.</span></div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;  <span class="keywordtype">real</span> :: exp_lhpe <span class="comment">! A nondimensional exponential decay.</span></div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;  <span class="keywordtype">real</span> :: i_hpe    <span class="comment">! An inverse thickness plus entrainment, in H-1.</span></div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;  <span class="keywordtype">real</span> :: r        <span class="comment">! The result of the integral above, in H-1.</span></div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;  exp_lhpe = exp(-l*(e+h))</div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;  i_hpe = 1.0/(h+e)</div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;  r = exp_lhpe * (e*i_hpe/h - 0.5*l*log(h*i_hpe) + 0.5*l*l*e)</div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">PRESENT</span>(dr_de)) &amp;</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;    dr_de = -l*r + exp_lhpe*(i_hpe*i_hpe + 0.5*l*i_hpe + 0.5*l*l)</div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;  ef4 = r</div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a98199335f3bf2b2153c35957d753b867_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a665aff6a1571290883752364eb5aa129"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a665aff6a1571290883752364eb5aa129">&#9670;&nbsp;</a></span>find_starting_tke()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::find_starting_tke </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>htot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h_CA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Conv_En</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>cTKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dKE_FC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>dKE_CA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>TKE_river</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Idecay_len_TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(2,szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>cMKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Idt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine determines the TKE available at the depth of free convection to drive mechanical entrainment. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">htot</td><td>The accumlated mixed layer thickness, in m or kg m-2. (Intent in).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_ca</td><td>The mixed layer depth after convective adjustment, in H.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields have NULL ptrs.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">conv_en</td><td>The buoyant turbulent kinetic energy source due to free convection, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dke_fc</td><td>The vertically integrated change in kinetic energy due to free convection, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ctke</td><td>The buoyant turbulent kinetic energy</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dke_ca</td><td>The vertically integrated change in</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tke</td><td>The turbulent kinetic energy available for mixing over a time step, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">idecay_len_tke</td><td>The inverse of the vertical decay scale for TKE, in H-1.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">cmke</td><td>Coefficients of HpE and HpE^2 in calculating the denominator of MKE_rate, in H-1 and H-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>The time step in s.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>The density-sorted k-indicies.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01431">1431</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">       !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: htot<span class="comment">    !&lt; The accumlated mixed layer thickness, in m</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;<span class="comment">                                                       !! or kg m-2. (Intent in).</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: h_ca<span class="comment">    !&lt; The mixed layer depth after convective</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;<span class="comment">                                                       !! adjustment, in H.</span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  <span class="keywordtype">type</span>(forcing),              <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment">  !&lt; A structure containing pointers to any</span></div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;<span class="comment">                                                       !! possible forcing fields.  Unused fields</span></div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;<span class="comment">                                                       !! have NULL ptrs.</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(inout)</span> :: conv_en<span class="comment"> !&lt; The buoyant turbulent kinetic energy</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="comment">                                                       !! source due to free convection,</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;<span class="comment">                                                       !! in m3 s-2.</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: dke_fc<span class="comment">  !&lt; The vertically integrated change in</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;<span class="comment">                                                       !! kinetic energy due to free convection,</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;<span class="comment">                                                       !! in m3 s-2.</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;                              <span class="keywordtype">intent(in)</span>    :: ctke<span class="comment">    !&lt; The buoyant turbulent kinetic energy</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;<span class="comment">                                                       !! source due to convective adjustment,</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;<span class="comment">                                                       !! in m3 s-2.</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                              <span class="keywordtype">intent(in)</span>    :: dke_ca<span class="comment">  !&lt; The vertically integrated change in</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;<span class="comment">                                                       !! kinetic energy due to convective</span></div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="comment">                                                       !! adjustment, in m3 s-2.</span></div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(out)</span>   :: tke<span class="comment">     !&lt; The turbulent kinetic energy available for</span></div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="comment">                                                       !! mixing over a time step, in m3 s-2.</span></div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(out)</span>   :: idecay_len_tke<span class="comment"> !&lt; The inverse of the vertical decay</span></div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="comment">                                                       !! scale for TKE, in H-1.</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: tke_river</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(2,SZI_(G))</span>, <span class="keywordtype">intent(out)</span>   :: cmke<span class="comment">    !&lt; Coefficients of HpE and HpE^2 in</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment">                                                       !! calculating the denominator of MKE_rate,</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="comment">                                                       !! in H-1 and H-2.</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordtype">real</span>,                       <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">      !&lt; The time step in s.</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keywordtype">real</span>,                       <span class="keywordtype">intent(in)</span>    :: idt_diag</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <span class="keywordtype">integer</span>,                    <span class="keywordtype">intent(in)</span>    :: j<span class="comment">       !&lt; The j-index to work on.</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                              <span class="keywordtype">intent(in)</span>    :: ksort<span class="comment">   !&lt; The density-sorted k-indicies.</span></div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),    <span class="keywordtype">pointer</span>       :: cs<span class="comment">      !&lt; The control structure for this module.</span></div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">!   This subroutine determines the TKE available at the depth of free</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="comment">! convection to drive mechanical entrainment.</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="comment">! Arguments: htot - The accumlated mixed layer thickness, in m or kg m-2. (Intent in)</span></div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="comment">!                   The units of htot are referred to as H below.</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">!  (in)      h_CA - The mixed layer depth after convective adjustment, in H.</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">!  (in)      fluxes - A structure containing pointers to any possible</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment">!                     forcing fields.  Unused fields have NULL ptrs.</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="comment">!  (in)      Conv_en - The buoyant turbulent kinetic energy source due to</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment">!                      free convection, in m3 s-2.</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment">!  (in)      cTKE - The buoyant turbulent kinetic energy source due to</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment">!                   convective adjustment, in m3 s-2.</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="comment">!  (in)      dKE_FC - The vertically integrated change in kinetic energy due</span></div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment">!                     to free convection, in m3 s-2.</span></div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment">!  (in)      dKE_CA - The vertically integrated change in kinetic energy due</span></div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">!                     to convective adjustment, in m3 s-2.</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="comment">!  (out)     TKE - The turbulent kinetic energy available for mixing over a</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">!                  time step, in m3 s-2.</span></div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment">!  (out)     Idecay_len_TKE - The inverse of the vertical decay scale for</span></div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">!                             TKE, in H-1.</span></div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="comment">!  (out)     cMKE - Coefficients of HpE and HpE^2 in calculating the</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="comment">!                   denominator of MKE_rate, in H-1 and H-2.</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="comment">!  (in)      dt - The time step in s.</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">!  (in)      j - The j-index to work on.</span></div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;<span class="comment">!  (in)      ksort - The density-sorted k-indicies.</span></div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="comment">!  (in)      CS - The control structure for this module.</span></div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;  <span class="keywordtype">real</span> :: dke_conv  <span class="comment">! The change in mean kinetic energy due</span></div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                    <span class="comment">! to all convection, in m3 s-2.</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  <span class="keywordtype">real</span> :: nstar_fc  <span class="comment">! The effective efficiency with which the energy released by</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                    <span class="comment">! free convection is converted to TKE, often ~0.2, ND.</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;  <span class="keywordtype">real</span> :: nstar_ca  <span class="comment">! The effective efficiency with which the energy released by</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                    <span class="comment">! convective adjustment is converted to TKE, often ~0.2, ND.</span></div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="keywordtype">real</span> :: tke_ca    <span class="comment">! The potential energy released by convective adjustment if</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;                    <span class="comment">! that release is positive, in m3 s2.</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <span class="keywordtype">real</span> :: mke_rate_ca <span class="comment">! MKE_rate for convective adjustment, ND, 0 to 1.</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keywordtype">real</span> :: mke_rate_fc <span class="comment">! MKE_rate for free convection, ND, 0 to 1.</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;  <span class="keywordtype">real</span> :: toten     <span class="comment">! The total potential energy released by convection, m3 s-2.</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="keywordtype">real</span> :: ih        <span class="comment">! The inverse of a thickness, in H-1.</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;  <span class="keywordtype">real</span> :: exp_kh    <span class="comment">! The nondimensional decay of TKE across a layer, ND.</span></div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  <span class="keywordtype">real</span> :: absf      <span class="comment">! The absolute value of f averaged to thickness points, s-1.</span></div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;  <span class="keywordtype">real</span> :: u_star    <span class="comment">! The friction velocity in m s-1.</span></div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  <span class="keywordtype">real</span> :: absf_ustar  <span class="comment">! The absolute value of f divided by U_star, in m-1.</span></div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;  <span class="keywordtype">real</span> :: wind_tke_src <span class="comment">! The surface wind source of TKE, in m3 s-3.</span></div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;  <span class="keywordtype">real</span> :: diag_wt   <span class="comment">! The ratio of the current timestep to the diagnostic</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                    <span class="comment">! timestep (which may include 2 calls), ND.</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  diag_wt = dt * idt_diag</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  <span class="keywordflow">if</span> (cs%omega_frac &gt;= 1.0) absf = 2.0*cs%omega</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    u_star = fluxes%ustar(i,j)</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%ustar_shelf) .and. <span class="keyword">associated</span>(fluxes%frac_shelf_h)) <span class="keywordflow">then</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;      <span class="keywordflow">if</span> (fluxes%frac_shelf_h(i,j) &gt; 0.0) &amp;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        u_star = (1.0 - fluxes%frac_shelf_h(i,j)) * u_star + &amp;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                  fluxes%frac_shelf_h(i,j) * fluxes%ustar_shelf(i,j)</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;    <span class="keywordflow">if</span> (u_star &lt; cs%ustar_min) u_star = cs%ustar_min</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;    <span class="keywordflow">if</span> (cs%omega_frac &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;      absf = 0.25*((abs(g%CoriolisBu(i,j)) + abs(g%CoriolisBu(i-1,j-1))) + &amp;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                   (abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i-1,j))))</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;      <span class="keywordflow">if</span> (cs%omega_frac &gt; 0.0) &amp;</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        absf = sqrt(cs%omega_frac*4.0*cs%omega**2 + (1.0-cs%omega_frac)*absf**2)</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    absf_ustar = absf / u_star</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    idecay_len_tke(i) = (absf_ustar * cs%TKE_decay) * gv%H_to_m</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;<span class="comment">!    The first number in the denominator could be anywhere up to 16.  The</span></div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;<span class="comment">!  value of 3 was chosen to minimize the time-step dependence of the amount</span></div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;<span class="comment">!  of shear-driven mixing in 10 days of a 1-degree global model, emphasizing</span></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;<span class="comment">!  the equatorial areas.  Although it is not cast as a parameter, it should</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;<span class="comment">!  be considered an empirical parameter, and it might depend strongly on the</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;<span class="comment">!  number of sublayers in the mixed layer and their locations.</span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;<span class="comment">!  The 0.41 is VonKarman&#39;s constant.  This equation assumes that small &amp; large</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="comment">!  scales contribute to mixed layer deepening at similar rates, even though</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;<span class="comment">!  small scales are dissipated more rapidly (implying they are less efficient).</span></div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;<span class="comment">!     Ih = 1.0/(16.0*0.41*U_star*dt)</span></div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    ih = gv%H_to_m/(3.0*0.41*u_star*dt)</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    cmke(1,i) = 4.0 * ih ; cmke(2,i) = (absf_ustar*gv%H_to_m) * ih</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    <span class="keywordflow">if</span> (idecay_len_tke(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;      exp_kh = exp(-htot(i)*idecay_len_tke(i))</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;      exp_kh = 1.0</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;<span class="comment">! Here nstar is a function of the natural Rossby number  0.2/(1+0.2/Ro), based</span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="comment">! on a curve fit from the data of Wang (GRL, 2003).</span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;<span class="comment">! Note:         Ro = 1.0/sqrt(0.5 * dt * (absf*htot(i))**3 / totEn)</span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="keywordflow">if</span> (conv_en(i) &lt; 0.0) conv_en(i) = 0.0</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="keywordflow">if</span> (ctke(i,1) &gt; 0.0) <span class="keywordflow">then</span> ; tke_ca = ctke(i,1) ; <span class="keywordflow">else</span> ; tke_ca = 0.0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="keywordflow">if</span> ((htot(i) &gt;= h_ca(i)) .or. (tke_ca == 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;      toten = conv_en(i) + tke_ca</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;      <span class="keywordflow">if</span> (toten &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;        nstar_fc = cs%nstar * toten / (toten + 0.2 * &amp;</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;                        sqrt(0.5 * dt * (absf*(htot(i)*gv%H_to_m))**3 * toten))</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;        nstar_fc = cs%nstar</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;      nstar_ca = nstar_fc</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;      <span class="comment">! This reconstructs the Buoyancy flux within the topmost htot of water.</span></div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;      <span class="keywordflow">if</span> (conv_en(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        toten = conv_en(i) + tke_ca * (htot(i) / h_ca(i))</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;       nstar_fc = cs%nstar * toten / (toten + 0.2 * &amp;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;                        sqrt(0.5 * dt * (absf*(htot(i)*gv%H_to_m))**3 * toten))</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        nstar_fc = cs%nstar</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;      toten = conv_en(i) + tke_ca</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;      <span class="keywordflow">if</span> (tke_ca &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        nstar_ca = cs%nstar * toten / (toten + 0.2 * &amp;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;                        sqrt(0.5 * dt * (absf*(h_ca(i)*gv%H_to_m))**3 * toten))</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;        nstar_ca = cs%nstar</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;    <span class="keywordflow">if</span> (dke_fc(i) + dke_ca(i,1) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;      <span class="keywordflow">if</span> (htot(i) &gt;= h_ca(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;        mke_rate_fc = 1.0 / (1.0 + htot(i)*(cmke(1,i) + cmke(2,i)*htot(i)) )</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;        mke_rate_ca = mke_rate_fc</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;        mke_rate_fc = 1.0 / (1.0 + htot(i)*(cmke(1,i) + cmke(2,i)*htot(i)) )</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        mke_rate_ca = 1.0 / (1.0 + h_ca(i)*(cmke(1,i) + cmke(2,i)*h_ca(i)) )</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;      <span class="comment">! This branch just saves unnecessary calculations.</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;      mke_rate_fc = 1.0 ; mke_rate_ca = 1.0</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    dke_conv = dke_ca(i,1) * mke_rate_ca + dke_fc(i) * mke_rate_fc</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="comment">! At this point, it is assumed that cTKE is positive and stored in TKE_CA!</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="comment">! Note: Removed factor of 2 in u*^3 terms.</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    tke(i) = (dt*cs%mstar)*((u_star*u_star*u_star)*exp_kh) + &amp;</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;             (exp_kh * dke_conv + nstar_fc*conv_en(i) + nstar_ca*tke_ca)</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="comment">! Add additional TKE at river mouths</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    <span class="keywordflow">if</span> (cs%do_rivermix) <span class="keywordflow">then</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;      tke(i) = tke(i) + tke_river(i)*dt*exp_kh</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;    <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;      wind_tke_src = cs%mstar*(u_star*u_star*u_star) * diag_wt</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;      cs%diag_TKE_wind(i,j) = cs%diag_TKE_wind(i,j) + &amp;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;          wind_tke_src + tke_river(i) * diag_wt</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;      cs%diag_TKE_RiBulk(i,j) = cs%diag_TKE_RiBulk(i,j) + dke_conv*idt_diag</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;      cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) + &amp;</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;          (exp_kh-1.0)*(wind_tke_src + dke_conv*idt_diag)</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;      cs%diag_TKE_conv(i,j) = cs%diag_TKE_conv(i,j) + &amp;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;          idt_diag*(nstar_fc*conv_en(i) + nstar_ca*tke_ca)</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;      cs%diag_TKE_conv_decay(i,j) = cs%diag_TKE_conv_decay(i,j) + &amp;</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;          idt_diag*((cs%nstar-nstar_fc)*conv_en(i) + (cs%nstar-nstar_ca)*tke_ca)</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;      cs%diag_TKE_conv_s2(i,j) = cs%diag_TKE_conv_s2(i,j) + &amp;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;          idt_diag*(ctke(i,1)-tke_ca)</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a665aff6a1571290883752364eb5aa129_icgraph.svg" width="567" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a18320524267554e0417f02af24ede6c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a18320524267554e0417f02af24ede6c3">&#9670;&nbsp;</a></span>mechanical_entrainment()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::mechanical_entrainment </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>htot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Ttot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Stot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>R0_tot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Rcv_tot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(2,szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>cMKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Idt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>Pen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(in)&#160;</td>
          <td class="paramname"><em>opacity_band</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>Idecay_len_TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine calculates mechanically driven entrainment. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_eb</td><td>The downward increase across a layer in the entrainment from below, in H. Positive values go with mass gain by a layer.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">htot</td><td>The accumlated mixed layer thickness, in H.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ttot</td><td>The depth integrated mixed layer temperature, in deg C H.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">stot</td><td>The depth integrated mixed layer salinity, in psu H.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtot</td><td>The depth integrated mixed layer zonal velocity, H m s-1.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtot</td><td>The integrated mixed layer meridional velocity, H m s-1.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">r0_tot</td><td>The integrated mixed layer potential density referenced to 0 pressure, in H kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rcv_tot</td><td>The integrated mixed layer coordinate variable potential density, in H kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>The number of bands of penetrating shortwave radiation.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pen_sw_bnd</td><td>The penetrating shortwave heating at the sea surface in each penetrating band, in K H, size nsw x <a class="el" href="MOM__memory__macros_8h.html#a778d74c20afedc458a527b6d5ca06fdc">SZI_(G)</a>.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tke</td><td>The turbulent kinetic energy available for mixing over a time step, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>The density-sorted k-indicies.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01641">1641</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03920">ef4()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),             <span class="keywordtype">intent(in)</span>    :: g<span class="comment">       !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),           <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; The ocean&#39;s vertical grid</span></div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="comment">                                                              !! structure.</span></div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">       !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="comment">                                                              !! (Intent in/out)  The units of h are</span></div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="comment">                                                              !! referred to as H below.</span></div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: d_eb<span class="comment">    !&lt; The downward increase across a</span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;<span class="comment">                                                              !! layer in the entrainment from</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="comment">                                                              !! below, in H. Positive values go</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="comment">                                                              !! with mass gain by a layer.</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: htot<span class="comment">    !&lt; The accumlated mixed layer</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="comment">                                                              !! thickness, in H.</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: ttot<span class="comment">    !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="comment">                                                              !! temperature, in deg C H.</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: stot<span class="comment">    !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;<span class="comment">                                                              !! salinity, in psu H.</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: uhtot<span class="comment">   !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="comment">                                                              !! zonal velocity, H m s-1.</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: vhtot<span class="comment">   !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="comment">                                                              !! meridional velocity, H m s-1.</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: r0_tot<span class="comment">  !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="comment">                                                              !! potential density referenced to 0</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="comment">                                                              !! pressure, in H kg m-3.</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: rcv_tot<span class="comment"> !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="comment">                                                              !! coordinate variable potential</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="comment">                                                              !! density, in H kg m-3.</span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>    :: u, v, t, s, r0, rcv, eps</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(in)</span>    :: dr0_dt, drcv_dt</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(2,SZI_(G))</span>,        <span class="keywordtype">intent(in)</span>    :: cmke</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;  <span class="keywordtype">real</span>,                              <span class="keywordtype">intent(in)</span>    :: idt_diag</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment">     !&lt; The number of bands of penetrating</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="comment">                                                              !! shortwave radiation.</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,              <span class="keywordtype">intent(inout)</span> :: pen_sw_bnd<span class="comment"> !&lt; The penetrating shortwave</span></div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="comment">                                                              !! heating at the sea surface in each</span></div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="comment">                                                              !! penetrating band, in K H,</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="comment">                                                              !! size nsw x SZI_(G).</span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,            <span class="keywordtype">intent(in)</span>    :: opacity_band</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: tke<span class="comment">     !&lt; The turbulent kinetic energy</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;<span class="comment">                                                              !! available for mixing over a time</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;<span class="comment">                                                              !! step, in m3 s-2.</span></div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(inout)</span> :: idecay_len_tke</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: j<span class="comment">       !&lt; The j-index to work on.</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;                                     <span class="keywordtype">intent(in)</span>    :: ksort<span class="comment"> !&lt; The density-sorted k-indicies.</span></div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),           <span class="keywordtype">pointer</span>       :: cs<span class="comment">    !&lt; The control structure for this</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="comment">                                                            !! module.</span></div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="comment">! This subroutine calculates mechanically driven entrainment.</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units</span></div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;<span class="comment">!                of h are referred to as H below.</span></div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="comment">!  (in/out)  d_eb - The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;<span class="comment">!                   below, in H. Positive values go with mass gain by a layer.</span></div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="comment">!  (in/out)  htot - The accumlated mixed layer thickness, in H.</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="comment">!  (in/out)  Ttot - The depth integrated mixed layer temperature, in deg C H.</span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="comment">!  (in/out)  Stot - The depth integrated mixed layer salinity, in psu H.</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="comment">!  (in/out)  uhtot - The depth integrated mixed layer zonal velocity, H m s-1.</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="comment">!  (in/out)  vhtot - The integrated mixed layer meridional velocity, H m s-1.</span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="comment">!  (in/out)  R0_tot - The integrated mixed layer potential density referenced</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="comment">!                  to 0 pressure, in H kg m-3.</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="comment">!  (in/out)  Rcv_tot - The integrated mixed layer coordinate variable</span></div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="comment">!                   potential density, in H kg m-3.</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="comment">!  (in)      nsw - The number of bands of penetrating shortwave radiation.</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="comment">!  (in/out)  Pen_SW_bnd - The penetrating shortwave heating at the sea surface</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="comment">!                         in each penetrating band, in K H, size nsw x SZI_(G).</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="comment">!  (in/out)  TKE - The turbulent kinetic energy available for mixing over a</span></div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="comment">!               time step, in m3 s-2.</span></div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="comment">!  (in)      j - The j-index to work on.</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="comment">!  (in)      ksort - The density-sorted k-indicies.</span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="comment">!  (in)      CS - The control structure for this module.</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="keywordtype">real</span> :: sw_trans  <span class="comment">!   The fraction of shortwave radiation that is not</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;                    <span class="comment">! absorbed in a layer, nondimensional.</span></div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;  <span class="keywordtype">real</span> :: pen_absorbed  <span class="comment">!   The amount of penetrative shortwave radiation</span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;                        <span class="comment">! that is absorbed in a layer, in units of K m.</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  <span class="keywordtype">real</span> :: h_avail   <span class="comment">! The thickness in a layer available for entrainment in H.</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;  <span class="keywordtype">real</span> :: h_ent     <span class="comment">! The thickness from a layer that is entrained, in H.</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;  <span class="keywordtype">real</span> :: h_min, h_max <span class="comment">! Limits on the solution for h_ent, in H.</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;  <span class="keywordtype">real</span> :: dh_newt      <span class="comment">!   The Newton&#39;s method estimate of the change in</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;                       <span class="comment">! h_ent between iterations, in H.</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;  <span class="keywordtype">real</span> :: mke_rate  <span class="comment">!   The fraction of the energy in resolved shears</span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;                    <span class="comment">! within the mixed layer that will be eliminated</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;                    <span class="comment">! within a timestep, nondim, 0 to 1.</span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;  <span class="keywordtype">real</span> :: hpe       <span class="comment">!   The current thickness plus entrainment, H.</span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;  <span class="keywordtype">real</span> :: g_h_2rho0   <span class="comment">!   Half the gravitational acceleration times the</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;                      <span class="comment">! conversion from H to m divided by the mean density,</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                      <span class="comment">! in m5 s-2 H-1 kg-1.</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;  <span class="keywordtype">real</span> :: tke_full_ent  <span class="comment">! The TKE remaining if a layer is fully entrained,</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;                        <span class="comment">! in units of m3 s-2.</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;  <span class="keywordtype">real</span> :: drl       <span class="comment">! Work required to mix water from the next layer</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;                    <span class="comment">! across the mixed layer, in m2 s-2.</span></div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;  <span class="keywordtype">real</span> :: pen_en_contrib  <span class="comment">! Penetrating SW contributions to the changes in</span></div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;                          <span class="comment">! TKE, divided by layer thickness in m, in m2 s-2.</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;  <span class="keywordtype">real</span> :: c1        <span class="comment">! A temporary variable in units of m2 s-2.</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  <span class="keywordtype">real</span> :: dmke      <span class="comment">! A temporary variable related to the release of mean</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;                    <span class="comment">! kinetic energy, with units of H m3 s-2.</span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  <span class="keywordtype">real</span> :: tke_ent   <span class="comment">! The TKE that remains if h_ent were entrained, in m3 s-2.</span></div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;  <span class="keywordtype">real</span> :: tke_ent1  <span class="comment">! The TKE that would remain, without considering the</span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;                    <span class="comment">! release of mean kinetic energy, in m3 s2.</span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;  <span class="keywordtype">real</span> :: dtke_dh   <span class="comment">! The partial derivative of TKE with h_ent, in m3 s-2 H-1.</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;  <span class="keywordtype">real</span> :: pen_dtke_dh_contrib <span class="comment">! The penetrating shortwave contribution to</span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;                    <span class="comment">! dTKE_dh, in m2 s-2.</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;  <span class="keywordtype">real</span> :: ef4_val   <span class="comment">! The result of EF4() (see later), in H-1.</span></div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;  <span class="keywordtype">real</span> :: h_neglect <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                    <span class="comment">! in roundoff and can be neglected, in H.</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;  <span class="keywordtype">real</span> :: def4_dh   <span class="comment">! The partial derivative of EF4 with h, in H-2.</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;  <span class="keywordtype">real</span> :: pen_en1   <span class="comment">! A nondimensional temporary variable.</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;  <span class="keywordtype">real</span> :: kh, exp_kh  <span class="comment">! Nondimensional temporary variables related to the.</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;  <span class="keywordtype">real</span> :: f1_kh       <span class="comment">! fractional decay of TKE across a layer.</span></div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;  <span class="keywordtype">real</span> :: x1, e_x1      <span class="comment">!   Nondimensional temporary variables related to</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;  <span class="keywordtype">real</span> :: f1_x1, f2_x1  <span class="comment">! the relative decay of TKE and SW radiation across</span></div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;  <span class="keywordtype">real</span> :: f3_x1         <span class="comment">! a layer, and exponential-related functions of x1.</span></div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;  <span class="keywordtype">real</span> :: e_hxhpe   <span class="comment">! Entrainment divided by the product of the new and old</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                    <span class="comment">! thicknesses, in H-1.</span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;  <span class="keywordtype">real</span> :: hmix_min  <span class="comment">! The minimum mixed layer depth in H.</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  <span class="keywordtype">real</span> :: h_to_m    <span class="comment">! Local copies of unit conversion factors.</span></div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;  <span class="keywordtype">real</span> :: opacity</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;  <span class="keywordtype">real</span> :: c1_3, c1_6, c1_24   <span class="comment">!  1/3, 1/6, and 1/24.</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, itt, n</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;  c1_3 = 1.0/3.0 ; c1_6 = 1.0/6.0 ; c1_24 = 1.0/24.0</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;  h_to_m = gv%H_to_m</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;  g_h_2rho0 = (gv%g_Earth * h_to_m) / (2.0 * gv%Rho0)</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;  hmix_min = cs%Hmix_min * gv%m_to_H</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;  <span class="keywordflow">do</span> ks=1,nz</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (ksort(i,ks) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;      k = ksort(i,ks)</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;      h_avail = h(i,k) - eps(i,k)</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;      <span class="keywordflow">if</span> ((h_avail &gt; 0.) .and. ((tke(i) &gt; 0.) .or. (htot(i) &lt; hmix_min))) <span class="keywordflow">then</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;        drl = g_h_2rho0 * (r0(i,k)*htot(i) - r0_tot(i) )</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        dmke = (h_to_m * cs%bulk_Ri_ML) * 0.5 * &amp;</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;            ((uhtot(i)-u(i,k)*htot(i))**2 + (vhtot(i)-v(i,k)*htot(i))**2)</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="comment">! Find the TKE that would remain if the entire layer were entrained.</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;        kh = idecay_len_tke(i)*h_avail ; exp_kh = exp(-kh)</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <span class="keywordflow">if</span> (kh &gt;= 2.0e-5) <span class="keywordflow">then</span> ; f1_kh = (1.0-exp_kh) / kh</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;        <span class="keywordflow">else</span> ; f1_kh = (1.0 - kh*(0.5 - c1_6*kh)) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;        pen_en_contrib = 0.0</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;        <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;          opacity = opacity_band(n,i,k)</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="comment">! Two different forms are used here to make sure that only negative</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;<span class="comment">! values are taken into exponentials to avoid excessively large</span></div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="comment">! numbers.  They are, of course, mathematically identical.</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;          <span class="keywordflow">if</span> (idecay_len_tke(i) &gt; opacity) <span class="keywordflow">then</span></div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;            x1 = (idecay_len_tke(i) - opacity) * h_avail</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;            <span class="keywordflow">if</span> (x1 &gt;= 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;              e_x1 = exp(-x1) ; f1_x1 = ((1.0-e_x1)/(x1))</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;              f3_x1 = ((e_x1-(1.0-x1))/(x1*x1))</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;              f1_x1 = (1.0 - x1*(0.5 - c1_6*x1))</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;              f3_x1 = (0.5 - x1*(c1_6 - c1_24*x1))</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;            pen_en1 = exp(-opacity*h_avail) * &amp;</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;               ((1.0+opacity*htot(i))*f1_x1 + opacity*h_avail*f3_x1)</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;            x1 = (opacity - idecay_len_tke(i)) * h_avail</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;            <span class="keywordflow">if</span> (x1 &gt;= 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;              e_x1 = exp(-x1) ; f1_x1 = ((1.0-e_x1)/(x1))</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;              f2_x1 = ((1.0-(1.0+x1)*e_x1)/(x1*x1))</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;              f1_x1 = (1.0 - x1*(0.5 - c1_6*x1))</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;              f2_x1 = (0.5 - x1*(c1_3 - 0.125*x1))</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;            pen_en1 = exp_kh * ((1.0+opacity*htot(i))*f1_x1 + &amp;</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;                                 opacity*h_avail*f2_x1)</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;          pen_en_contrib = pen_en_contrib + &amp;</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;            (g_h_2rho0*dr0_dt(i)*pen_sw_bnd(n,i)) * (pen_en1 - f1_kh)</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        hpe = htot(i)+h_avail</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        mke_rate = 1.0/(1.0 + (cmke(1,i)*hpe + cmke(2,i)*hpe**2))</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        ef4_val = ef4(htot(i)+h_neglect,h_avail,idecay_len_tke(i))</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        tke_full_ent = (exp_kh*tke(i) - (h_avail*h_to_m)*(drl*f1_kh + pen_en_contrib)) + &amp;</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;            mke_rate*dmke*ef4_val</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;        <span class="keywordflow">if</span> ((tke_full_ent &gt;= 0.0) .or. (h_avail+htot(i) &lt;= hmix_min)) <span class="keywordflow">then</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;          <span class="comment">! The layer will be fully entrained.</span></div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;          h_ent = h_avail</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;          <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;            e_hxhpe = h_ent / ((htot(i)+h_neglect)*(htot(i)+h_ent+h_neglect))</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;            cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) + &amp;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;                idt_diag * ((exp_kh-1.0)*tke(i) + &amp;</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;                            (h_ent*h_to_m)*drl*(1.0-f1_kh) + &amp;</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;                            mke_rate*dmke*(ef4_val-e_hxhpe))</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;            cs%diag_TKE_mixing(i,j) = cs%diag_TKE_mixing(i,j) - &amp;</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;                idt_diag*(h_to_m*h_ent)*drl</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;            cs%diag_TKE_pen_SW(i,j) = cs%diag_TKE_pen_SW(i,j) - &amp;</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;                idt_diag*(h_to_m*h_ent)*pen_en_contrib</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;            cs%diag_TKE_RiBulk(i,j) = cs%diag_TKE_RiBulk(i,j) + &amp;</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;                idt_diag*mke_rate*dmke*e_hxhpe</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;          tke(i) = tke_full_ent</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;          <span class="keywordflow">if</span> (tke(i) &lt;= 0.0) tke(i) = 1e-300</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="comment">! The layer is only partially entrained.  The amount that will be</span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="comment">! entrained is determined iteratively.  No further layers will be</span></div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="comment">! entrained.</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;          h_min = 0.0 ; h_max = h_avail</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;          <span class="keywordflow">if</span> (tke(i) &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;            h_ent = 0.0</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;            h_ent = h_avail * tke(i) / (tke(i) - tke_full_ent)</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;            <span class="keywordflow">do</span> itt=1,15</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;              <span class="comment">! Evaluate the TKE that would remain if h_ent were entrained.</span></div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;              kh = idecay_len_tke(i)*h_ent ; exp_kh = exp(-kh)</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;              <span class="keywordflow">if</span> (kh &gt;= 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;                f1_kh = (1.0-exp_kh) / kh</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;                f1_kh = (1.0 - kh*(0.5 - c1_6*kh))</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;              pen_en_contrib = 0.0 ; pen_dtke_dh_contrib = 0.0</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;              <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;                <span class="comment">! Two different forms are used here to make sure that only negative</span></div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                <span class="comment">! values are taken into exponentials to avoid excessively large</span></div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;                <span class="comment">! numbers.  They are, of course, mathematically identical.</span></div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;                opacity = opacity_band(n,i,k)</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;                sw_trans = exp(-h_ent*opacity)</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;                <span class="keywordflow">if</span> (idecay_len_tke(i) &gt; opacity) <span class="keywordflow">then</span></div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;                  x1 = (idecay_len_tke(i) - opacity) * h_ent</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;                  <span class="keywordflow">if</span> (x1 &gt;= 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;                    e_x1 = exp(-x1) ; f1_x1 = ((1.0-e_x1)/(x1))</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;                    f3_x1 = ((e_x1-(1.0-x1))/(x1*x1))</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;                  <span class="keywordflow">else</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;                    f1_x1 = (1.0 - x1*(0.5 - c1_6*x1))</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;                    f3_x1 = (0.5 - x1*(c1_6 - c1_24*x1))</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;<span class="keywordflow">                  endif</span></div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;                  pen_en1 = sw_trans * ((1.0+opacity*htot(i))*f1_x1 + &amp;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;                                          opacity*h_ent*f3_x1)</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;                  x1 = (opacity - idecay_len_tke(i)) * h_ent</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;                  <span class="keywordflow">if</span> (x1 &gt;= 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;                    e_x1 = exp(-x1) ; f1_x1 = ((1.0-e_x1)/(x1))</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;                    f2_x1 = ((1.0-(1.0+x1)*e_x1)/(x1*x1))</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;                  <span class="keywordflow">else</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;                    f1_x1 = (1.0 - x1*(0.5 - c1_6*x1))</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;                    f2_x1 = (0.5 - x1*(c1_3 - 0.125*x1))</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="keywordflow">                  endif</span></div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;                  pen_en1 = exp_kh * ((1.0+opacity*htot(i))*f1_x1 + &amp;</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;                                        opacity*h_ent*f2_x1)</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;                c1 = g_h_2rho0*dr0_dt(i)*pen_sw_bnd(n,i)</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;                pen_en_contrib = pen_en_contrib + c1*(pen_en1 - f1_kh)</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;                pen_dtke_dh_contrib = pen_dtke_dh_contrib + &amp;</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;                           c1*((1.0-sw_trans) - opacity*(htot(i) + h_ent)*sw_trans)</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="keywordflow">              endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! (Pen_SW_bnd(n,i) &gt; 0.0)</span></div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;              tke_ent1 = exp_kh*tke(i) - (h_ent*h_to_m)*(drl*f1_kh + pen_en_contrib)</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;              ef4_val = ef4(htot(i)+h_neglect,h_ent,idecay_len_tke(i),def4_dh)</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;              hpe = htot(i)+h_ent</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;              mke_rate = 1.0/(1.0 + (cmke(1,i)*hpe + cmke(2,i)*hpe**2))</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;              tke_ent = tke_ent1 + dmke*ef4_val*mke_rate</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;              <span class="comment">! TKE_ent is the TKE that would remain if h_ent were entrained.</span></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;              dtke_dh = ((-idecay_len_tke(i)*tke_ent1 - drl*h_to_m) + &amp;</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;                         pen_dtke_dh_contrib*h_to_m) + dmke * mke_rate* &amp;</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;                       (def4_dh - ef4_val*mke_rate*(cmke(1,i)+2.0*cmke(2,i)*hpe))</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;              <span class="comment">!  dh_Newt = -TKE_ent / dTKE_dh</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;              <span class="comment">! Bisect if the Newton&#39;s method prediction is outside of the bounded range.</span></div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;              <span class="keywordflow">if</span> (tke_ent &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;                <span class="keywordflow">if</span> ((h_max-h_ent)*(-dtke_dh) &gt; tke_ent) <span class="keywordflow">then</span></div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;                  dh_newt = -tke_ent / dtke_dh</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;                  dh_newt = 0.5*(h_max-h_ent)</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;                h_min = h_ent</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;                <span class="keywordflow">if</span> ((h_min-h_ent)*(-dtke_dh) &lt; tke_ent) <span class="keywordflow">then</span></div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;                  dh_newt = -tke_ent / dtke_dh</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;                  dh_newt = 0.5*(h_min-h_ent)</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;                h_max = h_ent</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;              h_ent = h_ent + dh_newt</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;              <span class="keywordflow">if</span> (abs(dh_newt) &lt; 0.2*gv%Angstrom) <span class="keywordflow">exit</span></div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;          <span class="keywordflow">if</span> (h_ent &lt; hmix_min-htot(i)) h_ent = hmix_min - htot(i)</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;          <span class="keywordflow">if</span> (cs%TKE_diagnostics) <span class="keywordflow">then</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;            hpe = htot(i)+h_ent</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;            mke_rate = 1.0/(1.0 + cmke(1,i)*hpe + cmke(2,i)*hpe**2)</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;            ef4_val = ef4(htot(i)+h_neglect,h_ent,idecay_len_tke(i))</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;            e_hxhpe = h_ent / ((htot(i)+h_neglect)*(hpe+h_neglect))</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;            cs%diag_TKE_mech_decay(i,j) = cs%diag_TKE_mech_decay(i,j) + &amp;</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;                idt_diag * ((exp_kh-1.0)*tke(i) + &amp;</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;                            (h_ent*h_to_m)*drl*(1.0-f1_kh) + &amp;</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;                             dmke*mke_rate*(ef4_val-e_hxhpe))</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;            cs%diag_TKE_mixing(i,j) = cs%diag_TKE_mixing(i,j) - &amp;</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;                idt_diag*(h_ent*h_to_m)*drl</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;            cs%diag_TKE_pen_SW(i,j) = cs%diag_TKE_pen_SW(i,j) - &amp;</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;                idt_diag*(h_ent*h_to_m)*pen_en_contrib</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;            cs%diag_TKE_RiBulk(i,j) = cs%diag_TKE_RiBulk(i,j) + &amp;</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;                idt_diag*dmke*mke_rate*e_hxhpe</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;          tke(i) = 0.0</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="keywordflow">        endif</span> <span class="comment">! TKE_full_ent &gt; 0.0</span></div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        pen_absorbed = 0.0</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;        <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;          sw_trans = exp(-h_ent*opacity_band(n,i,k))</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;          pen_absorbed = pen_absorbed + pen_sw_bnd(n,i) * (1.0 - sw_trans)</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;          pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        htot(i)   = htot(i)   + h_ent</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;        r0_tot(i) = r0_tot(i) + (h_ent * r0(i,k) + pen_absorbed*dr0_dt(i))</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        h(i,k)    = h(i,k)    - h_ent</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;        d_eb(i,k) = d_eb(i,k) - h_ent</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        stot(i)    = stot(i)    + h_ent * s(i,k)</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        ttot(i)    = ttot(i)    + (h_ent * t(i,k) + pen_absorbed)</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        rcv_tot(i) = rcv_tot(i) + (h_ent*rcv(i,k) + pen_absorbed*drcv_dt(i))</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        uhtot(i) = uhtot(i) + u(i,k)*h_ent</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        vhtot(i) = vhtot(i) + v(i,k)*h_ent</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! h_avail &gt; 0.0 .AND TKE(i) &gt; 0.0</span></div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i loop</span></div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k loop</span></div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a18320524267554e0417f02af24ede6c3_cgraph.svg" width="415" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a18320524267554e0417f02af24ede6c3_icgraph.svg" width="579" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a071010a461d5ae9440b063aadf4e2f88"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a071010a461d5ae9440b063aadf4e2f88">&#9670;&nbsp;</a></span>mixedlayer_convection()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::mixedlayer_convection </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>htot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Ttot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Stot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>uhtot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>vhtot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>R0_tot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Rcv_tot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>netMassInOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>netMassOut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>Net_heat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>Net_salt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>Pen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(in)&#160;</td>
          <td class="paramname"><em>opacity_band</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>Conv_en</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(out)&#160;</td>
          <td class="paramname"><em>dKE_FC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>aggregate_FW_forcing</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine causes the mixed layer to entrain to the depth of free convection. The depth of free convection is the shallowest depth at which the fluid is denser than the average of the fluid above. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_eb</td><td>The downward increase across a layer in the entrainment from below , in H. Positive values go with mass gain by a layer.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">htot</td><td>The accumulated mixed layer thickness, in H.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ttot</td><td>The depth integrated mixed layer temperature, in deg C H.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">stot</td><td>The depth integrated mixed layer salinity, in psu H.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">uhtot</td><td>The depth integrated mixed layer zonal velocity, H m s-1.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">vhtot</td><td>The integrated mixed layer meridional velocity, H m s-1.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">r0_tot</td><td>The integrated mixed layer potential density referenced to 0 pressure, in kg m-2.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">rcv_tot</td><td>The integrated mixed layer coordinate variable potential density, in kg m-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>The number of bands of penetrating shortwave radiation.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pen_sw_bnd</td><td>The penetrating shortwave heating at the sea surface in each penetrating band, in K H, size nsw x <a class="el" href="MOM__memory__macros_8h.html#a778d74c20afedc458a527b6d5ca06fdc">SZI_(G)</a>.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">conv_en</td><td>The buoyant turbulent kinetic energy source due to free convection, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">dke_fc</td><td>The vertically integrated change in kinetic energy due to free convection, in m3 s-2.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The j-index to work on.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>The density-sorted k-indices.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01073">1073</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),             <span class="keywordtype">intent(in)</span>    :: g<span class="comment">       !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),           <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; The ocean&#39;s vertical grid</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">                                                              !! structure.</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">       !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">                                                              !! (Intent in/out)  The units of h are</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment">                                                              !! referred to as H below.</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: d_eb<span class="comment">    !&lt; The downward increase across a</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment">                                                              !! layer in the entrainment from below</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment">                                                              !! , in H. Positive values go with</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">                                                              !! mass gain by a layer.</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: htot<span class="comment">    !&lt; The accumulated mixed layer</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">                                                              !! thickness, in H.</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: ttot<span class="comment">    !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">                                                              !! temperature, in deg C H.</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: stot<span class="comment">    !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment">                                                              !! salinity, in psu H.</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: uhtot<span class="comment">   !&lt; The depth integrated mixed layer</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="comment">                                                              !! zonal velocity, H m s-1.</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: vhtot<span class="comment">   !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment">                                                              !! meridional velocity, H m s-1.</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: r0_tot<span class="comment">  !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="comment">                                                              !! potential density referenced to 0</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="comment">                                                              !! pressure, in kg m-2.</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: rcv_tot<span class="comment"> !&lt; The integrated mixed layer</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="comment">                                                              !! coordinate variable potential</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="comment">                                                              !! density, in kg m-2.</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>    :: u, v, t, s, r0, rcv, eps</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(in)</span>    :: dr0_dt, drcv_dt, dr0_ds, drcv_ds</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(in)</span>    :: netmassinout, netmassout</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(in)</span>    :: net_heat, net_salt</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment">     !&lt; The number of bands of penetrating</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="comment">                                                              !! shortwave radiation.</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,              <span class="keywordtype">intent(inout)</span> :: pen_sw_bnd<span class="comment"> !&lt; The penetrating shortwave</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="comment">                                                              !! heating at the sea surface in each</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="comment">                                                              !! penetrating band, in K H,</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;<span class="comment">                                                              !! size nsw x SZI_(G).</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,            <span class="keywordtype">intent(in)</span>    :: opacity_band</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: conv_en<span class="comment"> !&lt; The buoyant turbulent kinetic</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="comment">                                                              !! energy source due to free</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="comment">                                                              !! convection, in m3 s-2.</span></div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,          <span class="keywordtype">intent(out)</span>   :: dke_fc<span class="comment">  !&lt; The vertically integrated change</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="comment">                                                              !! in kinetic energy due to free</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="comment">                                                              !! convection, in m3 s-2.</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <span class="keywordtype">integer</span>,                           <span class="keywordtype">intent(in)</span>    :: j<span class="comment">       !&lt; The j-index to work on.</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, &amp;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                                     <span class="keywordtype">intent(in)</span>    :: ksort<span class="comment">   !&lt; The density-sorted k-indices.</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),           <span class="keywordtype">pointer</span>       :: cs<span class="comment">      !&lt; The control structure for this</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="comment">                                                              !! module.</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),             <span class="keywordtype">intent(inout)</span> :: tv</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keywordtype">type</span>(forcing),                     <span class="keywordtype">intent(inout)</span> :: fluxes</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="keywordtype">real</span>,                              <span class="keywordtype">intent(in)</span>    :: dt</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keywordtype">logical</span>,                           <span class="keywordtype">intent(in)</span>    :: aggregate_fw_forcing</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="comment">!   This subroutine causes the mixed layer to entrain to the depth of free</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="comment">! convection.  The depth of free convection is the shallowest depth at which the</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment">! fluid is denser than the average of the fluid above.</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="comment">!                of h are referred to as H below.</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="comment">!  (in/out)  d_eb - The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="comment">!                   below, in H. Positive values go with mass gain by a layer.</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment">!  (out)     htot - The accumulated mixed layer thickness, in H.</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment">!  (out)     Ttot - The depth integrated mixed layer temperature, in deg C H.</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="comment">!  (out)     Stot - The depth integrated mixed layer salinity, in psu H.</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="comment">!  (out)     uhtot - The depth integrated mixed layer zonal velocity, H m s-1.</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="comment">!  (out)     vhtot - The integrated mixed layer meridional velocity, H m s-1.</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="comment">!  (out)     R0_tot - The integrated mixed layer potential density referenced</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">!                     to 0 pressure, in kg m-2.</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="comment">!  (out)     Rcv_tot - The integrated mixed layer coordinate variable</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment">!                      potential density, in kg m-2.</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;<span class="comment">!  (in)      nsw - The number of bands of penetrating shortwave radiation.</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="comment">!  (out)     Pen_SW_bnd - The penetrating shortwave heating at the sea surface</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="comment">!                         in each penetrating band, in K H, size nsw x SZI_(G).</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="comment">!  (out)     Conv_en - The buoyant turbulent kinetic energy source due to</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="comment">!                      free convection, in m3 s-2.</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="comment">!  (out)     dKE_FC - The vertically integrated change in kinetic energy due</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="comment">!                     to free convection, in m3 s-2.</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="comment">!  (in)      j - The j-index to work on.</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment">!  (in)      ksort - The density-sorted k-indices.</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment">!  (in)      CS - The control structure for this module.</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    massoutrem, &amp;      <span class="comment">!   Evaporation that remains to be supplied, in H.</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    netmassin          <span class="comment">! mass entering through ocean surface (H)</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="keywordtype">real</span> :: sw_trans     <span class="comment">!   The fraction of shortwave radiation</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                       <span class="comment">! that is not absorbed in a layer, ND.</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  <span class="keywordtype">real</span> :: pen_absorbed <span class="comment">!   The amount of penetrative shortwave radiation</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                       <span class="comment">! that is absorbed in a layer, in units of K H.</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;  <span class="keywordtype">real</span> :: h_avail      <span class="comment">!   The thickness in a layer available for</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                       <span class="comment">! entrainment, in H.</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="keywordtype">real</span> :: h_ent        <span class="comment">!   The thickness from a layer that is entrained, in H.</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="keywordtype">real</span> :: t_precip     <span class="comment">!   The temperature of the precipitation, in deg C.</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="keywordtype">real</span> :: c1_3, c1_6   <span class="comment">!  1/3 and 1/6.</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keywordtype">real</span> :: en_fn, frac, x1 <span class="comment">!  Nondimensional temporary variables.</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keywordtype">real</span> :: dr, dr0      <span class="comment">! Temporary variables with units of kg m-3 H.</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="keywordtype">real</span> :: dr_ent, dr_comp <span class="comment">! Temporary variables with units of kg m-3 H.</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="keywordtype">real</span> :: dr_dh        <span class="comment">! The partial derivative of dr_ent with h_ent, in kg m-3.</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="keywordtype">real</span> :: h_min, h_max <span class="comment">!   The minimum, maximum, and previous estimates for</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  <span class="keywordtype">real</span> :: h_prev       <span class="comment">! h_ent, in H.</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  <span class="keywordtype">real</span> :: h_evap       <span class="comment">!   The thickness that is evaporated, in H.</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="keywordtype">real</span> :: dh_newt      <span class="comment">!   The Newton&#39;s method estimate of the change in</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                       <span class="comment">! h_ent between iterations, in H.</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="keywordtype">real</span> :: g_h2_2rho0   <span class="comment">!   Half the gravitational acceleration times the</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                       <span class="comment">! square of the conversion from H to m divided</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                       <span class="comment">! by the mean density, in m6 s-2 H-2 kg-1.</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="keywordtype">real</span> :: angstrom     <span class="comment">!   The minimum layer thickness, in H.</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  <span class="keywordtype">real</span> :: opacity      <span class="comment">!   The opacity converted to units of H-1.</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="keywordtype">real</span> :: sum_pen_en   <span class="comment">!   The potential energy change due to penetrating</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;                       <span class="comment">! shortwave radiation, integrated over a layer, in</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                       <span class="comment">! H kg m-3.</span></div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="keywordtype">real</span> :: idt          <span class="comment">! 1.0/dt</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="keywordtype">real</span> :: netheatout   <span class="comment">! accumulated heat content of mass leaving ocean</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, itt, n</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(max(nsw,1))</span> :: &amp;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    c2, &amp;              <span class="comment">! Temporary variable with units of kg m-3 H-1.</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    r_sw_top           <span class="comment">! Temporary variables with units of H kg m-3.</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  angstrom = gv%Angstrom</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  c1_3 = 1.0/3.0 ; c1_6 = 1.0/6.0</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  g_h2_2rho0 = (gv%g_Earth * gv%H_to_m**2) / (2.0 * gv%Rho0)</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  idt        = 1.0/dt</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (ksort(i,1) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    k = ksort(i,1)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <span class="keywordflow">if</span> (aggregate_fw_forcing) <span class="keywordflow">then</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      massoutrem(i) = 0.0</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;      <span class="keywordflow">if</span> (netmassinout(i) &lt; 0.0) massoutrem(i) = -netmassinout(i)</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      netmassin(i) = netmassinout(i) + massoutrem(i)</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;      massoutrem(i) = -netmassout(i)</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;      netmassin(i)  = netmassinout(i) - netmassout(i)</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="comment">! htot is an Angstrom (taken from layer 1) plus any net precipitation.</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    h_ent     = max(min(angstrom,h(i,k)-eps(i,k)),0.0)</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    htot(i)   = h_ent + netmassin(i)</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    h(i,k)    = h(i,k) - h_ent</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    d_eb(i,k) = d_eb(i,k) - h_ent</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    pen_absorbed = 0.0</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;      sw_trans        = exp(-htot(i)*opacity_band(n,i,k))</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;      pen_absorbed    = pen_absorbed + pen_sw_bnd(n,i) * (1.0-sw_trans)</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;      pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <span class="comment">! Precipitation is assumed to have the same temperature and velocity</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <span class="comment">! as layer 1.  Because layer 1 might not be the topmost layer, this</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <span class="comment">! involves multiple terms.</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    t_precip = t(i,1)</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    ttot(i) = (net_heat(i) + (netmassin(i) * t_precip + h_ent * t(i,k))) + &amp;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;              pen_absorbed</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="comment">! Net_heat contains both heat fluxes and the heat content of mass fluxes.</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160; <span class="comment">!! Ttot(i) = netMassIn(i) * T_precip + h_ent * T(i,k)</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160; <span class="comment">!! Ttot(i) = Net_heat(i) + Ttot(i)</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160; <span class="comment">!! Ttot(i) = Ttot(i) + Pen_absorbed</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <span class="comment">! smg:</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <span class="comment">! Ttot(i)   = (Net_heat(i) + (h_ent * T(i,k))) + Pen_absorbed</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    stot(i)   = h_ent*s(i,k) + net_salt(i)</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    uhtot(i)  = u(i,1)*netmassin(i) + u(i,k)*h_ent</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    vhtot(i)  = v(i,1)*netmassin(i) + v(i,k)*h_ent</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    r0_tot(i) = (h_ent*r0(i,k) + netmassin(i)*r0(i,1)) + &amp;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="comment">!                   dR0_dT(i)*netMassIn(i)*(T_precip - T(i,1)) + &amp;</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                (dr0_dt(i)*(net_heat(i) + pen_absorbed) - &amp;</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;                 dr0_ds(i) * (netmassin(i) * s(i,1) - net_salt(i)))</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    rcv_tot(i) = (h_ent*rcv(i,k) + netmassin(i)*rcv(i,1)) + &amp;</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="comment">!                    dRcv_dT(i)*netMassIn(i)*(T_precip - T(i,1)) + &amp;</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;                 (drcv_dt(i)*(net_heat(i) + pen_absorbed) - &amp;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                  drcv_ds(i) * (netmassin(i) * s(i,1) - net_salt(i)))</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    conv_en(i) = 0.0 ; dke_fc(i) = 0.0</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keywordflow">if</span>(<span class="keyword">ASSOCIATED</span>(fluxes%heat_content_massin))                            &amp;</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;           fluxes%heat_content_massin(i,j) = fluxes%heat_content_massin(i,j) &amp;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                       + t_precip * netmassin(i) * gv%H_to_kg_m2 * fluxes%C_p * idt</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(tv%TempxPmE)) tv%TempxPmE(i,j) = tv%TempxPmE(i,j) + &amp;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                         t_precip * netmassin(i) * gv%H_to_kg_m2</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;  <span class="comment">! Now do netMassOut case in this block.</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  <span class="comment">! At this point htot contains an Angstrom of fluid from layer 0 plus netMassIn.</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;  <span class="keywordflow">do</span> ks=1,nz</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (ksort(i,ks) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      k = ksort(i,ks)</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      <span class="keywordflow">if</span> ((htot(i) &lt; angstrom) .and. (h(i,k) &gt; eps(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <span class="comment">! If less than an Angstrom was available from the layers above plus</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="comment">! any precipitation, add more fluid from this layer.</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        h_ent = min(angstrom-htot(i), h(i,k)-eps(i,k))</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        htot(i) = htot(i) + h_ent</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;        h(i,k) = h(i,k) - h_ent</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        d_eb(i,k) = d_eb(i,k) - h_ent</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;        r0_tot(i) = r0_tot(i) + h_ent*r0(i,k)</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;        uhtot(i) = uhtot(i) + h_ent*u(i,k)</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;        vhtot(i) = vhtot(i) + h_ent*v(i,k)</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        rcv_tot(i) = rcv_tot(i) + h_ent*rcv(i,k)</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;        ttot(i) = ttot(i) + h_ent*t(i,k)</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        stot(i) = stot(i) + h_ent*s(i,k)</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      <span class="comment">! Water is removed from the topmost layers with any mass.</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;      <span class="comment">! We may lose layers if they are thin enough.</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;      <span class="comment">! The salt that is left behind goes into Stot.</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;      <span class="keywordflow">if</span> ((massoutrem(i) &gt; 0.0) .and. (h(i,k) &gt; eps(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        <span class="keywordflow">if</span> (massoutrem(i) &gt; (h(i,k) - eps(i,k))) <span class="keywordflow">then</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;          h_evap = h(i,k) - eps(i,k)</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;          h(i,k) = eps(i,k)</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;          massoutrem(i) = massoutrem(i) - h_evap</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;          h_evap = massoutrem(i)</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;          h(i,k) = h(i,k) - h_evap</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;          massoutrem(i) = 0.0</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;        stot(i) = stot(i) + h_evap*s(i,k)</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        r0_tot(i) = r0_tot(i) + dr0_ds(i)*h_evap*s(i,k)</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        rcv_tot(i) = rcv_tot(i) + drcv_ds(i)*h_evap*s(i,k)</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        d_eb(i,k) = d_eb(i,k) - h_evap</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        <span class="comment">! smg: when resolve the A=B code, we will set</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="comment">! heat_content_massout = heat_content_massout - T(i,k)*h_evap*GV%H_to_kg_m2*fluxes%C_p*Idt</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="comment">! by uncommenting the lines here.</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="comment">! we will also then completely remove TempXpme from the model.</span></div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        <span class="keywordflow">if</span>(<span class="keyword">ASSOCIATED</span>(fluxes%heat_content_massout))                            &amp;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;           fluxes%heat_content_massout(i,j) = fluxes%heat_content_massout(i,j) &amp;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                                    - t(i,k)*h_evap*gv%H_to_kg_m2 * fluxes%C_p * idt</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(tv%TempxPmE)) tv%TempxPmE(i,j) = tv%TempxPmE(i,j) - &amp;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                                      t(i,k)*h_evap*gv%H_to_kg_m2</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;      <span class="comment">! The following section calculates how much fluid will be entrained.</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;      h_avail = h(i,k) - eps(i,k)</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;      <span class="keywordflow">if</span> (h_avail &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        dr = r0_tot(i) - htot(i)*r0(i,k)</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        h_ent = 0.0</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        dr0 = dr</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;          dr0 = dr0 - (dr0_dt(i)*pen_sw_bnd(n,i)) * &amp;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                      opacity_band(n,i,k)*htot(i)</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        <span class="comment">! Some entrainment will occur from this layer.</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        <span class="keywordflow">if</span> (dr0 &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;          dr_comp = dr</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;          <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            <span class="comment">!   Compare the density at the bottom of a layer with the</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;            <span class="comment">! density averaged over the mixed layer and that layer.</span></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;            opacity = opacity_band(n,i,k)</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;            sw_trans = exp(-h_avail*opacity)</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;            dr_comp = dr_comp + (dr0_dt(i)*pen_sw_bnd(n,i)) * &amp;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                ((1.0 - sw_trans) - opacity*(htot(i)+h_avail)*sw_trans)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;          <span class="keywordflow">if</span> (dr_comp &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;            <span class="comment">! The entire layer is entrained.</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            h_ent = h_avail</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            <span class="comment">!  The layer is partially entrained.   Iterate to determine how much</span></div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;            <span class="comment">!  entrainment occurs.  Solve for the h_ent at which dr_ent = 0.</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;            <span class="comment">! Instead of assuming that the curve is linear between the two end</span></div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;            <span class="comment">! points, assume that the change is concentrated near small values</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;            <span class="comment">! of entrainment.  On average, this saves about 1 iteration.</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;            frac = dr0 / (dr0 - dr_comp)</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;            h_ent = h_avail * frac*frac</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;            h_min = 0.0 ; h_max = h_avail</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;            <span class="keywordflow">do</span> n=1,nsw</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;              r_sw_top(n) = dr0_dt(i) * pen_sw_bnd(n,i)</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;              c2(n) = r_sw_top(n) * opacity_band(n,i,k)**2</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;            <span class="keywordflow">do</span> itt=1,10</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;              dr_ent = dr ; dr_dh = 0.0</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;              <span class="keywordflow">do</span> n=1,nsw</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                opacity = opacity_band(n,i,k)</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                sw_trans = exp(-h_ent*opacity)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                dr_ent = dr_ent + r_sw_top(n) * ((1.0 - sw_trans) - &amp;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                           opacity*(htot(i)+h_ent)*sw_trans)</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;                dr_dh = dr_dh + c2(n) * (htot(i)+h_ent) * sw_trans</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;              <span class="keywordflow">if</span> (dr_ent &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                h_min = h_ent</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                h_max = h_ent</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;              dh_newt = -dr_ent / dr_dh</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;              h_prev = h_ent ; h_ent = h_prev+dh_newt</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;              <span class="keywordflow">if</span> (h_ent &gt; h_max) <span class="keywordflow">then</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                h_ent = 0.5*(h_prev+h_max)</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h_ent &lt; h_min) <span class="keywordflow">then</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                h_ent = 0.5*(h_prev+h_min)</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;              <span class="keywordflow">if</span> (abs(dh_newt) &lt; 0.2*angstrom) <span class="keywordflow">exit</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;          <span class="comment">!  Now that the amount of entrainment (h_ent) has been determined,</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;          <span class="comment">!  calculate changes in various terms.</span></div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;          sum_pen_en = 0.0 ; pen_absorbed = 0.0</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;          <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;            opacity = opacity_band(n,i,k)</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;            sw_trans = exp(-h_ent*opacity)</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            x1 = h_ent*opacity</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;            <span class="keywordflow">if</span> (x1 &lt; 2.0e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;              en_fn = (opacity*htot(i)*(1.0 - 0.5*(x1 - c1_3*x1)) + &amp;</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                       x1*x1*c1_6)</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;              en_fn = ((opacity*htot(i) + 2.0) * &amp;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                       ((1.0-sw_trans) / x1) - 1.0 + sw_trans)</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            sum_pen_en = sum_pen_en - (dr0_dt(i)*pen_sw_bnd(n,i)) * en_fn</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            pen_absorbed = pen_absorbed + pen_sw_bnd(n,i) * (1.0 - sw_trans)</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;            pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;          conv_en(i) = conv_en(i) + g_h2_2rho0 * h_ent * &amp;</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                       ( (r0_tot(i) - r0(i,k)*htot(i)) + sum_pen_en )</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;          r0_tot(i) = r0_tot(i) + (h_ent * r0(i,k) + pen_absorbed*dr0_dt(i))</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;          stot(i) = stot(i) + h_ent * s(i,k)</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;          ttot(i) = ttot(i) + (h_ent * t(i,k) + pen_absorbed)</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;          rcv_tot(i) = rcv_tot(i) + (h_ent * rcv(i,k) + pen_absorbed*drcv_dt(i))</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="keywordflow">        endif</span> <span class="comment">! dr0 &gt; 0.0</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        <span class="keywordflow">if</span> (h_ent &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;          <span class="keywordflow">if</span> (htot(i) &gt; 0.0) &amp;</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            dke_fc(i) = dke_fc(i) + cs%bulk_Ri_convective * 0.5 * &amp;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;              ((gv%H_to_m*h_ent) / (htot(i)*(h_ent+htot(i)))) * &amp;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;              ((uhtot(i)-u(i,k)*htot(i))**2 + (vhtot(i)-v(i,k)*htot(i))**2)</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;          htot(i)  = htot(i)  + h_ent</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;          h(i,k) = h(i,k) - h_ent</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;          d_eb(i,k) = d_eb(i,k) - h_ent</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;          uhtot(i) = u(i,k)*h_ent ; vhtot(i) = v(i,k)*h_ent</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! h_avail&gt;0</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i loop</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k loop</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a071010a461d5ae9440b063aadf4e2f88_icgraph.svg" width="571" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ad9e6f68b38815279808b9fa52cfc6e65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9e6f68b38815279808b9fa52cfc6e65">&#9670;&nbsp;</a></span>mixedlayer_detrain_1()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::mixedlayer_detrain_1 </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>RcvTgt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>max_BL_det</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine moves any water left in the former mixed layers into the single buffer layers and may also move buffer layer water into the interior isopycnal layers. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below. Layer 0 is the new mixed layer.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Potential temperature, in C.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">s</td><td>Salinity, in psu.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">r0</td><td>Potential density referenced to surface pressure, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rcv</td><td>The coordinate defining potential density, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rcvtgt</td><td>The target value of Rcv for each layer, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment, in s.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_ea</td><td>The upward increase across a layer in the entrainment from above, in m or kg m-2 (H). Positive d_ea goes with layer thickness increases.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_eb</td><td>The downward increase across a layer in the entrainment from below, in H. Positive values go with mass gain by a layer.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The meridional row to work on.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_dt</td><td>The partial derivative of coordinate defining potential density with potential temperature, in kg m-3 K-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_ds</td><td>The partial derivative of coordinate defining potential density with salinity, in kg m-3 psu-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_bl_det</td><td>If non-negative, the maximum detrainment permitted from the buffer layers, in H. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03332">3332</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),              <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),            <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">    !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;<span class="comment">                                                            !! (Intent in/out) The units of h are</span></div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;<span class="comment">                                                            !! referred to as H below. Layer 0 is</span></div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;<span class="comment">                                                            !! the new mixed layer.</span></div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: t<span class="comment">    !&lt; Potential temperature, in C.</span></div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: s<span class="comment">    !&lt; Salinity, in psu.</span></div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: r0<span class="comment">   !&lt; Potential density referenced to</span></div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;<span class="comment">                                                            !! surface pressure, in kg m-3.</span></div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: rcv<span class="comment">  !&lt; The coordinate defining potential</span></div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;<span class="comment">                                                            !! density, in kg m-3.</span></div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>,          <span class="keywordtype">intent(in)</span>    :: rcvtgt<span class="comment"> !&lt; The target value of Rcv for each</span></div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;<span class="comment">                                                            !! layer, in kg m-3.</span></div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; Time increment, in s.</span></div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: dt_diag</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,  <span class="keywordtype">intent(inout)</span> :: d_ea<span class="comment"> !&lt; The upward increase across a layer in</span></div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;<span class="comment">                                                            !! the entrainment from above, in m or</span></div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;<span class="comment">                                                            !! kg m-2 (H). Positive d_ea goes with</span></div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;<span class="comment">                                                            !! layer thickness increases.</span></div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,  <span class="keywordtype">intent(inout)</span> :: d_eb<span class="comment"> !&lt; The downward increase across a layer</span></div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;<span class="comment">                                                            !! in the entrainment from below, in H.</span></div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;<span class="comment">                                                            !! Positive values go with mass gain by</span></div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;<span class="comment">                                                            !! a layer.</span></div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;  <span class="keywordtype">integer</span>,                            <span class="keywordtype">intent(in)</span>    :: j<span class="comment">    !&lt; The meridional row to work on.</span></div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),            <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; The control structure returned by a</span></div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;<span class="comment">                                                            !! previous call to mixedlayer_init.</span></div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: drcv_dt<span class="comment"> !&lt; The partial derivative of</span></div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;<span class="comment">                                                            !! coordinate defining potential density</span></div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;<span class="comment">                                                            !! with potential temperature,</span></div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="comment">                                                            !! in kg m-3 K-1.</span></div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: drcv_ds<span class="comment">    !&lt; The partial derivative of</span></div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;<span class="comment">                                                            !! coordinate defining potential density</span></div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;<span class="comment">                                                            !! with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: max_bl_det<span class="comment"> !&lt; If non-negative, the maximum</span></div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;<span class="comment">                                                            !! detrainment permitted from the buffer</span></div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;<span class="comment">                                                            !! layers, in H.</span></div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;<span class="comment">! This subroutine moves any water left in the former mixed layers into the</span></div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;<span class="comment">! single buffer layers and may also move buffer layer water into the interior</span></div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;<span class="comment">! isopycnal layers.</span></div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units of</span></div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;<span class="comment">!                h are referred to as H below.  Layer 0 is the new mixed layer.</span></div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;<span class="comment">!  (in/out)  T - Potential temperature, in C.</span></div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;<span class="comment">!  (in/out)  S - Salinity, in psu.</span></div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;<span class="comment">!  (in/out)  R0 - Potential density referenced to surface pressure, in kg m-3.</span></div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;<span class="comment">!  (in/out)  Rcv - The coordinate defining potential density, in kg m-3.</span></div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;<span class="comment">!  (in)      RcvTgt - The target value of Rcv for each layer, in kg m-3.</span></div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;<span class="comment">!  (in)      dt - Time increment, in s.</span></div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;<span class="comment">!  (in/out)  d_ea - The upward increase across a layer in the entrainment from</span></div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;<span class="comment">!                   above, in m or kg m-2 (H).  Positive d_ea goes with layer</span></div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;<span class="comment">!                   thickness increases.</span></div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;<span class="comment">!  (in/out)  d_eb - The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;<span class="comment">!                   below, in H. Positive values go with mass gain by a layer.</span></div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;<span class="comment">!  (in)      j - The meridional row to work on.</span></div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;<span class="comment">!                 mixedlayer_init.</span></div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;<span class="comment">!  (in)      max_BL_det - If non-negative, the maximum detrainment permitted</span></div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;<span class="comment">!                         from the buffer layers, in H.</span></div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;<span class="comment">!  (in/out)  dRcv_dT - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;<span class="comment">!                      density with potential temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;<span class="comment">!  (in/out)  dRcv_dS - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;<span class="comment">!                      density with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;  <span class="keywordtype">real</span> :: ih                  <span class="comment">! The inverse of a thickness, in H-1.</span></div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;  <span class="keywordtype">real</span> :: h_ent               <span class="comment">! The thickness from a layer that is</span></div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;                              <span class="comment">! entrained, in H.</span></div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;  <span class="keywordtype">real</span> :: max_det_rem(szi_(g)) <span class="comment">! Remaining permitted detrainment, in H.</span></div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;  <span class="keywordtype">real</span> :: detrain(szi_(g))    <span class="comment">! The thickness of fluid to detrain</span></div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;                              <span class="comment">! from the mixed layer, in H.</span></div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;  <span class="keywordtype">real</span> :: idt                 <span class="comment">! The inverse of the timestep in s-1.</span></div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;  <span class="keywordtype">real</span> :: dt_dr, ds_dr, drml, dr0_drcv, dt_ds_wt2</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;  <span class="keywordtype">real</span> :: i_denom             <span class="comment">! A work variable with units of psu2 m6 kg-2.</span></div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;  <span class="keywordtype">real</span> :: sdown, tdown</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;  <span class="keywordtype">real</span> :: dt_time, timescale = 86400.0*30.0<span class="comment">! *365.0/12.0</span></div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;  <span class="keywordtype">real</span> :: g_h2_2rho0dt       <span class="comment">! Half the gravitational acceleration times the</span></div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;                              <span class="comment">! square of the conversion from H to m divided</span></div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;                              <span class="comment">! by the mean density times the time step, in m6 s-3 H-2 kg-1.</span></div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;  <span class="keywordtype">real</span> :: g_h2_2dt            <span class="comment">! Half the gravitational acceleration times the</span></div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;                              <span class="comment">! square of the conversion from H to m divided</span></div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;                              <span class="comment">! by the diagnostic time step, in m3 H-2 s-3.</span></div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;  <span class="keywordtype">logical</span> :: splittable_bl(szi_(g)), orthogonal_extrap</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;  <span class="keywordtype">real</span> :: x1</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;  <span class="keywordtype">integer</span> :: i, is, ie, k, k1, nkmb, nz</div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;  <span class="keywordflow">if</span> (cs%nkbl /= 1) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;MOM_mixed_layer: &quot;</span>// &amp;</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;                        <span class="stringliteral">&quot;CS%nkbl must be 1 in mixedlayer_detrain_1.&quot;</span>)</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;  idt = 1.0/dt</div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;  dt_time = dt/timescale</div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;  g_h2_2rho0dt = (gv%g_Earth * gv%H_to_m**2) / (2.0 * gv%Rho0 * dt_diag)</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;  g_h2_2dt = (gv%g_Earth * gv%H_to_m**2) / (2.0 * dt_diag)</div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;</div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;  <span class="comment">! Move detrained water into the buffer layer.</span></div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;  <span class="keywordflow">do</span> k=1,cs%nkml</div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h(i,k) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;      ih = 1.0 / (h(i,nkmb) + h(i,k))</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;      <span class="keywordflow">if</span> (cs%TKE_diagnostics) &amp;</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        cs%diag_TKE_conv_s2(i,j) =  cs%diag_TKE_conv_s2(i,j) + &amp;</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;          g_h2_2rho0dt * h(i,k) * h(i,nkmb) * &amp;</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;          (r0(i,nkmb) - r0(i,k))</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) &amp;</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;        cs%diag_PE_detrain(i,j) = cs%diag_PE_detrain(i,j) + &amp;</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;            g_h2_2dt * h(i,k) * h(i,nkmb) * (r0(i,nkmb) - r0(i,k))</div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) &amp;</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;        cs%diag_PE_detrain2(i,j) = cs%diag_PE_detrain2(i,j) + &amp;</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;            g_h2_2dt * h(i,k) * h(i,nkmb) * (r0(i,nkmb) - r0(i,k))</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;      r0(i,nkmb) = (r0(i,nkmb)*h(i,nkmb) + r0(i,k)*h(i,k)) * ih</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;      rcv(i,nkmb) = (rcv(i,nkmb)*h(i,nkmb) + rcv(i,k)*h(i,k)) * ih</div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;      t(i,nkmb) = (t(i,nkmb)*h(i,nkmb) + t(i,k)*h(i,k)) * ih</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;      s(i,nkmb) = (s(i,nkmb)*h(i,nkmb) + s(i,k)*h(i,k)) * ih</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;      d_ea(i,k) = d_ea(i,k) - h(i,k)</div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;      d_ea(i,nkmb) = d_ea(i,nkmb) + h(i,k)</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;      h(i,nkmb) = h(i,nkmb) + h(i,k)</div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;      h(i,k) = 0.0</div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;</div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;    max_det_rem(i) = 10.0 * h(i,nkmb)</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;    <span class="keywordflow">if</span> (max_bl_det(i) &gt;= 0.0) max_det_rem(i) = max_bl_det(i)</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;<span class="comment">!   If the mixed layer was denser than the densest interior layer,</span></div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;<span class="comment">! but is now lighter than this layer, leaving a buffer layer that</span></div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;<span class="comment">! is denser than this layer, there are problems.  This should prob-</span></div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;<span class="comment">! ably be considered a case of an inadequate choice of resolution in</span></div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;<span class="comment">! density space and should be avoided.  To make the model run sens-</span></div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;<span class="comment">! ibly in this case, it will make the mixed layer denser while making</span></div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;<span class="comment">! the buffer layer the density of the densest interior layer (pro-</span></div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;<span class="comment">! vided that the this will not make the mixed layer denser than the</span></div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;<span class="comment">! interior layer).  Otherwise, make the mixed layer the same density</span></div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;<span class="comment">! as the densest interior layer and lighten the buffer layer with</span></div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;<span class="comment">! the released buoyancy.  With multiple buffer layers, much more</span></div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;<span class="comment">! graceful options are available.</span></div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h(i,nkmb) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    <span class="keywordflow">if</span> ((r0(i,0)&lt;r0(i,nz)) .and. (r0(i,nz)&lt;r0(i,nkmb))) <span class="keywordflow">then</span></div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;      <span class="keywordflow">if</span> ((r0(i,nz)-r0(i,0))*h(i,0) &gt; &amp;</div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;          (r0(i,nkmb)-r0(i,nz))*h(i,nkmb)) <span class="keywordflow">then</span></div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;        detrain(i) = (r0(i,nkmb)-r0(i,nz))*h(i,nkmb) / (r0(i,nkmb)-r0(i,0))</div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;        detrain(i) = (r0(i,nz)-r0(i,0))*h(i,0) / (r0(i,nkmb)-r0(i,0))</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;      d_eb(i,cs%nkml) = d_eb(i,cs%nkml) + detrain(i)</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;      d_ea(i,cs%nkml) = d_ea(i,cs%nkml) - detrain(i)</div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;      d_eb(i,nkmb) = d_eb(i,nkmb) - detrain(i)</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;      d_ea(i,nkmb) = d_ea(i,nkmb) + detrain(i)</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) cs%diag_PE_detrain(i,j) = &amp;</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;        cs%diag_PE_detrain(i,j) + g_h2_2dt * detrain(i)* &amp;</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;                     (h(i,0) + h(i,nkmb)) * (r0(i,nkmb) - r0(i,0))</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;      x1 = r0(i,0)</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;      r0(i,0) = r0(i,0) - detrain(i)*(r0(i,0)-r0(i,nkmb)) / h(i,0)</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;      r0(i,nkmb) = r0(i,nkmb) - detrain(i)*(r0(i,nkmb)-x1) / h(i,nkmb)</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;      x1 = rcv(i,0)</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;      rcv(i,0) = rcv(i,0) - detrain(i)*(rcv(i,0)-rcv(i,nkmb)) / h(i,0)</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;      rcv(i,nkmb) = rcv(i,nkmb) - detrain(i)*(rcv(i,nkmb)-x1) / h(i,nkmb)</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;      x1 = t(i,0)</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;      t(i,0) = t(i,0) - detrain(i)*(t(i,0)-t(i,nkmb)) / h(i,0)</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;      t(i,nkmb) = t(i,nkmb) - detrain(i)*(t(i,nkmb)-x1) / h(i,nkmb)</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;      x1 = s(i,0)</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;      s(i,0) = s(i,0) - detrain(i)*(s(i,0)-s(i,nkmb)) / h(i,0)</div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;      s(i,nkmb) = s(i,nkmb) - detrain(i)*(s(i,nkmb)-x1) / h(i,nkmb)</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;  <span class="comment">! Move water out of the buffer layer, if convenient.</span></div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;<span class="comment">!   Split the buffer layer if possible, and replace the buffer layer</span></div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;<span class="comment">! with a small amount of fluid from the mixed layer.</span></div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;<span class="comment">! This is the exponential-in-time splitting, circa 2005.</span></div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    <span class="keywordflow">if</span> (h(i,nkmb) &gt; 0.0) <span class="keywordflow">then</span> ; splittable_bl(i) = .true.</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    <span class="keywordflow">else</span> ; splittable_bl(i) = .false. ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;  dt_ds_wt2 = cs%dT_dS_wt**2</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;<span class="comment">!    dt_Time = dt/Timescale</span></div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;  <span class="keywordflow">do</span> k=nz-1,nkmb+1,-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;    <span class="keywordflow">if</span> (splittable_bl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;      <span class="keywordflow">if</span> (rcvtgt(k)&lt;=rcv(i,nkmb)) <span class="keywordflow">then</span></div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;<span class="comment">! Estimate dR/drho, dTheta/dR, and dS/dR, where R is the coordinate variable</span></div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;<span class="comment">! and rho is in-situ (or surface) potential density.</span></div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;<span class="comment">! There is no &quot;right&quot; way to do this, so this keeps things reasonable, if</span></div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;<span class="comment">! slightly arbitrary.</span></div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;        splittable_bl(i) = .false.</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;        k1 = k+1 ; orthogonal_extrap = .false.</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;        <span class="comment">! Here we try to find a massive layer to use for interpolating the</span></div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;        <span class="comment">! temperature and salinity.  If none is available a pseudo-orthogonal</span></div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;        <span class="comment">! extrapolation is used.  The 10.0 and 0.9 in the following are</span></div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;        <span class="comment">! arbitrary but probably about right.</span></div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;        <span class="keywordflow">if</span> ((h(i,k+1) &lt; 10.0*gv%Angstrom) .or. &amp;</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;            ((rcvtgt(k+1)-rcv(i,nkmb)) &gt;= 0.9*(rcv(i,k1) - rcv(i,0)))) <span class="keywordflow">then</span></div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;          <span class="keywordflow">if</span> (k&gt;=nz-1) <span class="keywordflow">then</span> ; orthogonal_extrap = .true.</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;          <span class="keywordflow">elseif</span> ((h(i,k+2) &lt;= 10.0*gv%Angstrom) .and. &amp;</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;              ((rcvtgt(k+1)-rcv(i,nkmb)) &lt; 0.9*(rcv(i,k+2)-rcv(i,0)))) <span class="keywordflow">then</span></div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;            k1 = k+2</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;          <span class="keywordflow">else</span> ; orthogonal_extrap = .true. ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;        <span class="keywordflow">if</span> ((r0(i,0) &gt;= r0(i,k1)) .or. (rcv(i,0) &gt;= rcv(i,nkmb))) cycle</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;          <span class="comment">! In this case there is an inversion of in-situ density relative to</span></div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;          <span class="comment">! the coordinate variable.  Do not detrain from the buffer layer.</span></div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;        <span class="keywordflow">if</span> (orthogonal_extrap) <span class="keywordflow">then</span></div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;          <span class="comment">! 36 here is a typical oceanic value of (dR/dS) / (dR/dT) - it says</span></div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;          <span class="comment">! that the relative weights of T &amp; S changes is a plausible 6:1.</span></div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;          <span class="comment">! Also, this was coded on Athena&#39;s 6th birthday!</span></div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;          i_denom = 1.0 / (drcv_ds(i)**2 + dt_ds_wt2*drcv_dt(i)**2)</div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;          dt_dr = dt_ds_wt2*drcv_dt(i) * i_denom</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;          ds_dr = drcv_ds(i) * i_denom</div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;          dt_dr = (t(i,0) - t(i,k1)) / (rcv(i,0) - rcv(i,k1))</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;          ds_dr = (s(i,0) - s(i,k1)) / (rcv(i,0) - rcv(i,k1))</div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;        drml = dt_time * (r0(i,nkmb) - r0(i,0)) * &amp;</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;               (rcv(i,0) - rcv(i,k1)) / (r0(i,0) - r0(i,k1))</div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;        <span class="comment">! Once again, there is an apparent density inversion in Rcv.</span></div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;        <span class="keywordflow">if</span> (drml &lt; 0.0) cycle</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        dr0_drcv = (r0(i,0) - r0(i,k1)) / (rcv(i,0) - rcv(i,k1))</div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;</div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;        <span class="keywordflow">if</span> ((rcv(i,nkmb) - drml &lt; rcvtgt(k)) .and. (max_det_rem(i) &gt; h(i,nkmb))) <span class="keywordflow">then</span></div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;          <span class="comment">! In this case, the buffer layer is split into two isopycnal layers.</span></div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;          detrain(i) = h(i,nkmb)*(rcv(i,nkmb) - rcvtgt(k)) / &amp;</div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;                                  (rcvtgt(k+1) - rcvtgt(k))</div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) cs%diag_PE_detrain(i,j) = &amp;</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;            cs%diag_PE_detrain(i,j) - g_h2_2dt * detrain(i) * &amp;</div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;                 (h(i,nkmb)-detrain(i)) * (rcvtgt(k+1) - rcvtgt(k)) * dr0_drcv</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;          tdown = detrain(i) * (t(i,nkmb) + dt_dr*(rcvtgt(k+1)-rcv(i,nkmb)))</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;          t(i,k) = (h(i,k) * t(i,k) + &amp;</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;                        (h(i,nkmb) * t(i,nkmb) - tdown)) / &amp;</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;                       (h(i,k) + (h(i,nkmb) - detrain(i)))</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;          t(i,k+1) = (h(i,k+1) * t(i,k+1) + tdown)/ &amp;</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;                          (h(i,k+1) + detrain(i))</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;          t(i,nkmb) = t(i,0)</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;          sdown = detrain(i) * (s(i,nkmb) + ds_dr*(rcvtgt(k+1)-rcv(i,nkmb)))</div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;          s(i,k) = (h(i,k) * s(i,k) + &amp;</div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;                      (h(i,nkmb) * s(i,nkmb) - sdown)) / &amp;</div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;                      (h(i,k) + (h(i,nkmb) - detrain(i)))</div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;          s(i,k+1) = (h(i,k+1) * s(i,k+1) + sdown)/ &amp;</div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;                         (h(i,k+1) + detrain(i))</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;          s(i,nkmb) = s(i,0)</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;          rcv(i,nkmb) = rcv(i,0)</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;          d_ea(i,k+1) = d_ea(i,k+1) + detrain(i)</div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;          d_ea(i,k) = d_ea(i,k) + (h(i,nkmb) - detrain(i))</div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;          d_ea(i,nkmb) = d_ea(i,nkmb) - h(i,nkmb)</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;          h(i,k+1) = h(i,k+1) + detrain(i)</div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;          h(i,k) = h(i,k) + h(i,nkmb) - detrain(i)</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;          h(i,nkmb) = 0.0</div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;          <span class="comment">! Here only part of the buffer layer is moved into the interior.</span></div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;          detrain(i) = h(i,nkmb) * drml / (rcvtgt(k+1) - rcv(i,nkmb) + drml)</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;          <span class="keywordflow">if</span> (detrain(i) &gt; max_det_rem(i)) detrain(i) = max_det_rem(i)</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;          ih = 1.0 / (h(i,k+1) + detrain(i))</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;          tdown = (t(i,nkmb) + dt_dr*(rcvtgt(k+1)-rcv(i,nkmb)))</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;          t(i,nkmb) = t(i,nkmb) - dt_dr * drml</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;          t(i,k+1) = (h(i,k+1) * t(i,k+1) + detrain(i) * tdown) * ih</div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;          sdown = (s(i,nkmb) + ds_dr*(rcvtgt(k+1)-rcv(i,nkmb)))</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;<span class="comment">!  The following two expressions updating S(nkmb) are mathematically identical.</span></div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;<span class="comment">!            S(i,nkmb) = (h(i,nkmb) * S(i,nkmb) - detrain(i) * Sdown) / &amp;</span></div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;<span class="comment">!                           (h(i,nkmb) - detrain(i))</span></div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;          s(i,nkmb) = s(i,nkmb) - ds_dr * drml</div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;          s(i,k+1) = (h(i,k+1) * s(i,k+1) + detrain(i) * sdown) * ih</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;          d_ea(i,k+1) = d_ea(i,k+1) + detrain(i)</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;          d_ea(i,nkmb) = d_ea(i,nkmb) - detrain(i)</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;          h(i,k+1) = h(i,k+1) + detrain(i)</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;          h(i,nkmb) = h(i,nkmb) - detrain(i)</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) cs%diag_PE_detrain(i,j) = &amp;</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;            cs%diag_PE_detrain(i,j) - g_h2_2dt * detrain(i) * dr0_drcv * &amp;</div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;                 (h(i,nkmb)-detrain(i)) * (rcvtgt(k+1) - rcv(i,nkmb) + drml)</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! RcvTgt(k)&lt;=Rcv(i,nkmb)</span></div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! splittable_BL</span></div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;</div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;<span class="comment">!   The numerical behavior of the buffer layer is dramatically improved</span></div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;<span class="comment">! if it is always at least a small fraction (say 10%) of the thickness</span></div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;<span class="comment">! of the mixed layer.  As the physical distinction between the mixed</span></div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;<span class="comment">! and buffer layers is vague anyway, this seems hard to argue against.</span></div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;    <span class="keywordflow">if</span> (h(i,nkmb) &lt; 0.1*h(i,0)) <span class="keywordflow">then</span></div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;      h_ent =  0.1*h(i,0) - h(i,nkmb)</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;      ih = 10.0/h(i,0)</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;      t(i,nkmb) = (h(i,nkmb)*t(i,nkmb) + h_ent*t(i,0)) * ih</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;      s(i,nkmb) = (h(i,nkmb)*s(i,nkmb) + h_ent*s(i,0)) * ih</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;      d_ea(i,1) = d_ea(i,1) - h_ent</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;      d_ea(i,nkmb) = d_ea(i,nkmb) + h_ent</div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;      h(i,0) = h(i,0) - h_ent</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;      h(i,nkmb) = h(i,nkmb) + h_ent</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_ad9e6f68b38815279808b9fa52cfc6e65_icgraph.svg" width="567" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a46fd0f8d6109e0d4f7e4da971f2ab663"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a46fd0f8d6109e0d4f7e4da971f2ab663">&#9670;&nbsp;</a></span>mixedlayer_detrain_2()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::mixedlayer_detrain_2 </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>RcvTgt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt_diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>max_BL_det</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine moves any water left in the former mixed layers into the two buffer layers and may also move buffer layer water into the interior isopycnal layers. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below. Layer 0 is the new mixed layer.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Potential temperature, in C.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">s</td><td>Salinity, in psu.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">r0</td><td>Potential density referenced to surface pressure, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rcv</td><td>The coordinate defining potential density, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rcvtgt</td><td>The target value of Rcv for each layer, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment, in s.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt_diag</td><td>The diagnostic time step, in s.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_ea</td><td>The upward increase across a layer in the entrainment from above, in m or kg m-2 (H). Positive d_ea goes with layer thickness increases.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>The meridional row to work on.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dr0_dt</td><td>The partial derivative of potential density referenced to the surface with potential temperature, in kg m-3 K-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dr0_ds</td><td>The partial derivative of cpotential density referenced to the surface with salinity, in kg m-3 psu-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_dt</td><td>The partial derivative of coordinate defining potential density with potential temperature, in kg m-3 K-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_ds</td><td>The partial derivative of coordinate defining potential density with salinity, in kg m-3 psu-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_bl_det</td><td>If non-negative, the maximum detrainment permitted from the buffer layers, in H. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l02408">2408</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),              <span class="keywordtype">intent(in)</span>    :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),            <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">    !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="comment">                                                            !! (Intent in/out)  The units of h are</span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;<span class="comment">                                                            !! referred to as H below.</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="comment">                                                            !!  Layer 0 is the new mixed layer.</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: t<span class="comment">    !&lt; Potential temperature, in C.</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: s<span class="comment">    !&lt; Salinity, in psu.</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: r0<span class="comment">   !&lt; Potential density referenced to</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;<span class="comment">                                                            !! surface pressure, in kg m-3.</span></div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: rcv<span class="comment">  !&lt; The coordinate defining potential</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;<span class="comment">                                                            !! density, in kg m-3.</span></div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>,          <span class="keywordtype">intent(in)</span>    :: rcvtgt<span class="comment">  !&lt; The target value of Rcv for each</span></div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;<span class="comment">                                                            !! layer, in kg m-3.</span></div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; Time increment, in s.</span></div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: dt_diag<span class="comment"> !&lt; The diagnostic time step, in s.</span></div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,  <span class="keywordtype">intent(inout)</span> :: d_ea<span class="comment"> !&lt; The upward increase across a layer in</span></div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;<span class="comment">                                                            !! the entrainment from above, in m or</span></div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="comment">                                                            !! kg m-2 (H).  Positive d_ea goes with</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="comment">                                                            !! layer thickness increases.</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;  <span class="keywordtype">integer</span>,                            <span class="keywordtype">intent(in)</span>    :: j<span class="comment">    !&lt; The meridional row to work on.</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),            <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; The control structure returned by a</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="comment">                                                            !! previous call to mixedlayer_init.</span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: dr0_dt<span class="comment">  !&lt; The partial derivative of</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;<span class="comment">                                                            !! potential density referenced to the</span></div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;<span class="comment">                                                            !! surface with potential temperature,</span></div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;<span class="comment">                                                            !! in kg m-3 K-1.</span></div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: dr0_ds<span class="comment">  !&lt; The partial derivative of</span></div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;<span class="comment">                                                            !! cpotential density referenced to the</span></div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;<span class="comment">                                                            !! surface with salinity,</span></div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="comment">                                                            !! in kg m-3 psu-1.</span></div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: drcv_dt<span class="comment"> !&lt; The partial derivative of</span></div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="comment">                                                            !! coordinate defining potential density</span></div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="comment">                                                            !! with potential temperature,</span></div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="comment">                                                            !! in kg m-3 K-1.</span></div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: drcv_ds<span class="comment"> !&lt; The partial derivative of</span></div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;<span class="comment">                                                            !! coordinate defining potential density</span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="comment">                                                            !! with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: max_bl_det<span class="comment"> !&lt; If non-negative, the maximum</span></div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;<span class="comment">                                                            !! detrainment permitted from the buffer</span></div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="comment">                                                            !! layers, in H.</span></div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="comment">! This subroutine moves any water left in the former mixed layers into the</span></div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="comment">! two buffer layers and may also move buffer layer water into the interior</span></div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="comment">! isopycnal layers.</span></div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units of</span></div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;<span class="comment">!                h are referred to as H below.  Layer 0 is the new mixed layer.</span></div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment">!  (in/out)  T - Potential temperature, in C.</span></div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;<span class="comment">!  (in/out)  S - Salinity, in psu.</span></div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="comment">!  (in/out)  R0 - Potential density referenced to surface pressure, in kg m-3.</span></div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="comment">!  (in/out)  Rcv - The coordinate defining potential density, in kg m-3.</span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;<span class="comment">!  (in)      RcvTgt - The target value of Rcv for each layer, in kg m-3.</span></div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="comment">!  (in)      dt - Time increment, in s.</span></div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;<span class="comment">!  (in)      dt_diag - The diagnostic time step, in s.</span></div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;<span class="comment">!  (in/out)  d_ea - The upward increase across a layer in the entrainment from</span></div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;<span class="comment">!                   above, in m or kg m-2 (H).  Positive d_ea goes with layer</span></div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;<span class="comment">!                   thickness increases.</span></div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;<span class="comment">!  (in)      j - The meridional row to work on.</span></div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="comment">!                 mixedlayer_init.</span></div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;<span class="comment">!  (in)      max_BL_det - If non-negative, the maximum detrainment permitted</span></div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="comment">!                         from the buffer layers, in H.</span></div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;<span class="comment">!  (in)  dR0_dT - The partial derivative of potential density referenced</span></div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="comment">!                 to the surface with potential temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="comment">!  (in)  dR0_dS - The partial derivative of cpotential density referenced</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="comment">!                 to the surface with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;<span class="comment">!  (in)  dRcv_dT - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;<span class="comment">!                  density with potential temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;<span class="comment">!  (in)  dRcv_dS - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;<span class="comment">!                  density with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;  <span class="keywordtype">real</span> :: h_to_bl                 <span class="comment">! The total thickness detrained to the buffer</span></div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;                                  <span class="comment">! layers, in H (the units of h).</span></div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;  <span class="keywordtype">real</span> :: r0_to_bl, rcv_to_bl     <span class="comment">! The depth integrated amount of R0, Rcv, T</span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;  <span class="keywordtype">real</span> :: t_to_bl, s_to_bl        <span class="comment">! and S that is detrained to the buffer layer,</span></div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;                                  <span class="comment">! in H kg m-3, H kg m-3, K H, and psu H.</span></div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;  <span class="keywordtype">real</span> :: h_min_bl                <span class="comment">! The minimum buffer layer thickness, in H.</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;  <span class="keywordtype">real</span> :: h_min_bl_thick          <span class="comment">! The minimum buffer layer thickness when the</span></div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;                                  <span class="comment">! mixed layer is very large, in H.</span></div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;  <span class="keywordtype">real</span> :: h_min_bl_frac_ml = 0.05 <span class="comment">! The minimum buffer layer thickness relative</span></div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;                                  <span class="comment">! to the total mixed layer thickness for thin</span></div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;                                  <span class="comment">! mixed layers, nondim., maybe 0.1/CS%nkbl.</span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;  <span class="keywordtype">real</span> :: h1, h2                  <span class="comment">! Scalar variables holding the values of</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;                                  <span class="comment">! h(i,CS%nkml+1) and h(i,CS%nkml+2), in H.</span></div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;  <span class="keywordtype">real</span> :: h1_avail                <span class="comment">! The thickess of the upper buffer layer</span></div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;                                  <span class="comment">! available to move into the lower buffer</span></div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;                                  <span class="comment">! layer, in H.</span></div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;  <span class="keywordtype">real</span> :: stays                   <span class="comment">! stays is the thickness of the upper buffer</span></div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;                                  <span class="comment">! layer that remains there, in units of H.</span></div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;  <span class="keywordtype">real</span> :: stays_min, stays_max    <span class="comment">! The minimum and maximum permitted values of</span></div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;                                  <span class="comment">! stays, in units of H.</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;  <span class="keywordtype">logical</span> :: mergeable_bl         <span class="comment">! If true, it is an option to combine the two</span></div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;                                  <span class="comment">! buffer layers and create water that matches</span></div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;                                  <span class="comment">! the target density of an interior layer.</span></div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;  <span class="keywordtype">real</span> :: stays_merge             <span class="comment">! If the two buffer layers can be combined</span></div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;                                  <span class="comment">! stays_merge is the thickness of the upper</span></div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;                                  <span class="comment">! layer that remains, in units of H.</span></div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;  <span class="keywordtype">real</span> :: stays_min_merge         <span class="comment">! The minimum allowed value of stays_merge in H.</span></div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;  <span class="keywordtype">real</span> :: dr0_2dz, drcv_2dz       <span class="comment">! Half the vertical gradients of R0, Rcv, T, and</span></div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="comment">!  real :: dT_2dz, dS_2dz          ! S, in kg m-4, kg m-4, K m-1, and psu m-1.</span></div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;  <span class="keywordtype">real</span> :: scale_slope             <span class="comment">! A nondimensional number &lt; 1 used to scale down</span></div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;                                  <span class="comment">! the slope within the upper buffer layer when</span></div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;                                  <span class="comment">! water MUST be detrained to the lower layer.</span></div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;  <span class="keywordtype">real</span> :: dpe_extrap              <span class="comment">! The potential energy change due to dispersive</span></div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;                                  <span class="comment">! advection or mixing layers, divided by</span></div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;                                  <span class="comment">! rho_0*g, in units of H2.</span></div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;  <span class="keywordtype">real</span> :: dpe_det, dpe_merge      <span class="comment">! The energy required to mix the detrained water</span></div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;                                  <span class="comment">! into the buffer layer or the merge the two</span></div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;                                  <span class="comment">! buffer layers, both in units of J H2 m-4.</span></div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;  <span class="keywordtype">real</span> :: h_from_ml               <span class="comment">! The amount of additional water that must be</span></div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;                                  <span class="comment">! drawn from the mixed layer, in H.</span></div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;  <span class="keywordtype">real</span> :: h_det_h2                <span class="comment">! The amount of detrained water and mixed layer</span></div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;                                  <span class="comment">! water that will go directly into the lower</span></div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;                                  <span class="comment">! buffer layer, in H.</span></div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;  <span class="keywordtype">real</span> :: h_det_to_h2, h_ml_to_h2 <span class="comment">! All of the variables hA_to_hB are the</span></div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;  <span class="keywordtype">real</span> :: h_det_to_h1, h_ml_to_h1 <span class="comment">! thickess fluxes from one layer to another,</span></div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;  <span class="keywordtype">real</span> :: h1_to_h2, h1_to_k0      <span class="comment">! in H, with h_det the detrained water, h_ml</span></div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;  <span class="keywordtype">real</span> :: h2_to_k1, h2_to_k1_rem  <span class="comment">! the actively mixed layer, h1 and h2 the upper</span></div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;                                  <span class="comment">! and lower buffer layers, and k0 and k1 the</span></div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;                                  <span class="comment">! interior layers that are just lighter and</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;                                  <span class="comment">! just denser than the lower buffer layer.</span></div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;  <span class="keywordtype">real</span> :: r0_det, t_det, s_det    <span class="comment">! Detrained values of R0, T, and S.</span></div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;  <span class="keywordtype">real</span> :: rcv_stays, r0_stays     <span class="comment">! Values of Rcv and R0 that stay in a layer.</span></div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;  <span class="keywordtype">real</span> :: t_stays, s_stays        <span class="comment">! Values of T and S that stay in a layer.</span></div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;  <span class="keywordtype">real</span> :: dspice_det, dspice_stays<span class="comment">! The spiciness difference between an original</span></div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;                                  <span class="comment">! buffer layer and the water that moves into</span></div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;                                  <span class="comment">! an interior layer or that stays in that</span></div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;                                  <span class="comment">! layer, in kg m-3.</span></div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;  <span class="keywordtype">real</span> :: dspice_lim, dspice_lim2 <span class="comment">! Limits to the spiciness difference between</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;                                  <span class="comment">! the lower buffer layer and the water that</span></div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;                                  <span class="comment">! moves into an interior layer, in kg m-3.</span></div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;  <span class="keywordtype">real</span> :: dspice_2dz              <span class="comment">! The vertical gradient of spiciness used for</span></div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;                                  <span class="comment">! advection, in kg m-4.</span></div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;  <span class="keywordtype">real</span> :: dpe_ratio               <span class="comment">! Multiplier of dPE_det at which merging is</span></div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;                                  <span class="comment">! permitted - here (detrainment_per_day/dt)*30</span></div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;                                  <span class="comment">! days?</span></div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;  <span class="keywordtype">real</span> :: num_events              <span class="comment">! The number of detrainment events over which</span></div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;                                  <span class="comment">! to prefer merging the buffer layers.</span></div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;  <span class="keywordtype">real</span> :: detrainment_timescale   <span class="comment">! The typical timescale for a detrainment</span></div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;                                  <span class="comment">! event, in s.</span></div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;  <span class="keywordtype">real</span> :: dpe_time_ratio          <span class="comment">! Larger of 1 and the detrainment_timescale</span></div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;                                  <span class="comment">! over dt, nondimensional.</span></div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  <span class="keywordtype">real</span> :: dt_ds_gauge, ds_dt_gauge <span class="comment">! The relative scales of temperature and</span></div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;                                  <span class="comment">! salinity changes in defining spiciness, in</span></div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;                                  <span class="comment">! K psu-1 and psu K-1.</span></div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;  <span class="keywordtype">real</span> :: i_denom                 <span class="comment">! A work variable with units of psu2 m6 kg-2.</span></div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;  <span class="keywordtype">real</span> :: g_2                     <span class="comment">! 1/2 G_Earth, in m s-2.</span></div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;  <span class="keywordtype">real</span> :: rho0xg                  <span class="comment">! Rho0 times G_Earth, in kg m-2 s-2.</span></div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;  <span class="keywordtype">real</span> :: i2rho0                  <span class="comment">! 1 / (2 Rho0), in m3 kg-1.</span></div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;  <span class="keywordtype">real</span> :: idt_h2                  <span class="comment">! The square of the conversion from thickness</span></div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;                                  <span class="comment">! to m divided by the time step in m2 H-2 s-1.</span></div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;  <span class="keywordtype">logical</span> :: stable_rcv           <span class="comment">! If true, the buffer layers are stable with</span></div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;                                  <span class="comment">! respect to the coordinate potential density.</span></div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;  <span class="keywordtype">real</span> :: h_neglect <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;                    <span class="comment">! in roundoff and can be neglected, in H.</span></div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;  <span class="keywordtype">real</span> :: s1en                    <span class="comment">! A work variable with units of H2 kg m s-3.</span></div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;  <span class="keywordtype">real</span> :: s1, s2, bh0             <span class="comment">! Work variables with units of H.</span></div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  <span class="keywordtype">real</span> :: s3sq                    <span class="comment">! A work variable with units of H2.</span></div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;  <span class="keywordtype">real</span> :: i_ya, b1                <span class="comment">! Nondimensional work variables.</span></div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;  <span class="keywordtype">real</span> :: ih, ihdet, ih1f, ih2f   <span class="comment">! Assorted inverse thickness work variables,</span></div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;  <span class="keywordtype">real</span> :: ihk0, ihk1, ih12        <span class="comment">! all with units of H-1.</span></div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;  <span class="keywordtype">real</span> :: dr1, dr2, dr2b, drk1    <span class="comment">! Assorted density difference work variables,</span></div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;  <span class="keywordtype">real</span> :: dr0, dr21, drcv         <span class="comment">! all with units of kg m-3.</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;  <span class="keywordtype">real</span> :: drcv_stays, drcv_det, drcv_lim</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;  <span class="keywordtype">real</span> :: angstrom                <span class="comment">! The minumum layer thickness, in H.</span></div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;  <span class="keywordtype">real</span> :: h2_to_k1_lim, t_new, s_new, t_max, t_min, s_max, s_min</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;  <span class="keywordtype">character(len=200)</span> :: mesg</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;  <span class="keywordtype">integer</span> :: i, k, k0, k1, is, ie, nz, kb1, kb2, nkmb</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  kb1 = cs%nkml+1; kb2 = cs%nkml+2</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;  g_2 = 0.5*gv%g_Earth</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;  rho0xg = gv%Rho0 * gv%g_Earth</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;  idt_h2 = gv%H_to_m**2 / dt_diag</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  i2rho0 = 0.5 / gv%Rho0</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;  angstrom = gv%Angstrom</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;  <span class="comment">! This is hard coding of arbitrary and dimensional numbers.</span></div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;  h_min_bl_thick = 5.0 * gv%m_to_H</div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;  dt_ds_gauge = cs%dT_dS_wt ; ds_dt_gauge = 1.0 /dt_ds_gauge</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;  num_events = 10.0</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;  detrainment_timescale = 4.0*3600.0</div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;  <span class="keywordflow">if</span> (cs%nkbl /= 2) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixed_layer&quot;</span>// &amp;</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;                        <span class="stringliteral">&quot;CS%nkbl must be 2 in mixedlayer_detrain_2.&quot;</span>)</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;  <span class="keywordflow">if</span> (dt &lt; detrainment_timescale) <span class="keywordflow">then</span> ; dpe_time_ratio = detrainment_timescale/dt</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;  <span class="keywordflow">else</span> ; dpe_time_ratio = 1.0 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;  <span class="comment">! Determine all of the properties being detrained from the mixed layer.</span></div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;  <span class="comment">! As coded this has the k and i loop orders switched, but k is CS%nkml is</span></div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;  <span class="comment">! often just 1 or 2, so this seems like it should not be a problem, especially</span></div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;  <span class="comment">! since it means that a number of variables can now be scalars, not arrays.</span></div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    h_to_bl = 0.0 ; r0_to_bl = 0.0</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    rcv_to_bl = 0.0 ; t_to_bl = 0.0 ; s_to_bl = 0.0</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;    <span class="keywordflow">do</span> k=1,cs%nkml ; <span class="keywordflow">if</span> (h(i,k) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;      h_to_bl = h_to_bl + h(i,k)</div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;      r0_to_bl = r0_to_bl + r0(i,k)*h(i,k)</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;      rcv_to_bl = rcv_to_bl + rcv(i,k)*h(i,k)</div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;      t_to_bl = t_to_bl + t(i,k)*h(i,k)</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;      s_to_bl = s_to_bl + s(i,k)*h(i,k)</div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;      d_ea(i,k) = d_ea(i,k) - h(i,k)</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;      h(i,k) = 0.0</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    <span class="keywordflow">if</span> (h_to_bl &gt; 0.0) <span class="keywordflow">then</span> ; r0_det = r0_to_bl / h_to_bl</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;    <span class="keywordflow">else</span> ; r0_det = r0(i,0) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;    <span class="comment">! This code does both downward detrainment from both the mixed layer and the</span></div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    <span class="comment">! buffer layers.</span></div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    <span class="comment">!   Several considerations apply in detraining water into the interior:</span></div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;    <span class="comment">! (1) Water only moves into the interior from the deeper buffer layer,</span></div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="comment">!     so the deeper buffer layer must have some mass.</span></div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;    <span class="comment">! (2) The upper buffer layer must have some mass so the extrapolation of</span></div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;    <span class="comment">!     density is meaningful (i.e. there is not detrainment from the buffer</span></div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">!     layers when there is strong mixed layer entrainment).</span></div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;    <span class="comment">! (3) The lower buffer layer density extrapolated to its base with a</span></div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;    <span class="comment">!     linear fit between the two layers must exceed the density of the</span></div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;    <span class="comment">!     next denser interior layer.</span></div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    <span class="comment">! (4) The average extroplated coordinate density that is moved into the</span></div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    <span class="comment">!     isopycnal interior matches the target value for that layer.</span></div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;    <span class="comment">! (5) The potential energy change is calculated and might be used later</span></div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;    <span class="comment">!     to allow the upper buffer layer to mix more into the lower buffer</span></div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;    <span class="comment">!     layer.</span></div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;    <span class="comment">! Determine whether more must be detrained from the mixed layer to keep a</span></div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;    <span class="comment">! minimal amount of mass in the buffer layers.  In this case the 5% of the</span></div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;    <span class="comment">! mixed layer thickness is hard-coded, but probably shouldn&#39;t be!</span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;    h_min_bl = min(h_min_bl_thick,h_min_bl_frac_ml*h(i,0))</div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;    stable_rcv = .true.</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;    <span class="keywordflow">if</span> (((r0(i,kb2)-r0(i,kb1)) * (rcv(i,kb2)-rcv(i,kb1)) &lt;= 0.0)) &amp;</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;      stable_rcv = .false.</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;    h1 = h(i,kb1) ; h2 = h(i,kb2)</div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;</div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;    h2_to_k1_rem = (h1 + h2) + h_to_bl</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;    <span class="keywordflow">if</span> ((max_bl_det(i) &gt;= 0.0) .and. (h2_to_k1_rem &gt; max_bl_det(i))) &amp;</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;      h2_to_k1_rem = max_bl_det(i)</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;    <span class="keywordflow">if</span> ((h2 == 0.0) .and. (h1 &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;      <span class="comment">! The lower buffer layer has been eliminated either by convective</span></div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;      <span class="comment">! adjustment or entrainment from the interior, and its current properties</span></div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;      <span class="comment">! are not meaningful, but may later be used to determine the properties of</span></div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;      <span class="comment">! waters moving into the lower buffer layer.  So the properties of the</span></div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;      <span class="comment">! lower buffer layer are set to be between those of the upper buffer layer</span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;      <span class="comment">! and the next denser interior layer, measured by R0.  This probably does</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;      <span class="comment">! not happen very often, so I am not too worried about the inefficiency of</span></div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;      <span class="comment">! the following loop.</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;      <span class="keywordflow">do</span> k1=kb2+1,nz ; <span class="keywordflow">if</span> (h(i,k1) &gt; 2.0*angstrom) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;      r0(i,kb2) = r0(i,kb1)</div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;      rcv(i,kb2)=rcv(i,kb1) ; t(i,kb2)=t(i,kb1) ; s(i,kb2)=s(i,kb1)</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;      <span class="keywordflow">if</span> (k1 &lt;= nz) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (r0(i,k1) &gt;= r0(i,kb1)) <span class="keywordflow">then</span></div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;        r0(i,kb2) = 0.5*(r0(i,kb1)+r0(i,k1))</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;        rcv(i,kb2) = 0.5*(rcv(i,kb1)+rcv(i,k1))</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;        t(i,kb2) = 0.5*(t(i,kb1)+t(i,k1))</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;        s(i,kb2) = 0.5*(s(i,kb1)+s(i,k1))</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! (h2 = 0 &amp;&amp; h1 &gt; 0)</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;    dpe_extrap = 0.0 ; dpe_merge = 0.0</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;    mergeable_bl = .false.</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;    <span class="keywordflow">if</span> ((h1 &gt; 0.0) .and. (h2 &gt; 0.0) .and. (h_to_bl &gt; 0.0) .and. &amp;</div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;        (stable_rcv)) <span class="keywordflow">then</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;      <span class="comment">! Check whether it is permissible for the buffer layers to detrain</span></div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;      <span class="comment">! into the interior isopycnal layers.</span></div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;      <span class="comment">! Determine the layer that has the lightest target density that is</span></div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;      <span class="comment">! denser than the lowermost buffer layer.</span></div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;      <span class="keywordflow">do</span> k1=kb2+1,nz ; <span class="keywordflow">if</span> (rcvtgt(k1) &gt;= rcv(i,kb2)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span> ; k0 = k1-1</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;      dr1 = rcvtgt(k0)-rcv(i,kb1) ; dr2 = rcv(i,kb2)-rcvtgt(k0)</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;      <span class="comment">! Use an energy-balanced combination of downwind advection into the next</span></div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;      <span class="comment">! denser interior layer and upwind advection from the upper buffer layer</span></div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;      <span class="comment">! into the lower one, each with an energy change that equals that required</span></div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;      <span class="comment">! to mix the detrained water with the upper buffer layer.</span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;      h1_avail = h1 - max(0.0,h_min_bl-h_to_bl)</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;      <span class="keywordflow">if</span> ((k1&lt;=nz) .and. (h2 &gt; h_min_bl) .and. (h1_avail &gt; 0.0) .and. &amp;</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;          (r0(i,kb1) &lt; r0(i,kb2)) .and. (h_to_bl*r0(i,kb1) &gt; r0_to_bl)) <span class="keywordflow">then</span></div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;        drk1 = (rcvtgt(k1) - rcv(i,kb2)) * (r0(i,kb2) - r0(i,kb1)) / &amp;</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;                                           (rcv(i,kb2) - rcv(i,kb1))</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;        b1 = drk1 / (r0(i,kb2) - r0(i,kb1))</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;        <span class="comment">! b1 = RcvTgt(k1) - Rcv(i,kb2)) / (Rcv(i,kb2) - Rcv(i,kb1))</span></div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;        <span class="comment">! Apply several limits to the detrainment.</span></div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;        <span class="comment">! Entrain less than the mass in h2, and keep the base of the buffer</span></div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;        <span class="comment">! layers from becoming shallower than any neighbors.</span></div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;        h2_to_k1 = min(h2 - h_min_bl, h2_to_k1_rem)</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;        <span class="comment">! Balance downwind advection of density into the layer below the</span></div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;        <span class="comment">! buffer layers with upwind advection from the layer above.</span></div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;        <span class="keywordflow">if</span> (h2_to_k1*(h1_avail + b1*(h1_avail + h2)) &gt; h2*h1_avail) &amp;</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;          h2_to_k1 = (h2*h1_avail) / (h1_avail + b1*(h1_avail + h2))</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;        <span class="keywordflow">if</span> (h2_to_k1*(drk1 * h2) &gt; (h_to_bl*r0(i,kb1) - r0_to_bl) * h1) &amp;</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;          h2_to_k1 = (h_to_bl*r0(i,kb1) - r0_to_bl) * h1 / (drk1 * h2)</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;        <span class="keywordflow">if</span> ((k1==kb2+1) .and. (cs%BL_extrap_lim &gt; 0.)) <span class="keywordflow">then</span></div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;          <span class="comment">! Simply do not detrain very light water into the lightest isopycnal</span></div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;          <span class="comment">! coordinate layers if the density jump is too large.</span></div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;          drcv_lim = rcv(i,kb2)-rcv(i,0)</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;          <span class="keywordflow">do</span> k=1,kb2 ; drcv_lim = max(drcv_lim, rcv(i,kb2)-rcv(i,k)) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;          drcv_lim = cs%BL_extrap_lim*drcv_lim</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;          <span class="keywordflow">if</span> ((rcvtgt(k1) - rcv(i,kb2)) &gt;= drcv_lim) <span class="keywordflow">then</span></div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;            h2_to_k1 = 0.0</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;          <span class="keywordflow">elseif</span> ((rcvtgt(k1) - rcv(i,kb2)) &gt; 0.5*drcv_lim) <span class="keywordflow">then</span></div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;            h2_to_k1 = h2_to_k1 * (2.0 - 2.0*((rcvtgt(k1) - rcv(i,kb2)) / drcv_lim))</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;        drcv = (rcvtgt(k1) - rcv(i,kb2))</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;        <span class="comment">! Use 2nd order upwind advection of spiciness, limited by the values</span></div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;        <span class="comment">! in deeper thick layers to determine the detrained temperature and</span></div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;        <span class="comment">! salinity.</span></div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;        dspice_det = (ds_dt_gauge*drcv_ds(i)*(t(i,kb2)-t(i,kb1)) - &amp;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;                      dt_ds_gauge*drcv_dt(i)*(s(i,kb2)-s(i,kb1))) * &amp;</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;                      (h2 - h2_to_k1) / (h1 + h2)</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;        dspice_lim = 0.0</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;        <span class="keywordflow">if</span> (h(i,k1) &gt; 10.0*angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;          dspice_lim = ds_dt_gauge*drcv_ds(i)*(t(i,k1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;                       dt_ds_gauge*drcv_dt(i)*(s(i,k1)-s(i,kb2))</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;          <span class="keywordflow">if</span> (dspice_det*dspice_lim &lt;= 0.0) dspice_lim = 0.0</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        <span class="keywordflow">if</span> (k1&lt;nz) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (h(i,k1+1) &gt; 10.0*angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;          dspice_lim2 = ds_dt_gauge*drcv_ds(i)*(t(i,k1+1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;                        dt_ds_gauge*drcv_dt(i)*(s(i,k1+1)-s(i,kb2))</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;          <span class="keywordflow">if</span> ((dspice_det*dspice_lim2 &gt; 0.0) .and. &amp;</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;              (abs(dspice_lim2) &gt; abs(dspice_lim))) dspice_lim = dspice_lim2</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;        <span class="keywordflow">if</span> (abs(dspice_det) &gt; abs(dspice_lim)) dspice_det = dspice_lim</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;        i_denom = 1.0 / (drcv_ds(i)**2 + (dt_ds_gauge*drcv_dt(i))**2)</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;        t_det = t(i,kb2) + dt_ds_gauge * i_denom * &amp;</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;            (dt_ds_gauge * drcv_dt(i) * drcv + drcv_ds(i) * dspice_det)</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;        s_det = s(i,kb2) + i_denom * &amp;</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;            (drcv_ds(i) * drcv - dt_ds_gauge * drcv_dt(i) * dspice_det)</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;        <span class="comment">! The detrained values of R0 are based on changes in T and S.</span></div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;        r0_det = r0(i,kb2) + (t_det-t(i,kb2)) * dr0_dt(i) + &amp;</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;                             (s_det-s(i,kb2)) * dr0_ds(i)</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;        <span class="keywordflow">if</span> (cs%BL_extrap_lim &gt;= 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;          <span class="comment">! Only do this detrainment if the new layer&#39;s temperature and salinity</span></div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;          <span class="comment">! are not too far outside of the range of previous values.</span></div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;          <span class="keywordflow">if</span> (h(i,k1) &gt; 10.0*angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;            t_min = min(t(i,kb1), t(i,kb2), t(i,k1)) - cs%Allowed_T_chg</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;            t_max = max(t(i,kb1), t(i,kb2), t(i,k1)) + cs%Allowed_T_chg</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;            s_min = min(s(i,kb1), s(i,kb2), s(i,k1)) - cs%Allowed_S_chg</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;            s_max = max(s(i,kb1), s(i,kb2), s(i,k1)) + cs%Allowed_S_chg</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;            t_min = min(t(i,kb1), t(i,kb2)) - cs%Allowed_T_chg</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;            t_max = max(t(i,kb1), t(i,kb2)) + cs%Allowed_T_chg</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;            s_min = min(s(i,kb1), s(i,kb2)) - cs%Allowed_S_chg</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;            s_max = max(s(i,kb1), s(i,kb2)) + cs%Allowed_S_chg</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;          ihk1 = 1.0 / (h(i,k1) + h2_to_k1)</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;          t_new = (h(i,k1)*t(i,k1) + h2_to_k1*t_det) * ihk1</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;          s_new = (h(i,k1)*s(i,k1) + h2_to_k1*s_det) * ihk1</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;          <span class="comment">! A less restrictive limit might be used here.</span></div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;          <span class="keywordflow">if</span> ((t_new &lt; t_min) .or. (t_new &gt; t_max) .or. &amp;</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;              (s_new &lt; s_min) .or. (s_new &gt; s_max)) &amp;</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;            h2_to_k1 = 0.0</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;        h1_to_h2 = b1*h2*h2_to_k1 / (h2 - (1.0+b1)*h2_to_k1)</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;        ihk1 = 1.0 / (h(i,k1) + h_neglect + h2_to_k1)</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;        ih2f = 1.0 / ((h(i,kb2) - h2_to_k1) + h1_to_h2)</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;        rcv(i,kb2) = ((h(i,kb2)*rcv(i,kb2) - h2_to_k1*rcvtgt(k1)) + &amp;</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;                      h1_to_h2*rcv(i,kb1))*ih2f</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;        rcv(i,k1) = ((h(i,k1)+h_neglect)*rcv(i,k1) + h2_to_k1*rcvtgt(k1)) * ihk1</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;        t(i,kb2) = ((h(i,kb2)*t(i,kb2) - h2_to_k1*t_det) + &amp;</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;                    h1_to_h2*t(i,kb1)) * ih2f</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;        t(i,k1) = ((h(i,k1)+h_neglect)*t(i,k1) + h2_to_k1*t_det) * ihk1</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;        s(i,kb2) = ((h(i,kb2)*s(i,kb2) - h2_to_k1*s_det) + &amp;</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;                    h1_to_h2*s(i,kb1)) * ih2f</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;        s(i,k1) = ((h(i,k1)+h_neglect)*s(i,k1) + h2_to_k1*s_det) * ihk1</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;        <span class="comment">! Changes in R0 are based on changes in T and S.</span></div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;        r0(i,kb2) = ((h(i,kb2)*r0(i,kb2) - h2_to_k1*r0_det) + &amp;</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;                     h1_to_h2*r0(i,kb1)) * ih2f</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;        r0(i,k1) = ((h(i,k1)+h_neglect)*r0(i,k1) + h2_to_k1*r0_det) * ihk1</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;        h(i,kb1) = h(i,kb1) - h1_to_h2 ; h1 = h(i,kb1)</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;        h(i,kb2) = (h(i,kb2) - h2_to_k1) + h1_to_h2 ; h2 = h(i,kb2)</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;        h(i,k1) = h(i,k1) + h2_to_k1</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;        d_ea(i,kb1) = d_ea(i,kb1) - h1_to_h2</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;        d_ea(i,kb2) = (d_ea(i,kb2) - h2_to_k1) + h1_to_h2</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;        d_ea(i,k1) = d_ea(i,k1) + h2_to_k1</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;        h2_to_k1_rem = max(h2_to_k1_rem - h2_to_k1, 0.0)</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;        <span class="comment">!   The lower buffer layer has become lighter - it may be necessary to</span></div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;        <span class="comment">! adjust k1 lighter.</span></div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        <span class="keywordflow">if</span> ((k1&gt;kb2+1) .and. (rcvtgt(k1-1) &gt;= rcv(i,kb2))) <span class="keywordflow">then</span></div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;          <span class="keywordflow">do</span> k1=k1,kb2+1,-1 ; <span class="keywordflow">if</span> (rcvtgt(k1-1) &lt; rcv(i,kb2)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;      k0 = k1-1</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;      dr1 = rcvtgt(k0)-rcv(i,kb1) ; dr2 = rcv(i,kb2)-rcvtgt(k0)</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;      <span class="keywordflow">if</span> ((k0&gt;kb2) .and. (dr1 &gt; 0.0) .and. (h1 &gt; h_min_bl) .and. &amp;</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;          (h2*dr2 &lt; h1*dr1) .and. (r0(i,kb2) &gt; r0(i,kb1))) <span class="keywordflow">then</span></div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;        <span class="comment">! An interior isopycnal layer (k0) is intermediate in density between</span></div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;        <span class="comment">! the two buffer layers, and there can be detrainment. The entire</span></div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;        <span class="comment">! lower buffer layer is combined with a portion of the upper buffer</span></div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;        <span class="comment">! layer to match the target density of layer k0.</span></div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;        stays_merge = 2.0*(h1+h2)*(h1*dr1 - h2*dr2) / &amp;</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;                     ((dr1+dr2)*h1 + dr1*(h1+h2) + &amp;</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;                      sqrt((dr2*h1-dr1*h2)**2 + 4*(h1+h2)*h2*(dr1+dr2)*dr2))</div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;        stays_min_merge = max(h_min_bl, 2.0*h_min_bl - h_to_bl, &amp;</div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;                  h1 - (h1+h2)*(r0(i,kb1) - r0_det) / (r0(i,kb2) - r0(i,kb1)))</div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;        <span class="keywordflow">if</span> ((stays_merge &gt; stays_min_merge) .and. &amp;</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;            (stays_merge + h2_to_k1_rem &gt;= h1 + h2)) <span class="keywordflow">then</span></div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;          mergeable_bl = .true.</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;          dpe_merge = g_2*(r0(i,kb2)-r0(i,kb1))*(h1-stays_merge)*(h2-stays_merge)</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;      <span class="keywordflow">if</span> ((k1&lt;=nz).and.(.not.mergeable_bl)) <span class="keywordflow">then</span></div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;        <span class="comment">! Check whether linear extrapolation of density (i.e. 2nd order upwind</span></div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;        <span class="comment">! advection) will allow some of the lower buffer layer to detrain into</span></div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;        <span class="comment">! the next denser interior layer (k1).</span></div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;        dr2b = rcvtgt(k1)-rcv(i,kb2) ; dr21 = rcv(i,kb2) - rcv(i,kb1)</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;        <span class="keywordflow">if</span> (dr2b*(h1+h2) &lt; h2*dr21) <span class="keywordflow">then</span></div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;          <span class="comment">! Some of layer kb2 is denser than k1.</span></div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;          h2_to_k1 = min(h2 - (h1+h2) * dr2b / dr21, h2_to_k1_rem)</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;          <span class="keywordflow">if</span> (h2 &gt; h2_to_k1) <span class="keywordflow">then</span></div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;            drcv = (rcvtgt(k1) - rcv(i,kb2))</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;            <span class="comment">! Use 2nd order upwind advection of spiciness, limited by the values</span></div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;            <span class="comment">! in deeper thick layers to determine the detrained temperature and</span></div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;            <span class="comment">! salinity.</span></div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;            dspice_det = (ds_dt_gauge*drcv_ds(i)*(t(i,kb2)-t(i,kb1)) - &amp;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;                          dt_ds_gauge*drcv_dt(i)*(s(i,kb2)-s(i,kb1))) * &amp;</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;                          (h2 - h2_to_k1) / (h1 + h2)</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;            dspice_lim = 0.0</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;            <span class="keywordflow">if</span> (h(i,k1) &gt; 10.0*angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;              dspice_lim = ds_dt_gauge*drcv_ds(i)*(t(i,k1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;                           dt_ds_gauge*drcv_dt(i)*(s(i,k1)-s(i,kb2))</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;              <span class="keywordflow">if</span> (dspice_det*dspice_lim &lt;= 0.0) dspice_lim = 0.0</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;            <span class="keywordflow">if</span> (k1&lt;nz) then; <span class="keywordflow">if</span> (h(i,k1+1) &gt; 10.0*angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;              dspice_lim2 = ds_dt_gauge*drcv_ds(i)*(t(i,k1+1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;                            dt_ds_gauge*drcv_dt(i)*(s(i,k1+1)-s(i,kb2))</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;              <span class="keywordflow">if</span> ((dspice_det*dspice_lim2 &gt; 0.0) .and. &amp;</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;                  (abs(dspice_lim2) &gt; abs(dspice_lim))) dspice_lim = dspice_lim2</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;<span class="keyword">            end</span>if; endif</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;            <span class="keywordflow">if</span> (abs(dspice_det) &gt; abs(dspice_lim)) dspice_det = dspice_lim</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;            i_denom = 1.0 / (drcv_ds(i)**2 + (dt_ds_gauge*drcv_dt(i))**2)</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;            t_det = t(i,kb2) + dt_ds_gauge * i_denom * &amp;</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;                (dt_ds_gauge * drcv_dt(i) * drcv + drcv_ds(i) * dspice_det)</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;            s_det = s(i,kb2) + i_denom * &amp;</div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;                (drcv_ds(i) * drcv - dt_ds_gauge * drcv_dt(i) * dspice_det)</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;            <span class="comment">! The detrained values of R0 are based on changes in T and S.</span></div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;            r0_det = r0(i,kb2) + (t_det-t(i,kb2)) * dr0_dt(i) + &amp;</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;                                 (s_det-s(i,kb2)) * dr0_ds(i)</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;            <span class="comment">! Now that the properties of the detrained water are known,</span></div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;            <span class="comment">! potentially limit the amount of water that is detrained to</span></div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;            <span class="comment">! avoid creating unphysical properties in the remaining water.</span></div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;            ih2f = 1.0 / (h2 - h2_to_k1)</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;            t_min = min(t(i,kb2), t(i,kb1)) - cs%Allowed_T_chg</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;            t_max = max(t(i,kb2), t(i,kb1)) + cs%Allowed_T_chg</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;            t_new = (h2*t(i,kb2) - h2_to_k1*t_det)*ih2f</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;            <span class="keywordflow">if</span> (t_new &lt; t_min) <span class="keywordflow">then</span></div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;              h2_to_k1_lim = h2 * (t(i,kb2) - t_min) / (t_det - t_min)</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment">!               write(mesg,&#39;(&quot;Low temperature limits det to &quot;, &amp;</span></div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment">!                    &amp; 1pe12.5, &quot; from &quot;, 1pe12.5, &quot; at &quot;, 1pg11.4,&quot;E, &quot;,1pg11.4,&quot;N. T=&quot;, &amp;</span></div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;<span class="comment">!                    &amp; 5(1pe12.5))&#39;) &amp;</span></div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;<span class="comment">!                    h2_to_k1_lim, h2_to_k1, G%geoLonT(i,j), G%geoLatT(i,j), &amp;</span></div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;<span class="comment">!                    T_new, T(i,kb2), T(i,kb1), T_det, T_new-T_min</span></div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;<span class="comment">!               call MOM_error(WARNING, mesg)</span></div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;              h2_to_k1 = h2_to_k1_lim</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;              ih2f = 1.0 / (h2 - h2_to_k1)</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;            <span class="keywordflow">elseif</span> (t_new &gt; t_max) <span class="keywordflow">then</span></div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;              h2_to_k1_lim = h2 * (t(i,kb2) - t_max) / (t_det - t_max)</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;<span class="comment">!               write(mesg,&#39;(&quot;High temperature limits det to &quot;, &amp;</span></div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;<span class="comment">!                    &amp; 1pe12.5, &quot; from &quot;, 1pe12.5, &quot; at &quot;, 1pg11.4,&quot;E, &quot;,1pg11.4,&quot;N. T=&quot;, &amp;</span></div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="comment">!                    &amp; 5(1pe12.5))&#39;) &amp;</span></div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;<span class="comment">!                    h2_to_k1_lim, h2_to_k1, G%geoLonT(i,j), G%geoLatT(i,j), &amp;</span></div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;<span class="comment">!                    T_new, T(i,kb2), T(i,kb1), T_det, T_new-T_max</span></div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;<span class="comment">!               call MOM_error(WARNING, mesg)</span></div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;              h2_to_k1 = h2_to_k1_lim</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;              ih2f = 1.0 / (h2 - h2_to_k1)</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;            s_min = max(min(s(i,kb2), s(i,kb1)) - cs%Allowed_S_chg, 0.0)</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;            s_max = max(s(i,kb2), s(i,kb1)) + cs%Allowed_S_chg</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;            s_new = (h2*s(i,kb2) - h2_to_k1*s_det)*ih2f</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;            <span class="keywordflow">if</span> (s_new &lt; s_min) <span class="keywordflow">then</span></div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;              h2_to_k1_lim = h2 * (s(i,kb2) - s_min) / (s_det - s_min)</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;<span class="comment">!               write(mesg,&#39;(&quot;Low salinity limits det to &quot;, &amp;</span></div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;<span class="comment">!                    &amp; 1pe12.5, &quot; from &quot;, 1pe12.5, &quot; at &quot;, 1pg11.4,&quot;E, &quot;,1pg11.4,&quot;N. S=&quot;, &amp;</span></div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;<span class="comment">!                    &amp; 5(1pe12.5))&#39;) &amp;</span></div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;<span class="comment">!                    h2_to_k1_lim, h2_to_k1, G%geoLonT(i,j), G%geoLatT(i,j), &amp;</span></div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;<span class="comment">!                    S_new, S(i,kb2), S(i,kb1), S_det, S_new-S_min</span></div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;<span class="comment">!               call MOM_error(WARNING, mesg)</span></div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;              h2_to_k1 = h2_to_k1_lim</div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;              ih2f = 1.0 / (h2 - h2_to_k1)</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;            <span class="keywordflow">elseif</span> (s_new &gt; s_max) <span class="keywordflow">then</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;              h2_to_k1_lim = h2 * (s(i,kb2) - s_max) / (s_det - s_max)</div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;<span class="comment">!               write(mesg,&#39;(&quot;High salinity limits det to &quot;, &amp;</span></div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;<span class="comment">!                    &amp; 1pe12.5, &quot; from &quot;, 1pe12.5, &quot; at &quot;, 1pg11.4,&quot;E, &quot;,1pg11.4,&quot;N. S=&quot;, &amp;</span></div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;<span class="comment">!                    &amp; 5(1pe12.5))&#39;) &amp;</span></div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;<span class="comment">!                    h2_to_k1_lim, h2_to_k1, G%geoLonT(i,j), G%geoLatT(i,j), &amp;</span></div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;<span class="comment">!                    S_new, S(i,kb2), S(i,kb1), S_det, S_new-S_max</span></div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;<span class="comment">!               call MOM_error(WARNING, mesg)</span></div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;              h2_to_k1 = h2_to_k1_lim</div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;              ih2f = 1.0 / (h2 - h2_to_k1)</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;</div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;            ihk1 = 1.0 / (h(i,k1) + h_neglect + h2_to_k1)</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;            rcv(i,k1) = ((h(i,k1)+h_neglect)*rcv(i,k1) + h2_to_k1*rcvtgt(k1)) * ihk1</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;            rcv(i,kb2) = rcv(i,kb2) - h2_to_k1*drcv*ih2f</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;            t(i,kb2) = (h2*t(i,kb2) - h2_to_k1*t_det)*ih2f</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;            t(i,k1) = ((h(i,k1)+h_neglect)*t(i,k1) + h2_to_k1*t_det) * ihk1</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;            s(i,kb2) = (h2*s(i,kb2) - h2_to_k1*s_det) * ih2f</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;            s(i,k1) = ((h(i,k1)+h_neglect)*s(i,k1) + h2_to_k1*s_det) * ihk1</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;            <span class="comment">! Changes in R0 are based on changes in T and S.</span></div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;            r0(i,kb2) = (h2*r0(i,kb2) - h2_to_k1*r0_det) * ih2f</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;            r0(i,k1) = ((h(i,k1)+h_neglect)*r0(i,k1) + h2_to_k1*r0_det) * ihk1</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;            <span class="comment">! h2==h2_to_k1 can happen if dR2b = 0 exactly, but this is very</span></div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;            <span class="comment">! unlikely.  In this case the entirety of layer kb2 is detrained.</span></div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;            h2_to_k1 = h2  <span class="comment">! These 2 lines are probably unnecessary.</span></div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;            ihk1 = 1.0 / (h(i,k1) + h2)</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;            rcv(i,k1) = (h(i,k1)*rcv(i,k1) + h2*rcv(i,kb2)) * ihk1</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;            t(i,k1) = (h(i,k1)*t(i,k1) + h2*t(i,kb2)) * ihk1</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;            s(i,k1) = (h(i,k1)*s(i,k1) + h2*s(i,kb2)) * ihk1</div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;            r0(i,k1) = (h(i,k1)*r0(i,k1) + h2*r0(i,kb2)) * ihk1</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;          h(i,k1) = h(i,k1) + h2_to_k1</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;          h(i,kb2) = h(i,kb2) - h2_to_k1 ; h2 = h(i,kb2)</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;          <span class="comment">! dPE_extrap should be positive here.</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;          dpe_extrap = i2rho0*(r0_det-r0(i,kb2))*h2_to_k1*h2</div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;          d_ea(i,kb2) = d_ea(i,kb2) - h2_to_k1</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;          d_ea(i,k1) = d_ea(i,k1) + h2_to_k1</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;          h2_to_k1_rem = max(h2_to_k1_rem - h2_to_k1, 0.0)</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! Detrainment by extrapolation.</span></div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;</div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! Detrainment to the interior at all.</span></div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;    <span class="comment">! Does some of the detrained water go into the lower buffer layer?</span></div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;    h_det_h2 = max(h_min_bl-(h1+h2), 0.0)</div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;    <span class="keywordflow">if</span> (h_det_h2 &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;      <span class="comment">! Detrained water will go into both upper and lower buffer layers.</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;      <span class="comment">! h(kb2) will be h_min_bl, but h(kb1) may be larger if there was already</span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;      <span class="comment">! ample detrainment; all water in layer kb1 moves into layer kb2.</span></div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;      <span class="comment">! Determine the fluxes between the various layers.</span></div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;      h_det_to_h2 = min(h_to_bl, h_det_h2)</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;      h_ml_to_h2 = h_det_h2 - h_det_to_h2</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;      h_det_to_h1 = h_to_bl - h_det_to_h2</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;      h_ml_to_h1 = max(h_min_bl-h_det_to_h1,0.0)</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;      ih = 1.0/h_min_bl;</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;      ihdet = 0.0 ; <span class="keywordflow">if</span> (h_to_bl &gt; 0.0) ihdet = 1.0 / h_to_bl</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;      ih1f = 1.0 / (h_det_to_h1 + h_ml_to_h1)</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;      r0(i,kb2) = ((h2*r0(i,kb2) + h1*r0(i,kb1)) + &amp;</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;                   (h_det_to_h2*r0_to_bl*ihdet + h_ml_to_h2*r0(i,0))) * ih</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;      r0(i,kb1) = (h_det_to_h1*r0_to_bl*ihdet + h_ml_to_h1*r0(i,0)) * ih1f</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;      rcv(i,kb2) = ((h2*rcv(i,kb2) + h1*rcv(i,kb1)) + &amp;</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;                    (h_det_to_h2*rcv_to_bl*ihdet + h_ml_to_h2*rcv(i,0))) * ih</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;      rcv(i,kb1) = (h_det_to_h1*rcv_to_bl*ihdet + h_ml_to_h1*rcv(i,0)) * ih1f</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;      t(i,kb2) = ((h2*t(i,kb2) + h1*t(i,kb1)) + &amp;</div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;                  (h_det_to_h2*t_to_bl*ihdet + h_ml_to_h2*t(i,0))) * ih</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;      t(i,kb1) = (h_det_to_h1*t_to_bl*ihdet + h_ml_to_h1*t(i,0)) * ih1f</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;      s(i,kb2) = ((h2*s(i,kb2) + h1*s(i,kb1)) + &amp;</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;                  (h_det_to_h2*s_to_bl*ihdet + h_ml_to_h2*s(i,0))) * ih</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;      s(i,kb1) = (h_det_to_h1*s_to_bl*ihdet + h_ml_to_h1*s(i,0)) * ih1f</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;      <span class="comment">! Recall that h1 = h(i,kb1) &amp; h2 = h(i,kb2).</span></div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;      d_ea(i,1) = d_ea(i,1) - (h_ml_to_h1 + h_ml_to_h2)</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;      d_ea(i,kb1) = d_ea(i,kb1) + ((h_det_to_h1 + h_ml_to_h1) - h1)</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;      d_ea(i,kb2) = d_ea(i,kb2) + (h_min_bl - h2)</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;      h(i,kb1) = h_det_to_h1 + h_ml_to_h1 ; h(i,kb2) = h_min_bl</div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;      h(i,0) = h(i,0) - (h_ml_to_h1 + h_ml_to_h2)</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;</div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain) .or. <span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) <span class="keywordflow">then</span></div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;        r0_det = r0_to_bl*ihdet</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;        s1en = g_2 * idt_h2 * ( ((r0(i,kb2)-r0(i,kb1))*h1*h2 + &amp;</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;            h_det_to_h2*( (r0(i,kb1)-r0_det)*h1 + (r0(i,kb2)-r0_det)*h2 ) + &amp;</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;            h_ml_to_h2*( (r0(i,kb2)-r0(i,0))*h2 + (r0(i,kb1)-r0(i,0))*h1 + &amp;</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;                         (r0_det-r0(i,0))*h_det_to_h2 ) + &amp;</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;            h_det_to_h1*h_ml_to_h1*(r0_det-r0(i,0))) - 2.0*gv%Rho0*dpe_extrap )</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;</div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) &amp;</div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;          cs%diag_PE_detrain(i,j) = cs%diag_PE_detrain(i,j) + s1en</div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) cs%diag_PE_detrain2(i,j) = &amp;</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;            cs%diag_PE_detrain2(i,j) + s1en + idt_h2*rho0xg*dpe_extrap</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;    <span class="keywordflow">elseif</span> ((h_to_bl &gt; 0.0) .or. (h1 &lt; h_min_bl) .or. (h2 &lt; h_min_bl)) <span class="keywordflow">then</span></div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;    <span class="comment">! Determine how much of the upper buffer layer will be moved into</span></div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    <span class="comment">! the lower buffer layer and the properties with which it is moving.</span></div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    <span class="comment">! This implementation assumes a 2nd-order upwind advection of density</span></div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    <span class="comment">! from the uppermost buffer layer into the next one down.</span></div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;      h_from_ml = h_min_bl + max(h_min_bl-h2,0.0) - h1 - h_to_bl</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;      <span class="keywordflow">if</span> (h_from_ml &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;        <span class="comment">! Some water needs to be moved from the mixed layer so that the upper</span></div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;        <span class="comment">! (and perhaps lower) buffer layers exceed their minimum thicknesses.</span></div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;        dpe_extrap = dpe_extrap - i2rho0*h_from_ml*(r0_to_bl - r0(i,0)*h_to_bl)</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;        r0_to_bl = r0_to_bl + h_from_ml*r0(i,0)</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;        rcv_to_bl = rcv_to_bl + h_from_ml*rcv(i,0)</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;        t_to_bl = t_to_bl + h_from_ml*t(i,0)</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;        s_to_bl = s_to_bl + h_from_ml*s(i,0)</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;        h_to_bl = h_to_bl + h_from_ml</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;        h(i,0) = h(i,0) - h_from_ml</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;        d_ea(i,1) = d_ea(i,1) - h_from_ml</div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;      <span class="comment">! The absolute value should be unnecessary and 1e9 is just a large number.</span></div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;      b1 = 1.0e9</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;      <span class="keywordflow">if</span> (r0(i,kb2) - r0(i,kb1) &gt; 1.0e-9*abs(r0(i,kb1) - r0_det)) &amp;</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;        b1 = abs(r0(i,kb1) - r0_det) / (r0(i,kb2) - r0(i,kb1))</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;      stays_min = max((1.0-b1)*h1 - b1*h2, 0.0, h_min_bl - h_to_bl)</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;      stays_max = h1 - max(h_min_bl-h2,0.0)</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;      scale_slope = 1.0</div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;      <span class="keywordflow">if</span> (stays_max &lt;= stays_min) <span class="keywordflow">then</span></div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        stays = stays_max</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;        mergeable_bl = .false.</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;        <span class="keywordflow">if</span> (stays_max &lt; h1) scale_slope = (h1 - stays_min) / (h1 - stays_max)</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;        <span class="comment">! There are numerous temporary variables used here that should not be</span></div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;        <span class="comment">! used outside of this &quot;else&quot; branch: s1, s2, s3sq, I_ya, bh0</span></div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        bh0 = b1*h_to_bl</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;        i_ya =  (h1 + h2) / ((h1 + h2) + h_to_bl)</div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;        <span class="comment">! s1 is the amount staying that minimizes the PE increase.</span></div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;        s1 = 0.5*(h1 + (h2 - bh0) * i_ya) ; s2 = h1 - s1</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;        <span class="keywordflow">if</span> (s2 &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;          <span class="comment">! The energy released by detrainment from the lower buffer layer can be</span></div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;          <span class="comment">! used to mix water from the upper buffer layer into the lower one.</span></div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;          s3sq = i_ya*max(bh0*h1-dpe_extrap, 0.0)</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;          s3sq = i_ya*(bh0*h1-min(dpe_extrap,0.0))</div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;</div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;        <span class="keywordflow">if</span> (s3sq == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;          <span class="comment">! There is a simple, exact solution to the quadratic equation, namely:</span></div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;          stays = h1 <span class="comment">! This will revert to stays_max later.</span></div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;        <span class="keywordflow">elseif</span> (s2*s2 &lt;= s3sq) <span class="keywordflow">then</span></div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;          <span class="comment">! There is no solution with 0 PE change - use the minimum energy input.</span></div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;          stays = s1</div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;          <span class="comment">! The following choose the solutions that are continuous with all water</span></div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;          <span class="comment">! staying in the upper buffer layer when there is no detrainment,</span></div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;          <span class="comment">! namely the + root when s2&gt;0 and the - root otherwise. They also</span></div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;          <span class="comment">! carefully avoid differencing large numbers, using s2 = (h1-s).</span></div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;          <span class="keywordflow">if</span> (bh0 &lt;= 0.0) <span class="keywordflow">then</span> ; stays = h1</div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;          <span class="keywordflow">elseif</span> (s2 &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;  <span class="comment">!         stays = s + sqrt(s2*s2 - s3sq) ! Note that s2 = h1-s</span></div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;            <span class="keywordflow">if</span> (s1 &gt;= stays_max) <span class="keywordflow">then</span> ; stays = stays_max</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;            <span class="keywordflow">elseif</span> (s1 &gt;= 0.0) <span class="keywordflow">then</span> ; stays = s1 + sqrt(s2*s2 - s3sq)</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;            <span class="keywordflow">else</span> ; stays = (h1*(s2-s1) - s3sq) / (-s1 + sqrt(s2*s2 - s3sq))</div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;  <span class="comment">!         stays = s - sqrt(s2*s2 - s3sq) ! Note that s2 = h1-s &amp; stays_min &gt;= 0</span></div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;            <span class="keywordflow">if</span> (s1 &lt;= stays_min) <span class="keywordflow">then</span> ; stays = stays_min</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;            <span class="keywordflow">else</span> ; stays = (h1*(s1-s2) + s3sq) / (s1 + sqrt(s2*s2 - s3sq))</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;        <span class="comment">! Limit the amount that stays so that the motion of water is from the</span></div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;        <span class="comment">! upper buffer layer into the lower, but no more than is in the upper</span></div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;        <span class="comment">! layer, and the water left in the upper layer is no lighter than the</span></div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;        <span class="comment">! detrained water.</span></div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        <span class="keywordflow">if</span> (stays &gt;= stays_max) <span class="keywordflow">then</span> ; stays = stays_max</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;        <span class="keywordflow">elseif</span> (stays &lt; stays_min) <span class="keywordflow">then</span> ; stays = stays_min</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;      dpe_det = g_2*((r0(i,kb1)*h_to_bl - r0_to_bl)*stays + &amp;</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;                     (r0(i,kb2)-r0(i,kb1)) * (h1-stays) * &amp;</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;                     (h2 - scale_slope*stays*((h1+h2)+h_to_bl)/(h1+h2)) ) - &amp;</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;                rho0xg*dpe_extrap</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;      <span class="keywordflow">if</span> (dpe_time_ratio*h_to_bl &gt; h_to_bl+h(i,0)) <span class="keywordflow">then</span></div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;        dpe_ratio = (h_to_bl+h(i,0)) / h_to_bl</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;        dpe_ratio = dpe_time_ratio</div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;</div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;      <span class="keywordflow">if</span> ((mergeable_bl) .and. (num_events*dpe_ratio*dpe_det &gt; dpe_merge)) <span class="keywordflow">then</span></div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;        <span class="comment">! It is energetically preferable to merge the two buffer layers, detrain</span></div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;        <span class="comment">! them into interior layer (k0), move the remaining upper buffer layer</span></div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;        <span class="comment">! water into the lower buffer layer, and detrain undiluted into the</span></div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;        <span class="comment">! upper buffer layer.</span></div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;        h1_to_k0 = (h1-stays_merge)</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;        stays = max(h_min_bl-h_to_bl,0.0)</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;        h1_to_h2 = stays_merge - stays</div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;        ihk0 = 1.0 / ((h1_to_k0 + h2) + h(i,k0))</div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;        ih1f = 1.0 / (h_to_bl + stays); ih2f = 1.0 / h1_to_h2</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;        ih12 = 1.0 / (h1 + h2)</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;        drcv_2dz = (rcv(i,kb1) - rcv(i,kb2)) * ih12</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;        drcv_stays = drcv_2dz*(h1_to_k0 + h1_to_h2)</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;        drcv_det = - drcv_2dz*(stays + h1_to_h2)</div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;        rcv(i,k0) = ((h1_to_k0*(rcv(i,kb1) + drcv_det) + &amp;</div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;                      h2*rcv(i,kb2)) + h(i,k0)*rcv(i,k0)) * ihk0</div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;        rcv(i,kb2) = rcv(i,kb1) + drcv_2dz*(h1_to_k0-stays)</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;        rcv(i,kb1) = (rcv_to_bl + stays*(rcv(i,kb1) + drcv_stays)) * ih1f</div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;</div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;        <span class="comment">! Use 2nd order upwind advection of spiciness, limited by the value in</span></div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;        <span class="comment">! the water from the mixed layer to determine the temperature and</span></div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;        <span class="comment">! salinity of the water that stays in the buffer layers.</span></div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;        i_denom = 1.0 / (drcv_ds(i)**2 + (dt_ds_gauge*drcv_dt(i))**2)</div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;        dspice_2dz = (ds_dt_gauge*drcv_ds(i)*(t(i,kb1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;                      dt_ds_gauge*drcv_dt(i)*(s(i,kb1)-s(i,kb2))) * ih12</div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;        dspice_lim = (ds_dt_gauge*dr0_ds(i)*(t_to_bl-t(i,kb1)*h_to_bl) - &amp;</div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;                      dt_ds_gauge*dr0_dt(i)*(s_to_bl-s(i,kb1)*h_to_bl)) / h_to_bl</div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;        <span class="keywordflow">if</span> (dspice_lim * dspice_2dz &lt;= 0.0) dspice_2dz = 0.0</div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;        <span class="keywordflow">if</span> (stays &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;        <span class="comment">! Limit the spiciness of the water that stays in the upper buffer layer.</span></div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;          <span class="keywordflow">if</span> (abs(dspice_lim) &lt; abs(dspice_2dz*(h1_to_k0 + h1_to_h2))) &amp;</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;            dspice_2dz = dspice_lim/(h1_to_k0 + h1_to_h2)</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;          dspice_stays = dspice_2dz*(h1_to_k0 + h1_to_h2)</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;          t_stays = t(i,kb1) + dt_ds_gauge * i_denom * &amp;</div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;              (dt_ds_gauge * drcv_dt(i) * drcv_stays + drcv_ds(i) * dspice_stays)</div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;          s_stays = s(i,kb1) + i_denom * &amp;</div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;              (drcv_ds(i) * drcv_stays - dt_ds_gauge * drcv_dt(i) * dspice_stays)</div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;          <span class="comment">! The values of R0 are based on changes in T and S.</span></div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;          r0_stays = r0(i,kb1) + (t_stays-t(i,kb1)) * dr0_dt(i) + &amp;</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;                                 (s_stays-s(i,kb1)) * dr0_ds(i)</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;          <span class="comment">! Limit the spiciness of the water that moves into the lower buffer layer.</span></div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;          <span class="keywordflow">if</span> (abs(dspice_lim) &lt; abs(dspice_2dz*h1_to_k0)) &amp;</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;            dspice_2dz = dspice_lim/h1_to_k0</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;          <span class="comment">! These will be multiplied by 0 later.</span></div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;          t_stays = 0.0 ; s_stays = 0.0 ; r0_stays = 0.0</div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;</div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;        dspice_det = - dspice_2dz*(stays + h1_to_h2)</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;        t_det = t(i,kb1) + dt_ds_gauge * i_denom * &amp;</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;            (dt_ds_gauge * drcv_dt(i) * drcv_det + drcv_ds(i) * dspice_det)</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;        s_det = s(i,kb1) + i_denom * &amp;</div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;            (drcv_ds(i) * drcv_det - dt_ds_gauge * drcv_dt(i) * dspice_det)</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;        <span class="comment">! The values of R0 are based on changes in T and S.</span></div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;        r0_det = r0(i,kb1) + (t_det-t(i,kb1)) * dr0_dt(i) + &amp;</div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;                             (s_det-s(i,kb1)) * dr0_ds(i)</div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;</div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;        t(i,k0) = ((h1_to_k0*t_det + h2*t(i,kb2)) + h(i,k0)*t(i,k0)) * ihk0</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;        t(i,kb2) = (h1*t(i,kb1) - stays*t_stays - h1_to_k0*t_det) * ih2f</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;        t(i,kb1) = (t_to_bl + stays*t_stays) * ih1f</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;        s(i,k0) = ((h1_to_k0*s_det + h2*s(i,kb2)) + h(i,k0)*s(i,k0)) * ihk0</div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;        s(i,kb2) = (h1*s(i,kb1) - stays*s_stays - h1_to_k0*s_det) * ih2f</div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;        s(i,kb1) = (s_to_bl + stays*s_stays) * ih1f</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;</div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;        r0(i,k0) = ((h1_to_k0*r0_det + h2*r0(i,kb2)) + h(i,k0)*r0(i,k0)) * ihk0</div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;        r0(i,kb2) = (h1*r0(i,kb1) - stays*r0_stays - h1_to_k0*r0_det) * ih2f</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;        r0(i,kb1) = (r0_to_bl + stays*r0_stays) * ih1f</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;<span class="comment">!        ! The following is 2nd-order upwind advection without limiters.</span></div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;<span class="comment">!        dT_2dz = (T(i,kb1) - T(i,kb2)) * Ih12</span></div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;<span class="comment">!        T(i,k0) = (h1_to_k0*(T(i,kb1) - dT_2dz*(stays+h1_to_h2)) + &amp;</span></div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;<span class="comment">!                     h2*T(i,kb2) + h(i,k0)*T(i,k0)) * Ihk0</span></div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;<span class="comment">!        T(i,kb2) = T(i,kb1) + dT_2dz*(h1_to_k0-stays)</span></div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;<span class="comment">!        T(i,kb1) = (T_to_bl + stays*(T(i,kb1) + &amp;</span></div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;<span class="comment">!                      dT_2dz*(h1_to_k0 + h1_to_h2))) * Ih1f</span></div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;<span class="comment">!        dS_2dz = (S(i,kb1) - S(i,kb2)) * Ih12</span></div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;<span class="comment">!        S(i,k0) = (h1_to_k0*(S(i,kb1) - dS_2dz*(stays+h1_to_h2)) + &amp;</span></div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;<span class="comment">!                     h2*S(i,kb2) + h(i,k0)*S(i,k0)) * Ihk0</span></div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;<span class="comment">!        S(i,kb2) = S(i,kb1) + dS_2dz*(h1_to_k0-stays)</span></div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;<span class="comment">!        S(i,kb1) = (S_to_bl + stays*(S(i,kb1) + &amp;</span></div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;<span class="comment">!                      dS_2dz*(h1_to_k0 + h1_to_h2))) * Ih1f</span></div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;<span class="comment">!        dR0_2dz = (R0(i,kb1) - R0(i,kb2)) * Ih12</span></div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;<span class="comment">!        R0(i,k0) = (h1_to_k0*(R0(i,kb1) - dR0_2dz*(stays+h1_to_h2)) + &amp;</span></div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;<span class="comment">!                    h2*R0(i,kb2) + h(i,k0)*R0(i,k0)) * Ihk0</span></div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;<span class="comment">!        R0(i,kb2) = R0(i,kb1) + dR0_2dz*(h1_to_k0-stays)</span></div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;<span class="comment">!        R0(i,kb1) = (R0_to_bl + stays*(R0(i,kb1) + &amp;</span></div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;<span class="comment">!                     dR0_2dz*(h1_to_k0 + h1_to_h2))) * Ih1f</span></div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;</div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;        d_ea(i,kb1) = (d_ea(i,kb1) + h_to_bl) + (stays - h1)</div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;        d_ea(i,kb2) = d_ea(i,kb2) + (h1_to_h2 - h2)</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;        d_ea(i,k0) = d_ea(i,k0) + (h1_to_k0 + h2)</div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        h(i,kb1) = stays + h_to_bl</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        h(i,kb2) = h1_to_h2</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;        h(i,k0) = h(i,k0) + (h1_to_k0 + h2)</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) &amp;</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;          cs%diag_PE_detrain(i,j) = cs%diag_PE_detrain(i,j) + idt_h2*dpe_merge</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) cs%diag_PE_detrain2(i,j) = &amp;</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;             cs%diag_PE_detrain2(i,j) + idt_h2*(dpe_det+rho0xg*dpe_extrap)</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;      <span class="keywordflow">else</span> <span class="comment">! Not mergeable_bl.</span></div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;        <span class="comment">! There is no further detrainment from the buffer layers, and the</span></div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;        <span class="comment">! upper buffer layer water is distributed optimally between the</span></div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;        <span class="comment">! upper and lower buffer layer.</span></div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;        h1_to_h2 = h1 - stays</div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;        ih1f = 1.0 / (h_to_bl + stays) ; ih2f = 1.0 / (h2 + h1_to_h2)</div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        ih = 1.0 / (h1 + h2)</div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;        dr0_2dz = (r0(i,kb1) - r0(i,kb2)) * ih</div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;        r0(i,kb2) = (h2*r0(i,kb2) + h1_to_h2*(r0(i,kb1) - &amp;</div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;                     scale_slope*dr0_2dz*stays)) * ih2f</div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;        r0(i,kb1) = (r0_to_bl + stays*(r0(i,kb1) + &amp;</div><div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;                        scale_slope*dr0_2dz*h1_to_h2)) * ih1f</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;</div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;        <span class="comment">! Use 2nd order upwind advection of spiciness, limited by the value</span></div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;        <span class="comment">! in the detrained water to determine the detrained temperature and</span></div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;        <span class="comment">! salinity.</span></div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;        dr0 = scale_slope*dr0_2dz*h1_to_h2</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;        dspice_stays = (ds_dt_gauge*dr0_ds(i)*(t(i,kb1)-t(i,kb2)) - &amp;</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;                        dt_ds_gauge*dr0_dt(i)*(s(i,kb1)-s(i,kb2))) * &amp;</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;                        scale_slope*h1_to_h2 * ih</div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;        <span class="keywordflow">if</span> (h_to_bl &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;          dspice_lim = (ds_dt_gauge*dr0_ds(i)*(t_to_bl-t(i,kb1)*h_to_bl) - &amp;</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;                        dt_ds_gauge*dr0_dt(i)*(s_to_bl-s(i,kb1)*h_to_bl)) /&amp;</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;                        h_to_bl</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;          dspice_lim = ds_dt_gauge*dr0_ds(i)*(t(i,0)-t(i,kb1)) - &amp;</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;                       dt_ds_gauge*dr0_dt(i)*(s(i,0)-s(i,kb1))</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;        <span class="keywordflow">if</span> (dspice_stays*dspice_lim &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;          dspice_stays = 0.0</div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;        <span class="keywordflow">elseif</span> (abs(dspice_stays) &gt; abs(dspice_lim)) <span class="keywordflow">then</span></div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;          dspice_stays = dspice_lim</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;        i_denom = 1.0 / (dr0_ds(i)**2 + (dt_ds_gauge*dr0_dt(i))**2)</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;        t_stays = t(i,kb1) + dt_ds_gauge * i_denom * &amp;</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;            (dt_ds_gauge * dr0_dt(i) * dr0 + dr0_ds(i) * dspice_stays)</div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;        s_stays = s(i,kb1) + i_denom * &amp;</div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;            (dr0_ds(i) * dr0 - dt_ds_gauge * dr0_dt(i) * dspice_stays)</div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;        <span class="comment">! The detrained values of Rcv are based on changes in T and S.</span></div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;        rcv_stays = rcv(i,kb1) + (t_stays-t(i,kb1)) * drcv_dt(i) + &amp;</div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;                                 (s_stays-s(i,kb1)) * drcv_ds(i)</div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;</div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;        t(i,kb2) = (h2*t(i,kb2) + h1*t(i,kb1) - t_stays*stays) * ih2f</div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;        t(i,kb1) = (t_to_bl + stays*t_stays) * ih1f</div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;        s(i,kb2) = (h2*s(i,kb2) + h1*s(i,kb1) - s_stays*stays) * ih2f</div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;        s(i,kb1) = (s_to_bl + stays*s_stays) * ih1f</div><div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;        rcv(i,kb2) = (h2*rcv(i,kb2) + h1*rcv(i,kb1) - rcv_stays*stays) * ih2f</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;        rcv(i,kb1) = (rcv_to_bl + stays*rcv_stays) * ih1f</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;</div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;<span class="comment">!        ! The following is 2nd-order upwind advection without limiters.</span></div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;<span class="comment">!        dRcv_2dz = (Rcv(i,kb1) - Rcv(i,kb2)) * Ih</span></div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;<span class="comment">!        dRcv = scale_slope*dRcv_2dz*h1_to_h2</span></div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;<span class="comment">!        Rcv(i,kb2) = (h2*Rcv(i,kb2) + h1_to_h2*(Rcv(i,kb1) - &amp;</span></div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;<span class="comment">!                      scale_slope*dRcv_2dz*stays)) * Ih2f</span></div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;<span class="comment">!        Rcv(i,kb1) = (Rcv_to_bl + stays*(Rcv(i,kb1) + dRcv)) * Ih1f</span></div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;<span class="comment">!        dT_2dz = (T(i,kb1) - T(i,kb2)) * Ih</span></div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;<span class="comment">!        T(i,kb2) = (h2*T(i,kb2) + h1_to_h2*(T(i,kb1) - &amp;</span></div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;<span class="comment">!                      scale_slope*dT_2dz*stays)) * Ih2f</span></div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;<span class="comment">!        T(i,kb1) = (T_to_bl + stays*(T(i,kb1) + &amp;</span></div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;<span class="comment">!                      scale_slope*dT_2dz*h1_to_h2)) * Ih1f</span></div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;<span class="comment">!        dS_2dz = (S(i,kb1) - S(i,kb2)) * Ih</span></div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;<span class="comment">!        S(i,kb2) = (h2*S(i,kb2) + h1_to_h2*(S(i,kb1) - &amp;</span></div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;<span class="comment">!                      scale_slope*dS_2dz*stays)) * Ih2f</span></div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;<span class="comment">!        S(i,kb1) = (S_to_bl + stays*(S(i,kb1) + &amp;</span></div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;<span class="comment">!                      scale_slope*dS_2dz*h1_to_h2)) * Ih1f</span></div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;        d_ea(i,kb1) = d_ea(i,kb1) + ((stays - h1) + h_to_bl)</div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;        d_ea(i,kb2) = d_ea(i,kb2) + h1_to_h2</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;        h(i,kb1) = stays + h_to_bl</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;        h(i,kb2) = h(i,kb2) + h1_to_h2</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain)) &amp;</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;          cs%diag_PE_detrain(i,j) = cs%diag_PE_detrain(i,j) + idt_h2*dpe_det</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">ALLOCATED</span>(cs%diag_PE_detrain2)) cs%diag_PE_detrain2(i,j) = &amp;</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;          cs%diag_PE_detrain2(i,j) + idt_h2*(dpe_det+rho0xg*dpe_extrap)</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! End of detrainment...</span></div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;</div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! i loop</span></div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a46fd0f8d6109e0d4f7e4da971f2ab663_cgraph.svg" width="548" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a46fd0f8d6109e0d4f7e4da971f2ab663_icgraph.svg" width="567" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1378659bc97b52e065a7cfe44166504d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1378659bc97b52e065a7cfe44166504d">&#9670;&nbsp;</a></span>resort_ml()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::resort_ml </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk0_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>Rcv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>RcvTgt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>d_eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dR0_dS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>dRcv_dS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine actually moves properties between layers to achieve a resorted state, with all of the resorted water either moved into the correct interior layers or in the top nkmb layers. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below. Layer 0 is the new mixed layer.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Layer temperatures, in deg C.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">s</td><td>Layer salinities, in psu.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">r0</td><td>Potential density referenced to surface pressure, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">rcv</td><td>The coordinate defining potential density, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rcvtgt</td><td>The target value of Rcv for each layer, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eps</td><td>The (small) thickness that must remain in each layer, in H.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_ea</td><td>The upward increase across a layer in the entrainment from above, in m or kg m-2 (H). Positive d_ea goes with layer thickness increases.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">d_eb</td><td>The downward increase across a layer in the entrainment from below, in H. Positive values go with mass gain by a layer.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>The density-sorted k-indicies.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure for this module.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dr0_dt</td><td>The partial derivative of potential density referenced to the surface with potential temperature, in kg m-3 K-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dr0_ds</td><td>The partial derivative of cpotential density referenced to the surface with salinity, in kg m-3 psu-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_dt</td><td>The partial derivative of coordinate defining potential density with potential temperature, in kg m-3 K-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drcv_ds</td><td>The partial derivative of coordinate defining potential density with salinity, in kg m-3 psu-1. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l02055">2055</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                <span class="keywordtype">intent(in)</span>    :: g<span class="comment">       !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),              <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; The ocean&#39;s vertical grid</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;<span class="comment">                                                                 !! structure.</span></div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: h<span class="comment">       !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;<span class="comment">                                                                 !! (Intent in/out)  The units of h</span></div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;<span class="comment">                                                                 !! are referred to as H below.</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;<span class="comment">                                                                 !! Layer 0 is the new mixed layer.</span></div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: t<span class="comment">       !&lt; Layer temperatures, in deg C.</span></div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: s<span class="comment">       !&lt; Layer salinities, in psu.</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: r0<span class="comment">      !&lt; Potential density referenced to</span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="comment">                                                                 !! surface pressure, in kg m-3.</span></div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK0_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: rcv<span class="comment">     !&lt; The coordinate defining</span></div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;<span class="comment">                                                                 !! potential density, in kg m-3.</span></div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span>,            <span class="keywordtype">intent(in)</span>    :: rcvtgt<span class="comment">  !&lt; The target value of Rcv for each</span></div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;<span class="comment">                                                                 !! layer, in kg m-3.</span></div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(inout)</span> :: eps<span class="comment">     !&lt; The (small) thickness that must</span></div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;<span class="comment">                                                                 !! remain in each layer, in H.</span></div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(inout)</span> :: d_ea<span class="comment">    !&lt; The upward increase across a</span></div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;<span class="comment">                                                                 !! layer in the entrainment from</span></div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;<span class="comment">                                                                 !! above, in m or kg m-2 (H).</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;<span class="comment">                                                                 !!  Positive d_ea goes with layer</span></div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="comment">                                                                 !! thickness increases.</span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(inout)</span> :: d_eb<span class="comment">    !&lt; The downward increase across a</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="comment">                                                                 !! layer in the entrainment from</span></div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;<span class="comment">                                                                 !! below, in H. Positive values go</span></div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="comment">                                                                 !! with mass gain by a layer.</span></div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(in)</span>    :: ksort<span class="comment">   !&lt; The density-sorted k-indicies.</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),              <span class="keywordtype">pointer</span>       :: cs<span class="comment">      !&lt; The control structure for this</span></div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;<span class="comment">                                                                 !! module.</span></div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,             <span class="keywordtype">intent(in)</span>    :: dr0_dt<span class="comment">  !&lt; The partial derivative of</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;<span class="comment">                                                                 !! potential density referenced</span></div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="comment">                                                                 !! to the surface with potential</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="comment">                                                                 !! temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,             <span class="keywordtype">intent(in)</span>    :: dr0_ds<span class="comment">  !&lt; The partial derivative of</span></div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;<span class="comment">                                                                 !! cpotential density referenced</span></div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;<span class="comment">                                                                 !! to the surface with salinity,</span></div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;<span class="comment">                                                                 !! in kg m-3 psu-1.</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,             <span class="keywordtype">intent(in)</span>    :: drcv_dt<span class="comment"> !&lt; The partial derivative of</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;<span class="comment">                                                                 !! coordinate defining potential</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="comment">                                                                 !! density with potential</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;<span class="comment">                                                                 !! temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,             <span class="keywordtype">intent(in)</span>    :: drcv_ds<span class="comment"> !&lt; The partial derivative of</span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="comment">                                                                 !! coordinate defining potential</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="comment">                                                                 !! density with salinity,</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="comment">                                                                 !! in kg m-3 psu-1.</span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="comment">!   This subroutine actually moves properties between layers to achieve a</span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="comment">! resorted state, with all of the resorted water either moved into the correct</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">! interior layers or in the top nkmb layers.</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units of</span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="comment">!                h are referred to as H below.  Layer 0 is the new mixed layer.</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="comment">!  (in/out)  T - Layer temperatures, in deg C.</span></div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="comment">!  (in/out)  S - Layer salinities, in psu.</span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="comment">!  (in/out)  R0 - Potential density referenced to surface pressure, in kg m-3.</span></div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">!  (in/out)  Rcv - The coordinate defining potential density, in kg m-3.</span></div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="comment">!  (in)      RcvTgt - The target value of Rcv for each layer, in kg m-3.</span></div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="comment">!  (in)      eps - The (small) thickness that must remain in each layer, in H.</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;<span class="comment">!  (in/out)  d_ea - The upward increase across a layer in the entrainment from</span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;<span class="comment">!                   above, in m or kg m-2 (H).  Positive d_ea goes with layer</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="comment">!                   thickness increases.</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="comment">!  (in/out)  d_eb - The downward increase across a layer in the entrainment from</span></div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="comment">!                   below, in H. Positive values go with mass gain by a layer.</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="comment">!  (in)      ksort - The density-sorted k-indicies.</span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;<span class="comment">!  (in)      CS - The control structure for this module.</span></div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="comment">!  (in/out)  dR0_dT - The partial derivative of potential density referenced</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;<span class="comment">!                     to the surface with potential temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;<span class="comment">!  (in/out)  dR0_dS - The partial derivative of cpotential density referenced</span></div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="comment">!                     to the surface with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="comment">!  (in/out)  dRcv_dT - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="comment">!                      density with potential temperature, in kg m-3 K-1.</span></div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="comment">!  (in/out)  dRcv_dS - The partial derivative of coordinate defining potential</span></div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="comment">!                      density with salinity, in kg m-3 psu-1.</span></div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="comment">!   If there are no massive light layers above the deepest of the mixed- and</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;<span class="comment">! buffer layers, do nothing (except perhaps to reshuffle these layers).</span></div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="comment">!   If there are nkbl or fewer layers above the deepest mixed- or buffer-</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;<span class="comment">! layers, move them (in sorted order) into the buffer layers, even if they</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="comment">! were previously interior layers.</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="comment">!   If there are interior layers that are intermediate in density (both in-situ</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;<span class="comment">! and the coordinate density (sigma-2)) between the newly forming mixed layer</span></div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="comment">! and a residual buffer- or mixed layer, and the number of massive layers above</span></div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;<span class="comment">! the deepest massive buffer or mixed layer is greater than nkbl, then split</span></div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="comment">! those buffer layers into peices that match the target density of the two</span></div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;<span class="comment">! nearest interior layers.</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;<span class="comment">!   Otherwise, if there are more than nkbl+1 remaining massive layers</span></div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;  <span class="keywordtype">real</span>    :: h_move, h_tgt_old, i_hnew</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;  <span class="keywordtype">real</span>    :: dt_ds_wt2, dt_dr, ds_dr, i_denom</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  <span class="keywordtype">real</span>    :: rcv_int</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;  <span class="keywordtype">real</span>    :: target_match_tol</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;  <span class="keywordtype">real</span>    :: t_up, s_up, r0_up, i_hup, h_to_up</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;  <span class="keywordtype">real</span>    :: t_dn, s_dn, r0_dn, i_hdn, h_to_dn</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;  <span class="keywordtype">real</span>    :: wt_dn</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;  <span class="keywordtype">real</span>    :: dr1, dr2</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;  <span class="keywordtype">real</span>    :: dpe, hmin, min_dpe, min_hmin</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    h_tmp, r0_tmp, t_tmp, s_tmp, rcv_tmp</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  <span class="keywordtype">integer</span> :: ks_min</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;  <span class="keywordtype">logical</span> :: sorted, leave_in_layer</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;  <span class="keywordtype">integer</span> :: ks_deep(szi_(g)), k_count(szi_(g)), ks2_reverse(szi_(g), szk_(gv))</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;  <span class="keywordtype">integer</span> :: ks2(szk_(gv))</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;  <span class="keywordtype">integer</span> :: i, k, ks, is, ie, nz, k1, k2, k_tgt, k_src, k_int_top</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;  <span class="keywordtype">integer</span> :: nks, nkmb, num_interior, top_interior_ks</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;  target_match_tol = 0.1 <span class="comment">! ### MAKE THIS A PARAMETER.</span></div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;  dt_ds_wt2 = cs%dT_dS_wt**2</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;<span class="comment">! Find out how many massive layers are above the deepest buffer or mixed layer.</span></div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; ks_deep(i) = -1 ; k_count(i) = 0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;  <span class="keywordflow">do</span> ks=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (ksort(i,ks) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    k = ksort(i,ks)</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;    <span class="keywordflow">if</span> (h(i,k) &gt; eps(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;      <span class="keywordflow">if</span> (ks_deep(i) == -1) <span class="keywordflow">then</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        <span class="keywordflow">if</span> (k &lt;= nkmb) <span class="keywordflow">then</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;          ks_deep(i) = ks ; k_count(i) = k_count(i) + 1</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;          ks2_reverse(i,k_count(i)) = k</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        k_count(i) = k_count(i) + 1</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        ks2_reverse(i,k_count(i)) = k</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (k_count(i) &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;    <span class="comment">! This column might need to be reshuffled.</span></div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    nks = k_count(i)</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    <span class="comment">! Put ks2 in the right order and check whether reshuffling is needed.</span></div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;    sorted = .true.</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;    ks2(nks) = ks2_reverse(i,1)</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;    <span class="keywordflow">do</span> ks=nks-1,1,-1</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;      ks2(ks) = ks2_reverse(i,1+nks-ks)</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;      <span class="keywordflow">if</span> (ks2(ks) &gt; ks2(ks+1)) sorted = .false.</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;    <span class="comment">! Go to the next column of no reshuffling is needed.</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    <span class="keywordflow">if</span> (sorted) cycle</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;    <span class="comment">! Find out how many interior layers are being reshuffled.  If none,</span></div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    <span class="comment">! then this is a simple swapping procedure.</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;    num_interior = 0 ; top_interior_ks = 0</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;    <span class="keywordflow">do</span> ks=nks,1,-1 ; <span class="keywordflow">if</span> (ks2(ks) &gt; nkmb) <span class="keywordflow">then</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;      num_interior = num_interior+1 ; top_interior_ks = ks</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;    <span class="keywordflow">if</span> (num_interior &gt;= 1) <span class="keywordflow">then</span></div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;      <span class="comment">! Find the lightest interior layer with a target coordinate density</span></div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;      <span class="comment">! greater than the newly forming mixed layer.</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;      <span class="keywordflow">do</span> k=nkmb+1,nz ; <span class="keywordflow">if</span> (rcv(i,0) &lt; rcvtgt(k)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;      k_int_top = k ; rcv_int = rcvtgt(k)</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;      i_denom = 1.0 / (drcv_ds(i)**2 + dt_ds_wt2*drcv_dt(i)**2)</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;      dt_dr = dt_ds_wt2*drcv_dt(i) * i_denom</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;      ds_dr = drcv_ds(i) * i_denom</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;      <span class="comment">! Examine whether layers can be split out of existence.  Stop when there</span></div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;      <span class="comment">! is a layer that cannot be handled this way, or when the topmost formerly</span></div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;      <span class="comment">! interior layer has been dealt with.</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;      <span class="keywordflow">do</span> ks = nks,top_interior_ks,-1</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;        k = ks2(ks)</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;        leave_in_layer = .false.</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;        <span class="keywordflow">if</span> ((k &gt; nkmb) .and. (rcv(i,k) &lt;= rcvtgt(k))) <span class="keywordflow">then</span></div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;          <span class="keywordflow">if</span> (rcvtgt(k)-rcv(i,k) &lt; target_match_tol*(rcvtgt(k) - rcvtgt(k-1))) &amp;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            leave_in_layer = .true.</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;        <span class="keywordflow">elseif</span> (k &gt; nkmb) <span class="keywordflow">then</span></div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;          <span class="keywordflow">if</span> (rcv(i,k)-rcvtgt(k) &lt; target_match_tol*(rcvtgt(k+1) - rcvtgt(k))) &amp;</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;            leave_in_layer = .true.</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        <span class="keywordflow">if</span> (leave_in_layer) <span class="keywordflow">then</span></div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;          <span class="comment">! Just drop this layer from the sorted list.</span></div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;          nks = nks-1</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;        <span class="keywordflow">elseif</span> (rcv(i,k) &lt; rcv_int) <span class="keywordflow">then</span></div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;          <span class="comment">! There is no interior layer with a target density that is intermediate</span></div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;          <span class="comment">! between this layer and the mixed layer.</span></div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;          <span class="keywordflow">exit</span></div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;          <span class="comment">! Try splitting the layer between two interior isopycnal layers.</span></div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;          <span class="comment">! Find the target densities that bracket this layer.</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;          <span class="keywordflow">do</span> k2=k_int_top+1,nz ; <span class="keywordflow">if</span> (rcv(i,k) &lt; rcvtgt(k2)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;          <span class="keywordflow">if</span> (k2&gt;nz) <span class="keywordflow">exit</span></div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;          <span class="comment">! This layer is bracketed in density between layers k2-1 and k2.</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;          dr1 = (rcvtgt(k2-1) - rcv(i,k)) ; dr2 = (rcvtgt(k2) - rcv(i,k))</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;          t_up = t(i,k) + dt_dr * dr1</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;          s_up = s(i,k) + ds_dr * dr1</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;          t_dn = t(i,k) + dt_dr * dr2</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;          s_dn = s(i,k) + ds_dr * dr2</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;          r0_up = r0(i,k) + (dt_dr*dr0_dt(i) + ds_dr*dr0_ds(i)) * dr1</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;          r0_dn = r0(i,k) + (dt_dr*dr0_dt(i) + ds_dr*dr0_ds(i)) * dr2</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;          <span class="comment">! Make sure the new properties are acceptable.</span></div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;          <span class="keywordflow">if</span> ((r0_up &gt; r0(i,0)) .or. (r0_dn &gt; r0(i,0))) &amp;</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;            <span class="comment">! Avoid creating obviously unstable profiles.</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;            <span class="keywordflow">exit</span></div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;          wt_dn = (rcv(i,k) - rcvtgt(k2-1)) / (rcvtgt(k2) - rcvtgt(k2-1))</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;          h_to_up = (h(i,k)-eps(i,k)) * (1.0 - wt_dn)</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;          h_to_dn = (h(i,k)-eps(i,k)) * wt_dn</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;          i_hup = 1.0 / (h(i,k2-1) + h_to_up)</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;          i_hdn = 1.0 / (h(i,k2) + h_to_dn)</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;          r0(i,k2-1) = (r0(i,k2)*h(i,k2-1) + r0_up*h_to_up) * i_hup</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;          r0(i,k2) = (r0(i,k2)*h(i,k2) + r0_dn*h_to_dn) * i_hdn</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;          t(i,k2-1) = (t(i,k2)*h(i,k2-1) + t_up*h_to_up) * i_hup</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;          t(i,k2) = (t(i,k2)*h(i,k2) + t_dn*h_to_dn) * i_hdn</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;          s(i,k2-1) = (s(i,k2)*h(i,k2-1) + s_up*h_to_up) * i_hup</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;          s(i,k2) = (s(i,k2)*h(i,k2) + s_dn*h_to_dn) * i_hdn</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;          rcv(i,k2-1) = (rcv(i,k2)*h(i,k2-1) + rcvtgt(k2-1)*h_to_up) * i_hup</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;          rcv(i,k2) = (rcv(i,k2)*h(i,k2) + rcvtgt(k2)*h_to_dn) * i_hdn</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;          h(i,k) = eps(i,k)</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;          h(i,k2) = h(i,k2) + h_to_dn</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;          h(i,k2-1) = h(i,k2-1) + h_to_up</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;          <span class="keywordflow">if</span> (k &gt; k2-1) <span class="keywordflow">then</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;            d_eb(i,k) = d_eb(i,k) - h_to_up</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;            d_eb(i,k2-1) = d_eb(i,k2-1) + h_to_up</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;          <span class="keywordflow">elseif</span> (k &lt; k2-1) <span class="keywordflow">then</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;            d_ea(i,k) = d_ea(i,k) - h_to_up</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;            d_ea(i,k2-1) = d_ea(i,k2-1) + h_to_up</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;          <span class="keywordflow">if</span> (k &gt; k2) <span class="keywordflow">then</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;            d_eb(i,k) = d_eb(i,k) - h_to_dn</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;            d_eb(i,k2) = d_eb(i,k2) + h_to_dn</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;          <span class="keywordflow">elseif</span> (k &lt; k2) <span class="keywordflow">then</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;            d_ea(i,k) = d_ea(i,k) - h_to_dn</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;            d_ea(i,k2) = d_ea(i,k2) + h_to_dn</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;          nks = nks-1</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keywordflow">do</span> <span class="keywordflow">while</span> (nks &gt; nkmb)</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;      <span class="comment">! Having already tried to move surface layers into the interior, there</span></div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;      <span class="comment">! are still too many layers, and layers must be merged until nks=nkmb.</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;      <span class="comment">! Examine every merger of a layer with its neighbors, and merge the ones</span></div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;      <span class="comment">! that increase the potential energy the least.  If there are layers</span></div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;      <span class="comment">! with (apparently?) negative potential energy change, choose the one</span></div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;      <span class="comment">! with the smallest total thickness.  Repeat until nkmb layers remain.</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;      <span class="comment">! Choose the smaller value for the remaining index for convenience.</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;      ks_min = -1 ; min_dpe = 1.0 ; min_hmin = 0.0</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;      <span class="keywordflow">do</span> ks=1,nks-1</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        k1 = ks2(ks) ; k2 = ks2(ks+1)</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;        dpe = max(0.0, (r0(i,k2)-r0(i,k1)) * h(i,k1) * h(i,k2))</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;        hmin = min(h(i,k1)-eps(i,k1), h(i,k2)-eps(i,k2))</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;        <span class="keywordflow">if</span> ((ks_min &lt; 0) .or. (dpe &lt; min_dpe) .or. &amp;</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;            ((dpe &lt;= 0.0) .and. (hmin &lt; min_hmin))) <span class="keywordflow">then</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;           ks_min = ks ; min_dpe = dpe ; min_hmin = hmin</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;      <span class="comment">! Now merge the two layers that do the least damage.</span></div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;      k1 = ks2(ks_min) ; k2 = ks2(ks_min+1)</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;      <span class="keywordflow">if</span> (k1 &lt; k2) <span class="keywordflow">then</span> ; k_tgt = k1 ; k_src = k2</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;      <span class="keywordflow">else</span> ; k_tgt = k2 ; k_src = k1 ; ks2(ks_min) = k2 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;      h_tgt_old = h(i,k_tgt)</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;      h_move = h(i,k_src)-eps(i,k_src)</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;      h(i,k_src) = eps(i,k_src)</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;      h(i,k_tgt) = h(i,k_tgt) + h_move</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;      i_hnew = 1.0 / (h(i,k_tgt))</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;      r0(i,k_tgt) = (r0(i,k_tgt)*h_tgt_old + r0(i,k_src)*h_move) * i_hnew</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;      t(i,k_tgt) = (t(i,k_tgt)*h_tgt_old + t(i,k_src)*h_move) * i_hnew</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;      s(i,k_tgt) = (s(i,k_tgt)*h_tgt_old + s(i,k_src)*h_move) * i_hnew</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;      rcv(i,k_tgt) = (rcv(i,k_tgt)*h_tgt_old + rcv(i,k_src)*h_move) * i_hnew</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;      d_eb(i,k_src) = d_eb(i,k_src) - h_move</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;      d_eb(i,k_tgt) = d_eb(i,k_tgt) + h_move</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;      <span class="comment">! Remove the newly missing layer from the sorted list.</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;      <span class="keywordflow">do</span> ks=ks_min+1,nks ; ks2(ks) = ks2(ks+1) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;      nks = nks-1</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="comment">!   Check again whether the layers are sorted, and go on to the next column</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    <span class="comment">! if they are.</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;    sorted = .true.</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordflow">do</span> ks=1,nks-1 ; <span class="keywordflow">if</span> (ks2(ks) &gt; ks2(ks+1)) sorted = .false. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;    <span class="keywordflow">if</span> (sorted) cycle</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;    <span class="keywordflow">if</span> (nks &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;      <span class="comment">! At this point, actually swap the properties of the layers, and place</span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;      <span class="comment">! the remaining layers in order starting with nkmb.</span></div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;      <span class="comment">! Save all the properties of the nkmb layers that might be replaced.</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;      <span class="keywordflow">do</span> k=1,nkmb</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;        h_tmp(k) = h(i,k) ; r0_tmp(k) = r0(i,k)</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;        t_tmp(k) = t(i,k) ; s_tmp(k) = s(i,k) ; rcv_tmp(k) = rcv(i,k)</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        h(i,k) = 0.0</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;      <span class="keywordflow">do</span> ks=nks,1,-1</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;        k_tgt = nkmb - nks + ks ; k_src = ks2(ks)</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        <span class="keywordflow">if</span> (k_tgt == k_src) <span class="keywordflow">then</span></div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;          h(i,k_tgt) = h_tmp(k_tgt)  <span class="comment">! This layer doesn&#39;t move, so put the water back.</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;          cycle</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;        <span class="comment">! Note below that eps=0 for k&lt;=nkmb.</span></div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;        <span class="keywordflow">if</span> (k_src &gt; nkmb) <span class="keywordflow">then</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;          h_move = h(i,k_src)-eps(i,k_src)</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;          h(i,k_src) = eps(i,k_src)</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;          h(i,k_tgt) = h_move</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;          r0(i,k_tgt) = r0(i,k_src)</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;          t(i,k_tgt) = t(i,k_src) ; s(i,k_tgt) = s(i,k_src)</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;          rcv(i,k_tgt) = rcv(i,k_src)</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;          d_eb(i,k_src) = d_eb(i,k_src) - h_move</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;          d_eb(i,k_tgt) = d_eb(i,k_tgt) + h_move</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;          h(i,k_tgt) = h_tmp(k_src)</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;          r0(i,k_tgt) = r0_tmp(k_src)</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;          t(i,k_tgt) = t_tmp(k_src) ; s(i,k_tgt) = s_tmp(k_src)</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;          rcv(i,k_tgt) = rcv_tmp(k_src)</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;          <span class="keywordflow">if</span> (k_src &gt; k_tgt) <span class="keywordflow">then</span></div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;            d_eb(i,k_src) = d_eb(i,k_src) - h_tmp(k_src)</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;            d_eb(i,k_tgt) = d_eb(i,k_tgt) + h_tmp(k_src)</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;            d_ea(i,k_src) = d_ea(i,k_src) - h_tmp(k_src)</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;            d_ea(i,k_tgt) = d_ea(i,k_tgt) + h_tmp(k_src)</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_a1378659bc97b52e065a7cfe44166504d_icgraph.svg" width="567" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ae4325155d260533b923ba910557945f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae4325155d260533b923ba910557945f3">&#9670;&nbsp;</a></span>sort_ml()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_bulk_mixed_layer::sort_ml </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>R0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__bulk__mixed__layer_1_1bulkmixedlayer__cs.html">bulkmixedlayer_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension(szi_(g),szk_(gv)), intent(out)&#160;</td>
          <td class="paramname"><em>ksort</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine generates an array of indices that are sorted by layer density. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness, in m or kg m-2. (Intent in/out) The units of h are referred to as H below.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">r0</td><td>The potential density used to sort the layers, in kg m-3.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eps</td><td>The (small) thickness that must remain in each layer, in H.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to mixedlayer_init.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ksort</td><td>The k-index to use in the sort. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l01987">1987</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                <span class="keywordtype">intent(in)</span>  :: g<span class="comment">     !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),              <span class="keywordtype">intent(in)</span>  :: gv<span class="comment">    !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>  :: h<span class="comment">     !&lt; Layer thickness, in m or kg m-2.</span></div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;<span class="comment">                                                             !! (Intent in/out)  The units of h are</span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;<span class="comment">                                                             !! referred to as H below.</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>  :: r0<span class="comment">    !&lt; The potential density used to sort</span></div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;<span class="comment">                                                             !! the layers, in kg m-3.</span></div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>  :: eps<span class="comment">   !&lt; The (small) thickness that must</span></div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="comment">                                                             !! remain in each layer, in H.</span></div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;  <span class="keywordtype">type</span>(bulkmixedlayer_cs),              <span class="keywordtype">pointer</span>     :: cs<span class="comment">    !&lt; The control structure returned by a</span></div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;<span class="comment">                                                             !! previous call to mixedlayer_init.</span></div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(GV))</span>, <span class="keywordtype">intent(out)</span> :: ksort<span class="comment"> !&lt; The k-index to use in the sort.</span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="comment">!   This subroutine generates an array of indices that are sorted by layer</span></div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="comment">! density.</span></div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;<span class="comment">! Arguments: h - Layer thickness, in m or kg m-2. (Intent in/out)  The units</span></div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment">!                of h are referred to as H below.</span></div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="comment">!  (in)      R0 - The potential density used to sort the layers, in kg m-3.</span></div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="comment">!  (in)      eps - The (small) thickness that must remain in each layer, in H.</span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="comment">!  (in)      tv - A structure containing pointers to any available</span></div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;<span class="comment">!                 thermodynamic fields. Absent fields have NULL ptrs.</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;<span class="comment">!  (in)      j - The meridional row to work on.</span></div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;<span class="comment">!                 mixedlayer_init.</span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;<span class="comment">!  (out)     ksort - The k-index to use in the sort.</span></div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  <span class="keywordtype">real</span> :: r0sort(szi_(g),szk_(gv))</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  <span class="keywordtype">integer</span> :: nsort(szi_(g))</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;  <span class="keywordtype">logical</span> :: done_sorting(szi_(g))</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;  <span class="keywordtype">integer</span> :: i, k, ks, is, ie, nz, nkmb</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  is = g%isc ; ie = g%iec ; nz = gv%ke</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;  nkmb = cs%nkml+cs%nkbl</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;  <span class="comment">!   Come up with a sorted index list of layers with increasing R0.</span></div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;  <span class="comment">! Assume that the layers below nkmb are already stably stratified.</span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;  <span class="comment">! Only layers that are thicker than eps are in the list.  Extra elements</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;  <span class="comment">! have an index of -1.</span></div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;  <span class="comment">!   This is coded using straight insertion, on the assumption that the</span></div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;  <span class="comment">! layers are usually in the right order (or massless) anyway.</span></div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; ksort(i,k) = -1 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; nsort(i) = 0 ; done_sorting(i) = .false. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h(i,k) &gt; eps(i,k)) <span class="keywordflow">then</span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    <span class="keywordflow">if</span> (done_sorting(i)) <span class="keywordflow">then</span> ; ks = nsort(i) ; <span class="keywordflow">else</span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;      <span class="keywordflow">do</span> ks=nsort(i),1,-1</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        <span class="keywordflow">if</span> (r0(i,k) &gt;= r0sort(i,ks)) <span class="keywordflow">exit</span></div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        r0sort(i,ks+1) = r0sort(i,ks) ; ksort(i,ks+1) = ksort(i,ks)</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;      <span class="keywordflow">if</span> ((k &gt; nkmb) .and. (ks == nsort(i))) done_sorting(i) = .true.</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;    ksort(i,ks+1) = k</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    r0sort(i,ks+1) = r0(i,k)</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    nsort(i) = nsort(i) + 1</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__bulk__mixed__layer_ae4325155d260533b923ba910557945f3_icgraph.svg" width="567" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a8e92dc75114e33498ee9318edbb784d4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8e92dc75114e33498ee9318edbb784d4">&#9670;&nbsp;</a></span>id_clock_adjustment</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_adjustment =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">188</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>

</div>
</div>
<a id="aaeabff634c035ff4b91e5ea695123a34"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaeabff634c035ff4b91e5ea695123a34">&#9670;&nbsp;</a></span>id_clock_conv</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_conv =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">188</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>

</div>
</div>
<a id="a834f8c8f259f53f30654ad9273eee648"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a834f8c8f259f53f30654ad9273eee648">&#9670;&nbsp;</a></span>id_clock_detrain</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_detrain =0</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">188</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordtype">integer</span> :: id_clock_detrain=0, id_clock_mech=0, id_clock_conv=0, id_clock_adjustment=0</div></div><!-- fragment -->
</div>
</div>
<a id="a238ec53eac28b48ba8ab226296b363f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a238ec53eac28b48ba8ab226296b363f0">&#9670;&nbsp;</a></span>id_clock_eos</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_eos =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">189</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="keywordtype">integer</span> :: id_clock_eos=0, id_clock_resort=0, id_clock_pass=0</div></div><!-- fragment -->
</div>
</div>
<a id="afadd63132ed4d2785d2771dfe33e64d8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afadd63132ed4d2785d2771dfe33e64d8">&#9670;&nbsp;</a></span>id_clock_mech</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_mech =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00188">188</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>

</div>
</div>
<a id="af833f821fed6dc29921f131d80a27b6e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af833f821fed6dc29921f131d80a27b6e">&#9670;&nbsp;</a></span>id_clock_pass</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_pass =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">189</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>

</div>
</div>
<a id="aa27ed6a6317d7f8031d7c0207fe42c52"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa27ed6a6317d7f8031d7c0207fe42c52">&#9670;&nbsp;</a></span>id_clock_resort</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::id_clock_resort =0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00189">189</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">bulkmixedlayer()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l03647">bulkmixedlayer_init()</a>.</p>

</div>
</div>
<a id="a95c01658ab4d38a3ff111da62296d52c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a95c01658ab4d38a3ff111da62296d52c">&#9670;&nbsp;</a></span>max_msg</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::max_msg = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00191">191</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>

</div>
</div>
<a id="a6627a99604f22dd946977416da9f1420"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6627a99604f22dd946977416da9f1420">&#9670;&nbsp;</a></span>num_msg</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_bulk_mixed_layer::num_msg = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00191">191</a> of file <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html">MOM_bulk_mixed_layer.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordtype">integer</span> :: num_msg = 0, max_msg = 2</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__bulk__mixed__layer.html">mom_bulk_mixed_layer</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
