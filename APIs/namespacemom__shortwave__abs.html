<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_shortwave_abs Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__shortwave__abs.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_shortwave_abs Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__shortwave__abs_1_1optics__type.html">optics_type</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a977474b56b68f4db0d6b0dc604755e6c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__shortwave__abs.html#a977474b56b68f4db0d6b0dc604755e6c">absorbremainingsw</a> (G, GV, h, opacity_band, nsw, j, dt, H_limit_fluxes, adjustAbsorptionProfile, absorbAllSW, T, Pen_SW_bnd, eps, ksort, htot, Ttot, TKE, dSV_dT)</td></tr>
<tr class="memdesc:a977474b56b68f4db0d6b0dc604755e6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply shortwave heating below surface boundary layer.  <a href="#a977474b56b68f4db0d6b0dc604755e6c">More...</a><br /></td></tr>
<tr class="separator:a977474b56b68f4db0d6b0dc604755e6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a1184c3f836d0900dfd5fa587cfb879"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__shortwave__abs.html#a8a1184c3f836d0900dfd5fa587cfb879">sumswoverbands</a> (G, GV, h, opacity_band, nsw, j, dt, H_limit_fluxes, absorbAllSW, iPen_SW_bnd, netPen)</td></tr>
<tr class="separator:a8a1184c3f836d0900dfd5fa587cfb879"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a977474b56b68f4db0d6b0dc604755e6c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a977474b56b68f4db0d6b0dc604755e6c">&#9670;&nbsp;</a></span>absorbremainingsw()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_shortwave_abs::absorbremainingsw </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(in)&#160;</td>
          <td class="paramname"><em>opacity_band</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>H_limit_fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>adjustAbsorptionProfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>absorbAllSW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>T</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>Pen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>eps</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, dimension( g %isd: g %ied, g %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>ksort</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied), intent(in), optional&#160;</td>
          <td class="paramname"><em>htot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied), intent(inout), optional&#160;</td>
          <td class="paramname"><em>Ttot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(inout), optional&#160;</td>
          <td class="paramname"><em>TKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %ke), intent(in), optional&#160;</td>
          <td class="paramname"><em>dSV_dT</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply shortwave heating below surface boundary layer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">opacity_band</td><td>Opacity in each band of penetrating shortwave radiation (1/H). The indicies are band, i, k.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>Number of bands of penetrating shortwave radiation.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to work on.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time step (seconds).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_limit_fluxes</td><td>If the total ocean depth is less than this, they are scaled away to avoid numerical instabilities. (H) This would not be necessary if a finite heat capacity mud-layer were added.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjustabsorptionprofile</td><td>If true, apply heating above the layers in which it should have occurred to get the correct mean depth (and potential energy change) of the shortwave that should be absorbed by each layer.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">absorballsw</td><td>If true, apply heating above the layers in which it should have occurred to get the correct mean depth (and potential energy change) of the shortwave that should be absorbed by each layer.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">t</td><td>Layer potential/conservative temperatures (deg C)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pen_sw_bnd</td><td>Penetrating shortwave heating in each band that hits the bottom and will be redistributed through the water column (units of K*H), size nsw x G isd: G ied.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eps</td><td>Small thickness that must remain in</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ksort</td><td>Density-sorted k-indicies.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">htot</td><td>Total mixed layer thickness, in H .</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ttot</td><td>Depth integrated mixed layer</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dsv_dt</td><td>The partial derivative of specific</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tke</td><td>The TKE sink from mixing the heating </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__shortwave__abs_8F90_source.html#l00060">60</a> of file <a class="el" href="MOM__shortwave__abs_8F90_source.html">MOM_shortwave_abs.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00814">mom_diabatic_aux::applyboundaryfluxesinout()</a>, and <a class="el" href="MOM__bulk__mixed__layer_8F90_source.html#l00227">mom_bulk_mixed_layer::bulkmixedlayer()</a>.</p>
<div class="fragment"><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">!&lt; This subroutine applies shortwave heating below the boundary layer (when running</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">!! with the bulk mixed layer from GOLD) or throughout the water column.  In</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">!! addition, it causes all of the remaining SW radiation to be absorbed,</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">!! provided that the total water column thickness is greater than</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">!! H_limit_fluxes.  For thinner water columns, the heating is scaled down</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">!! proportionately, the assumption being that the remaining heating (which is</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">!! left in Pen_SW) should go into an (absent for now) ocean bottom sediment layer.</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),            <span class="keywordtype">intent(in)</span>    :: g<span class="comment">     !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),          <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">    !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">     !&lt; Layer thicknesses, in H (usually m or</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">                                                           !! kg m-2).</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,           <span class="keywordtype">intent(in)</span>    :: opacity_band<span class="comment"> !&lt; Opacity in each band of</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">                                                           !! penetrating shortwave radiation (1/H).</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">                                                           !! The indicies are band, i, k.</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordtype">integer</span>,                          <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment">   !&lt; Number of bands of penetrating</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">                                                           !! shortwave radiation.</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordtype">integer</span>,                          <span class="keywordtype">intent(in)</span>    :: j<span class="comment">     !&lt; j-index to work on.</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keywordtype">real</span>,                             <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">    !&lt; Time step (seconds).</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="keywordtype">real</span>,                             <span class="keywordtype">intent(in)</span>    :: h_limit_fluxes<span class="comment"> !&lt; If the total ocean depth is</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">                                                           !! less than this, they are scaled away</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">                                                           !! to avoid numerical instabilities. (H)</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">                                                           !! This would not be necessary if a</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">                                                           !! finite heat capacity mud-layer</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">                                                           !! were added.</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">logical</span>,                          <span class="keywordtype">intent(in)</span>    :: adjustabsorptionprofile<span class="comment"> !&lt; If true, apply</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">                                                           !! heating above the layers in which it</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">                                                           !! should have occurred to get the</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">                                                           !! correct mean depth (and potential</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">                                                           !! energy change) of the shortwave that</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">                                                           !! should be absorbed by each layer.</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">logical</span>,                          <span class="keywordtype">intent(in)</span>    :: absorballsw<span class="comment"> !&lt; If true, apply heating above the</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">                                                           !! layers in which it should have occurred</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">                                                           !! to get the correct mean depth (and</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">                                                           !! potential energy change) of the</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">                                                           !! shortwave that should be absorbed by</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">                                                           !! each layer.</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: t<span class="comment">     !&lt; Layer potential/conservative</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">                                                           !! temperatures (deg C)</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,             <span class="keywordtype">intent(inout)</span> :: pen_sw_bnd<span class="comment"> !&lt; Penetrating shortwave heating in</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">                                                           !! each band that hits the bottom and</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">                                                           !! will be redistributed through the</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">                                                           !! water column (units of K*H), size</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">                                                           !! nsw x SZI_(G).</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,    &amp;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: eps<span class="comment">   !&lt; Small thickness that must remain in</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">                                                           !! each layer, and which will not be</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">                                                           !! subject to heating (units of H)</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: ksort<span class="comment"> !&lt; Density-sorted k-indicies.</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,            &amp;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: htot<span class="comment">  !&lt; Total mixed layer thickness, in H .</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>,            &amp;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: ttot<span class="comment">  !&lt; Depth integrated mixed layer</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">                                                           !! temperature (units of K H).</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,    &amp;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: dsv_dt<span class="comment"> !&lt; The partial derivative of specific</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">                                                           !! volume with temperature, in m3 kg-1</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">                                                           !! K-1.</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,    &amp;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                          <span class="keywordtype">optional</span>, <span class="keywordtype">intent(inout)</span> :: tke<span class="comment">   !&lt; The TKE sink from mixing the heating</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">                                                           !! throughout a layer, in J m-2.</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">!  (in)    G            = the ocean grid structure.</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">!  (in)    GV           = The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">!  (in)    h            = the layer thicknesses, in m or kg m-2.</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">!                         units of h are referred to as &quot;H&quot; below.</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">!  (in)    opacity_band = opacity in each band of penetrating shortwave</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">!                         radiation (1/H). The indicies are band, i, k.</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">!  (in)    nsw          = number of bands of penetrating shortwave radiation</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">!  (in)    j            = j-index to work on</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">!  (in)    dt           = time step (seconds)</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">!  (in)    H_limit_fluxes = if the total ocean depth is less than this, they</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">!                         are scaled away to avoid numerical instabilities. (H)</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">!                         This would not be necessary if a finite heat</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">!                         capacity mud-layer were added.</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">!  (in)    adjustAbsorptionProfile = if true, apply heating above the layers</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">!                         in which it should have occurred to get the correct</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">!                         mean depth (and potential energy change) of the</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">!                         shortwave that should be absorbed by each layer.</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">!  (in)    absorbAllSW  = if true, any shortwave radiation that hits the</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">!                         bottom is absorbed uniformly over the water column.</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">!  (inout) T            = layer potential/conservative temperatures (deg C)</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">!  (inout) Pen_SW_bnd   = penetrating shortwave heating in each band that</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">!                         hits the bottom and will be redistributed through</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">!                         the water column (units of K*H), size nsw x SZI_(G).</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">! These optional arguments apply when the bulk mixed layer is used</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">! but are unnecessary with other schemes.</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">!  (in,opt)    eps      = small thickness that must remain in each layer, and</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">!                         which will not be subject to heating (units of H)</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">!  (inout,opt) ksort    = density-sorted k-indicies</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">!  (in,opt)    htot     = total mixed layer thickness, in H</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">!  (inout,opt) Ttot     = depth integrated mixed layer temperature (units of K H)</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">!  (in,opt)    dSV_dT   = the partial derivative of specific volume with temperature, in m3 kg-1 K-1.</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">!  (inout,opt) TKE      = the TKE sink from mixing the heating throughout a layer, in J m-2.</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    t_chg_above    <span class="comment">! A temperature change that will be applied to all the thick</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                   <span class="comment">! layers above a given layer, in K.  This is only nonzero if</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                   <span class="comment">! adjustAbsorptionProfile is true, in which case the net</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                   <span class="comment">! change in the temperature of a layer is the sum of the</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                   <span class="comment">! direct heating of that layer plus T_chg_above from all of</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                   <span class="comment">! the layers below, plus any contribution from absorbing</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                   <span class="comment">! radiation that hits the bottom.</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    h_heat, &amp;      <span class="comment">! The thickness of the water column that will be heated by</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                   <span class="comment">! any remaining shortwave radiation (H units).</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    t_chg, &amp;       <span class="comment">! The temperature change of thick layers due to the remaining</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                   <span class="comment">! shortwave radiation and contributions from T_chg_above, in K.</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    pen_sw_rem     <span class="comment">! The sum across all wavelength bands of the penetrating shortwave</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                   <span class="comment">! heating that hits the bottom and will be redistributed through</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                   <span class="comment">! the water column (in units of K H)</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="keywordtype">real</span> :: sw_trans          <span class="comment">! fraction of shortwave radiation that is not</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                            <span class="comment">! absorbed in a layer (nondimensional)</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordtype">real</span> :: unabsorbed        <span class="comment">! fraction of the shortwave radiation that</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                            <span class="comment">! is not absorbed because the layers are too thin</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="keywordtype">real</span> :: ih_limit          <span class="comment">! inverse of the total depth at which the</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                            <span class="comment">! surface fluxes start to be limited (1/H)</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">real</span> :: h_min_heat        <span class="comment">! minimum thickness layer that should get heated (H)</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keywordtype">real</span> :: opt_depth         <span class="comment">! optical depth of a layer (non-dim)</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordtype">real</span> :: exp_od            <span class="comment">! exp(-opt_depth) (non-dim)</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordtype">real</span> :: heat_bnd          <span class="comment">! heating due to absorption in the current</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                            <span class="comment">! layer by the current band, including any piece that</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                            <span class="comment">! is moved upward (K H units)</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordtype">real</span> :: swa               <span class="comment">! fraction of the absorbed shortwave that is</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                            <span class="comment">! moved to layers above with adjustAbsorptionProfile (non-dim)</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keywordtype">real</span> :: coswa_frac        <span class="comment">! The fraction of SWa that is actually moved upward.</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordtype">real</span> :: min_sw_heating    <span class="comment">! A minimum remaining shortwave heating rate that will be</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                            <span class="comment">! simply absorbed in the next layer for computational</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                            <span class="comment">! efficiency, instead of continuing to penetrate, in units</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                            <span class="comment">! of K H s-1.  The default, 2.5e-11, is about 0.08 K m / century.</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keywordtype">real</span> :: epsilon           <span class="comment">! A small thickness that must remain in each</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                            <span class="comment">! layer, and which will not be subject to heating (units of H)</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keywordtype">real</span> :: i_g_earth</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">real</span> :: g_hconv2</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="keywordtype">logical</span> :: sw_remains     <span class="comment">! If true, some column has shortwave radiation that</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                            <span class="comment">! was not entirely absorbed.</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keywordtype">logical</span> :: tke_calc       <span class="comment">! If true, calculate the implications to the</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                            <span class="comment">! TKE budget of the shortwave heating.</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="keywordtype">real</span> :: c1_6, c1_60</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, n</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  sw_remains = .false.</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  min_sw_heating = 2.5e-11</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  h_min_heat = 2.0*gv%Angstrom + gv%H_subroundoff</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  c1_6 = 1.0 / 6.0 ; c1_60 = 1.0 / 60.0</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  tke_calc = (<span class="keyword">present</span>(tke) .and. <span class="keyword">present</span>(dsv_dt))</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  g_hconv2 = gv%g_Earth * gv%H_to_kg_m2**2</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  h_heat(:) = 0.0</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(htot)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie ; h_heat(i) = htot(i) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="comment">! Apply penetrating SW radiation to remaining parts of layers.</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="comment">! Excessively thin layers are not heated to avoid runaway temps.</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="keywordflow">do</span> ks=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    k = ks</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(ksort)) <span class="keywordflow">then</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      <span class="keywordflow">if</span> (ksort(i,ks) &lt;= 0) cycle</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      k = ksort(i,ks)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    epsilon = 0.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(eps)) epsilon = eps(i,k)</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    t_chg_above(i,k) = 0.0</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">if</span> (h(i,k) &gt; 1.5*epsilon) <span class="keywordflow">then</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="comment">! SW_trans is the SW that is transmitted THROUGH the layer</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        opt_depth = h(i,k) * opacity_band(n,i,k)</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        exp_od = exp(-opt_depth)</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        sw_trans = exp_od</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="comment">! Heating at a rate of less than 10-4 W m-2 = 10-3 K m / Century,</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="comment">! and of the layer in question less than 1 K / Century, can be</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="comment">! absorbed without further penetration.</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="comment">! ###Make these numbers into parameters!</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="keywordflow">if</span> (nsw*pen_sw_bnd(n,i)*sw_trans &lt; &amp;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            dt*min_sw_heating*min(gv%m_to_H,1e3*h(i,k)) ) sw_trans = 0.0</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        heat_bnd = pen_sw_bnd(n,i) * (1.0 - sw_trans)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">if</span> (adjustabsorptionprofile .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          <span class="comment">!   In this case, a fraction of the heating is applied to the</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;          <span class="comment">! overlying water so that the mean pressure at which the shortwave</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;          <span class="comment">! heating occurs is exactly what it would have been with a careful</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;          <span class="comment">! pressure-weighted averaging of the exponential heating profile,</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;          <span class="comment">! hence there should be no TKE budget requirements due to this</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;          <span class="comment">! layer.  Very clever, but this is also limited so that the</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;          <span class="comment">! water above is not heated at a faster rate than the layer</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;          <span class="comment">! actually being heated, i.e., SWA &lt;= h_heat / (h_heat + h(i,k))</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;          <span class="comment">! and takes the energetics of the rest of the heating into account.</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;          <span class="comment">! (-RWH, ~7 years later.)</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;          <span class="keywordflow">if</span> (opt_depth &gt; 1e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;            swa = ((opt_depth + (opt_depth + 2.0)*exp_od) - 2.0) / &amp;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;              ((opt_depth + opacity_band(n,i,k) * h_heat(i)) * &amp;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;               (1.0 - exp_od))</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            <span class="comment">! Use Taylor series expansion of the expression above for a</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="comment">! more accurate form with very small layer optical depths.</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;            swa = h(i,k) * (opt_depth * (1.0 - opt_depth)) / &amp;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;              ((h_heat(i) + h(i,k)) * (6.0 - 3.0*opt_depth))</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;          coswa_frac = 0.0</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;          <span class="keywordflow">if</span> (swa*(h_heat(i) + h(i,k)) &gt; h_heat(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;            coswa_frac = (swa*(h_heat(i) + h(i,k)) - h_heat(i) ) / &amp;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                         (swa*(h_heat(i) + h(i,k)))</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;            swa = h_heat(i) / (h_heat(i) + h(i,k))</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;          t_chg_above(i,k) = t_chg_above(i,k) + (swa * heat_bnd) / h_heat(i)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;          t(i,k) = t(i,k) + ((1.0 - swa) * heat_bnd) / h(i,k)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;          coswa_frac = 1.0</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;          t(i,k) = t(i,k) + pen_sw_bnd(n,i) * (1.0 - sw_trans) / h(i,k)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordflow">if</span> (tke_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;          <span class="keywordflow">if</span> (opt_depth &gt; 1e-2) <span class="keywordflow">then</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            tke(i,k) = tke(i,k) - coswa_frac*heat_bnd*dsv_dt(i,k)* &amp;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;               (0.5*h(i,k)*g_hconv2) * &amp;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;               (opt_depth*(1.0+exp_od) - 2.0*(1.0-exp_od)) / (opt_depth*(1.0-exp_od))</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            <span class="comment">! Use Taylor series-derived approximation to the above expression</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            <span class="comment">! that is well behaved and more accurate when opt_depth is small.</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            tke(i,k) = tke(i,k) - coswa_frac*heat_bnd*dsv_dt(i,k)* &amp;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;               (0.5*h(i,k)*g_hconv2) * &amp;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;               (c1_6*opt_depth * (1.0 - c1_60*opt_depth**2))</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="comment">! Add to the accumulated thickness above that could be heated.</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      h_heat(i) = h_heat(i) + h(i,k)</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      h_heat(i) = h_heat(i) + (2.0*h(i,k) - 2.0*h_min_heat)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">! if (.not.absorbAllSW .and. .not.adjustAbsorptionProfile) return</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="comment">! Unless modified, there is no temperature change due to fluxes from the bottom.</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; t_chg(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="keywordflow">if</span> (absorballsw) <span class="keywordflow">then</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="comment">! If there is still shortwave radiation at this point, it could go into</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="comment">! the bottom (with a bottom mud model), or it could be redistributed back</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">! through the water column.</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      pen_sw_rem(i) = pen_sw_bnd(1,i)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      <span class="keywordflow">do</span> n=2,nsw ; pen_sw_rem(i) = pen_sw_rem(i) + pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (pen_sw_rem(i) &gt; 0.0) sw_remains = .true. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    ih_limit = 1.0 / h_limit_fluxes</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((pen_sw_rem(i) &gt; 0.0) .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;      <span class="keywordflow">if</span> (h_heat(i)*ih_limit &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        t_chg(i) = pen_sw_rem(i) / h_heat(i) ; unabsorbed = 0.0</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        t_chg(i) = pen_sw_rem(i) * ih_limit</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        unabsorbed = 1.0 - h_heat(i)*ih_limit</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; pen_sw_bnd(n,i) = unabsorbed * pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordflow">if</span> (absorballsw .or. adjustabsorptionprofile) <span class="keywordflow">then</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">do</span> ks=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      k = ks</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(ksort)) <span class="keywordflow">then</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordflow">if</span> (ksort(i,ks) &lt;= 0) cycle</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        k = ksort(i,ks)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <span class="keywordflow">if</span> (t_chg(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span> ; t(i,k) = t(i,k) + t_chg(i)</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;          t(i,k) = t(i,k) + t_chg(i) * (2.0 - 2.0*h_min_heat/h(i,k))</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="comment">! Increase the heating for layers above.</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;      t_chg(i) = t_chg(i) + t_chg_above(i,k)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(htot) .and. <span class="keyword">present</span>(ttot)) <span class="keywordflow">then</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; ttot(i) = ttot(i) + t_chg(i) * htot(i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW .or. adjustAbsorptionProfile</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__shortwave__abs_a977474b56b68f4db0d6b0dc604755e6c_icgraph.svg" width="100%" height="378"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a8a1184c3f836d0900dfd5fa587cfb879"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a1184c3f836d0900dfd5fa587cfb879">&#9670;&nbsp;</a></span>sumswoverbands()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_shortwave_abs::sumswoverbands </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(in)&#160;</td>
          <td class="paramname"><em>opacity_band</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nsw</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>H_limit_fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>absorbAllSW</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(in)&#160;</td>
          <td class="paramname"><em>iPen_SW_bnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szk_(g)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>netPen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">opacity_band</td><td>opacity in each band of penetrating shortwave radiation, in m-1. The indicies are band, i, k.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nsw</td><td>number of bands of penetrating shortwave radiation.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to work on.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time step (seconds). </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__shortwave__abs_8F90_source.html#l00363">363</a> of file <a class="el" href="MOM__shortwave__abs_8F90_source.html">MOM_shortwave_abs.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__aux_8F90_source.html#l00814">mom_diabatic_aux::applyboundaryfluxesinout()</a>, and <a class="el" href="MOM__forcing__type_8F90_source.html#l00775">mom_forcing_type::calculatebuoyancyflux1d()</a>.</p>
<div class="fragment"><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">!&lt; This subroutine calculates the total shortwave heat flux integrated over</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">!! bands as a function of depth.  This routine is only called for computing</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">!! buoyancy fluxes for use in KPP. This routine does not updat e the state.</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),              <span class="keywordtype">intent(in)</span>    :: g<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),            <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">  !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">   !&lt; Layer thicknesses, in H (usually m</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">                                                           !! or kg m-2).</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>,             <span class="keywordtype">intent(in)</span>    :: opacity_band<span class="comment"> !&lt; opacity in each band of</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">                                                           !! penetrating shortwave radiation,</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">                                                           !! in m-1. The indicies are band, i, k.</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordtype">integer</span>,                            <span class="keywordtype">intent(in)</span>    :: nsw<span class="comment"> !&lt; number of bands of penetrating</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">                                                           !! shortwave radiation.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordtype">integer</span>,                            <span class="keywordtype">intent(in)</span>    :: j<span class="comment">   !&lt; j-index to work on.</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">  !&lt; Time step (seconds).</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordtype">real</span>,                               <span class="keywordtype">intent(in)</span>    :: h_limit_fluxes</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordtype">logical</span>,                            <span class="keywordtype">intent(in)</span>    :: absorballsw</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,               <span class="keywordtype">intent(in)</span>    :: ipen_sw_bnd</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: netpen <span class="comment">! Units of K H.</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">!  (in)      G             = ocean grid structure</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">!  (in)      GV            = The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">!  (in)      h             = layer thickness (units of m or kg/m^2);</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">!                            units of h are referred to as H below.</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">!  (in)      opacity_band  = opacity in each band of penetrating shortwave</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">!                            radiation, in m-1. The indicies are band, i, k.</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">!  (in)      nsw           = number of bands of penetrating shortwave radiation</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">!  (in)      j             = j-index to work on</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">!  (in)      dt            = time step (seconds)</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">!  (inout)   Pen_SW_bnd    = penetrating shortwave heating in each band that</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">!                            hits the bottom and will be redistributed through</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">!                            the water column (K H units); size nsw x SZI_(G).</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">!  (out)     netPen        = attenuated flux at interfaces, summed over bands (K H units)</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordtype">real</span> :: h_heat(szi_(g))     <span class="comment">! thickness of the water column that receives</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                              <span class="comment">! remaining shortwave radiation, in H.</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="keywordtype">real</span> :: pen_sw_rem(szi_(g)) <span class="comment">! sum across all wavelength bands of the</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                              <span class="comment">! penetrating shortwave heating that hits the bottom</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                              <span class="comment">! and will be redistributed through the water column</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                              <span class="comment">! (K H units)</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(size(iPen_SW_bnd,1),size(iPen_SW_bnd,2))</span> :: pen_sw_bnd</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="keywordtype">real</span> :: sw_trans        <span class="comment">! fraction of shortwave radiation not</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                          <span class="comment">! absorbed in a layer (nondimensional)</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="keywordtype">real</span> :: unabsorbed      <span class="comment">! fraction of the shortwave radiation</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                          <span class="comment">! not absorbed because the layers are too thin.</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordtype">real</span> :: ih_limit        <span class="comment">! inverse of the total depth at which the</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                          <span class="comment">! surface fluxes start to be limited (1/H units)</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordtype">real</span> :: h_min_heat      <span class="comment">! minimum thickness layer that should get heated (H units)</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">real</span> :: opt_depth       <span class="comment">! optical depth of a layer (non-dim)</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordtype">real</span> :: exp_od          <span class="comment">! exp(-opt_depth) (non-dim)</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordtype">logical</span> :: sw_remains   <span class="comment">! If true, some column has shortwave radiation that</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                          <span class="comment">! was not entirely absorbed.</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, nz, i, k, ks, n</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  sw_remains = .false.</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  h_min_heat = 2.0*gv%Angstrom + gv%H_subroundoff</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  is = g%isc ; ie = g%iec ; nz = g%ke</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  pen_sw_bnd(:,:) = ipen_sw_bnd(:,:)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; h_heat(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  netpen(:,1) = sum( pen_sw_bnd(:,:), dim=1 ) <span class="comment">! Surface interface</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="comment">! Apply penetrating SW radiation to remaining parts of layers.</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="comment">! Excessively thin layers are not heated to avoid runaway temps.</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;      netpen(i,k+1) = 0.</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      <span class="keywordflow">if</span> (h(i,k) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordflow">do</span> n=1,nsw ; <span class="keywordflow">if</span> (pen_sw_bnd(n,i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          <span class="comment">! SW_trans is the SW that is transmitted THROUGH the layer</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;          opt_depth = h(i,k)*gv%H_to_m * opacity_band(n,i,k)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          exp_od = exp(-opt_depth)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;          sw_trans = exp_od</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;          <span class="comment">! Heating at a rate of less than 10-4 W m-2 = 10-3 K m / Century,</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;          <span class="comment">! and of the layer in question less than 1 K / Century, can be</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;          <span class="comment">! absorbed without further penetration.</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;          <span class="keywordflow">if</span> ((nsw*pen_sw_bnd(n,i)*sw_trans &lt; gv%m_to_H*2.5e-11*dt) .and. &amp;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;              (nsw*pen_sw_bnd(n,i)*sw_trans &lt; h(i,k)*dt*2.5e-8)) &amp;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            sw_trans = 0.0</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          pen_sw_bnd(n,i) = pen_sw_bnd(n,i) * sw_trans</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          netpen(i,k+1)   = netpen(i,k+1) + pen_sw_bnd(n,i)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! h(i,k) &gt; 0.0</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      <span class="comment">! Add to the accumulated thickness above that could be heated.</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      <span class="comment">! Only layers greater than h_min_heat thick should get heated.</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="keywordflow">if</span> (h(i,k) &gt;= 2.0*h_min_heat) <span class="keywordflow">then</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        h_heat(i) = h_heat(i) + h(i,k)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;      <span class="keywordflow">elseif</span> (h(i,k) &gt; h_min_heat) <span class="keywordflow">then</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        h_heat(i) = h_heat(i) + (2.0*h(i,k) - 2.0*h_min_heat)</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i loop</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! k loop</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordflow">if</span> (absorballsw) <span class="keywordflow">then</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">! If there is still shortwave radiation at this point, it could go into</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="comment">! the bottom (with a bottom mud model), or it could be redistributed back</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">! through the water column.</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      pen_sw_rem(i) = pen_sw_bnd(1,i)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      <span class="keywordflow">do</span> n=2,nsw ; pen_sw_rem(i) = pen_sw_rem(i) + pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (pen_sw_rem(i) &gt; 0.0) sw_remains = .true. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    ih_limit = 1.0 / h_limit_fluxes</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> ((pen_sw_rem(i) &gt; 0.0) .and. (h_heat(i) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      <span class="keywordflow">if</span> (h_heat(i)*ih_limit &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        unabsorbed = 1.0 - h_heat(i)*ih_limit</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        unabsorbed = 0.0</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="keywordflow">do</span> n=1,nsw ; pen_sw_bnd(n,i) = unabsorbed * pen_sw_bnd(n,i) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! absorbAllSW</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__shortwave__abs_a8a1184c3f836d0900dfd5fa587cfb879_icgraph.svg" width="100%" height="366"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__shortwave__abs.html">mom_shortwave_abs</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
