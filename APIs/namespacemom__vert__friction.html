<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_vert_friction Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__vert__friction.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_vert_friction Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implements vertical viscosity (vertvisc) </p>
<dl class="section author"><dt>Author</dt><dd>Robert Hallberg </dd></dl>
<dl class="section date"><dt>Date</dt><dd>April 1994 - October 2006</dd></dl>
<p>The vertical diffusion of momentum is fully implicit. This is necessary to allow for vanishingly small layers. The coupling is based on the distance between the centers of adjacent layers, except where a layer is close to the bottom compared with a bottom boundary layer thickness when a bottom drag law is used. A stress top b.c. and a no slip bottom b.c. are used. There is no limit on the time step for vertvisc.</p>
<p>Near the bottom, the horizontal thickness interpolation scheme changes to an upwind biased estimate to control the effect of spurious Montgomery potential gradients at the bottom where nearly massless layers layers ride over the topography. Within a few boundary layer depths of the bottom, the harmonic mean thickness (i.e. (2 h+ h-) / (h+ + h-) ) is used if the velocity is from the thinner side and the arithmetic mean thickness (i.e. (h+ + h-)/2) is used if the velocity is from the thicker side. Both of these thickness estimates are second order accurate. Above this the arithmetic mean thickness is used.</p>
<p>In addition, vertvisc truncates any velocity component that exceeds maxvel to truncvel. This basically keeps instabilities spatially localized. The number of times the velocity is truncated is reported each time the energies are saved, and if exceeds CSMaxtrunc the model will stop itself and change the time to a large value. This has proven very useful in (1) diagnosing model failures and (2) letting the model settle down to a meaningful integration from a poorly specified initial condition.</p>
<p>The same code is used for the two velocity components, by indirectly referencing the velocities and defining a handful of direction-specific defined variables.</p>
<p>Macros written all in capital letters are defined in <a class="el" href="MOM__memory_8h.html" title="Compile-time memory settings. ">MOM_memory.h</a>.</p>
<p>A small fragment of the grid is shown below: </p><pre class="fragment">    j+1  x ^ x ^ x   At x:  q
    j+1  &gt; o &gt; o &gt;   At ^:  v, frhatv, tauy
    j    x ^ x ^ x   At &gt;:  u, frhatu, taux
    j    &gt; o &gt; o &gt;   At o:  h
    j-1  x ^ x ^ x
        i-1  i  i+1  At x &amp; ^:
           i  i+1    At &gt; &amp; o:</pre><p>The boundaries always run through q grid points (x). </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:afcb3ca5d907b32d50101f90e93d0b160"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#afcb3ca5d907b32d50101f90e93d0b160">vertvisc</a> (u, v, h, fluxes, visc, dt, OBC, ADp, CDp, G, GV, CS, taux_bot, tauy_bot)</td></tr>
<tr class="memdesc:afcb3ca5d907b32d50101f90e93d0b160"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform a fully implicit vertical diffusion of momentum. Stress top and bottom boundary conditions are used.  <a href="#afcb3ca5d907b32d50101f90e93d0b160">More...</a><br /></td></tr>
<tr class="separator:afcb3ca5d907b32d50101f90e93d0b160"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc0ab44f987baf2efee2f43fa54435f2"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#acc0ab44f987baf2efee2f43fa54435f2">vertvisc_remnant</a> (visc, visc_rem_u, visc_rem_v, dt, G, GV, CS)</td></tr>
<tr class="memdesc:acc0ab44f987baf2efee2f43fa54435f2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the fraction of momentum originally in a layer that remains after a time-step of viscosity, and the fraction of a time-step's worth of barotropic acceleration that a layer experiences after viscosity is applied.  <a href="#acc0ab44f987baf2efee2f43fa54435f2">More...</a><br /></td></tr>
<tr class="separator:acc0ab44f987baf2efee2f43fa54435f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5c29ca42705b12654f06005afb84fdfa"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#a5c29ca42705b12654f06005afb84fdfa">vertvisc_coef</a> (u, v, h, fluxes, visc, dt, G, GV, CS, OBC)</td></tr>
<tr class="memdesc:a5c29ca42705b12654f06005afb84fdfa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the coupling coefficients (CSa_u and CSa_v) and effective layer thicknesses (CSh_u and CSh_v) for later use in the applying the implicit vertical viscosity via <a class="el" href="namespacemom__vert__friction.html#afcb3ca5d907b32d50101f90e93d0b160" title="Perform a fully implicit vertical diffusion of momentum. Stress top and bottom boundary conditions ar...">vertvisc()</a>.  <a href="#a5c29ca42705b12654f06005afb84fdfa">More...</a><br /></td></tr>
<tr class="separator:a5c29ca42705b12654f06005afb84fdfa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac2dc4c420077931f1413d61a495c20da"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#ac2dc4c420077931f1413d61a495c20da">find_coupling_coef</a> (a, hvel, do_i, h_harm, bbl_thick, kv_bbl, z_i, h_ml, dt, j, G, GV, CS, visc, fluxes, work_on_u, OBC, shelf)</td></tr>
<tr class="memdesc:ac2dc4c420077931f1413d61a495c20da"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the 'coupling coefficient' (a[k]) at the interfaces. If BOTTOMDRAGLAW is defined, the minimum of Hbbl and half the adjacent layer thicknesses are used to calculate a[k] near the bottom.  <a href="#ac2dc4c420077931f1413d61a495c20da">More...</a><br /></td></tr>
<tr class="separator:ac2dc4c420077931f1413d61a495c20da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82bae17e9c3b1a5f1eedb6c1d14c5998"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#a82bae17e9c3b1a5f1eedb6c1d14c5998">vertvisc_limit_vel</a> (u, v, h, ADp, CDp, fluxes, visc, dt, G, GV, CS)</td></tr>
<tr class="memdesc:a82bae17e9c3b1a5f1eedb6c1d14c5998"><td class="mdescLeft">&#160;</td><td class="mdescRight">Velocity components which exceed a threshold for physically reasonable values are truncated. Optionally, any column with excessive velocities may be sent to a diagnostic reporting subroutine.  <a href="#a82bae17e9c3b1a5f1eedb6c1d14c5998">More...</a><br /></td></tr>
<tr class="separator:a82bae17e9c3b1a5f1eedb6c1d14c5998"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02be81324ab60dcbcf3c1ecf3aa0da17"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#a02be81324ab60dcbcf3c1ecf3aa0da17">vertvisc_init</a> (MIS, Time, G, GV, param_file, diag, ADp, dirs, ntrunc, CS)</td></tr>
<tr class="memdesc:a02be81324ab60dcbcf3c1ecf3aa0da17"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialise the vertical friction module.  <a href="#a02be81324ab60dcbcf3c1ecf3aa0da17">More...</a><br /></td></tr>
<tr class="separator:a02be81324ab60dcbcf3c1ecf3aa0da17"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62e586a80ed4bdd3fd27ab62ca4c054f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#a62e586a80ed4bdd3fd27ab62ca4c054f">updatecfltruncationvalue</a> (Time, CS, activate)</td></tr>
<tr class="memdesc:a62e586a80ed4bdd3fd27ab62ca4c054f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update the CFL truncation value as a function of time. If called with the optional argument activate=.true., record the value of Time as the beginning of the ramp period.  <a href="#a62e586a80ed4bdd3fd27ab62ca4c054f">More...</a><br /></td></tr>
<tr class="separator:a62e586a80ed4bdd3fd27ab62ca4c054f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a158d29cf5c1d79ca7c5f327706855972"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__vert__friction.html#a158d29cf5c1d79ca7c5f327706855972">vertvisc_end</a> (CS)</td></tr>
<tr class="memdesc:a158d29cf5c1d79ca7c5f327706855972"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clean up and deallocate the vertical friction module.  <a href="#a158d29cf5c1d79ca7c5f327706855972">More...</a><br /></td></tr>
<tr class="separator:a158d29cf5c1d79ca7c5f327706855972"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="ac2dc4c420077931f1413d61a495c20da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac2dc4c420077931f1413d61a495c20da">&#9670;&nbsp;</a></span>find_coupling_coef()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_vert_friction::find_coupling_coef </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, gv %ke+1), intent(out)&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>hvel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, dimension( g %isdb: g %iedb), intent(in)&#160;</td>
          <td class="paramname"><em>do_i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h_harm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb), intent(in)&#160;</td>
          <td class="paramname"><em>bbl_thick</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb), intent(in)&#160;</td>
          <td class="paramname"><em>kv_bbl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, gv %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>z_i</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb), intent(out)&#160;</td>
          <td class="paramname"><em>h_ml</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>work_on_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>shelf</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculate the 'coupling coefficient' (a[k]) at the interfaces. If BOTTOMDRAGLAW is defined, the minimum of Hbbl and half the adjacent layer thicknesses are used to calculate a[k] near the bottom. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">a</td><td>Coupling coefficient across interfaces, in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hvel</td><td>Thickness at velocity points, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">do_i</td><td>If true, determine coupling coefficient for a column</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_harm</td><td>Harmonic mean of thicknesses around a velocity grid point, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bbl_thick</td><td>Bottom boundary layer thickness, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">kv_bbl</td><td>Bottom boundary layer viscosity, in m2 s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">z_i</td><td>Estimate of interface heights above the bottom, normalised by the bottom boundary layer thickness</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">h_ml</td><td>Mixed layer depth, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">j</td><td>j-index to find coupling coefficient for</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment, in s</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Structure containing viscosities and bottom drag</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Structure containing forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">work_on_u</td><td>If true, u-points are being calculated, otherwise v-points</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>Open boundary condition structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">shelf</td><td>If present and true, use a surface boundary condition appropriate for an ice shelf. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l00981">981</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__open__boundary_8F90_source.html#l00049">mom_open_boundary::obc_direction_n</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00050">mom_open_boundary::obc_direction_s</a>, and <a class="el" href="MOM__open__boundary_8F90_source.html#l00052">mom_open_boundary::obc_direction_w</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__vert__friction_8F90_source.html#l00534">vertvisc_coef()</a>.</p>
<div class="fragment"><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span>                 :: g<span class="comment">  !&lt; Ocean grid structure</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),               <span class="keywordtype">intent(in)</span> :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="comment">  !&gt; Coupling coefficient across interfaces, in m s-1</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(out)</span> :: a<span class="comment"></span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="comment">  !&gt; Thickness at velocity points, in H</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>  :: hvel<span class="comment"></span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">  !&gt; If true, determine coupling coefficient for a column</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZIB_(G))</span>,            <span class="keywordtype">intent(in)</span>  :: do_i<span class="comment"></span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">  !&gt; Harmonic mean of thicknesses around a velocity grid point, in H</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>  :: h_harm<span class="comment"></span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">  !&gt; Bottom boundary layer thickness, in H</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G))</span>,            <span class="keywordtype">intent(in)</span>  :: bbl_thick<span class="comment"></span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">  !&gt; Bottom boundary layer viscosity, in m2 s-1</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G))</span>,            <span class="keywordtype">intent(in)</span>  :: kv_bbl<span class="comment"></span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="comment">  !&gt; Estimate of interface heights above the bottom,</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="comment">  !! normalised by the bottom boundary layer thickness</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(in)</span>  :: z_i<span class="comment"></span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment">  !&gt; Mixed layer depth, in H</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">dimension(SZIB_(G))</span>,         <span class="keywordtype">intent(out)</span> :: h_ml<span class="comment"></span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;<span class="comment">  !&gt; j-index to find coupling coefficient for</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  <span class="keywordtype">integer</span>,                              <span class="keywordtype">intent(in)</span>  :: j<span class="comment"></span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment">  !&gt; Time increment, in s</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  <span class="keywordtype">real</span>,                                 <span class="keywordtype">intent(in)</span>  :: dt<span class="comment"></span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="comment">  !&gt; Vertical viscosity control structure</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs), <span class="keywordtype">pointer</span>                        :: cs<span class="comment"></span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="comment">  !&gt; Structure containing viscosities and bottom drag</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type), <span class="keywordtype">intent(in)</span>                   :: visc<span class="comment"></span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment">  !&gt; Structure containing forcing fields</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="keywordtype">type</span>(forcing), <span class="keywordtype">intent(in)</span>                         :: fluxes<span class="comment"></span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">  !&gt; If true, u-points are being calculated, otherwise v-points</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  <span class="keywordtype">logical</span>,                              <span class="keywordtype">intent(in)</span>  :: work_on_u<span class="comment"></span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="comment">  !&gt; Open boundary condition structure</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),  <span class="keywordtype">pointer</span>         :: obc<span class="comment"></span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">  !&gt; If present and true, use a surface boundary condition</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">  !! appropriate for an ice shelf.</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,                    <span class="keywordtype">intent(in)</span>  :: shelf</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    u_star, &amp;   <span class="comment">! ustar at a velocity point, in m s-1.</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    absf, &amp;     <span class="comment">! The average of the neighboring absolute values of f, in s-1.</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="comment">!      h_ml, &amp;     ! The mixed layer depth, in m or kg m-2.</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    nk_visc, &amp;  <span class="comment">! The (real) interface index of the base of mixed layer.</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    z_t, &amp;      <span class="comment">! The distance from the top, sometimes normalized</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                <span class="comment">! by Hmix, in m or nondimensional.</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    kv_tbl, &amp;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    tbl_thick</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(GV))</span> :: &amp;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    kv_add      <span class="comment">! A viscosity to add, in m2 s-1.</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;  <span class="keywordtype">real</span> :: h_shear <span class="comment">! The distance over which shears occur, m or kg m-2.</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="keywordtype">real</span> :: r       <span class="comment">! A thickness to compare with Hbbl, in m or kg m-2.</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;  <span class="keywordtype">real</span> :: visc_ml <span class="comment">! The mixed layer viscosity, in m2 s-1.</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;  <span class="keywordtype">real</span> :: i_hmix  <span class="comment">! The inverse of the mixed layer thickness, in m-1 or m2 kg-1.</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="keywordtype">real</span> :: a_ml    <span class="comment">! The layer coupling coefficient across an interface in</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                  <span class="comment">! the mixed layer, in m s-1.</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="keywordtype">real</span> :: temp1   <span class="comment">! A temporary variable in m2 s-1.</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;  <span class="keywordtype">real</span> :: h_neglect   <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                      <span class="comment">! in roundoff and can be neglected, in H.</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="keywordtype">real</span> :: dz_neglect  <span class="comment">! A thickness in m that is so small it is usually lost</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                      <span class="comment">! in roundoff and can be neglected, in m.</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;  <span class="keywordtype">real</span> :: z2      <span class="comment">! A copy of z_i, nondim.</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;  <span class="keywordtype">real</span> :: h_to_m, m_to_h <span class="comment">! Unit conversion factors.</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  <span class="keywordtype">real</span> :: topfn</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="keywordtype">real</span> :: a_top</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordtype">logical</span> :: do_shelf, do_obcs</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordtype">integer</span> :: i, k, is, ie, max_nk</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="keywordtype">integer</span> :: nz</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordtype">real</span>    :: botfn</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  a(:,:) = 0.0</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;  <span class="keywordflow">if</span> (work_on_u) <span class="keywordflow">then</span> ; is = g%IscB ; ie = g%IecB</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keywordflow">else</span> ; is = g%isc ; ie = g%iec ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  nz = g%ke</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  h_to_m = gv%H_to_m ; m_to_h = gv%m_to_H</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  dz_neglect = gv%H_subroundoff*gv%H_to_m</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  do_shelf = .false. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(shelf)) do_shelf = shelf</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  do_obcs = .false.</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; do_obcs = (obc%number_of_segments &gt; 0) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  h_ml(:) = 0.0</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment">!    The following loop calculates the vertical average velocity and</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">!  surface mixed layer contributions to the vertical viscosity.</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; a(i,1) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  <span class="keywordflow">if</span> ((gv%nkml&gt;0) .or. do_shelf) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <span class="keywordflow">if</span> (do_i(i)) a(i,k) = 2.0*cs%Kv</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ; <span class="keywordflow">else</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    i_hmix = 1.0 / (cs%Hmix * m_to_h + h_neglect)</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; z_t(i) = h_neglect*i_hmix ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;      z_t(i) = z_t(i) + h_harm(i,k-1)*i_hmix</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;      a(i,k) = 2.0*cs%Kv + 2.0*cs%Kvml / ((z_t(i)*z_t(i)) *  &amp;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;               (1.0 + 0.09*z_t(i)*z_t(i)*z_t(i)*z_t(i)*z_t(i)*z_t(i)))</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="keywordflow">if</span> (cs%bottomdraglaw) <span class="keywordflow">then</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;      r = hvel(i,nz)*0.5</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      <span class="keywordflow">if</span> (r &lt; bbl_thick(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        a(i,nz+1) = 1.0*kv_bbl(i) / (1e-10*dt*kv_bbl(i) + r*h_to_m)</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        a(i,nz+1) = 1.0*kv_bbl(i) / (1e-10*dt*kv_bbl(i) + bbl_thick(i)*h_to_m)</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;      a(i,nz+1) = 2.0*cs%Kvbbl / (hvel(i,nz)*h_to_m + 2.0e-10*dt*cs%Kvbbl)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(visc%Kv_turb)) <span class="keywordflow">then</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;     <span class="comment">! BGR/ Add factor of 2. * the averaged Kv_turb.</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;     <span class="comment">!      this is needed to reproduce the analytical solution to</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;     <span class="comment">!      a simple diffusion problem, likely due to h_shear being</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;     <span class="comment">!      equal to 2 x \delta z</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keywordflow">if</span> (work_on_u) <span class="keywordflow">then</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        kv_add(i,k) = (2.*0.5)*(visc%Kv_turb(i,j,k) + visc%Kv_turb(i+1,j,k))</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      <span class="keywordflow">if</span> (do_obcs) <span class="keywordflow">then</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_u(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;          <span class="keywordflow">if</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_e) <span class="keywordflow">then</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            <span class="keywordflow">do</span> k=2,nz ; kv_add(i,k) = 2.*visc%Kv_turb(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;          <span class="keywordflow">elseif</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_w) <span class="keywordflow">then</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            <span class="keywordflow">do</span> k=2,nz ; kv_add(i,k) = 2.*visc%Kv_turb(i+1,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        a(i,k) = a(i,k) + kv_add(i,k)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        kv_add(i,k) = (2.*0.5)*(visc%Kv_turb(i,j,k) + visc%Kv_turb(i,j+1,k))</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;      <span class="keywordflow">if</span> (do_obcs) <span class="keywordflow">then</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_v(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;          <span class="keywordflow">if</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_n) <span class="keywordflow">then</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;            <span class="keywordflow">do</span> k=2,nz ; kv_add(i,k) = 2.*visc%Kv_turb(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;          <span class="keywordflow">elseif</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_s) <span class="keywordflow">then</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;            <span class="keywordflow">do</span> k=2,nz ; kv_add(i,k) = 2.*visc%Kv_turb(i,j+1,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        a(i,k) = a(i,k) + kv_add(i,k)</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;  <span class="keywordflow">do</span> k=nz,2,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <span class="comment">!    botfn determines when a point is within the influence of the bottom</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <span class="comment">!  boundary layer, going from 1 at the bottom to 0 in the interior.</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    z2 = z_i(i,k)</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    botfn = 1.0 / (1.0 + 0.09*z2*z2*z2*z2*z2*z2)</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <span class="keywordflow">if</span> (cs%bottomdraglaw) <span class="keywordflow">then</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;      a(i,k) = a(i,k) + 2.0*(kv_bbl(i)-cs%Kv)*botfn</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;      r = (hvel(i,k)+hvel(i,k-1))</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      <span class="keywordflow">if</span> (r &gt; 2.0*bbl_thick(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        h_shear = ((1.0 - botfn) * r + botfn*2.0*bbl_thick(i))</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        h_shear = r</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;      a(i,k) = a(i,k) + 2.0*(cs%Kvbbl-cs%Kv)*botfn</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      h_shear = hvel(i,k) + hvel(i,k-1) + h_neglect</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="comment">!   Up to this point a has units of m2 s-1, but now is converted to m s-1.</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <span class="comment">!   The term including 1e-10 in the denominators is here to avoid</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="comment">! truncation error problems in the tridiagonal solver. Effectively, this</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <span class="comment">! sets the maximum coupling coefficient at 1e10 m.</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    a(i,k) = a(i,k) / (h_shear*h_to_m + 1.0e-10*dt*a(i,k))</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  <span class="keywordflow">if</span> (do_shelf) <span class="keywordflow">then</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="comment">! Set the coefficients to include the no-slip surface stress.</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;      <span class="keywordflow">if</span> (work_on_u) <span class="keywordflow">then</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        kv_tbl(i) = visc%kv_tbl_shelf_u(i,j)</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        tbl_thick(i) = visc%tbl_thick_shelf_u(i,j) * m_to_h</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        kv_tbl(i) = visc%kv_tbl_shelf_v(i,j)</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        tbl_thick(i) = visc%tbl_thick_shelf_v(i,j) * m_to_h</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;      z_t(i) = 0.0</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;      <span class="comment">! If a(i,1) were not already 0, it would be added here.</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;      <span class="keywordflow">if</span> (0.5*hvel(i,1) &gt; tbl_thick(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        a(i,1) = kv_tbl(i) / (tbl_thick(i) *h_to_m + (1.0e-10*dt)*kv_tbl(i))</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        a(i,1) = kv_tbl(i) / (0.5*hvel(i,1)*h_to_m + (1.0e-10*dt)*kv_tbl(i))</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ;  <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;      z_t(i) = z_t(i) + hvel(i,k-1) / tbl_thick(i)</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;      topfn = 1.0 / (1.0 + 0.09 * z_t(i)**6)</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;      r = (hvel(i,k)+hvel(i,k-1))</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;      <span class="keywordflow">if</span> (r &gt; 2.0*tbl_thick(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        h_shear = ((1.0 - topfn) * r + topfn*2.0*tbl_thick(i))</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        h_shear = r</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="comment">!   The term including 1e-10 in the denominators is here to avoid</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    <span class="comment">! truncation error problems in the tridiagonal solver. Effectively, this</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="comment">! sets the maximum coupling coefficient increment to 1e10 m.</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;      a_top = 2.0 * topfn * kv_tbl(i)</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;      a(i,k) = a(i,k) + a_top / (h_shear*h_to_m + 1.0e-10*dt*a_top)</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  <span class="keywordflow">elseif</span> (cs%dynamic_viscous_ML .or. (gv%nkml&gt;0)) <span class="keywordflow">then</span></div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    max_nk = 0</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;      <span class="keywordflow">if</span> (gv%nkml&gt;0) nk_visc(i) = <span class="keywordtype">real</span>(gv%nkml+1)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;      <span class="keywordflow">if</span> (work_on_u) <span class="keywordflow">then</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        u_star(i) = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i+1,j))</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        absf(i) = 0.5*(abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="keywordflow">if</span> (cs%dynamic_viscous_ML) nk_visc(i) = visc%nkml_visc_u(i,j) + 1</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;        u_star(i) = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i,j+1))</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        absf(i) = 0.5*(abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <span class="keywordflow">if</span> (cs%dynamic_viscous_ML) nk_visc(i) = visc%nkml_visc_v(i,j) + 1</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;      h_ml(i) = h_neglect ; z_t(i) = 0.0</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;      max_nk = max(max_nk,ceiling(nk_visc(i) - 1.0))</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <span class="keywordflow">if</span> (do_obcs) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (work_on_u) <span class="keywordflow">then</span></div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_u(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_e) &amp;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;          u_star(i) = fluxes%ustar(i,j)</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_w) &amp;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;          u_star(i) = fluxes%ustar(i+1,j)</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_v(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_n) &amp;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;          u_star(i) = fluxes%ustar(i,j)</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_s) &amp;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;          u_star(i) = fluxes%ustar(i,j+1)</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="keywordflow">do</span> k=1,max_nk ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;      <span class="keywordflow">if</span> (k+1 &lt;= nk_visc(i)) <span class="keywordflow">then</span> <span class="comment">! This layer is all in the ML.</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        h_ml(i) = h_ml(i) + hvel(i,k)</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;      <span class="keywordflow">elseif</span> (k &lt; nk_visc(i)) <span class="keywordflow">then</span> <span class="comment">! Part of this layer is in the ML.</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        h_ml(i) = h_ml(i) + (nk_visc(i) - k) * hvel(i,k)</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keywordflow">do</span> k=2,max_nk ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (k &lt; nk_visc(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;      <span class="comment">! Set the viscosity at the interfaces.</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;      z_t(i) = z_t(i) + hvel(i,k-1)</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;      temp1 = (z_t(i)*h_ml(i) - z_t(i)*z_t(i)) * h_to_m</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;      <span class="comment">!   This viscosity is set to go to 0 at the mixed layer top and bottom</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;      <span class="comment">! (in a log-layer) and be further limited by rotation to give the</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;      <span class="comment">! natural Ekman length.</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;      visc_ml = u_star(i) * 0.41 * (temp1*u_star(i)) / &amp;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;                     (absf(i)*temp1 + h_ml(i)*u_star(i))</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;      a_ml = 4.0*visc_ml / ((hvel(i,k)+hvel(i,k-1) + h_neglect) * h_to_m + &amp;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                            2.0e-10*dt*visc_ml)</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;      <span class="comment">! Choose the largest estimate of a.</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;      <span class="keywordflow">if</span> (a_ml &gt; a(i,k)) a(i,k) = a_ml</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_ac2dc4c420077931f1413d61a495c20da_icgraph.svg" width="328" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a62e586a80ed4bdd3fd27ab62ca4c054f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a62e586a80ed4bdd3fd27ab62ca4c054f">&#9670;&nbsp;</a></span>updatecfltruncationvalue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::updatecfltruncationvalue </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>activate</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update the CFL truncation value as a function of time. If called with the optional argument activate=.true., record the value of Time as the beginning of the ramp period. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>Current model time</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">activate</td><td>Whether to record the value of Time as the beginning of the ramp period </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l01637">1637</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__dynamics__split__RK2_8F90_source.html#l00205">mom_dynamics_split_rk2::step_mom_dyn_split_rk2()</a>.</p>
<div class="fragment"><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: time<span class="comment">     !&lt; Current model time</span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs),       <span class="keywordtype">pointer</span>       :: cs<span class="comment">       !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="comment">  !&gt; Whether to record the value of Time as the beginning of the ramp period</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,       <span class="keywordtype">intent(in)</span>    :: activate</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;  <span class="keywordtype">real</span> :: deltatime, wghta</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;  <span class="keywordtype">character(len=12)</span> :: msg</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;  <span class="keywordflow">if</span> (cs%truncRampTime==0.) <span class="keywordflow">return</span> <span class="comment">! This indicates to ramping is turned off</span></div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;  <span class="comment">! We use the optional argument to indicate this Time should be recorded as the</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;  <span class="comment">! beginning of the ramp-up period.</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(activate)) <span class="keywordflow">then</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    <span class="keywordflow">if</span> (activate) <span class="keywordflow">then</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;      cs%rampStartTime = time <span class="comment">! Record the current time</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;      cs%CFLrampingIsActivated = .true.</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;  <span class="keywordflow">if</span> (.not.cs%CFLrampingIsActivated) <span class="keywordflow">return</span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;  deltatime = max( 0., time_type_to_real( time - cs%rampStartTime ) )</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;  <span class="keywordflow">if</span> (deltatime &gt;= cs%truncRampTime) <span class="keywordflow">then</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    cs%CFL_trunc = cs%CFL_truncE</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    cs%truncRampTime = 0. <span class="comment">! This turns off ramping after this call</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    wghta = min( 1., deltatime / cs%truncRampTime ) <span class="comment">! Linear profile in time</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    <span class="comment">!wghtA = wghtA*wghtA ! Convert linear profile to parabolic profile in time</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <span class="comment">!wghtA = wghtA*wghtA*(3. - 2.*wghtA) ! Convert linear profile to cosine profile</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    wghta = 1. - ( (1. - wghta)**2 ) <span class="comment">! Convert linear profiel to nverted parabolic profile</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    cs%CFL_trunc = cs%CFL_truncS + wghta * ( cs%CFL_truncE - cs%CFL_truncS )</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;  <span class="keyword">write</span>(msg(1:12),<span class="stringliteral">&#39;(es12.3)&#39;</span>) cs%CFL_trunc</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;  <span class="keyword">call </span>mom_error(note, <span class="stringliteral">&quot;MOM_vert_friction: updateCFLtruncationValue set CFL&quot;</span>// &amp;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                       <span class="stringliteral">&quot; limit to &quot;</span>//trim(msg))</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_a62e586a80ed4bdd3fd27ab62ca4c054f_cgraph.svg" width="552" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_a62e586a80ed4bdd3fd27ab62ca4c054f_icgraph.svg" width="422" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="afcb3ca5d907b32d50101f90e93d0b160"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afcb3ca5d907b32d50101f90e93d0b160">&#9670;&nbsp;</a></span>vertvisc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(inout)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(accel_diag_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>ADp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(cont_diag_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>CDp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>taux_bot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g)), intent(out), optional&#160;</td>
          <td class="paramname"><em>tauy_bot</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform a fully implicit vertical diffusion of momentum. Stress top and bottom boundary conditions are used. </p>
<p>This is solving the tridiagonal system </p><p class="formulaDsp">
\[ \left(h_k + a_{k + 1/2} + a_{k - 1/2} + r_k\right) u_k^{n+1} = h_k u_k^n + a_{k + 1/2} u_{k+1}^{n+1} + a_{k - 1/2} u_{k-1}^{n+1} \]
</p>
<p> where \(a_{k + 1/2} = \Delta t \nu_{k + 1/2} / h_{k + 1/2}\) is the <em>interfacial coupling thickness per time step</em>, encompassing background viscosity as well as contributions from enhanced mixed and bottom layer viscosities. $r_k$ is a Rayleight drag term due to channel drag. There is an additional stress term on the right-hand side if DIRECT_STRESS is true, applied to the surface layer.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">u</td><td>Zonal velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>Meridional velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Structure containing forcing fields</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">visc</td><td>Viscosities and bottom drag</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment in s</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>Open boundary condition structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">adp</td><td>Accelerations in the momentum equations for diagnostics</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cdp</td><td>Continuity equation terms</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">taux_bot</td><td>Zonal bottom stress from ocean to rock in Pa</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">tauy_bot</td><td>Meridional bottom stress from ocean to rock in Pa </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l00140">140</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__vert__friction_8F90_source.html#l01258">vertvisc_limit_vel()</a>.</p>
<div class="fragment"><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">      !&lt; Ocean grid structure</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span>, &amp;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(GV))</span> :: u<span class="comment">      !&lt; Zonal velocity in m s-1</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span>, &amp;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(GV))</span> :: v<span class="comment">      !&lt; Meridional velocity in m s-1</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>, &amp;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>  :: h<span class="comment">      !&lt; Layer thickness in H</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(in)</span>      :: fluxes<span class="comment"> !&lt; Structure containing forcing fields</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),   <span class="keywordtype">intent(inout)</span>   :: visc<span class="comment">   !&lt; Viscosities and bottom drag</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span>      :: dt<span class="comment">     !&lt; Time increment in s</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),  <span class="keywordtype">pointer</span>         :: obc<span class="comment">    !&lt; Open boundary condition structure</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordtype">type</span>(accel_diag_ptrs), <span class="keywordtype">intent(inout)</span>   :: adp<span class="comment">    !&lt; Accelerations in the momentum</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">                                                   !! equations for diagnostics</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordtype">type</span>(cont_diag_ptrs),  <span class="keywordtype">intent(inout)</span>   :: cdp<span class="comment">    !&lt; Continuity equation terms</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs),     <span class="keywordtype">pointer</span>         :: cs<span class="comment">     !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">  !&gt; Zonal bottom stress from ocean to rock in Pa</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: taux_bot<span class="comment"></span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">  !&gt; Meridional bottom stress from ocean to rock in Pa</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(out)</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: tauy_bot</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="comment">! Fields from fluxes used in this subroutine:</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="comment">!   taux: Zonal wind stress in Pa.</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="comment">!   tauy: Meridional wind stress in Pa.</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordtype">real</span> :: b1(szib_(g))          <span class="comment">! b1 and c1 are variables used by the</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordtype">real</span> :: c1(szib_(g),szk_(g))  <span class="comment">! tridiagonal solver.  c1 is nondimensional,</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                                <span class="comment">! while b1 has units of inverse thickness.</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordtype">real</span> :: d1(szib_(g))          <span class="comment">! d1=1-c1 is used by the tridiagonal solver, ND.</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keywordtype">real</span> :: ray(szib_(g),szk_(g)) <span class="comment">! Ray is the Rayleigh-drag velocity in m s-1</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keywordtype">real</span> :: b_denom_1             <span class="comment">! The first term in the denominator of b1, in H.</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="keywordtype">real</span> :: hmix             <span class="comment">! The mixed layer thickness over which stress</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                           <span class="comment">! is applied with direct_stress, translated into</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                           <span class="comment">! thickness units - either m or kg m-2.</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordtype">real</span> :: i_hmix           <span class="comment">! The inverse of Hmix, in m-1 or m2 kg-1.</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="keywordtype">real</span> :: idt              <span class="comment">! The inverse of the time step, in s-1.</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="keywordtype">real</span> :: dt_rho0          <span class="comment">! The time step divided by the mean</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                           <span class="comment">! density, in s m3 kg-1.</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">real</span> :: rho0             <span class="comment">! A density used to convert drag laws into stress in</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                           <span class="comment">! Pa, in kg m-3.</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordtype">real</span> :: dt_m_to_h        <span class="comment">! The time step times the conversion from m to the</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                           <span class="comment">! units of thickness - either s or s m3 kg-1.</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordtype">real</span> :: h_neglect        <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                           <span class="comment">! in roundoff and can be neglected, in m or kg m-2.</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keywordtype">real</span> :: stress           <span class="comment">!   The surface stress times the time step, divided</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                           <span class="comment">! by the density, in units of m2 s-1.</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordtype">real</span> :: zds, hfr, h_a    <span class="comment">! Temporary variables used with direct_stress.</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="keywordtype">real</span> :: surface_stress(szib_(g))<span class="comment">! The same as stress, unless the wind</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                           <span class="comment">! stress is applied as a body force, in</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                           <span class="comment">! units of m2 s-1.</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szib_(g))</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, isq, ieq, jsq, jeq, nz, n</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  is = g%isc ; ie = g%iec</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB ; nz = g%ke</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;MOM_vert_friction(visc): &quot;</span>// &amp;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keywordflow">if</span> (cs%direct_stress) <span class="keywordflow">then</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    hmix = cs%Hmix_stress*gv%m_to_H</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    i_hmix = 1.0 / hmix</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  dt_rho0 = dt/gv%H_to_kg_m2</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  dt_m_to_h = dt*gv%m_to_H</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  rho0 = gv%Rho0</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  idt = 1.0 / dt</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; ray(i,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="comment">!   Update the zonal velocity component using a modification of a standard</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="comment">! tridagonal solver.</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,Isq,Ieq,ADp,nz,u,CS,dt_Rho0,fluxes,h, &amp;</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">!$OMP                                  h_neglect,Hmix,I_Hmix,visc,dt_m_to_H,   &amp;</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">!$OMP                                  Idt,taux_bot,Rho0)                      &amp;</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">!$OMP                     firstprivate(Ray)                                    &amp;</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">!$OMP                          private(do_i,surface_stress,zDS,stress,h_a,hfr, &amp;</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">!$OMP                                     b_denom_1,b1,d1,c1)</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq ; do_i(i) = (g%mask2dCu(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(adp%du_dt_visc)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      adp%du_dt_visc(i,j,k) = u(i,j,k)</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">!   One option is to have the wind stress applied as a body force</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">! over the topmost Hmix fluid.  If DIRECT_STRESS is not defined,</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">! the wind stress is applied as a stress boundary condition.</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordflow">if</span> (cs%direct_stress) <span class="keywordflow">then</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        surface_stress(i) = 0.0</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        zds = 0.0</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        stress = dt_rho0 * fluxes%taux(i,j)</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;          h_a = 0.5 * (h(i,j,k) + h(i+1,j,k)) + h_neglect</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;          hfr = 1.0 ; <span class="keywordflow">if</span> ((zds+h_a) &gt; hmix) hfr = (hmix - zds) / h_a</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;          u(i,j,k) = u(i,j,k) + i_hmix * hfr * stress</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;          zds = zds + h_a ; <span class="keywordflow">if</span> (zds &gt;= hmix) <span class="keywordflow">exit</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! end of i loop</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordflow">else</span> ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;      surface_stress(i) = dt_rho0 * (g%mask2dCu(i,j)*fluxes%taux(i,j))</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span> <span class="comment">! direct_stress</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      ray(i,k) = visc%Ray_u(i,j,k)</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="comment">! perform forward elimination on the tridiagonal system</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">!</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="comment">! denote the diagonal of the system as b_k, the subdiagonal as a_k</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">! and the superdiagonal as c_k. The right-hand side terms are d_k.</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="comment">!</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="comment">! ignoring the rayleigh drag contribution,</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="comment">! we have a_k = -dt_m_to_H * a_u(k)</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="comment">!         b_k = h_u(k) + dt_m_to_H * (a_u(k) + a_u(k+1))</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">!         c_k = -dt_m_to_H * a_u(k+1)</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">!</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="comment">! for forward elimination, we want to:</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">! calculate c&#39;_k = - c_k                / (b_k + a_k c&#39;_(k-1))</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="comment">! and       d&#39;_k = (d_k - a_k d&#39;_(k-1)) / (b_k + a_k c&#39;_(k-1))</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="comment">! where c&#39;_1 = c_1/b_1 and d&#39;_1 = d_1/b_1</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="comment">! (see Thomas&#39; tridiagonal matrix algorithm)</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">!</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="comment">! b1 is the denominator term 1 / (b_k + a_k c&#39;_(k-1))</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="comment">! b_denom_1 is (b_k + a_k + c_k) - a_k(1 - c&#39;_(k-1))</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">!            = (b_k + c_k + c&#39;_(k-1))</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="comment">! this is done so that d1 = b1 * b_denom_1 = 1 - c&#39;_(k-1)</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment">! c1(k) is -c&#39;_(k - 1)</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">! and the right-hand-side is destructively updated to be d&#39;_k</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">!</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      b_denom_1 = cs%h_u(i,j,1) + dt_m_to_h * (ray(i,1) + cs%a_u(i,j,1))</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h*cs%a_u(i,j,2))</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      u(i,j,1) = b1(i) * (cs%h_u(i,j,1) * u(i,j,1) + surface_stress(i))</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      c1(i,k) = dt_m_to_h * cs%a_u(i,j,k) * b1(i)</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;      b_denom_1 = cs%h_u(i,j,k) + dt_m_to_h * (ray(i,k) + cs%a_u(i,j,k)*d1(i))</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h * cs%a_u(i,j,k+1))</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      u(i,j,k) = (cs%h_u(i,j,k) * u(i,j,k) + &amp;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                  dt_m_to_h * cs%a_u(i,j,k) * u(i,j,k-1)) * b1(i)</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="comment">! back substitute to solve for the new velocities</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="comment">! u_k = d&#39;_k - c&#39;_k x_(k+1)</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      u(i,j,k) = u(i,j,k) + c1(i,k+1) * u(i,j,k+1)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i and k loops</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(adp%du_dt_visc)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      adp%du_dt_visc(i,j,k) = (u(i,j,k) - adp%du_dt_visc(i,j,k))*idt</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(visc%taux_shelf)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      visc%taux_shelf(i,j) = -rho0*cs%a1_shelf_u(i,j)*u(i,j,1) <span class="comment">! - u_shelf?</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">PRESENT</span>(taux_bot)) <span class="keywordflow">then</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        taux_bot(i,j) = rho0 * (u(i,j,nz)*cs%a_u(i,j,nz+1))</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        taux_bot(i,j) = taux_bot(i,j) + rho0 * (ray(i,k)*u(i,j,k))</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end u-component j loop</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="comment">! Now work on the meridional velocity component.</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,Jsq,Jeq,ADp,nz,v,CS,dt_Rho0,fluxes,h, &amp;</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">!$OMP                                  Hmix,I_Hmix,visc,dt_m_to_H,Idt,Rho0,    &amp;</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">!$OMP                                  tauy_bot,is,ie)                         &amp;</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">!$OMP                     firstprivate(Ray)                                    &amp;</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">!$OMP                          private(do_i,surface_stress,zDS,stress,h_a,hfr, &amp;</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">!$OMP                                  b_denom_1,b1,d1,c1)</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="keywordflow">do</span> j=jsq,jeq</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; do_i(i) = (g%mask2dCv(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(adp%dv_dt_visc)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      adp%dv_dt_visc(i,j,k) = v(i,j,k)</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">!   One option is to have the wind stress applied as a body force</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">! over the topmost Hmix fluid.  If DIRECT_STRESS is not defined,</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">! the wind stress is applied as a stress boundary condition.</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordflow">if</span> (cs%direct_stress) <span class="keywordflow">then</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        surface_stress(i) = 0.0</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        zds = 0.0</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        stress = dt_rho0 * fluxes%tauy(i,j)</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;          h_a = 0.5 * (h(i,j,k) + h(i,j+1,k))</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;          hfr = 1.0 ; <span class="keywordflow">if</span> ((zds+h_a) &gt; hmix) hfr = (hmix - zds) / h_a</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;          v(i,j,k) = v(i,j,k) + i_hmix * hfr * stress</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;          zds = zds + h_a ; <span class="keywordflow">if</span> (zds &gt;= hmix) <span class="keywordflow">exit</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! end of i loop</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordflow">else</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      surface_stress(i) = dt_rho0 * (g%mask2dCv(i,j)*fluxes%tauy(i,j))</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span> <span class="comment">! direct_stress</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      ray(i,k) = visc%Ray_v(i,j,k)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      b_denom_1 = cs%h_v(i,j,1) + dt_m_to_h * (ray(i,1) + cs%a_v(i,j,1))</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h*cs%a_v(i,j,2))</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      v(i,j,1) = b1(i) * (cs%h_v(i,j,1) * v(i,j,1) + surface_stress(i))</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      c1(i,k) = dt_m_to_h * cs%a_v(i,j,k) * b1(i)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      b_denom_1 = cs%h_v(i,j,k) + dt_m_to_h *  (ray(i,k) + cs%a_v(i,j,k)*d1(i))</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h * cs%a_v(i,j,k+1))</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      v(i,j,k) = (cs%h_v(i,j,k) * v(i,j,k) + dt_m_to_h * &amp;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                  cs%a_v(i,j,k) * v(i,j,k-1)) * b1(i)</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      v(i,j,k) = v(i,j,k) + c1(i,k+1) * v(i,j,k+1)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i and k loops</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(adp%dv_dt_visc)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      adp%dv_dt_visc(i,j,k) = (v(i,j,k) - adp%dv_dt_visc(i,j,k))*idt</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(visc%tauy_shelf)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      visc%tauy_shelf(i,j) = -rho0*cs%a1_shelf_v(i,j)*v(i,j,1) <span class="comment">! - v_shelf?</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">present</span>(tauy_bot)) <span class="keywordflow">then</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        tauy_bot(i,j) = rho0 * (v(i,j,nz)*cs%a_v(i,j,nz+1))</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        tauy_bot(i,j) = tauy_bot(i,j) + rho0 * (ray(i,k)*v(i,j,k))</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of v-component J loop</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keyword">call </span>vertvisc_limit_vel(u, v, h, adp, cdp, fluxes, visc, dt, g, gv, cs)</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="comment">! Here the velocities associated with open boundary conditions are applied.</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      <span class="keywordflow">if</span> (obc%segment(n)%specified) <span class="keywordflow">then</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S) <span class="keywordflow">then</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;          j = obc%segment(n)%HI%JsdB</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=obc%segment(n)%HI%isd,obc%segment(n)%HI%ied</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            v(i,j,k) = obc%segment(n)%normal_vel(i,j,k)</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordflow">elseif</span> (obc%segment(n)%is_E_or_W) <span class="keywordflow">then</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;          i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=obc%segment(n)%HI%jsd,obc%segment(n)%HI%jed</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            u(i,j,k) = obc%segment(n)%normal_vel(i,j,k)</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">! Offer diagnostic fields for averaging.</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">if</span> (cs%id_du_dt_visc &gt; 0) &amp;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keyword">call </span>post_data(cs%id_du_dt_visc, adp%du_dt_visc, cs%diag)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordflow">if</span> (cs%id_dv_dt_visc &gt; 0) &amp;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="keyword">call </span>post_data(cs%id_dv_dt_visc, adp%dv_dt_visc, cs%diag)</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(taux_bot) .and. (cs%id_taux_bot &gt; 0)) &amp;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keyword">call </span>post_data(cs%id_taux_bot, taux_bot, cs%diag)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tauy_bot) .and. (cs%id_tauy_bot &gt; 0)) &amp;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="keyword">call </span>post_data(cs%id_tauy_bot, tauy_bot, cs%diag)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_afcb3ca5d907b32d50101f90e93d0b160_cgraph.svg" width="524" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a5c29ca42705b12654f06005afb84fdfa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5c29ca42705b12654f06005afb84fdfa">&#9670;&nbsp;</a></span>vertvisc_coef()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc_coef </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), pointer&#160;</td>
          <td class="paramname"><em>OBC</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate the coupling coefficients (CSa_u and CSa_v) and effective layer thicknesses (CSh_u and CSh_v) for later use in the applying the implicit vertical viscosity via <a class="el" href="namespacemom__vert__friction.html#afcb3ca5d907b32d50101f90e93d0b160" title="Perform a fully implicit vertical diffusion of momentum. Stress top and bottom boundary conditions ar...">vertvisc()</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>Zonal velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>Meridional velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Structure containing forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Viscosities and bottom drag</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment in s</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>Open boundary condition structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l00534">534</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__vert__friction_8F90_source.html#l00981">find_coupling_coef()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00049">mom_open_boundary::obc_direction_n</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00050">mom_open_boundary::obc_direction_s</a>, and <a class="el" href="MOM__open__boundary_8F90_source.html#l00052">mom_open_boundary::obc_direction_w</a>.</p>
<div class="fragment"><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span>      :: g<span class="comment">      !&lt; Ocean grid structure</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>, &amp;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(GV))</span> :: u<span class="comment">      !&lt; Zonal velocity in m s-1</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>, &amp;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(GV))</span> :: v<span class="comment">      !&lt; Meridional velocity in m s-1</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>, &amp;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>  :: h<span class="comment">      !&lt; Layer thickness in H</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">type</span>(forcing), <span class="keywordtype">intent(in)</span>              :: fluxes<span class="comment"> !&lt; Structure containing forcing fields</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type), <span class="keywordtype">intent(in)</span>        :: visc<span class="comment">   !&lt; Viscosities and bottom drag</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>                       :: dt<span class="comment">     !&lt; Time increment in s</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs), <span class="keywordtype">pointer</span>             :: cs<span class="comment">     !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),  <span class="keywordtype">pointer</span>         :: obc<span class="comment">    !&lt; Open boundary condition structure</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="comment">! Field from fluxes used in this subroutine:</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="comment">!   ustar: the friction velocity in m s-1, used here as the mixing</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="comment">!     velocity in the mixed layer if NKML &gt; 1 in a bulk mixed layer.</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    h_harm, &amp;   <span class="comment">! Harmonic mean of the thicknesses around a velocity grid point,</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                <span class="comment">! given by 2*(h+ * h-)/(h+ + h-), in m or kg m-2 (H for short).</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    h_arith, &amp;  <span class="comment">! The arithmetic mean thickness, in m or kg m-2.</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    hvel, &amp;     <span class="comment">! hvel is the thickness used at a velocity grid point, in H.</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    hvel_shelf  <span class="comment">! The equivalent of hvel under shelves, in H.</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    a, &amp;        <span class="comment">! The drag coefficients across interfaces, in m s-1.  a times</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                <span class="comment">! the velocity difference gives the stress across an interface.</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    a_shelf, &amp;  <span class="comment">! The drag coefficients across interfaces in water columns under</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                <span class="comment">! ice shelves, in m s-1.</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    z_i         <span class="comment">! An estimate of each interface&#39;s height above the bottom,</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <span class="comment">! normalized by the bottom boundary layer thickness, nondim.</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    kv_bbl, &amp;     <span class="comment">! The bottom boundary layer viscosity in m2 s-1.</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    bbl_thick, &amp;  <span class="comment">! The bottom boundary layer thickness in m or kg m-2.</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    i_hbbl, &amp;     <span class="comment">! The inverse of the bottom boundary layer thickness, in units</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                  <span class="comment">! of H-1 (i.e., m-1 or m2 kg-1).</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    i_htbl, &amp;     <span class="comment">! The inverse of the top boundary layer thickness, in units</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                  <span class="comment">! of H-1 (i.e., m-1 or m2 kg-1).</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    zcol1, &amp;      <span class="comment">! The height of the interfaces to the north and south of a</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    zcol2, &amp;      <span class="comment">! v-point, in m or kg m-2.</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    ztop_min, &amp;   <span class="comment">! The deeper of the two adjacent surface heights, in H.</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    dmin, &amp;       <span class="comment">! The shallower of the two adjacent bottom depths converted to</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                  <span class="comment">! thickness units, in m or kg m-2.</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    zh, &amp;         <span class="comment">! An estimate of the interface&#39;s distance from the bottom</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                  <span class="comment">! based on harmonic mean thicknesses, in m or kg m-2.</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    h_ml          <span class="comment">! The mixed layer depth, in m or kg m-2.</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">dimension(:,:)</span> :: hml_u, hml_v</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordtype">real</span> :: zcol(szi_(g)) <span class="comment">! The height of an interface at h-points, in m or kg m-2.</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordtype">real</span> :: botfn   <span class="comment">! A function which goes from 1 at the bottom to 0 much more</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                  <span class="comment">! than Hbbl into the interior.</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordtype">real</span> :: topfn   <span class="comment">! A function which goes from 1 at the top to 0 much more</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                  <span class="comment">! than Htbl into the interior.</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordtype">real</span> :: z2      <span class="comment">! The distance from the bottom, normalized by Hbbl, nondim.</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordtype">real</span> :: z2_wt   <span class="comment">! A nondimensional (0-1) weight used when calculating z2.</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">real</span> :: z_clear <span class="comment">! The clearance of an interface above the surrounding topography, in H.</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">real</span> :: h_neglect     <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                        <span class="comment">! in roundoff and can be neglected, in H.</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  <span class="keywordtype">real</span> :: h_to_m, m_to_h <span class="comment">! Unit conversion factors.</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keywordtype">real</span> :: i_valbl <span class="comment">! The inverse of a scaling factor determining when water is</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                  <span class="comment">! still within the boundary layer, as determined by the sum</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                  <span class="comment">! of the harmonic mean thicknesses.</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: do_i, do_i_shelf</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordtype">logical</span> :: do_any_shelf</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZIB_(G))</span> :: &amp;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    zi_dir   <span class="comment">!  A trinary logical array indicating which thicknesses to use for</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;             <span class="comment">!  finding z_clear.</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB ; nz = g%ke</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;MOM_vert_friction(coef): &quot;</span>// &amp;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;  h_to_m = gv%H_to_m ; m_to_h = gv%m_to_H</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  i_hbbl(:) = 1.0 / (cs%Hbbl * gv%m_to_H + h_neglect)</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;  i_valbl = 0.0 ; <span class="keywordflow">if</span> (cs%harm_BL_val &gt; 0.0) i_valbl = 1.0 / cs%harm_BL_val</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keywordflow">if</span> (cs%debug .or. (cs%id_hML_u &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keyword">allocate</span>(hml_u(g%IsdB:g%IedB,g%jsd:g%jed)) ; hml_u(:,:) = 0.0</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="keywordflow">if</span> (cs%debug .or. (cs%id_hML_v &gt; 0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keyword">allocate</span>(hml_v(g%isd:g%ied,g%JsdB:g%JedB)) ; hml_v(:,:) = 0.0</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keywordflow">if</span> ((<span class="keyword">associated</span>(visc%taux_shelf) .or. <span class="keyword">associated</span>(fluxes%frac_shelf_u)) .and. &amp;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      .not.<span class="keyword">associated</span>(cs%a1_shelf_u)) <span class="keywordflow">then</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keyword">allocate</span>(cs%a1_shelf_u(g%IsdB:g%IedB,g%jsd:g%jed)) ; cs%a1_shelf_u(:,:)=0.0</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  <span class="keywordflow">if</span> ((<span class="keyword">associated</span>(visc%tauy_shelf) .or. <span class="keyword">associated</span>(fluxes%frac_shelf_u)) .and. &amp;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      .not.<span class="keyword">associated</span>(cs%a1_shelf_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keyword">allocate</span>(cs%a1_shelf_v(g%isd:g%ied,g%JsdB:g%JedB)) ; cs%a1_shelf_v(:,:)=0.0</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,CS,visc,Isq,ieq,nz,u,h,fluxes,hML_u, &amp;</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="comment">!$OMP                                  OBC,h_neglect,dt,m_to_H,I_valBL) &amp;</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">!$OMP                     firstprivate(i_hbbl)                                             &amp;</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="comment">!$OMP                          private(do_i,kv_bbl,bbl_thick,z_i,h_harm,h_arith,hvel,z2,   &amp;</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">!$OMP                                  botfn,zh,Dmin,zcol,a,do_any_shelf,do_i_shelf,zi_dir, &amp;</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">!$OMP                                  a_shelf,Ztop_min,I_HTbl,hvel_shelf,topfn,h_ml,z2_wt,z_clear)</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keywordflow">do</span> j=g%Jsc,g%Jec</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq ; do_i(i) = (g%mask2dCu(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="keywordflow">if</span> (cs%bottomdraglaw) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;      kv_bbl(i) = visc%kv_bbl_u(i,j)</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;      bbl_thick(i) = visc%bbl_thick_u(i,j) * m_to_h</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;      <span class="keywordflow">if</span> (do_i(i)) i_hbbl(i) = 1.0 / (bbl_thick(i) + h_neglect)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      h_harm(i,k) = 2.0*h(i,j,k)*h(i+1,j,k) / (h(i,j,k)+h(i+1,j,k)+h_neglect)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      h_arith(i,k) = 0.5*(h(i+1,j,k)+h(i,j,k))</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;      dmin(i) = min(g%bathyT(i,j), g%bathyT(i+1,j)) * m_to_h</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      zi_dir(i) = 0</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    <span class="comment">! Project thickness outward across OBCs using a zero-gradient condition.</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%number_of_segments &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_u(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_e) <span class="keywordflow">then</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; h_harm(i,k) = h(i,j,k) ; h_arith(i,k) = h(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;          dmin(i) = g%bathyT(i,j) * m_to_h</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;          zi_dir(i) = -1</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keywordflow">elseif</span> (obc%segment(obc%segnum_u(i,j))%direction == obc_direction_w) <span class="keywordflow">then</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; h_harm(i,k) = h(i+1,j,k) ; h_arith(i,k) = h(i+1,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;          dmin(i) = g%bathyT(i+1,j) * m_to_h</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;          zi_dir(i) = 1</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">!    The following block calculates the thicknesses at velocity</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="comment">!  grid points for the vertical viscosity (hvel[k]).  Near the</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">!  bottom an upwind biased thickness is used to control the effect</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">!  of spurious Montgomery potential gradients at the bottom where</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="comment">!  nearly massless layers layers ride over the topography.</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">if</span> (cs%harmonic_visc) <span class="keywordflow">then</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; z_i(i,nz+1) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;      <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        hvel(i,k) = h_harm(i,k)</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="keywordflow">if</span> (u(i,j,k) * (h(i+1,j,k)-h(i,j,k)) &lt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;          z2 = z_i(i,k+1) ; botfn = 1.0 / (1.0 + 0.09*z2*z2*z2*z2*z2*z2)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;          hvel(i,k) = (1.0-botfn)*h_harm(i,k) + botfn*h_arith(i,k)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        z_i(i,k) =  z_i(i,k+1) + h_harm(i,k)*i_hbbl(i)</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! Not harmonic_visc</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; zh(i) = 0.0 ; z_i(i,nz+1) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq+1 ; zcol(i) = -g%bathyT(i,j) * m_to_h ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;      <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        <span class="keywordflow">do</span> i=isq,ieq+1 ; zcol(i) = zcol(i) + h(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;          zh(i) = zh(i) + h_harm(i,k)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;          z_clear = max(zcol(i),zcol(i+1)) + dmin(i)</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;          <span class="keywordflow">if</span> (zi_dir(i) &lt; 0) z_clear = zcol(i) + dmin(i)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;          <span class="keywordflow">if</span> (zi_dir(i) &gt; 0) z_clear = zcol(i+1) + dmin(i)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;          z_i(i,k) = max(zh(i), z_clear) * i_hbbl(i)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;          hvel(i,k) = h_arith(i,k)</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;          <span class="keywordflow">if</span> (u(i,j,k) * (h(i+1,j,k)-h(i,j,k)) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            <span class="keywordflow">if</span> (zh(i) * i_hbbl(i) &lt; cs%harm_BL_val) <span class="keywordflow">then</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;              hvel(i,k) = h_harm(i,k)</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;              z2_wt = 1.0  ; <span class="keywordflow">if</span> (zh(i) * i_hbbl(i) &lt; 2.0*cs%harm_BL_val) &amp;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                z2_wt = max(0.0, min(1.0, zh(i) * i_hbbl(i) * i_valbl - 1.0))</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;              z2 = z2_wt * (max(zh(i), z_clear) * i_hbbl(i))</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;              botfn = 1.0 / (1.0 + 0.09*z2*z2*z2*z2*z2*z2)</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;              hvel(i,k) = (1.0-botfn)*h_arith(i,k) + botfn*h_harm(i,k)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i  loop</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! k loop</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keyword">call </span>find_coupling_coef(a, hvel, do_i, h_harm, bbl_thick, kv_bbl, z_i, h_ml, &amp;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                            dt, j, g, gv, cs, visc, fluxes, work_on_u=.true., obc=obc)</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(hml_u)) <span class="keywordflow">then</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span> ; hml_u(i,j) = h_ml(i) ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    do_any_shelf = .false.</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%frac_shelf_u)) <span class="keywordflow">then</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        cs%a1_shelf_u(i,j) = 0.0</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        do_i_shelf(i) = (do_i(i) .and. fluxes%frac_shelf_u(i,j) &gt; 0.0)</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="keywordflow">if</span> (do_i_shelf(i)) do_any_shelf = .true.</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;      <span class="keywordflow">if</span> (do_any_shelf) <span class="keywordflow">then</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="keywordflow">if</span> (cs%harmonic_visc) <span class="keywordflow">then</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;          <span class="keyword">call </span>find_coupling_coef(a_shelf, hvel, do_i_shelf, h_harm, bbl_thick, &amp;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                                  kv_bbl, z_i, h_ml, dt, j, g, gv, cs, &amp;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                                  visc, fluxes, work_on_u=.true., obc=obc, shelf=.true.)</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">else</span>  <span class="comment">! Find upwind-biased thickness near the surface.</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;          <span class="comment">! Perhaps this needs to be done more carefully, via find_eta.</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            zh(i) = 0.0 ; ztop_min(i) = min(zcol(i), zcol(i+1))</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            i_htbl(i) = 1.0 / (visc%tbl_thick_shelf_u(i,j)*m_to_h + h_neglect)</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            <span class="keywordflow">do</span> i=isq,ieq+1 ; zcol(i) = zcol(i) - h(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;              zh(i) = zh(i) + h_harm(i,k)</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;              hvel_shelf(i,k) = hvel(i,k)</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;              <span class="keywordflow">if</span> (u(i,j,k) * (h(i+1,j,k)-h(i,j,k)) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                <span class="keywordflow">if</span> (zh(i) * i_htbl(i) &lt; cs%harm_BL_val) <span class="keywordflow">then</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                  hvel_shelf(i,k) = min(hvel(i,k), h_harm(i,k))</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                  z2_wt = 1.0  ; <span class="keywordflow">if</span> (zh(i) * i_htbl(i) &lt; 2.0*cs%harm_BL_val) &amp;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                    z2_wt = max(0.0, min(1.0, zh(i) * i_htbl(i) * i_valbl - 1.0))</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                  z2 = z2_wt * (max(zh(i), ztop_min(i) - min(zcol(i),zcol(i+1))) * i_htbl(i))</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                  topfn = 1.0 / (1.0 + 0.09*z2**6)</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                  hvel_shelf(i,k) = min(hvel(i,k), (1.0-topfn)*h_arith(i,k) + topfn*h_harm(i,k))</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          <span class="keyword">call </span>find_coupling_coef(a_shelf, hvel_shelf, do_i_shelf, h_harm, &amp;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                                  bbl_thick, kv_bbl, z_i, h_ml, dt, j, g, gv, cs, &amp;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                                  visc, fluxes, work_on_u=.true., obc=obc, shelf=.true.)</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i_shelf(i)) cs%a1_shelf_u(i,j) = a_shelf(i,1) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keywordflow">if</span> (do_any_shelf) <span class="keywordflow">then</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        cs%a_u(i,j,k) = fluxes%frac_shelf_u(i,j)  * a_shelf(i,k) + &amp;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                   (1.0-fluxes%frac_shelf_u(i,j)) * a(i,k)</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">! This is Alistair&#39;s suggestion, but it destabilizes the model. I do not know why. RWH</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment">!        CS%a_u(I,j,K) = fluxes%frac_shelf_u(I,j)  * max(a_shelf(I,K), a(I,K)) + &amp;</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="comment">!                   (1.0-fluxes%frac_shelf_u(I,j)) * a(I,K)</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <span class="keywordflow">elseif</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        cs%a_u(i,j,k) = a(i,k)</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="comment">! Should we instead take the inverse of the average of the inverses?</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        cs%h_u(i,j,k) = fluxes%frac_shelf_u(i,j)  * hvel_shelf(i,k) + &amp;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                   (1.0-fluxes%frac_shelf_u(i,j)) * hvel(i,k)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;      <span class="keywordflow">elseif</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        cs%h_u(i,j,k) = hvel(i,k)</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) cs%a_u(i,j,k) = a(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) cs%h_u(i,j,k) = hvel(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <span class="comment">! Now work on v-points.</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,CS,visc,is,ie,Jsq,Jeq,nz,v,h,fluxes,hML_v, &amp;</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="comment">!$OMP                                  OBC,h_neglect,dt,m_to_H,I_valBL) &amp;</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="comment">!$OMP                     firstprivate(i_hbbl)                                                &amp;</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">!$OMP                          private(do_i,kv_bbl,bbl_thick,z_i,h_harm,h_arith,hvel,z2,zi_dir, &amp;</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">!$OMP                                  botfn,zh,Dmin,zcol1,zcol2,a,do_any_shelf,do_i_shelf,  &amp;</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment">!$OMP                                  a_shelf,Ztop_min,I_HTbl,hvel_shelf,topfn,h_ml,z2_wt,z_clear)</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="keywordflow">do</span> j=jsq,jeq</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; do_i(i) = (g%mask2dCv(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">if</span> (cs%bottomdraglaw) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;      kv_bbl(i) = visc%kv_bbl_v(i,j)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      bbl_thick(i) = visc%bbl_thick_v(i,j) * m_to_h</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;      <span class="keywordflow">if</span> (do_i(i)) i_hbbl(i) = 1.0 / bbl_thick(i)</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;      h_harm(i,k) = 2.0*h(i,j,k)*h(i,j+1,k) / (h(i,j,k)+h(i,j+1,k)+h_neglect)</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      h_arith(i,k) = 0.5*(h(i,j+1,k)+h(i,j,k))</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      dmin(i) = min(g%bathyT(i,j), g%bathyT(i,j+1)) * m_to_h</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      zi_dir(i) = 0</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">! Project thickness outward across OBCs using a zero-gradient condition.</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%number_of_segments &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i) .and. (obc%segnum_v(i,j) /= obc_none)) <span class="keywordflow">then</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        <span class="keywordflow">if</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_n) <span class="keywordflow">then</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; h_harm(i,k) = h(i,j,k) ; h_arith(i,k) = h(i,j,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;          dmin(i) = g%bathyT(i,j) * m_to_h</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;          zi_dir(i) = -1</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;        <span class="keywordflow">elseif</span> (obc%segment(obc%segnum_v(i,j))%direction == obc_direction_s) <span class="keywordflow">then</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;          <span class="keywordflow">do</span> k=1,nz ; h_harm(i,k) = h(i,j+1,k) ; h_arith(i,k) = h(i,j+1,k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;          dmin(i) = g%bathyT(i,j+1) * m_to_h</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;          zi_dir(i) = 1</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">!    The following block calculates the thicknesses at velocity</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">!  grid points for the vertical viscosity (hvel[k]).  Near the</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">!  bottom an upwind biased thickness is used to control the effect</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">!  of spurious Montgomery potential gradients at the bottom where</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">!  nearly massless layers layers ride over the topography.</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> (cs%harmonic_visc) <span class="keywordflow">then</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; z_i(i,nz+1) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        hvel(i,k) = h_harm(i,k)</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        <span class="keywordflow">if</span> (v(i,j,k) * (h(i,j+1,k)-h(i,j,k)) &lt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;          z2 = z_i(i,k+1) ; botfn = 1.0 / (1.0 + 0.09*z2*z2*z2*z2*z2*z2)</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;          hvel(i,k) = (1.0-botfn)*h_harm(i,k) + botfn*h_arith(i,k)</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        z_i(i,k) = z_i(i,k+1)  + h_harm(i,k)*i_hbbl(i)</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! Not harmonic_visc</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        zh(i) = 0.0 ; z_i(i,nz+1) = 0.0</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        zcol1(i) = -g%bathyT(i,j) * m_to_h</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        zcol2(i) = -g%bathyT(i,j+1) * m_to_h</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;      <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        zh(i) = zh(i) + h_harm(i,k)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        zcol1(i) = zcol1(i) + h(i,j,k) ; zcol2(i) = zcol2(i) + h(i,j+1,k)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        z_clear = max(zcol1(i),zcol2(i)) + dmin(i)</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">if</span> (zi_dir(i) &lt; 0) z_clear = zcol1(i) + dmin(i)</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        <span class="keywordflow">if</span> (zi_dir(i) &gt; 0) z_clear = zcol2(i) + dmin(i)</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        z_i(i,k) = max(zh(i), z_clear) * i_hbbl(i)</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        hvel(i,k) = h_arith(i,k)</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        <span class="keywordflow">if</span> (v(i,j,k) * (h(i,j+1,k)-h(i,j,k)) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;          <span class="keywordflow">if</span> (zh(i) * i_hbbl(i) &lt; cs%harm_BL_val) <span class="keywordflow">then</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            hvel(i,k) = h_harm(i,k)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;            z2_wt = 1.0  ; <span class="keywordflow">if</span> (zh(i) * i_hbbl(i) &lt; 2.0*cs%harm_BL_val) &amp;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;              z2_wt = max(0.0, min(1.0, zh(i) * i_hbbl(i) * i_valbl - 1.0))</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;            z2 = z2_wt * (max(zh(i), max(zcol1(i),zcol2(i)) + dmin(i)) * i_hbbl(i))</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;            botfn = 1.0 / (1.0 + 0.09*z2*z2*z2*z2*z2*z2)</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;            hvel(i,k) = (1.0-botfn)*h_arith(i,k) + botfn*h_harm(i,k)</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordflow">       endif</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i &amp; k loops</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keyword">call </span>find_coupling_coef(a, hvel, do_i, h_harm, bbl_thick, kv_bbl, z_i, h_ml, &amp;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                            dt, j, g, gv, cs, visc, fluxes, work_on_u=.false., obc=obc)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="keywordflow">if</span> ( <span class="keyword">allocated</span>(hml_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;       <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span> ; hml_v(i,j) = h_ml(i) ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    do_any_shelf = .false.</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(fluxes%frac_shelf_v)) <span class="keywordflow">then</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        cs%a1_shelf_v(i,j) = 0.0</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        do_i_shelf(i) = (do_i(i) .and. fluxes%frac_shelf_v(i,j) &gt; 0.0)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordflow">if</span> (do_i_shelf(i)) do_any_shelf = .true.</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;      <span class="keywordflow">if</span> (do_any_shelf) <span class="keywordflow">then</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keywordflow">if</span> (cs%harmonic_visc) <span class="keywordflow">then</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;          <span class="keyword">call </span>find_coupling_coef(a_shelf, hvel, do_i_shelf, h_harm, bbl_thick, &amp;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                                  kv_bbl, z_i, h_ml, dt, j, g, gv, cs, visc, &amp;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                                  fluxes, work_on_u=.false., obc=obc, shelf=.true.)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        <span class="keywordflow">else</span>  <span class="comment">! Find upwind-biased thickness near the surface.</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;          <span class="comment">! Perhaps this needs to be done more carefully, via find_eta.</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;          <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;            zh(i) = 0.0 ; ztop_min(i) = min(zcol1(i), zcol2(i))</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            i_htbl(i) = 1.0 / (visc%tbl_thick_shelf_v(i,j)*m_to_h + h_neglect)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;          <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;            <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;              zcol1(i) = zcol1(i) - h(i,j,k) ; zcol2(i) = zcol2(i) - h(i,j+1,k)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;              zh(i) = zh(i) + h_harm(i,k)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;              hvel_shelf(i,k) = hvel(i,k)</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;              <span class="keywordflow">if</span> (v(i,j,k) * (h(i,j+1,k)-h(i,j,k)) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                <span class="keywordflow">if</span> (zh(i) * i_htbl(i) &lt; cs%harm_BL_val) <span class="keywordflow">then</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                  hvel_shelf(i,k) = min(hvel(i,k), h_harm(i,k))</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                  z2_wt = 1.0  ; <span class="keywordflow">if</span> (zh(i) * i_htbl(i) &lt; 2.0*cs%harm_BL_val) &amp;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                    z2_wt = max(0.0, min(1.0, zh(i) * i_htbl(i) * i_valbl - 1.0))</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                  z2 = z2_wt * (max(zh(i), ztop_min(i) - min(zcol1(i),zcol2(i))) * i_htbl(i))</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                  topfn = 1.0 / (1.0 + 0.09*z2**6)</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                  hvel_shelf(i,k) = min(hvel(i,k), (1.0-topfn)*h_arith(i,k) + topfn*h_harm(i,k))</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="keywordflow">             endif</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;          <span class="keyword">call </span>find_coupling_coef(a_shelf, hvel_shelf, do_i_shelf, h_harm, &amp;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                                  bbl_thick, kv_bbl, z_i, h_ml, dt, j, g, gv, cs, &amp;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                                  visc, fluxes, work_on_u=.false., obc=obc, shelf=.true.)</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i_shelf(i)) cs%a1_shelf_v(i,j) = a_shelf(i,1) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="keywordflow">if</span> (do_any_shelf) <span class="keywordflow">then</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        cs%a_v(i,j,k) = fluxes%frac_shelf_v(i,j)  * a_shelf(i,k) + &amp;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                   (1.0-fluxes%frac_shelf_v(i,j)) * a(i,k)</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="comment">! This is Alistair&#39;s suggestion, but it destabilizes the model. I do not know why. RWH</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment">!        CS%a_v(i,J,K) = fluxes%frac_shelf_v(i,J)  * max(a_shelf(i,K), a(i,K)) + &amp;</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="comment">!                   (1.0-fluxes%frac_shelf_v(i,J)) * a(i,K)</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;      <span class="keywordflow">elseif</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        cs%a_v(i,j,k) = a(i,k)</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i_shelf(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="comment">! Should we instead take the inverse of the average of the inverses?</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        cs%h_v(i,j,k) = fluxes%frac_shelf_v(i,j)  * hvel_shelf(i,k) + &amp;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                   (1.0-fluxes%frac_shelf_v(i,j)) * hvel(i,k)</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;      <span class="keywordflow">elseif</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        cs%h_v(i,j,k) = hvel(i,k)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) cs%a_v(i,j,k) = a(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) cs%h_v(i,j,k) = hvel(i,k) ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of v-point j loop</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;vertvisc_coef h_[uv]&quot;</span>, cs%h_u, &amp;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                  cs%h_v, g%HI,haloshift=0, scale=gv%H_to_m)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;vertvisc_coef a_[uv]&quot;</span>, cs%a_u, &amp;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                  cs%a_v, g%HI, haloshift=0)</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(hml_u) .and. <span class="keyword">allocated</span>(hml_v)) &amp;</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;vertvisc_coef hML_[uv]&quot;</span>, hml_u, hml_v, &amp;</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                    g%HI, haloshift=0, scale=gv%H_to_m)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment">! Offer diagnostic fields for averaging.</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  <span class="keywordflow">if</span> (cs%id_au_vv &gt; 0) <span class="keyword">call </span>post_data(cs%id_au_vv, cs%a_u, cs%diag)</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  <span class="keywordflow">if</span> (cs%id_av_vv &gt; 0) <span class="keyword">call </span>post_data(cs%id_av_vv, cs%a_v, cs%diag)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  <span class="keywordflow">if</span> (cs%id_h_u &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_u, cs%h_u, cs%diag)</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="keywordflow">if</span> (cs%id_h_v &gt; 0) <span class="keyword">call </span>post_data(cs%id_h_v, cs%h_v, cs%diag)</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <span class="keywordflow">if</span> (cs%id_hML_u &gt; 0) <span class="keyword">call </span>post_data(cs%id_hML_u, hml_u, cs%diag)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="keywordflow">if</span> (cs%id_hML_v &gt; 0) <span class="keyword">call </span>post_data(cs%id_hML_v, hml_v, cs%diag)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(hml_u)) <span class="keyword">deallocate</span>(hml_u)</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(hml_v)) <span class="keyword">deallocate</span>(hml_v)</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_a5c29ca42705b12654f06005afb84fdfa_cgraph.svg" width="524" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a158d29cf5c1d79ca7c5f327706855972"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a158d29cf5c1d79ca7c5f327706855972">&#9670;&nbsp;</a></span>vertvisc_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clean up and deallocate the vertical friction module. </p>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l01675">1675</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs),   <span class="keywordtype">pointer</span>       :: cs</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;  dealloc_(cs%a_u) ; dealloc_(cs%h_u)</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;  dealloc_(cs%a_v) ; dealloc_(cs%h_v)</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%a1_shelf_u)) <span class="keyword">deallocate</span>(cs%a1_shelf_u)</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%a1_shelf_v)) <span class="keyword">deallocate</span>(cs%a1_shelf_v)</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;  <span class="keyword">deallocate</span>(cs)</div></div><!-- fragment -->
</div>
</div>
<a id="a02be81324ab60dcbcf3c1ecf3aa0da17"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a02be81324ab60dcbcf3c1ecf3aa0da17">&#9670;&nbsp;</a></span>vertvisc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc_init </td>
          <td>(</td>
          <td class="paramtype">type(ocean_internal_state), intent(in), target&#160;</td>
          <td class="paramname"><em>MIS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(accel_diag_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>ADp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(directories), intent(in)&#160;</td>
          <td class="paramname"><em>dirs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout), target&#160;</td>
          <td class="paramname"><em>ntrunc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialise the vertical friction module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">mis</td><td>"MOM Internal State", a set of pointers to the fields and accelerations that make up the ocean's physical state</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>Current model time</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>File to parse for parameters</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>Diagnostic control structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">adp</td><td>Acceleration diagnostic pointers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dirs</td><td>Relevant directory paths</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ntrunc</td><td>Number of velocity truncations</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l01458">1458</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;<span class="comment">  !&gt; &quot;MOM Internal State&quot;, a set of pointers to the fields and accelerations</span></div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="comment">  !! that make up the ocean&#39;s physical state</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  <span class="keywordtype">type</span>(ocean_internal_state), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span> :: mis</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: time<span class="comment">       !&lt; Current model time</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">          !&lt; Ocean grid structure</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">         !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; File to parse for parameters</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">       !&lt; Diagnostic control structure</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordtype">type</span>(accel_diag_ptrs),   <span class="keywordtype">intent(inout)</span> :: adp<span class="comment">        !&lt; Acceleration diagnostic pointers</span></div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  <span class="keywordtype">type</span>(directories),       <span class="keywordtype">intent(in)</span>    :: dirs<span class="comment">       !&lt; Relevant directory paths</span></div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>,         <span class="keywordtype">intent(inout)</span> :: ntrunc<span class="comment">     !&lt; Number of velocity truncations</span></div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs),       <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordtype">real</span> :: hmix_str_dflt</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, isdb, iedb, jsdb, jedb, nz</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_vert_friction&quot;</span> <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: thickness_units = <span class="stringliteral">&quot;meters or kg m-2&quot;</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;vertvisc_init called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                            <span class="stringliteral">&quot;control structure.&quot;</span>)</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed ; nz = g%ke</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  cs%diag =&gt; diag ; cs%ntrunc =&gt; ntrunc ; ntrunc = 0</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">! Default, read and log parameters</span></div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOTTOMDRAGLAW&quot;</span>, cs%bottomdraglaw, &amp;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                 <span class="stringliteral">&quot;If true, the bottom stress is calculated with a drag \n&quot;</span>//&amp;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                 <span class="stringliteral">&quot;law of the form c_drag*|u|*u. The velocity magnitude \n&quot;</span>//&amp;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                 <span class="stringliteral">&quot;may be an assumed value or it may be based on the \n&quot;</span>//&amp;</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                 <span class="stringliteral">&quot;actual velocity in the bottommost HBBL, depending on \n&quot;</span>//&amp;</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                 <span class="stringliteral">&quot;LINEAR_DRAG.&quot;</span>, default=.true.)</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CHANNEL_DRAG&quot;</span>, cs%Channel_drag, &amp;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                 <span class="stringliteral">&quot;If true, the bottom drag is exerted directly on each \n&quot;</span>//&amp;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;                 <span class="stringliteral">&quot;layer proportional to the fraction of the bottom it \n&quot;</span>//&amp;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;                 <span class="stringliteral">&quot;overlies.&quot;</span>, default=.false.)</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DIRECT_STRESS&quot;</span>, cs%direct_stress, &amp;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;                 <span class="stringliteral">&quot;If true, the wind stress is distributed over the \n&quot;</span>//&amp;</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;                 <span class="stringliteral">&quot;topmost HMIX_STRESS of fluid (like in HYCOM), and KVML \n&quot;</span>//&amp;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;                 <span class="stringliteral">&quot;may be set to a very small value.&quot;</span>, default=.false.)</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DYNAMIC_VISCOUS_ML&quot;</span>, cs%dynamic_viscous_ML, &amp;</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                 <span class="stringliteral">&quot;If true, use a bulk Richardson number criterion to \n&quot;</span>//&amp;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                 <span class="stringliteral">&quot;determine the mixed layer thickness for viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                 default=.false.)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;U_TRUNC_FILE&quot;</span>, cs%u_trunc_file, &amp;</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                 <span class="stringliteral">&quot;The absolute path to a file into which the accelerations \n&quot;</span>//&amp;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                 <span class="stringliteral">&quot;leading to zonal velocity truncations are written.  \n&quot;</span>//&amp;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                 <span class="stringliteral">&quot;Undefine this for efficiency if this diagnostic is not \n&quot;</span>//&amp;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;                 <span class="stringliteral">&quot;needed.&quot;</span>, default=<span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;V_TRUNC_FILE&quot;</span>, cs%v_trunc_file, &amp;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;                 <span class="stringliteral">&quot;The absolute path to a file into which the accelerations \n&quot;</span>//&amp;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                 <span class="stringliteral">&quot;leading to meridional velocity truncations are written. \n&quot;</span>//&amp;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                 <span class="stringliteral">&quot;Undefine this for efficiency if this diagnostic is not \n&quot;</span>//&amp;</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                 <span class="stringliteral">&quot;needed.&quot;</span>, default=<span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HARMONIC_VISC&quot;</span>, cs%harmonic_visc, &amp;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;                 <span class="stringliteral">&quot;If true, use the harmonic mean thicknesses for \n&quot;</span>//&amp;</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;                 <span class="stringliteral">&quot;calculating the vertical viscosity.&quot;</span>, default=.false.)</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HARMONIC_BL_SCALE&quot;</span>, cs%harm_BL_val, &amp;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;                 <span class="stringliteral">&quot;A scale to determine when water is in the boundary \n&quot;</span>//&amp;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                 <span class="stringliteral">&quot;layers based solely on harmonic mean thicknesses for \n&quot;</span>//&amp;</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;                 <span class="stringliteral">&quot;the purpose of determining the extent to which the \n&quot;</span>//&amp;</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                 <span class="stringliteral">&quot;thicknesses used in the viscosities are upwinded.&quot;</span>, &amp;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;                 default=0.0, units=<span class="stringliteral">&quot;nondim&quot;</span>)</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, default=.false.)</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="keywordflow">if</span> (gv%nkml &lt; 1) &amp;</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HMIX_FIXED&quot;</span>, cs%Hmix, &amp;</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;                 <span class="stringliteral">&quot;The prescribed depth over which the near-surface \n&quot;</span>//&amp;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;                 <span class="stringliteral">&quot;viscosity and diffusivity are elevated when the bulk \n&quot;</span>//&amp;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;                 <span class="stringliteral">&quot;mixed layer is not used.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="keywordflow">if</span> (cs%direct_stress) <span class="keywordflow">then</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    <span class="keywordflow">if</span> (gv%nkml &lt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HMIX_STRESS&quot;</span>, cs%Hmix_stress, &amp;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;                 <span class="stringliteral">&quot;The depth over which the wind stress is applied if \n&quot;</span>//&amp;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                 <span class="stringliteral">&quot;DIRECT_STRESS is true.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, default=cs%Hmix)</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HMIX_STRESS&quot;</span>, cs%Hmix_stress, &amp;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                 <span class="stringliteral">&quot;The depth over which the wind stress is applied if \n&quot;</span>//&amp;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                 <span class="stringliteral">&quot;DIRECT_STRESS is true.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;    <span class="keywordflow">if</span> (cs%Hmix_stress &lt;= 0.0) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;vertvisc_init: &quot;</span> // &amp;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;       <span class="stringliteral">&quot;HMIX_STRESS must be set to a positive value if DIRECT_STRESS is true.&quot;</span>)</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KV&quot;</span>, cs%Kv, &amp;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                 <span class="stringliteral">&quot;The background kinematic viscosity in the interior. \n&quot;</span>//&amp;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                 <span class="stringliteral">&quot;The molecular value, ~1e-6 m2 s-1, may be used.&quot;</span>, &amp;</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;<span class="comment">! CS%Kvml = CS%Kv ; CS%Kvbbl = CS%Kv ! Needed? -AJA</span></div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;  <span class="keywordflow">if</span> (gv%nkml &lt; 1) <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KVML&quot;</span>, cs%Kvml, &amp;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;                 <span class="stringliteral">&quot;The kinematic viscosity in the mixed layer.  A typical \n&quot;</span>//&amp;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;                 <span class="stringliteral">&quot;value is ~1e-2 m2 s-1. KVML is not used if \n&quot;</span>//&amp;</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;                 <span class="stringliteral">&quot;BULKMIXEDLAYER is true.  The default is set by KV.&quot;</span>, &amp;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=cs%Kv)</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;  <span class="keywordflow">if</span> (.not.cs%bottomdraglaw) <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KVBBL&quot;</span>, cs%Kvbbl, &amp;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;                 <span class="stringliteral">&quot;The kinematic viscosity in the benthic boundary layer. \n&quot;</span>//&amp;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                 <span class="stringliteral">&quot;A typical value is ~1e-2 m2 s-1. KVBBL is not used if \n&quot;</span>//&amp;</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                 <span class="stringliteral">&quot;BOTTOMDRAGLAW is true.  The default is set by KV.&quot;</span>, &amp;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=cs%Kv)</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HBBL&quot;</span>, cs%Hbbl, &amp;</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                 <span class="stringliteral">&quot;The thickness of a bottom boundary layer with a \n&quot;</span>//&amp;</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;                 <span class="stringliteral">&quot;viscosity of KVBBL if BOTTOMDRAGLAW is not defined, or \n&quot;</span>//&amp;</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;                 <span class="stringliteral">&quot;the thickness over which near-bottom velocities are \n&quot;</span>//&amp;</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                 <span class="stringliteral">&quot;averaged for the drag law if BOTTOMDRAGLAW is defined \n&quot;</span>//&amp;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                 <span class="stringliteral">&quot;but LINEAR_DRAG is not.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, fail_if_missing=.true.)</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXVEL&quot;</span>, cs%maxvel, &amp;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                 <span class="stringliteral">&quot;The maximum velocity allowed before the velocity \n&quot;</span>//&amp;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                 <span class="stringliteral">&quot;components are truncated.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=3.0e8)</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CFL_BASED_TRUNCATIONS&quot;</span>, cs%CFL_based_trunc, &amp;</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;                 <span class="stringliteral">&quot;If true, base truncations on the CFL number, and not an \n&quot;</span>//&amp;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;                 <span class="stringliteral">&quot;absolute speed.&quot;</span>, default=.true.)</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CFL_TRUNCATE&quot;</span>, cs%CFL_trunc, &amp;</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;                 <span class="stringliteral">&quot;The value of the CFL number that will cause velocity \n&quot;</span>//&amp;</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;                 <span class="stringliteral">&quot;components to be truncated; instability can occur past 0.5.&quot;</span>, &amp;</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.5)</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CFL_REPORT&quot;</span>, cs%CFL_report, &amp;</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                 <span class="stringliteral">&quot;The value of the CFL number that causes accelerations \n&quot;</span>//&amp;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;                 <span class="stringliteral">&quot;to be reported; the default is CFL_TRUNCATE.&quot;</span>, &amp;</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=cs%CFL_trunc)</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CFL_TRUNCATE_RAMP_TIME&quot;</span>, cs%truncRampTime, &amp;</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;                 <span class="stringliteral">&quot;The time over which the CFL trunction value is ramped\n&quot;</span>//&amp;</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                 <span class="stringliteral">&quot;up at the beginning of the run.&quot;</span>, &amp;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;                 units=<span class="stringliteral">&quot;s&quot;</span>, default=0.)</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;  cs%CFL_truncE = cs%CFL_trunc</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CFL_TRUNCATE_START&quot;</span>, cs%CFL_truncS, &amp;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;                 <span class="stringliteral">&quot;The start value of the truncation CFL number used when\n&quot;</span>//&amp;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;                 <span class="stringliteral">&quot;ramping up CFL_TRUNC.&quot;</span>, &amp;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.)</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;  alloc_(cs%a_u(isdb:iedb,jsd:jed,nz+1)) ; cs%a_u(:,:,:) = 0.0</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;  alloc_(cs%h_u(isdb:iedb,jsd:jed,nz))   ; cs%h_u(:,:,:) = 0.0</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;  alloc_(cs%a_v(isd:ied,jsdb:jedb,nz+1)) ; cs%a_v(:,:,:) = 0.0</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;  alloc_(cs%h_v(isd:ied,jsdb:jedb,nz))   ; cs%h_v(:,:,:) = 0.0</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;  cs%id_au_vv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;au_visc&#39;</span>, diag%axesCui, time, &amp;</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;     <span class="stringliteral">&#39;Zonal Viscous Vertical Coupling Coefficient&#39;</span>, <span class="stringliteral">&#39;meter second-1&#39;</span>)</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;  cs%id_av_vv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;av_visc&#39;</span>, diag%axesCvi, time, &amp;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;     <span class="stringliteral">&#39;Meridional Viscous Vertical Coupling Coefficient&#39;</span>, <span class="stringliteral">&#39;meter second-1&#39;</span>)</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;  cs%id_h_u = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Hu_visc&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;     <span class="stringliteral">&#39;Thickness at Zonal Velocity Points for Viscosity&#39;</span>, thickness_units)</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;  cs%id_h_v = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Hv_visc&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;     <span class="stringliteral">&#39;Thickness at Meridional Velocity Points for Viscosity&#39;</span>, thickness_units)</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;  cs%id_hML_u = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;HMLu_visc&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;     <span class="stringliteral">&#39;Mixed Layer Thickness at Zonal Velocity Points for Viscosity&#39;</span>, thickness_units)</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;  cs%id_hML_v = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;HMLv_visc&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;     <span class="stringliteral">&#39;Mixed Layer Thickness at Meridional Velocity Points for Viscosity&#39;</span>, thickness_units)</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;  cs%id_du_dt_visc = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;du_dt_visc&#39;</span>, diag%axesCuL, &amp;</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;     time, <span class="stringliteral">&#39;Zonal Acceleration from Vertical Viscosity&#39;</span>, <span class="stringliteral">&#39;meter second-2&#39;</span>)</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;  <span class="keywordflow">if</span> (cs%id_du_dt_visc &gt; 0) <span class="keyword">call </span>safe_alloc_ptr(adp%du_dt_visc,isdb,iedb,jsd,jed,nz)</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;  cs%id_dv_dt_visc = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;dv_dt_visc&#39;</span>, diag%axesCvL, &amp;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;     time, <span class="stringliteral">&#39;Meridional Acceleration from Vertical Viscosity&#39;</span>, <span class="stringliteral">&#39;meter second-2&#39;</span>)</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;  <span class="keywordflow">if</span> (cs%id_dv_dt_visc &gt; 0) <span class="keyword">call </span>safe_alloc_ptr(adp%dv_dt_visc,isd,ied,jsdb,jedb,nz)</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;  cs%id_taux_bot = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;taux_bot&#39;</span>, diag%axesCu1, &amp;</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;     time, <span class="stringliteral">&#39;Zonal Bottom Stress from Ocean to Earth&#39;</span>, <span class="stringliteral">&#39;Pa&#39;</span>)</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;  cs%id_tauy_bot = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;tauy_bot&#39;</span>, diag%axesCv1, &amp;</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;     time, <span class="stringliteral">&#39;Meridional Bottom Stress from Ocean to Earth&#39;</span>, <span class="stringliteral">&#39;Pa&#39;</span>)</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;  <span class="keywordflow">if</span> ((len_trim(cs%u_trunc_file) &gt; 0) .or. (len_trim(cs%v_trunc_file) &gt; 0)) &amp;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    <span class="keyword">call </span>pointaccel_init(mis, time, g, param_file, diag, dirs, cs%PointAccel_CSp)</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_a02be81324ab60dcbcf3c1ecf3aa0da17_cgraph.svg" width="524" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a82bae17e9c3b1a5f1eedb6c1d14c5998"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82bae17e9c3b1a5f1eedb6c1d14c5998">&#9670;&nbsp;</a></span>vertvisc_limit_vel()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc_limit_vel </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, gv %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(accel_diag_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>ADp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(cont_diag_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>CDp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Velocity components which exceed a threshold for physically reasonable values are truncated. Optionally, any column with excessive velocities may be sent to a diagnostic reporting subroutine. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">u</td><td>Zonal velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">v</td><td>Meridional velocity in m s-1</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adp</td><td>Acceleration diagnostic pointers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cdp</td><td>Continuity diagnostic pointers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>Forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Viscosities and bottom drag</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment in s</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l01258">1258</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__vert__friction_8F90_source.html#l00140">vertvisc()</a>.</p>
<div class="fragment"><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">      !&lt; Ocean grid structure</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span>, &amp;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(GV))</span> :: u<span class="comment">      !&lt; Zonal velocity in m s-1</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span>, &amp;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(GV))</span> :: v<span class="comment">      !&lt; Meridional velocity in m s-1</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>, &amp;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>  :: h<span class="comment">      !&lt; Layer thickness in H</span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="keywordtype">type</span>(accel_diag_ptrs), <span class="keywordtype">intent(in)</span>      :: adp<span class="comment">    !&lt; Acceleration diagnostic pointers</span></div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  <span class="keywordtype">type</span>(cont_diag_ptrs),  <span class="keywordtype">intent(in)</span>      :: cdp<span class="comment">    !&lt; Continuity diagnostic pointers</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(in)</span>      :: fluxes<span class="comment"> !&lt; Forcing fields</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),   <span class="keywordtype">intent(in)</span>      :: visc<span class="comment">   !&lt; Viscosities and bottom drag</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span>      :: dt<span class="comment">     !&lt; Time increment in s</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs),     <span class="keywordtype">pointer</span>         :: cs<span class="comment">     !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;  <span class="keywordtype">real</span> :: maxvel           <span class="comment">! Velocities components greater than maxvel</span></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;  <span class="keywordtype">real</span> :: truncvel         <span class="comment">! are truncated to truncvel, both in m s-1.</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  <span class="keywordtype">real</span> :: cfl              <span class="comment">! The local CFL number.</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  <span class="keywordtype">real</span> :: h_report         <span class="comment">! A thickness below which not to report truncations.</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  <span class="keywordtype">real</span> :: dt_rho0          <span class="comment">! The timestep divided by the Boussinesq density, in dt m3 kg-1.</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  <span class="keywordtype">real</span> :: vel_report(szib_(g),szjb_(g))</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;  <span class="keywordtype">real</span> :: u_old(szib_(g),szj_(g),szk_(g))</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  <span class="keywordtype">real</span> :: v_old(szi_(g),szjb_(g),szk_(g))</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;  <span class="keywordtype">logical</span> :: trunc_any, dowrite(szib_(g),szjb_(g))</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  maxvel = cs%maxvel</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;  truncvel = 0.9*maxvel</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  h_report = 6.0 * gv%Angstrom</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;  dt_rho0 = dt / gv%Rho0</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  <span class="keywordflow">if</span> (len_trim(cs%u_trunc_file) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(js,je,Isq,Ieq,nz,CS,G,fluxes,u,h,dt,maxvel,ADp,CDp,truncvel, &amp;</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;<span class="comment">!$OMP                                  u_old,vel_report,dowrite,H_report) &amp;</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="comment">!$OMP                          private(trunc_any,CFL)</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;      trunc_any = .false.</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; dowrite(i,j) = .false. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;      <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        <span class="keywordflow">do</span> i=isq,ieq ; vel_report(i,j) = 3.0e8 ;<span class="keywordflow"> enddo</span> <span class="comment">! Speed of light default.</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;          <span class="keywordflow">if</span> (u(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            cfl = (-u(i,j,k) * dt) * (g%dy_Cu(i,j) * g%IareaT(i+1,j))</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            cfl = (u(i,j,k) * dt) * (g%dy_Cu(i,j) * g%IareaT(i,j))</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;          <span class="keywordflow">if</span> (cfl &gt; cs%CFL_trunc) trunc_any = .true.</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;          <span class="keywordflow">if</span> (cfl &gt; cs%CFL_report) <span class="keywordflow">then</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;            dowrite(i,j) = .true.</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            vel_report(i,j) = min(vel_report(i,j), abs(u(i,j,k)))</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        <span class="keywordflow">do</span> i=isq,ieq; vel_report(i,j) = maxvel;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (abs(u(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;          dowrite(i,j) = .true. ; trunc_any = .true.</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow">enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;      <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (dowrite(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        u_old(i,j,:) = u(i,j,:)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      <span class="keywordflow">if</span> (trunc_any) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;          <span class="keywordflow">if</span> ((u(i,j,k) * (dt * g%dy_Cu(i,j))) * g%IareaT(i+1,j) &lt; -cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;            u(i,j,k) = (-0.9*cs%CFL_trunc) * (g%areaT(i+1,j) / (dt * g%dy_Cu(i,j)))</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;          <span class="keywordflow">elseif</span> ((u(i,j,k) * (dt * g%dy_Cu(i,j))) * g%IareaT(i,j) &gt; cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;            u(i,j,k) = (0.9*cs%CFL_trunc) * (g%areaT(i,j) / (dt * g%dy_Cu(i,j)))</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (abs(u(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;          u(i,j,k) = sign(truncvel,u(i,j,k))</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! j-loop</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(nz,js,je,Isq,Ieq,u,dt,G,CS,h,H_report)</span></div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        <span class="keywordflow">if</span> ((u(i,j,k) * (dt * g%dy_Cu(i,j))) * g%IareaT(i+1,j) &lt; -cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;          u(i,j,k) = (-0.9*cs%CFL_trunc) * (g%areaT(i+1,j) / (dt * g%dy_Cu(i,j)))</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;        <span class="keywordflow">elseif</span> ((u(i,j,k) * (dt * g%dy_Cu(i,j))) * g%IareaT(i,j) &gt; cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;          u(i,j,k) = (0.9*cs%CFL_trunc) * (g%areaT(i,j) / (dt * g%dy_Cu(i,j)))</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(nz,js,je,Isq,Ieq,u,G,CS,truncvel,maxvel,h,H_report)</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (abs(u(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        u(i,j,k) = sign(truncvel,u(i,j,k))</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        <span class="keywordflow">if</span> (h(i,j,k) + h(i+1,j,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  <span class="keywordflow">if</span> (len_trim(cs%u_trunc_file) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <span class="keywordflow">do</span> j=js,je; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (dowrite(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;<span class="comment">!   Here the diagnostic reporting subroutines are called if</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;<span class="comment">! unphysically large values were found.</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;      <span class="keyword">call </span>write_u_accel(i, j, u_old, h, adp, cdp, dt, g, gv, cs%PointAccel_CSp, &amp;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;               vel_report(i,j), -vel_report(i,j), fluxes%taux(i,j)*dt_rho0, &amp;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;               a=cs%a_u(:,j,:), hv=cs%h_u(:,j,:))</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="keywordflow">    endif</span> ; enddo;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  <span class="keywordflow">if</span> (len_trim(cs%v_trunc_file) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(Jsq,Jeq,is,ie,nz,CS,G,fluxes,v,h,dt,maxvel,ADp,CDp,truncvel, &amp;</span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="comment">!$OMP                                  v_old,vel_report,dowrite,H_report)                           &amp;</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="comment">!$OMP                          private(trunc_any,CFL)</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;      trunc_any = .false.</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; dowrite(i,j) = .false. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;      <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; vel_report(i,j) = 3.0e8 ;<span class="keywordflow"> enddo</span> <span class="comment">! Speed of light default.</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;          <span class="keywordflow">if</span> (v(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            cfl = (-v(i,j,k) * dt) * (g%dx_Cv(i,j) * g%IareaT(i,j+1))</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            cfl = (v(i,j,k) * dt) * (g%dx_Cv(i,j) * g%IareaT(i,j))</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;          <span class="keywordflow">if</span> (cfl &gt; cs%CFL_trunc) trunc_any = .true.</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;          <span class="keywordflow">if</span> (cfl &gt; cs%CFL_report) <span class="keywordflow">then</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;            dowrite(i,j) = .true.</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            vel_report(i,j) = min(vel_report(i,j), abs(v(i,j,k)))</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        <span class="keywordflow">do</span> i=is,ie ; vel_report(i,j) = maxvel ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (abs(v(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;          dowrite(i,j) = .true. ; trunc_any = .true.</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (dowrite(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        v_old(i,j,:) = v(i,j,:)</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;      <span class="keywordflow">if</span> (trunc_any) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;          <span class="keywordflow">if</span> ((v(i,j,k) * (dt * g%dx_Cv(i,j))) * g%IareaT(i,j+1) &lt; -cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;            v(i,j,k) = (-0.9*cs%CFL_trunc) * (g%areaT(i,j+1) / (dt * g%dx_Cv(i,j)))</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;          <span class="keywordflow">elseif</span> ((v(i,j,k) * (dt * g%dx_Cv(i,j))) * g%IareaT(i,j) &gt; cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;            v(i,j,k) = (0.9*cs%CFL_trunc) * (g%areaT(i,j) / (dt * g%dx_Cv(i,j)))</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;            <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (abs(v(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;          v(i,j,k) = sign(truncvel,v(i,j,k))</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;<span class="keywordflow">        endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! J-loop</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">if</span> (cs%CFL_based_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,Jsq,Jeq,nz,v,dt,G,CS,h,H_report)</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        <span class="keywordflow">if</span> ((v(i,j,k) * (dt * g%dx_Cv(i,j))) * g%IareaT(i,j+1) &lt; -cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;          v(i,j,k) = (-0.9*cs%CFL_trunc) * (g%areaT(i,j+1) / (dt * g%dx_Cv(i,j)))</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="keywordflow">elseif</span> ((v(i,j,k) * (dt * g%dx_Cv(i,j))) * g%IareaT(i,j) &gt; cs%CFL_trunc) <span class="keywordflow">then</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;          v(i,j,k) = (0.9*cs%CFL_trunc) * (g%areaT(i,j) / (dt * g%dx_Cv(i,j)))</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;          <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,Jsq,Jeq,nz,v,G,CS,h,truncvel,maxvel,H_report)</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (abs(v(i,j,k)) &gt; maxvel) <span class="keywordflow">then</span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        v(i,j,k) = sign(truncvel,v(i,j,k))</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        <span class="keywordflow">if</span> (h(i,j,k) + h(i,j+1,k) &gt; h_report) cs%ntrunc = cs%ntrunc + 1</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  <span class="keywordflow">if</span> (len_trim(cs%v_trunc_file) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (dowrite(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;<span class="comment">!   Here the diagnostic reporting subroutines are called if</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;<span class="comment">! unphysically large values were found.</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;      <span class="keyword">call </span>write_v_accel(i, j, v_old, h, adp, cdp, dt, g, gv, cs%PointAccel_CSp, &amp;</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;               vel_report(i,j), -vel_report(i,j), fluxes%tauy(i,j)*dt_rho0, &amp;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;               a=cs%a_v(:,j,:),hv=cs%h_v(:,j,:))</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="keywordflow">    endif</span> ; enddo;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_a82bae17e9c3b1a5f1eedb6c1d14c5998_icgraph.svg" width="328" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="acc0ab44f987baf2efee2f43fa54435f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc0ab44f987baf2efee2f43fa54435f2">&#9670;&nbsp;</a></span>vertvisc_remnant()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_vert_friction::vertvisc_remnant </td>
          <td>(</td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>visc_rem_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, gv %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>visc_rem_v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__vert__friction_1_1vertvisc__cs.html">vertvisc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate the fraction of momentum originally in a layer that remains after a time-step of viscosity, and the fraction of a time-step's worth of barotropic acceleration that a layer experiences after viscosity is applied. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>Viscosities and bottom drag</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">visc_rem_u</td><td>Fraction of a time-step's worth of a barotopic acceleration that a layer experiences after viscosity is applied in the zonal direction</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">visc_rem_v</td><td>Fraction of a time-step's worth of a barotopic acceleration that a layer experiences after viscosity is applied in the meridional direction</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time increment in s</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Vertical viscosity control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__vert__friction_8F90_source.html#l00427">427</a> of file <a class="el" href="MOM__vert__friction_8F90_source.html">MOM_vert_friction.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span>   :: g<span class="comment">    !&lt; Ocean grid structure</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span> :: gv<span class="comment">   !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type), <span class="keywordtype">intent(in)</span>     :: visc<span class="comment"> !&lt; Viscosities and bottom drag</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">  !&gt; Fraction of a time-step&#39;s worth of a barotopic acceleration that</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">  !! a layer experiences after viscosity is applied in the zonal direction</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: visc_rem_u<span class="comment"></span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">  !&gt; Fraction of a time-step&#39;s worth of a barotopic acceleration that</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">  !! a layer experiences after viscosity is applied in the meridional direction</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: visc_rem_v</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">intent(in)</span>           :: dt<span class="comment"> !&lt; Time increment in s</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="keywordtype">type</span>(vertvisc_cs), <span class="keywordtype">pointer</span> :: cs<span class="comment"> !&lt; Vertical viscosity control structure</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordtype">real</span> :: b1(szib_(g))          <span class="comment">! b1 and c1 are variables used by the</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordtype">real</span> :: c1(szib_(g),szk_(g))  <span class="comment">! tridiagonal solver.  c1 is nondimensional,</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                                <span class="comment">! while b1 has units of inverse thickness.</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">real</span> :: d1(szib_(g))          <span class="comment">! d1=1-c1 is used by the tridiagonal solver, ND.</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordtype">real</span> :: ray(szib_(g),szk_(g)) <span class="comment">! Ray is the Rayleigh-drag velocity times the</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                                <span class="comment">! time step, in m.</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">real</span> :: b_denom_1   <span class="comment">! The first term in the denominator of b1, in m or kg m-2.</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">real</span> :: dt_m_to_h        <span class="comment">! The time step times the conversion from m to the</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                           <span class="comment">! units of thickness - either s or s m3 kg-1.</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">logical</span> :: do_i(szib_(g))</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  is = g%isc ; ie = g%iec</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB ; nz = g%ke</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;MOM_vert_friction(visc): &quot;</span>// &amp;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  dt_m_to_h = dt*gv%m_to_H</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq ; ray(i,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="comment">! Find the zonal viscous using a modification of a standard tridagonal solver.</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,Isq,Ieq,CS,nz,visc,dt_m_to_H,visc_rem_u) &amp;</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">!$OMP                     firstprivate(Ray)                                       &amp;</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">!$OMP                          private(do_i,b_denom_1,b1,d1,c1)</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq ; do_i(i) = (g%mask2dCu(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      ray(i,k) = visc%Ray_u(i,j,k)</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      b_denom_1 = cs%h_u(i,j,1) + dt_m_to_h * (ray(i,1) + cs%a_u(i,j,1))</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h*cs%a_u(i,j,2))</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      visc_rem_u(i,j,1) = b1(i) * cs%h_u(i,j,1)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      c1(i,k) = dt_m_to_h * cs%a_u(i,j,k)*b1(i)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      b_denom_1 = cs%h_u(i,j,k) + dt_m_to_h * (ray(i,k) + cs%a_u(i,j,k)*d1(i))</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h * cs%a_u(i,j,k+1))</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;      visc_rem_u(i,j,k) = (cs%h_u(i,j,k) + dt_m_to_h * cs%a_u(i,j,k) * visc_rem_u(i,j,k-1)) * b1(i)</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=isq,ieq ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      visc_rem_u(i,j,k) = visc_rem_u(i,j,k) + c1(i,k+1)*visc_rem_u(i,j,k+1)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i and k loops</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end u-component j loop</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="comment">! Now find the meridional viscous using a modification.</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(Jsq,Jeq,is,ie,G,CS,visc,dt_m_to_H,visc_rem_v,nz) &amp;</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">!$OMP                     firstprivate(Ray)                                             &amp;</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">!$OMP                          private(do_i,b_denom_1,b1,d1,c1)</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">do</span> j=jsq,jeq</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; do_i(i) = (g%mask2dCv(i,j) &gt; 0) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> (cs%Channel_drag) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      ray(i,k) = visc%Ray_v(i,j,k)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      b_denom_1 = cs%h_v(i,j,1) + dt_m_to_h * (ray(i,1) + cs%a_v(i,j,1))</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h*cs%a_v(i,j,2))</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      visc_rem_v(i,j,1) = b1(i) * cs%h_v(i,j,1)</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      c1(i,k) = dt_m_to_h * cs%a_v(i,j,k)*b1(i)</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      b_denom_1 = cs%h_v(i,j,k) + dt_m_to_h *  (ray(i,k) + cs%a_v(i,j,k)*d1(i))</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      b1(i) = 1.0 / (b_denom_1 + dt_m_to_h * cs%a_v(i,j,k+1))</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      d1(i) = b_denom_1 * b1(i)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      visc_rem_v(i,j,k) = (cs%h_v(i,j,k) + dt_m_to_h * cs%a_v(i,j,k) * visc_rem_v(i,j,k-1)) * b1(i)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordflow">do</span> k=nz-1,1,-1 ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (do_i(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      visc_rem_v(i,j,k) = visc_rem_v(i,j,k) + c1(i,k+1)*visc_rem_v(i,j,k+1)</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i and k loops</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of v-component J loop</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;visc_rem_[uv]&quot;</span>, visc_rem_u, visc_rem_v, g%HI,haloshift=0)</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__vert__friction_acc0ab44f987baf2efee2f43fa54435f2_cgraph.svg" width="524" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__vert__friction.html">mom_vert_friction</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
