<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_wave_speed Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__wave__speed.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_wave_speed Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Routines for calculating baroclinic wave speeds. </p>
<p>Subroutine <a class="el" href="namespacemom__wave__speed.html#a72302e356c47c5055ba0b1a8714c772a" title="Calculates the wave speed of the first baroclinic mode. ">wave_speed()</a> solves for the first baroclinic mode wave speed. (It could solve for all the wave speeds, but the iterative approach taken here means that this is not particularly efficient.)</p>
<p>If <code>e(k)</code> is the perturbation interface height, this means solving for the smallest eigenvalue (<code>lam</code> = 1/c^2) of the system</p>
<pre class="fragment">   -Igu(k)*e(k-1) + (Igu(k)+Igl(k)-lam)*e(k) - Igl(k)*e(k+1) = 0.0</pre><p>with rigid lid boundary conditions e(1) = e(nz+1) = 0.0 giving</p>
<pre class="fragment">   (Igu(2)+Igl(2)-lam)*e(2) - Igl(2)*e(3) = 0.0
   -Igu(nz)*e(nz-1) + (Igu(nz)+Igl(nz)-lam)*e(nz) = 0.0</pre><p>Here </p><pre class="fragment">   Igl(k) = 1.0/(gprime(k)*h(k)) ; Igu(k) = 1.0/(gprime(k)*h(k-1))</pre><p>Alternately, these same eigenvalues can be found from the second smallest eigenvalue of the Montgomery potential (M(k)) calculation:</p>
<pre class="fragment">   -Igl(k)*M(k-1) + (Igl(k)+Igu(k+1)-lam)*M(k) - Igu(k+1)*M(k+1) = 0.0</pre><p>with rigid lid and flat bottom boundary conditions</p>
<pre class="fragment">   (Igu(2)-lam)*M(1) - Igu(2)*M(2) = 0.0
   -Igl(nz)*M(nz-1) + (Igl(nz)-lam)*M(nz) = 0.0</pre><p>Note that the barotropic mode has been eliminated from the rigid lid interface height equations, hence the matrix is one row smaller. Without the rigid lid, the top boundary condition is simpler to implement with the M equations. </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__wave__speed_1_1wave__speed__cs.html">wave_speed_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure for MOM_wave_speed.  <a href="structmom__wave__speed_1_1wave__speed__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a72302e356c47c5055ba0b1a8714c772a"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a72302e356c47c5055ba0b1a8714c772a">wave_speed</a> (h, tv, G, GV, cg1, CS, full_halos, use_ebt_mode, mono_N2_column_fraction, mono_N2_depth, modal_structure)</td></tr>
<tr class="memdesc:a72302e356c47c5055ba0b1a8714c772a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the wave speed of the first baroclinic mode.  <a href="#a72302e356c47c5055ba0b1a8714c772a">More...</a><br /></td></tr>
<tr class="separator:a72302e356c47c5055ba0b1a8714c772a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a57673d33027f1ef38330443123102301"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a57673d33027f1ef38330443123102301">tdma6</a> (n, a, b, c, lam, y)</td></tr>
<tr class="memdesc:a57673d33027f1ef38330443123102301"><td class="mdescLeft">&#160;</td><td class="mdescRight">Solve a non-symmetric tridiagonal problem with a scalar contribution to the leading diagonal. This uses the Thomas algorithm rather than the Hallberg algorithm since the matrix is not symmetric.  <a href="#a57673d33027f1ef38330443123102301">More...</a><br /></td></tr>
<tr class="separator:a57673d33027f1ef38330443123102301"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0009abd8573168b780c95db2962982d6"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a0009abd8573168b780c95db2962982d6">wave_speeds</a> (h, tv, G, GV, nmodes, cn, CS, full_halos)</td></tr>
<tr class="memdesc:a0009abd8573168b780c95db2962982d6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the wave speeds for the first few barolinic modes.  <a href="#a0009abd8573168b780c95db2962982d6">More...</a><br /></td></tr>
<tr class="separator:a0009abd8573168b780c95db2962982d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d633de4db3e5c4e4a7d313c428c7a56"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a1d633de4db3e5c4e4a7d313c428c7a56">tridiag_det</a> (a, b, c, nrows, lam, det_out, ddet_out)</td></tr>
<tr class="memdesc:a1d633de4db3e5c4e4a7d313c428c7a56"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the determinant of a tridiagonal matrix with diagonals a,b-lam,c where lam is constant across rows.  <a href="#a1d633de4db3e5c4e4a7d313c428c7a56">More...</a><br /></td></tr>
<tr class="separator:a1d633de4db3e5c4e4a7d313c428c7a56"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a46e21529ec8098b0b19053afa133b971"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a46e21529ec8098b0b19053afa133b971">wave_speed_init</a> (CS, use_ebt_mode, mono_N2_column_fraction, mono_N2_depth)</td></tr>
<tr class="memdesc:a46e21529ec8098b0b19053afa133b971"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize control structure for MOM_wave_speed.  <a href="#a46e21529ec8098b0b19053afa133b971">More...</a><br /></td></tr>
<tr class="separator:a46e21529ec8098b0b19053afa133b971"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a035c9e3306d6b21809e240a5b24a2db0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__wave__speed.html#a035c9e3306d6b21809e240a5b24a2db0">wave_speed_set_param</a> (CS, use_ebt_mode, mono_N2_column_fraction, mono_N2_depth)</td></tr>
<tr class="memdesc:a035c9e3306d6b21809e240a5b24a2db0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets internal parameters for MOM_wave_speed.  <a href="#a035c9e3306d6b21809e240a5b24a2db0">More...</a><br /></td></tr>
<tr class="separator:a035c9e3306d6b21809e240a5b24a2db0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a57673d33027f1ef38330443123102301"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a57673d33027f1ef38330443123102301">&#9670;&nbsp;</a></span>tdma6()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_wave_speed::tdma6 </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n), intent(in)&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n), intent(in)&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n), intent(in)&#160;</td>
          <td class="paramname"><em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>lam</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(n), intent(inout)&#160;</td>
          <td class="paramname"><em>y</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Solve a non-symmetric tridiagonal problem with a scalar contribution to the leading diagonal. This uses the Thomas algorithm rather than the Hallberg algorithm since the matrix is not symmetric. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">n</td><td>Number of rows of matrix</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">a</td><td>Lower diagonal</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">b</td><td>Leading diagonal</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">c</td><td>Upper diagonal</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">lam</td><td>Scalar subtracted from leading diagonal</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">y</td><td>RHS on entry, result on exit </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l00464">464</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__wave__speed_8F90_source.html#l00045">wave_speed()</a>.</p>
<div class="fragment"><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordtype">integer</span>,            <span class="keywordtype">intent(in)</span>    :: n<span class="comment"> !&lt; Number of rows of matrix</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(n)</span>, <span class="keywordtype">intent(in)</span>    :: a<span class="comment"> !&lt; Lower diagonal</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(n)</span>, <span class="keywordtype">intent(in)</span>    :: b<span class="comment"> !&lt; Leading diagonal</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(n)</span>, <span class="keywordtype">intent(in)</span>    :: c<span class="comment"> !&lt; Upper diagonal</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordtype">real</span>,               <span class="keywordtype">intent(in)</span>    :: lam<span class="comment"> !&lt; Scalar subtracted from leading diagonal</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(n)</span>, <span class="keywordtype">intent(inout)</span> :: y<span class="comment"> !&lt; RHS on entry, result on exit</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="keywordtype">integer</span> :: k, l</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  <span class="keywordtype">real</span> :: beta(n), yy(n), lambda</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  lambda = lam</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  beta(1) = b(1) - lambda</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <span class="keywordflow">if</span> (beta(1)==0.) <span class="keywordflow">then</span> <span class="comment">! lam was chosen too perfectly</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="comment">! Change lambda and redo this first row</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    lambda = (1. + 1.e-5) * lambda</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    beta(1) = b(1) - lambda</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  beta(1) = 1. / beta(1)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  yy(1) = y(1)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  <span class="keywordflow">do</span> k = 2, n</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    beta(k) = ( b(k) - lambda ) - a(k) * c(k-1) * beta(k-1)</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordflow">if</span> (beta(k)==0.) <span class="keywordflow">then</span> <span class="comment">! lam was chosen too perfectly</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;      <span class="comment">! Change lambda and redo everything up to row k</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      lambda = (1. + 1.e-5) * lambda</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      beta(1) = 1. / ( b(1) - lambda )</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="keywordflow">do</span> l = 2, k</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        beta(l) = 1. / ( ( b(l) - lambda ) - a(l) * c(l-1) * beta(l-1) )</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        yy(l) = y(l) - a(l) * yy(l-1) * beta(l-1)</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      beta(k) = 1. / beta(k)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    yy(k) = y(k) - a(k) * yy(k-1) * beta(k-1)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  y(n) = yy(n) * beta(n)</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">do</span> k = n-1, 1, -1</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    y(k) = ( yy(k) - c(k) * y(k+1) ) * beta(k)</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordflow">  enddo</span></div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a57673d33027f1ef38330443123102301_icgraph.svg" width="100%" height="419"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a1d633de4db3e5c4e4a7d313c428c7a56"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d633de4db3e5c4e4a7d313c428c7a56">&#9670;&nbsp;</a></span>tridiag_det()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_wave_speed::tridiag_det </td>
          <td>(</td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nrows</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>lam</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>det_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>ddet_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculate the determinant of a tridiagonal matrix with diagonals a,b-lam,c where lam is constant across rows. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">a</td><td>Lower diagonal of matrix (first entry = 0)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">b</td><td>Leading diagonal of matrix (excluding lam)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">c</td><td>Upper diagonal of matrix (last entry = 0)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nrows</td><td>Size of matrix</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">lam</td><td>Value subtracted from b</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">det_out</td><td>Determinant</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">ddet_out</td><td>Derivative of determinant w.r.t. lam </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l01047">1047</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__wave__speed_8F90_source.html#l00505">wave_speeds()</a>.</p>
<div class="fragment"><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: a<span class="comment"> !&lt; Lower diagonal of matrix (first entry = 0)</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: b<span class="comment"> !&lt; Leading diagonal of matrix (excluding lam)</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: c<span class="comment"> !&lt; Upper diagonal of matrix (last entry = 0)</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  <span class="keywordtype">integer</span>,            <span class="keywordtype">intent(in)</span> :: nrows<span class="comment"> !&lt; Size of matrix</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keywordtype">real</span>,               <span class="keywordtype">intent(in)</span> :: lam<span class="comment"> !&lt; Value subtracted from b</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;  <span class="keywordtype">real</span>,               <span class="keywordtype">intent(out)</span>:: det_out<span class="comment"> !&lt; Determinant</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;  <span class="keywordtype">real</span>,               <span class="keywordtype">intent(out)</span>:: ddet_out<span class="comment"> !&lt; Derivative of determinant w.r.t. lam</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nrows)</span> :: det <span class="comment">! value of recursion function</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nrows)</span> :: ddet <span class="comment">! value of recursion function for derivative</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>:: rescale = 1024.0**4 <span class="comment">! max value of determinant allowed before rescaling</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  <span class="keywordtype">real</span> :: i_rescale <span class="comment">! inverse of rescale</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  <span class="keywordtype">integer</span> :: n      <span class="comment">! row (layer interface) index</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">size</span>(b) .ne. nrows) <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Diagonal b must be same length as nrows.&quot;</span>)</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">size</span>(a) .ne. nrows) <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Diagonal a must be same length as nrows.&quot;</span>)</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">size</span>(c) .ne. nrows) <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Diagonal c must be same length as nrows.&quot;</span>)</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  i_rescale = 1.0/rescale</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  det(1) = 1.0      ; ddet(1) = 0.0</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  det(2) = b(2)-lam ; ddet(2) = -1.0</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  <span class="keywordflow">do</span> n=3,nrows</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    det(n)  = (b(n)-lam)*det(n-1)  - (a(n)*c(n-1))*det(n-2)</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    ddet(n) = (b(n)-lam)*ddet(n-1) - (a(n)*c(n-1))*ddet(n-2) - det(n-1)</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="comment">! Rescale det &amp; ddet if det is getting too large.</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <span class="keywordflow">if</span> (abs(det(n)) &gt; rescale) <span class="keywordflow">then</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;      det(n)  = i_rescale*det(n)  ; det(n-1)  = i_rescale*det(n-1)</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;      ddet(n) = i_rescale*ddet(n) ; ddet(n-1) = i_rescale*ddet(n-1)</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  det_out = det(nrows)</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  ddet_out = ddet(nrows)</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a1d633de4db3e5c4e4a7d313c428c7a56_icgraph.svg" width="619" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a72302e356c47c5055ba0b1a8714c772a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a72302e356c47c5055ba0b1a8714c772a">&#9670;&nbsp;</a></span>wave_speed()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_wave_speed::wave_speed </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>cg1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__wave__speed_1_1wave__speed__cs.html">wave_speed_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>full_halos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>use_ebt_mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_column_fraction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(out), optional&#160;</td>
          <td class="paramname"><em>modal_structure</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the wave speed of the first baroclinic mode. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness (m or kg/m2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamic variables</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">cg1</td><td>First mode internal wave speed (m/s)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for MOM_wave_speed</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">full_halos</td><td>If true, do the calculation over the entire computational domain.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">use_ebt_mode</td><td>If true, use the equivalent barotropic mode instead of the first baroclinic mode.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_column_fraction</td><td>The lower fraction of water column over which N2 is limited as monotonic for the purposes of calculating vertical modal structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_depth</td><td>A depth below which N2 is limited as monotonic for the purposes of calculating vertical modal structure.</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">modal_structure</td><td>Normalized model structure (non-dim) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l00045">45</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__EOS_8F90_source.html#l00214">mom_eos::calculate_density_derivs()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__remapping_8F90_source.html#l00163">mom_remapping::remapping_core_h()</a>, and <a class="el" href="MOM__wave__speed_8F90_source.html#l00464">tdma6()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__lateral__mixing__coeffs_8F90_source.html#l00133">mom_lateral_mixing_coeffs::calc_resoln_function()</a>, and <a class="el" href="MOM__diagnostics_8F90_source.html#l00174">mom_diagnostics::calculate_diagnostic_fields()</a>.</p>
<div class="fragment"><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(in)</span>  :: g<span class="comment"> !&lt; Ocean grid structure</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>  :: gv<span class="comment"> !&lt; Vertical grid structure</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>  :: h<span class="comment"> !&lt; Layer thickness (m or kg/m2)</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                    <span class="keywordtype">intent(in)</span>  :: tv<span class="comment"> !&lt; Thermodynamic variables</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,         <span class="keywordtype">intent(out)</span> :: cg1<span class="comment"> !&lt; First mode internal wave speed (m/s)</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordtype">type</span>(wave_speed_cs),                      <span class="keywordtype">pointer</span>     :: cs<span class="comment"> !&lt; Control structure for MOM_wave_speed</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,                        <span class="keywordtype">intent(in)</span>  :: full_halos<span class="comment"> !&lt; If true, do the calculation</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">                                                  !! over the entire computational domain.</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,                        <span class="keywordtype">intent(in)</span>  :: use_ebt_mode<span class="comment"> !&lt; If true, use the equivalent</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">                                                  !! barotropic mode instead of the first baroclinic mode.</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,                           <span class="keywordtype">intent(in)</span>  :: mono_n2_column_fraction<span class="comment"> !&lt; The lower fraction</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">                                                  !! of water column over which N2 is limited as monotonic</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">                                                  !! for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,                           <span class="keywordtype">intent(in)</span>  :: mono_n2_depth<span class="comment"> !&lt; A depth below which N2 is limited as</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">                                                  !! monotonic for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordtype">optional</span>,                           <span class="keywordtype">intent(out)</span> :: modal_structure<span class="comment"> !&lt; Normalized model structure (non-dim)</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    drho_dt, drho_ds, &amp;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    pres, t_int, s_int, &amp;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    gprime        <span class="comment">! The reduced gravity across each interface, in m s-2.</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    igl, igu      <span class="comment">! The inverse of the reduced gravity across an interface times</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                  <span class="comment">! the thickness of the layer below (Igl) or above (Igu) it,</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                  <span class="comment">! in units of s2 m-2.</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G),SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    hf, tf, sf, rf</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    hc, tc, sc, rc</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordtype">real</span> det, ddet, detkm1, detkm2, ddetkm1, ddetkm2</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordtype">real</span> :: lam, dlam, lam0</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordtype">real</span> :: min_h_frac</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keywordtype">real</span> :: h_to_pres</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="keywordtype">real</span> :: h_to_m     <span class="comment">! Local copy of a unit conversion factor.</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    htot, hmin, &amp;  <span class="comment">! Thicknesses in m.</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    h_here, hxt_here, hxs_here, hxr_here</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">real</span> :: speed2_tot</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">real</span> :: i_hnew, drxh_sum</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: tol1  = 0.0001, tol2 = 0.001</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">dimension(:,:,:)</span> :: t, s</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">real</span> :: g_rho0  <span class="comment">! G_Earth/Rho0 in m4 s-2 kg-1.</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">real</span> :: rescale, i_rescale</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="keywordtype">integer</span> :: kf(szi_(g))</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: max_itt = 10</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">real</span> :: lam_it(max_itt), det_it(max_itt), ddet_it(max_itt)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">logical</span> :: use_eos    <span class="comment">! If true, density is calculated from T &amp; S using an</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                        <span class="comment">! equation of state.</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordtype">integer</span> :: kc</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, k2, itt, is, ie, js, je, nz</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordtype">real</span> :: hw, gp, sum_hc, n2min</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordtype">logical</span> :: l_use_ebt_mode, calc_modal_structure</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keywordtype">real</span> :: l_mono_n2_column_fraction, l_mono_n2_depth</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordtype">real</span> :: mode_struct(szk_(g)), ms_min, ms_max, ms_sq</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_wave_speed: &quot;</span>// &amp;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;           <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(full_halos)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (full_halos) <span class="keywordflow">then</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    is = g%isd ; ie = g%ied ; js = g%jsd ; je = g%jed</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  l_use_ebt_mode = cs%use_ebt_mode</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(use_ebt_mode)) l_use_ebt_mode = use_ebt_mode</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  l_mono_n2_column_fraction = cs%mono_N2_column_fraction</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(mono_n2_column_fraction)) l_mono_n2_column_fraction = mono_n2_column_fraction</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  l_mono_n2_depth = cs%mono_N2_depth</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(mono_n2_depth)) l_mono_n2_depth = mono_n2_depth</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  calc_modal_structure = l_use_ebt_mode</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(modal_structure)) calc_modal_structure = .true.</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keywordflow">if</span> (calc_modal_structure) <span class="keywordflow">then</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> j=js,je; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      modal_structure(i,j,k) = 0.0</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="keyword">    end</span>do; enddo; enddo</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  s =&gt; tv%S ; t =&gt; tv%T</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  g_rho0 = gv%g_Earth/gv%Rho0</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  use_eos = <span class="keyword">associated</span>(tv%eqn_of_state)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  h_to_pres = gv%g_Earth * gv%Rho0</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  h_to_m = gv%H_to_m</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  rescale = 1024.0**4 ; i_rescale = 1.0/rescale</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  min_h_frac = tol1 / <span class="keywordtype">real</span>(nz)</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,h,G,GV,min_h_frac,use_EOS,T,S,tv,&amp;</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">!$OMP                                  calc_modal_structure,l_use_ebt_mode,modal_structure, &amp;</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">!$OMP                                  l_mono_N2_column_fraction,l_mono_N2_depth,CS, &amp;</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">!$OMP                                  H_to_pres,H_to_m,cg1,g_Rho0,rescale,I_rescale)  &amp;</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">!$OMP                          private(htot,hmin,kf,H_here,HxT_here,HxS_here,HxR_here, &amp;</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">!$OMP                                  Hf,Tf,Sf,Rf,pres,T_int,S_int,drho_dT,           &amp;</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">!$OMP                                  drho_dS,drxh_sum,kc,Hc,Tc,Sc,I_Hnew,gprime,     &amp;</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">!$OMP                                  Rc,speed2_tot,Igl,Igu,lam0,lam,lam_it,dlam,     &amp;</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">!$OMP                                  mode_struct,sum_hc,N2min,gp,hw,                 &amp;</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">!$OMP                                  ms_min,ms_max,ms_sq,                            &amp;</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">!$OMP                                  det,ddet,detKm1,ddetKm1,detKm2,ddetKm2,det_it,ddet_it)</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="comment">!   First merge very thin layers with the one above (or below if they are</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="comment">! at the top).  This also transposes the row order so that columns can</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="comment">! be worked upon one at a time.</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; htot(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; htot(i) = htot(i) + h(i,j,k)*h_to_m ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;      hmin(i) = htot(i)*min_h_frac ; kf(i) = 1 ; h_here(i) = 0.0</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      hxt_here(i) = 0.0 ; hxs_here(i) = 0.0 ; hxr_here(i) = 0.0</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="keywordflow">if</span> ((h_here(i) &gt; hmin(i)) .and. (h(i,j,k)*h_to_m &gt; hmin(i))) <span class="keywordflow">then</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;          hf(kf(i),i) = h_here(i)</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;          tf(kf(i),i) = hxt_here(i) / h_here(i)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;          sf(kf(i),i) = hxs_here(i) / h_here(i)</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;          kf(i) = kf(i) + 1</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;          <span class="comment">! Start a new layer</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;          h_here(i) = h(i,j,k)*h_to_m</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;          hxt_here(i) = (h(i,j,k)*h_to_m)*t(i,j,k)</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;          hxs_here(i) = (h(i,j,k)*h_to_m)*s(i,j,k)</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;          h_here(i) = h_here(i) + h(i,j,k)*h_to_m</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;          hxt_here(i) = hxt_here(i) + (h(i,j,k)*h_to_m)*t(i,j,k)</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;          hxs_here(i) = hxs_here(i) + (h(i,j,k)*h_to_m)*s(i,j,k)</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h_here(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        hf(kf(i),i) = h_here(i)</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        tf(kf(i),i) = hxt_here(i) / h_here(i)</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        sf(kf(i),i) = hxs_here(i) / h_here(i)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">if</span> ((h_here(i) &gt; hmin(i)) .and. (h(i,j,k)*h_to_m &gt; hmin(i))) <span class="keywordflow">then</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;          hf(kf(i),i) = h_here(i) ; rf(kf(i),i) = hxr_here(i) / h_here(i)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;          kf(i) = kf(i) + 1</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;          <span class="comment">! Start a new layer</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;          h_here(i) = h(i,j,k)*h_to_m</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;          hxr_here(i) = (h(i,j,k)*h_to_m)*gv%Rlay(k)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;          h_here(i) = h_here(i) + h(i,j,k)*h_to_m</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;          hxr_here(i) = hxr_here(i) + (h(i,j,k)*h_to_m)*gv%Rlay(k)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h_here(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        hf(kf(i),i) = h_here(i) ; rf(kf(i),i) = hxr_here(i) / h_here(i)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="comment">! From this point, we can work on individual columns without causing memory</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="comment">! to have page faults.</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        pres(1) = 0.0</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;          pres(k) = pres(k-1) + h_to_pres*hf(k-1,i)</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;          t_int(k) = 0.5*(tf(k,i)+tf(k-1,i))</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;          s_int(k) = 0.5*(sf(k,i)+sf(k-1,i))</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keyword">call </span>calculate_density_derivs(t_int, s_int, pres, drho_dt, drho_ds, 2, &amp;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                                      kf(i)-1, tv%eqn_of_state)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="comment">! Sum the reduced gravities to find out how small a density difference</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="comment">! is negligibly small.</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        drxh_sum = 0.0</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;          drxh_sum = drxh_sum + 0.5*(hf(k-1,i)+hf(k,i)) * &amp;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;              max(0.0,drho_dt(k)*(tf(k,i)-tf(k-1,i)) + &amp;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                      drho_ds(k)*(sf(k,i)-sf(k-1,i)))</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        drxh_sum = 0.0</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;          drxh_sum = drxh_sum + 0.5*(hf(k-1,i)+hf(k,i)) * &amp;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                            max(0.0,rf(k,i)-rf(k-1,i))</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;      <span class="keywordflow">if</span> (calc_modal_structure) <span class="keywordflow">then</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        mode_struct(:) = 0.</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="comment">!   Find gprime across each internal interface, taking care of convective</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="comment">! instabilities by merging layers.</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;      <span class="keywordflow">if</span> (drxh_sum &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        cg1(i,j) = 0.0</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="comment">! Merge layers to eliminate convective instabilities or exceedingly</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="comment">! small reduced gravities.</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;          kc = 1</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;          hc(1) = hf(1,i) ; tc(1) = tf(1,i) ; sc(1) = sf(1,i)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;          <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            <span class="keywordflow">if</span> ((drho_dt(k)*(tf(k,i)-tc(kc)) + drho_ds(k)*(sf(k,i)-sc(kc))) * &amp;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                (hc(kc) + hf(k,i)) &lt; 2.0 * tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;              <span class="comment">! Merge this layer with the one above and backtrack.</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;              i_hnew = 1.0 / (hc(kc) + hf(k,i))</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;              tc(kc) = (hc(kc)*tc(kc) + hf(k,i)*tf(k,i)) * i_hnew</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;              sc(kc) = (hc(kc)*sc(kc) + hf(k,i)*sf(k,i)) * i_hnew</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;              hc(kc) = (hc(kc) + hf(k,i))</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;              <span class="comment">! Backtrack to remove any convective instabilities above...  Note</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;              <span class="comment">! that the tolerance is a factor of two larger, to avoid limit how</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;              <span class="comment">! far back we go.</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;              <span class="keywordflow">do</span> k2=kc,2,-1</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                <span class="keywordflow">if</span> ((drho_dt(k2)*(tc(k2)-tc(k2-1)) + drho_ds(k2)*(sc(k2)-sc(k2-1))) * &amp;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                    (hc(k2) + hc(k2-1)) &lt; tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                  <span class="comment">! Merge the two bottommost layers.  At this point kc = k2.</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                  i_hnew = 1.0 / (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                  tc(kc-1) = (hc(kc)*tc(kc) + hc(kc-1)*tc(kc-1)) * i_hnew</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                  sc(kc-1) = (hc(kc)*sc(kc) + hc(kc-1)*sc(kc-1)) * i_hnew</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                  hc(kc-1) = (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                  kc = kc - 1</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                <span class="keywordflow">else</span> ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;              <span class="comment">! Add a new layer to the column.</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;              kc = kc + 1</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;              drho_ds(kc) = drho_ds(k) ; drho_dt(kc) = drho_dt(k)</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;              tc(kc) = tf(k,i) ; sc(kc) = sf(k,i) ; hc(kc) = hf(k,i)</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;          <span class="comment">! At this point there are kc layers and the gprimes should be positive.</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;          <span class="keywordflow">do</span> k=2,kc <span class="comment">! Revisit this if non-Boussinesq.</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;            gprime(k) = g_rho0 * (drho_dt(k)*(tc(k)-tc(k-1)) + &amp;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                                  drho_ds(k)*(sc(k)-sc(k-1)))</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="keywordflow">else</span>  <span class="comment">! .not.use_EOS</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;          <span class="comment">! Do the same with density directly...</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;          kc = 1</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;          hc(1) = hf(1,i) ; rc(1) = rf(1,i)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;          <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;            <span class="keywordflow">if</span> ((rf(k,i) - rc(kc)) * (hc(kc) + hf(k,i)) &lt; 2.0*tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;              <span class="comment">! Merge this layer with the one above and backtrack.</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;              rc(kc) = (hc(kc)*rc(kc) + hf(k,i)*rf(k,i)) / (hc(kc) + hf(k,i))</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;              hc(kc) = (hc(kc) + hf(k,i))</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;              <span class="comment">! Backtrack to remove any convective instabilities above...  Note</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;              <span class="comment">! that the tolerance is a factor of two larger, to avoid limit how</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;              <span class="comment">! far back we go.</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;              <span class="keywordflow">do</span> k2=kc,2,-1</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                <span class="keywordflow">if</span> ((rc(k2)-rc(k2-1)) * (hc(k2)+hc(k2-1)) &lt; tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                  <span class="comment">! Merge the two bottommost layers.  At this point kc = k2.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                  rc(kc-1) = (hc(kc)*rc(kc) + hc(kc-1)*rc(kc-1)) / (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                  hc(kc-1) = (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                  kc = kc - 1</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                <span class="keywordflow">else</span> ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;              <span class="comment">! Add a new layer to the column.</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;              kc = kc + 1</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;              rc(kc) = rf(k,i) ; hc(kc) = hf(k,i)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;          <span class="comment">! At this point there are kc layers and the gprimes should be positive.</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;          <span class="keywordflow">do</span> k=2,kc <span class="comment">! Revisit this if non-Boussinesq.</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            gprime(k) = g_rho0 * (rc(k)-rc(k-1))</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keywordflow">        endif</span>  <span class="comment">! use_EOS</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        <span class="comment">! Sum the contributions from all of the interfaces to give an over-estimate</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment">! of the first-mode wave speed.  Also populate Igl and Igu which are the</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">! non-leading diagonals of the tridiagonal matrix.</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">if</span> (kc &gt;= 2) <span class="keywordflow">then</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;          speed2_tot = 0.0</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;          <span class="keywordflow">if</span> (l_use_ebt_mode) <span class="keywordflow">then</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            igu(1) = 0. <span class="comment">! Neumann condition for pressure modes</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            sum_hc = hc(1)*gv%H_to_m</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;            n2min = gprime(2)/hc(1)</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            <span class="keywordflow">do</span> k=2,kc</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;              hw = 0.5*(hc(k-1)+hc(k))</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;              gp = gprime(k)</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;              <span class="keywordflow">if</span> (l_mono_n2_column_fraction&gt;0. .or. l_mono_n2_depth&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                <span class="keywordflow">if</span> (g%bathyT(i,j)-sum_hc&lt;l_mono_n2_column_fraction*g%bathyT(i,j) .and. gp&gt;n2min*hw) <span class="keywordflow">then</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                  <span class="comment">! Filters out regions where N2 increases with depth but only in a lower fraction of water column</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                  gp = n2min/hw</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                <span class="keywordflow">elseif</span> (l_mono_n2_depth&gt;=0. .and. sum_hc&gt;l_mono_n2_depth .and. gp&gt;n2min*hw) <span class="keywordflow">then</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                  <span class="comment">! Filters out regions where N2 increases with depth but only below a certain depth</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                  gp = n2min/hw</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                  n2min = gp/hw</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;              igu(k) = 1.0/(gp*hc(k))</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;              igl(k-1) = 1.0/(gp*hc(k-1))</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;              speed2_tot = speed2_tot + gprime(k)*(hc(k-1)+hc(k))*0.707</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;              sum_hc = sum_hc + hc(k)*gv%H_to_m</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;           <span class="comment">!Igl(kc) = 0. ! Neumann condition for pressure modes</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            igl(kc) = 2.*igu(kc) <span class="comment">! Dirichlet condition for pressure modes</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;          <span class="keywordflow">else</span> <span class="comment">! .not. l_use_ebt_mode</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            <span class="keywordflow">do</span> k=2,kc</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;              igl(k) = 1.0/(gprime(k)*hc(k)) ; igu(k) = 1.0/(gprime(k)*hc(k-1))</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;              speed2_tot = speed2_tot + gprime(k)*(hc(k-1)+hc(k))</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;          <span class="keywordflow">if</span> (calc_modal_structure) <span class="keywordflow">then</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            mode_struct(1:kc) = 1. <span class="comment">! Uniform flow, first guess</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;          <span class="comment">! Overestimate the speed to start with.</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;          <span class="keywordflow">if</span> (calc_modal_structure) <span class="keywordflow">then</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            lam0 = 0.5 / speed2_tot ; lam = lam0</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            lam0 = 1.0 / speed2_tot ; lam = lam0</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;          <span class="comment">! Find the determinant and its derivative with lam.</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;          <span class="keywordflow">do</span> itt=1,max_itt</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            lam_it(itt) = lam</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            <span class="keywordflow">if</span> (l_use_ebt_mode) <span class="keywordflow">then</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;              <span class="comment">! This initialization of det,ddet imply Neumann boundary conditions so that first 3 rows of the matrix are</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;              <span class="comment">!    /   b(1)-lam  igl(1)      0        0     0  ...  \</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;              <span class="comment">!    |  igu(2)    b(2)-lam   igl(2)     0     0  ...  |</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;              <span class="comment">!    |    0        igu(3)   b(3)-lam  igl(3)  0  ...  |</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;              <span class="comment">! which is consistent if the eigenvalue problem is for horizontal velocity or pressure modes.</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;             <span class="comment">!detKm1 = (       Igl(1)-lam) ; ddetKm1 = -1.0</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;             <span class="comment">!det = (Igu(2)+Igl(2)-lam)*detKm1 - (Igu(2)*Igl(1)) ; ddet = (Igu(2)+Igl(2)-lam)*ddetKm1 - detKm1</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;              detkm1 = 1.0 ; ddetkm1 = 0.0</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;              det = (       igl(1)-lam) ; ddet = -1.0</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;              <span class="keywordflow">if</span> (kc&gt;1) <span class="keywordflow">then</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                detkm2 = detkm1; ddetkm2 = ddetkm1</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                detkm1 = det; ddetkm1 = ddet</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                det = (igu(2)+igl(2)-lam)*detkm1 - (igu(2)*igl(1))*detkm2</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                ddet = (igu(2)+igl(2)-lam)*ddetkm1 - (igu(2)*igl(1))*ddetkm2 - detkm1</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;              <span class="comment">! The last two rows of the pressure equation matrix are</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;              <span class="comment">!    |    ...  0  igu(kc-1)  b(kc-1)-lam  igl(kc-1)  |</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;              <span class="comment">!    \    ...  0     0        igu(kc)     b(kc)-lam  /</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;              <span class="comment">! This initialization of det,ddet imply Dirichlet boundary conditions so that first 3 rows of the matrix are</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;              <span class="comment">!    /  b(2)-lam  igl(2)      0       0     0  ...  |</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;              <span class="comment">!    |  igu(3)  b(3)-lam   igl(3)     0     0  ...  |</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;              <span class="comment">!    |    0       igu43)  b(4)-lam  igl(4)  0  ...  |</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;              <span class="comment">! which is consistent if the eigenvalue problem is for vertical velocity modes.</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;              detkm1 = 1.0 ; ddetkm1 = 0.0</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;              det = (igu(2)+igl(2)-lam) ; ddet = -1.0</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;              <span class="comment">! The last three rows of the w equation matrix are</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;              <span class="comment">!    |    ...   0  igu(kc-1)  b(kc-1)-lam  igl(kc-1)     0       |</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;              <span class="comment">!    |    ...   0     0        igu(kc-1)  b(kc-1)-lam  igl(kc-1) |</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;              <span class="comment">!    \    ...   0     0           0        igu(kc)    b(kc)-lam  /</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            <span class="keywordflow">do</span> k=3,kc</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;              detkm2 = detkm1; ddetkm2 = ddetkm1</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;              detkm1 = det; ddetkm1 = ddet</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;              det = (igu(k)+igl(k)-lam)*detkm1 - (igu(k)*igl(k-1))*detkm2</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;              ddet = (igu(k)+igl(k)-lam)*ddetkm1 - (igu(k)*igl(k-1))*ddetkm2 - detkm1</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;              <span class="comment">! Rescale det &amp; ddet if det is getting too large.</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;              <span class="keywordflow">if</span> (abs(det) &gt; rescale) <span class="keywordflow">then</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                det = i_rescale*det ; detkm1 = i_rescale*detkm1</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                ddet = i_rescale*ddet ; ddetkm1 = i_rescale*ddetkm1</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;            <span class="comment">! Use Newton&#39;s method iteration to find a new estimate of lam.</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;            det_it(itt) = det ; ddet_it(itt) = ddet</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            <span class="keywordflow">if</span> ((ddet &gt;= 0.0) .or. (-det &gt; -0.5*lam*ddet)) <span class="keywordflow">then</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;              <span class="comment">! lam was not an under-estimate, as intended, so Newton&#39;s method</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;              <span class="comment">! may not be reliable; lam must be reduced, but not by more</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;              <span class="comment">! than half.</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;              lam = 0.5 * lam</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;              dlam = -lam</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;            <span class="keywordflow">else</span>  <span class="comment">! Newton&#39;s method is OK.</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;              dlam = - det / ddet</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;              lam = lam + dlam</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            <span class="keywordflow">if</span> (calc_modal_structure) <span class="keywordflow">then</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;              <span class="keyword">call </span>tdma6(kc, -igu, igu+igl, -igl, lam, mode_struct)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;              ms_min = mode_struct(1)</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;              ms_max = mode_struct(1)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;              ms_sq = mode_struct(1)**2</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;              <span class="keywordflow">do</span> k = 2,kc</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                ms_min = min(ms_min, mode_struct(k))</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                ms_max = max(ms_max, mode_struct(k))</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                ms_sq = ms_sq + mode_struct(k)**2</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordflow">              enddo</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;              <span class="keywordflow">if</span> (ms_min&lt;0. .and. ms_max&gt;0.) <span class="keywordflow">then</span> <span class="comment">! Any zero crossings =&gt; lam is too high</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                lam = 0.5 * ( lam - dlam )</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                dlam = -lam</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                mode_struct(1:kc) = abs(mode_struct(1:kc)) / sqrt( ms_sq )</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                mode_struct(1:kc) = mode_struct(1:kc) / sqrt( ms_sq )</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            <span class="keywordflow">if</span> (abs(dlam) &lt; tol2*lam) <span class="keywordflow">exit</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;          cg1(i,j) = 0.0</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          <span class="keywordflow">if</span> (lam &gt; 0.0) cg1(i,j) = 1.0 / sqrt(lam)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">present</span>(modal_structure)) <span class="keywordflow">then</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <span class="keywordflow">if</span> (mode_struct(1)/=0.) <span class="keywordflow">then</span> <span class="comment">! Normalize</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;              mode_struct(1:kc) = mode_struct(1:kc) / mode_struct(1)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;              mode_struct(1:kc)=0.</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;            <span class="keyword">call </span>remapping_core_h(cs%remapping_CS, kc, hc, mode_struct, nz, h(i,j,:), modal_structure(i,j,:))</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          cg1(i,j) = 0.0</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">present</span>(modal_structure)) modal_structure(i,j,:) = 0.</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! cg1 /= 0.0</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      cg1(i,j) = 0.0 <span class="comment">! This is a land point.</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">present</span>(modal_structure)) modal_structure(i,j,:) = 0.</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i-loop</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a72302e356c47c5055ba0b1a8714c772a_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a72302e356c47c5055ba0b1a8714c772a_icgraph.svg" width="100%" height="408"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a46e21529ec8098b0b19053afa133b971"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a46e21529ec8098b0b19053afa133b971">&#9670;&nbsp;</a></span>wave_speed_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_wave_speed::wave_speed_init </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__wave__speed_1_1wave__speed__cs.html">wave_speed_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>use_ebt_mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_column_fraction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_depth</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize control structure for MOM_wave_speed. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for MOM_wave_speed</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">use_ebt_mode</td><td>If true, use the equivalent barotropic mode instead of the first baroclinic mode.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_column_fraction</td><td>The lower fraction of water column over which N2 is limited as monotonic for the purposes of calculating vertical modal structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_depth</td><td>The depth below which N2 is limited as monotonic for the purposes of calculating vertical modal structure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l01085">1085</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__wave__speed_8F90_source.html#l01113">wave_speed_set_param()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diagnostics_8F90_source.html#l01115">mom_diagnostics::mom_diagnostics_init()</a>, and <a class="el" href="MOM__lateral__mixing__coeffs_8F90_source.html#l00724">mom_lateral_mixing_coeffs::varmix_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <span class="keywordtype">type</span>(wave_speed_cs), <span class="keywordtype">pointer</span> :: cs<span class="comment"> !&lt; Control structure for MOM_wave_speed</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: use_ebt_mode<span class="comment">  !&lt; If true, use the equivalent</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment">                                     !! barotropic mode instead of the first baroclinic mode.</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: mono_n2_column_fraction<span class="comment"> !&lt; The lower fraction of water column over which N2 is limited</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;<span class="comment">                                     !! as monotonic for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: mono_n2_depth<span class="comment"> !&lt; The depth below which N2 is limited</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="comment">                                      !! as monotonic for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_wave_speed&quot;</span>  <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;wave_speed_init called with an &quot;</span>// &amp;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="comment">! Write all relevant parameters to the model log.</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;  <span class="keyword">call </span>log_version(mdl, version)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;  <span class="keyword">call </span>wave_speed_set_param(cs, use_ebt_mode=use_ebt_mode, mono_n2_column_fraction=mono_n2_column_fraction)</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="keyword">call </span>initialize_remapping(cs%remapping_CS, <span class="stringliteral">&#39;PLM&#39;</span>, boundary_extrapolation=.false.)</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a46e21529ec8098b0b19053afa133b971_cgraph.svg" width="400" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a46e21529ec8098b0b19053afa133b971_icgraph.svg" width="391" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a035c9e3306d6b21809e240a5b24a2db0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a035c9e3306d6b21809e240a5b24a2db0">&#9670;&nbsp;</a></span>wave_speed_set_param()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_wave_speed::wave_speed_set_param </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__wave__speed_1_1wave__speed__cs.html">wave_speed_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>use_ebt_mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_column_fraction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>mono_N2_depth</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Sets internal parameters for MOM_wave_speed. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for MOM_wave_speed</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">use_ebt_mode</td><td>If true, use the equivalent barotropic mode instead of the first baroclinic mode.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_column_fraction</td><td>The lower fraction of water column over which N2 is limited as monotonic for the purposes of calculating vertical modal structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mono_n2_depth</td><td>The depth below which N2 is limited as monotonic for the purposes of calculating vertical modal structure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l01113">1113</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__wave__speed_8F90_source.html#l01085">wave_speed_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="keywordtype">type</span>(wave_speed_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment"> !&lt; Control structure for MOM_wave_speed</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: use_ebt_mode<span class="comment">  !&lt; If true, use the equivalent</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="comment">                                      !! barotropic mode instead of the first baroclinic mode.</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: mono_n2_column_fraction<span class="comment"> !&lt; The lower fraction of water column over which N2 is limited</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="comment">                                      !! as monotonic for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: mono_n2_depth<span class="comment"> !&lt; The depth below which N2 is limited</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="comment">                                      !! as monotonic for the purposes of calculating vertical modal structure.</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;     <span class="stringliteral">&quot;wave_speed_set_param called with an associated control structure.&quot;</span>)</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(use_ebt_mode)) cs%use_ebt_mode=use_ebt_mode</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(mono_n2_column_fraction)) cs%mono_N2_column_fraction=mono_n2_column_fraction</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(mono_n2_depth)) cs%mono_N2_depth=mono_n2_depth</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a035c9e3306d6b21809e240a5b24a2db0_icgraph.svg" width="610" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a0009abd8573168b780c95db2962982d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0009abd8573168b780c95db2962982d6">&#9670;&nbsp;</a></span>wave_speeds()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_wave_speed::wave_speeds </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nmodes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(g%isd:g%ied,g%jsd:g%jed,nmodes), intent(out)&#160;</td>
          <td class="paramname"><em>cn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__wave__speed_1_1wave__speed__cs.html">wave_speed_cs</a>), optional, pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>full_halos</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the wave speeds for the first few barolinic modes. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness (m or kg/m2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamic variables</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nmodes</td><td>Number of modes</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">cn</td><td>Waves speeds (m/s)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for MOM_wave_speed</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">full_halos</td><td>If true, do the calculation over the entire computational domain. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__wave__speed_8F90_source.html#l00505">505</a> of file <a class="el" href="MOM__wave__speed_8F90_source.html">MOM_wave_speed.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__wave__speed_8F90_source.html#l01047">tridiag_det()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00235">mom_diabatic_driver::diabatic()</a>.</p>
<div class="fragment"><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(in)</span>  :: g<span class="comment"> !&lt; Ocean grid structure</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>  :: gv<span class="comment"> !&lt; Vertical grid structure</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>  :: h<span class="comment"> !&lt; Layer thickness (m or kg/m2)</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                    <span class="keywordtype">intent(in)</span>  :: tv<span class="comment"> !&lt; Thermodynamic variables</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>  :: nmodes<span class="comment"> !&lt; Number of modes</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(G%isd:G%ied,G%jsd:G%jed,nmodes)</span>, <span class="keywordtype">intent(out)</span> :: cn<span class="comment"> !&lt; Waves speeds (m/s)</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <span class="keywordtype">type</span>(wave_speed_cs), <span class="keywordtype">optional</span>,            <span class="keywordtype">pointer</span>     :: cs<span class="comment"> !&lt; Control structure for MOM_wave_speed</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="keywordtype">logical</span>,             <span class="keywordtype">optional</span>,            <span class="keywordtype">intent(in)</span>  :: full_halos<span class="comment"> !&lt; If true, do the calculation</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">                                                                      !! over the entire computational domain.</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    drho_dt, drho_ds, &amp;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    pres, t_int, s_int, &amp;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    gprime        <span class="comment">! The reduced gravity across each interface, in m s-2.</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    igl, igu      <span class="comment">! The inverse of the reduced gravity across an interface times</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                  <span class="comment">! the thickness of the layer below (Igl) or above (Igu) it,</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                  <span class="comment">! in units of s2 m-2.</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G)-1)</span> :: &amp;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    a_diag, b_diag, c_diag</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                  <span class="comment">! diagonals of tridiagonal matrix; one value for each</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                  <span class="comment">! interface (excluding surface and bottom)</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G),SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    hf, tf, sf, rf</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    hc, tc, sc, rc</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: c1_thresh = 0.01</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                          <span class="comment">! if c1 is below this value, don&#39;t bother calculating</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                          <span class="comment">! cn values for higher modes</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keywordtype">real</span> :: det, ddet       <span class="comment">! determinant &amp; its derivative of eigen system</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordtype">real</span> :: lam_1           <span class="comment">! approximate mode-1 eigen value</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordtype">real</span> :: lam_n           <span class="comment">! approximate mode-n eigen value</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <span class="keywordtype">real</span> :: dlam            <span class="comment">! increment in lam for Newton&#39;s method</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keywordtype">real</span> :: lammin          <span class="comment">! minimum lam value for root searching range</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordtype">real</span> :: lammax          <span class="comment">! maximum lam value for root searching range</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  <span class="keywordtype">real</span> :: laminc          <span class="comment">! width of moving window for root searching</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  <span class="keywordtype">real</span> :: det_l,det_r     <span class="comment">! determinant value at left and right of window</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">real</span> :: ddet_l,ddet_r   <span class="comment">! derivative of determinant at left and right of window</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordtype">real</span> :: det_sub,ddet_sub<span class="comment">! derivative of determinant at subinterval endpoint</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="keywordtype">real</span> :: xl,xr           <span class="comment">! lam guesses at left and right of window</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="keywordtype">real</span> :: xl_sub          <span class="comment">! lam guess at left of subinterval window</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordtype">real</span>,<span class="keywordtype">dimension(nmodes)</span> :: &amp;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;          xbl,xbr         <span class="comment">! lam guesses bracketing a zero-crossing (root)</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="keywordtype">integer</span> :: numint       <span class="comment">! number of widows (intervals) in root searching range</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="keywordtype">integer</span> :: nrootsfound  <span class="comment">! number of extra roots found (not including 1st root)</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="keywordtype">real</span> :: min_h_frac</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  <span class="keywordtype">real</span> :: h_to_pres</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="keywordtype">real</span> :: h_to_m     <span class="comment">! Local copy of a unit conversion factor.</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: &amp;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    htot, hmin, &amp;    <span class="comment">! Thicknesses in m.</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    h_here, hxt_here, hxs_here, hxr_here</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordtype">real</span> :: speed2_tot <span class="comment">! overestimate of the mode-1 speed squared, m2 s-2</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordtype">real</span> :: speed2_min <span class="comment">! minimum mode speed (squared) to consider in root searching</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: reduct_factor = 0.5</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                     <span class="comment">! factor used in setting speed2_min</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="keywordtype">real</span> :: i_hnew, drxh_sum</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: tol1  = 0.0001, tol2 = 0.001</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">dimension(:,:,:)</span> :: t, s</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  <span class="keywordtype">real</span> :: g_rho0  <span class="comment">! G_Earth/Rho0 in m4 s-2 kg-1.</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <span class="keywordtype">integer</span> :: kf(szi_(g))</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: max_itt = 10</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="keywordtype">logical</span> :: use_eos    <span class="comment">! If true, density is calculated from T &amp; S using an</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                        <span class="comment">! equation of state.</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G)+1)</span> :: z_int, n2</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="keywordtype">integer</span> :: nsub       <span class="comment">! number of subintervals used for root finding</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: sub_it_max = 4</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                        <span class="comment">! maximum number of times to subdivide interval</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                        <span class="comment">! for root finding (# intervals = 2**sub_it_max)</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="keywordtype">logical</span> :: sub_rootfound <span class="comment">! if true, subdivision has located root</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="keywordtype">integer</span> :: kc, nrows</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="keywordtype">integer</span> :: sub, sub_it</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, k2, itt, is, ie, js, je, nz, row, iint, m, ig, jg</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keywordtype">integer</span> :: ig_need_sub, jg_need_sub <span class="comment">! for debugging (BDM)</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_wave_speed: &quot;</span>// &amp;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;           <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(full_halos)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (full_halos) <span class="keywordflow">then</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    is = g%isd ; ie = g%ied ; js = g%jsd ; je = g%jed</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  s =&gt; tv%S ; t =&gt; tv%T</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  g_rho0 = gv%g_Earth/gv%Rho0</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  use_eos = <span class="keyword">associated</span>(tv%eqn_of_state)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  h_to_pres = gv%g_Earth * gv%Rho0</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  h_to_m = gv%H_to_m</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  min_h_frac = tol1 / <span class="keywordtype">real</span>(nz)</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,h,G,GV,min_h_frac,use_EOS,T,S,   &amp;</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="comment">!$OMP                                  H_to_pres,H_to_m,tv,cn,g_Rho0,nmodes)           &amp;</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">!$OMP                          private(htot,hmin,kf,H_here,HxT_here,HxS_here,HxR_here, &amp;</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="comment">!$OMP                                  Hf,Tf,Sf,Rf,pres,T_int,S_int,drho_dT,           &amp;</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">!$OMP                                  drho_dS,drxh_sum,kc,Hc,Tc,Sc,I_Hnew,gprime,     &amp;</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="comment">!$OMP                                  Rc,speed2_tot,Igl,Igu,dlam,                     &amp;</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">!$OMP                                  det,ddet,ig,jg,z_int,N2,row,nrows,lam_1,        &amp;</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">!$OMP                                  lamMin,speed2_min,lamMax,lamInc,numint,det_l,   &amp;</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">!$OMP                                  ddet_l,xr,xl,det_r,xbl,xbr,ddet_r,xl_sub,       &amp;</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="comment">!$OMP                                  ig_need_sub,jg_need_sub,sub_rootfound,nsub,     &amp;</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">!$OMP                                  det_sub,ddet_sub,lam_n,                         &amp;</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">!$OMP                                  a_diag,b_diag,c_diag,nrootsfound)</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="comment">!   First merge very thin layers with the one above (or below if they are</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="comment">! at the top).  This also transposes the row order so that columns can</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="comment">! be worked upon one at a time.</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; htot(i) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie ; htot(i) = htot(i) + h(i,j,k)*h_to_m ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;      hmin(i) = htot(i)*min_h_frac ; kf(i) = 1 ; h_here(i) = 0.0</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      hxt_here(i) = 0.0 ; hxs_here(i) = 0.0 ; hxr_here(i) = 0.0</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">if</span> ((h_here(i) &gt; hmin(i)) .and. (h(i,j,k)*h_to_m &gt; hmin(i))) <span class="keywordflow">then</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;          hf(kf(i),i) = h_here(i)</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          tf(kf(i),i) = hxt_here(i) / h_here(i)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;          sf(kf(i),i) = hxs_here(i) / h_here(i)</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;          kf(i) = kf(i) + 1</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;          <span class="comment">! Start a new layer</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;          h_here(i) = h(i,j,k)*h_to_m</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;          hxt_here(i) = (h(i,j,k)*h_to_m)*t(i,j,k)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;          hxs_here(i) = (h(i,j,k)*h_to_m)*s(i,j,k)</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;          h_here(i) = h_here(i) + h(i,j,k)*h_to_m</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;          hxt_here(i) = hxt_here(i) + (h(i,j,k)*h_to_m)*t(i,j,k)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;          hxs_here(i) = hxs_here(i) + (h(i,j,k)*h_to_m)*s(i,j,k)</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h_here(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        hf(kf(i),i) = h_here(i)</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        tf(kf(i),i) = hxt_here(i) / h_here(i)</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        sf(kf(i),i) = hxs_here(i) / h_here(i)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">if</span> ((h_here(i) &gt; hmin(i)) .and. (h(i,j,k)*h_to_m &gt; hmin(i))) <span class="keywordflow">then</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          hf(kf(i),i) = h_here(i) ; rf(kf(i),i) = hxr_here(i) / h_here(i)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;          kf(i) = kf(i) + 1</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;          <span class="comment">! Start a new layer</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          h_here(i) = h(i,j,k)*h_to_m</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;          hxr_here(i) = (h(i,j,k)*h_to_m)*gv%Rlay(k)</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;          h_here(i) = h_here(i) + h(i,j,k)*h_to_m</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;          hxr_here(i) = hxr_here(i) + (h(i,j,k)*h_to_m)*gv%Rlay(k)</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (h_here(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        hf(kf(i),i) = h_here(i) ; rf(kf(i),i) = hxr_here(i) / h_here(i)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="comment">! From this point, we can work on individual columns without causing memory</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="comment">! to have page faults.</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;        <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          pres(1) = 0.0</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            pres(k) = pres(k-1) + h_to_pres*hf(k-1,i)</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;            t_int(k) = 0.5*(tf(k,i)+tf(k-1,i))</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;            s_int(k) = 0.5*(sf(k,i)+sf(k-1,i))</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;          <span class="keyword">call </span>calculate_density_derivs(t_int, s_int, pres, drho_dt, drho_ds, 2, &amp;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                                        kf(i)-1, tv%eqn_of_state)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;          <span class="comment">! Sum the reduced gravities to find out how small a density difference</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;          <span class="comment">! is negligibly small.</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;          drxh_sum = 0.0</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;          <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            drxh_sum = drxh_sum + 0.5*(hf(k-1,i)+hf(k,i)) * &amp;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                max(0.0,drho_dt(k)*(tf(k,i)-tf(k-1,i)) + &amp;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                        drho_ds(k)*(sf(k,i)-sf(k-1,i)))</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;          drxh_sum = 0.0</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;          <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            drxh_sum = drxh_sum + 0.5*(hf(k-1,i)+hf(k,i)) * &amp;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                              max(0.0,rf(k,i)-rf(k-1,i))</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="comment">!   Find gprime across each internal interface, taking care of convective</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="comment">! instabilities by merging layers.</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="keywordflow">if</span> (drxh_sum &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;          cn(i,j,:) = 0.0</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;          <span class="comment">! Merge layers to eliminate convective instabilities or exceedingly</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          <span class="comment">! small reduced gravities.</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;          <span class="keywordflow">if</span> (use_eos) <span class="keywordflow">then</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            kc = 1</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            hc(1) = hf(1,i) ; tc(1) = tf(1,i) ; sc(1) = sf(1,i)</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;              <span class="keywordflow">if</span> ((drho_dt(k)*(tf(k,i)-tc(kc)) + drho_ds(k)*(sf(k,i)-sc(kc))) * &amp;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                  (hc(kc) + hf(k,i)) &lt; 2.0 * tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                <span class="comment">! Merge this layer with the one above and backtrack.</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                i_hnew = 1.0 / (hc(kc) + hf(k,i))</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                tc(kc) = (hc(kc)*tc(kc) + hf(k,i)*tf(k,i)) * i_hnew</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                sc(kc) = (hc(kc)*sc(kc) + hf(k,i)*sf(k,i)) * i_hnew</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;                hc(kc) = (hc(kc) + hf(k,i))</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                <span class="comment">! Backtrack to remove any convective instabilities above...  Note</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                <span class="comment">! that the tolerance is a factor of two larger, to avoid limit how</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                <span class="comment">! far back we go.</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                <span class="keywordflow">do</span> k2=kc,2,-1</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                  <span class="keywordflow">if</span> ((drho_dt(k2)*(tc(k2)-tc(k2-1)) + drho_ds(k2)*(sc(k2)-sc(k2-1))) * &amp;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                      (hc(k2) + hc(k2-1)) &lt; tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                    <span class="comment">! Merge the two bottommost layers.  At this point kc = k2.</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                    i_hnew = 1.0 / (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                    tc(kc-1) = (hc(kc)*tc(kc) + hc(kc-1)*tc(kc-1)) * i_hnew</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                    sc(kc-1) = (hc(kc)*sc(kc) + hc(kc-1)*sc(kc-1)) * i_hnew</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                    hc(kc-1) = (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                    kc = kc - 1</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                  <span class="keywordflow">else</span> ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="keywordflow">                enddo</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                <span class="comment">! Add a new layer to the column.</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                kc = kc + 1</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                drho_ds(kc) = drho_ds(k) ; drho_dt(kc) = drho_dt(k)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                tc(kc) = tf(k,i) ; sc(kc) = sf(k,i) ; hc(kc) = hf(k,i)</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <span class="comment">! At this point there are kc layers and the gprimes should be positive.</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            <span class="keywordflow">do</span> k=2,kc <span class="comment">! Revisit this if non-Boussinesq.</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;              gprime(k) = g_rho0 * (drho_dt(k)*(tc(k)-tc(k-1)) + &amp;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                                    drho_ds(k)*(sc(k)-sc(k-1)))</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          <span class="keywordflow">else</span>  <span class="comment">! .not.use_EOS</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            <span class="comment">! Do the same with density directly...</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;            kc = 1</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;            hc(1) = hf(1,i) ; rc(1) = rf(1,i)</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            <span class="keywordflow">do</span> k=2,kf(i)</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;              <span class="keywordflow">if</span> ((rf(k,i) - rc(kc)) * (hc(kc) + hf(k,i)) &lt; 2.0*tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                <span class="comment">! Merge this layer with the one above and backtrack.</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                rc(kc) = (hc(kc)*rc(kc) + hf(k,i)*rf(k,i)) / (hc(kc) + hf(k,i))</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                hc(kc) = (hc(kc) + hf(k,i))</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                <span class="comment">! Backtrack to remove any convective instabilities above...  Note</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                <span class="comment">! that the tolerance is a factor of two larger, to avoid limit how</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                <span class="comment">! far back we go.</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                <span class="keywordflow">do</span> k2=kc,2,-1</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                  <span class="keywordflow">if</span> ((rc(k2)-rc(k2-1)) * (hc(k2)+hc(k2-1)) &lt; tol2*drxh_sum) <span class="keywordflow">then</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;                    <span class="comment">! Merge the two bottommost layers.  At this point kc = k2.</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                    rc(kc-1) = (hc(kc)*rc(kc) + hc(kc-1)*rc(kc-1)) / (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                    hc(kc-1) = (hc(kc) + hc(kc-1))</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                    kc = kc - 1</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                  <span class="keywordflow">else</span> ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="keywordflow">                enddo</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                <span class="comment">! Add a new layer to the column.</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                kc = kc + 1</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                rc(kc) = rf(k,i) ; hc(kc) = hf(k,i)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            <span class="comment">! At this point there are kc layers and the gprimes should be positive.</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            <span class="keywordflow">do</span> k=2,kc <span class="comment">! Revisit this if non-Boussinesq.</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;              gprime(k) = g_rho0 * (rc(k)-rc(k-1))</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="keywordflow">          endif</span>  <span class="comment">! use_EOS</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;          <span class="comment">!-----------------NOW FIND WAVE SPEEDS---------------------------------------</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;          ig = i + g%idg_offset ; jg = j + g%jdg_offset</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;          <span class="comment">!   Sum the contributions from all of the interfaces to give an over-estimate</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;          <span class="comment">! of the first-mode wave speed.</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;          <span class="keywordflow">if</span> (kc &gt;= 2) <span class="keywordflow">then</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <span class="comment">! Set depth at surface</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            z_int(1) = 0.0</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            <span class="comment">! initialize speed2_tot</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            speed2_tot = 0.0</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            <span class="comment">! Calculate Igu, Igl, depth, and N2 at each interior interface</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            <span class="comment">! [excludes surface (K=1) and bottom (K=kc+1)]</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;            <span class="keywordflow">do</span> k=2,kc</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;              igl(k) = 1.0/(gprime(k)*hc(k)) ; igu(k) = 1.0/(gprime(k)*hc(k-1))</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;              z_int(k) = z_int(k-1) + hc(k-1)</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;              n2(k) = gprime(k)/(0.5*(hc(k)+hc(k-1)))</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;              speed2_tot = speed2_tot + gprime(k)*(hc(k-1)+hc(k))</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;            <span class="comment">! Set stratification for surface and bottom (setting equal to nearest interface for now)</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            n2(1) = n2(2) ; n2(kc+1) = n2(kc)</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;            <span class="comment">! Calcualte depth at bottom</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            z_int(kc+1) = z_int(kc)+hc(kc)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;            <span class="comment">! check that thicknesses sum to total depth</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;            <span class="keywordflow">if</span> (abs(z_int(kc+1)-htot(i)) &gt; 1.e-10) <span class="keywordflow">then</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;              <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;wave_structure: mismatch in total depths&quot;</span>)</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;              print *, <span class="stringliteral">&quot;kc=&quot;</span>, kc</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;              print *, <span class="stringliteral">&quot;z_int(kc+1)=&quot;</span>, z_int(kc+1)</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;              print *, <span class="stringliteral">&quot;htot(i)=&quot;</span>, htot(i)</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            <span class="comment">! Define the diagonals of the tridiagonal matrix</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            <span class="comment">! First, populate interior rows</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;            <span class="keywordflow">do</span> k=3,kc-1</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;              row = k-1 <span class="comment">! indexing for TD matrix rows</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;              a_diag(row) = (-igu(k))</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;              b_diag(row) = (igu(k)+igl(k))</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;              c_diag(row) = (-igl(k))</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            <span class="comment">! Populate top row of tridiagonal matrix</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;            k=2 ; row = k-1</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;            a_diag(row) = 0.0</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;            b_diag(row) = (igu(k)+igl(k))</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;            c_diag(row) = (-igl(k))</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            <span class="comment">! Populate bottom row of tridiagonal matrix</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            k=kc ; row = k-1</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            a_diag(row) = (-igu(k))</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            b_diag(row) = (igu(k)+igl(k))</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            c_diag(row) = 0.0</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            <span class="comment">! Total number of rows in the matrix = number of interior interfaces</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            nrows = kc-1</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            <span class="comment">! Under estimate the first eigen value to start with.</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            lam_1 = 1.0 / speed2_tot</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;            <span class="comment">! Find the first eigen value</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;            <span class="keywordflow">do</span> itt=1,max_itt</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;              <span class="comment">! calculate the determinant of (A-lam_1*I)</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;              <span class="keyword">call </span>tridiag_det(a_diag(1:nrows),b_diag(1:nrows),c_diag(1:nrows), &amp;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                                      nrows,lam_1,det,ddet)</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;              <span class="comment">! Use Newton&#39;s method iteration to find a new estimate of lam_1</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;              <span class="comment">!det = det_it(itt) ; ddet = ddet_it(itt)</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;              <span class="keywordflow">if</span> ((ddet &gt;= 0.0) .or. (-det &gt; -0.5*lam_1*ddet)) <span class="keywordflow">then</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                <span class="comment">! lam_1 was not an under-estimate, as intended, so Newton&#39;s method</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                <span class="comment">! may not be reliable; lam_1 must be reduced, but not by more</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                <span class="comment">! than half.</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                lam_1 = 0.5 * lam_1</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;              <span class="keywordflow">else</span>  <span class="comment">! Newton&#39;s method is OK.</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                dlam = - det / ddet</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                lam_1 = lam_1 + dlam</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                <span class="keywordflow">if</span> (abs(dlam) &lt; tol2*lam_1) <span class="keywordflow">then</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                  <span class="comment">! calculate 1st mode speed</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                  <span class="keywordflow">if</span> (lam_1 &gt; 0.0) cn(i,j,1) = 1.0 / sqrt(lam_1)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                  <span class="keywordflow">exit</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            <span class="comment">! print resutls (for debugging only)</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;            <span class="comment">!if(ig .eq. 83 .and. jg .eq. 2) then</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            <span class="comment">!  if(nmodes&gt;1)then</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            <span class="comment">!    print *,  &quot;Results after finding first mode:&quot;</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            <span class="comment">!    print *, &quot;first guess at lam_1=&quot;, 1./speed2_tot</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            <span class="comment">!    print *, &quot;final guess at lam_1=&quot;, lam_1</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            <span class="comment">!    print *, &quot;det value after iterations, det=&quot;, det</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            <span class="comment">!    print *, &quot;ddet value after iterations, det=&quot;, ddet</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;            <span class="comment">!    print *, &quot;final guess at c1=&quot;, cn(i,j,1)</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;            <span class="comment">!    print *, &quot;a_diag=&quot;,a_diag(1:nrows)</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;            <span class="comment">!    print *, &quot;b_diag=&quot;,b_diag(1:nrows)</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;            <span class="comment">!    print *, &quot;c_diag=&quot;,c_diag(1:nrows)</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;            <span class="comment">!    !stop</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            <span class="comment">!  endif</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            <span class="comment">!endif</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;            <span class="comment">! Find other eigen values if c1 is of significant magnitude, &gt; cn_thresh</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            nrootsfound = 0    <span class="comment">! number of extra roots found (not including 1st root)</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;            <span class="keywordflow">if</span> (nmodes&gt;1 .and. kc&gt;=nmodes+1 .and. cn(i,j,1)&gt;c1_thresh) <span class="keywordflow">then</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;              <span class="comment">! Set the the range to look for the other desired eigen values</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;              <span class="comment">! set min value just greater than the 1st root (found above)</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;              lammin = lam_1*(1.0 + tol2)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;              <span class="comment">! set max value based on a low guess at wavespeed for highest mode</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;              speed2_min = (reduct_factor*cn(i,j,1)/<span class="keywordtype">real</span>(nmodes))**2</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;              lammax = 1.0 / speed2_min</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;              <span class="comment">! set width of interval (not sure about this - BDM)</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;              laminc = 0.5*lam_1</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;              <span class="comment">! set number of intervals within search range</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;              numint = nint((lammax - lammin)/laminc)</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;              <span class="comment">!if(ig .eq. 144 .and. jg .eq. 5) then</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;              <span class="comment">!  print *, &#39;Looking for other eigenvalues at&#39;, ig, jg</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;              <span class="comment">!  print *, &#39;Wave_speed: lamMin=&#39;,         lamMin</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;              <span class="comment">!  print *, &#39;Wave_speed: cnMax=&#39;,          1/sqrt(lamMin)</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;              <span class="comment">!  print *, &#39;Wave_speed: lamMax=&#39;,         lamMax</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;              <span class="comment">!  print *, &#39;Wave_speed: cnMin=&#39;,          1/sqrt(lamMax)</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;              <span class="comment">!  print *, &#39;Wave_speed: lamInc=&#39;,         lamInc</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;              <span class="comment">!endif</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;              <span class="comment">!   Find intervals containing zero-crossings (roots) of the determinant</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;              <span class="comment">! that are beyond the first root</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;              <span class="comment">! find det_l of first interval (det at left endpoint)</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;              <span class="keyword">call </span>tridiag_det(a_diag(1:nrows),b_diag(1:nrows),c_diag(1:nrows), &amp;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                               nrows,lammin,det_l,ddet_l)</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;              <span class="comment">! move interval window looking for zero-crossings************************</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;              <span class="keywordflow">do</span> iint=1,numint</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                xr = lammin + laminc * iint</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                xl = xr - laminc</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                <span class="keyword">call </span>tridiag_det(a_diag(1:nrows),b_diag(1:nrows),c_diag(1:nrows), &amp;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                                 nrows,xr,det_r,ddet_r)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                <span class="comment">!if(ig .eq. 83 .and. jg .eq. 2) then</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                <span class="comment">!  print *, &quot;Move interval&quot;</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                <span class="comment">!  print *, &quot;iint=&quot;,iint</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                <span class="comment">!  print *, &quot;@ xr=&quot;,xr</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                <span class="comment">!  print *, &quot;det_r=&quot;,det_r</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                <span class="comment">!  print *, &quot;ddet_r=&quot;,ddet_r</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                <span class="comment">!endif</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                <span class="keywordflow">if</span> (det_l*det_r &lt; 0.0) <span class="keywordflow">then</span>  <span class="comment">! if function changes sign</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                  <span class="keywordflow">if</span> (det_l*ddet_l &lt; 0.0) <span class="keywordflow">then</span> <span class="comment">! if function at left is headed to zero</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                    nrootsfound = nrootsfound + 1</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                    xbl(nrootsfound) = xl</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                    xbr(nrootsfound) = xr</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                    <span class="comment">!if(ig .eq. 144 .and. jg .eq. 5) then</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                    <span class="comment">!  print *, &quot;Root located without subdivision!&quot;</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                    <span class="comment">!  print *, &quot;between xbl=&quot;,xl,&quot;and xbr=&quot;,xr</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                    <span class="comment">!endif</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                  <span class="keywordflow">else</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                    <span class="comment">!   function changes sign but has a local max/min in interval,</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                    <span class="comment">! try subdividing interval as many times as necessary (or sub_it_max).</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                    <span class="comment">! loop that increases number of subintervals:</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                    <span class="comment">!call MOM_error(WARNING, &quot;determinant changes sign&quot;// &amp;</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                    <span class="comment">!            &quot;but has a local max/min in interval;&quot;//&amp;</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                    <span class="comment">!            &quot; reduce increment in lam.&quot;)</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                    ig_need_sub = i + g%idg_offset ; jg_need_sub = j + g%jdg_offset</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                    <span class="comment">! begin subdivision loop -------------------------------------------</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                    <span class="comment">!print *, &quot;subdividing interval at ig=&quot;,ig_need_sub,&quot;jg=&quot;,jg_need_sub</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                    sub_rootfound = .false. <span class="comment">! initialize</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                    <span class="keywordflow">do</span> sub_it=1,sub_it_max</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                      nsub = 2**sub_it <span class="comment">! number of subintervals; nsub=2,4,8,...</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                      <span class="comment">! loop over each subinterval:</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                      <span class="keywordflow">do</span> sub=1,nsub-1,2 <span class="comment">! only check odds; sub = 1; 1,3; 1,3,5,7;...</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                        xl_sub = xl + laminc/(nsub)*sub</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                        <span class="keyword">call </span>tridiag_det(a_diag(1:nrows),b_diag(1:nrows),c_diag(1:nrows), &amp;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                                 nrows,xl_sub,det_sub,ddet_sub)</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                        <span class="keywordflow">if</span> (det_sub*det_r &lt; 0.0) <span class="keywordflow">then</span>  <span class="comment">! if function changes sign</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                          <span class="keywordflow">if</span> (det_sub*ddet_sub &lt; 0.0) <span class="keywordflow">then</span> <span class="comment">! if function at left is headed to zero</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                            sub_rootfound = .true.</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                            nrootsfound = nrootsfound + 1</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                            xbl(nrootsfound) = xl_sub</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                            xbr(nrootsfound) = xr</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                            <span class="comment">!if(ig .eq. 144 .and. jg .eq. 5) then</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                            <span class="comment">!  print *, &quot;Root located after subdiving&quot;,sub_it,&quot; times!&quot;</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                            <span class="comment">!  print *, &quot;between xbl=&quot;,xl_sub,&quot;and xbr=&quot;,xr</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                            <span class="comment">!endif</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                            <span class="keywordflow">exit</span> <span class="comment">! exit sub loop</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keywordflow">                          endif</span> <span class="comment">! headed toward zero</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="keywordflow">                        endif</span> <span class="comment">! sign change</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="keywordflow">                      enddo</span> <span class="comment">! sub-loop</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                      <span class="keywordflow">if</span> (sub_rootfound) <span class="keywordflow">exit</span> <span class="comment">! root has been found, exit sub_it loop</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                      <span class="comment">!   Otherwise, function changes sign but has a local max/min in one of the</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                      <span class="comment">! sub intervals, try subdividing again unless sub_it_max has been reached.</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                      <span class="keywordflow">if</span> (sub_it == sub_it_max) <span class="keywordflow">then</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                        <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;wave_speed: root not found &quot;</span>// &amp;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                                       <span class="stringliteral">&quot; after sub_it_max subdivisions of original&quot;</span>// &amp;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                                       <span class="stringliteral">&quot; interval.&quot;</span>)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                        <span class="comment">!if(ig .eq. 144 .and. jg .eq. 5) then</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                          <span class="comment">!print *, &quot;xbl=&quot;,xbl</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                          <span class="comment">!print *, &quot;xbr=&quot;,xbr</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                          <span class="comment">!print *, &quot;Wave_speed: kc=&quot;,kc</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: z_int(ig,jg)=&#39;,   z_int(1:kc+1)</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: N2(ig,jg)=&#39;,      N2(1:kc+1)</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: gprime=&#39;,         gprime(1:kc+1)</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: htot=&#39;,           htot(i)</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: cn1=&#39;,            cn(i,j,1)</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: numint=&#39;,         numint</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                          <span class="comment">!print *, &#39;Wave_speed: nrootsfound=&#39;,    nrootsfound</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;                          <span class="comment">!stop</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                        <span class="comment">!endif</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="keywordflow">                      endif</span> <span class="comment">! sub_it == sub_it_max</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="keywordflow">                    enddo</span> <span class="comment">! sub_it-loop-------------------------------------------------</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="keywordflow">                  endif</span> <span class="comment">! det_l*ddet_l &lt; 0.0</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="keywordflow">                endif</span> <span class="comment">! det_l*det_r &lt; 0.0</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                <span class="comment">! exit iint-loop if all desired roots have been found</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                <span class="keywordflow">if</span> (nrootsfound &gt;= nmodes-1) <span class="keywordflow">then</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                  <span class="comment">! exit if all additional roots found</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                  <span class="keywordflow">exit</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                <span class="keywordflow">elseif</span> (iint == numint) <span class="keywordflow">then</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                  <span class="comment">! oops, lamMax not large enough - could add code to increase (BDM)</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                  <span class="comment">! set unfound modes to zero for now (BDM)</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                  cn(i,j,nrootsfound+2:nmodes) = 0.0</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                  <span class="comment">!if(ig .eq. 83 .and. jg .eq. 2) then</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                  <span class="comment">!  call MOM_error(WARNING, &quot;wave_speed: not all modes found &quot;// &amp;</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                  <span class="comment">!                       &quot; within search range: increase numint.&quot;)</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                  <span class="comment">!  print *, &quot;Increase lamMax at ig=&quot;,ig,&quot; jg=&quot;,jg</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                  <span class="comment">!  print *, &quot;where lamMax=&quot;, lamMax</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                  <span class="comment">!  print *, &#39;numint=&#39;,       numint</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                  <span class="comment">!  print *, &quot;nrootsfound=&quot;,  nrootsfound</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                  <span class="comment">!  print *, &quot;xbl=&quot;,xbl</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                  <span class="comment">!  print *, &quot;xbr=&quot;,xbr</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                    <span class="comment">!print *, &quot;kc=&quot;,kc</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                    <span class="comment">!print *, &#39;z_int(ig,jg)=&#39;,   z_int(1:kc+1)</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                    <span class="comment">!print *, &#39;N2(ig,jg)=&#39;,      N2(1:kc+1)</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                    <span class="comment">!stop</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                  <span class="comment">!endif</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                  <span class="comment">! else shift interval and keep looking until nmodes or numint is reached</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                  det_l = det_r</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                  ddet_l = ddet_r</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="keywordflow">              enddo</span> <span class="comment">! iint-loop</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;              <span class="comment">! Use Newton&#39;s method to find the roots within the identified windows</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;              <span class="keywordflow">do</span> m=1,nrootsfound <span class="comment">! loop over the root-containing widows (excluding 1st mode)</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                lam_n = xbl(m) <span class="comment">! first guess is left edge of window</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                <span class="keywordflow">do</span> itt=1,max_itt</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                  <span class="comment">! calculate the determinant of (A-lam_n*I)</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                  <span class="keyword">call </span>tridiag_det(a_diag(1:nrows),b_diag(1:nrows),c_diag(1:nrows), &amp;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                                   nrows,lam_n,det,ddet)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                  <span class="comment">! Use Newton&#39;s method to find a new estimate of lam_n</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                  dlam = - det / ddet</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                  lam_n = lam_n + dlam</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                  <span class="keywordflow">if</span> (abs(dlam) &lt; tol2*lam_1) <span class="keywordflow">then</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                    <span class="comment">! calculate nth mode speed</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                    <span class="keywordflow">if</span> (lam_n &gt; 0.0) cn(i,j,m+1) = 1.0 / sqrt(lam_n)</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                    <span class="keywordflow">exit</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="keywordflow">                  endif</span> <span class="comment">! within tol</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="keywordflow">                enddo</span> <span class="comment">! itt-loop</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="keywordflow">              enddo</span> <span class="comment">! n-loop</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;              cn(i,j,2:nmodes) = 0.0 <span class="comment">! else too small to worry about</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="keywordflow">            endif</span> <span class="comment">! if nmodes&gt;1 .and. kc&gt;nmodes .and. c1&gt;c1_thresh</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;            cn(i,j,:) = 0.0</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="keywordflow">          endif</span> <span class="comment">! if more than 2 layers</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;<span class="keywordflow">        endif</span> <span class="comment">! if drxh_sum &lt; 0</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        cn(i,j,:) = 0.0 <span class="comment">! This is a land point.</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! if not land</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;      <span class="comment">! ----- Spot check - comment out later (BDM) ----------</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;      <span class="comment">!ig = G%idg_offset + i</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;      <span class="comment">!jg = G%jdg_offset + j</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;      <span class="comment">!if (ig .eq. 83 .and. jg .eq. 2) then</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;      <span class="comment">!!  print *, &quot;nmodes=&quot;,nmodes</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;      <span class="comment">!  print *, &quot;lam_1=&quot;,lam_1</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;      <span class="comment">!  print *, &quot;lamMin=&quot;,lamMin</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;      <span class="comment">!  print *, &quot;lamMax=&quot;,lamMax</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="comment">!  print *, &quot;lamInc=&quot;,lamInc</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      <span class="comment">!  print *, &quot;nrootsfound=&quot;,nrootsfound</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      <span class="comment">!  do m=1,nmodes</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      <span class="comment">!    print *, &quot;c&quot;,m,&quot;= &quot;, cn(i,j,m)</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;      <span class="comment">!    print *, &quot;xbl&quot;,m,&quot;= &quot;, xbl(m)</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;      <span class="comment">!    print *, &quot;xbr&quot;,m,&quot;= &quot;, xbr(m)</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;      <span class="comment">!  enddo</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;      <span class="comment">!endif</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;      <span class="comment">!-------------------------------------------------------</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i-loop</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j-loop</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a0009abd8573168b780c95db2962982d6_cgraph.svg" width="428" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__wave__speed_a0009abd8573168b780c95db2962982d6_icgraph.svg" width="372" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__wave__speed.html">mom_wave_speed</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
