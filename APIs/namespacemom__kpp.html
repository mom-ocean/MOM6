<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_kpp Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__kpp.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_kpp Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Provides the K-Profile Parameterization (KPP) of Large et al., 1994, via CVMix. </p>
<h1><a class="anchor" id="section_KPP"></a>
The K-Profile Parameterization</h1>
<p>The K-Profile Parameterization (KPP) of Large et al., 1994, (<a href="http://dx.doi.org/10.1029/94RG01872">http://dx.doi.org/10.1029/94RG01872</a>) is implemented via the Community Vertical Mixing package, <a href="https://code.google.com/p/cvmix">CVmix</a>, which is called directly by this module.</p>
<p>The formulation and implementation of KPP is described in great detail in the <a href="https://cvmix.googlecode.com/svn/trunk/manual/cvmix.pdf">CVMix manual</a> (written by our own Stephen Griffies).</p>
<h2><a class="anchor" id="section_KPP_nutshell"></a>
KPP in a nutshell</h2>
<p>Large et al., 1994, decompose the parameterized boundary layer turbulent flux of a scalar, \( s \), as </p><p class="formulaDsp">
\[ \overline{w^\prime s^\prime} = -K \partial_z s + K \gamma_s(\sigma), \]
</p>
<p> where \( \sigma = -z/h \) is a non-dimensional coordinate within the boundary layer of depth \( h \). \( K \) is the eddy diffusivity and is a function of position within the boundary layer as well as a function of the surface forcing: </p><p class="formulaDsp">
\[ K = h w_s(\sigma) G(\sigma) . \]
</p>
<p> Here, \( w_s \) is the vertical velocity scale of the boundary layer turbulence and \( G(\sigma) \) is a "shape function" which is described later. The last term is the "non-local transport" which involves a function \( \gamma_s(\sigma) \) that is matched to the forcing but is not actually needed in the final implementation. Instead, the entire non-local transport term can be equivalently written </p><p class="formulaDsp">
\[ K \gamma_s(\sigma) = C_s G(\sigma) Q_s \]
</p>
<p> where \( Q_s \) is the surface flux of \( s \) and \( C_s \) is a constant. The vertical structure of the redistribution (non-local) term is solely due to the shape function, \( G(\sigma) \). In our implementation of KPP, we allow the shape functions used for \( K \) and for the non-local transport to be chosen independently.</p>
<p>The particular shape function most widely used in the atmospheric community is </p><p class="formulaDsp">
\[ G(\sigma) = \sigma (1-\sigma)^2 \]
</p>
<p> which satisfies the boundary conditions \( G(0) = 0 \), \( G(1) = 0 \), \( G^\prime(0) = 1 \), and \( G^\prime(1) = 0 \). Large et al, 1994, alter the function so as to match interior diffusivities but we have found that this leads to inconsistencies within the formulation (see google groups thread <a href="https://groups.google.com/forum/#!msg/cvmix-dev/i6rF-eHOtKI/Ti8BeyksrhAJ" title="Extreme values of non-local transport">Extreme values of non-local transport</a>). Instead, we use either the above form, or even simpler forms that use alternative upper boundary conditions.</p>
<p>The KPP boundary layer depth is a function of the bulk Richardson number, Rib. But to compute Rib, we need the boundary layer depth. To address this circular logic, we compute Rib for each vertical cell in a column, assuming the BL depth equals to the depth of the given grid cell. Once we have a vertical array of Rib(k), we then call the OBLdepth routine from CVMix to compute the actual OBLdepth. We optionally then "correct" the OBLdepth by cycling through once more, this time knowing the OBLdepth from the first pass. This "correction" step is not used by NCAR. It has been found in idealized MOM6 tests to not be necessary.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="namespacemom__kpp.html#ae808ecbe5d3d46e1b6cef55a8be4d234" title="KPP vertical diffusivity/viscosity and non-local tracer transport. ">kpp_calculate()</a>, kpp_applynonlocaltransport() </dd></dl>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure for containing KPP parameters/data.  <a href="structmom__kpp_1_1kpp__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a9c834424b6e067e280928db3700ec77e"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a9c834424b6e067e280928db3700ec77e">kpp_init</a> (paramFile, G, diag, Time, CS, passive)</td></tr>
<tr class="memdesc:a9c834424b6e067e280928db3700ec77e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the CVmix KPP module and set up diagnostics Returns True if KPP is to be used, False otherwise.  <a href="#a9c834424b6e067e280928db3700ec77e">More...</a><br /></td></tr>
<tr class="separator:a9c834424b6e067e280928db3700ec77e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae808ecbe5d3d46e1b6cef55a8be4d234"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ae808ecbe5d3d46e1b6cef55a8be4d234">kpp_calculate</a> (CS, G, GV, h, Temp, Salt, u, v, EOS, uStar, buoyFlux, Kt, Ks, Kv, nonLocalTransHeat, nonLocalTransScalar)</td></tr>
<tr class="memdesc:ae808ecbe5d3d46e1b6cef55a8be4d234"><td class="mdescLeft">&#160;</td><td class="mdescRight">KPP vertical diffusivity/viscosity and non-local tracer transport.  <a href="#ae808ecbe5d3d46e1b6cef55a8be4d234">More...</a><br /></td></tr>
<tr class="separator:ae808ecbe5d3d46e1b6cef55a8be4d234"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa69a77d09b776e8b85d9908c716cb2b1"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#aa69a77d09b776e8b85d9908c716cb2b1">kpp_nonlocaltransport_temp</a> (CS, G, GV, h, nonLocalTrans, surfFlux, dt, scalar, C_p)</td></tr>
<tr class="memdesc:aa69a77d09b776e8b85d9908c716cb2b1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply KPP non-local transport of surface fluxes for temperature.  <a href="#aa69a77d09b776e8b85d9908c716cb2b1">More...</a><br /></td></tr>
<tr class="separator:aa69a77d09b776e8b85d9908c716cb2b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad46904979c826432df224c38e84f3043"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ad46904979c826432df224c38e84f3043">kpp_nonlocaltransport_saln</a> (CS, G, GV, h, nonLocalTrans, surfFlux, dt, scalar)</td></tr>
<tr class="memdesc:ad46904979c826432df224c38e84f3043"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply KPP non-local transport of surface fluxes for salinity. This routine is a useful prototype for other material tracers.  <a href="#ad46904979c826432df224c38e84f3043">More...</a><br /></td></tr>
<tr class="separator:ad46904979c826432df224c38e84f3043"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a043acd45d7244b4a22285ad42a178b79"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a043acd45d7244b4a22285ad42a178b79">kpp_end</a> (CS)</td></tr>
<tr class="memdesc:a043acd45d7244b4a22285ad42a178b79"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clear pointers, deallocate memory.  <a href="#a043acd45d7244b4a22285ad42a178b79">More...</a><br /></td></tr>
<tr class="separator:a043acd45d7244b4a22285ad42a178b79"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a8ce04e556df335d2920049e027319f95"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a8ce04e556df335d2920049e027319f95">nlt_shape_cvmix</a> = 0</td></tr>
<tr class="memdesc:a8ce04e556df335d2920049e027319f95"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use the CVmix profile.  <a href="#a8ce04e556df335d2920049e027319f95">More...</a><br /></td></tr>
<tr class="separator:a8ce04e556df335d2920049e027319f95"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab4082e47ef31d736769267b912a55cae"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ab4082e47ef31d736769267b912a55cae">nlt_shape_linear</a> = 1</td></tr>
<tr class="memdesc:ab4082e47ef31d736769267b912a55cae"><td class="mdescLeft">&#160;</td><td class="mdescRight">Linear, \( G(\sigma) = 1-\sigma \).  <a href="#ab4082e47ef31d736769267b912a55cae">More...</a><br /></td></tr>
<tr class="separator:ab4082e47ef31d736769267b912a55cae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4d0b609996e88b8cc96070089c58a9bc"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a4d0b609996e88b8cc96070089c58a9bc">nlt_shape_parabolic</a> = 2</td></tr>
<tr class="memdesc:a4d0b609996e88b8cc96070089c58a9bc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Parabolic, \( G(\sigma) = (1-\sigma)^2 \).  <a href="#a4d0b609996e88b8cc96070089c58a9bc">More...</a><br /></td></tr>
<tr class="separator:a4d0b609996e88b8cc96070089c58a9bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae4cccaa3c7e998023cce98a8aefdc9ec"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ae4cccaa3c7e998023cce98a8aefdc9ec">nlt_shape_cubic</a> = 3</td></tr>
<tr class="memdesc:ae4cccaa3c7e998023cce98a8aefdc9ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">Cubic, \( G(\sigma) = 1 + (2\sigma-3) \sigma^2\).  <a href="#ae4cccaa3c7e998023cce98a8aefdc9ec">More...</a><br /></td></tr>
<tr class="separator:ae4cccaa3c7e998023cce98a8aefdc9ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7fe55c332f4b25ba6a15be447243a86"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ab7fe55c332f4b25ba6a15be447243a86">nlt_shape_cubic_lmd</a> = 4</td></tr>
<tr class="memdesc:ab7fe55c332f4b25ba6a15be447243a86"><td class="mdescLeft">&#160;</td><td class="mdescRight">Original shape, \( G(\sigma) = \frac{27}{4} \sigma (1-\sigma)^2 \).  <a href="#ab7fe55c332f4b25ba6a15be447243a86">More...</a><br /></td></tr>
<tr class="separator:ab7fe55c332f4b25ba6a15be447243a86"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac780edab0da6d9b4d4447dcbd33c70b8"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#ac780edab0da6d9b4d4447dcbd33c70b8">sw_method_all_sw</a> = 0</td></tr>
<tr class="memdesc:ac780edab0da6d9b4d4447dcbd33c70b8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use all shortwave radiation.  <a href="#ac780edab0da6d9b4d4447dcbd33c70b8">More...</a><br /></td></tr>
<tr class="separator:ac780edab0da6d9b4d4447dcbd33c70b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5553d1f1600b10d49015b4b8d34e2885"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a5553d1f1600b10d49015b4b8d34e2885">sw_method_mxl_sw</a> = 1</td></tr>
<tr class="memdesc:a5553d1f1600b10d49015b4b8d34e2885"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use shortwave radiation absorbed in mixing layer.  <a href="#a5553d1f1600b10d49015b4b8d34e2885">More...</a><br /></td></tr>
<tr class="separator:a5553d1f1600b10d49015b4b8d34e2885"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26511e698d325cfd0c8d4be02af7ef00"><td class="memItemLeft" align="right" valign="top">integer, parameter, private&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a26511e698d325cfd0c8d4be02af7ef00">sw_method_lv1_sw</a> = 2</td></tr>
<tr class="memdesc:a26511e698d325cfd0c8d4be02af7ef00"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use shortwave radiation absorbed in layer 1.  <a href="#a26511e698d325cfd0c8d4be02af7ef00">More...</a><br /></td></tr>
<tr class="separator:a26511e698d325cfd0c8d4be02af7ef00"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a12e1097a88e7ea3f5bcc91673f192295"><td class="memItemLeft" align="right" valign="top">logical, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__kpp.html#a12e1097a88e7ea3f5bcc91673f192295">verbose</a> = .False.</td></tr>
<tr class="separator:a12e1097a88e7ea3f5bcc91673f192295"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="ae808ecbe5d3d46e1b6cef55a8be4d234"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae808ecbe5d3d46e1b6cef55a8be4d234">&#9670;&nbsp;</a></span>kpp_calculate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kpp::kpp_calculate </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>Temp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>Salt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(eos_type), pointer&#160;</td>
          <td class="paramname"><em>EOS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>uStar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>buoyFlux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>Kt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>Ks</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>Kv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>nonLocalTransHeat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(inout)&#160;</td>
          <td class="paramname"><em>nonLocalTransScalar</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>KPP vertical diffusivity/viscosity and non-local tracer transport. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer/level thicknesses (units of H)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">temp</td><td>potential/cons temp (deg C)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">salt</td><td>Salinity (ppt)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>Velocity i-component (m/s)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>Velocity j-component (m/s)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">eos</td><td>Equation of state</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ustar</td><td>Surface friction velocity (m/s)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buoyflux</td><td>Surface buoyancy flux (m2/s3)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kt</td><td>(in) Vertical diffusivity of heat w/o KPP (m2/s) (out) Vertical diffusivity including KPP (m2/s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ks</td><td>(in) Vertical diffusivity of salt w/o KPP (m2/s) (out) Vertical diffusivity including KPP (m2/s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">kv</td><td>(in) Vertical viscosity w/o KPP (m2/s) (out) Vertical viscosity including KPP (m2/s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">nonlocaltransheat</td><td>Temp non-local transport (m/s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">nonlocaltransscalar</td><td>scalar non-local transport (m/s) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00413">413</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__KPP_8F90_source.html#l00040">nlt_shape_cubic</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00041">nlt_shape_cubic_lmd</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00038">nlt_shape_linear</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00039">nlt_shape_parabolic</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00043">sw_method_all_sw</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00045">sw_method_lv1_sw</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00044">sw_method_mxl_sw</a>.</p>
<div class="fragment"><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordtype">type</span>(kpp_cs),                           <span class="keywordtype">pointer</span>       :: cs<span class="comment">             !&lt; Control structure</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                  <span class="keywordtype">intent(in)</span>    :: g<span class="comment">              !&lt; Ocean grid</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">             !&lt; Ocean vertical grid</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: h<span class="comment">              !&lt; Layer/level thicknesses (units of H)</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: temp<span class="comment">           !&lt; potential/cons temp (deg C)</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: salt<span class="comment">           !&lt; Salinity (ppt)</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: u<span class="comment">              !&lt; Velocity i-component (m/s)</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: v<span class="comment">              !&lt; Velocity j-component (m/s)</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordtype">type</span>(eos_type),                         <span class="keywordtype">pointer</span>       :: eos<span class="comment">            !&lt; Equation of state</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: ustar<span class="comment">          !&lt; Surface friction velocity (m/s)</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(in)</span>    :: buoyflux<span class="comment"> !&lt; Surface buoyancy flux (m2/s3)</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: kt<span class="comment">       !&lt; (in)  Vertical diffusivity of heat w/o KPP (m2/s)</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">                                                                          !&lt; (out) Vertical diffusivity including KPP (m2/s)</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: ks<span class="comment">       !&lt; (in)  Vertical diffusivity of salt w/o KPP (m2/s)</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">                                                                          !&lt; (out) Vertical diffusivity including KPP (m2/s)</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: kv<span class="comment">       !&lt; (in)  Vertical viscosity w/o KPP (m2/s)</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">                                                                          !&lt; (out) Vertical viscosity including KPP (m2/s)</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: nonlocaltransheat<span class="comment">   !&lt; Temp non-local transport (m/s)</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(inout)</span> :: nonlocaltransscalar<span class="comment"> !&lt; scalar non-local transport (m/s)</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, km1,kp1                    <span class="comment">! Loop indices</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: cellheight      <span class="comment">! Cell center heights referenced to surface (m) (negative in ocean)</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1 )</span>   :: ifaceheight     <span class="comment">! Interface heights referenced to surface (m) (negative in ocean)</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1 )</span>   :: n2_1d           <span class="comment">! Brunt-Vaisala frequency squared, at interfaces (1/s2)</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1 )</span>   :: n_1d            <span class="comment">! Brunt-Vaisala frequency at interfaces (1/s) (floored at 0)</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: ws_1d           <span class="comment">! Profile of vertical velocity scale for scalars (m/s)</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: wm_1d           <span class="comment">! Profile of vertical velocity scale for momentum (m/s)</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: vt2_1d          <span class="comment">! Unresolved velocity for bulk Ri calculation/diagnostic (m2/s2)</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: bulkri_1d       <span class="comment">! Bulk Richardson number for each layer</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: deltarho        <span class="comment">! delta Rho in numerator of Bulk Ri number</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: deltau2         <span class="comment">! square of delta U (shear) in denominator of Bulk Ri (m2/s2)</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1, 2)</span> :: kdiffusivity    <span class="comment">! Vertical diffusivity at interfaces (m2/s)</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1 )</span>   :: kviscosity      <span class="comment">! Vertical viscosity at interfaces (m2/s)</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke+1, 2)</span> :: nonlocaltrans   <span class="comment">! Non-local transport for heat/salt at interfaces (non-dimensional)</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( G%ke )</span>     :: surfbuoyflux2</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="comment">! for EOS calculation</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( 3*G%ke )</span>   :: rho_1d</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( 3*G%ke )</span>   :: pres_1d</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( 3*G%ke )</span>   :: temp_1d</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( 3*G%ke )</span>   :: salt_1d</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  <span class="keywordtype">real</span> :: kobl, obldepth_0d, surffricvel, surfbuoyflux, coriolis</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordtype">real</span> :: gorho, pref, rho1, rhok, rhokm1, uk, vk, sigma</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordtype">real</span> :: zbottomminusoffset   <span class="comment">! Height of bottom plus a little bit (m)</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordtype">real</span> :: sldepth_0d           <span class="comment">! Surface layer depth = surf_layer_ext*OBLdepth.</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordtype">real</span> :: htot                 <span class="comment">! Running sum of thickness used in the surface layer average (m)</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordtype">real</span> :: delh                 <span class="comment">! Thickness of a layer (m)</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordtype">real</span> :: surfhtemp, surftemp  <span class="comment">! Integral and average of temp over the surface layer</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordtype">real</span> :: surfhsalt, surfsalt  <span class="comment">! Integral and average of saln over the surface layer</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordtype">real</span> :: surfhu, surfu        <span class="comment">! Integral and average of u over the surface layer</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordtype">real</span> :: surfhv, surfv        <span class="comment">! Integral and average of v over the surface layer</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordtype">real</span> :: dh    <span class="comment">! The local thickness used for calculating interface positions (m)</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keywordtype">real</span> :: hcorr <span class="comment">! A cumulative correction arising from inflation of vanished layers (m)</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="keywordtype">integer</span> :: kk, ksfc, ktmp</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keyword">call </span>hchksum(h, <span class="stringliteral">&quot;KPP in: h&quot;</span>,g%HI,haloshift=0, scale=gv%H_to_m)</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keyword">call </span>hchksum(temp, <span class="stringliteral">&quot;KPP in: T&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keyword">call </span>hchksum(salt, <span class="stringliteral">&quot;KPP in: S&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keyword">call </span>hchksum(u, <span class="stringliteral">&quot;KPP in: u&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keyword">call </span>hchksum(v, <span class="stringliteral">&quot;KPP in: v&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keyword">call </span>hchksum(ustar, <span class="stringliteral">&quot;KPP in: uStar&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keyword">call </span>hchksum(buoyflux, <span class="stringliteral">&quot;KPP in: buoyFlux&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keyword">call </span>hchksum(kt, <span class="stringliteral">&quot;KPP in: Kt&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="keyword">call </span>hchksum(ks, <span class="stringliteral">&quot;KPP in: Ks&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="comment">! some constants</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  gorho = gv%g_Earth / gv%Rho0</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  nonlocaltrans(:,:) = 0.0</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kd_in &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kd_in, kt, cs%diag)</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,CS,EOS,uStar,Temp,Salt,u,v,h,GoRho,       &amp;</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">!$OMP                                  buoyFlux, nonLocalTransHeat,                   &amp;</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">!$OMP                                  nonLocalTransScalar,Kt,Ks,Kv)                  &amp;</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">!$OMP                     firstprivate(nonLocalTrans)                                 &amp;</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">!$OMP                          private(Coriolis,surfFricVel,SLdepth_0d,hTot,surfTemp, &amp;</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">!$OMP                                  surfHtemp,surfSalt,surfHsalt,surfU,            &amp;</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">!$OMP                                  surfHu,surfV,surfHv,iFaceHeight,               &amp;</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">!$OMP                                  pRef,km1,cellHeight,Uk,Vk,deltaU2,             &amp;</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">!$OMP                                  rho1,rhoK,rhoKm1,deltaRho,N2_1d,N_1d,delH,     &amp;</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment">!$OMP                                  surfBuoyFlux,Ws_1d,Vt2_1d,BulkRi_1d,           &amp;</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">!$OMP                                  OBLdepth_0d,zBottomMinusOffset,Kdiffusivity,   &amp;</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">!$OMP                                  Kviscosity,sigma,kOBL,kk,pres_1D,Temp_1D,      &amp;</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">!$OMP                                  Salt_1D,rho_1D,surfBuoyFlux2,ksfc,dh,hcorr)</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="comment">! loop over horizontal points on processor</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;      <span class="comment">! skip calling KPP for land points</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)==0.) cycle</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="comment">! things independent of position within the column</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      coriolis = 0.25*( (g%CoriolisBu(i,j)   + g%CoriolisBu(i-1,j-1)) &amp;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                       +(g%CoriolisBu(i-1,j) + g%CoriolisBu(i,j-1)) )</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      surffricvel = ustar(i,j)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      <span class="comment">! Bullk Richardson number computed for each cell in a column,</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      <span class="comment">! assuming OBLdepth = grid cell depth. After Rib(k) is</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      <span class="comment">! known for the column, then CVMix interpolates to find</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      <span class="comment">! the actual OBLdepth. This approach avoids need to iterate</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="comment">! on the OBLdepth calculation. It follows that used in MOM5</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;      <span class="comment">! and POP.</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      ifaceheight(1) = 0.0 <span class="comment">! BBL is all relative to the surface</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;      pref = 0.</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      hcorr = 0.</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      <span class="keywordflow">do</span> k=1,g%ke</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="comment">! cell center and cell bottom in meters (negative values in the ocean)</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        dh = h(i,j,k) * gv%H_to_m <span class="comment">! Nominal thickness to use for increment</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        dh = dh + hcorr <span class="comment">! Take away the accumulated error (could temporarily make dh&lt;0)</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        hcorr = min( dh - cs%min_thickness, 0. ) <span class="comment">! If inflating then hcorr&lt;0</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        dh = max( dh, cs%min_thickness ) <span class="comment">! Limit increment dh&gt;=min_thickness</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        cellheight(k)    = ifaceheight(k) - 0.5 * dh</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        ifaceheight(k+1) = ifaceheight(k) - dh</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="comment">! find ksfc for cell where &quot;surface layer&quot; sits</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        sldepth_0d = cs%surf_layer_ext*max( max(-cellheight(k),-ifaceheight(2) ), cs%minOBLdepth )</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        ksfc = k</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">do</span> ktmp = 1,k</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;          <span class="keywordflow">if</span> (-1.0*ifaceheight(ktmp+1) &gt;= sldepth_0d) <span class="keywordflow">then</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;            ksfc = ktmp</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            <span class="keywordflow">exit</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="comment">! average temp, saln, u, v over surface layer</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="comment">! use C-grid average to get u,v on T-points.</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        surfhtemp=0.0</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        surfhsalt=0.0</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        surfhu   =0.0</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        surfhv   =0.0</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        htot     =0.0</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        <span class="keywordflow">do</span> ktmp = 1,ksfc</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;          <span class="comment">! SLdepth_0d can be between cell interfaces</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;          delh = min( max(0.0, sldepth_0d - htot), h(i,j,ktmp)*gv%H_to_m )</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;          <span class="comment">! surface layer thickness</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;          htot = htot + delh</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;          <span class="comment">! surface averaged fields</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;          surfhtemp = surfhtemp + temp(i,j,ktmp) * delh</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;          surfhsalt = surfhsalt + salt(i,j,ktmp) * delh</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;          surfhu    = surfhu + 0.5*(u(i,j,ktmp)+u(i-1,j,ktmp)) * delh</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;          surfhv    = surfhv + 0.5*(v(i,j,ktmp)+v(i,j-1,ktmp)) * delh</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        surftemp = surfhtemp / htot</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        surfsalt = surfhsalt / htot</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        surfu    = surfhu    / htot</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        surfv    = surfhv    / htot</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <span class="comment">! vertical shear between present layer and</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="comment">! surface layer averaged surfU,surfV.</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        <span class="comment">! C-grid average to get Uk and Vk on T-points.</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        uk         = 0.5*(u(i,j,k)+u(i-1,j,k)) - surfu</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        vk         = 0.5*(v(i,j,k)+v(i,j-1,k)) - surfv</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;        deltau2(k) = uk**2 + vk**2</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="comment">! pressure, temp, and saln for EOS</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        <span class="comment">! kk+1 = surface fields</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <span class="comment">! kk+2 = k fields</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="comment">! kk+3 = km1 fields</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        km1  = max(1, k-1)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        kk   = 3*(k-1)</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        pres_1d(kk+1) = pref</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        pres_1d(kk+2) = pref</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        pres_1d(kk+3) = pref</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        temp_1d(kk+1) = surftemp</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        temp_1d(kk+2) = temp(i,j,k)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        temp_1d(kk+3) = temp(i,j,km1)</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        salt_1d(kk+1) = surfsalt</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        salt_1d(kk+2) = salt(i,j,k)</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        salt_1d(kk+3) = salt(i,j,km1)</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="comment">! pRef is pressure at interface between k and km1.</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        <span class="comment">! iterate pRef for next pass through k-loop.</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        pref = pref + gv%H_to_Pa * h(i,j,k)</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="comment">! this difference accounts for penetrating SW</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        surfbuoyflux2(k) = buoyflux(i,j,1) - buoyflux(i,j,k+1)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! k-loop finishes</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      <span class="comment">! compute in-situ density</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      <span class="keyword">call </span>calculate_density(temp_1d, salt_1d, pres_1d, rho_1d, 1, 3*g%ke, eos)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="comment">! N2 (can be negative) and N (non-negative) on interfaces.</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      <span class="comment">! deltaRho is non-local rho difference used for bulk Richardson number.</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      <span class="comment">! N_1d is local N (with floor) used for unresolved shear calculation.</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        km1 = max(1, k-1)</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        kk = 3*(k-1)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        deltarho(k) = rho_1d(kk+2) - rho_1d(kk+1)</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        n2_1d(k)    = (gorho * (rho_1d(kk+2) - rho_1d(kk+3)) ) / &amp;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                      ((0.5*(h(i,j,km1) + h(i,j,k))+gv%H_subroundoff)*gv%H_to_m)</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        n_1d(k)     = sqrt( max( n2_1d(k), 0.) )</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      n2_1d(g%ke+1 ) = 0.0</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;      n_1d(g%ke+1 )  = 0.0</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="comment">! turbulent velocity scales w_s and w_m computed at the cell centers.</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="comment">! Note that if sigma &gt; CS%surf_layer_ext, then CVmix_kpp_compute_turbulent_scales</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      <span class="comment">! computes w_s and w_m velocity scale at sigma=CS%surf_layer_ext. So we only pass</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="comment">! sigma=CS%surf_layer_ext for this calculation.</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;      <span class="keyword">call </span>cvmix_kpp_compute_turbulent_scales( &amp;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        cs%surf_layer_ext, &amp; <span class="comment">! (in)  Normalized surface layer depth; sigma = CS%surf_layer_ext</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        -cellheight,       &amp; <span class="comment">! (in)  Assume here that OBL depth (m) = -cellHeight(k)</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        surfbuoyflux2,     &amp; <span class="comment">! (in)  Buoyancy flux at surface (m2/s3)</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        surffricvel,       &amp; <span class="comment">! (in)  Turbulent friction velocity at surface (m/s)</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        w_s=ws_1d,         &amp; <span class="comment">! (out) Turbulent velocity scale profile (m/s)</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        cvmix_kpp_params_user=cs%KPP_params )</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;      <span class="comment">! Calculate Bulk Richardson number from eq (21) of LMD94</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;      bulkri_1d = cvmix_kpp_compute_bulk_richardson( &amp;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                  cellheight(1:g%ke),                &amp; <span class="comment">! Depth of cell center (m)</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                  gorho*deltarho,                    &amp; <span class="comment">! Bulk buoyancy difference, Br-B(z) (1/s)</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                  deltau2,                           &amp; <span class="comment">! Square of resolved velocity difference (m2/s2)</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                  ws_cntr=ws_1d,                     &amp; <span class="comment">! Turbulent velocity scale profile (m/s)</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                  n_iface=n_1d)                        <span class="comment">! Buoyancy frequency (1/s)</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      surfbuoyflux = buoyflux(i,j,1) <span class="comment">! This is only used in kpp_compute_OBL_depth to limit</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                                     <span class="comment">! h to Monin-Obukov (default is false, ie. not used)</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="keyword">call </span>cvmix_kpp_compute_obl_depth( &amp;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        bulkri_1d,              &amp; <span class="comment">! (in) Bulk Richardson number</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        ifaceheight,            &amp; <span class="comment">! (in) Height of interfaces (m)</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        obldepth_0d,            &amp; <span class="comment">! (out) OBL depth (m)</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        kobl,                   &amp; <span class="comment">! (out) level (+fraction) of OBL extent</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        zt_cntr=cellheight,     &amp; <span class="comment">! (in) Height of cell centers (m)</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        surf_fric=surffricvel,  &amp; <span class="comment">! (in) Turbulent friction velocity at surface (m/s)</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        surf_buoy=surfbuoyflux, &amp; <span class="comment">! (in) Buoyancy flux at surface (m2/s3)</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        coriolis=coriolis,      &amp; <span class="comment">! (in) Coriolis parameter (1/s)</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        cvmix_kpp_params_user=cs%KPP_params ) <span class="comment">! KPP parameters</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;      <span class="comment">! A hack to avoid KPP reaching the bottom. It was needed during development</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <span class="comment">! because KPP was unable to handle vanishingly small layers near the bottom.</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keywordflow">if</span> (cs%deepOBLoffset&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        zbottomminusoffset = ifaceheight(g%ke+1) + min(cs%deepOBLoffset,-0.1*ifaceheight(g%ke+1))</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        obldepth_0d = min( obldepth_0d, -zbottomminusoffset )</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      <span class="comment">! apply some constraints on OBLdepth</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      <span class="keywordflow">if</span>(cs%fixedOBLdepth)  obldepth_0d = cs%fixedOBLdepth_value</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;      obldepth_0d = max( obldepth_0d, -ifaceheight(2) )      <span class="comment">! no shallower than top layer</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;      obldepth_0d = min( obldepth_0d, -ifaceheight(g%ke+1) ) <span class="comment">! no deeper than bottom</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      kobl        = cvmix_kpp_compute_kobl_depth( ifaceheight, cellheight, obldepth_0d )</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">!*************************************************************************</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">! smg: remove code below</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="comment">! Following &quot;correction&quot; step has been found to be unnecessary.</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">! Code should be removed after further testing.</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;      <span class="keywordflow">if</span> (cs%correctSurfLayerAvg) <span class="keywordflow">then</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        sldepth_0d = cs%surf_layer_ext * obldepth_0d</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        htot      = h(i,j,1)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        surftemp  = temp(i,j,1) ; surfhtemp = surftemp * htot</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        surfsalt  = salt(i,j,1) ; surfhsalt = surfsalt * htot</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        surfu     = 0.5*(u(i,j,1)+u(i-1,j,1)) ; surfhu = surfu * htot</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        surfv     = 0.5*(v(i,j,1)+v(i,j-1,1)) ; surfhv = surfv * htot</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        pref      = 0.0</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        <span class="keywordflow">do</span> k = 2, g%ke</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;          <span class="comment">! Recalculate differences with surface layer</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;          uk = 0.5*(u(i,j,k)+u(i-1,j,k)) - surfu</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;          vk = 0.5*(v(i,j,k)+v(i,j-1,k)) - surfv</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;          deltau2(k) = uk**2 + vk**2</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;          pref = pref + gv%H_to_Pa * h(i,j,k)</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;          <span class="keyword">call </span>calculate_density(surftemp, surfsalt, pref, rho1, eos)</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;          <span class="keyword">call </span>calculate_density(temp(i,j,k), salt(i,j,k), pref, rhok, eos)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;          deltarho(k) = rhok - rho1</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          <span class="comment">! Surface layer averaging (needed for next k+1 iteration of this loop)</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;          <span class="keywordflow">if</span> (htot &lt; sldepth_0d) <span class="keywordflow">then</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            delh = min( max(0., sldepth_0d - htot), h(i,j,k)*gv%H_to_m )</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            htot = htot + delh</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            surfhtemp = surfhtemp + temp(i,j,k) * delh ; surftemp = surfhtemp / htot</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            surfhsalt = surfhsalt + salt(i,j,k) * delh ; surfsalt = surfhsalt / htot</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;            surfhu = surfhu + 0.5*(u(i,j,k)+u(i-1,j,k)) * delh ; surfu = surfhu / htot</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;            surfhv = surfhv + 0.5*(v(i,j,k)+v(i,j-1,k)) * delh ; surfv = surfhv / htot</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        bulkri_1d = cvmix_kpp_compute_bulk_richardson( &amp;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                    cellheight(1:g%ke),                &amp; <span class="comment">! Depth of cell center (m)</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                    gorho*deltarho,                    &amp; <span class="comment">! Bulk buoyancy difference, Br-B(z) (1/s)</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                    deltau2,                           &amp; <span class="comment">! Square of resolved velocity difference (m2/s2)</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                    ws_cntr=ws_1d,                     &amp; <span class="comment">! Turbulent velocity scale profile (m/s)</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                    n_iface=n_1d )                       <span class="comment">! Buoyancy frequency (1/s)</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        surfbuoyflux = buoyflux(i,j,1) <span class="comment">! This is only used in kpp_compute_OBL_depth to limit</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                                       <span class="comment">! h to Monin-Obukov (default is false, ie. not used)</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="keyword">call </span>cvmix_kpp_compute_obl_depth( &amp;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;          bulkri_1d,              &amp; <span class="comment">! (in) Bulk Richardson number</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;          ifaceheight,            &amp; <span class="comment">! (in) Height of interfaces (m)</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;          obldepth_0d,            &amp; <span class="comment">! (out) OBL depth (m)</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;          kobl,                   &amp; <span class="comment">! (out) level (+fraction) of OBL extent</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;          zt_cntr=cellheight,     &amp; <span class="comment">! (in) Height of cell centers (m)</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;          surf_fric=surffricvel,  &amp; <span class="comment">! (in) Turbulent friction velocity at surface (m/s)</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;          surf_buoy=surfbuoyflux, &amp; <span class="comment">! (in) Buoyancy flux at surface (m2/s3)</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;          coriolis=coriolis,      &amp; <span class="comment">! (in) Coriolis parameter (1/s)</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;          cvmix_kpp_params_user=cs%KPP_params ) <span class="comment">! KPP parameters</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">if</span> (cs%deepOBLoffset&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;          zbottomminusoffset = ifaceheight(g%ke+1) + min(cs%deepOBLoffset,-0.1*ifaceheight(g%ke+1))</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;          obldepth_0d = min( obldepth_0d, -zbottomminusoffset )</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;          kobl = cvmix_kpp_compute_kobl_depth( ifaceheight, cellheight, obldepth_0d )</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="comment">! apply some constraints on OBLdepth</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">if</span>(cs%fixedOBLdepth)  obldepth_0d = cs%fixedOBLdepth_value</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        obldepth_0d = max( obldepth_0d, -ifaceheight(2) )      <span class="comment">! no shallower than top layer</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        obldepth_0d = min( obldepth_0d, -ifaceheight(g%ke+1) ) <span class="comment">! no deep than bottom</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        kobl        = cvmix_kpp_compute_kobl_depth( ifaceheight, cellheight, obldepth_0d )</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keywordflow">      endif</span>   <span class="comment">! endif for &quot;correction&quot; step</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment">! smg: remove code above</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">! **********************************************************************</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;      <span class="comment">! Call CVMix/KPP to obtain OBL diffusivities, viscosities and non-local transports</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;      <span class="comment">! Unlike LMD94, we do not match to interior diffusivities. If using the original</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;      <span class="comment">! LMD94 shape function, not matching is equivalent to matching to a zero diffusivity.</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      <span class="comment">!BGR/ Add option for use of surface buoyancy flux with total sw flux.</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      <span class="keywordflow">if</span> (cs%SW_METHOD .eq. sw_method_all_sw) <span class="keywordflow">then</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;         surfbuoyflux = buoyflux(i,j,1)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      <span class="keywordflow">elseif</span> (cs%SW_METHOD .eq. sw_method_mxl_sw) <span class="keywordflow">then</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;         surfbuoyflux  = buoyflux(i,j,1) - buoyflux(i,j,int(kobl)+1) <span class="comment">! We know the actual buoyancy flux into the OBL</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;      <span class="keywordflow">elseif</span> (cs%SW_METHOD .eq. sw_method_lv1_sw) <span class="keywordflow">then</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;         surfbuoyflux  = buoyflux(i,j,1) - buoyflux(i,j,2)</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;      <span class="comment">! If option &quot;MatchBoth&quot; is selected in CVMix, MOM should be capable of matching.</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      <span class="keywordflow">if</span> (.not. (cs%MatchTechnique.eq.<span class="stringliteral">&#39;MatchBoth&#39;</span>)) <span class="keywordflow">then</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;         kdiffusivity(:,:) = 0. <span class="comment">! Diffusivities for heat and salt (m2/s)</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;         kviscosity(:)     = 0. <span class="comment">! Viscosity (m2/s)</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;         kdiffusivity(:,1) = kt(i,j,:)</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;         kdiffusivity(:,2) = ks(i,j,:)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;         kviscosity(:)=kv(i,j,:)</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;      <span class="keyword">call </span>cvmix_coeffs_kpp(kviscosity,        &amp; <span class="comment">! (inout) Total viscosity (m2/s)</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                            kdiffusivity(:,1), &amp; <span class="comment">! (inout) Total heat diffusivity (m2/s)</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                            kdiffusivity(:,2), &amp; <span class="comment">! (inout) Total salt diffusivity (m2/s)</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                            ifaceheight,       &amp; <span class="comment">! (in) Height of interfaces (m)</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                            cellheight,        &amp; <span class="comment">! (in) Height of level centers (m)</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                            kviscosity,        &amp; <span class="comment">! (in) Original viscosity (m2/s)</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                            kdiffusivity(:,1), &amp; <span class="comment">! (in) Original heat diffusivity (m2/s)</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;                            kdiffusivity(:,2), &amp; <span class="comment">! (in) Original salt diffusivity (m2/s)</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                            obldepth_0d,       &amp; <span class="comment">! (in) OBL depth (m)</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                            kobl,              &amp; <span class="comment">! (in) level (+fraction) of OBL extent</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                            nonlocaltrans(:,1),&amp; <span class="comment">! (out) Non-local heat transport (non-dimensional)</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                            nonlocaltrans(:,2),&amp; <span class="comment">! (out) Non-local salt transport (non-dimensional)</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;                            surffricvel,       &amp; <span class="comment">! (in) Turbulent friction velocity at surface (m/s)</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                            surfbuoyflux,      &amp; <span class="comment">! (in) Buoyancy flux at surface (m2/s3)</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                            g%ke,              &amp; <span class="comment">! (in) Number of levels to compute coeffs for</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                            g%ke,              &amp; <span class="comment">! (in) Number of levels in array shape</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                            cvmix_kpp_params_user=cs%KPP_params )</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      <span class="comment">! Over-write CVMix NLT shape function with one of the following choices.</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;      <span class="comment">! The CVMix code has yet to update for thse options, so we compute in MOM6.</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;      <span class="comment">! Note that nonLocalTrans = Cs * G(sigma) (LMD94 notation), with</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;      <span class="comment">! Cs = 6.32739901508.</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;      <span class="comment">! Start do-loop at k=2, since k=1 is ocean surface (sigma=0)</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;      <span class="comment">! and we do not wish to double-count the surface forcing.</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;      <span class="comment">! Only compute nonlocal transport for 0 &lt;= sigma &lt;= 1.</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;      <span class="comment">! MOM6 recommended shape is the parabolic; it gives deeper boundary layer</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;      <span class="comment">! and no spurious extrema.</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;      <span class="keywordflow">if</span> (surfbuoyflux &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordflow">if</span> (cs%NLT_shape == nlt_shape_cubic) <span class="keywordflow">then</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;          <span class="keywordflow">do</span> k = 2, g%ke</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;            sigma = min(1.0,-ifaceheight(k)/obldepth_0d)</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            nonlocaltrans(k,1) = (1.0 - sigma)**2 * (1.0 + 2.0*sigma) <span class="comment">!*</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;            nonlocaltrans(k,2) = nonlocaltrans(k,1)</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="keywordflow">elseif</span> (cs%NLT_shape == nlt_shape_parabolic) <span class="keywordflow">then</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;          <span class="keywordflow">do</span> k = 2, g%ke</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            sigma = min(1.0,-ifaceheight(k)/obldepth_0d)</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            nonlocaltrans(k,1) = (1.0 - sigma)**2 <span class="comment">!*CS%CS2</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            nonlocaltrans(k,2) = nonlocaltrans(k,1)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="keywordflow">elseif</span> (cs%NLT_shape == nlt_shape_linear) <span class="keywordflow">then</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;          <span class="keywordflow">do</span> k = 2, g%ke</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            sigma = min(1.0,-ifaceheight(k)/obldepth_0d)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            nonlocaltrans(k,1) = (1.0 - sigma)<span class="comment">!*CS%CS2</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            nonlocaltrans(k,2) = nonlocaltrans(k,1)</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        <span class="keywordflow">elseif</span> (cs%NLT_shape == nlt_shape_cubic_lmd) <span class="keywordflow">then</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;          <span class="comment">! Sanity check (should agree with CVMix result using simple matching)</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;          <span class="keywordflow">do</span> k = 2, g%ke</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;            sigma = min(1.0,-ifaceheight(k)/obldepth_0d)</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            nonlocaltrans(k,1) = cs%CS2 * sigma*(1.0 -sigma)**2</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            nonlocaltrans(k,2) = nonlocaltrans(k,1)</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      <span class="comment">! we apply nonLocalTrans in subroutines</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;      <span class="comment">! KPP_NonLocalTransport_temp and KPP_NonLocalTransport_saln</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      nonlocaltransheat(i,j,:)   = nonlocaltrans(:,1) <span class="comment">! temp</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      nonlocaltransscalar(i,j,:) = nonlocaltrans(:,2) <span class="comment">! saln</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;      <span class="comment">! set the KPP diffusivity and viscosity to zero for testing purposes</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      <span class="keywordflow">if</span>(cs%KPPzeroDiffusivity) <span class="keywordflow">then</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;         kdiffusivity(:,1) = 0.0</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;         kdiffusivity(:,2) = 0.0</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;         kviscosity(:)     = 0.0</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;      <span class="comment">! recompute wscale for diagnostics, now that we in fact know boundary layer depth</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;      <span class="keywordflow">if</span> (cs%id_Ws &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;          <span class="keyword">call </span>cvmix_kpp_compute_turbulent_scales( &amp;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;            -cellheight/obldepth_0d,               &amp; <span class="comment">! (in)  Normalized boundary layer coordinate</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;            obldepth_0d,                           &amp; <span class="comment">! (in)  OBL depth (m)</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;            surfbuoyflux,                          &amp; <span class="comment">! (in)  Buoyancy flux at surface (m2/s3)</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            surffricvel,                           &amp; <span class="comment">! (in)  Turbulent friction velocity at surface (m/s)</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;            w_s=ws_1d,                             &amp; <span class="comment">! (out) Turbulent velocity scale profile (m/s)</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;            cvmix_kpp_params_user=cs%KPP_params    &amp; <span class="comment">!       KPP parameters</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;            )</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;          cs%Ws(i,j,:) = ws_1d(:)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;      <span class="comment">! compute unresolved squared velocity for diagnostics</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      <span class="keywordflow">if</span> (cs%id_Vt2 &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        vt2_1d(:) = cvmix_kpp_compute_unresolved_shear( &amp;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                    cellheight(1:g%ke),                 &amp; <span class="comment">! Depth of cell center (m)</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                    ws_cntr=ws_1d,                      &amp; <span class="comment">! Turbulent velocity scale profile, at centers (m/s)</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;                    n_iface=n_1d,                       &amp; <span class="comment">! Buoyancy frequency at interface (1/s)</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                    cvmix_kpp_params_user=cs%KPP_params ) <span class="comment">! KPP parameters</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        cs%Vt2(i,j,:) = vt2_1d(:)</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      <span class="comment">! Copy 1d data into 3d diagnostic arrays</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      <span class="keywordflow">if</span> (cs%id_OBLdepth &gt; 0) cs%OBLdepth(i,j) = obldepth_0d</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      <span class="keywordflow">if</span> (cs%id_BulkDrho &gt; 0) cs%dRho(i,j,:)   = deltarho(:)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;      <span class="keywordflow">if</span> (cs%id_BulkUz2 &gt; 0)  cs%Uz2(i,j,:)    = deltau2(:)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="keywordflow">if</span> (cs%id_BulkRi &gt; 0)   cs%BulkRi(i,j,:) = bulkri_1d(:)</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;      <span class="keywordflow">if</span> (cs%id_sigma &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        cs%sigma(i,j,:)  = 0.</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        <span class="keywordflow">if</span> (obldepth_0d&gt;0.)   cs%sigma(i,j,:)  = -ifaceheight/obldepth_0d</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;      <span class="keywordflow">if</span> (cs%id_N      &gt; 0)   cs%N(i,j,:)      = n_1d(:)</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;      <span class="keywordflow">if</span> (cs%id_N2     &gt; 0)   cs%N2(i,j,:)     = n2_1d(:)</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;      <span class="keywordflow">if</span> (cs%id_Kt_KPP &gt; 0)   cs%Kt_KPP(i,j,:) = kdiffusivity(:,1)</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;      <span class="keywordflow">if</span> (cs%id_Ks_KPP &gt; 0)   cs%Ks_KPP(i,j,:) = kdiffusivity(:,2)</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;      <span class="keywordflow">if</span> (cs%id_Kv_KPP &gt; 0)   cs%Kv_KPP(i,j,:) = kviscosity(:)</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;      <span class="keywordflow">if</span> (cs%id_Tsurf  &gt; 0)   cs%Tsurf(i,j)    = surftemp</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;      <span class="keywordflow">if</span> (cs%id_Ssurf  &gt; 0)   cs%Ssurf(i,j)    = surfsalt</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      <span class="keywordflow">if</span> (cs%id_Usurf  &gt; 0)   cs%Usurf(i,j)    = surfu</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      <span class="keywordflow">if</span> (cs%id_Vsurf  &gt; 0)   cs%Vsurf(i,j)    = surfv</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;       <span class="comment">! Update output of routine</span></div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;      <span class="keywordflow">if</span> (.not. cs%passiveMode) <span class="keywordflow">then</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="keywordflow">if</span> (cs%KPPisAdditive) <span class="keywordflow">then</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;          <span class="keywordflow">do</span> k=1, g%ke+1</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;            kt(i,j,k) = kt(i,j,k) + kdiffusivity(k,1)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            ks(i,j,k) = ks(i,j,k) + kdiffusivity(k,2)</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            kv(i,j,k) = kv(i,j,k) + kviscosity(k)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keywordflow">else</span> <span class="comment">! KPP replaces prior diffusivity when former is non-zero</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;          <span class="keywordflow">do</span> k=1, g%ke+1</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            <span class="keywordflow">if</span> (kdiffusivity(k,1) /= 0.) kt(i,j,k) = kdiffusivity(k,1)</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;            <span class="keywordflow">if</span> (kdiffusivity(k,2) /= 0.) ks(i,j,k) = kdiffusivity(k,2)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            <span class="keywordflow">if</span> (kviscosity(k) /= 0.) kv(i,j,k) = kviscosity(k)</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="comment">! end of the horizontal do-loops over the vertical columns</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! i</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! j</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="preprocessor"></span>  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="keyword">call </span>hchksum(kt, <span class="stringliteral">&quot;KPP out: Kt&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="keyword">call </span>hchksum(ks, <span class="stringliteral">&quot;KPP out: Ks&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  <span class="comment">! send diagnostics to post_data</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;  <span class="keywordflow">if</span> (cs%id_OBLdepth &gt; 0) <span class="keyword">call </span>post_data(cs%id_OBLdepth, cs%OBLdepth,        cs%diag)</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkDrho &gt; 0) <span class="keyword">call </span>post_data(cs%id_BulkDrho, cs%dRho,            cs%diag)</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkUz2  &gt; 0) <span class="keyword">call </span>post_data(cs%id_BulkUz2,  cs%Uz2,             cs%diag)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkRi   &gt; 0) <span class="keyword">call </span>post_data(cs%id_BulkRi,   cs%BulkRi,          cs%diag)</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;  <span class="keywordflow">if</span> (cs%id_sigma    &gt; 0) <span class="keyword">call </span>post_data(cs%id_sigma,    cs%sigma,           cs%diag)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ws       &gt; 0) <span class="keyword">call </span>post_data(cs%id_Ws,       cs%Ws,              cs%diag)</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="keywordflow">if</span> (cs%id_N        &gt; 0) <span class="keyword">call </span>post_data(cs%id_N,        cs%N,               cs%diag)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  <span class="keywordflow">if</span> (cs%id_N2       &gt; 0) <span class="keyword">call </span>post_data(cs%id_N2,       cs%N2,              cs%diag)</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vt2      &gt; 0) <span class="keyword">call </span>post_data(cs%id_Vt2,      cs%Vt2,             cs%diag)</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <span class="keywordflow">if</span> (cs%id_uStar    &gt; 0) <span class="keyword">call </span>post_data(cs%id_uStar,    ustar,              cs%diag)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  <span class="keywordflow">if</span> (cs%id_buoyFlux &gt; 0) <span class="keyword">call </span>post_data(cs%id_buoyFlux, buoyflux,           cs%diag)</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kt_KPP   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kt_KPP,   cs%Kt_KPP,          cs%diag)</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ks_KPP   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Ks_KPP,   cs%Ks_KPP,          cs%diag)</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kv_KPP   &gt; 0) <span class="keyword">call </span>post_data(cs%id_Kv_KPP,   cs%Kv_KPP,          cs%diag)</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLTt     &gt; 0) <span class="keyword">call </span>post_data(cs%id_NLTt,     nonlocaltransheat,  cs%diag)</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLTs     &gt; 0) <span class="keyword">call </span>post_data(cs%id_NLTs,     nonlocaltransscalar,cs%diag)</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  <span class="keywordflow">if</span> (cs%id_Tsurf    &gt; 0) <span class="keyword">call </span>post_data(cs%id_Tsurf,    cs%Tsurf,           cs%diag)</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ssurf    &gt; 0) <span class="keyword">call </span>post_data(cs%id_Ssurf,    cs%Ssurf,           cs%diag)</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="keywordflow">if</span> (cs%id_Usurf    &gt; 0) <span class="keyword">call </span>post_data(cs%id_Usurf,    cs%Usurf,           cs%diag)</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vsurf    &gt; 0) <span class="keyword">call </span>post_data(cs%id_Vsurf,    cs%Vsurf,           cs%diag)</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a043acd45d7244b4a22285ad42a178b79"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a043acd45d7244b4a22285ad42a178b79">&#9670;&nbsp;</a></span>kpp_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kpp::kpp_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clear pointers, deallocate memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">cs</td><td>Control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l01062">1062</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordtype">type</span>(kpp_cs), <span class="keywordtype">pointer</span> :: cs<span class="comment"> !&lt; Control structure</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keyword">deallocate</span>(cs)</div></div><!-- fragment -->
</div>
</div>
<a id="a9c834424b6e067e280928db3700ec77e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9c834424b6e067e280928db3700ec77e">&#9670;&nbsp;</a></span>kpp_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_kpp::kpp_init </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>paramFile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(in), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(out), optional&#160;</td>
          <td class="paramname"><em>passive</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the CVmix KPP module and set up diagnostics Returns True if KPP is to be used, False otherwise. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">paramfile</td><td>File parser</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">diag</td><td>Diagnostics</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">passive</td><td>Copy of passiveMode </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00133">133</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__file__parser_8F90_source.html#l01826">mom_file_parser::closeparameterblock()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00040">nlt_shape_cubic</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00041">nlt_shape_cubic_lmd</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00037">nlt_shape_cvmix</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00038">nlt_shape_linear</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00039">nlt_shape_parabolic</a>, <a class="el" href="MOM__file__parser_8F90_source.html#l01810">mom_file_parser::openparameterblock()</a>, <a class="el" href="MOM__diag__mediator_8F90_source.html#l01048">mom_diag_mediator::register_diag_field()</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00043">sw_method_all_sw</a>, <a class="el" href="MOM__KPP_8F90_source.html#l00045">sw_method_lv1_sw</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00044">sw_method_mxl_sw</a>.</p>
<div class="fragment"><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: paramfile<span class="comment"> !&lt; File parser</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(in)</span>    :: g<span class="comment">         !&lt; Ocean grid</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in)</span>    :: diag<span class="comment">      !&lt; Diagnostics</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: time<span class="comment">      !&lt; Time</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordtype">type</span>(kpp_cs),            <span class="keywordtype">pointer</span>       :: cs<span class="comment">        !&lt; Control structure</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,       <span class="keywordtype">intent(out)</span>   :: passive<span class="comment">   !&lt; Copy of %passiveMode</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span> :: mdl = <span class="stringliteral">&#39;MOM_KPP&#39;</span> <span class="comment">! name of this module</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keywordtype">character(len=20)</span> :: string          <span class="comment">! local temporary string</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordtype">logical</span> :: cs_is_one=.false.</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&#39;MOM_KPP, KPP_init: &#39;</span>// &amp;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;           <span class="stringliteral">&#39;Control structure has already been initialized&#39;</span>)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">! Read parameters</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keyword">call </span>log_version(paramfile, mdl, version, <span class="stringliteral">&#39;This is the MOM wrapper to CVmix:KPP\n&#39;</span> // &amp;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            <span class="stringliteral">&#39;See http://code.google.com/p/cvmix/&#39;</span>)</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&quot;USE_KPP&quot;</span>, kpp_init, &amp;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                 <span class="stringliteral">&quot;If true, turns on the [CVmix] KPP scheme of Large et al., 1994,\n&quot;</span>// &amp;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                 <span class="stringliteral">&quot;to calculate diffusivities and non-local transport in the OBL.&quot;</span>,     &amp;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                 default=.false.)</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">! Forego remainder of initialization if not using this scheme</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="keywordflow">if</span> (.not. kpp_init) <span class="keywordflow">return</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="keyword">call </span>openparameterblock(paramfile,<span class="stringliteral">&#39;KPP&#39;</span>)</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;PASSIVE&#39;</span>, cs%passiveMode,           &amp;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                 <span class="stringliteral">&#39;If True, puts KPP into a passive-diagnostic mode.&#39;</span>, &amp;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                  default=.false.)</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(passive)) passive=cs%passiveMode <span class="comment">! This is passed back to the caller so</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                                               <span class="comment">! the caller knows to not use KPP output</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;APPLY_NONLOCAL_TRANSPORT&#39;</span>, cs%applyNonLocalTrans,  &amp;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                 <span class="stringliteral">&#39;If True, applies the non-local transport to heat and scalars.\n&#39;</span>//  &amp;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                 <span class="stringliteral">&#39;If False, calculates the non-local transport and tendencies but\n&#39;</span>//&amp;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                 <span class="stringliteral">&#39;purely for diagnostic purposes.&#39;</span>,                                   &amp;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                 default=.not. cs%passiveMode)</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;RI_CRIT&#39;</span>, cs%Ri_crit,                            &amp;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                 <span class="stringliteral">&#39;Critical bulk Richardson number used to define depth of the\n&#39;</span>// &amp;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                 <span class="stringliteral">&#39;surface Ocean Boundary Layer (OBL).&#39;</span>,                            &amp;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                 units=<span class="stringliteral">&#39;nondim&#39;</span>, default=0.3)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;VON_KARMAN&#39;</span>, cs%vonKarman, &amp;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                 <span class="stringliteral">&#39;von Karman constant.&#39;</span>,                     &amp;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                 units=<span class="stringliteral">&#39;nondim&#39;</span>, default=0.40)</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;ENHANCE_DIFFUSION&#39;</span>, cs%enhance_diffusion,              &amp;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                 <span class="stringliteral">&#39;If True, adds enhanced diffusion at the based of the boundary layer.&#39;</span>, &amp;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                 default=.true.)</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;INTERP_TYPE&#39;</span>, cs%interpType,           &amp;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                 <span class="stringliteral">&#39;Type of interpolation to determine the OBL depth.\n&#39;</span>// &amp;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                 <span class="stringliteral">&#39;Allowed types are: linear, quadratic, cubic.&#39;</span>,         &amp;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                 default=<span class="stringliteral">&#39;cubic&#39;</span>)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;COMPUTE_EKMAN&#39;</span>, cs%computeEkman,             &amp;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                 <span class="stringliteral">&#39;If True, limit OBL depth to be no deeper than Ekman depth.&#39;</span>, &amp;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                 default=.false.)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;COMPUTE_MONIN_OBUKHOV&#39;</span>, cs%computeMoninObukhov, &amp;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                 <span class="stringliteral">&#39;If True, limit the OBL depth to be no deeper than\n&#39;</span>//          &amp;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                 <span class="stringliteral">&#39;Monin-Obukhov depth.&#39;</span>,                                          &amp;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                 default=.false.)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;CS&#39;</span>, cs%cs,                        &amp;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                 <span class="stringliteral">&#39;Parameter for computing velocity scale function.&#39;</span>, &amp;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                 units=<span class="stringliteral">&#39;nondim&#39;</span>, default=98.96)</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;CS2&#39;</span>, cs%cs2,                        &amp;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                 <span class="stringliteral">&#39;Parameter for computing non-local term.&#39;</span>, &amp;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                 units=<span class="stringliteral">&#39;nondim&#39;</span>, default=6.32739901508)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;DEEP_OBL_OFFSET&#39;</span>, cs%deepOBLoffset,                             &amp;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                 <span class="stringliteral">&#39;If non-zero, the distance above the bottom to which the OBL is clipped\n&#39;</span>//     &amp;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                 <span class="stringliteral">&#39;if it would otherwise reach the bottom. The smaller of this and 0.1D is used.&#39;</span>, &amp;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                 units=<span class="stringliteral">&#39;m&#39;</span>,default=0.)</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;FIXED_OBLDEPTH&#39;</span>, cs%fixedOBLdepth,       &amp;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                 <span class="stringliteral">&#39;If True, fix the OBL depth to FIXED_OBLDEPTH_VALUE\n&#39;</span>//  &amp;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                 <span class="stringliteral">&#39;rather than using the OBL depth from CVMix.\n&#39;</span>//         &amp;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                 <span class="stringliteral">&#39;This option is just for testing purposes.&#39;</span>,              &amp;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                 default=.false.)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;FIXED_OBLDEPTH_VALUE&#39;</span>, cs%fixedOBLdepth_value,  &amp;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                 <span class="stringliteral">&#39;Value for the fixed OBL depth when fixedOBLdepth==True. \n&#39;</span>//   &amp;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                 <span class="stringliteral">&#39;This parameter is for just for testing purposes. \n&#39;</span>//          &amp;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                 <span class="stringliteral">&#39;It will over-ride the OBLdepth computed from CVMix.&#39;</span>,           &amp;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                 units=<span class="stringliteral">&#39;m&#39;</span>,default=30.0)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;SURF_LAYER_EXTENT&#39;</span>, cs%surf_layer_ext,   &amp;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                 <span class="stringliteral">&#39;Fraction of OBL depth considered in the surface layer.&#39;</span>, &amp;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                 units=<span class="stringliteral">&#39;nondim&#39;</span>,default=0.10)</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;MINIMUM_OBL_DEPTH&#39;</span>, cs%minOBLdepth,                            &amp;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;                 <span class="stringliteral">&#39;If non-zero, a minimum depth to use for KPP OBL depth. Independent of\n&#39;</span>//     &amp;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                 <span class="stringliteral">&#39;this parameter, the OBL depth is always at least as deep as the first layer.&#39;</span>, &amp;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                 units=<span class="stringliteral">&#39;m&#39;</span>,default=0.)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;MINIMUM_VT2&#39;</span>, cs%minVtsqr,                                   &amp;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                 <span class="stringliteral">&#39;Min of the unresolved velocity Vt2 used in Rib CVMix calculation.     \n&#39;</span>//  &amp;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                 <span class="stringliteral">&#39;Scaling: MINIMUM_VT2 = const1*d*N*ws, with d=1m, N=1e-5/s, ws=1e-6 m/s.&#39;</span>,    &amp;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                 units=<span class="stringliteral">&#39;m2/s2&#39;</span>,default=1e-10)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">! smg: for removal below</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;CORRECT_SURFACE_LAYER_AVERAGE&#39;</span>, cs%correctSurfLayerAvg,   &amp;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                 <span class="stringliteral">&#39;If true, applies a correction step to the averaging of surface layer\n&#39;</span>// &amp;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                 <span class="stringliteral">&#39;properties. This option is obsolete.&#39;</span>, default=.false.)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;FIRST_GUESS_SURFACE_LAYER_DEPTH&#39;</span>, cs%surfLayerDepth,              &amp;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                 <span class="stringliteral">&#39;The first guess at the depth of the surface layer used for averaging\n&#39;</span>//         &amp;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                 <span class="stringliteral">&#39;the surface layer properties. If =0, the top model level properties\n&#39;</span>//          &amp;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                 <span class="stringliteral">&#39;will be used for the surface layer. If CORRECT_SURFACE_LAYER_AVERAGE=True, a\n&#39;</span>// &amp;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                 <span class="stringliteral">&#39;subsequent correction is applied. This parameter is obsolete&#39;</span>, units=<span class="stringliteral">&#39;m&#39;</span>, default=0.)</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">! smg: for removal above</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;NLT_SHAPE&#39;</span>, string, &amp;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                 <span class="stringliteral">&#39;MOM6 method to set nonlocal transport profile.\n&#39;</span>//                          &amp;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                 <span class="stringliteral">&#39;Over-rides the result from CVMix.  Allowed values are: \n&#39;</span>//                 &amp;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                 <span class="stringliteral">&#39;\t CVMIX     - Uses the profiles from CVmix specified by MATCH_TECHNIQUE\n&#39;</span>//&amp;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                 <span class="stringliteral">&#39;\t LINEAR    - A linear profile, 1-sigma\n&#39;</span>//                                &amp;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                 <span class="stringliteral">&#39;\t PARABOLIC - A parablic profile, (1-sigma)^2\n&#39;</span>//                          &amp;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                 <span class="stringliteral">&#39;\t CUBIC     - A cubic profile, (1-sigma)^2(1+2*sigma)\n&#39;</span>//                  &amp;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                 <span class="stringliteral">&#39;\t CUBIC_LMD - The original KPP profile&#39;</span>,                                    &amp;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                 default=<span class="stringliteral">&#39;CVMIX&#39;</span>)</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordflow">select case</span> ( trim(string) )</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;CVMIX&quot;</span>)     ; cs%NLT_shape = nlt_shape_cvmix</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;LINEAR&quot;</span>)    ; cs%NLT_shape = nlt_shape_linear</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PARABOLIC&quot;</span>) ; cs%NLT_shape = nlt_shape_parabolic</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;CUBIC&quot;</span>)     ; cs%NLT_shape = nlt_shape_cubic</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;CUBIC_LMD&quot;</span>) ; cs%NLT_shape = nlt_shape_cubic_lmd</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keywordflow">    case default</span> ; <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;KPP_init: &quot;</span>// &amp;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                   <span class="stringliteral">&quot;Unrecognized NLT_SHAPE option&quot;</span>//trim(string))</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;MATCH_TECHNIQUE&#39;</span>, cs%MatchTechnique,                                    &amp;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                 <span class="stringliteral">&#39;CVMix method to set profile function for diffusivity and NLT,\n&#39;</span>//                      &amp;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                 <span class="stringliteral">&#39;as well as matching across OBL base. Allowed values are: \n&#39;</span>//                          &amp;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                 <span class="stringliteral">&#39;\t SimpleShapes      = sigma*(1-sigma)^2 for both diffusivity and NLT\n&#39;</span>//              &amp;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                 <span class="stringliteral">&#39;\t MatchGradient     = sigma*(1-sigma)^2 for NLT; diffusivity profile from matching\n&#39;</span>//&amp;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                 <span class="stringliteral">&#39;\t MatchBoth         = match gradient for both diffusivity and NLT\n&#39;</span>//                 &amp;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                 <span class="stringliteral">&#39;\t ParabolicNonLocal = sigma*(1-sigma)^2 for diffusivity; (1-sigma)^2 for NLT&#39;</span>,         &amp;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                 default=<span class="stringliteral">&#39;SimpleShapes&#39;</span>)</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keywordflow">if</span> (cs%MatchTechnique.eq.<span class="stringliteral">&#39;ParabolicNonLocal&#39;</span>) <span class="keywordflow">then</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;     <span class="comment">! This forces Cs2 (Cs in non-local computation) to equal 1 for parabolic non-local option.</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;     <span class="comment">!  May be used during CVmix initialization.</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;     cs_is_one=.true.</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;KPP_ZERO_DIFFUSIVITY&#39;</span>, cs%KPPzeroDiffusivity,            &amp;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                 <span class="stringliteral">&#39;If True, zeroes the KPP diffusivity and viscosity; for testing purpose.&#39;</span>,&amp;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                 default=.false.)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;KPP_IS_ADDITIVE&#39;</span>, cs%KPPisAdditive,                &amp;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                 <span class="stringliteral">&#39;If true, adds KPP diffusivity to diffusivity from other schemes.&#39;</span>//&amp;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                 <span class="stringliteral">&#39;If false, KPP is the only diffusivity wherever KPP is non-zero.&#39;</span>,  &amp;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                 default=.true.)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;KPP_SHORTWAVE_METHOD&#39;</span>,string,                      &amp;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                 <span class="stringliteral">&#39;Determines contribution of shortwave radiation to KPP surface &#39;</span>// &amp;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                 <span class="stringliteral">&#39;buoyancy flux.  Options include:\n&#39;</span>//                             &amp;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                 <span class="stringliteral">&#39;  ALL_SW: use total shortwave radiation\n&#39;</span>//                      &amp;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                 <span class="stringliteral">&#39;  MXL_SW:  use shortwave radiation absorbed by mixing layer\n&#39;</span>//  &amp;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                 <span class="stringliteral">&#39;  LV1_SW:  use shortwave radiation absorbed by top model layer&#39;</span>,  &amp;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                 default=<span class="stringliteral">&#39;MXL_SW&#39;</span>)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keywordflow">select case</span> ( trim(string) )</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;ALL_SW&quot;</span>) ; cs%SW_METHOD = sw_method_all_sw</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;MXL_SW&quot;</span>) ; cs%SW_METHOD = sw_method_mxl_sw</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;LV1_SW&quot;</span>) ; cs%SW_METHOD = sw_method_lv1_sw</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordflow">    case default</span> ; <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;KPP_init: &quot;</span>// &amp;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                   <span class="stringliteral">&quot;Unrecognized KPP_SHORTWAVE_METHOD option&quot;</span>//trim(string))</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;CVMIX_ZERO_H_WORK_AROUND&#39;</span>, cs%min_thickness,                           &amp;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                 <span class="stringliteral">&#39;A minimum thickness used to avoid division by small numbers in the vicinity\n&#39;</span>//       &amp;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                 <span class="stringliteral">&#39;of vanished layers. This is independent of MIN_THICKNESS used in other parts of MOM.&#39;</span>, &amp;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                 units=<span class="stringliteral">&#39;m&#39;</span>, default=0.)</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="keyword">call </span>closeparameterblock(paramfile)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="keyword">call </span>get_param(paramfile, mdl, <span class="stringliteral">&#39;DEBUG&#39;</span>, cs%debug, default=.false., do_not_log=.true.)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="keyword">call </span>cvmix_init_kpp( ri_crit=cs%Ri_crit,                 &amp;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                       minobldepth=cs%minOBLdepth,         &amp;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                       minvtsqr=cs%minVtsqr,               &amp;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                       vonkarman=cs%vonKarman,             &amp;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                       surf_layer_ext=cs%surf_layer_ext,   &amp;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                       interp_type=cs%interpType,          &amp;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                       lekman=cs%computeEkman,             &amp;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                       lmonob=cs%computeMoninObukhov,      &amp;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                       matchtechnique=cs%MatchTechnique,   &amp;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                       lenhanced_diff=cs%enhance_diffusion,&amp;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                       lnonzero_surf_nonlocal=cs_is_one   ,&amp;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                       cvmix_kpp_params_user=cs%KPP_params )</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="comment">! Register diagnostics</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  cs%id_OBLdepth = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_OBLdepth&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;      <span class="stringliteral">&#39;Thickness of the surface Ocean Boundary Layer calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>, &amp;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      cmor_field_name=<span class="stringliteral">&#39;oml&#39;</span>, cmor_long_name=<span class="stringliteral">&#39;ocean_mixed_layer_thickness_defined_by_mixing_scheme&#39;</span>, &amp;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      cmor_units=<span class="stringliteral">&#39;m&#39;</span>, cmor_standard_name=<span class="stringliteral">&#39;Ocean Mixed Layer Thickness Defined by Mixing Scheme&#39;</span>)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      <span class="comment">! CMOR names are placeholders; must be modified by time period</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <span class="comment">! for CMOR compliance. Diag manager will be used for omlmax and</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      <span class="comment">! omldamax.</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  cs%id_BulkDrho = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_BulkDrho&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      <span class="stringliteral">&#39;Bulk difference in density used in Bulk Richardson number, as used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;kg/m3&#39;</span>)</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  cs%id_BulkUz2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_BulkUz2&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      <span class="stringliteral">&#39;Square of bulk difference in resolved velocity used in Bulk Richardson number via [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s2&#39;</span>)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  cs%id_BulkRi = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_BulkRi&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      <span class="stringliteral">&#39;Bulk Richardson number used to find the OBL depth used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  cs%id_Sigma = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_sigma&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;      <span class="stringliteral">&#39;Sigma coordinate used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  cs%id_Ws = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Ws&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;      <span class="stringliteral">&#39;Turbulent vertical velocity scale for scalars used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  cs%id_N = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_N&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;      <span class="stringliteral">&#39;(Adjusted) Brunt-Vaisala frequency used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;1/s&#39;</span>)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  cs%id_N2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_N2&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      <span class="stringliteral">&#39;Square of Brunt-Vaisala frequency used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;1/s2&#39;</span>)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  cs%id_Vt2 = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Vt2&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      <span class="stringliteral">&#39;Unresolved shear turbulence used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s2&#39;</span>)</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  cs%id_uStar = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_uStar&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      <span class="stringliteral">&#39;Friction velocity, u*, as used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  cs%id_buoyFlux = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_buoyFlux&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="stringliteral">&#39;Surface (and penetrating) buoyancy flux, as used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s3&#39;</span>)</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  cs%id_QminusSW = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_QminusSW&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      <span class="stringliteral">&#39;Net temperature flux ignoring short-wave, as used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;K m/s&#39;</span>)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  cs%id_netS = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_netSalt&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      <span class="stringliteral">&#39;Effective net surface salt flux, as used by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;ppt m/s&#39;</span>)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  cs%id_Kt_KPP = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Kheat&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="stringliteral">&#39;Heat diffusivity due to KPP, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s&#39;</span>)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  cs%id_Kd_in = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Kd_in&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <span class="stringliteral">&#39;Diffusivity passed to KPP&#39;</span>, <span class="stringliteral">&#39;m2/s&#39;</span>)</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  cs%id_Ks_KPP = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Ksalt&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;      <span class="stringliteral">&#39;Salt diffusivity due to KPP, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s&#39;</span>)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  cs%id_Kv_KPP = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Kv&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="stringliteral">&#39;Vertical viscosity due to KPP, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m2/s&#39;</span>)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  cs%id_NLTt = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLtransport_heat&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      <span class="stringliteral">&#39;Non-local transport (Cs*G(sigma)) for heat, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  cs%id_NLTs = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLtransport_salt&#39;</span>, diag%axesTi, time, &amp;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      <span class="stringliteral">&#39;Non-local tranpsort (Cs*G(sigma)) for scalars, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  cs%id_NLT_dTdt = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLT_dTdt&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      <span class="stringliteral">&#39;Temperature tendency due to non-local transport of heat, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;K/s&#39;</span>)</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  cs%id_NLT_dSdt = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLT_dSdt&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      <span class="stringliteral">&#39;Salinity tendency due to non-local transport of salt, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;ppt/s&#39;</span>)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  cs%id_NLT_temp_budget = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLT_temp_budget&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      <span class="stringliteral">&#39;Heat content change due to non-local transport, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;W/m^2&#39;</span>)</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  cs%id_NLT_saln_budget = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_NLT_saln_budget&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      <span class="stringliteral">&#39;Salt content change due to non-local transport, as calculated by [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;kg/(sec*m^2)&#39;</span>)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  cs%id_Tsurf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Tsurf&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      <span class="stringliteral">&#39;Temperature of surface layer (10% of OBL depth) as passed to [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>)</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  cs%id_Ssurf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Ssurf&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      <span class="stringliteral">&#39;Salinity of surface layer (10% of OBL depth) as passed to [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;ppt&#39;</span>)</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  cs%id_Usurf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Usurf&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      <span class="stringliteral">&#39;i-component flow of surface layer (10% of OBL depth) as passed to [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  cs%id_Vsurf = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KPP_Vsurf&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;      <span class="stringliteral">&#39;j-component flow of surface layer (10% of OBL depth) as passed to [CVmix] KPP&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="keywordflow">if</span> (cs%id_OBLdepth &gt; 0) <span class="keyword">allocate</span>( cs%OBLdepth( szi_(g), szj_(g) ) )</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordflow">if</span> (cs%id_OBLdepth &gt; 0) cs%OBLdepth(:,:) = 0.</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkDrho &gt; 0) <span class="keyword">allocate</span>( cs%dRho( szi_(g), szj_(g), szk_(g) ) )</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkDrho &gt; 0) cs%dRho(:,:,:) = 0.</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkUz2 &gt; 0)  <span class="keyword">allocate</span>( cs%Uz2( szi_(g), szj_(g), szk_(g) ) )</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkUz2 &gt; 0)  cs%Uz2(:,:,:) = 0.</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkRi &gt; 0)   <span class="keyword">allocate</span>( cs%BulkRi( szi_(g), szj_(g), szk_(g) ) )</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordflow">if</span> (cs%id_BulkRi &gt; 0)   cs%BulkRi(:,:,:) = 0.</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordflow">if</span> (cs%id_Sigma &gt; 0)    <span class="keyword">allocate</span>( cs%sigma( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordflow">if</span> (cs%id_Sigma &gt; 0)    cs%sigma(:,:,:) = 0.</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ws &gt; 0)       <span class="keyword">allocate</span>( cs%Ws( szi_(g), szj_(g), szk_(g) ) )</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ws &gt; 0)       cs%Ws(:,:,:) = 0.</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="keywordflow">if</span> (cs%id_N &gt; 0)        <span class="keyword">allocate</span>( cs%N( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordflow">if</span> (cs%id_N &gt; 0)        cs%N(:,:,:) = 0.</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="keywordflow">if</span> (cs%id_N2 &gt; 0)       <span class="keyword">allocate</span>( cs%N2( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordflow">if</span> (cs%id_N2 &gt; 0)       cs%N2(:,:,:) = 0.</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vt2 &gt; 0)      <span class="keyword">allocate</span>( cs%Vt2( szi_(g), szj_(g), szk_(g) ) )</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vt2 &gt; 0)      cs%Vt2(:,:,:) = 0.</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kt_KPP &gt; 0)   <span class="keyword">allocate</span>( cs%Kt_KPP( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kt_KPP &gt; 0)   cs%Kt_KPP(:,:,:) = 0.</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ks_KPP &gt; 0)   <span class="keyword">allocate</span>( cs%Ks_KPP( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ks_KPP &gt; 0)   cs%Ks_KPP(:,:,:) = 0.</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kv_KPP &gt; 0)   <span class="keyword">allocate</span>( cs%Kv_KPP( szi_(g), szj_(g), szk_(g)+1 ) )</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kv_KPP &gt; 0)   cs%Kv_KPP(:,:,:) = 0.</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">if</span> (cs%id_Tsurf &gt; 0)    <span class="keyword">allocate</span>( cs%Tsurf( szi_(g), szj_(g)) )</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordflow">if</span> (cs%id_Tsurf &gt; 0)    cs%Tsurf(:,:) = 0.</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ssurf &gt; 0)    <span class="keyword">allocate</span>( cs%Ssurf( szi_(g), szj_(g)) )</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ssurf &gt; 0)    cs%Ssurf(:,:) = 0.</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="keywordflow">if</span> (cs%id_Usurf &gt; 0)    <span class="keyword">allocate</span>( cs%Usurf( szib_(g), szj_(g)) )</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordflow">if</span> (cs%id_Usurf &gt; 0)    cs%Usurf(:,:) = 0.</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vsurf &gt; 0)    <span class="keyword">allocate</span>( cs%Vsurf( szi_(g), szjb_(g)) )</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordflow">if</span> (cs%id_Vsurf &gt; 0)    cs%Vsurf(:,:) = 0.</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__kpp_a9c834424b6e067e280928db3700ec77e_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad46904979c826432df224c38e84f3043"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad46904979c826432df224c38e84f3043">&#9670;&nbsp;</a></span>kpp_nonlocaltransport_saln()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kpp::kpp_nonlocaltransport_saln </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>nonLocalTrans</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>surfFlux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>scalar</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply KPP non-local transport of surface fluxes for salinity. This routine is a useful prototype for other material tracers. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer/level thickness (units of H)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nonlocaltrans</td><td>Non-local transport (non-dimensional)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">surfflux</td><td>Surface flux of scalar (H/s * scalar)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time-step (s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">scalar</td><td>Scalar (scalar units) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l01003">1003</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00235">mom_diabatic_driver::diabatic()</a>.</p>
<div class="fragment"><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  <span class="keywordtype">type</span>(kpp_cs),                               <span class="keywordtype">intent(in)</span>    :: cs<span class="comment">            !&lt; Control structure</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">             !&lt; Ocean grid</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">            !&lt; Ocean vertical grid</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">             !&lt; Layer/level thickness (units of H)</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(in)</span>    :: nonlocaltrans<span class="comment"> !&lt; Non-local transport (non-dimensional)</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: surfflux<span class="comment">      !&lt; Surface flux of scalar (H/s * scalar)</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="keywordtype">real</span>,                                       <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">            !&lt; Time-step (s)</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(inout)</span> :: scalar<span class="comment">        !&lt; Scalar (scalar units)</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( SZI_(G), SZJ_(G), SZK_(G) )</span> :: dtracer</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  dtracer(:,:,:) = 0.0</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,dtracer,nonLocalTrans,h,surfFlux,CS,scalar,dt)</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;      <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        dtracer(i,j,k) = ( nonlocaltrans(i,j,k) - nonlocaltrans(i,j,k+1) ) / &amp;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                         ( h(i,j,k) + gv%H_subroundoff ) * surfflux(i,j)</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;  <span class="comment">!  Update tracer due to non-local redistribution of surface flux</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;  <span class="keywordflow">if</span> (cs%applyNonLocalTrans) <span class="keywordflow">then</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;          scalar(i,j,k) = scalar(i,j,k) + dt * dtracer(i,j,k)</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;  <span class="comment">! Diagnostics</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="keywordflow">if</span> (cs%id_netS            &gt; 0) <span class="keyword">call </span>post_data(cs%id_netS,     surfflux, cs%diag)</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLT_dSdt        &gt; 0) <span class="keyword">call </span>post_data(cs%id_NLT_dSdt, dtracer,  cs%diag)</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLT_saln_budget &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    dtracer(:,:,:) = 0.0</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;      <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;          dtracer(i,j,k) = (nonlocaltrans(i,j,k) - nonlocaltrans(i,j,k+1)) * &amp;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                           surfflux(i,j) * gv%H_to_kg_m2</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="keyword">call </span>post_data(cs%id_NLT_saln_budget, dtracer, cs%diag)</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kpp_ad46904979c826432df224c38e84f3043_icgraph.svg" width="447" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aa69a77d09b776e8b85d9908c716cb2b1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa69a77d09b776e8b85d9908c716cb2b1">&#9670;&nbsp;</a></span>kpp_nonlocaltransport_temp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_kpp::kpp_nonlocaltransport_temp </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__kpp_1_1kpp__cs.html">kpp_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke+1), intent(in)&#160;</td>
          <td class="paramname"><em>nonLocalTrans</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>surfFlux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>scalar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>C_p</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply KPP non-local transport of surface fluxes for temperature. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer/level thickness (units of H)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nonlocaltrans</td><td>Non-local transport (non-dimensional)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">surfflux</td><td>Surface flux of scalar (H/s * scalar)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Time-step (s)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">scalar</td><td>temperature</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">c_p</td><td>Seawater specific heat capacity (J/(kg*K)) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00944">944</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__diabatic__driver_8F90_source.html#l00235">mom_diabatic_driver::diabatic()</a>.</p>
<div class="fragment"><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordtype">type</span>(kpp_cs),                               <span class="keywordtype">intent(in)</span>    :: cs<span class="comment">            !&lt; Control structure</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">             !&lt; Ocean grid</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">            !&lt; Ocean vertical grid</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">             !&lt; Layer/level thickness (units of H)</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span>, <span class="keywordtype">intent(in)</span>    :: nonlocaltrans<span class="comment"> !&lt; Non-local transport (non-dimensional)</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,           <span class="keywordtype">intent(in)</span>    :: surfflux<span class="comment">      !&lt; Surface flux of scalar (H/s * scalar)</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <span class="keywordtype">real</span>,                                       <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">            !&lt; Time-step (s)</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(inout)</span> :: scalar<span class="comment">        !&lt; temperature</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordtype">real</span>,                                       <span class="keywordtype">intent(in)</span>    :: c_p<span class="comment">           !&lt; Seawater specific heat capacity (J/(kg*K))</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension( SZI_(G), SZJ_(G), SZK_(G) )</span> :: dtracer</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  dtracer(:,:,:) = 0.0</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,dtracer,nonLocalTrans,h,surfFlux,CS,scalar,dt)</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        dtracer(i,j,k) = ( nonlocaltrans(i,j,k) - nonlocaltrans(i,j,k+1) ) / &amp;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                         ( h(i,j,k) + gv%H_subroundoff ) * surfflux(i,j)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;  <span class="comment">!  Update tracer due to non-local redistribution of surface flux</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordflow">if</span> (cs%applyNonLocalTrans) <span class="keywordflow">then</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;      <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;          scalar(i,j,k) = scalar(i,j,k) + dt * dtracer(i,j,k)</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="comment">! Diagnostics</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="keywordflow">if</span> (cs%id_QminusSW        &gt; 0) <span class="keyword">call </span>post_data(cs%id_QminusSW, surfflux, cs%diag)</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLT_dTdt        &gt; 0) <span class="keyword">call </span>post_data(cs%id_NLT_dTdt, dtracer,  cs%diag)</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  <span class="keywordflow">if</span> (cs%id_NLT_temp_budget &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    dtracer(:,:,:) = 0.0</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;    <span class="keywordflow">do</span> k = 1, g%ke</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;      <span class="keywordflow">do</span> j = g%jsc, g%jec</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        <span class="keywordflow">do</span> i = g%isc, g%iec</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;          dtracer(i,j,k) = (nonlocaltrans(i,j,k) - nonlocaltrans(i,j,k+1)) * &amp;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                           surfflux(i,j) * c_p * gv%H_to_kg_m2</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    <span class="keyword">call </span>post_data(cs%id_NLT_temp_budget, dtracer, cs%diag)</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__kpp_aa69a77d09b776e8b85d9908c716cb2b1_icgraph.svg" width="452" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ae4cccaa3c7e998023cce98a8aefdc9ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae4cccaa3c7e998023cce98a8aefdc9ec">&#9670;&nbsp;</a></span>nlt_shape_cubic</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::nlt_shape_cubic = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Cubic, \( G(\sigma) = 1 + (2\sigma-3) \sigma^2\). </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00040">40</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: nlt_shape_cubic     = 3<span class="comment"> !&lt; Cubic, \f$ G(\sigma) = 1 + (2\sigma-3) \sigma^2\f$</span></div></div><!-- fragment -->
</div>
</div>
<a id="ab7fe55c332f4b25ba6a15be447243a86"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab7fe55c332f4b25ba6a15be447243a86">&#9670;&nbsp;</a></span>nlt_shape_cubic_lmd</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::nlt_shape_cubic_lmd = 4</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Original shape, \( G(\sigma) = \frac{27}{4} \sigma (1-\sigma)^2 \). </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00041">41</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: nlt_shape_cubic_lmd = 4<span class="comment"> !&lt; Original shape, \f$ G(\sigma) = \frac{27}{4} \sigma (1-\sigma)^2 \f$</span></div></div><!-- fragment -->
</div>
</div>
<a id="a8ce04e556df335d2920049e027319f95"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ce04e556df335d2920049e027319f95">&#9670;&nbsp;</a></span>nlt_shape_cvmix</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::nlt_shape_cvmix = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use the CVmix profile. </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00037">37</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: nlt_shape_cvmix     = 0<span class="comment"> !&lt; Use the CVmix profile</span></div></div><!-- fragment -->
</div>
</div>
<a id="ab4082e47ef31d736769267b912a55cae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab4082e47ef31d736769267b912a55cae">&#9670;&nbsp;</a></span>nlt_shape_linear</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::nlt_shape_linear = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Linear, \( G(\sigma) = 1-\sigma \). </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00038">38</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: nlt_shape_linear    = 1<span class="comment"> !&lt; Linear, \f$ G(\sigma) = 1-\sigma \f$</span></div></div><!-- fragment -->
</div>
</div>
<a id="a4d0b609996e88b8cc96070089c58a9bc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4d0b609996e88b8cc96070089c58a9bc">&#9670;&nbsp;</a></span>nlt_shape_parabolic</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::nlt_shape_parabolic = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Parabolic, \( G(\sigma) = (1-\sigma)^2 \). </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00039">39</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: nlt_shape_parabolic = 2<span class="comment"> !&lt; Parabolic, \f$ G(\sigma) = (1-\sigma)^2 \f$</span></div></div><!-- fragment -->
</div>
</div>
<a id="ac780edab0da6d9b4d4447dcbd33c70b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac780edab0da6d9b4d4447dcbd33c70b8">&#9670;&nbsp;</a></span>sw_method_all_sw</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::sw_method_all_sw = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use all shortwave radiation. </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00043">43</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: sw_method_all_sw = 0<span class="comment"> !&lt; Use all shortwave radiation</span></div></div><!-- fragment -->
</div>
</div>
<a id="a26511e698d325cfd0c8d4be02af7ef00"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26511e698d325cfd0c8d4be02af7ef00">&#9670;&nbsp;</a></span>sw_method_lv1_sw</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::sw_method_lv1_sw = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use shortwave radiation absorbed in layer 1. </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00045">45</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: sw_method_lv1_sw = 2<span class="comment"> !&lt; Use shortwave radiation absorbed in layer 1</span></div></div><!-- fragment -->
</div>
</div>
<a id="a5553d1f1600b10d49015b4b8d34e2885"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5553d1f1600b10d49015b4b8d34e2885">&#9670;&nbsp;</a></span>sw_method_mxl_sw</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter, private mom_kpp::sw_method_mxl_sw = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Use shortwave radiation absorbed in mixing layer. </p>

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00044">44</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__KPP_8F90_source.html#l00413">kpp_calculate()</a>, and <a class="el" href="MOM__KPP_8F90_source.html#l00133">kpp_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">private</span>, <span class="keywordtype">parameter</span> :: sw_method_mxl_sw = 1<span class="comment"> !&lt; Use shortwave radiation absorbed in mixing layer</span></div></div><!-- fragment -->
</div>
</div>
<a id="a12e1097a88e7ea3f5bcc91673f192295"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a12e1097a88e7ea3f5bcc91673f192295">&#9670;&nbsp;</a></span>verbose</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical, parameter mom_kpp::verbose = .False.</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__KPP_8F90_source.html#l00125">125</a> of file <a class="el" href="MOM__KPP_8F90_source.html">MOM_KPP.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: verbose = .false.</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__kpp.html">mom_kpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
