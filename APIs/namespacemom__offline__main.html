<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_offline_main Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__offline__main.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_offline_main Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>The routines here implement the offline tracer algorithm used in MOM6. These are called from step_offline Some routines called here can be found in the MOM_offline_aux module. </p>
<h1><a class="anchor" id="offline_overview"></a>
Offline Tracer Transport in MOM6</h1>
<p>'Offline tracer modeling' uses physical fields (e.g. mass transports and layer thicknesses) saved from a previous integration of the physical model to transport passive tracers. These fields are accumulated or averaged over a period of time (in this test case, 1 day) and used to integrate portions of the MOM6 code base that handle the 3d advection and diffusion of passive tracers.</p>
<p>The distribution of tracers in the ocean modeled offline should not be expected to match an online simulation. Accumulating transports over more than one online model timestep implicitly assumes homogeneity over that time period and essentially aliases over processes that occur with higher frequency. For example, consider the case of a surface boundary layer with a strong diurnal cycle. An offline simulation with a 1 day timestep, captures the net transport into or out of that layer, but not the exact cycling. This effective aliasing may also complicate online model configurations which strongly-eddying regions. In this case, the offline model timestep must be limited to some fraction of the eddy correlation timescale. Lastly, the nonlinear advection scheme which applies limited mass-transports over a sequence of iterations means that tracers are not transported along exactly the same path as they are in the online model.</p>
<p>This capability has currently targeted the Baltic_ALE_z test case, though some work has also been done with the OM4 1/2 degree configuration. Work is ongoing to develop recommendations and best practices for investigators seeking to use MOM6 for offline tracer modeling.</p>
<h1><a class="anchor" id="offline_technical"></a>
Implementation of offline routine in MOM6</h1>
<p>The subroutine step_tracers that coordinates this can be found in <a class="el" href="MOM_8F90.html">MOM.F90</a> and is only called using the solo ocean driver. This is to avoid issues with coupling to other climate components that may be relying on fluxes from the ocean to be coupled more often than the offline time step. Other routines related to offline tracer modeling can be found in tracers/MOM_offline_control.F90</p>
<p>As can also be seen in the comments for the step_tracers subroutine, an offline time step comprises the following steps:</p><ol type="1">
<li>Using the layer thicknesses and tracer concentrations from the previous timestep, half of the accumulated vertical mixing (eatr and ebtr) is applied in the call to tracer_column_fns. For tracers whose source/sink terms need dt, this value is set to 1/2 dt_offline</li>
<li>Half of the accumulated surface freshwater fluxes are applied START ITERATION</li>
<li>Accumulated mass fluxes are used to do horizontal transport. The number of iterations used in advect_tracer is limited to 2 (e.g x-&gt;y-&gt;x-&gt;y). The remaining mass fluxes are stored for later use and resulting layer thicknesses fed into the next step</li>
<li>Tracers and the h-grid are regridded and remapped in a call to ALE. This allows for layers which might 'vanish' because of horizontal mass transport to be 'reinflated' and essentially allows for the vertical transport of tracers</li>
<li>Check that transport is done if the remaining mass fluxes equals 0 or if the max number of iterations has been reached END ITERATION</li>
<li>Repeat steps 1 and 2</li>
<li>Redistribute any residual mass fluxes that remain after the advection iterations in a barotropic manner, progressively upward through the water column.</li>
<li>Force a remapping to the stored layer thicknesses that correspond to the snapshot of the online model at the end of an accumulation interval</li>
<li>Reset T/S and h to their stored snapshotted values to prevent model drift</li>
</ol>
<h1><a class="anchor" id="offline_evaluation"></a>
Evaluating the utility of an offline tracer model</h1>
<p>How well an offline tracer model can be used as an alternative to integrating tracers online with the prognostic model must be evaluated for each application. This efficacy may be related to the native coordinate of the online model, to the length of the offline timestep, and to the behavior of the tracer itself.</p>
<p>A framework for formally regression testing the offline capability still needs to be developed. However, as a simple way of testing whether the offline model is nominally behaving as expected, the total inventory of the advection test tracers (tr1, tr2, etc.) should be conserved between time steps except for the last 4 decimal places. As a general guideline, an offline timestep of 5 days or less.</p>
<h1><a class="anchor" id="offline_parameters"></a>
Runtime parameters for offline tracers</h1>
<ul>
<li>OFFLINEDIR: Input directory where the offline fields can be found</li>
<li>OFF_SUM_FILE: Filename where the accumulated fields can be found (e.g. horizontal mass transports)</li>
<li>OFF_SNAP_FILE: Filename where snapshot fields can be found (e.g. end of timestep layer thickness)</li>
<li>START_INDEX: Which timelevel of the input files to read first</li>
<li>NUMTIME: How many timelevels to read before 'looping' back to 1</li>
<li>FIELDS_ARE_OFFSET: True if the time-averaged fields and snapshot fields are offset by one time level, probably not needed -NUM_OFF_ITER: Maximum number of iterations to do for the nonlinear advection scheme -REDISTRIBUTE_METHOD: Redistributes any remaining horizontal fluxes throughout the rest of water column. Options are 'barotropic' which "evenly distributes flux throughout the entire water column,'upwards' which adds the maximum of the remaining flux in each layer above, and 'none' which does no redistribution" </li>
</ul>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:ae85546d26ceb447742abe3c528cad2d7"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#ae85546d26ceb447742abe3c528cad2d7">offline_advection_ale</a> (fluxes, Time_start, time_interval, CS, id_clock_ale, h_pre, uhtr, vhtr, converged)</td></tr>
<tr class="memdesc:ae85546d26ceb447742abe3c528cad2d7"><td class="mdescLeft">&#160;</td><td class="mdescRight">3D advection is done by doing flux-limited nonlinear horizontal advection interspersed with an ALE regridding/remapping step. The loop in this routine is exited if remaining residual transports are below a runtime-specified value or a maximum number of iterations is reached.  <a href="#ae85546d26ceb447742abe3c528cad2d7">More...</a><br /></td></tr>
<tr class="separator:ae85546d26ceb447742abe3c528cad2d7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a312c47e83e64a6bdf064526f77a8a8ec"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a312c47e83e64a6bdf064526f77a8a8ec">offline_redistribute_residual</a> (CS, h_pre, uhtr, vhtr, converged)</td></tr>
<tr class="memdesc:a312c47e83e64a6bdf064526f77a8a8ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">In the case where the main advection routine did not converge, something needs to be done with the remaining transport. Two different ways are offered, 'barotropic' means that the residual is distributed equally throughout the water column. 'upwards' attempts to redistribute the transport in the layers above and will eventually work down the entire water column.  <a href="#a312c47e83e64a6bdf064526f77a8a8ec">More...</a><br /></td></tr>
<tr class="separator:a312c47e83e64a6bdf064526f77a8a8ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a713ee3448313842b0f07a5a750a01c60"><td class="memItemLeft" align="right" valign="top">real function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a713ee3448313842b0f07a5a750a01c60">remaining_transport_sum</a> (CS, uhtr, vhtr)</td></tr>
<tr class="memdesc:a713ee3448313842b0f07a5a750a01c60"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sums any non-negligible remaining transport to check for advection convergence.  <a href="#a713ee3448313842b0f07a5a750a01c60">More...</a><br /></td></tr>
<tr class="separator:a713ee3448313842b0f07a5a750a01c60"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaef35c02f93931567c41ae8bc0544bdd"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#aaef35c02f93931567c41ae8bc0544bdd">offline_diabatic_ale</a> (fluxes, Time_start, Time_end, CS, h_pre, eatr, ebtr)</td></tr>
<tr class="memdesc:aaef35c02f93931567c41ae8bc0544bdd"><td class="mdescLeft">&#160;</td><td class="mdescRight">The vertical/diabatic driver for offline tracers. First the eatr/ebtr associated with the interpolated vertical diffusivities are calculated and then any tracer column functions are done which can include vertical diffuvities and source/sink terms.  <a href="#aaef35c02f93931567c41ae8bc0544bdd">More...</a><br /></td></tr>
<tr class="separator:aaef35c02f93931567c41ae8bc0544bdd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a04d329761570d6d9fbc38589bea929cc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a04d329761570d6d9fbc38589bea929cc">offline_fw_fluxes_into_ocean</a> (G, GV, CS, fluxes, h, in_flux_optional)</td></tr>
<tr class="memdesc:a04d329761570d6d9fbc38589bea929cc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply positive freshwater fluxes (into the ocean) and update netMassOut with only the negative (out of the ocean) fluxes.  <a href="#a04d329761570d6d9fbc38589bea929cc">More...</a><br /></td></tr>
<tr class="separator:a04d329761570d6d9fbc38589bea929cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad96c09ff7c8f34d9602fd111ec492cfe"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#ad96c09ff7c8f34d9602fd111ec492cfe">offline_fw_fluxes_out_ocean</a> (G, GV, CS, fluxes, h, out_flux_optional)</td></tr>
<tr class="memdesc:ad96c09ff7c8f34d9602fd111ec492cfe"><td class="mdescLeft">&#160;</td><td class="mdescRight">Apply negative freshwater fluxes (out of the ocean)  <a href="#ad96c09ff7c8f34d9602fd111ec492cfe">More...</a><br /></td></tr>
<tr class="separator:ad96c09ff7c8f34d9602fd111ec492cfe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a887d59c64eb269aad257eacc8cf30444"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a887d59c64eb269aad257eacc8cf30444">offline_advection_layer</a> (fluxes, Time_start, time_interval, CS, h_pre, eatr, ebtr, uhtr, vhtr)</td></tr>
<tr class="memdesc:a887d59c64eb269aad257eacc8cf30444"><td class="mdescLeft">&#160;</td><td class="mdescRight">When in layer mode, 3D horizontal advection using stored mass fluxes must be used. Horizontal advection is done via tracer_advect, whereas the vertical component is actually handled by vertdiff in tracer_column_fns.  <a href="#a887d59c64eb269aad257eacc8cf30444">More...</a><br /></td></tr>
<tr class="separator:a887d59c64eb269aad257eacc8cf30444"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e59b996b88713928c04f72d57c5a531"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a2e59b996b88713928c04f72d57c5a531">update_offline_fields</a> (CS, h, fluxes, do_ale)</td></tr>
<tr class="memdesc:a2e59b996b88713928c04f72d57c5a531"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update fields used in this round of offline transport. First fields are updated from files or from arrays read during initialization. Then if in an ALE-dependent coordinate, regrid/remap fields.  <a href="#a2e59b996b88713928c04f72d57c5a531">More...</a><br /></td></tr>
<tr class="separator:a2e59b996b88713928c04f72d57c5a531"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0adf88ec8f84684573c1bafd91b22cf6"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a0adf88ec8f84684573c1bafd91b22cf6">register_diags_offline_transport</a> (Time, diag, CS)</td></tr>
<tr class="memdesc:a0adf88ec8f84684573c1bafd91b22cf6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize additional diagnostics required for offline tracer transport.  <a href="#a0adf88ec8f84684573c1bafd91b22cf6">More...</a><br /></td></tr>
<tr class="separator:a0adf88ec8f84684573c1bafd91b22cf6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad773f8f414f53f000cab30ad097aeaab"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#ad773f8f414f53f000cab30ad097aeaab">post_offline_convergence_diags</a> (CS, h_off, h_end, uhtr, vhtr)</td></tr>
<tr class="memdesc:ad773f8f414f53f000cab30ad097aeaab"><td class="mdescLeft">&#160;</td><td class="mdescRight">Posts diagnostics related to offline convergence diagnostics.  <a href="#ad773f8f414f53f000cab30ad097aeaab">More...</a><br /></td></tr>
<tr class="separator:ad773f8f414f53f000cab30ad097aeaab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a92877b75e72069b97573d2643a919106"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a92877b75e72069b97573d2643a919106">extract_offline_main</a> (CS, uhtr, vhtr, eatr, ebtr, h_end, accumulated_time, dt_offline, dt_offline_vertical, skip_diffusion)</td></tr>
<tr class="memdesc:a92877b75e72069b97573d2643a919106"><td class="mdescLeft">&#160;</td><td class="mdescRight">Extracts members of the offline main control structure. All arguments are optional except the control structure itself.  <a href="#a92877b75e72069b97573d2643a919106">More...</a><br /></td></tr>
<tr class="separator:a92877b75e72069b97573d2643a919106"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadf3150c45b59adac6e70933971e6f8a"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#aadf3150c45b59adac6e70933971e6f8a">insert_offline_main</a> (CS, ALE_CSp, diabatic_CSp, diag, OBC, tracer_adv_CSp, tracer_flow_CSp, tracer_Reg, tv, G, GV, x_before_y, debug)</td></tr>
<tr class="memdesc:aadf3150c45b59adac6e70933971e6f8a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Inserts (assigns values to) members of the offline main control structure. All arguments are optional except for the CS itself.  <a href="#aadf3150c45b59adac6e70933971e6f8a">More...</a><br /></td></tr>
<tr class="separator:aadf3150c45b59adac6e70933971e6f8a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3948771c2f4a319e66db28fe866e1549"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a3948771c2f4a319e66db28fe866e1549">offline_transport_init</a> (param_file, CS, diabatic_CSp, G, GV)</td></tr>
<tr class="memdesc:a3948771c2f4a319e66db28fe866e1549"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes the control structure for offline transport and reads in some of the.  <a href="#a3948771c2f4a319e66db28fe866e1549">More...</a><br /></td></tr>
<tr class="separator:a3948771c2f4a319e66db28fe866e1549"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abc6fd7e877d8e70014cbad2d4e3f11c5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#abc6fd7e877d8e70014cbad2d4e3f11c5">read_all_input</a> (CS)</td></tr>
<tr class="memdesc:abc6fd7e877d8e70014cbad2d4e3f11c5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Coordinates the allocation and reading in all time levels of uh, vh, hend, temp, and salt from files. Used when read_all_ts_uvh.  <a href="#abc6fd7e877d8e70014cbad2d4e3f11c5">More...</a><br /></td></tr>
<tr class="separator:abc6fd7e877d8e70014cbad2d4e3f11c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a853e9fbade83984621d26f51c1a2d651"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__offline__main.html#a853e9fbade83984621d26f51c1a2d651">offline_transport_end</a> (CS)</td></tr>
<tr class="memdesc:a853e9fbade83984621d26f51c1a2d651"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deallocates (if necessary) arrays within the offline control structure.  <a href="#a853e9fbade83984621d26f51c1a2d651">More...</a><br /></td></tr>
<tr class="separator:a853e9fbade83984621d26f51c1a2d651"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a92877b75e72069b97573d2643a919106"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a92877b75e72069b97573d2643a919106">&#9670;&nbsp;</a></span>extract_offline_main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::extract_offline_main </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(in), target&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>eatr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>ebtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:,:), intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>h_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out), optional, pointer&#160;</td>
          <td class="paramname"><em>accumulated_time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out), optional&#160;</td>
          <td class="paramname"><em>dt_offline</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(out), optional&#160;</td>
          <td class="paramname"><em>dt_offline_vertical</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(out), optional&#160;</td>
          <td class="paramname"><em>skip_diffusion</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Extracts members of the offline main control structure. All arguments are optional except the control structure itself. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Offline control structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01151">1151</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">target</span>, <span class="keywordtype">intent(in   )</span>  :: cs<span class="comment"> !&lt; Offline control structure</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;  <span class="comment">! Returned optional arguments</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: uhtr</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: vhtr</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: eatr</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: ebtr</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: h_end</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="keywordtype">integer</span>,                <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: accumulated_time</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  <span class="keywordtype">integer</span>,                         <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: dt_offline</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  <span class="keywordtype">integer</span>,                         <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: dt_offline_vertical</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  <span class="keywordtype">logical</span>,                         <span class="keywordtype">optional</span>, <span class="keywordtype">intent(  out)</span> :: skip_diffusion</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  <span class="comment">! Pointers to 3d members</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(uhtr)) uhtr =&gt; cs%uhtr</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(vhtr)) vhtr =&gt; cs%vhtr</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(eatr)) eatr =&gt; cs%eatr</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ebtr)) ebtr =&gt; cs%ebtr</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(h_end)) h_end =&gt; cs%h_end</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="comment">! Pointers to integer members which need to be modified</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(accumulated_time)) accumulated_time =&gt; cs%accumulated_time</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  <span class="comment">! Return value of non-modified integers</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_offline))  dt_offline = cs%dt_offline</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dt_offline_vertical)) dt_offline_vertical = cs%dt_offline_vertical</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(skip_diffusion)) skip_diffusion = cs%skip_diffusion</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="aadf3150c45b59adac6e70933971e6f8a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadf3150c45b59adac6e70933971e6f8a">&#9670;&nbsp;</a></span>insert_offline_main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::insert_offline_main </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ale_cs), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>ALE_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diabatic_cs), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>diabatic_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>OBC</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_advect_cs), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>tracer_adv_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_flow_control_cs), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>tracer_flow_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_registry_type), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>tracer_Reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in), optional, target&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>x_before_y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>debug</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Inserts (assigns values to) members of the offline main control structure. All arguments are optional except for the CS itself. </p>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01184">1184</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">intent(inout)</span> :: cs</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="comment">! Inserted optional arguments</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  <span class="keywordtype">type</span>(ale_cs),                 <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: ale_csp</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keywordtype">type</span>(diabatic_cs),            <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: diabatic_csp</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl),              <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: diag</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type),         <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: obc</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordtype">type</span>(tracer_advect_cs),       <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: tracer_adv_csp</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  <span class="keywordtype">type</span>(tracer_flow_control_cs), <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: tracer_flow_csp</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  <span class="keywordtype">type</span>(tracer_registry_type),   <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: tracer_reg</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),        <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: tv</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),        <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: g</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),      <span class="keywordtype">target</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: gv</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;  <span class="keywordtype">logical</span>,                              <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: x_before_y</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  <span class="keywordtype">logical</span>,                              <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in   )</span> :: debug</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(ale_csp))         cs%ALE_CSp =&gt; ale_csp</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(diabatic_csp))    cs%diabatic_CSp =&gt; diabatic_csp</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(diag))            cs%diag =&gt; diag</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(obc))             cs%OBC =&gt; obc</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tracer_adv_csp))  cs%tracer_adv_CSp =&gt; tracer_adv_csp</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tracer_flow_csp)) cs%tracer_flow_CSp =&gt; tracer_flow_csp</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tracer_reg))      cs%tracer_Reg =&gt; tracer_reg</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tv))              cs%tv =&gt; tv</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(g))               cs%G =&gt; g</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(gv))              cs%GV =&gt; gv</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(x_before_y))      cs%x_before_y = x_before_y</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(debug))           cs%debug = debug</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae85546d26ceb447742abe3c528cad2d7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae85546d26ceb447742abe3c528cad2d7">&#9670;&nbsp;</a></span>offline_advection_ale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_advection_ale </td>
          <td>(</td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time_start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>time_interval</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>id_clock_ale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( cs%g %isd: cs%g %ied, cs%g %jsd: cs%g %jed, cs%g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( cs%g %isdb: cs%g %iedb, cs%g %jsd: cs%g %jed, cs%g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( cs%g %isd: cs%g %ied, cs%g %jsdb: cs%g %jedb, cs%g %ke), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(out)&#160;</td>
          <td class="paramname"><em>converged</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>3D advection is done by doing flux-limited nonlinear horizontal advection interspersed with an ALE regridding/remapping step. The loop in this routine is exited if remaining residual transports are below a runtime-specified value or a maximum number of iterations is reached. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_start</td><td>starting time of a segment, as a time type</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_interval</td><td>time interval</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure for offline module</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">id_clock_ale</td><td>Clock for ALE routines</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_pre</td><td>layer thicknesses before advection</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>Zonal mass transport</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>Meridional mass transport </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00181">181</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">mom_tracer_advect::advect_tracer()</a>, <a class="el" href="MOM__ALE_8F90_source.html#l00446">mom_ale::ale_main_offline()</a>, <a class="el" href="MOM__tracer__registry_8F90_source.html#l00270">mom_tracer_registry::mom_tracer_chkinv()</a>, and <a class="el" href="MOM__offline__main_8F90_source.html#l00582">remaining_transport_sum()</a>.</p>
<div class="fragment"><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">type</span>(forcing),    <span class="keywordtype">intent(inout)</span>      :: fluxes<span class="comment">        !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keywordtype">type</span>(time_type),  <span class="keywordtype">intent(in)</span>         :: time_start<span class="comment">    !&lt; starting time of a segment, as a time type</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordtype">real</span>,             <span class="keywordtype">intent(in)</span>         :: time_interval<span class="comment"> !&lt; time interval</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment">            !&lt; control structure for offline module</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordtype">integer</span>,          <span class="keywordtype">intent(in)</span>         :: id_clock_ale<span class="comment">  !&lt; Clock for ALE routines</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span>  :: h_pre<span class="comment"> !&lt; layer thicknesses before advection</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span>  :: uhtr<span class="comment">  !&lt; Zonal mass transport</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span>  :: vhtr<span class="comment">  !&lt; Meridional mass transport</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keywordtype">logical</span>,                                            <span class="keywordtype">intent(  out)</span>  :: converged</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="comment">! Local pointers</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),      <span class="keywordtype">pointer</span> :: g  =&gt; null() <span class="comment">! Pointer to a structure containing</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                                                      <span class="comment">! metrics and related information</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">pointer</span> :: gv =&gt; null() <span class="comment">! Pointer to structure containing information</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                                                      <span class="comment">! about the vertical grid</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="comment">! Work arrays for mass transports</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>   :: uhtr_sub</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="comment">! Meridional mass transports</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>   :: vhtr_sub</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <span class="keywordtype">real</span> :: prev_tot_residual, tot_residual  <span class="comment">! Used to keep track of how close to convergence we are</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="comment">! Variables used to keep track of layer thicknesses at various points in the code</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: &amp;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      h_new, &amp;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      h_vol</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="comment">! Fields for eta_diff diagnostic</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G))</span>         :: eta_pre, eta_end</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordtype">integer</span>                                        :: niter, iter</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="keywordtype">real</span>                                           :: inum_iter</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, isd, ied, jsd, jed, nz</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keywordtype">integer</span> :: isv, iev, jsv, jev <span class="comment">! The valid range of the indices.</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordtype">logical</span> :: z_first, x_before_y</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="keywordtype">real</span> :: evap_cfl_limit, minimum_forcing_depth, dt_iter, dt_offline</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordtype">integer</span> :: nstocks</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="keywordtype">real</span> :: stock_values(max_fields_)</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordtype">character*20</span> :: debug_msg</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_offline_adv)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  <span class="comment">! Grid-related pointer assignments</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  g =&gt; cs%G</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  gv =&gt; cs%GV</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  x_before_y = cs%x_before_y</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="comment">! Initialize some shorthand variables from other structures</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  dt_offline = cs%dt_offline</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  evap_cfl_limit = cs%evap_CFL_limit</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  minimum_forcing_depth = cs%minimum_forcing_depth</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  niter = cs%num_off_iter</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  inum_iter = 1./<span class="keywordtype">real</span>(niter)</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  dt_iter = dt_offline*inum_iter</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="comment">! Initialize working arrays</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  h_new(:,:,:) = 0.0</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  h_vol(:,:,:) = 0.0</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  uhtr_sub(:,:,:) = 0.0</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  vhtr_sub(:,:,:) = 0.0</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">! converged should only be true if there are no remaining mass fluxes</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  converged = .false.</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="comment">! Tracers are transported using the stored mass fluxes. Where possible, operators are Strang-split around</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="comment">! the call to</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="comment">! 1)  Using the layer thicknesses and tracer concentrations from the previous timestep,</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="comment">!     half of the accumulated vertical mixing (eatr and ebtr) is applied in the call to tracer_column_fns.</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="comment">!     For tracers whose source/sink terms need dt, this value is set to 1/2 dt_offline</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="comment">! 2)  Half of the accumulated surface freshwater fluxes are applied</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="comment">!! START ITERATION</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  <span class="comment">! 3)  Accumulated mass fluxes are used to do horizontal transport. The number of iterations used in</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="comment">!     advect_tracer is limited to 2 (e.g x-&gt;y-&gt;x-&gt;y). The remaining mass fluxes are stored for later use</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="comment">!     and resulting layer thicknesses fed into the next step</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="comment">! 4)  Tracers and the h-grid are regridded and remapped in a call to ALE. This allows for layers which might</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="comment">!     &#39;vanish&#39; because of horizontal mass transport to be &#39;reinflated&#39;</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="comment">! 5)  Check that transport is done if the remaining mass fluxes equals 0 or if the max number of iterations</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="comment">!     has been reached</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="comment">!! END ITERATION</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="comment">! 6)  Repeat steps 1 and 2</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="comment">! 7)  Force a remapping to the stored layer thicknesses that correspond to the snapshot of the online model</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="comment">! 8)  Reset T/S and h to their stored snapshotted values to prevent model drift</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="comment">! Copy over the horizontal mass fluxes from the total mass fluxes</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsd,jed ; <span class="keywordflow">do</span> i=isdb,iedb</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    uhtr_sub(i,j,k) = uhtr(i,j,k)</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsdb,jedb ; <span class="keywordflow">do</span> i=isd,ied</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    vhtr_sub(i,j,k) = vhtr(i,j,k)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    h_new(i,j,k) = h_pre(i,j,k)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keyword">call </span>hchksum(h_pre,<span class="stringliteral">&quot;h_pre before transport&quot;</span>,g%HI)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]htr_sub before transport&quot;</span>, uhtr_sub, vhtr_sub, g%HI)</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  tot_residual = remaining_transport_sum(cs, uhtr, vhtr)</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="keywordflow">if</span> (cs%print_adv_offline) <span class="keywordflow">then</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,ES24.16)&#39;</span>) <span class="stringliteral">&quot;Main advection starting transport: &quot;</span>, tot_residual</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="comment">! This loop does essentially a flux-limited, nonlinear advection scheme until all mass fluxes</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="comment">! are used. ALE is done after the horizontal advection.</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keywordflow">do</span> iter=1,cs%num_off_iter</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      h_vol(i,j,k) = h_new(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">if</span>(cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keyword">call </span>hchksum(h_vol,<span class="stringliteral">&quot;h_vol before advect&quot;</span>,g%HI)</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]htr_sub before advect&quot;</span>, uhtr_sub, vhtr_sub, g%HI)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      <span class="keyword">write</span>(debug_msg, <span class="stringliteral">&#39;(A,I4.4)&#39;</span>) <span class="stringliteral">&#39;Before advect &#39;</span>, iter</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;      <span class="keyword">call </span>mom_tracer_chkinv(debug_msg, g, h_pre, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keyword">call </span>advect_tracer(h_pre, uhtr_sub, vhtr_sub, cs%OBC, cs%dt_offline, g, gv, &amp;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        cs%tracer_adv_CSp, cs%tracer_Reg, h_vol, max_iter_in=1, &amp;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        uhr_out=uhtr, vhr_out=vhtr, h_out=h_new, x_first_in=x_before_y)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="comment">! Switch the direction every iteration</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    x_before_y = .not. x_before_y</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="comment">! Update the new layer thicknesses after one round of advection has happened</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      h_new(i,j,k) = h_new(i,j,k)/g%areaT(i,j)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">if</span> (modulo(iter,cs%off_ale_mod)==0) <span class="keywordflow">then</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      <span class="comment">! Do ALE remapping/regridding to allow for more advection to occur in the next iteration</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      <span class="keyword">call </span>pass_var(h_new,g%Domain)</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="keyword">call </span>hchksum(h_new,<span class="stringliteral">&quot;h_new before ALE&quot;</span>,g%HI)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="keyword">write</span>(debug_msg, <span class="stringliteral">&#39;(A,I4.4)&#39;</span>) <span class="stringliteral">&#39;Before ALE &#39;</span>, iter</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keyword">call </span>mom_tracer_chkinv(debug_msg, g, h_new, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_ale)</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;      <span class="keyword">call </span>ale_main_offline(g, gv, h_new, cs%tv, cs%tracer_Reg, cs%ALE_CSp, cs%dt_offline)</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_ale)</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keyword">call </span>hchksum(h_new,<span class="stringliteral">&quot;h_new after ALE&quot;</span>,g%HI)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <span class="keyword">write</span>(debug_msg, <span class="stringliteral">&#39;(A,I4.4)&#39;</span>) <span class="stringliteral">&#39;After ALE &#39;</span>, iter</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <span class="keyword">call </span>mom_tracer_chkinv(debug_msg, g, h_new, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;      uhtr_sub(i,j,k) = uhtr(i,j,k)</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      vhtr_sub(i,j,k) = vhtr(i,j,k)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keyword">call </span>pass_var(h_new, g%Domain)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keyword">call </span>pass_vector(uhtr_sub,vhtr_sub,g%Domain)</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="comment">! Check for whether we&#39;ve used up all the advection, or if we need to move on because</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment">! advection has stalled</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    tot_residual = remaining_transport_sum(cs, uhtr, vhtr)</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keywordflow">if</span> (cs%print_adv_offline) <span class="keywordflow">then</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,ES24.16)&#39;</span>) <span class="stringliteral">&quot;Main advection remaining transport: &quot;</span>, tot_residual</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">! If all the mass transports have been used u, then quit</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">if</span> (tot_residual == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      <span class="keywordflow">if</span> (is_root_pe()) <span class="keyword">write</span>(0,*) <span class="stringliteral">&quot;Converged after iteration&quot;</span>, iter</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      converged = .true.</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="comment">! If advection has stalled or the remaining residual is less than a specified amount, quit</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="keywordflow">if</span> ( (tot_residual == prev_tot_residual) .or. (tot_residual&lt;cs%min_residual) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      converged = .false.</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    prev_tot_residual = tot_residual</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <span class="comment">! Make sure that uhtr and vhtr halos are updated</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  h_pre(:,:,:) = h_new(:,:,:)</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  <span class="keyword">call </span>pass_vector(uhtr,vhtr,g%Domain)</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keyword">call </span>hchksum(h_pre,<span class="stringliteral">&quot;h after offline_advection_ale&quot;</span>,g%HI)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]htr after offline_advection_ale&quot;</span>, uhtr, vhtr, g%HI)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;After offline_advection_ale&quot;</span>, g, h_pre, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keyword">call </span>cpu_clock_end(cs%id_clock_offline_adv)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_ae85546d26ceb447742abe3c528cad2d7_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a887d59c64eb269aad257eacc8cf30444"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a887d59c64eb269aad257eacc8cf30444">&#9670;&nbsp;</a></span>offline_advection_layer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_advection_layer </td>
          <td>(</td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time_start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>time_interval</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>eatr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>ebtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szjb_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>When in layer mode, 3D horizontal advection using stored mass fluxes must be used. Horizontal advection is done via tracer_advect, whereas the vertical component is actually handled by vertdiff in tracer_column_fns. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_start</td><td>starting time of a segment, as a time type</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_interval</td><td>Offline transport time interval</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure from initialize_MOM</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_pre</td><td>layer thicknesses before advection</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eatr</td><td>Entrainment from layer above</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ebtr</td><td>Entrainment from layer below</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>Zonal mass transport</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>Meridional mass transport </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00800">800</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM_8F90_source.html#l01294">mom::step_offline()</a>.</p>
<div class="fragment"><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;  <span class="keywordtype">type</span>(forcing),              <span class="keywordtype">intent(inout)</span>    :: fluxes<span class="comment">        !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;  <span class="keywordtype">type</span>(time_type),            <span class="keywordtype">intent(in)</span>       :: time_start<span class="comment">    !&lt; starting time of a segment, as a time type</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  <span class="keywordtype">real</span>,                       <span class="keywordtype">intent(in)</span>       :: time_interval<span class="comment"> !&lt; Offline transport time interval</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment">                    !&lt; control structure from initialize_MOM</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span> :: h_pre<span class="comment"> !&lt; layer thicknesses before advection</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span> :: eatr<span class="comment"> !&lt; Entrainment from layer above</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span> :: ebtr<span class="comment"> !&lt; Entrainment from layer below</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: uhtr<span class="comment">  !&lt; Zonal mass transport</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: vhtr<span class="comment">  !&lt; Meridional mass transport</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="comment">! Local pointers</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),      <span class="keywordtype">pointer</span> :: g  =&gt; null() <span class="comment">! Pointer to a structure containing</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                                                      <span class="comment">! metrics and related information</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">pointer</span> :: gv =&gt; null() <span class="comment">! Pointer to structure containing information</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                                                      <span class="comment">! about the vertical grid</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  <span class="comment">! Remaining zonal mass transports</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>   :: uhtr_sub</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;  <span class="comment">! Remaining meridional mass transports</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>   :: vhtr_sub</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;  <span class="keywordtype">real</span> :: sum_abs_fluxes, sum_u, sum_v  <span class="comment">! Used to keep track of how close to convergence we are</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  <span class="keywordtype">real</span> :: dt_offline</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="comment">! Vertical diffusion related variables</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: &amp;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;      eatr_sub, &amp;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;      ebtr_sub</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  <span class="comment">! Variables used to keep track of layer thicknesses at various points in the code</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: &amp;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;      h_new, &amp;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      h_vol</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="comment">! Work arrays for temperature and salinity</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: &amp;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;      temp_old, salt_old, &amp;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;      temp_mean, salt_mean, &amp;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;      zero_3dh     <span class="comment">!</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keywordtype">integer</span>                                        :: niter, iter</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  <span class="keywordtype">real</span>                                           :: inum_iter, dt_iter</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keywordtype">logical</span>                                        :: converged</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, isd, ied, jsd, jed, nz</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  <span class="keywordtype">integer</span> :: isv, iev, jsv, jev <span class="comment">! The valid range of the indices.</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  <span class="keywordtype">logical</span> :: z_first, x_before_y</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keywordflow">do</span> iter=1,cs%num_off_iter</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      eatr_sub(i,j,k) = eatr(i,j,k)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      ebtr_sub(i,j,k) = ebtr(i,j,k)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-2,ie+1</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      uhtr_sub(i,j,k) = uhtr(i,j,k)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-2,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      vhtr_sub(i,j,k) = vhtr(i,j,k)</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">! Calculate 3d mass transports to be used in this iteration</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keyword">call </span>limit_mass_flux_3d(g, gv, uhtr_sub, vhtr_sub, eatr_sub, ebtr_sub, h_pre)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">if</span> (z_first) <span class="keywordflow">then</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;      <span class="comment">! First do vertical advection</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="keyword">call </span>update_h_vertical_flux(g, gv, eatr_sub, ebtr_sub, h_pre, h_new)</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;      <span class="keyword">call </span>call_tracer_column_fns(h_pre, h_new, eatr_sub, ebtr_sub, &amp;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;          fluxes, cs%mld, dt_iter, g, gv, cs%tv, cs%optics, cs%tracer_flow_CSp, cs%debug)</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;      <span class="comment">! We are now done with the vertical mass transports, so now h_new is h_sub</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;      <span class="keyword">call </span>pass_var(h_pre,g%Domain)</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;      <span class="comment">! Second zonal and meridional advection</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;      <span class="keyword">call </span>update_h_horizontal_flux(g, gv, uhtr_sub, vhtr_sub, h_pre, h_new)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> i = is-1, ie+1 ; <span class="keywordflow">do</span> j=js-1, je+1</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        h_vol(i,j,k) = h_pre(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;<span class="keyword">      end</span>do; enddo; enddo</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;      <span class="keyword">call </span>advect_tracer(h_pre, uhtr_sub, vhtr_sub, cs%OBC, dt_iter, g, gv, &amp;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;          cs%tracer_adv_CSp, cs%tracer_Reg, h_vol, max_iter_in=30, x_first_in=x_before_y)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;      <span class="comment">! Done with horizontal so now h_pre should be h_new</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;          h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="keywordflow">if</span> (.not. z_first) <span class="keywordflow">then</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      <span class="comment">! First zonal and meridional advection</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;      <span class="keyword">call </span>update_h_horizontal_flux(g, gv, uhtr_sub, vhtr_sub, h_pre, h_new)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> i = is-1, ie+1 ; <span class="keywordflow">do</span> j=js-1, je+1</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        h_vol(i,j,k) = h_pre(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="keyword">      end</span>do; enddo; enddo</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;      <span class="keyword">call </span>advect_tracer(h_pre, uhtr_sub, vhtr_sub, cs%OBC, dt_iter, g, gv, &amp;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;          cs%tracer_adv_CSp, cs%tracer_Reg, h_vol, max_iter_in=30, x_first_in=x_before_y)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      <span class="comment">! Done with horizontal so now h_pre should be h_new</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;          h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;      <span class="comment">! Second vertical advection</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;      <span class="keyword">call </span>update_h_vertical_flux(g, gv, eatr_sub, ebtr_sub, h_pre, h_new)</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;      <span class="keyword">call </span>call_tracer_column_fns(h_pre, h_new, eatr_sub, ebtr_sub, &amp;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;          fluxes, cs%mld, dt_iter, g, gv, cs%tv, cs%optics, cs%tracer_flow_CSp, cs%debug)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;      <span class="comment">! We are now done with the vertical mass transports, so now h_new is h_sub</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;      <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">! Update remaining transports</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;      eatr(i,j,k) = eatr(i,j,k) - eatr_sub(i,j,k)</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;      ebtr(i,j,k) = ebtr(i,j,k) - ebtr_sub(i,j,k)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-2,ie+1</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;      uhtr(i,j,k) = uhtr(i,j,k) - uhtr_sub(i,j,k)</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-2,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      vhtr(i,j,k) = vhtr(i,j,k) - vhtr_sub(i,j,k)</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="keyword">    end</span>do; enddo ; enddo</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="keyword">call </span>pass_var(eatr,g%Domain)</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="keyword">call </span>pass_var(ebtr,g%Domain)</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="keyword">call </span>pass_var(h_pre,g%Domain)</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="keyword">call </span>pass_vector(uhtr,vhtr,g%Domain)</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;  <span class="comment">!</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">! Calculate how close we are to converging by summing the remaining fluxes at each point</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    sum_abs_fluxes = 0.0</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    sum_u = 0.0</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    sum_v = 0.0</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> j=js,je; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;      sum_u = sum_u + abs(uhtr(i-1,j,k))+abs(uhtr(i,j,k))</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;      sum_v = sum_v + abs(vhtr(i,j-1,k))+abs(vhtr(i,j,k))</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;      sum_abs_fluxes = sum_abs_fluxes + abs(eatr(i,j,k)) + abs(ebtr(i,j,k)) + abs(uhtr(i-1,j,k)) + &amp;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;          abs(uhtr(i,j,k)) + abs(vhtr(i,j-1,k)) + abs(vhtr(i,j,k))</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="keyword">    end</span>do; enddo; enddo</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="keyword">call </span>sum_across_pes(sum_abs_fluxes)</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    print *, <span class="stringliteral">&quot;Remaining u-flux, v-flux:&quot;</span>, sum_u, sum_v</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordflow">if</span> (sum_abs_fluxes==0) <span class="keywordflow">then</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;      print *, <span class="stringliteral">&#39;Converged after iteration&#39;</span>, iter</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">! Switch order of Strang split every iteration</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    z_first = .not. z_first</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    x_before_y = .not. x_before_y</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_a887d59c64eb269aad257eacc8cf30444_icgraph.svg" width="583" height="104"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aaef35c02f93931567c41ae8bc0544bdd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aaef35c02f93931567c41ae8bc0544bdd">&#9670;&nbsp;</a></span>offline_diabatic_ale()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_diabatic_ale </td>
          <td>(</td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time_start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>eatr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>ebtr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The vertical/diabatic driver for offline tracers. First the eatr/ebtr associated with the interpolated vertical diffusivities are calculated and then any tracer column functions are done which can include vertical diffuvities and source/sink terms. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_start</td><td>starting time of a segment, as a time type</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time_end</td><td>time interval</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure from initialize_MOM</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">eatr</td><td>Entrainment from layer above</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ebtr</td><td>Entrainment from layer below </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00617">617</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="keywordtype">type</span>(forcing),    <span class="keywordtype">intent(inout)</span>      :: fluxes<span class="comment">        !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <span class="keywordtype">type</span>(time_type),  <span class="keywordtype">intent(in)</span>         :: time_start<span class="comment">    !&lt; starting time of a segment, as a time type</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  <span class="keywordtype">type</span>(time_type),  <span class="keywordtype">intent(in)</span>         :: time_end<span class="comment">      !&lt; time interval</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment">            !&lt; control structure from initialize_MOM</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: h_pre</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: eatr<span class="comment"> !&lt; Entrainment from layer above</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: ebtr<span class="comment"> !&lt; Entrainment from layer below</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G))</span>    :: sw, sw_vis, sw_nir<span class="comment"> !&lt; Save old value of shortwave radiation</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  <span class="keywordtype">real</span> :: hval</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  <span class="keywordtype">integer</span> :: i,j,k</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, nz</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="keywordtype">integer</span> :: k_nonzero</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keywordtype">real</span> :: stock_values(max_fields_)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="keywordtype">real</span> :: kd_bot</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  <span class="keywordtype">integer</span> :: nstocks</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  nz = cs%GV%ke</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  is = cs%G%isc ; ie = cs%G%iec ; js = cs%G%jsc ; je = cs%G%jec</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_offline_diabatic)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  <span class="keywordflow">if</span> (is_root_pe()) <span class="keyword">write</span> (0,*) <span class="stringliteral">&quot;Applying tracer source, sinks, and vertical mixing&quot;</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="keyword">call </span>hchksum(h_pre,<span class="stringliteral">&quot;h_pre before offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keyword">call </span>hchksum(eatr,<span class="stringliteral">&quot;eatr before offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keyword">call </span>hchksum(ebtr,<span class="stringliteral">&quot;ebtr before offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;Before offline_diabatic_ale&quot;</span>, cs%G, h_pre, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  eatr(:,:,:) = 0.</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  ebtr(:,:,:) = 0.</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="comment">! Calculate eatr and ebtr if vertical diffusivity is read</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <span class="comment">! Because the saved remapped diagnostics from the online run assume a zero minimum thickness</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  <span class="comment">! but ALE may have a minimum thickness. Flood the diffusivities for all layers with the value</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="comment">! of Kd closest to the bottom which is non-zero</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    k_nonzero = nz+1</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="comment">! Find the nonzero bottom Kd</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    <span class="keywordflow">do</span> k=nz+1,1,-1</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      <span class="keywordflow">if</span> (cs%Kd(i,j,k)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        kd_bot = cs%Kd(i,j,k)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        k_nonzero = k</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="keywordflow">exit</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="comment">! Flood the bottom interfaces</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="keywordflow">do</span> k=k_nonzero,nz+1</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      cs%Kd(i,j,k) = kd_bot</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    eatr(i,j,1) = 0.</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    hval=1.0/(cs%GV%H_subroundoff + 0.5*(h_pre(i,j,k-1) + h_pre(i,j,k)))</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    eatr(i,j,k) = (cs%GV%m_to_H**2) * cs%dt_offline_vertical * hval * cs%Kd(i,j,k)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    ebtr(i,j,k-1) = eatr(i,j,k)</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    ebtr(i,j,nz) = 0.</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="comment">! Add diurnal cycle for shortwave radiation (only used if run in ocean-only mode)</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordflow">if</span> (cs%diurnal_SW .and. cs%read_sw) <span class="keywordflow">then</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    sw(:,:) = fluxes%sw</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    sw_vis(:,:) = fluxes%sw_vis_dir</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    sw_nir(:,:) = fluxes%sw_nir_dir</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keyword">call </span>offline_add_diurnal_sw(fluxes, cs%G, time_start, time_end)</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%optics)) &amp;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keyword">call </span>set_opacity(cs%optics, fluxes, cs%G, cs%GV, cs%opacity_CSp)</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="comment">! Note that tracerBoundaryFluxesInOut within this subroutine should NOT be called</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="comment">! as the freshwater fluxes have already been accounted for</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keyword">call </span>call_tracer_column_fns(h_pre, h_pre, eatr, ebtr, fluxes, cs%MLD, cs%dt_offline_vertical, cs%G, cs%GV, &amp;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                              cs%tv, cs%optics, cs%tracer_flow_CSp, cs%debug)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="keywordflow">if</span> (cs%diurnal_SW .and. cs%read_sw) <span class="keywordflow">then</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    fluxes%sw(:,:) = sw</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    fluxes%sw_vis_dir(:,:) = sw_vis</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    fluxes%sw_nir_dir(:,:) = sw_nir</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keyword">call </span>hchksum(h_pre,<span class="stringliteral">&quot;h_pre after offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keyword">call </span>hchksum(eatr,<span class="stringliteral">&quot;eatr after offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="keyword">call </span>hchksum(ebtr,<span class="stringliteral">&quot;ebtr after offline_diabatic_ale&quot;</span>,cs%G%HI)</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;After offline_diabatic_ale&quot;</span>, cs%G, h_pre, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="keyword">call </span>cpu_clock_end(cs%id_clock_offline_diabatic)</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a04d329761570d6d9fbc38589bea929cc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a04d329761570d6d9fbc38589bea929cc">&#9670;&nbsp;</a></span>offline_fw_fluxes_into_ocean()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_fw_fluxes_into_ocean </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g)), intent(in), optional&#160;</td>
          <td class="paramname"><em>in_flux_optional</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply positive freshwater fluxes (into the ocean) and update netMassOut with only the negative (out of the ocean) fluxes. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Offline control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>Surface fluxes container</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness in H units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">in_flux_optional</td><td>The total time-integrated amount of tracer that leaves with freshwater </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00718">718</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs),                 <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Offline control structure</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Grid structure</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  <span class="keywordtype">type</span>(forcing),                              <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; Surface fluxes container</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(inout)</span> :: h<span class="comment">  !&lt; Layer thickness in H units</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">  !&gt; The total time-integrated amount of tracer that leaves with freshwater</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: in_flux_optional</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keywordtype">integer</span> :: i, j, m</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: negative_fw<span class="comment"> !&lt; store all negative fluxes</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordtype">logical</span> :: update_h<span class="comment"> !&lt; Flag for whether h should be updated</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="keywordflow">if</span> ( <span class="keyword">present</span>(in_flux_optional) ) &amp;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Positive freshwater fluxes with non-zero tracer concentration not supported yet&quot;</span>)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  <span class="comment">! Set all fluxes to 0</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  negative_fw(:,:) = 0.</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="comment">! Sort fluxes into positive and negative</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordflow">if</span> (fluxes%netMassOut(i,j)&lt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      negative_fw(i,j) = fluxes%netMassOut(i,j)</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;      fluxes%netMassOut(i,j) = 0.</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="keyword">call </span>hchksum(h,<span class="stringliteral">&quot;h before fluxes into ocean&quot;</span>,g%HI)</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;Before fluxes into ocean&quot;</span>, g, h, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  <span class="keywordflow">do</span> m = 1,cs%tracer_reg%ntr</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    <span class="comment">! Layer thicknesses should only be updated after the last tracer is finished</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    update_h = ( m == cs%tracer_reg%ntr )</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keyword">call </span>applytracerboundaryfluxesinout(g, gv, cs%tracer_reg%tr(m)%t, cs%dt_offline, fluxes, h, &amp;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                                        cs%evap_CFL_limit, cs%minimum_forcing_depth, update_h_opt = update_h)</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="keyword">call </span>hchksum(h,<span class="stringliteral">&quot;h after fluxes into ocean&quot;</span>,g%HI)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;After fluxes into ocean&quot;</span>, g, h, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  <span class="comment">! Now that fluxes into the ocean are done, save the negative fluxes for later</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  fluxes%netMassOut(:,:) = negative_fw(:,:)</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad96c09ff7c8f34d9602fd111ec492cfe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad96c09ff7c8f34d9602fd111ec492cfe">&#9670;&nbsp;</a></span>offline_fw_fluxes_out_ocean()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_fw_fluxes_out_ocean </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g)), intent(in), optional&#160;</td>
          <td class="paramname"><em>out_flux_optional</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Apply negative freshwater fluxes (out of the ocean) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Offline control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>Surface fluxes container</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Layer thickness in H units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">out_flux_optional</td><td>The total time-integrated amount of tracer that leaves with freshwater </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00766">766</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs),                 <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Offline control structure</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Grid structure</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  <span class="keywordtype">type</span>(forcing),                              <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; Surface fluxes container</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,   <span class="keywordtype">intent(inout)</span> :: h<span class="comment">  !&lt; Layer thickness in H units</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">  !&gt; The total time-integrated amount of tracer that leaves with freshwater</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: out_flux_optional</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="keywordtype">integer</span> :: m</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  <span class="keywordtype">logical</span> :: update_h<span class="comment"> !&lt; Flag for whether h should be updated</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordflow">if</span> ( <span class="keyword">present</span>(out_flux_optional) ) &amp;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;Negative freshwater fluxes with non-zero tracer concentration not supported yet&quot;</span>)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keyword">call </span>hchksum(h,<span class="stringliteral">&quot;h before fluxes out of ocean&quot;</span>,g%HI)</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;Before fluxes out of ocean&quot;</span>, g, h, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  <span class="keywordflow">do</span> m = 1, cs%tracer_reg%ntr</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="comment">! Layer thicknesses should only be updated after the last tracer is finished</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    update_h = ( m == cs%tracer_reg%ntr )</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keyword">call </span>applytracerboundaryfluxesinout(g, gv, cs%tracer_reg%tr(m)%t, cs%dt_offline, fluxes, h, &amp;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                                        cs%evap_CFL_limit, cs%minimum_forcing_depth, update_h_opt = update_h)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="keyword">call </span>hchksum(h,<span class="stringliteral">&quot;h after fluxes out of ocean&quot;</span>,g%HI)</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;Before fluxes out of ocean&quot;</span>, g, h, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a312c47e83e64a6bdf064526f77a8a8ec"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a312c47e83e64a6bdf064526f77a8a8ec">&#9670;&nbsp;</a></span>offline_redistribute_residual()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_redistribute_residual </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szjb_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>converged</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In the case where the main advection routine did not converge, something needs to be done with the remaining transport. Two different ways are offered, 'barotropic' means that the residual is distributed equally throughout the water column. 'upwards' attempts to redistribute the transport in the layers above and will eventually work down the entire water column. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure from initialize_MOM</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_pre</td><td>layer thicknesses before advection</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>Zonal mass transport</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>Meridional mass transport </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00388">388</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__tracer__advect_8F90_source.html#l00049">mom_tracer_advect::advect_tracer()</a>, <a class="el" href="MOM__offline__aux_8F90_source.html#l00359">mom_offline_aux::distribute_residual_uh_upwards()</a>, <a class="el" href="MOM__offline__aux_8F90_source.html#l00452">mom_offline_aux::distribute_residual_vh_upwards()</a>, <a class="el" href="MOM__tracer__registry_8F90_source.html#l00270">mom_tracer_registry::mom_tracer_chkinv()</a>, <a class="el" href="MOM__tracer__registry_8F90_source.html#l00253">mom_tracer_registry::mom_tracer_chksum()</a>, and <a class="el" href="MOM__offline__main_8F90_source.html#l00582">remaining_transport_sum()</a>.</p>
<div class="fragment"><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment">           !&lt; control structure from initialize_MOM</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span>  :: h_pre<span class="comment"> !&lt; layer thicknesses before advection</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span>  :: uhtr<span class="comment">  !&lt; Zonal mass transport</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span>  :: vhtr<span class="comment">  !&lt; Meridional mass transport</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="keywordtype">logical</span>,                                            <span class="keywordtype">intent(in   )</span>  :: converged</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),      <span class="keywordtype">pointer</span> :: g  =&gt; null() <span class="comment">! Pointer to a structure containing</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                                                      <span class="comment">! metrics and related information</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">pointer</span> :: gv =&gt; null() <span class="comment">! Pointer to structure containing information</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                                                      <span class="comment">! about the vertical grid</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="keywordtype">logical</span> :: x_before_y</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="comment">! Variables used to keep track of layer thicknesses at various points in the code</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: &amp;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;      h_new, &amp;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;      h_vol</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="comment">! Used to calculate the eta diagnostics</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G))</span> :: eta_work</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: uhr<span class="comment">  !&lt; Zonal mass transport</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span> :: vhr<span class="comment">  !&lt; Meridional mass transport</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, isd, ied, jsd, jed, nz, iter</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordtype">real</span> :: prev_tot_residual, tot_residual, stock_values(max_fields_)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">integer</span> :: nstocks</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="comment">! Assign grid pointers</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  g  =&gt; cs%G</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  gv =&gt; cs%GV</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  x_before_y = cs%x_before_y</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordflow">if</span> (cs%id_eta_pre_distribute&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    eta_work(:,:) = 0.0</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;      <span class="keywordflow">if</span> (h_pre(i,j,k)&gt;gv%Angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        eta_work(i,j) = eta_work(i,j) + h_pre(i,j,k)</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keyword">call </span>post_data(cs%id_eta_pre_distribute,eta_work,cs%diag)</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="comment">! These are used to find out how much will be redistributed in this routine</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">if</span> (cs%id_h_redist&gt;0) <span class="keyword">call </span>post_data(cs%id_h_redist, h_pre, cs%diag)</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordflow">if</span> (cs%id_uhr_redist&gt;0) <span class="keyword">call </span>post_data(cs%id_uhr_redist, uhtr, cs%diag)</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordflow">if</span> (cs%id_vhr_redist&gt;0) <span class="keyword">call </span>post_data(cs%id_vhr_redist, vhtr, cs%diag)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keywordflow">if</span> (converged) <span class="keywordflow">return</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;Before redistribute &quot;</span>, g, h_pre, cs%tracer_reg%Tr, cs%tracer_reg%ntr)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_redistribute)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordflow">if</span> (cs%redistribute_upwards .or. cs%redistribute_barotropic) <span class="keywordflow">then</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keywordflow">do</span> iter = 1, cs%num_off_iter</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      <span class="comment">! Perform upwards redistribution</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordflow">if</span> (cs%redistribute_upwards) <span class="keywordflow">then</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="comment">! Calculate the layer volumes at beginning of redistribute</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;          h_vol(i,j,k) = h_pre(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="keyword">call </span>pass_var(h_vol,g%Domain)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        <span class="keyword">call </span>pass_vector(uhtr,vhtr,g%Domain)</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="comment">! Store volumes for advect_tracer</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        h_pre(:,:,:) = h_vol(:,:,:)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;          <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;Before upwards redistribute &quot;</span>, cs%tracer_Reg%Tr, cs%tracer_Reg%ntr, g)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;          <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]tr before upwards redistribute&quot;</span>, uhtr, vhtr, g%HI)</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="keywordflow">if</span> (x_before_y) <span class="keywordflow">then</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;          <span class="keyword">call </span>distribute_residual_uh_upwards(g, gv, h_vol, uhtr)</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;          <span class="keyword">call </span>distribute_residual_vh_upwards(g, gv, h_vol, vhtr)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;          <span class="keyword">call </span>distribute_residual_vh_upwards(g, gv, h_vol, vhtr)</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;          <span class="keyword">call </span>distribute_residual_uh_upwards(g, gv, h_vol, uhtr)</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keyword">call </span>advect_tracer(h_pre, uhtr, vhtr, cs%OBC, cs%dt_offline, g, gv, &amp;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            cs%tracer_adv_CSp, cs%tracer_Reg, h_prev_opt = h_pre, max_iter_in=1, &amp;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            h_out=h_new, uhr_out=uhr, vhr_out=vhr, x_first_in=x_before_y)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;          <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;After upwards redistribute &quot;</span>, cs%tracer_Reg%Tr, cs%tracer_Reg%ntr, g)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        <span class="comment">! Convert h_new back to layer thickness for ALE remapping</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;          uhtr(i,j,k) = uhr(i,j,k)</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;          vhtr(i,j,k) = vhr(i,j,k)</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;          h_vol(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;          h_new(i,j,k) = h_new(i,j,k)/g%areaT(i,j)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;          h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! redistribute upwards</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      <span class="comment">! Perform barotropic redistribution</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      <span class="keywordflow">if</span> (cs%redistribute_barotropic) <span class="keywordflow">then</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;        <span class="comment">! Calculate the layer volumes at beginning of redistribute</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;          h_vol(i,j,k) = h_pre(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        <span class="keyword">call </span>pass_var(h_vol,g%Domain)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keyword">call </span>pass_vector(uhtr,vhtr,g%Domain)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <span class="comment">! Copy h_vol to h_pre for advect_tracer routine</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        h_pre(:,:,:) = h_vol(:,:,:)</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;          <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;Before barotropic redistribute &quot;</span>, cs%tracer_Reg%Tr, cs%tracer_Reg%ntr, g)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;          <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]tr before upwards redistribute&quot;</span>, uhtr, vhtr, g%HI)</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span> (x_before_y) <span class="keywordflow">then</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;          <span class="keyword">call </span>distribute_residual_uh_barotropic(g, gv, h_vol, uhtr)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;          <span class="keyword">call </span>distribute_residual_vh_barotropic(g, gv, h_vol, vhtr)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;          <span class="keyword">call </span>distribute_residual_vh_barotropic(g, gv, h_vol, vhtr)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;          <span class="keyword">call </span>distribute_residual_uh_barotropic(g, gv, h_vol, uhtr)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keyword">call </span>advect_tracer(h_pre, uhtr, vhtr, cs%OBC, cs%dt_offline, g, gv, &amp;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;            cs%tracer_adv_CSp, cs%tracer_Reg, h_prev_opt = h_pre, max_iter_in=1, &amp;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            h_out=h_new, uhr_out=uhr, vhr_out=vhr, x_first_in=x_before_y)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;          <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;After barotropic redistribute &quot;</span>, cs%tracer_Reg%Tr, cs%tracer_Reg%ntr, g)</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="comment">! Convert h_new back to layer thickness for ALE remapping</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;          uhtr(i,j,k) = uhr(i,j,k)</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          vhtr(i,j,k) = vhr(i,j,k)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          h_vol(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;          h_new(i,j,k) = h_new(i,j,k)/g%areaT(i,j)</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;          h_pre(i,j,k) = h_new(i,j,k)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! redistribute barotropic</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;      <span class="comment">! Check to see if all transport has been exhausted</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      tot_residual = remaining_transport_sum(cs, uhtr, vhtr)</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      <span class="keywordflow">if</span> (cs%print_adv_offline) <span class="keywordflow">then</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,ES24.16)&#39;</span>) <span class="stringliteral">&quot;Residual advection remaining transport: &quot;</span>, tot_residual</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="comment">! If the remaining residual is 0, then this return is done</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      <span class="keywordflow">if</span> (tot_residual==0.0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keywordflow">exit</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      <span class="keywordflow">if</span> ( (tot_residual == prev_tot_residual) .or. (tot_residual&lt;cs%min_residual) ) <span class="keywordflow">exit</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      prev_tot_residual = tot_residual</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! Redistribution iteration</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! If one of the redistribution routines is requested</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordflow">if</span> (cs%id_eta_post_distribute&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    eta_work(:,:) = 0.0</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      <span class="keywordflow">if</span> (h_pre(i,j,k)&gt;gv%Angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        eta_work(i,j) = eta_work(i,j) + h_pre(i,j,k)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="keyword">call </span>post_data(cs%id_eta_post_distribute,eta_work,cs%diag)</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <span class="keywordflow">if</span> (cs%id_uhr&gt;0) <span class="keyword">call </span>post_data(cs%id_uhr,uhtr,cs%diag)</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="keywordflow">if</span> (cs%id_vhr&gt;0) <span class="keyword">call </span>post_data(cs%id_vhr,vhtr,cs%diag)</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keyword">call </span>hchksum(h_pre,<span class="stringliteral">&quot;h_pre after redistribute&quot;</span>,g%HI)</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;uhtr after redistribute&quot;</span>, uhtr, vhtr, g%HI)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keyword">call </span>mom_tracer_chkinv(<span class="stringliteral">&quot;after redistribute &quot;</span>, g, h_new, cs%tracer_Reg%Tr, cs%tracer_Reg%ntr)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keyword">call </span>cpu_clock_end(cs%id_clock_redistribute)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_a312c47e83e64a6bdf064526f77a8a8ec_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a853e9fbade83984621d26f51c1a2d651"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a853e9fbade83984621d26f51c1a2d651">&#9670;&nbsp;</a></span>offline_transport_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_transport_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deallocates (if necessary) arrays within the offline control structure. </p>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01430">1430</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(inout)</span>  :: cs</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;  <span class="comment">! Explicitly allocate all allocatable arrays</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  <span class="keyword">deallocate</span>(cs%uhtr)</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  <span class="keyword">deallocate</span>(cs%vhtr)</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  <span class="keyword">deallocate</span>(cs%eatr)</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  <span class="keyword">deallocate</span>(cs%ebtr)</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  <span class="keyword">deallocate</span>(cs%h_end)</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;  <span class="keyword">deallocate</span>(cs%netMassOut)</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;  <span class="keyword">deallocate</span>(cs%netMassIn)</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  <span class="keyword">deallocate</span>(cs%Kd)</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;  <span class="keywordflow">if</span> (cs%read_mld) <span class="keyword">deallocate</span>(cs%mld)</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  <span class="keywordflow">if</span> (cs%read_all_ts_uvh) <span class="keywordflow">then</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="keyword">deallocate</span>(cs%uhtr_all)</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="keyword">deallocate</span>(cs%vhtr_all)</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="keyword">deallocate</span>(cs%hend_all)</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    <span class="keyword">deallocate</span>(cs%temp_all)</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    <span class="keyword">deallocate</span>(cs%salt_all)</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a3948771c2f4a319e66db28fe866e1549"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3948771c2f4a319e66db28fe866e1549">&#9670;&nbsp;</a></span>offline_transport_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::offline_transport_init </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diabatic_cs), intent(in), pointer&#160;</td>
          <td class="paramname"><em>diabatic_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in), pointer&#160;</td>
          <td class="paramname"><em>GV</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes the control structure for offline transport and reads in some of the. </p>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01218">1218</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__offline__main_8F90_source.html#l01388">read_all_input()</a>.</p>
<div class="fragment"><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  <span class="keywordtype">type</span>(param_file_type),               <span class="keywordtype">intent(in)</span>     :: param_file</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(inout)</span>  :: cs</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;  <span class="keywordtype">type</span>(diabatic_cs),          <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(in)</span>     :: diabatic_csp</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),      <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(in)</span>     :: g</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),    <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(in)</span>     :: gv</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;offline_transport&quot;</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="keywordtype">character(len=20)</span>  :: redistribute_method</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isd, ied, jsd, jed, nz</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  is   = g%isc   ; ie   = g%iec  ; js   = g%jsc  ; je   = g%jec ; nz = gv%ke</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  isd  = g%isd   ; ied  = g%ied  ; jsd  = g%jsd  ; jed  = g%jed</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  isdb = g%IsdB  ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;offline_transport_init, MOM_offline_control.F90&quot;</span>)</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;offline_transport_init called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;      <span class="stringliteral">&quot;control structure.&quot;</span>)</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl,version, <span class="stringliteral">&quot;This module allows for tracers to be run offline&quot;</span>)</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="comment">! Parse MOM_input for offline control</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFFLINEDIR&quot;</span>, cs%offlinedir, &amp;</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="stringliteral">&quot;Input directory where the offline fields can be found&quot;</span>,  fail_if_missing = .true.)</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFF_SUM_FILE&quot;</span>, cs%sum_file, &amp;</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="stringliteral">&quot;Filename where the accumulated fields can be found&quot;</span>,     fail_if_missing = .true.)</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFF_SNAP_FILE&quot;</span>, cs%snap_file, &amp;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="stringliteral">&quot;Filename where snapshot fields can be found&quot;</span>,            fail_if_missing = .true.)</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFF_MEAN_FILE&quot;</span>, cs%mean_file, &amp;</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <span class="stringliteral">&quot;Filename where averaged fields can be found&quot;</span>,            fail_if_missing = .true.)</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFF_SURF_FILE&quot;</span>, cs%surf_file, &amp;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="stringliteral">&quot;Filename where averaged fields can be found&quot;</span>,            fail_if_missing = .true.)</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NUMTIME&quot;</span>, cs%numtime, &amp;</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="stringliteral">&quot;Number of timelevels in offline input files&quot;</span>,            fail_if_missing = .true.)</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NK_INPUT&quot;</span>, cs%nk_input, &amp;</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="stringliteral">&quot;Number of vertical levels in offline input files&quot;</span>, default = nz)</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT_OFFLINE&quot;</span>, cs%dt_offline, &amp;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <span class="stringliteral">&quot;Length of time between reading in of input fields&quot;</span>,      fail_if_missing = .true.)</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT_OFFLINE_VERTICAL&quot;</span>, cs%dt_offline_vertical, &amp;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    <span class="stringliteral">&quot;Length of the offline timestep for tracer column sources/sinks\n&quot;</span> //&amp;</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    <span class="stringliteral">&quot;This should be set to the length of the coupling timestep for \n&quot;</span> //&amp;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="stringliteral">&quot;tracers which need shortwave fluxes&quot;</span>,                    fail_if_missing = .true.)</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;START_INDEX&quot;</span>, cs%start_index, &amp;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <span class="stringliteral">&quot;Which time index to start from&quot;</span>, default=1)</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;FIELDS_ARE_OFFSET&quot;</span>, cs%fields_are_offset, &amp;</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    <span class="stringliteral">&quot;True if the time-averaged fields and snapshot fields\n&quot;</span>//&amp;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <span class="stringliteral">&quot;are offset by one time level&quot;</span>, default=.false.)</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;REDISTRIBUTE_METHOD&quot;</span>, redistribute_method, &amp;</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="stringliteral">&quot;Redistributes any remaining horizontal fluxes throughout\n&quot;</span>    //&amp;</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="stringliteral">&quot;the rest of water column. Options are &#39;barotropic&#39; which\n&quot;</span>    //&amp;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    <span class="stringliteral">&quot;evenly distributes flux throughout the entire water column,\n&quot;</span> //&amp;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    <span class="stringliteral">&quot;&#39;upwards&#39; which adds the maximum of the remaining flux in\n&quot;</span>   //&amp;</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    <span class="stringliteral">&quot;each layer above, both which first applies upwards and then\n&quot;</span> //&amp;</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="stringliteral">&quot;barotropic, and &#39;none&#39; which does no redistribution&quot;</span>, &amp;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    default=<span class="stringliteral">&#39;barotropic&#39;</span>)</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NUM_OFF_ITER&quot;</span>, cs%num_off_iter, &amp;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="stringliteral">&quot;Number of iterations to subdivide the offline tracer advection and diffusion&quot;</span>, &amp;</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    default = 60)</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFF_ALE_MOD&quot;</span>, cs%off_ale_mod, &amp;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="stringliteral">&quot;Sets how many horizontal advection steps are taken before an ALE\n&quot;</span> //&amp;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="stringliteral">&quot;remapping step is done. 1 would be x-&gt;y-&gt;ALE, 2 would be&quot;</span>           //&amp;</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="stringliteral">&quot;x-&gt;y-&gt;x-&gt;y-&gt;ALE&quot;</span>, default = 1)</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;PRINT_ADV_OFFLINE&quot;</span>, cs%print_adv_offline, &amp;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="stringliteral">&quot;Print diagnostic output every advection subiteration&quot;</span>,default=.false.)</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SKIP_DIFFUSION_OFFLINE&quot;</span>, cs%skip_diffusion, &amp;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="stringliteral">&quot;Do not do horizontal diffusion&quot;</span>,default=.false.)</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_SW&quot;</span>, cs%read_sw, &amp;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="stringliteral">&quot;Read in shortwave radiation field instead of using values from the coupler&quot;</span>//&amp;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="stringliteral">&quot;when in offline tracer mode&quot;</span>,default=.false.)</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_MLD&quot;</span>, cs%read_mld, &amp;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <span class="stringliteral">&quot;Read in mixed layer depths for tracers which exchange with the atmosphere&quot;</span>//&amp;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <span class="stringliteral">&quot;when in offline tracer mode&quot;</span>,default=.false.)</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MLD_VAR_NAME&quot;</span>, cs%mld_var_name, &amp;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="stringliteral">&quot;Name of the variable containing the depth of active mixing&quot;</span>,&amp;</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    default=<span class="stringliteral">&#39;ePBL_h_ML&#39;</span>)</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;OFFLINE_ADD_DIURNAL_SW&quot;</span>, cs%diurnal_sw, &amp;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <span class="stringliteral">&quot;Adds a synthetic diurnal cycle in the same way that the ice\n&quot;</span> // &amp;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;    <span class="stringliteral">&quot;model would have when time-averaged fields of shortwave\n&quot;</span>    // &amp;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    <span class="stringliteral">&quot;radiation are read in&quot;</span>, default=.false.)</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KD_MAX&quot;</span>, cs%Kd_max, &amp;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="stringliteral">&quot;The maximum permitted increment for the diapycnal \n&quot;</span>//&amp;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    <span class="stringliteral">&quot;diffusivity from TKE-based parameterizations, or a \n&quot;</span>//&amp;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;    <span class="stringliteral">&quot;negative value for no limit.&quot;</span>, units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=-1.0)</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MIN_RESIDUAL_TRANSPORT&quot;</span>, cs%min_residual, &amp;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    <span class="stringliteral">&quot;How much remaining transport before the main offline advection\n&quot;</span>// &amp;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    <span class="stringliteral">&quot;is exited. The default value corresponds to about 1 meter of\n&quot;</span>  // &amp;</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    <span class="stringliteral">&quot;difference in a grid cell&quot;</span>, default = 1.e9)</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_ALL_TS_UVH&quot;</span>, cs%read_all_ts_uvh,  &amp;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    <span class="stringliteral">&quot;Reads all time levels of a subset of the fields necessary to run \n&quot;</span>    //      &amp;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;    <span class="stringliteral">&quot;the model offline. This can require a large amount of memory\n&quot;</span>//      &amp;</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    <span class="stringliteral">&quot;and will make initialization very slow. However, for offline\n&quot;</span>//      &amp;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    <span class="stringliteral">&quot;runs spanning more than a year this can reduce total I/O overhead&quot;</span>,    &amp;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    default = .false.)</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;  <span class="comment">! Concatenate offline directory and file names</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;  cs%snap_file = trim(cs%offlinedir)//trim(cs%snap_file)</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;  cs%mean_file = trim(cs%offlinedir)//trim(cs%mean_file)</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;  cs%sum_file = trim(cs%offlinedir)//trim(cs%sum_file)</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  cs%surf_file = trim(cs%offlinedir)//trim(cs%surf_file)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  cs%num_vert_iter = cs%dt_offline/cs%dt_offline_vertical</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <span class="comment">! Map redistribute_method onto logicals in CS</span></div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  <span class="keywordflow">select case</span> (redistribute_method)</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&#39;barotropic&#39;</span>)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;      cs%redistribute_barotropic = .true.</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;      cs%redistribute_upwards    = .false.</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&#39;upwards&#39;</span>)</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;      cs%redistribute_barotropic = .false.</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;      cs%redistribute_upwards    = .true.</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&#39;both&#39;</span>)</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      cs%redistribute_barotropic = .true.</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;      cs%redistribute_upwards    = .true.</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;      cs%redistribute_barotropic = .false.</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;      cs%redistribute_upwards    = .false.</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <span class="comment">! Set the accumulated time to zero</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;  cs%accumulated_time = 0</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;  <span class="comment">! Set the starting read index for time-averaged and snapshotted fields</span></div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;  cs%ridx_sum = cs%start_index</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;  <span class="keywordflow">if</span> (cs%fields_are_offset) cs%ridx_snap = next_modulo_time(cs%start_index,cs%numtime)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  <span class="keywordflow">if</span> (.not. cs%fields_are_offset) cs%ridx_snap = cs%start_index</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;  <span class="comment">! Copy members from other modules</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;  <span class="keyword">call </span>extract_diabatic_member(diabatic_csp, opacity_csp=cs%opacity_CSp, optics_csp=cs%optics,&amp;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                               evap_cfl_limit=cs%evap_CFL_limit, &amp;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                               minimum_forcing_depth=cs%minimum_forcing_depth)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  <span class="comment">! Grid pointer assignments</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  cs%G  =&gt; g</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  cs%GV =&gt; gv</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;  <span class="comment">! Allocate arrays</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;  <span class="keyword">allocate</span>(cs%uhtr(isdb:iedb,jsd:jed,nz))   ; cs%uhtr(:,:,:) = 0.0</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  <span class="keyword">allocate</span>(cs%vhtr(isd:ied,jsdb:jedb,nz))   ; cs%vhtr(:,:,:) = 0.0</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;  <span class="keyword">allocate</span>(cs%eatr(isd:ied,jsd:jed,nz))          ; cs%eatr(:,:,:) = 0.0</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;  <span class="keyword">allocate</span>(cs%ebtr(isd:ied,jsd:jed,nz))          ; cs%ebtr(:,:,:) = 0.0</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  <span class="keyword">allocate</span>(cs%h_end(isd:ied,jsd:jed,nz))         ; cs%h_end(:,:,:) = 0.0</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  <span class="keyword">allocate</span>(cs%netMassOut(g%isd:g%ied,g%jsd:g%jed)) ; cs%netMassOut(:,:) = 0.0</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keyword">allocate</span>(cs%netMassIn(g%isd:g%ied,g%jsd:g%jed))  ; cs%netMassIn(:,:) = 0.0</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;  <span class="keyword">allocate</span>(cs%Kd(isd:ied,jsd:jed,nz+1)) ; cs%Kd = 0.</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;  <span class="keywordflow">if</span> (cs%read_mld) <span class="keywordflow">then</span></div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;    <span class="keyword">allocate</span>(cs%mld(g%isd:g%ied,g%jsd:g%jed)) ; cs%mld(:,:) = 0.0</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;  <span class="keywordflow">if</span> (cs%read_all_ts_uvh) <span class="keywordflow">then</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    <span class="keyword">call </span>read_all_input(cs)</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <span class="comment">! Initialize ids for clocks used in offline routines</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  cs%id_clock_read_fields =      cpu_clock_id(<span class="stringliteral">&#39;(Offline read fields)&#39;</span>,grain=clock_module)</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;  cs%id_clock_offline_diabatic = cpu_clock_id(<span class="stringliteral">&#39;(Offline diabatic)&#39;</span>,grain=clock_module)</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;  cs%id_clock_offline_adv =      cpu_clock_id(<span class="stringliteral">&#39;(Offline transport)&#39;</span>,grain=clock_module)</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  cs%id_clock_redistribute =     cpu_clock_id(<span class="stringliteral">&#39;(Offline redistribute)&#39;</span>,grain=clock_module)</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;offline_transport_init&quot;</span>)</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_a3948771c2f4a319e66db28fe866e1549_cgraph.svg" width="391" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ad773f8f414f53f000cab30ad097aeaab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad773f8f414f53f000cab30ad097aeaab">&#9670;&nbsp;</a></span>post_offline_convergence_diags()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::post_offline_convergence_diags </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_off</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(cs%g),szj_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szjb_(cs%g),szk_(cs%g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Posts diagnostics related to offline convergence diagnostics. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Offline control structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_off</td><td>Thicknesses at end of offline step</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_end</td><td>Stored thicknesses</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>Remaining zonal mass transport</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>Remaining meridional mass transport </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01118">1118</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">intent(in   )</span> :: cs<span class="comment">     !&lt; Offline control structure</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span> :: h_off<span class="comment">  !&lt; Thicknesses at end of offline step</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>,  <span class="keywordtype">intent(inout)</span> :: h_end<span class="comment">  !&lt; Stored thicknesses</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: uhtr<span class="comment">   !&lt; Remaining zonal mass transport</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(inout)</span> :: vhtr<span class="comment">   !&lt; Remaining meridional mass transport</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G))</span> :: eta_diff</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keywordflow">if</span> (cs%id_eta_diff_end&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">! Calculate difference in column thickness</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    eta_diff = 0.</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <span class="keywordflow">do</span> k=1,cs%GV%ke ; <span class="keywordflow">do</span> j=cs%G%jsc,cs%G%jec ; <span class="keywordflow">do</span> i=cs%G%isc,cs%G%iec</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;      eta_diff(i,j) = eta_diff(i,j) + h_off(i,j,k)</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <span class="keywordflow">do</span> k=1,cs%GV%ke ; <span class="keywordflow">do</span> j=cs%G%jsc,cs%G%jec ; <span class="keywordflow">do</span> i=cs%G%isc,cs%G%iec</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;      eta_diff(i,j) = eta_diff(i,j) - h_end(i,j,k)</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="keyword">call </span>post_data(cs%id_eta_diff_end, eta_diff, cs%diag)</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="keywordflow">if</span> (cs%id_hdiff&gt;0) <span class="keyword">call </span>post_data(cs%id_hdiff, h_off-h_end, cs%diag)</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;  <span class="keywordflow">if</span> (cs%id_hr&gt;0) <span class="keyword">call </span>post_data(cs%id_hr, h_off, cs%diag)</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="keywordflow">if</span> (cs%id_uhr_end&gt;0) <span class="keyword">call </span>post_data(cs%id_uhr_end, uhtr, cs%diag)</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;  <span class="keywordflow">if</span> (cs%id_vhr_end&gt;0) <span class="keyword">call </span>post_data(cs%id_vhr_end, vhtr, cs%diag)</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="abc6fd7e877d8e70014cbad2d4e3f11c5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc6fd7e877d8e70014cbad2d4e3f11c5">&#9670;&nbsp;</a></span>read_all_input()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_offline_main::read_all_input </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Coordinates the allocation and reading in all time levels of uh, vh, hend, temp, and salt from files. Used when read_all_ts_uvh. </p>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01388">1388</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__offline__main_8F90_source.html#l01218">offline_transport_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(inout)</span>  :: cs</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, isd, ied, jsd, jed, nz, t, ntime</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  nz = cs%GV%ke ; ntime = cs%numtime</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  isd  = cs%G%isd   ; ied  = cs%G%ied  ; jsd  = cs%G%jsd  ; jed  = cs%G%jed</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  isdb = cs%G%IsdB  ; iedb = cs%G%IedB ; jsdb = cs%G%JsdB ; jedb = cs%G%JedB</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="comment">! Extra safety check that we&#39;re not going to overallocate any arrays</span></div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="keywordflow">if</span> (cs%read_all_ts_uvh) <span class="keywordflow">then</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%uhtr_all)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;uhtr_all is already allocated&quot;</span>)</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%vhtr_all)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;vhtr_all is already allocated&quot;</span>)</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%hend_all)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;hend_all is already allocated&quot;</span>)</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%temp_all)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;temp_all is already allocated&quot;</span>)</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%salt_all)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;salt_all is already allocated&quot;</span>)</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;    <span class="keyword">allocate</span>(cs%uhtr_all(isdb:iedb,jsd:jed,nz,ntime))     ; cs%uhtr_all(:,:,:,:) = 0.0</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    <span class="keyword">allocate</span>(cs%vhtr_all(isd:ied,jsdb:jedb,nz,ntime))     ; cs%vhtr_all(:,:,:,:) = 0.0</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    <span class="keyword">allocate</span>(cs%hend_all(isd:ied,jsd:jed,nz,ntime))       ; cs%hend_all(:,:,:,:) = 0.0</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    <span class="keyword">allocate</span>(cs%temp_all(isd:ied,jsd:jed,nz,1:ntime))     ; cs%temp_all(:,:,:,:) = 0.0</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="keyword">allocate</span>(cs%salt_all(isd:ied,jsd:jed,nz,1:ntime))     ; cs%salt_all(:,:,:,:) = 0.0</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    <span class="keywordflow">if</span> (is_root_pe()) <span class="keyword">write</span> (0,*) <span class="stringliteral">&quot;Reading in uhtr, vhtr, h_start, h_end, temp, salt&quot;</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <span class="keywordflow">do</span> t = 1,ntime</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;      <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;uhtr_sum&#39;</span>, cs%uhtr_all(:,:,1:cs%nk_input,t), domain=cs%G%Domain%mpp_domain, &amp;</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        timelevel=t, position=east)</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;      <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;vhtr_sum&#39;</span>, cs%vhtr_all(:,:,1:cs%nk_input,t), domain=cs%G%Domain%mpp_domain, &amp;</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        timelevel=t, position=north)</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;      <span class="keyword">call </span>read_data(cs%snap_file,<span class="stringliteral">&#39;h_end&#39;</span>, cs%hend_all(:,:,1:cs%nk_input,t), domain=cs%G%Domain%mpp_domain, &amp;</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        timelevel=t, position=center)</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;      <span class="keyword">call </span>read_data(cs%mean_file,<span class="stringliteral">&#39;temp&#39;</span>, cs%temp_all(:,:,1:cs%nk_input,t), domain=cs%G%Domain%mpp_domain, &amp;</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        timelevel=t, position=center)</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;      <span class="keyword">call </span>read_data(cs%mean_file,<span class="stringliteral">&#39;salt&#39;</span>, cs%salt_all(:,:,1:cs%nk_input,t), domain=cs%G%Domain%mpp_domain, &amp;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        timelevel=t, position=center)</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_abc6fd7e877d8e70014cbad2d4e3f11c5_icgraph.svg" width="391" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a0adf88ec8f84684573c1bafd91b22cf6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0adf88ec8f84684573c1bafd91b22cf6">&#9670;&nbsp;</a></span>register_diags_offline_transport()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::register_diags_offline_transport </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl)&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize additional diagnostics required for offline tracer transport. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure for MOM</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l01061">1061</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span> :: cs<span class="comment">         !&lt; control structure for MOM</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">intent(in)</span> :: time<span class="comment">               !&lt; current model time</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl)             :: diag</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;  <span class="comment">! U-cell fields</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  cs%id_uhr = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhr&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    <span class="stringliteral">&#39;Zonal thickness fluxes remaining at end of advection&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  cs%id_uhr_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhr_redist&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="stringliteral">&#39;Zonal thickness fluxes to be redistributed vertically&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  cs%id_uhr_end = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhr_end&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="stringliteral">&#39;Zonal thickness fluxes at end of offline step&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="comment">! V-cell fields</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  cs%id_vhr = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhr&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="stringliteral">&#39;Meridional thickness fluxes remaining at end of advection&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  cs%id_vhr_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhr_redist&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    <span class="stringliteral">&#39;Meridional thickness to be redistributed vertically&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  cs%id_vhr_end = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhr_end&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="stringliteral">&#39;Meridional thickness at end of offline step&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  <span class="comment">! T-cell fields</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;  cs%id_hdiff  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;hdiff&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <span class="stringliteral">&#39;Difference between the stored and calculated layer thickness&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  cs%id_hr  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;hr&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <span class="stringliteral">&#39;Layer thickness at end of offline step&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  cs%id_ear  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ear&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="stringliteral">&#39;Remaining thickness entrained from above&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;  cs%id_ebr  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ebr&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="stringliteral">&#39;Remaining thickness entrained from below&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  cs%id_eta_pre_distribute = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;eta_pre_distribute&#39;</span>, &amp;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    diag%axesT1, time, <span class="stringliteral">&#39;Total water column height before residual transport redistribution&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;  cs%id_eta_post_distribute = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;eta_post_distribute&#39;</span>, &amp;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    diag%axesT1, time, <span class="stringliteral">&#39;Total water column height after residual transport redistribution&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  cs%id_eta_diff_end = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;eta_diff_end&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="stringliteral">&#39;Difference in total water column height from online and offline &#39;</span> // &amp;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <span class="stringliteral">&#39;at the end of the offline timestep&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;  cs%id_h_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;h_redist&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <span class="stringliteral">&#39;Layer thicknesses before redistribution of mass fluxes&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  <span class="comment">! Regridded/remapped input fields</span></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  cs%id_uhtr_regrid = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhtr_regrid&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                                          <span class="stringliteral">&#39;Zonal mass transport regridded/remapped onto offline grid&#39;</span>,<span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  cs%id_vhtr_regrid = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhtr_regrid&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                                          <span class="stringliteral">&#39;Meridional mass transport regridded/remapped onto offline grid&#39;</span>,<span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;  cs%id_temp_regrid = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;temp_regrid&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                                          <span class="stringliteral">&#39;Temperature regridded/remapped onto offline grid&#39;</span>,<span class="stringliteral">&#39;C&#39;</span>)</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  cs%id_salt_regrid = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;salt_regrid&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                                          <span class="stringliteral">&#39;Salinity regridded/remapped onto offline grid&#39;</span>,<span class="stringliteral">&#39;g kg-1&#39;</span>)</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  cs%id_h_regrid = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;h_regrid&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                          <span class="stringliteral">&#39;Layer thicknesses regridded/remapped onto offline grid&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a713ee3448313842b0f07a5a750a01c60"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a713ee3448313842b0f07a5a750a01c60">&#9670;&nbsp;</a></span>remaining_transport_sum()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real function mom_offline_main::remaining_transport_sum </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(cs%g),szj_(cs%g),szk_(cs%g)), intent(in)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szjb_(cs%g),szk_(cs%g)), intent(in)&#160;</td>
          <td class="paramname"><em>vhtr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Sums any non-negligible remaining transport to check for advection convergence. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure for offline module</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">uhtr</td><td>Zonal mass transport</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">vhtr</td><td>Meridional mass transport </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00582">582</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__offline__main_8F90_source.html#l00181">offline_advection_ale()</a>, and <a class="el" href="MOM__offline__main_8F90_source.html#l00388">offline_redistribute_residual()</a>.</p>
<div class="fragment"><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>  :: cs<span class="comment"> !&lt; control structure for offline module</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(in   )</span>  :: uhtr<span class="comment">  !&lt; Zonal mass transport</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJB_(CS%G),SZK_(CS%G))</span>, <span class="keywordtype">intent(in   )</span>  :: vhtr<span class="comment">  !&lt; Meridional mass transport</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, nz</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordtype">real</span> :: h_min<span class="comment"> !&lt; A layer thickness below roundoff from GV type</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">real</span> :: uh_neglect<span class="comment"> !&lt; A small value of zonal transport that effectively is below roundoff error</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">real</span> :: vh_neglect<span class="comment"> !&lt; A small value of meridional transport that effectively is below roundoff error</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  nz = cs%GV%ke</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  is = cs%G%isc ; ie = cs%G%iec ; js = cs%G%jsc ; je = cs%G%jec</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  h_min = cs%GV%H_subroundoff</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  remaining_transport_sum = 0.</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">do</span> k=1,nz; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    uh_neglect = h_min*min(cs%G%areaT(i,j),cs%G%areaT(i+1,j))</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    vh_neglect = h_min*min(cs%G%areaT(i,j),cs%G%areaT(i,j+1))</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">if</span> (abs(uhtr(i,j,k))&gt;uh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      remaining_transport_sum = remaining_transport_sum + abs(uhtr(i,j,k))</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordflow">if</span> (abs(vhtr(i,j,k))&gt;vh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      remaining_transport_sum = remaining_transport_sum + abs(vhtr(i,j,k))</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="keyword">  end</span>do; enddo; enddo</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;  <span class="keyword">call </span>sum_across_pes(remaining_transport_sum)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__offline__main_a713ee3448313842b0f07a5a750a01c60_icgraph.svg" width="422" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a2e59b996b88713928c04f72d57c5a531"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e59b996b88713928c04f72d57c5a531">&#9670;&nbsp;</a></span>update_offline_fields()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_main::update_offline_fields </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__offline__main_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(cs%g),szj_(cs%g),szk_(cs%g))&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>do_ale</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update fields used in this round of offline transport. First fields are updated from files or from arrays read during initialization. Then if in an ALE-dependent coordinate, regrid/remap fields. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Control structure for offline module</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">h</td><td>The regridded layer thicknesses</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxes</td><td>Pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">do_ale</td><td>True if using ALE </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__offline__main_8F90_source.html#l00966">966</a> of file <a class="el" href="MOM__offline__main_8F90_source.html">MOM_offline_main.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>               :: cs<span class="comment"> !&lt; Control structure for offline module</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: h<span class="comment"> !&lt; The regridded layer thicknesses</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <span class="keywordtype">type</span>(forcing),        <span class="keywordtype">intent(inout)</span> :: fluxes<span class="comment"> !&lt; Pointers to forcing fields</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="keywordtype">logical</span>,              <span class="keywordtype">intent(in   )</span> :: do_ale<span class="comment"> !&lt; True if using ALE</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(CS%G),SZJ_(CS%G),SZK_(CS%G))</span> :: h_start</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  is = cs%G%isc ; ie = cs%G%iec ; js = cs%G%jsc ; je = cs%G%jec ; nz = cs%GV%ke</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_read_fields)</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;update_offline_fields, MOM_offline_main.F90&quot;</span>)</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <span class="comment">! Store a copy of the layer thicknesses before ALE regrid/remap</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  h_start(:,:,:) = h(:,:,:)</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  <span class="comment">! Most fields will be read in from files</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  <span class="keyword">call </span>update_offline_from_files( cs%G, cs%GV, cs%nk_input, cs%mean_file, cs%sum_file, cs%snap_file, cs%surf_file,    &amp;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                                  cs%h_end, cs%uhtr, cs%vhtr, cs%tv%T, cs%tv%S, cs%mld, cs%Kd, fluxes,                &amp;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                                  cs%ridx_sum, cs%ridx_snap, cs%read_mld, cs%read_sw, .not. cs%read_all_ts_uvh, do_ale)</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  <span class="comment">! If uh, vh, h_end, temp, salt were read in at the beginning, fields are copied from those arrays</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="keywordflow">if</span> (cs%read_all_ts_uvh) <span class="keywordflow">then</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;      <span class="keyword">call </span>update_offline_from_arrays(cs%G, cs%GV, cs%nk_input, cs%ridx_sum, cs%mean_file, cs%sum_file, cs%snap_file, &amp;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        cs%uhtr, cs%vhtr, cs%h_end, cs%uhtr_all, cs%vhtr_all, cs%hend_all, cs%tv%T, cs%tv%S, cs%temp_all, cs%salt_all)</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]h after update offline from files and arrays&quot;</span>, cs%uhtr, cs%vhtr, cs%G%HI)</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <span class="comment">! If using an ALE-dependent vertical coordinate, fields will need to be remapped</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordflow">if</span> (do_ale) <span class="keywordflow">then</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <span class="comment">! These halo passes are necessary because u, v fields will need information 1 step into the halo</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    <span class="keyword">call </span>pass_var(h, cs%G%Domain)</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keyword">call </span>pass_var(cs%tv%T, cs%G%Domain)</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="keyword">call </span>pass_var(cs%tv%S, cs%G%Domain)</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keyword">call </span>ale_offline_inputs(cs%ALE_CSp, cs%G, cs%GV, h, cs%tv, cs%tracer_Reg, cs%uhtr, cs%vhtr, cs%Kd, cs%debug)</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <span class="keywordflow">if</span> (cs%id_temp_regrid&gt;0) <span class="keyword">call </span>post_data(cs%id_temp_regrid, cs%tv%T, cs%diag)</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <span class="keywordflow">if</span> (cs%id_salt_regrid&gt;0) <span class="keyword">call </span>post_data(cs%id_salt_regrid, cs%tv%S, cs%diag)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="keywordflow">if</span> (cs%id_uhtr_regrid&gt;0) <span class="keyword">call </span>post_data(cs%id_uhtr_regrid, cs%uhtr, cs%diag)</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordflow">if</span> (cs%id_vhtr_regrid&gt;0) <span class="keyword">call </span>post_data(cs%id_vhtr_regrid, cs%vhtr, cs%diag)</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">if</span> (cs%id_h_regrid&gt;0) <span class="keyword">call </span>post_data(cs%id_h_regrid, h, cs%diag)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]h after ALE regridding/remapping of inputs&quot;</span>, cs%uhtr, cs%vhtr, cs%G%HI)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;      <span class="keyword">call </span>hchksum(h_start,<span class="stringliteral">&quot;h_start after update offline from files and arrays&quot;</span>, cs%G%HI)</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  <span class="comment">! Update halos for some</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;  <span class="keyword">call </span>pass_var(cs%h_end, cs%G%Domain)</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  <span class="keyword">call </span>pass_var(cs%tv%T, cs%G%Domain)</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;  <span class="keyword">call </span>pass_var(cs%tv%S, cs%G%Domain)</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  <span class="comment">! Update the read indices</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  cs%ridx_snap = next_modulo_time(cs%ridx_snap,cs%numtime)</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  cs%ridx_sum = next_modulo_time(cs%ridx_sum,cs%numtime)</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;  <span class="comment">! Apply masks/factors at T, U, and V points</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="keywordflow">if</span> (cs%G%mask2dT(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;      cs%h_end(i,j,k) = cs%GV%Angstrom</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;  <span class="keywordflow">do</span> k=1,nz+1 ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    cs%Kd(i,j,k) = max(0.0, cs%Kd(i,j,k))</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">if</span> (cs%Kd_max&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      cs%Kd(i,j,k) = min(cs%Kd_max, cs%Kd(i,j,k))</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> ;</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <span class="keywordflow">if</span> (cs%G%mask2dCv(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;      cs%vhtr(i,j,k) = 0.0</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <span class="keywordflow">if</span> (cs%G%mask2dCu(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;      cs%uhtr(i,j,k) = 0.0</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;[uv]htr_sub after update_offline_fields&quot;</span>, cs%uhtr, cs%vhtr, cs%G%HI)</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="keyword">call </span>hchksum(cs%h_end, <span class="stringliteral">&quot;h_end after update_offline_fields&quot;</span>, cs%G%HI)</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="keyword">call </span>hchksum(cs%tv%T, <span class="stringliteral">&quot;Temp after update_offline_fields&quot;</span>, cs%G%HI)</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    <span class="keyword">call </span>hchksum(cs%tv%S, <span class="stringliteral">&quot;Salt after update_offline_fields&quot;</span>, cs%G%HI)</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;update_offline_fields&quot;</span>)</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  <span class="keyword">call </span>cpu_clock_end(cs%id_clock_read_fields)</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__offline__main.html">mom_offline_main</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
