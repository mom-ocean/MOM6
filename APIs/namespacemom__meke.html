<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_meke Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__meke.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_meke Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implements the Mesoscale Eddy Kinetic Energy framework. </p>
<h1><a class="anchor" id="section_MEKE"></a>
The Mesoscale Eddy Kinetic Energy (MEKE) framework</h1>
<p>The MEKE framework accounts for the mean potential energy removed by the first order closures used to parameterize mesoscale eddies. It requires closure at the second order, namely dissipation and transport of eddy energy.</p>
<p>Monitoring the sub-grid scale eddy energy budget provides a means to predict a sub-grid eddy-velocity scale which can be used in the lower order closures.</p>
<h2><a class="anchor" id="section_MEKE_equations"></a>
MEKE equations</h2>
<p>The eddy kinetic energy equation is: </p><p class="formulaDsp">
\[ \partial_\tilde{t} E = \overbrace{ \dot{E}_b + \gamma_\eta \dot{E}_\eta + \gamma_v \dot{E}_v }^\text{sources} - \overbrace{ ( \lambda + C_d | U_d | \gamma_b^2 ) E }^\text{local dissipation} + \overbrace{ \nabla \cdot ( ( \kappa_E + \gamma_M \kappa_M ) \nabla E - \kappa_4 \nabla^3 E ) }^\text{smoothing} \]
</p>
<p> where \( E \) is the eddy kinetic energy (variable <code>MEKE</code>) with units of m<sup>2</sup>s<sup>-2</sup>, and \(\tilde{t} = a t\) is a scaled time. The non-dimensional factor \( a\geq 1 \) is used to accelerate towards equilibrium.</p>
<p>The MEKE equation is two-dimensional and obtained by depth averaging the the three-dimensional eddy energy equation. In the following expressions \( \left&lt; \phi \right&gt; = \frac{1}{H} \int^\eta_{-D} \phi \, dz \) maps three dimensional terms into the two-dimensional quantities needed.</p>
<h3><a class="anchor" id="section_MEKE_source_terms"></a>
MEKE source terms</h3>
<p>The source term \( \dot{E}_b \) is a constant background source of energy intended to avoid the limit \(E\rightarrow 0\).</p>
<p>The "GM" source term </p><p class="formulaDsp">
\[ \dot{E}_\eta = - \left&lt; \overline{w^\prime b^\prime} \right&gt; = \left&lt; \kappa_h N^2S^2 \right&gt; \approx \left&lt; \kappa_h g\prime |\nabla_\sigma \eta|^2 \right&gt;\]
</p>
<p> equals the mean potential energy removed by the Gent-McWilliams closure, and is excluded/included in the MEKE budget by the efficiency parameter \( \gamma_\eta \in [0,1] \).</p>
<p>The "frictional" source term </p><p class="formulaDsp">
\[ \dot{E}_{v} = \left&lt; u \cdot \tau_h \right&gt; \]
</p>
<p> equals the mean kinetic energy removed by lateral viscous fluxes, and is excluded/included in the MEKE budget by the efficiency parameter \( \gamma_v \in [0,1] \).</p>
<h3><a class="anchor" id="section_MEKE_dissipation_terms"></a>
MEKE dissipation terms</h3>
<p>The local dissipation of \( E \) is parameterized through a linear damping, \(\lambda\), and bottom drag, \( C_d | U_d | \gamma_b^2 \). The \( \gamma_b \) accounts for the weak projection of the column-mean eddy velocty to the bottom. In other words, the bottom velocity is estimated as \( \gamma_b U_e \). The bottom drag coefficient, \( C_d \) is the same as that used in the bottom friction in the mean model equations.</p>
<p>The bottom drag velocity scale, \( U_d \), has contributions from the resolved state and \( E \): </p><p class="formulaDsp">
\[ U_d = \sqrt{ U_b^2 + |u|^2_{z=-D} + |\gamma_b U_e|^2 } .\]
</p>
<p> where the eddy velocity scale, \( U_e \), is given by: </p><p class="formulaDsp">
\[ U_e = \sqrt{ 2 E } .\]
</p>
<p> \( U_b \) is a constant background bottom velocity scale and is typically not used (i.e. set to zero).</p>
<p>Following Jansen et al., 2015, the projection of eddy energy on to the bottom is given by the ratio of bottom energy to column mean energy: </p><p class="formulaDsp">
\[ \gamma_b^2 = \frac{E_b}{E} = \gamma_{d0} + \left( 1 + c_{b} \frac{L_d}{L_f} \right)^{-\frac{4}{5}} , \]
</p>
 <p class="formulaDsp">
\[ \gamma_b^2 \leftarrow \max{\left( \gamma_b^2, \gamma_{min}^2 \right)} . \]
</p>
<h2><a class="anchor" id="section_MEKE_smoothing"></a>
MEKE smoothing terms</h2>
<p>\( E \) is laterally diffused by a diffusivity \( \kappa_E + \gamma_M \kappa_M \) where \( \kappa_E \) is a constant diffusivity and the term \( \gamma_M \kappa_M \) is a "self diffusion" using the diffusivity calculated in the section <a class="el" href="namespacemom__meke.html#section_MEKE_diffusivity">Diffusivity derived from MEKE</a>. \( \kappa_4 \) is a constant bi-harmonic diffusivity.</p>
<h2><a class="anchor" id="section_MEKE_diffusivity"></a>
Diffusivity derived from MEKE</h2>
<p>The predicted eddy velocity scale, \( U_e \), can be combined with a mixing length scale to form a diffusivity. The primary use of a MEKE derived diffusivity is for use in thickness diffusion (module <a class="el" href="namespacemom__thickness__diffuse.html" title="Thickness diffusion (or Gent McWilliams) ">mom_thickness_diffuse</a>) and optionally in along isopycnal mixing of tracers (module <a class="el" href="namespacemom__tracer__hor__diff.html" title="Main routine for lateral (along surface or neutral) diffusion of tracers. ">mom_tracer_hor_diff</a>). The original form used (enabled with MEKE_OLD_LSCALE=True):</p>
<p class="formulaDsp">
\[ \kappa_M = \gamma_\kappa \sqrt{ \gamma_t^2 U_e^2 A_\Delta } \]
</p>
<p>where \( A_\Delta \) is the area of the grid cell. Following Jansen et al., 2015, we now use</p>
<p class="formulaDsp">
\[ \kappa_M = \gamma_\kappa l_M \sqrt{ \gamma_t^2 U_e^2 } \]
</p>
<p>where \( \gamma_\kappa \in [0,1] \) is a non-dimensional factor and, following Jansen et al., 2015, \(\gamma_t^2\) is the ratio of barotropic eddy energy to column mean eddy energy given by </p><p class="formulaDsp">
\[ \gamma_t^2 = \frac{E_t}{E} = \left( 1 + c_{t} \frac{L_d}{L_f} \right)^{-\frac{1}{4}} , \]
</p>
 <p class="formulaDsp">
\[ \gamma_t^2 \leftarrow \max{\left( \gamma_t^2, \gamma_{min}^2 \right)} . \]
</p>
<p>The length-scale is a configurable combination of multiple length scales:</p>
<p class="formulaDsp">
\[ l_M = \left( \frac{\alpha_d}{L_d} + \frac{\alpha_f}{L_f} + \frac{\alpha_R}{L_R} + \frac{\alpha_e}{L_e} + \frac{\alpha_\Delta}{L_\Delta} + \frac{\delta[L_c]}{L_c} \right)^{-1} \]
</p>
<p>where</p>
<p class="formulaDsp">
\begin{eqnarray*} L_d &amp; = &amp; \sqrt{\frac{c_g^2}{f^2+2\beta c_g}} \sim \frac{ c_g }{f} \\\ L_R &amp; = &amp; \sqrt{\frac{U_e}{\beta}} \\\ L_e &amp; = &amp; \frac{U_e}{|S| N} \\\ L_f &amp; = &amp; \frac{H}{c_d} \\\ L_\Delta &amp; = &amp; \sqrt{A_\Delta} . \end{eqnarray*}
</p>
<p>\(L_c\) is a constant and \(\delta[L_c]\) is the impulse function so that the term \(\frac{\delta[L_c]}{L_c}\) evaluates to \(\frac{1}{L_c}\) when \(L_c\) is non-zero but is dropped if \(L_c=0\).</p>
<h2><a class="anchor" id="section_MEKE_viscosity"></a>
Viscosity derived from MEKE</h2>
<p>As for \( \kappa_M \), the predicted eddy velocity scale can be used to form an eddy viscosity:</p>
<p class="formulaDsp">
\[ \kappa_u = \gamma_u \sqrt{ U_e^2 A_\Delta } . \]
</p>
<h2><a class="anchor" id="section_MEKE_limit_case"></a>
Limit cases for local source-dissipative balance</h2>
<p>Note that in steady-state (or when \( a&gt;&gt;1 \)) and there is no diffusion of \( E \) then </p><p class="formulaDsp">
\[ \overline{E} \approx \frac{ \dot{E}_b + \gamma_\eta \dot{E}_\eta + \gamma_v \dot{E}_v }{ \lambda + C_d|U_d|\gamma_b^2 } . \]
</p>
<p>In the linear drag limit, where \( U_e &lt;&lt; \min(U_b, |u|_{z=-D}, C_d^{-1}\lambda) \), the equilibrium becomes \( \overline{E} \approx \frac{ \dot{E}_b + \gamma_\eta \dot{E}_\eta + \gamma_v \dot{E}_v }{ \lambda + C_d \sqrt{ U_b^2 + |u|^2_{z=-D} } } \).</p>
<p>In the nonlinear drag limit, where \( U_e &gt;&gt; \max(U_b, |u|_{z=-D}, C_d^{-1}\lambda) \), the equilibrium becomes \( \overline{E} \approx \left( \frac{ \dot{E}_b + \gamma_\eta \dot{E}_\eta + \gamma_v \dot{E}_v }{ \sqrt{2} C_d \gamma_b^3 } \right)^\frac{2}{3} \).</p>
<h3><a class="anchor" id="section_MEKE_module_parameters"></a>
MEKE module parameters</h3>
<table class="doxtable">
<tr>
<th>Symbol </th><th>Module parameter  </th></tr>
<tr>
<td>- </td><td><code>USE_MEKE</code> </td></tr>
<tr>
<td>\( a \) </td><td><code>MEKE_DTSCALE</code> </td></tr>
<tr>
<td>\( \dot{E}_b \) </td><td><code>MEKE_BGSRC</code> </td></tr>
<tr>
<td>\( \gamma_\eta \) </td><td><code>MEKE_GMCOEFF</code> </td></tr>
<tr>
<td>\( \gamma_v \) </td><td><code>MEKE_FrCOEFF</code> </td></tr>
<tr>
<td>\( \lambda \) </td><td><code>MEKE_DAMPING</code> </td></tr>
<tr>
<td>\( U_b \) </td><td><code>MEKE_USCALE</code> </td></tr>
<tr>
<td>\( \gamma_{d0} \) </td><td><code>MEKE_CD_SCALE</code> </td></tr>
<tr>
<td>\( c_{b} \) </td><td><code>MEKE_CB</code> </td></tr>
<tr>
<td>\( c_{t} \) </td><td><code>MEKE_CT</code> </td></tr>
<tr>
<td>\( \kappa_E \) </td><td><code>MEKE_KH</code> </td></tr>
<tr>
<td>\( \kappa_4 \) </td><td><code>MEKE_K4</code> </td></tr>
<tr>
<td>\( \gamma_\kappa \) </td><td><code>MEKE_KHCOEFF</code> </td></tr>
<tr>
<td>\( \gamma_M \) </td><td><code>MEKE_KHMEKE_FAC</code> </td></tr>
<tr>
<td>\( \gamma_u \) </td><td><code>MEKE_VISCOSITY_COEFF</code> </td></tr>
<tr>
<td>\( \gamma_{min}^2 \)</td><td><code>MEKE_MIN_GAMMA2</code> </td></tr>
<tr>
<td>\( \alpha_d \) </td><td><code>MEKE_ALPHA_DEFORM</code> </td></tr>
<tr>
<td>\( \alpha_f \) </td><td><code>MEKE_ALPHA_FRICT</code> </td></tr>
<tr>
<td>\( \alpha_R \) </td><td><code>MEKE_ALPHA_RHINES</code> </td></tr>
<tr>
<td>\( \alpha_e \) </td><td><code>MEKE_ALPHA_EADY</code> </td></tr>
<tr>
<td>\( \alpha_\Delta \) </td><td><code>MEKE_ALPHA_GRID</code> </td></tr>
<tr>
<td>\( L_c \) </td><td><code>MEKE_FIXED_MIXING_LENGTH</code> </td></tr>
<tr>
<td>- </td><td><code>MEKE_KHTH_FAC</code> </td></tr>
<tr>
<td>- </td><td><code>MEKE_KHTR_FAC</code> </td></tr>
</table>
<table class="doxtable">
<tr>
<th>Symbol </th><th>Model parameter  </th></tr>
<tr>
<td>\( C_d \) </td><td><code>CDRAG</code> </td></tr>
</table>
<h2><a class="anchor" id="section_MEKE_references"></a>
References</h2>
<p>Jansen, M. F., A. J. Adcroft, R. Hallberg, and I. M. Held, 2015: Parameterization of eddy fluxes based on a mesoscale energy budget. Ocean Modelling, 92, 28&ndash;41, <a href="http://doi.org/10.1016/j.ocemod.2015.05.007">http://doi.org/10.1016/j.ocemod.2015.05.007</a> .</p>
<p>Marshall, D. P., and A. J. Adcroft, 2010: Parameterization of ocean eddies: Potential vorticity mixing, energetics and Arnold first stability theorem. Ocean Modelling, 32, 188&ndash;204, <a href="http://doi.org/10.1016/j.ocemod.2010.02.001">http://doi.org/10.1016/j.ocemod.2010.02.001</a> . </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure that contains MEKE parameters and diagnostics handles.  <a href="structmom__meke_1_1meke__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:adff303c8c542ec848294078e4b3bc010"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#adff303c8c542ec848294078e4b3bc010">step_forward_meke</a> (MEKE, h, SN_u, SN_v, visc, dt, G, GV, CS, hu, hv)</td></tr>
<tr class="memdesc:adff303c8c542ec848294078e4b3bc010"><td class="mdescLeft">&#160;</td><td class="mdescRight">Integrates forward-in-time the MEKE eddy energy equation. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>.  <a href="#adff303c8c542ec848294078e4b3bc010">More...</a><br /></td></tr>
<tr class="separator:adff303c8c542ec848294078e4b3bc010"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc39c025706ccbcab39795b56a01d15c"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#afc39c025706ccbcab39795b56a01d15c">meke_equilibrium</a> (CS, MEKE, G, GV, SN_u, SN_v, drag_rate_visc, I_mass)</td></tr>
<tr class="memdesc:afc39c025706ccbcab39795b56a01d15c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the equilibrium solutino where the source depends only on MEKE diffusivity and there is no lateral diffusion of MEKE. Results is in MEKEMEKE.  <a href="#afc39c025706ccbcab39795b56a01d15c">More...</a><br /></td></tr>
<tr class="separator:afc39c025706ccbcab39795b56a01d15c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa5ed096f400a914e1e318fde1e880ffe"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#aa5ed096f400a914e1e318fde1e880ffe">meke_lengthscales</a> (CS, MEKE, G, SN_u, SN_v, EKE, bottomFac2, barotrFac2, LmixScale)</td></tr>
<tr class="memdesc:aa5ed096f400a914e1e318fde1e880ffe"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the eddy mixing length scale and \(\gamma_b\) and \(\gamma_t\) functions that are ratios of either bottom or barotropic eddy energy to the column eddy energy, respectively. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>.  <a href="#aa5ed096f400a914e1e318fde1e880ffe">More...</a><br /></td></tr>
<tr class="separator:aa5ed096f400a914e1e318fde1e880ffe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a577e88a6514c7dfa9a05b1d5eff2b8c6"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#a577e88a6514c7dfa9a05b1d5eff2b8c6">meke_lengthscales_0d</a> (CS, area, beta, depth, Rd_dx, SN, EKE, bottomFac2, barotrFac2, LmixScale, Lrhines, Leady)</td></tr>
<tr class="memdesc:a577e88a6514c7dfa9a05b1d5eff2b8c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the eddy mixing length scale and \(\gamma_b\) and \(\gamma_t\) functions that are ratios of either bottom or barotropic eddy energy to the column eddy energy, respectively. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>.  <a href="#a577e88a6514c7dfa9a05b1d5eff2b8c6">More...</a><br /></td></tr>
<tr class="separator:a577e88a6514c7dfa9a05b1d5eff2b8c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3541e89d2c55cbd6b77f7a256040f5b2"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#a3541e89d2c55cbd6b77f7a256040f5b2">meke_init</a> (Time, G, param_file, diag, CS, MEKE, restart_CS)</td></tr>
<tr class="memdesc:a3541e89d2c55cbd6b77f7a256040f5b2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes the MOM_MEKE module and reads parameters. Returns True if module is to be used, otherwise returns False.  <a href="#a3541e89d2c55cbd6b77f7a256040f5b2">More...</a><br /></td></tr>
<tr class="separator:a3541e89d2c55cbd6b77f7a256040f5b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1900316331157e48f1a6029bac63fbd0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#a1900316331157e48f1a6029bac63fbd0">meke_alloc_register_restart</a> (HI, param_file, MEKE, restart_CS)</td></tr>
<tr class="memdesc:a1900316331157e48f1a6029bac63fbd0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocates memory and register restart fields for the MOM_MEKE module.  <a href="#a1900316331157e48f1a6029bac63fbd0">More...</a><br /></td></tr>
<tr class="separator:a1900316331157e48f1a6029bac63fbd0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc007bf1aa24263f699b059d3e9cc6eb"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__meke.html#acc007bf1aa24263f699b059d3e9cc6eb">meke_end</a> (MEKE, CS)</td></tr>
<tr class="memdesc:acc007bf1aa24263f699b059d3e9cc6eb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deallocates any variables allocated in MEKE_init or MEKE_alloc_register_restart.  <a href="#acc007bf1aa24263f699b059d3e9cc6eb">More...</a><br /></td></tr>
<tr class="separator:acc007bf1aa24263f699b059d3e9cc6eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a1900316331157e48f1a6029bac63fbd0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1900316331157e48f1a6029bac63fbd0">&#9670;&nbsp;</a></span>meke_alloc_register_restart()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_meke::meke_alloc_register_restart </td>
          <td>(</td>
          <td class="paramtype">type(hor_index_type), intent(in)&#160;</td>
          <td class="paramname"><em>HI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mom_restart_cs), pointer&#160;</td>
          <td class="paramname"><em>restart_CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocates memory and register restart fields for the MOM_MEKE module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">hi</td><td>Horizontal index structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>Parameter file parser structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>A structure with MEKE-related fields.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">restart_cs</td><td>Restart control structure for MOM_MEKE. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l01043">1043</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00057">mom_error_handler::mom_mesg()</a>, and <a class="el" href="MOM__io_8F90_source.html#l00585">mom_io::var_desc()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM_8F90_source.html#l01480">mom::initialize_mom()</a>.</p>
<div class="fragment"><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">! Arguments</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  <span class="keywordtype">type</span>(hor_index_type),  <span class="keywordtype">intent(in)</span>    :: hi<span class="comment">         !&lt; Horizontal index structure</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="keywordtype">type</span>(param_file_type), <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; Parameter file parser structure.</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordtype">type</span>(meke_type),       <span class="keywordtype">pointer</span>       :: meke<span class="comment">       !&lt; A structure with MEKE-related fields.</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordtype">type</span>(mom_restart_cs),  <span class="keywordtype">pointer</span>       :: restart_cs<span class="comment"> !&lt; Restart control structure for MOM_MEKE.</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment">! Local variables</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordtype">type</span>(vardesc) :: vd</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  <span class="keywordtype">real</span> :: meke_gmcoeff, meke_frcoeff, meke_khcoeff, meke_visccoeff</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keywordtype">logical</span> :: usemeke</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">! Determine whether this module will be used</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  usemeke = .false.; <span class="keyword">call </span>read_param(param_file,<span class="stringliteral">&quot;USE_MEKE&quot;</span>,usemeke)</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="comment">! Read these parameters to determine what should be in the restarts</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  meke_gmcoeff =-1.; <span class="keyword">call </span>read_param(param_file,<span class="stringliteral">&quot;MEKE_GMCOEFF&quot;</span>,meke_gmcoeff)</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  meke_frcoeff =-1.; <span class="keyword">call </span>read_param(param_file,<span class="stringliteral">&quot;MEKE_FRCOEFF&quot;</span>,meke_frcoeff)</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  meke_khcoeff =1.; <span class="keyword">call </span>read_param(param_file,<span class="stringliteral">&quot;MEKE_KHCOEFF&quot;</span>,meke_khcoeff)</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  meke_visccoeff =0.; <span class="keyword">call </span>read_param(param_file,<span class="stringliteral">&quot;MEKE_VISCOSITY_COEFF&quot;</span>,meke_visccoeff)</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="comment">! Allocate control structure</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke)) <span class="keywordflow">then</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MEKE_alloc_register_restart called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                             <span class="stringliteral">&quot;MEKE type.&quot;</span>)</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  else; <span class="keyword">allocate</span>(meke);<span class="keywordflow"> endif</span></div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  <span class="keywordflow">if</span> (.not. usemeke) <span class="keywordflow">return</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="comment">! Allocate memory</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;MEKE_alloc_register_restart: allocating and registering&quot;</span>, 5)</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  isd = hi%isd ; ied = hi%ied ; jsd = hi%jsd ; jed = hi%jed</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="keyword">allocate</span>(meke%MEKE(isd:ied,jsd:jed)) ; meke%MEKE(:,:) = 0.0</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  vd = var_desc(<span class="stringliteral">&quot;MEKE&quot;</span>, <span class="stringliteral">&quot;m2 s-2&quot;</span>, hor_grid=<span class="stringliteral">&#39;h&#39;</span>, z_grid=<span class="stringliteral">&#39;1&#39;</span>, &amp;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;           longname=<span class="stringliteral">&quot;Mesoscale Eddy Kinetic Energy&quot;</span>)</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="keyword">call </span>register_restart_field(meke%MEKE, vd, .false., restart_cs)</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  <span class="keywordflow">if</span> (meke_gmcoeff&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="keyword">allocate</span>(meke%GM_src(isd:ied,jsd:jed)) ; meke%GM_src(:,:) = 0.0</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  <span class="keywordflow">if</span> (meke_frcoeff&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keyword">allocate</span>(meke%mom_src(isd:ied,jsd:jed)) ; meke%mom_src(:,:) = 0.0</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <span class="keywordflow">if</span> (meke_khcoeff&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <span class="keyword">allocate</span>(meke%Kh(isd:ied,jsd:jed)) ; meke%Kh(:,:) = 0.0</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    vd = var_desc(<span class="stringliteral">&quot;MEKE_Kh&quot;</span>, <span class="stringliteral">&quot;m2 s-1&quot;</span>,hor_grid=<span class="stringliteral">&#39;h&#39;</span>,z_grid=<span class="stringliteral">&#39;1&#39;</span>, &amp;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;             longname=<span class="stringliteral">&quot;Lateral diffusivity from Mesoscale Eddy Kinetic Energy&quot;</span>)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="keyword">call </span>register_restart_field(meke%Kh, vd, .false., restart_cs)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  <span class="keyword">allocate</span>(meke%Rd_dx_h(isd:ied,jsd:jed)) ; meke%Rd_dx_h(:,:) = 0.0</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordflow">if</span> (meke_visccoeff/=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="keyword">allocate</span>(meke%Ku(isd:ied,jsd:jed)) ; meke%Ku(:,:) = 0.0</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    vd = var_desc(<span class="stringliteral">&quot;MEKE_Ah&quot;</span>, <span class="stringliteral">&quot;m2 s-1&quot;</span>, hor_grid=<span class="stringliteral">&#39;h&#39;</span>, z_grid=<span class="stringliteral">&#39;1&#39;</span>, &amp;</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;             longname=<span class="stringliteral">&quot;Lateral viscosity from Mesoscale Eddy Kinetic Energy&quot;</span>)</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="keyword">call </span>register_restart_field(meke%Ku, vd, .false., restart_cs)</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_a1900316331157e48f1a6029bac63fbd0_cgraph.svg" width="100%" height="454"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_a1900316331157e48f1a6029bac63fbd0_icgraph.svg" width="500" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="acc007bf1aa24263f699b059d3e9cc6eb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc007bf1aa24263f699b059d3e9cc6eb">&#9670;&nbsp;</a></span>meke_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_meke::meke_end </td>
          <td>(</td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deallocates any variables allocated in MEKE_init or MEKE_alloc_register_restart. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">meke</td><td>A structure with MEKE-related fields.</td></tr>
    <tr><td class="paramname">cs</td><td>The control structure for MOM_MEKE. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l01104">1104</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  <span class="keywordtype">type</span>(meke_type), <span class="keywordtype">pointer</span> :: meke<span class="comment"> !&lt; A structure with MEKE-related fields.</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;  <span class="keywordtype">type</span>(meke_cs),   <span class="keywordtype">pointer</span> :: cs<span class="comment">   !&lt; The control structure for MOM_MEKE.</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(meke)) <span class="keywordflow">return</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%MEKE)) <span class="keyword">deallocate</span>(meke%MEKE)</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%GM_src)) <span class="keyword">deallocate</span>(meke%GM_src)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%mom_src)) <span class="keyword">deallocate</span>(meke%mom_src)</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) <span class="keyword">deallocate</span>(meke%Kh)</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Ku)) <span class="keyword">deallocate</span>(meke%Ku)</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%del2MEKE)) <span class="keyword">deallocate</span>(cs%del2MEKE)</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  <span class="keyword">deallocate</span>(meke)</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="afc39c025706ccbcab39795b56a01d15c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc39c025706ccbcab39795b56a01d15c">&#9670;&nbsp;</a></span>meke_equilibrium()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_meke::meke_equilibrium </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>SN_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb), intent(in)&#160;</td>
          <td class="paramname"><em>SN_v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>drag_rate_visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>I_mass</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates the equilibrium solutino where the source depends only on MEKE diffusivity and there is no lateral diffusion of MEKE. Results is in MEKEMEKE. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>Ocean grid.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>MEKE control structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>MEKE data.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_u</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_v</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">drag_rate_visc</td><td>Mean flow contrib. to drag rate</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">i_mass</td><td>Inverse of column mass. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l00568">568</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__MEKE_8F90_source.html#l00731">meke_lengthscales_0d()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__MEKE_8F90_source.html#l00088">step_forward_meke()</a>.</p>
<div class="fragment"><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),             <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; Ocean grid.</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),           <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; Ocean vertical grid structure.</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keywordtype">type</span>(meke_cs),                     <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; MEKE control structure.</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  <span class="keywordtype">type</span>(meke_type),                   <span class="keywordtype">pointer</span>       :: meke<span class="comment"> !&lt; MEKE data.</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>, <span class="keywordtype">intent(in)</span>    :: sn_u<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>, <span class="keywordtype">intent(in)</span>    :: sn_v<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: drag_rate_visc<span class="comment">  !&lt; Mean flow contrib. to drag rate</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: i_mass<span class="comment">  !&lt; Inverse of column mass.</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keywordtype">real</span> :: beta, sn, bottomfac2, barotrfac2, lmixscale, lrhines, leady</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="keywordtype">real</span> :: i_h, khcoeff, kh, ubg2, cd2, drag_rate, ldamping, src</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="keywordtype">real</span> :: eke, ekemin, ekemax, resid, resmin, resmax, ekeerr</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je, n1, n2</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: tolerance = 1.e-12 <span class="comment">! Width of EKE bracket in m^2 s^-2.</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">logical</span> :: usesecant, debugiteration</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  debugiteration = .false.</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  khcoeff = cs%MEKE_KhCoeff</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  ubg2 = cs%MEKE_Uscale**2</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  cd2 = cs%cdrag**2</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="comment">!SN = 0.25*max( (SN_u(I,j) + SN_u(I-1,j)) + (SN_v(i,J) + SN_v(i,J-1)), 0.)</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="comment">! This avoids extremes values in equilibrium solution due to bad values in SN_u, SN_v</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    sn = min( min(sn_u(i,j) , sn_u(i-1,j)) , min(sn_v(i,j), sn_v(i,j-1)) )</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    beta = sqrt( g%dF_dx(i,j)**2 + g%dF_dy(i,j)**2 )</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    i_h = gv%Rho0 * i_mass(i,j)</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="keywordflow">if</span> (khcoeff*sn*i_h&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;      <span class="comment">! Solve resid(E) = 0, where resid = Kh(E) * (SN)^2 - damp_rate(E) E</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      ekemin = 0.   <span class="comment">! Use the trivial root as the left bracket</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;      resmin = 0.   <span class="comment">! Need to detect direction of left residual</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      ekemax = 0.01 <span class="comment">! First guess at right bracket</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      usesecant = .false. <span class="comment">! Start using a bisection method</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">! First find right bracket for which resid&lt;0</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      resid = 1. ; n1 = 0</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      <span class="keywordflow">do</span> <span class="keywordflow">while</span> (resid&gt;0.)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        n1 = n1 + 1</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        eke = ekemax</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keyword">call </span>meke_lengthscales_0d(cs, g%areaT(i,j), beta, g%bathyT(i,j), &amp;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                                  meke%Rd_dx_h(i,j), sn, eke,            &amp;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                                  bottomfac2, barotrfac2, lmixscale,     &amp;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                                  lrhines, leady)</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="comment">! TODO: Should include resolution function in Kh</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        kh = (khcoeff * sqrt(2.*barotrfac2*eke) * lmixscale)</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        src = kh * (sn * sn)</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        drag_rate = i_h * sqrt( drag_rate_visc(i,j)**2 + cd2 * ( 2.0*bottomfac2*eke + ubg2 ) )</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        ldamping = cs%MEKE_damping + drag_rate * bottomfac2</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        resid = src - ldamping * eke</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">if</span> (debugiteration) <span class="keywordflow">then</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;          <span class="keyword">write</span>(0,*) n1, <span class="stringliteral">&#39;EKE=&#39;</span>,eke,<span class="stringliteral">&#39;resid=&#39;</span>,resid</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;EKEmin=&#39;</span>,ekemin,<span class="stringliteral">&#39;ResMin=&#39;</span>,resmin</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;src=&#39;</span>,src,<span class="stringliteral">&#39;ldamping=&#39;</span>,ldamping</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;gamma-b=&#39;</span>,bottomfac2,<span class="stringliteral">&#39;gamma-t=&#39;</span>,barotrfac2</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;drag_visc=&#39;</span>,drag_rate_visc(i,j),<span class="stringliteral">&#39;Ubg2=&#39;</span>,ubg2</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="keywordflow">if</span> (resid&gt;0.) <span class="keywordflow">then</span>    <span class="comment">! EKE is to the left of the root</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;          ekemin = eke        <span class="comment">! so we move the left bracket here</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;          ekemax = 10. * eke  <span class="comment">! and guess again for the right bracket</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;          <span class="keywordflow">if</span> (resid&lt;resmin) usesecant = .true.</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;          resmin = resid</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;          <span class="keywordflow">if</span> (ekemax &gt; 2.e17) <span class="keywordflow">then</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">if</span> (debugiteration) stop <span class="stringliteral">&#39;Something has gone very wrong&#39;</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;            debugiteration = .true.</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;            resid = 1. ; n1 = 0</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            ekemin = 0. ; resmin = 0.</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            ekemax = 0.01</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            usesecant = .false.</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! while(resid&gt;0.) searching for right bracket</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;      resmax = resid</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="comment">! Bisect the bracket</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;      n2 = 0 ; ekeerr = ekemax - ekemin</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <span class="keywordflow">do</span> <span class="keywordflow">while</span> (ekeerr&gt;tolerance)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        n2 = n2 + 1</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordflow">if</span> (usesecant) <span class="keywordflow">then</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;          eke = ekemin + (ekemax - ekemin) * (resmin / (resmin - resmax))</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;          eke = 0.5 * (ekemin + ekemax)</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        ekeerr = min( eke-ekemin, ekemax-eke )</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="comment">! TODO: Should include resolution function in Kh</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        kh = (khcoeff * sqrt(2.*barotrfac2*eke) * lmixscale)</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        src = kh * (sn * sn)</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        drag_rate = i_h * sqrt( drag_rate_visc(i,j)**2 + cd2 * ( 2.0*bottomfac2*eke + ubg2 ) )</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        ldamping = cs%MEKE_damping + drag_rate * bottomfac2</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        resid = src - ldamping * eke</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        <span class="keywordflow">if</span> (usesecant.and.resid&gt;resmin) usesecant = .false.</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keywordflow">if</span> (resid&gt;0.) <span class="keywordflow">then</span>              <span class="comment">! EKE is to the left of the root</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;          ekemin = eke                  <span class="comment">! so we move the left bracket here</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;          <span class="keywordflow">if</span> (resid&lt;resmin) usesecant = .true.</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;          resmin = resid                <span class="comment">! Save this for the secant method</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        <span class="keywordflow">elseif</span> (resid&lt;0.) <span class="keywordflow">then</span>          <span class="comment">! EKE is to the right of the root</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;          ekemax = eke                  <span class="comment">! so we move the right bracket here</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          resmax = resid                <span class="comment">! Save this for the secant method</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;          <span class="keywordflow">exit</span>                          <span class="comment">! resid=0 =&gt; EKE is exactly at the root</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <span class="keywordflow">if</span> (n2&gt;200) stop <span class="stringliteral">&#39;Failing to converge?&#39;</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! while(EKEmax-EKEmin&gt;tolerance)</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      eke = 0.</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    meke%MEKE(i,j) = eke</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_afc39c025706ccbcab39795b56a01d15c_cgraph.svg" width="488" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_afc39c025706ccbcab39795b56a01d15c_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a3541e89d2c55cbd6b77f7a256040f5b2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3541e89d2c55cbd6b77f7a256040f5b2">&#9670;&nbsp;</a></span>meke_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_meke::meke_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mom_restart_cs), pointer&#160;</td>
          <td class="paramname"><em>restart_CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes the MOM_MEKE module and reads parameters. Returns True if module is to be used, otherwise returns False. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>The current model time.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>Parameter file parser structure.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>Diagnostics structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>MEKE control structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>MEKE-related fields.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">restart_cs</td><td>Restart control structure for MOM_MEKE. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l00789">789</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00057">mom_error_handler::mom_mesg()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM_8F90_source.html#l01480">mom::initialize_mom()</a>.</p>
<div class="fragment"><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: time<span class="comment">       !&lt; The current model time.</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(inout)</span> :: g<span class="comment">          !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; Parameter file parser structure.</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">       !&lt; Diagnostics structure.</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <span class="keywordtype">type</span>(meke_cs),           <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; MEKE control structure.</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  <span class="keywordtype">type</span>(meke_type),         <span class="keywordtype">pointer</span>       :: meke<span class="comment">       !&lt; MEKE-related fields.</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keywordtype">type</span>(mom_restart_cs),    <span class="keywordtype">pointer</span>       :: restart_cs<span class="comment"> !&lt; Restart control structure for MOM_MEKE.</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">! Local variables</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, isd, ied, jsd, jed, nz</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <span class="keywordtype">logical</span> :: laplacian, usevarmix, coldstart</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_MEKE&quot;</span> <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="comment">! Determine whether this module will be used</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_MEKE&quot;</span>, meke_init, &amp;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                 <span class="stringliteral">&quot;If true, turns on the MEKE scheme which calculates\n&quot;</span>// &amp;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                 <span class="stringliteral">&quot;a sub-grid mesoscale eddy kinetic energy budget.&quot;</span>, &amp;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                 default=.false.)</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">if</span> (.not. meke_init) <span class="keywordflow">return</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke)) <span class="keywordflow">then</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">! The MEKE structure should have been allocated in MEKE_alloc_register_restart()</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MEKE_init called with NO associated &quot;</span>// &amp;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                            <span class="stringliteral">&quot;MEKE-type structure.&quot;</span>)</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;      <span class="stringliteral">&quot;MEKE_init called with an associated control structure.&quot;</span>)</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="keywordflow">else</span> ; <span class="keyword">allocate</span>(cs) ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  <span class="keyword">call </span>mom_mesg(<span class="stringliteral">&quot;MEKE_init: reading parameters &quot;</span>, 5)</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_DAMPING&quot;</span>, cs%MEKE_damping, &amp;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                 <span class="stringliteral">&quot;The local depth-indepented MEKE dissipation rate.&quot;</span>, &amp;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                 units=<span class="stringliteral">&quot;s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_CD_SCALE&quot;</span>, cs%MEKE_Cd_scale, &amp;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                 <span class="stringliteral">&quot;The ratio of the bottom eddy velocity to the column mean\n&quot;</span>//&amp;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                 <span class="stringliteral">&quot;eddy velocity, i.e. sqrt(2*MEKE). This should be less than 1\n&quot;</span>//&amp;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                 <span class="stringliteral">&quot;to account for the surface intensification of MEKE.&quot;</span>, &amp;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.)</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_CB&quot;</span>, cs%MEKE_Cb, &amp;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                 <span class="stringliteral">&quot;A coefficient in the expression for the ratio of bottom projected\n&quot;</span>//&amp;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;                 <span class="stringliteral">&quot;eddy energy and mean column energy (see Jansen et al. 2015).&quot;</span>,&amp;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=25.)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_MIN_GAMMA2&quot;</span>, cs%MEKE_min_gamma, &amp;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;                 <span class="stringliteral">&quot;The minimum allowed value of gamma_b^2.&quot;</span>,&amp;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0001)</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_CT&quot;</span>, cs%MEKE_Ct, &amp;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                 <span class="stringliteral">&quot;A coefficient in the expression for the ratio of barotropic\n&quot;</span>//&amp;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                 <span class="stringliteral">&quot;eddy energy and mean column energy (see Jansen et al. 2015).&quot;</span>,&amp;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=50.)</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_GMCOEFF&quot;</span>, cs%MEKE_GMcoeff, &amp;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                 <span class="stringliteral">&quot;The efficiency of the conversion of potential energy \n&quot;</span>//&amp;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                 <span class="stringliteral">&quot;into MEKE by the thickness mixing parameterization. \n&quot;</span>//&amp;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                 <span class="stringliteral">&quot;If MEKE_GMCOEFF is negative, this conversion is not \n&quot;</span>//&amp;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                 <span class="stringliteral">&quot;used or calculated.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-1.0)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_FRCOEFF&quot;</span>, cs%MEKE_FrCoeff, &amp;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                 <span class="stringliteral">&quot;The efficiency of the conversion of mean energy into \n&quot;</span>//&amp;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                 <span class="stringliteral">&quot;MEKE.  If MEKE_FRCOEFF is negative, this conversion \n&quot;</span>//&amp;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                 <span class="stringliteral">&quot;is not used or calculated.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=-1.0)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_BGSRC&quot;</span>, cs%MEKE_BGsrc, &amp;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;                 <span class="stringliteral">&quot;A background energy source for MEKE.&quot;</span>, units=<span class="stringliteral">&quot;W kg-1&quot;</span>, &amp;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                 default=0.0)</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_KH&quot;</span>, cs%MEKE_Kh, &amp;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                 <span class="stringliteral">&quot;A background lateral diffusivity of MEKE.\n&quot;</span>//&amp;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                 <span class="stringliteral">&quot;Use a negative value to not apply lateral diffusion to MEKE.&quot;</span>, &amp;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=-1.0)</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_K4&quot;</span>, cs%MEKE_K4, &amp;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                 <span class="stringliteral">&quot;A lateral bi-harmonic diffusivity of MEKE.\n&quot;</span>//&amp;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                 <span class="stringliteral">&quot;Use a negative value to not apply bi-harmonic diffusion to MEKE.&quot;</span>, &amp;</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                 units=<span class="stringliteral">&quot;m4 s-1&quot;</span>, default=-1.0)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_DTSCALE&quot;</span>, cs%MEKE_dtScale, &amp;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;                 <span class="stringliteral">&quot;A scaling factor to accelerate the time evolution of MEKE.&quot;</span>, &amp;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_KHCOEFF&quot;</span>, cs%MEKE_KhCoeff, &amp;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                 <span class="stringliteral">&quot;A scaling factor in the expression for eddy diffusivity\n&quot;</span>//&amp;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                 <span class="stringliteral">&quot;which is otherwise proportional to the MEKE velocity-\n&quot;</span>//&amp;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;                 <span class="stringliteral">&quot;scale times an eddy mixing-length. This factor\n&quot;</span>//&amp;</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;                 <span class="stringliteral">&quot;must be &gt;0 for MEKE to contribute to the thickness/\n&quot;</span>//&amp;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                 <span class="stringliteral">&quot;and tracer diffusivity in the rest of the model.&quot;</span>, &amp;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_USCALE&quot;</span>, cs%MEKE_Uscale, &amp;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                 <span class="stringliteral">&quot;The background velocity that is combined with MEKE to \n&quot;</span>//&amp;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                 <span class="stringliteral">&quot;calculate the bottom drag.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_VISC_DRAG&quot;</span>, cs%visc_drag, &amp;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                 <span class="stringliteral">&quot;If true, use the vertvisc_type to calculate the bottom \n&quot;</span>//&amp;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                 <span class="stringliteral">&quot;drag acting on MEKE.&quot;</span>, default=.true.)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_KHTH_FAC&quot;</span>, meke%KhTh_fac, &amp;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                 <span class="stringliteral">&quot;A factor that maps MEKE%Kh to KhTh.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                 default=0.0)</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_KHTR_FAC&quot;</span>, meke%KhTr_fac, &amp;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                 <span class="stringliteral">&quot;A factor that maps MEKE%Kh to KhTr.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                 default=0.0)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_KHMEKE_FAC&quot;</span>, cs%KhMEKE_Fac, &amp;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                 <span class="stringliteral">&quot;A factor that maps MEKE%Kh to Kh for MEKE itself.&quot;</span>, &amp;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_OLD_LSCALE&quot;</span>, cs%use_old_lscale, &amp;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                 <span class="stringliteral">&quot;If true, use the old formula for length scale which is\n&quot;</span>//&amp;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                 <span class="stringliteral">&quot;a function of grid spacing and deformation radius.&quot;</span>,  &amp;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                 default=.false.)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_RD_MAX_SCALE&quot;</span>, cs%Rd_as_max_scale, &amp;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                 <span class="stringliteral">&quot;If true, the length scale used by MEKE is the minimum of\n&quot;</span>//&amp;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                 <span class="stringliteral">&quot;the deformation radius or grid-spacing. Only used if\n&quot;</span>//&amp;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                 <span class="stringliteral">&quot;MEKE_OLD_LSCALE=True&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=.false.)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_VISCOSITY_COEFF&quot;</span>, cs%viscosity_coeff, &amp;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                 <span class="stringliteral">&quot;If non-zero, is the scaling coefficient in the expression for\n&quot;</span>//&amp;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                 <span class="stringliteral">&quot;viscosity used to parameterize lateral momentum mixing by\n&quot;</span>//&amp;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                 <span class="stringliteral">&quot;unresolved eddies represented by MEKE. Can be negative to\n&quot;</span>//&amp;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                 <span class="stringliteral">&quot;represent backscatter from the unresolved eddies.&quot;</span>, &amp;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_FIXED_MIXING_LENGTH&quot;</span>, cs%Lfixed, &amp;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                 <span class="stringliteral">&quot;If positive, is a fixed length contribution to the expression\n&quot;</span>//&amp;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                 <span class="stringliteral">&quot;for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                 units=<span class="stringliteral">&quot;m&quot;</span>, default=0.0)</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ALPHA_DEFORM&quot;</span>, cs%aDeform, &amp;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                 <span class="stringliteral">&quot;If positive, is a coefficient weighting the deformation scale\n&quot;</span>//&amp;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                 <span class="stringliteral">&quot;in the expression for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ALPHA_RHINES&quot;</span>, cs%aRhines, &amp;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                 <span class="stringliteral">&quot;If positive, is a coefficient weighting the Rhines scale\n&quot;</span>//&amp;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                 <span class="stringliteral">&quot;in the expression for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.05)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ALPHA_EADY&quot;</span>, cs%aEady, &amp;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                 <span class="stringliteral">&quot;If positive, is a coefficient weighting the Eady length scale\n&quot;</span>//&amp;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                 <span class="stringliteral">&quot;in the expression for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.05)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ALPHA_FRICT&quot;</span>, cs%aFrict, &amp;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                 <span class="stringliteral">&quot;If positive, is a coefficient weighting the frictional arrest scale\n&quot;</span>//&amp;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                 <span class="stringliteral">&quot;in the expression for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ALPHA_GRID&quot;</span>, cs%aGrid, &amp;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                 <span class="stringliteral">&quot;If positive, is a coefficient weighting the grid-spacing as a scale\n&quot;</span>//&amp;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                 <span class="stringliteral">&quot;in the expression for mixing length used in MEKE-derived diffusiviity.&quot;</span>, &amp;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_COLD_START&quot;</span>, coldstart, &amp;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                 <span class="stringliteral">&quot;If true, initialize EKE to zero. Otherwise a local equilibrium solution\n&quot;</span>//&amp;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                 <span class="stringliteral">&quot;is used as an initial condition for EKE.&quot;</span>, default=.false.)</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_BACKSCAT_RO_C&quot;</span>, meke%backscatter_Ro_c, &amp;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                 <span class="stringliteral">&quot;The coefficient in the Rossby number function for scaling the buharmonic\n&quot;</span>//&amp;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                 <span class="stringliteral">&quot;frictional energy source. Setting to non-zero enables the Rossby number function.&quot;</span>, &amp;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_BACKSCAT_RO_POW&quot;</span>, meke%backscatter_Ro_pow, &amp;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                 <span class="stringliteral">&quot;The power in the Rossby number function for scaling the biharmomnic\n&quot;</span>//&amp;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                 <span class="stringliteral">&quot;frictional energy source.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MEKE_ADVECTION_FACTOR&quot;</span>, cs%MEKE_advection_factor, &amp;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                 <span class="stringliteral">&quot;A scale factor in front of advection of eddy energy. Zero turns advection off.\n&quot;</span>//&amp;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                 <span class="stringliteral">&quot;Using unity would be normal but other values could accomodate a mismatch\n&quot;</span>//&amp;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                 <span class="stringliteral">&quot;between the advecting barotropic flow and the vertical structure of MEKE.&quot;</span>, &amp;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="comment">! Nonlocal module parameters</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CDRAG&quot;</span>, cs%cdrag, &amp;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                 <span class="stringliteral">&quot;CDRAG is the drag coefficient relating the magnitude of \n&quot;</span>//&amp;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                 <span class="stringliteral">&quot;the velocity field to the bottom stress.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                 default=0.003)</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LAPLACIAN&quot;</span>, laplacian, default=.false., do_not_log=.true.)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordflow">if</span> (cs%viscosity_coeff/=0. .and. .not. laplacian) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                 <span class="stringliteral">&quot;LAPLACIAN must be true if MEKE_VISCOSITY_COEFF is true.&quot;</span>)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_VARIABLE_MIXING&quot;</span>, usevarmix, default=.false., do_not_log=.true.)</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  <span class="keywordflow">if</span> (.not. usevarmix .and. cs%aEady&gt;0.) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                 <span class="stringliteral">&quot;USE_VARIABLE_MIXING must be true if USE_MEKE is true and MEKE_ALPHA_EADY&gt;0.&quot;</span>)</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, default=.false., do_not_log=.true.)</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="comment">! Allocation of storage NOT shared with other modules</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  <span class="keywordflow">if</span> (cs%MEKE_K4&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="keyword">allocate</span>(cs%del2MEKE(isd:ied,jsd:jed)) ; cs%del2MEKE(:,:) = 0.0</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment">! In the case of a restart, these fields need a halo update</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%MEKE)) <span class="keywordflow">then</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_MEKE, meke%MEKE, g%Domain)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_MEKE, g%Domain)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) <span class="keywordflow">then</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_Kh, meke%Kh, g%Domain)</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_Kh, g%Domain)</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Ku)) <span class="keywordflow">then</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_Ku, meke%Ku, g%Domain)</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_Ku, g%Domain)</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%del2MEKE)) <span class="keywordflow">then</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_del2MEKE, cs%del2MEKE, g%Domain)</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_del2MEKE, g%Domain)</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="comment">! Register fields for output from this module.</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  cs%id_MEKE = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;     <span class="stringliteral">&#39;Mesoscale Eddy Kinetic Energy&#39;</span>, <span class="stringliteral">&#39;meter2 second-2&#39;</span>)</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%MEKE)) cs%id_MEKE = -1</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;  cs%id_Kh = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_KH&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;     <span class="stringliteral">&#39;MEKE derived diffusivity&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%Kh)) cs%id_Kh = -1</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  cs%id_Ku = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_KU&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;     <span class="stringliteral">&#39;MEKE derived lateral viscosity&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%Ku)) cs%id_Ku = -1</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  cs%id_Ue = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Ue&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;     <span class="stringliteral">&#39;MEKE derived eddy-velocity scale&#39;</span>, <span class="stringliteral">&#39;meter second-1&#39;</span>)</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%MEKE)) cs%id_Ue = -1</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  cs%id_Ub = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Ub&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;     <span class="stringliteral">&#39;MEKE derived bottom eddy-velocity scale&#39;</span>, <span class="stringliteral">&#39;meter second-1&#39;</span>)</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%MEKE)) cs%id_Ub = -1</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  cs%id_Ut = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Ut&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;     <span class="stringliteral">&#39;MEKE derived barotropic eddy-velocity scale&#39;</span>, <span class="stringliteral">&#39;meter second-1&#39;</span>)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%MEKE)) cs%id_Ut = -1</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  cs%id_src = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_src&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;     <span class="stringliteral">&#39;MEKE energy source&#39;</span>, <span class="stringliteral">&#39;meter2 second-3&#39;</span>)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;  cs%id_decay = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_decay&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;     <span class="stringliteral">&#39;MEKE decay rate&#39;</span>, <span class="stringliteral">&#39;second-1&#39;</span>)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;  cs%id_KhMEKE_u = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KHMEKE_u&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;     <span class="stringliteral">&#39;Zonal diffusivity of MEKE&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  cs%id_KhMEKE_v = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KHMEKE_v&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;     <span class="stringliteral">&#39;Meridional diffusivity of MEKE&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  cs%id_GM_src = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_GM_src&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;     <span class="stringliteral">&#39;MEKE energy available from thickness mixing&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%GM_src)) cs%id_GM_src = -1</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;  cs%id_mom_src = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_mom_src&#39;</span>,diag%axesT1, time, &amp;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;     <span class="stringliteral">&#39;MEKE energy available from momentum&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(meke%mom_src)) cs%id_mom_src = -1</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  cs%id_Le = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Le&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;     <span class="stringliteral">&#39;Eddy mixing length used in the MEKE derived eddy diffusivity&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  cs%id_Lrhines = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Lrhines&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;     <span class="stringliteral">&#39;Rhines length scale used in the MEKE derived eddy diffusivity&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  cs%id_Leady = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_Leady&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;     <span class="stringliteral">&#39;Eady length scale used in the MEKE derived eddy diffusivity&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  cs%id_gamma_b = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_gamma_b&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;     <span class="stringliteral">&#39;Ratio of bottom-projected eddy velocity to column-mean eddy velocity&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  cs%id_gamma_t = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MEKE_gamma_t&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;     <span class="stringliteral">&#39;Ratio of barotropic eddy velocity to column-mean eddy velocity&#39;</span>, <span class="stringliteral">&#39;nondim&#39;</span>)</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;  cs%id_clock_pass = cpu_clock_id(<span class="stringliteral">&#39;(Ocean continuity halo updates)&#39;</span>, grain=clock_routine)</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;  <span class="comment">! Detect whether this instant of MEKE_init() is at the beginning of a run</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="comment">! or after a restart. If at the beginning, we will initialize MEKE to a local</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;  <span class="comment">! equilibrium.</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;  cs%initialize = .not.query_initialized(meke%MEKE,<span class="stringliteral">&quot;MEKE&quot;</span>,restart_cs)</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="keywordflow">if</span> (coldstart) cs%initialize = .false.</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;  <span class="keywordflow">if</span> (cs%initialize) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                       <span class="stringliteral">&quot;MEKE_init: Initializing MEKE with a local equilibrium balance.&quot;</span>)</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_a3541e89d2c55cbd6b77f7a256040f5b2_cgraph.svg" width="544" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_a3541e89d2c55cbd6b77f7a256040f5b2_icgraph.svg" width="491" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aa5ed096f400a914e1e318fde1e880ffe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa5ed096f400a914e1e318fde1e880ffe">&#9670;&nbsp;</a></span>meke_lengthscales()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_meke::meke_lengthscales </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>SN_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb), intent(in)&#160;</td>
          <td class="paramname"><em>SN_v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>EKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>bottomFac2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>barotrFac2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed), intent(out)&#160;</td>
          <td class="paramname"><em>LmixScale</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates the eddy mixing length scale and \(\gamma_b\) and \(\gamma_t\) functions that are ratios of either bottom or barotropic eddy energy to the column eddy energy, respectively. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>MEKE control structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>MEKE data.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>Ocean grid.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_u</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_v</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eke</td><td>Eddy kinetic energy (m2/s2).</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">bottomfac2</td><td>gamma_b^2</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">barotrfac2</td><td>gamma_t^2</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">lmixscale</td><td>Eddy mixing length (m). </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l00689">689</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__MEKE_8F90_source.html#l00731">meke_lengthscales_0d()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__MEKE_8F90_source.html#l00088">step_forward_meke()</a>.</p>
<div class="fragment"><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  <span class="keywordtype">type</span>(meke_cs),                     <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; MEKE control structure.</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  <span class="keywordtype">type</span>(meke_type),                   <span class="keywordtype">pointer</span>       :: meke<span class="comment"> !&lt; MEKE data.</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),             <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; Ocean grid.</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>, <span class="keywordtype">intent(in)</span>    :: sn_u<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>, <span class="keywordtype">intent(in)</span>    :: sn_v<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: eke<span class="comment">  !&lt; Eddy kinetic energy (m2/s2).</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(out)</span>   :: bottomfac2<span class="comment"> !&lt; gamma_b^2</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(out)</span>   :: barotrfac2<span class="comment"> !&lt; gamma_t^2</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span>,  <span class="keywordtype">intent(out)</span>   :: lmixscale<span class="comment"> !&lt; Eddy mixing length (m).</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: lrhines, leady</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <span class="keywordtype">real</span> :: beta, sn</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="keywordflow">if</span> (.not.cs%use_old_lscale) <span class="keywordflow">then</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      <span class="keywordflow">if</span> (cs%aEady &gt; 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;         sn = 0.25*( (sn_u(i,j) + sn_u(i-1,j)) + (sn_v(i,j) + sn_v(i,j-1)) )</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        sn = 0.</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;      beta = sqrt( g%dF_dx(i,j)**2 + g%dF_dy(i,j)**2 )</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="comment">! Returns bottomFac2, barotrFac2 and LmixScale</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keyword">call </span>meke_lengthscales_0d(cs, g%areaT(i,j), beta, g%bathyT(i,j),            &amp;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                              meke%Rd_dx_h(i,j), sn, meke%MEKE(i,j),            &amp;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                              bottomfac2(i,j), barotrfac2(i,j), lmixscale(i,j), &amp;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                              lrhines(i,j), leady(i,j))</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  <span class="keywordflow">if</span> (cs%id_Lrhines&gt;0) <span class="keyword">call </span>post_data(cs%id_Lrhines, lrhines, cs%diag)</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <span class="keywordflow">if</span> (cs%id_Leady&gt;0) <span class="keyword">call </span>post_data(cs%id_Leady, leady, cs%diag)</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_aa5ed096f400a914e1e318fde1e880ffe_cgraph.svg" width="500" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_aa5ed096f400a914e1e318fde1e880ffe_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a577e88a6514c7dfa9a05b1d5eff2b8c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a577e88a6514c7dfa9a05b1d5eff2b8c6">&#9670;&nbsp;</a></span>meke_lengthscales_0d()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_meke::meke_lengthscales_0d </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>area</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>beta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>Rd_dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>SN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>EKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>bottomFac2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>barotrFac2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>LmixScale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>Lrhines</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(out)&#160;</td>
          <td class="paramname"><em>Leady</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates the eddy mixing length scale and \(\gamma_b\) and \(\gamma_t\) functions that are ratios of either bottom or barotropic eddy energy to the column eddy energy, respectively. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>MEKE control structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">area</td><td>Grid cell area (m2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">beta</td><td>Planetary beta = |grad F| (s-1 m-1)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">depth</td><td>Ocean depth (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rd_dx</td><td>Resolution Ld/dx (nondim).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn</td><td>Eady growth rate (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eke</td><td>Eddy kinetic energy (m s-1).</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">bottomfac2</td><td>gamma_b^2</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">barotrfac2</td><td>gamma_t^2</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">lmixscale</td><td>Eddy mixing length (m).</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">lrhines</td><td>Rhines length scale (m).</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">leady</td><td>Eady length scale (m). </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l00731">731</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__MEKE_8F90_source.html#l00568">meke_equilibrium()</a>, and <a class="el" href="MOM__MEKE_8F90_source.html#l00689">meke_lengthscales()</a>.</p>
<div class="fragment"><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="keywordtype">type</span>(meke_cs), <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; MEKE control structure.</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: area<span class="comment">       !&lt; Grid cell area (m2)</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: beta<span class="comment">       !&lt; Planetary beta = |grad F| (s-1 m-1)</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: depth<span class="comment">      !&lt; Ocean depth (m)</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: rd_dx<span class="comment">      !&lt; Resolution Ld/dx (nondim).</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: sn<span class="comment">         !&lt; Eady growth rate (s-1).</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(in)</span>    :: eke<span class="comment">        !&lt; Eddy kinetic energy (m s-1).</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(out)</span>   :: bottomfac2<span class="comment"> !&lt; gamma_b^2</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(out)</span>   :: barotrfac2<span class="comment"> !&lt; gamma_t^2</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(out)</span>   :: lmixscale<span class="comment">  !&lt; Eddy mixing length (m).</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(out)</span>   :: lrhines<span class="comment">    !&lt; Rhines length scale (m).</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;  <span class="keywordtype">real</span>,          <span class="keywordtype">intent(out)</span>   :: leady<span class="comment">      !&lt; Eady length scale (m).</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordtype">real</span> :: lgrid, ldeform, ldeformlim, ue, lfrict</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="comment">! Length scale for MEKE derived diffusivity</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  lgrid = sqrt(area)               <span class="comment">! Grid scale</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  ldeform = lgrid * rd_dx          <span class="comment">! Deformation scale</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  lfrict = depth / cs%cdrag        <span class="comment">! Frictional arrest scale</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="comment">! gamma_b^2 is the ratio of bottom eddy energy to mean column eddy energy</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <span class="comment">! used in calculating bottom drag</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  bottomfac2 = cs%MEKE_CD_SCALE**2</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keywordflow">if</span> (lfrict*cs%MEKE_Cb&gt;0.) bottomfac2 = bottomfac2 + 1./( 1. + cs%MEKE_Cb*(ldeform/lfrict) )**0.8</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  bottomfac2 = max(bottomfac2, cs%MEKE_min_gamma)</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="comment">! gamma_t^2 is the ratio of barotropic eddy energy to mean column eddy energy</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="comment">! used in the velocity scale for diffusivity</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;  barotrfac2 = 1.</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  <span class="keywordflow">if</span> (lfrict*cs%MEKE_Ct&gt;0.) barotrfac2 = 1./( 1. + cs%MEKE_Ct*(ldeform/lfrict) )**0.25</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  barotrfac2 = max(barotrfac2, cs%MEKE_min_gamma)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="keywordflow">if</span> (cs%use_old_lscale) <span class="keywordflow">then</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="keywordflow">if</span> (cs%Rd_as_max_scale) <span class="keywordflow">then</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;      lmixscale = min(ldeform, lgrid) <span class="comment">! The smaller of Ld or dx</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      lmixscale = lgrid</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    ue = sqrt( 2.0 * max( 0., barotrfac2*eke ) ) <span class="comment">! Barotropic eddy flow scale</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    lrhines = sqrt( ue / max( beta, 1.e-30 ) )       <span class="comment">! Rhines scale</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keywordflow">if</span> (cs%aEady &gt; 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;      leady = ue / max( sn, 1.e-15 ) <span class="comment">! Bound Eady time-scale &lt; 1e15 seconds</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      leady = 0.</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    lmixscale = 0.</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="keywordflow">if</span> (cs%aDeform*ldeform &gt; 0.) lmixscale = lmixscale + 1./(cs%aDeform*ldeform)</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">if</span> (cs%aFrict *lfrict  &gt; 0.) lmixscale = lmixscale + 1./(cs%aFrict *lfrict)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordflow">if</span> (cs%aRhines*lrhines &gt; 0.) lmixscale = lmixscale + 1./(cs%aRhines*lrhines)</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordflow">if</span> (cs%aEady  *leady   &gt; 0.) lmixscale = lmixscale + 1./(cs%aEady  *leady)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordflow">if</span> (cs%aGrid  *lgrid   &gt; 0.) lmixscale = lmixscale + 1./(cs%aGrid  *lgrid)</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordflow">if</span> (cs%Lfixed          &gt; 0.) lmixscale = lmixscale + 1./cs%Lfixed</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">if</span> (lmixscale &gt; 0.) lmixscale = 1. / lmixscale</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_a577e88a6514c7dfa9a05b1d5eff2b8c6_icgraph.svg" width="100%" height="366"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="adff303c8c542ec848294078e4b3bc010"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adff303c8c542ec848294078e4b3bc010">&#9670;&nbsp;</a></span>step_forward_meke()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_meke::step_forward_meke </td>
          <td>(</td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed), intent(in)&#160;</td>
          <td class="paramname"><em>SN_u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb), intent(in)&#160;</td>
          <td class="paramname"><em>SN_v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(vertvisc_type), intent(in)&#160;</td>
          <td class="paramname"><em>visc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__meke_1_1meke__cs.html">meke_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>hu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>hv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Integrates forward-in-time the MEKE eddy energy equation. See <a class="el" href="namespacemom__meke.html#section_MEKE_equations">MEKE equations</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>MEKE data.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>Ocean grid.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness (m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_u</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">sn_v</td><td>Eady growth rate at u-points (s-1).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">visc</td><td>The vertical viscosity type.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>Model(baroclinic) time-step (s).</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>MEKE control structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hu</td><td>Zonal flux flux (m3).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hv</td><td>Meridional mass flux (m3). </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__MEKE_8F90_source.html#l00088">88</a> of file <a class="el" href="MOM__MEKE_8F90_source.html">MOM_MEKE.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__MEKE_8F90_source.html#l00568">meke_equilibrium()</a>, <a class="el" href="MOM__MEKE_8F90_source.html#l00689">meke_lengthscales()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM_8F90_source.html#l00466">mom::step_mom()</a>.</p>
<div class="fragment"><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">type</span>(meke_type),                          <span class="keywordtype">pointer</span>       :: meke<span class="comment"> !&lt; MEKE data.</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                    <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; Ocean grid.</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">   !&lt; Ocean vertical grid structure.</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">    !&lt; Layer thickness (m or kg m-2).</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: sn_u<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>,         <span class="keywordtype">intent(in)</span>    :: sn_v<span class="comment"> !&lt; Eady growth rate at u-points (s-1).</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordtype">type</span>(vertvisc_type),                      <span class="keywordtype">intent(in)</span>    :: visc<span class="comment"> !&lt; The vertical viscosity type.</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordtype">real</span>,                                     <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">   !&lt; Model(baroclinic) time-step (s).</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordtype">type</span>(meke_cs),                            <span class="keywordtype">pointer</span>       :: cs<span class="comment">   !&lt; MEKE control structure.</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: hu<span class="comment">   !&lt; Zonal flux flux (m3).</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: hv<span class="comment">   !&lt; Meridional mass flux (m3).</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    mass, &amp;         <span class="comment">! The total mass of the water column, in kg m-2.</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    i_mass, &amp;       <span class="comment">! The inverse of mass, in m2 kg-1.</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    src, &amp;          <span class="comment">! The sum of all MEKE sources, in m2 s-3.</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    meke_decay, &amp;   <span class="comment">! The MEKE decay timescale, in s-1.</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    meke_gm_src, &amp;  <span class="comment">! The MEKE source from thickness mixing, in m2 s-3.</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    meke_mom_src, &amp; <span class="comment">! The MEKE source from momentum, in m2 s-3.</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    drag_rate_visc, &amp;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    drag_rate, &amp;    <span class="comment">! The MEKE spindown timescale due to bottom drag, in s-1.</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    lmixscale, &amp;    <span class="comment">! Square of eddy mixing length, in m2.</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    barotrfac2, &amp;   <span class="comment">! Ratio of EKE_barotropic / EKE (nondim)/</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    bottomfac2      <span class="comment">! Ratio of EKE_bottom / EKE (nondim)/</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    meke_uflux, &amp;   <span class="comment">! The zonal diffusive flux of MEKE, in kg m2 s-3.</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    kh_u, &amp;         <span class="comment">! The zonal diffusivity that is actually used, in m2 s-1.</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    barohu, &amp;       <span class="comment">! Depth integrated zonal mass flux (m3).</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    drag_vel_u      <span class="comment">! A (vertical) viscosity associated with bottom drag at</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                    <span class="comment">! u-points, in m s-1.</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    meke_vflux, &amp;   <span class="comment">! The meridional diffusive flux of MEKE, in kg m2 s-3.</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    kh_v, &amp;         <span class="comment">! The meridional diffusivity that is actually used, in m2 s-1.</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    barohv, &amp;       <span class="comment">! Depth integrated meridional mass flux (m3).</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    drag_vel_v      <span class="comment">! A (vertical) viscosity associated with bottom drag at</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                    <span class="comment">! v-points, in m s-1.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordtype">real</span> :: kh_here, inv_kh_max, k4_here</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="keywordtype">real</span> :: cdrag2</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="keywordtype">real</span> :: advfac</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keywordtype">real</span> :: mass_neglect <span class="comment">! A negligible mass, in kg m-2.</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordtype">real</span> :: ldamping  <span class="comment">! The MEKE damping rate in s-1.</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordtype">real</span> :: rho0      <span class="comment">! A density used to convert mass to distance, in kg m-3.</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keywordtype">real</span> :: sdt  <span class="comment">! dt to use locally (could be scaled to accelerate)</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordtype">real</span> :: sdt_damp  <span class="comment">! dt for damping (sdt could be split).</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keywordtype">logical</span> :: use_drag_rate <span class="comment">! Flag to indicate drag_rate is finite</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;         <span class="stringliteral">&quot;MOM_MEKE: Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(meke)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;         <span class="stringliteral">&quot;MOM_MEKE: MEKE must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  rho0 = gv%H_to_kg_m2 * gv%m_to_H</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  mass_neglect = gv%H_to_kg_m2 * gv%H_subroundoff</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  sdt = dt*cs%MEKE_dtScale <span class="comment">! Scaled dt to use for time-stepping</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordflow">if</span> (cs%MEKE_damping + cs%MEKE_Cd_scale &gt; 0.0 .or. cs%MEKE_Cb&gt;0. &amp;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      .or. cs%visc_drag) <span class="keywordflow">then</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    use_drag_rate = .true.</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    use_drag_rate = .false.</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">! Only integrate the MEKE equations if MEKE is required.</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%MEKE)) <span class="keywordflow">then</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%mom_src)) <span class="keyword">call </span>hchksum(meke%mom_src, <span class="stringliteral">&#39;MEKE mom_src&#39;</span>,g%HI)</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%GM_src)) <span class="keyword">call </span>hchksum(meke%GM_src, <span class="stringliteral">&#39;MEKE GM_src&#39;</span>,g%HI)</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%MEKE)) <span class="keyword">call </span>hchksum(meke%MEKE, <span class="stringliteral">&#39;MEKE MEKE&#39;</span>,g%HI)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;MEKE SN_[uv]&quot;</span>, sn_u, sn_v, g%HI)</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;MEKE h[uv]&quot;</span>, hu, hv, g%HI, haloshift=1)</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="comment">! Why are these 3 lines repeated from above?</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    sdt = dt*cs%MEKE_dtScale <span class="comment">! Scaled dt to use for time-stepping</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    rho0 = gv%H_to_kg_m2 * gv%m_to_H</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    mass_neglect = gv%H_to_kg_m2 * gv%H_subroundoff</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    cdrag2 = cs%cdrag**2</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">! With a depth-dependent (and possibly strong) damping, it seems</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="comment">! advisable to use Strang splitting between the damping and diffusion.</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    sdt_damp = sdt ; <span class="keywordflow">if</span> (cs%MEKE_KH &gt;= 0.0 .or. cs%MEKE_K4 &gt;= 0.) sdt_damp = 0.5*sdt</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">! Calculate depth integrated mass flux if doing advection</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_advection_factor&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        barohu(i,j) = 0.</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;          barohu(i,j) = hu(i,j,k)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        barohv(i,j) = 0.</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;          barohv(i,j) = hv(i,j,k)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">!$OMP parallel default(none) shared(MEKE,CS,is,ie,js,je,nz,src,mass,G,GV,h,I_mass, &amp;</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">!$OMP                               sdt,drag_vel_u,visc,drag_vel_v,drag_rate_visc, &amp;</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">!$OMP                               drag_rate,Rho0,MEKE_decay,sdt_damp,cdrag2, &amp;</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">!$OMP                               bottomFac2) &amp;</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">!$OMP                       private(ldamping)</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_Cd_scale == 0.0 .and. .not. cs%visc_drag) <span class="keywordflow">then</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        drag_rate(i,j) = 0.</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="comment">! Calculate drag_rate_visc(i,j) which accounts for the model bottom mean flow</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordflow">if</span> (cs%visc_drag) <span class="keywordflow">then</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        drag_vel_u(i,j) = 0.0</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">if</span> ((g%mask2dCu(i,j) &gt; 0.0) .and. (visc%bbl_thick_u(i,j) &gt; 0.0)) &amp;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;          drag_vel_u(i,j) = visc%kv_bbl_u(i,j) / visc%bbl_thick_u(i,j)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        drag_vel_v(i,j) = 0.0</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">if</span> ((g%mask2dCv(i,j) &gt; 0.0) .and. (visc%bbl_thick_v(i,j) &gt; 0.0)) &amp;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;          drag_vel_v(i,j) = visc%kv_bbl_v(i,j) / visc%bbl_thick_v(i,j)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        drag_rate_visc(i,j) = (0.25*g%IareaT(i,j) * &amp;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                ((g%areaCu(i-1,j)*drag_vel_u(i-1,j) + &amp;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                  g%areaCu(i,j)*drag_vel_u(i,j)) + &amp;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                 (g%areaCv(i,j-1)*drag_vel_v(i,j-1) + &amp;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                  g%areaCv(i,j)*drag_vel_v(i,j)) ) )</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        drag_rate_visc(i,j) = 0.</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie+1 ; mass(i,j) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        mass(i,j) = mass(i,j) + g%mask2dT(i,j) * (gv%H_to_kg_m2 * h(i,j,k))</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        i_mass(i,j) = 0.0</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">if</span> (mass(i,j) &gt; 0.0) i_mass(i,j) = 1.0 / mass(i,j)</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> (cs%initialize) <span class="keywordflow">then</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      <span class="keyword">call </span>meke_equilibrium(cs, meke, g, gv, sn_u, sn_v, drag_rate_visc, i_mass)</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      cs%initialize = .false.</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">! Calculates bottomFac2, barotrFac2 and LmixScale</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keyword">call </span>meke_lengthscales(cs, meke, g, sn_u, sn_v, meke%MEKE, bottomfac2, barotrfac2, lmixscale)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;      <span class="keyword">call </span>uvchksum(<span class="stringliteral">&quot;MEKE drag_vel_[uv]&quot;</span>, drag_vel_u, drag_vel_v, g%HI)</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;      <span class="keyword">call </span>hchksum(mass, <span class="stringliteral">&#39;MEKE mass&#39;</span>,g%HI,haloshift=1)</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      <span class="keyword">call </span>hchksum(drag_rate_visc, <span class="stringliteral">&#39;MEKE drag_rate_visc&#39;</span>,g%HI)</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      <span class="keyword">call </span>hchksum(bottomfac2, <span class="stringliteral">&#39;MEKE bottomFac2&#39;</span>,g%HI)</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;      <span class="keyword">call </span>hchksum(barotrfac2, <span class="stringliteral">&#39;MEKE barotrFac2&#39;</span>,g%HI)</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;      <span class="keyword">call </span>hchksum(lmixscale, <span class="stringliteral">&#39;MEKE LmixScale&#39;</span>,g%HI)</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">!$OMP parallel default(none) shared(MEKE,CS,is,ie,js,je,nz,src,mass,G,h,I_mass, &amp;</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">!$OMP                               sdt,drag_vel_u,visc,drag_vel_v,drag_rate_visc, &amp;</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">!$OMP                               drag_rate,Rho0,MEKE_decay,sdt_damp,cdrag2, &amp;</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">!$OMP                               bottomFac2,barotrFac2,use_drag_rate) &amp;</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">!$OMP                       private(ldamping)</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">! Aggregate sources of MEKE (background, frictional and GM)</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      src(i,j) = cs%MEKE_BGsrc</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%mom_src)) <span class="keywordflow">then</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        src(i,j) = src(i,j) - cs%MEKE_FrCoeff*i_mass(i,j)*meke%mom_src(i,j)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%GM_src)) <span class="keywordflow">then</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        src(i,j) = src(i,j) - cs%MEKE_GMcoeff*i_mass(i,j)*meke%GM_src(i,j)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="comment">! Increase EKE by a full time-steps worth of source</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      meke%MEKE(i,j) = (meke%MEKE(i,j) + sdt*src(i,j) )*g%mask2dT(i,j)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    <span class="keywordflow">if</span> (use_drag_rate) <span class="keywordflow">then</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      <span class="comment">! Calculate a viscous drag rate (includes BBL contributions from mean flow and eddies)</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        drag_rate(i,j) = (rho0 * i_mass(i,j)) * sqrt( drag_rate_visc(i,j)**2 &amp;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;             + cdrag2 * ( max(0.0, 2.0*bottomfac2(i,j)*meke%MEKE(i,j)) + cs%MEKE_Uscale**2 ) )</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="comment">! First stage of Strang splitting</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      ldamping = cs%MEKE_damping + drag_rate(i,j) * bottomfac2(i,j)</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;      <span class="keywordflow">if</span> (meke%MEKE(i,j)&lt;0.) ldamping = 0.</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;      <span class="comment">! notice that the above line ensures a damping only if MEKE is positive,</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;      <span class="comment">! while leaving MEKE unchanged if it is negative</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      meke%MEKE(i,j) =  meke%MEKE(i,j) / (1.0 + sdt_damp*ldamping)</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      meke_decay(i,j) = ldamping*g%mask2dT(i,j)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_KH &gt;= 0.0 .or. cs%KhMEKE_FAC &gt; 0.0 .or. cs%MEKE_K4 &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      <span class="comment">! Update halos for lateral or bi-harmonic diffusion</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_pass)</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_MEKE, g%Domain)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      <span class="keyword">call </span>cpu_clock_end(cs%id_clock_pass)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_K4 &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;      <span class="comment">! Calculate Laplacian of MEKE</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,MEKE_uflux,G,MEKE,MEKE_vflux,CS)</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        meke_uflux(i,j) = ((g%dy_Cu(i,j)*g%IdxCu(i,j)) * g%mask2dCu(i,j)) * &amp;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            (meke%MEKE(i+1,j) - meke%MEKE(i,j))</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;      <span class="comment">! MEKE_uflux(I,j) = ((G%dy_Cu(I,j)*G%IdxCu(I,j)) * &amp;</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;      <span class="comment">!     ((2.0*mass(i,j)*mass(i+1,j)) / ((mass(i,j)+mass(i+1,j)) + mass_neglect)) ) * &amp;</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;      <span class="comment">!     (MEKE%MEKE(i+1,j) - MEKE%MEKE(i,j))</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        meke_vflux(i,j) = ((g%dx_Cv(i,j)*g%IdyCv(i,j)) * g%mask2dCv(i,j)) * &amp;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            (meke%MEKE(i,j+1) - meke%MEKE(i,j))</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;      <span class="comment">! MEKE_vflux(i,J) = ((G%dx_Cv(i,J)*G%IdyCv(i,J)) * &amp;</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      <span class="comment">!     ((2.0*mass(i,j)*mass(i,j+1)) / ((mass(i,j)+mass(i,j+1)) + mass_neglect)) ) * &amp;</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <span class="comment">!     (MEKE%MEKE(i,j+1) - MEKE%MEKE(i,j))</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        cs%del2MEKE(i,j) = g%IareaT(i,j) * &amp;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;            ((meke_uflux(i,j) - meke_uflux(i-1,j)) + (meke_vflux(i,j) - meke_vflux(i,j-1)))</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <span class="comment">! CS%del2MEKE(i,j) = (G%IareaT(i,j)*I_mass(i,j)) * &amp;</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="comment">!     ((MEKE_uflux(I,j) - MEKE_uflux(I-1,j)) + (MEKE_vflux(i,J) - MEKE_vflux(i,J-1)))</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_pass)</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_del2MEKE, g%Domain)</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      <span class="keyword">call </span>cpu_clock_end(cs%id_clock_pass)</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      <span class="comment">! Bi-harmonic diffusion of MEKE</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,MEKE_uflux,G,CS,sdt,mass, &amp;</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">!$OMP                               mass_neglect,MEKE_vflux,I_mass)       &amp;</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">!$OMP                       private(K4_here,Inv_Kh_max)</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        k4_here = cs%MEKE_K4</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="comment">! Limit Kh to avoid CFL violations.</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        inv_kh_max = 64.0*sdt * (((g%dy_Cu(i,j)*g%IdxCu(i,j)) * &amp;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                     max(g%IareaT(i,j),g%IareaT(i+1,j))))**2.0</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="keywordflow">if</span> (k4_here*inv_kh_max &gt; 0.3) k4_here = 0.3 / inv_kh_max</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        meke_uflux(i,j) = ((k4_here * (g%dy_Cu(i,j)*g%IdxCu(i,j))) * &amp;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            ((2.0*mass(i,j)*mass(i+1,j)) / ((mass(i,j)+mass(i+1,j)) + mass_neglect)) ) * &amp;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            (cs%del2MEKE(i+1,j) - cs%del2MEKE(i,j))</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        k4_here = cs%MEKE_K4</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        inv_kh_max = 64.0*sdt * (((g%dx_Cv(i,j)*g%IdyCv(i,j)) * &amp;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                     max(g%IareaT(i,j),g%IareaT(i,j+1))))**2.0</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">if</span> (k4_here*inv_kh_max &gt; 0.3) k4_here = 0.3 / inv_kh_max</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        meke_vflux(i,j) = ((k4_here * (g%dx_Cv(i,j)*g%IdyCv(i,j))) * &amp;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            ((2.0*mass(i,j)*mass(i,j+1)) / ((mass(i,j)+mass(i,j+1)) + mass_neglect)) ) * &amp;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            (cs%del2MEKE(i,j+1) - cs%del2MEKE(i,j))</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      <span class="comment">! Store tendency of bi-harmonic in del2MEKE</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        cs%del2MEKE(i,j) = (sdt*(g%IareaT(i,j)*i_mass(i,j))) * &amp;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            ((meke_uflux(i-1,j) - meke_uflux(i,j)) + &amp;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;             (meke_vflux(i,j-1) - meke_vflux(i,j)))</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">!</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,MEKE,CS,sdt,G,Kh_u,MEKE_uflux, &amp;</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">!$OMP                               mass,mass_neglect,Kh_v,MEKE_vflux,I_mass, &amp;</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">!$OMP                               sdt_damp,drag_rate,Rho0,drag_rate_visc,   &amp;</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">!$OMP                               cdrag2,bottomFac2,MEKE_decay,barotrFac2,  &amp;</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">!$OMP                               use_drag_rate,dt,baroHu,baroHv) &amp;</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">!$OMP                       private(Kh_here,Inv_Kh_max,ldamping,advFac)</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_KH &gt;= 0.0 .or. cs%KhMEKE_FAC &gt; 0.0 .or. cs%MEKE_advection_factor &gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      <span class="comment">! Lateral diffusion of MEKE</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;      kh_here = max(0.,cs%MEKE_Kh)</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        <span class="comment">! Limit Kh to avoid CFL violations.</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) &amp;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;          kh_here = max(0.,cs%MEKE_Kh) + cs%KhMEKE_Fac*0.5*(meke%Kh(i,j)+meke%Kh(i+1,j))</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        inv_kh_max = 2.0*sdt * ((g%dy_Cu(i,j)*g%IdxCu(i,j)) * &amp;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                     max(g%IareaT(i,j),g%IareaT(i+1,j)))</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="keywordflow">if</span> (kh_here*inv_kh_max &gt; 0.25) kh_here = 0.25 / inv_kh_max</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        kh_u(i,j) = kh_here</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        meke_uflux(i,j) = ((kh_here * (g%dy_Cu(i,j)*g%IdxCu(i,j))) * &amp;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            ((2.0*mass(i,j)*mass(i+1,j)) / ((mass(i,j)+mass(i+1,j)) + mass_neglect)) ) * &amp;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            (meke%MEKE(i,j) - meke%MEKE(i+1,j))</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) &amp;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;          kh_here = max(0.,cs%MEKE_Kh) + cs%KhMEKE_Fac*0.5*(meke%Kh(i,j)+meke%Kh(i,j+1))</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        inv_kh_max = 2.0*sdt * ((g%dx_Cv(i,j)*g%IdyCv(i,j)) * &amp;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                     max(g%IareaT(i,j),g%IareaT(i,j+1)))</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordflow">if</span> (kh_here*inv_kh_max &gt; 0.25) kh_here = 0.25 / inv_kh_max</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        kh_v(i,j) = kh_here</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        meke_vflux(i,j) = ((kh_here * (g%dx_Cv(i,j)*g%IdyCv(i,j))) * &amp;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;            ((2.0*mass(i,j)*mass(i,j+1)) / ((mass(i,j)+mass(i,j+1)) + mass_neglect)) ) * &amp;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;            (meke%MEKE(i,j) - meke%MEKE(i,j+1))</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      <span class="keywordflow">if</span> (cs%MEKE_advection_factor&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        advfac = cs%MEKE_advection_factor / dt</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;          <span class="keywordflow">if</span> (barohu(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            meke_uflux(i,j) = meke_uflux(i,j) + barohu(i,j)*meke%MEKE(i,j)*advfac</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          <span class="keywordflow">elseif</span> (barohu(i,j)&lt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            meke_uflux(i,j) = meke_uflux(i,j) + barohu(i,j)*meke%MEKE(i+1,j)*advfac</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;          <span class="keywordflow">if</span> (barohv(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            meke_vflux(i,j) = meke_vflux(i,j) + barohv(i,j)*meke%MEKE(i,j)*advfac</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;          <span class="keywordflow">elseif</span> (barohv(i,j)&lt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            meke_vflux(i,j) = meke_vflux(i,j) + barohv(i,j)*meke%MEKE(i,j+1)*advfac</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        meke%MEKE(i,j) = meke%MEKE(i,j) + (sdt*(g%IareaT(i,j)*i_mass(i,j))) * &amp;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            ((meke_uflux(i-1,j) - meke_uflux(i,j)) + &amp;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;             (meke_vflux(i,j-1) - meke_vflux(i,j)))</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! MEKE_KH&gt;0</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="comment">! Add on bi-harmonic tendency</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_K4 &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        meke%MEKE(i,j) = meke%MEKE(i,j) + cs%del2MEKE(i,j)</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">! Second stage of Strang splitting</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_KH &gt;= 0.0 .or. cs%MEKE_K4 &gt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      <span class="keywordflow">if</span> (sdt&gt;sdt_damp) <span class="keywordflow">then</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="comment">! Recalculate the drag rate, since MEKE has changed.</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        <span class="keywordflow">if</span> (use_drag_rate) <span class="keywordflow">then</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;          <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            drag_rate(i,j) = (rho0 * i_mass(i,j)) * sqrt( drag_rate_visc(i,j)**2 &amp;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                 + cdrag2 * ( max(0.0, 2.0*bottomfac2(i,j)*meke%MEKE(i,j)) + cs%MEKE_Uscale**2 ) )</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;          ldamping = cs%MEKE_damping + drag_rate(i,j) * bottomfac2(i,j)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;          <span class="keywordflow">if</span> (meke%MEKE(i,j)&lt;0.) ldamping = 0.</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;          <span class="comment">! notice that the above line ensures a damping only if MEKE is positive,</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;          <span class="comment">! while leaving MEKE unchanged if it is negative</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;          meke%MEKE(i,j) =  meke%MEKE(i,j) / (1.0 + sdt_damp*ldamping)</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;          meke_decay(i,j) = 0.5 * g%mask2dT(i,j) * (meke_decay(i,j) + ldamping)</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! MEKE_KH&gt;=0</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_pass)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_MEKE, g%Domain)</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keyword">call </span>cpu_clock_end(cs%id_clock_pass)</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">! Calculate diffusivity for main model to use</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">if</span> (cs%MEKE_KhCoeff&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      <span class="keywordflow">if</span> (cs%use_old_lscale) <span class="keywordflow">then</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="keywordflow">if</span> (cs%Rd_as_max_scale) <span class="keywordflow">then</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,MEKE,CS,G,barotrFac2)</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;          <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;            meke%Kh(i,j) = (cs%MEKE_KhCoeff &amp;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                         * sqrt(2.*max(0.,barotrfac2(i,j)*meke%MEKE(i,j))*g%areaT(i,j))) &amp;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                         * min(meke%Rd_dx_h(i,j), 1.0)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,MEKE,CS,G,barotrFac2)</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;          <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;            meke%Kh(i,j) = cs%MEKE_KhCoeff*sqrt(2.*max(0.,barotrfac2(i,j)*meke%MEKE(i,j))*g%areaT(i,j))</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,MEKE,LmixScale,CS,G,barotrFac2)</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;          meke%Kh(i,j) = (cs%MEKE_KhCoeff*sqrt(2.*max(0.,barotrfac2(i,j)*meke%MEKE(i,j)))*lmixscale(i,j))</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_pass)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_Kh, g%Domain)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="keyword">call </span>cpu_clock_end(cs%id_clock_pass)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="comment">! Calculate viscosity for the main model to use</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordflow">if</span> (cs%viscosity_coeff/=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">!aja: should make range jsq:jeq, isq:ieq</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        meke%Ku(i,j) = cs%viscosity_coeff*sqrt(2.*max(0.,meke%MEKE(i,j)))*lmixscale(i,j)</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(cs%id_clock_pass)</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_Ku, g%Domain)</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      <span class="keyword">call </span>cpu_clock_end(cs%id_clock_pass)</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">! Offer fields for averaging.</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="keywordflow">if</span> (cs%id_MEKE&gt;0) <span class="keyword">call </span>post_data(cs%id_MEKE, meke%MEKE, cs%diag)</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">if</span> (cs%id_Ue&gt;0) <span class="keyword">call </span>post_data(cs%id_Ue, sqrt(max(0.,2.0*meke%MEKE)), cs%diag)</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="keywordflow">if</span> (cs%id_Ub&gt;0) <span class="keyword">call </span>post_data(cs%id_Ub, sqrt(max(0.,2.0*meke%MEKE*bottomfac2)), cs%diag)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordflow">if</span> (cs%id_Ut&gt;0) <span class="keyword">call </span>post_data(cs%id_Ut, sqrt(max(0.,2.0*meke%MEKE*barotrfac2)), cs%diag)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">if</span> (cs%id_Kh&gt;0) <span class="keyword">call </span>post_data(cs%id_Kh, meke%Kh, cs%diag)</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordflow">if</span> (cs%id_Ku&gt;0) <span class="keyword">call </span>post_data(cs%id_Ku, meke%Ku, cs%diag)</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordflow">if</span> (cs%id_KhMEKE_u&gt;0) <span class="keyword">call </span>post_data(cs%id_KhMEKE_u, kh_u, cs%diag)</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">if</span> (cs%id_KhMEKE_v&gt;0) <span class="keyword">call </span>post_data(cs%id_KhMEKE_v, kh_v, cs%diag)</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> (cs%id_src&gt;0) <span class="keyword">call </span>post_data(cs%id_src, src, cs%diag)</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="keywordflow">if</span> (cs%id_decay&gt;0) <span class="keyword">call </span>post_data(cs%id_decay, meke_decay, cs%diag)</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keywordflow">if</span> (cs%id_GM_src&gt;0) <span class="keyword">call </span>post_data(cs%id_GM_src, meke%GM_src, cs%diag)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">if</span> (cs%id_mom_src&gt;0) <span class="keyword">call </span>post_data(cs%id_mom_src, meke%mom_src, cs%diag)</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">if</span> (cs%id_Le&gt;0) <span class="keyword">call </span>post_data(cs%id_Le, lmixscale, cs%diag)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordflow">if</span> (cs%id_gamma_b&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        bottomfac2(i,j) = sqrt(bottomfac2(i,j))</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      <span class="keyword">call </span>post_data(cs%id_gamma_b, bottomfac2, cs%diag)</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keywordflow">if</span> (cs%id_gamma_t&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        barotrfac2(i,j) = sqrt(barotrfac2(i,j))</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <span class="keyword">call </span>post_data(cs%id_gamma_t, barotrfac2, cs%diag)</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment">! else ! if MEKE%MEKE</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">!   call MOM_error(FATAL, &quot;MOM_MEKE: MEKE%MEKE is not associated!&quot;)</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_adff303c8c542ec848294078e4b3bc010_cgraph.svg" width="100%" height="416"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__meke_adff303c8c542ec848294078e4b3bc010_icgraph.svg" width="526" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__meke.html">mom_meke</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
