<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_hor_visc Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__hor__visc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_hor_visc Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__hor__visc_1_1hor__visc__cs.html">hor_visc_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a9f553282bddb798335a3c7aa8f49bd76"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__hor__visc.html#a9f553282bddb798335a3c7aa8f49bd76">horizontal_viscosity</a> (u, v, h, diffu, diffv, MEKE, VarMix, G, GV, CS, OBC)</td></tr>
<tr class="memdesc:a9f553282bddb798335a3c7aa8f49bd76"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine determines the acceleration due to the horizontal viscosity. A combination of biharmonic and Laplacian forms can be used. The coefficient may either be a constant or a shear-dependent form. The biharmonic is determined by twice taking the divergence of an appropriately defined stress tensor. The Laplacian is determined by doing so once. To work, the following fields must be set outside of the usual is to ie range before this subroutine is called: v[is-2,is-1,ie+1,ie+2], u[is-2,is-1,ie+1,ie+2], and h[is-1,ie+1], with a similarly sized halo in the y-direction.  <a href="#a9f553282bddb798335a3c7aa8f49bd76">More...</a><br /></td></tr>
<tr class="separator:a9f553282bddb798335a3c7aa8f49bd76"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15121289da182e9ecb4561f10de335a5"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__hor__visc.html#a15121289da182e9ecb4561f10de335a5">hor_visc_init</a> (Time, G, param_file, diag, CS)</td></tr>
<tr class="memdesc:a15121289da182e9ecb4561f10de335a5"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine allocates space for and calculates static variables used by this module. The metrics may be 0, 1, or 2-D arrays, while fields like the background viscosities are 2-D arrays. ALLOC is a macro defined in <a class="el" href="MOM__memory_8h.html" title="Compile-time memory settings. ">MOM_memory.h</a> to either allocate for dynamic memory, or do nothing when using static memory.  <a href="#a15121289da182e9ecb4561f10de335a5">More...</a><br /></td></tr>
<tr class="separator:a15121289da182e9ecb4561f10de335a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a677ff53dc44cfbf175d9d02627aa92fd"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__hor__visc.html#a677ff53dc44cfbf175d9d02627aa92fd">hor_visc_end</a> (CS)</td></tr>
<tr class="separator:a677ff53dc44cfbf175d9d02627aa92fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a677ff53dc44cfbf175d9d02627aa92fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a677ff53dc44cfbf175d9d02627aa92fd">&#9670;&nbsp;</a></span>hor_visc_end()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_hor_visc::hor_visc_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__hor__visc_1_1hor__visc__cs.html">hor_visc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__hor__visc_8F90_source.html#l01575">1575</a> of file <a class="el" href="MOM__hor__visc_8F90_source.html">MOM_hor_visc.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;<span class="comment">! This subroutine deallocates any variables allocated in hor_visc_init.</span></div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;<span class="comment">! Argument:  CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;<span class="comment">!                 hor_visc_init.</span></div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  <span class="keywordtype">type</span>(hor_visc_cs), <span class="keywordtype">pointer</span> :: cs</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian .or. cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    dealloc_(cs%dx2h) ; dealloc_(cs%dx2q) ; dealloc_(cs%dy2h) ; dealloc_(cs%dy2q)</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    dealloc_(cs%dx_dyT) ; dealloc_(cs%dy_dxT) ; dealloc_(cs%dx_dyBu) ; dealloc_(cs%dy_dxBu)</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    dealloc_(cs%reduction_xx) ; dealloc_(cs%reduction_xy)</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    dealloc_(cs%Kh_bg_xx) ; dealloc_(cs%Kh_bg_xy)</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    <span class="keywordflow">if</span> (cs%bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;      dealloc_(cs%Kh_Max_xx) ; dealloc_(cs%Kh_Max_xy)</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;      dealloc_(cs%Laplac_Const_xx) ; dealloc_(cs%Laplac_Const_xy)</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;      dealloc_(cs%Laplac3_Const_xx) ; dealloc_(cs%Laplac3_Const_xy)</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;    dealloc_(cs%Idx2dyCu) ; dealloc_(cs%Idx2dyCv)</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    dealloc_(cs%Idxdy2u) ; dealloc_(cs%Idxdy2v)</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;    dealloc_(cs%Ah_bg_xx) ; dealloc_(cs%Ah_bg_xy)</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;    <span class="keywordflow">if</span> (cs%bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;      dealloc_(cs%Ah_Max_xx) ; dealloc_(cs%Ah_Max_xy)</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;      dealloc_(cs%Biharm_Const_xx) ; dealloc_(cs%Biharm_Const_xy)</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        dealloc_(cs%Biharm_Const2_xx) ; dealloc_(cs%Biharm_Const2_xy)</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;      dealloc_(cs%Biharm5_Const_xx) ; dealloc_(cs%Biharm5_Const_xy)</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;  <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a15121289da182e9ecb4561f10de335a5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a15121289da182e9ecb4561f10de335a5">&#9670;&nbsp;</a></span>hor_visc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_hor_visc::hor_visc_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__hor__visc_1_1hor__visc__cs.html">hor_visc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine allocates space for and calculates static variables used by this module. The metrics may be 0, 1, or 2-D arrays, while fields like the background viscosities are 2-D arrays. ALLOC is a macro defined in <a class="el" href="MOM__memory_8h.html" title="Compile-time memory settings. ">MOM_memory.h</a> to either allocate for dynamic memory, or do nothing when using static memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>structure to regulate diagnostic output.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>pointer to the control structure for this module </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__hor__visc_8F90_source.html#l00995">995</a> of file <a class="el" href="MOM__hor__visc_8F90_source.html">MOM_hor_visc.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordtype">type</span>(time_type),         <span class="keywordtype">intent(in)</span>    :: time<span class="comment"> !&lt; current model time.</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),   <span class="keywordtype">intent(inout)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <span class="keywordtype">type</span>(param_file_type),   <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="comment">                                                 !! parameters.</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: diag<span class="comment"> !&lt; structure to regulate diagnostic output.</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  <span class="keywordtype">type</span>(hor_visc_cs), <span class="keywordtype">pointer</span>             :: cs<span class="comment">   !&lt; pointer to the control structure for this module</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="comment">! This subroutine allocates space for and calculates static variables</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="comment">! used by this module. The metrics may be 0, 1, or 2-D arrays,</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="comment">! while fields like the background viscosities are 2-D arrays.</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="comment">! ALLOC is a macro defined in MOM_memory.h to either allocate</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="comment">! for dynamic memory, or do nothing when using static memory.</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="comment">!  (in)      Time       - current model time</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">!  (in)      G          - ocean grid structure</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">!  (in)      param_file - structure to parse for model parameter values</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="comment">!  (in)      diag       - structure to regulate diagnostic output</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="comment">!  (in/out)  CS         - pointer to the control structure for this module</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: u0u, u0v</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: v0u, v0v</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                <span class="comment">! u0v is the Laplacian sensitivities to the v velocities</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                <span class="comment">! at u points, in m-2, with u0u, v0u, and v0v defined similarly.</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  <span class="keywordtype">real</span> :: grid_sp_h2       <span class="comment">! Harmonic mean of the squares of the grid</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  <span class="keywordtype">real</span> :: grid_sp_h3       <span class="comment">! Harmonic mean of the squares of the grid^(3/2)</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;  <span class="keywordtype">real</span> :: grid_sp_q2       <span class="comment">! spacings at h and q points (m2)</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;  <span class="keywordtype">real</span> :: grid_sp_q3       <span class="comment">! spacings at h and q points^(3/2) (m3)</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;  <span class="keywordtype">real</span> :: kh_limit         <span class="comment">! A coefficient (1/s) used, along with the</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                           <span class="comment">! grid spacing, to limit Laplacian viscosity.</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;  <span class="keywordtype">real</span> :: fmax             <span class="comment">! maximum absolute value of f at the four</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                           <span class="comment">! vorticity points around a thickness point (1/s)</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;  <span class="keywordtype">real</span> :: boundcorconst    <span class="comment">! constant (s2/m2)</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;  <span class="keywordtype">real</span> :: ah_limit         <span class="comment">! coefficient (1/s) used, along with the</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                           <span class="comment">! grid spacing, to limit biharmonic viscosity</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;  <span class="keywordtype">real</span> :: kh               <span class="comment">! Lapacian horizontal viscosity (m2/s)</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;  <span class="keywordtype">real</span> :: ah               <span class="comment">! biharmonic horizontal viscosity (m4/s)</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="keywordtype">real</span> :: kh_vel_scale     <span class="comment">! this speed (m/s) times grid spacing gives Lap visc</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;  <span class="keywordtype">real</span> :: ah_vel_scale     <span class="comment">! this speed (m/s) times grid spacing cubed gives bih visc</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;  <span class="keywordtype">real</span> :: smag_lap_const   <span class="comment">! nondimensional Laplacian Smagorinsky constant</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;  <span class="keywordtype">real</span> :: smag_bi_const    <span class="comment">! nondimensional biharmonic Smagorinsky constant</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;  <span class="keywordtype">real</span> :: leith_lap_const  <span class="comment">! nondimensional Laplacian Leith constant</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="keywordtype">real</span> :: leith_bi_const   <span class="comment">! nondimensional biharmonic Leith constant</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;  <span class="keywordtype">real</span> :: dt               <span class="comment">! dynamics time step (sec)</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;  <span class="keywordtype">real</span> :: idt              <span class="comment">! inverse of dt (1/s)</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="keywordtype">real</span> :: denom            <span class="comment">! work variable; the denominator of a fraction</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordtype">real</span> :: maxvel           <span class="comment">! largest permitted velocity components (m/s)</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;  <span class="keywordtype">real</span> :: bound_cor_vel    <span class="comment">! grid-scale velocity variations at which value</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                           <span class="comment">! the quadratically varying biharmonic viscosity</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                           <span class="comment">! balances Coriolis acceleration (m/s)</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="keywordtype">logical</span> :: bound_cor_def <span class="comment">! parameter setting of BOUND_CORIOLIS</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordtype">logical</span> :: get_all       <span class="comment">! If true, read and log all parameters, regardless of</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                           <span class="comment">! whether they are used, to enable spell-checking of</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                           <span class="comment">! valid parameters.</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordtype">character(len=64)</span> :: inputdir, filename</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, isdb, iedb, jsdb, jedb</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;  <span class="keywordtype">integer</span> :: i, j</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_hor_visc&quot;</span>  <span class="comment">! module name</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  is   = g%isc  ; ie   = g%iec  ; js   = g%jsc  ; je   = g%jec ; nz = g%ke</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  isq  = g%IscB ; ieq  = g%IecB ; jsq  = g%JscB ; jeq  = g%JecB</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  isd  = g%isd  ; ied  = g%ied  ; jsd  = g%jsd  ; jed  = g%jed</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  isdb = g%IsdB ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;hor_visc_init called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                            <span class="stringliteral">&quot;control structure.&quot;</span>)</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  <span class="comment">! Read parameters and write them to the model log.</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="comment">!   It is not clear whether these initialization lines are needed for the</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="comment">! cases where the corresponding parameters are not read.</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;  cs%bound_Kh = .false. ; cs%better_bound_Kh = .false. ; cs%Smagorinsky_Kh = .false. ; cs%Leith_Kh = .false.</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  cs%bound_Ah = .false. ; cs%better_bound_Ah = .false. ; cs%Smagorinsky_Ah = .false. ; cs%Leith_Ah = .false.</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  cs%bound_Coriolis = .false.</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  cs%Modified_Leith = .false.</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;  kh = 0.0 ; ah = 0.0</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;  <span class="comment">!   If GET_ALL_PARAMS is true, all parameters are read in all cases to enable</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;  <span class="comment">! parameter spelling checks.</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;GET_ALL_PARAMS&quot;</span>, get_all, default=.false.)</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LAPLACIAN&quot;</span>, cs%Laplacian, &amp;</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                 <span class="stringliteral">&quot;If true, use a Laplacian horizontal viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                 default=.false.)</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KH&quot;</span>, kh,                      &amp;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                 <span class="stringliteral">&quot;The background Laplacian horizontal viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                 units = <span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KH_BG_MIN&quot;</span>, cs%Kh_bg_min, &amp;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                 <span class="stringliteral">&quot;The minimum value allowed for Laplacian horizontal viscosity, KH.&quot;</span>, &amp;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                 units = <span class="stringliteral">&quot;m2 s-1&quot;</span>,  default=0.0)</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KH_VEL_SCALE&quot;</span>, kh_vel_scale, &amp;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                 <span class="stringliteral">&quot;The velocity scale which is multiplied by the grid \n&quot;</span>//&amp;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                 <span class="stringliteral">&quot;spacing to calculate the Laplacian viscosity. \n&quot;</span>//&amp;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                 <span class="stringliteral">&quot;The final viscosity is the largest of this scaled \n&quot;</span>//&amp;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                 <span class="stringliteral">&quot;viscosity, the Smagorinsky and Leith viscosities, and KH.&quot;</span>, &amp;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SMAGORINSKY_KH&quot;</span>, cs%Smagorinsky_Kh, &amp;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                 <span class="stringliteral">&quot;If true, use a Smagorinsky nonlinear eddy viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                 default=.false.)</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Kh .or. get_all) &amp;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SMAG_LAP_CONST&quot;</span>, smag_lap_const, &amp;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                 <span class="stringliteral">&quot;The nondimensional Laplacian Smagorinsky constant, \n&quot;</span>//&amp;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                 <span class="stringliteral">&quot;often 0.15.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0, &amp;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                  fail_if_missing = cs%Smagorinsky_Kh)</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEITH_KH&quot;</span>, cs%Leith_Kh, &amp;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                 <span class="stringliteral">&quot;If true, use a Leith nonlinear eddy viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                 default=.false.)</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MODIFIED_LEITH&quot;</span>, cs%Modified_Leith, &amp;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                 <span class="stringliteral">&quot;If true, add a term to Leith viscosity which is \n&quot;</span>//&amp;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                 <span class="stringliteral">&quot;proportional to the gradient of divergence.&quot;</span>, &amp;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                 default=.false.)</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Kh .or. get_all) &amp;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEITH_LAP_CONST&quot;</span>, leith_lap_const, &amp;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                 <span class="stringliteral">&quot;The nondimensional Laplacian Leith constant, \n&quot;</span>//&amp;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                 <span class="stringliteral">&quot;often ??&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0, &amp;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                  fail_if_missing = cs%Leith_Kh)</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOUND_KH&quot;</span>, cs%bound_Kh, &amp;</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                 <span class="stringliteral">&quot;If true, the Laplacian coefficient is locally limited \n&quot;</span>//&amp;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;                 <span class="stringliteral">&quot;to be stable.&quot;</span>, default=.true.)</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BETTER_BOUND_KH&quot;</span>, cs%better_bound_Kh, &amp;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                 <span class="stringliteral">&quot;If true, the Laplacian coefficient is locally limited \n&quot;</span>//&amp;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                 <span class="stringliteral">&quot;to be stable with a better bounding than just BOUND_KH.&quot;</span>, &amp;</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;                 default=cs%bound_Kh)</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BIHARMONIC&quot;</span>, cs%biharmonic, &amp;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;                 <span class="stringliteral">&quot;If true, use a biharmonic horizontal viscosity. \n&quot;</span>//&amp;</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;                 <span class="stringliteral">&quot;BIHARMONIC may be used with LAPLACIAN.&quot;</span>, &amp;</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                 default=.true.)</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;AH&quot;</span>, ah, &amp;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;                 <span class="stringliteral">&quot;The background biharmonic horizontal viscosity.&quot;</span>, &amp;</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;                 units = <span class="stringliteral">&quot;m4 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;AH_VEL_SCALE&quot;</span>, ah_vel_scale, &amp;</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;                 <span class="stringliteral">&quot;The velocity scale which is multiplied by the cube of \n&quot;</span>//&amp;</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;                 <span class="stringliteral">&quot;the grid spacing to calculate the biharmonic viscosity. \n&quot;</span>//&amp;</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;                 <span class="stringliteral">&quot;The final viscosity is the largest of this scaled \n&quot;</span>//&amp;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;                 <span class="stringliteral">&quot;viscosity, the Smagorinsky and Leith viscosities, and AH.&quot;</span>, &amp;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SMAGORINSKY_AH&quot;</span>, cs%Smagorinsky_Ah, &amp;</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                 <span class="stringliteral">&quot;If true, use a biharmonic Smagorinsky nonlinear eddy \n&quot;</span>//&amp;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                 <span class="stringliteral">&quot;viscosity.&quot;</span>, default=.false.)</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEITH_AH&quot;</span>, cs%Leith_Ah, &amp;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;                 <span class="stringliteral">&quot;If true, use a biharmonic Leith nonlinear eddy \n&quot;</span>//&amp;</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;                 <span class="stringliteral">&quot;viscosity.&quot;</span>, default=.false.)</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOUND_AH&quot;</span>, cs%bound_Ah, &amp;</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                 <span class="stringliteral">&quot;If true, the biharmonic coefficient is locally limited \n&quot;</span>//&amp;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                 <span class="stringliteral">&quot;to be stable.&quot;</span>, default=.true.)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BETTER_BOUND_AH&quot;</span>, cs%better_bound_Ah, &amp;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                 <span class="stringliteral">&quot;If true, the biharmonic coefficient is locally limited \n&quot;</span>//&amp;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                 <span class="stringliteral">&quot;to be stable with a better bounding than just BOUND_AH.&quot;</span>, &amp;</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                 default=cs%bound_Ah)</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Ah .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;SMAG_BI_CONST&quot;</span>,smag_bi_const, &amp;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                 <span class="stringliteral">&quot;The nondimensional biharmonic Smagorinsky constant, \n&quot;</span>//&amp;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                 <span class="stringliteral">&quot;typically 0.015 - 0.06.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0, &amp;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                 fail_if_missing = cs%Smagorinsky_Ah)</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOUND_CORIOLIS&quot;</span>, bound_cor_def, default=.false.)</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOUND_CORIOLIS_BIHARM&quot;</span>, cs%bound_Coriolis, &amp;</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;                 <span class="stringliteral">&quot;If true use a viscosity that increases with the square \n&quot;</span>//&amp;</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;                 <span class="stringliteral">&quot;of the velocity shears, so that the resulting viscous \n&quot;</span>//&amp;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                 <span class="stringliteral">&quot;drag is of comparable magnitude to the Coriolis terms \n&quot;</span>//&amp;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                 <span class="stringliteral">&quot;when the velocity differences between adjacent grid \n&quot;</span>//&amp;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                 <span class="stringliteral">&quot;points is 0.5*BOUND_CORIOLIS_VEL.  The default is the \n&quot;</span>//&amp;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;                 <span class="stringliteral">&quot;value of BOUND_CORIOLIS (or false).&quot;</span>, default=bound_cor_def)</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Coriolis .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXVEL&quot;</span>, maxvel, default=3.0e8)</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        bound_cor_vel = maxvel</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;BOUND_CORIOLIS_VEL&quot;</span>, bound_cor_vel, &amp;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                 <span class="stringliteral">&quot;The velocity scale at which BOUND_CORIOLIS_BIHARM causes \n&quot;</span>//&amp;</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;                 <span class="stringliteral">&quot;the biharmonic drag to have comparable magnitude to the \n&quot;</span>//&amp;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                 <span class="stringliteral">&quot;Coriolis acceleration.  The default is set by MAXVEL.&quot;</span>, &amp;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                 units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=maxvel)</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Ah .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;LEITH_BI_CONST&quot;</span>,leith_bi_const, &amp;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                 <span class="stringliteral">&quot;The nondimensional biharmonic Leith constant, \n&quot;</span>//&amp;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                 <span class="stringliteral">&quot;typical values are thus far undetermined&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0, &amp;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                 fail_if_missing = cs%Leith_Ah)</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <span class="keywordflow">if</span> (cs%better_bound_Ah .or. cs%better_bound_Kh .or. get_all) &amp;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;HORVISC_BOUND_COEF&quot;</span>, cs%bound_coef, &amp;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                 <span class="stringliteral">&quot;The nondimensional coefficient of the ratio of the \n&quot;</span>//&amp;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                 <span class="stringliteral">&quot;viscosity bounds to the theoretical maximum for \n&quot;</span>//&amp;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                 <span class="stringliteral">&quot;stability without considering other terms.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, &amp;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                 default=0.8)</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;NOSLIP&quot;</span>, cs%no_slip, &amp;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                 <span class="stringliteral">&quot;If true, no slip boundary conditions are used; otherwise \n&quot;</span>//&amp;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                 <span class="stringliteral">&quot;free slip boundary conditions are assumed. The \n&quot;</span>//&amp;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                 <span class="stringliteral">&quot;implementation of the free slip BCs on a C-grid is much \n&quot;</span>//&amp;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                 <span class="stringliteral">&quot;cleaner than the no slip BCs. The use of free slip BCs \n&quot;</span>//&amp;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                 <span class="stringliteral">&quot;is strongly encouraged, and no slip BCs are not used with \n&quot;</span>//&amp;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;                 <span class="stringliteral">&quot;the biharmonic viscosity.&quot;</span>, default=.false.)</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;USE_KH_BG_2D&quot;</span>, cs%use_Kh_bg_2d, &amp;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                 <span class="stringliteral">&quot;If true, read a file containing 2-d background harmonic  \n&quot;</span>//&amp;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;                 <span class="stringliteral">&quot;viscosities. The final viscosity is the maximum of the other &quot;</span>//&amp;</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;                 <span class="stringliteral">&quot;terms and this background value.&quot;</span>, default=.false.)</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  <span class="keywordflow">if</span> (cs%bound_Kh .or. cs%bound_Ah .or. cs%better_bound_Kh .or. cs%better_bound_Ah) &amp;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT&quot;</span>, dt, &amp;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;                 <span class="stringliteral">&quot;The (baroclinic) dynamics time step.&quot;</span>, units = <span class="stringliteral">&quot;s&quot;</span>, &amp;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;  <span class="keywordflow">if</span> (cs%no_slip .and. cs%biharmonic) &amp;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;ERROR: NOSLIP and BIHARMONIC cannot be defined &quot;</span>// &amp;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;                          <span class="stringliteral">&quot;at the same time in MOM.&quot;</span>)</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%Laplacian .or. cs%biharmonic)) <span class="keywordflow">then</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="comment">! Only issue inviscid warning if not in single column mode (usually 2x2 domain)</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="keywordflow">if</span> ( max(g%domain%niglobal, g%domain%njglobal)&gt;2 ) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;      <span class="stringliteral">&quot;hor_visc_init:  It is usually a very bad idea not to use either &quot;</span>//&amp;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;      <span class="stringliteral">&quot;LAPLACIAN or BIHARMONIC viscosity.&quot;</span>)</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="keywordflow">return</span> <span class="comment">! We are not using either Laplacian or Bi-harmonic lateral viscosity</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  alloc_(cs%dx2h(isd:ied,jsd:jed))        ; cs%dx2h(:,:)    = 0.0</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  alloc_(cs%dy2h(isd:ied,jsd:jed))        ; cs%dy2h(:,:)    = 0.0</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;  alloc_(cs%dx2q(isdb:iedb,jsdb:jedb))    ; cs%dx2q(:,:)    = 0.0</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  alloc_(cs%dy2q(isdb:iedb,jsdb:jedb))    ; cs%dy2q(:,:)    = 0.0</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  alloc_(cs%dx_dyT(isd:ied,jsd:jed))      ; cs%dx_dyT(:,:)  = 0.0</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  alloc_(cs%dy_dxT(isd:ied,jsd:jed))      ; cs%dy_dxT(:,:)  = 0.0</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  alloc_(cs%dx_dyBu(isdb:iedb,jsdb:jedb)) ; cs%dx_dyBu(:,:) = 0.0</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;  alloc_(cs%dy_dxBu(isdb:iedb,jsdb:jedb)) ; cs%dy_dxBu(:,:) = 0.0</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    alloc_(cs%Kh_bg_xx(isd:ied,jsd:jed))     ; cs%Kh_bg_xx(:,:) = 0.0</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    alloc_(cs%Kh_bg_xy(isdb:iedb,jsdb:jedb)) ; cs%Kh_bg_xy(:,:) = 0.0</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="keywordflow">if</span> (cs%bound_Kh .or. cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      alloc_(cs%Kh_Max_xx(isdb:iedb,jsdb:jedb)) ; cs%Kh_Max_xx(:,:) = 0.0</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;      alloc_(cs%Kh_Max_xy(isdb:iedb,jsdb:jedb)) ; cs%Kh_Max_xy(:,:) = 0.0</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      alloc_(cs%Laplac_Const_xx(isd:ied,jsd:jed))     ; cs%Laplac_Const_xx(:,:) = 0.0</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      alloc_(cs%Laplac_Const_xy(isdb:iedb,jsdb:jedb)) ; cs%Laplac_Const_xy(:,:) = 0.0</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;      alloc_(cs%Laplac3_Const_xx(isd:ied,jsd:jed))     ; cs%Laplac3_Const_xx(:,:) = 0.0</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;      alloc_(cs%Laplac3_Const_xy(isdb:iedb,jsdb:jedb)) ; cs%Laplac3_Const_xy(:,:) = 0.0</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  alloc_(cs%reduction_xx(isd:ied,jsd:jed))     ; cs%reduction_xx(:,:) = 0.0</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  alloc_(cs%reduction_xy(isdb:iedb,jsdb:jedb)) ; cs%reduction_xy(:,:) = 0.0</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;  <span class="keywordflow">if</span> (cs%use_Kh_bg_2d) <span class="keywordflow">then</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    alloc_(cs%Kh_bg_2d(isd:ied,jsd:jed))     ; cs%Kh_bg_2d(:,:) = 0.0</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;KH_BG_2D_FILENAME&quot;</span>, filename, &amp;</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                 <span class="stringliteral">&#39;The filename containing a 2d map of &quot;Kh&quot;.&#39;</span>, &amp;</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                 default=<span class="stringliteral">&#39;KH_background_2d.nc&#39;</span>)</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;INPUTDIR&quot;</span>, inputdir, default=<span class="stringliteral">&quot;.&quot;</span>)</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    inputdir = slasher(inputdir)</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    <span class="keyword">call </span>read_data(trim(inputdir)//trim(filename), <span class="stringliteral">&#39;Kh&#39;</span>, cs%Kh_bg_2d, &amp;</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;                   domain=g%domain%mpp_domain, timelevel=1)</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="keyword">call </span>pass_var(cs%Kh_bg_2d, g%domain)</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    alloc_(cs%Idx2dyCu(isdb:iedb,jsd:jed)) ; cs%Idx2dyCu(:,:) = 0.0</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    alloc_(cs%Idx2dyCv(isd:ied,jsdb:jedb)) ; cs%Idx2dyCv(:,:) = 0.0</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    alloc_(cs%Idxdy2u(isdb:iedb,jsd:jed))  ; cs%Idxdy2u(:,:)  = 0.0</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    alloc_(cs%Idxdy2v(isd:ied,jsdb:jedb))  ; cs%Idxdy2v(:,:)  = 0.0</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    alloc_(cs%Ah_bg_xx(isd:ied,jsd:jed))     ; cs%Ah_bg_xx(:,:) = 0.0</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    alloc_(cs%Ah_bg_xy(isdb:iedb,jsdb:jedb)) ; cs%Ah_bg_xy(:,:) = 0.0</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <span class="keywordflow">if</span> (cs%bound_Ah .or. cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      alloc_(cs%Ah_Max_xx(isd:ied,jsd:jed))     ; cs%Ah_Max_xx(:,:) = 0.0</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      alloc_(cs%Ah_Max_xy(isdb:iedb,jsdb:jedb)) ; cs%Ah_Max_xy(:,:) = 0.0</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;      alloc_(cs%Biharm_Const_xx(isd:ied,jsd:jed))     ; cs%Biharm_Const_xx(:,:) = 0.0</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;      alloc_(cs%Biharm_Const_xy(isdb:iedb,jsdb:jedb)) ; cs%Biharm_Const_xy(:,:) = 0.0</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        alloc_(cs%Biharm_Const2_xx(isd:ied,jsd:jed))     ; cs%Biharm_Const2_xx(:,:) = 0.0</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        alloc_(cs%Biharm_Const2_xy(isdb:iedb,jsdb:jedb)) ; cs%Biharm_Const2_xy(:,:) = 0.0</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <span class="keywordflow">if</span> (cs%Leith_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;      alloc_(cs%Biharm5_Const_xx(isd:ied,jsd:jed))     ; cs%Biharm5_Const_xx(:,:) = 0.0</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;      alloc_(cs%Biharm5_Const_xy(isdb:iedb,jsdb:jedb)) ; cs%Biharm5_Const_xy(:,:) = 0.0</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;  <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;    cs%DX2q(i,j) = g%dxBu(i,j)*g%dxBu(i,j) ; cs%DY2q(i,j) = g%dyBu(i,j)*g%dyBu(i,j)</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    cs%DX_dyBu(i,j) = g%dxBu(i,j)*g%IdyBu(i,j) ; cs%DY_dxBu(i,j) = g%dyBu(i,j)*g%IdxBu(i,j)</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;  <span class="keywordflow">do</span> j=jsq-1,jeq+2 ; <span class="keywordflow">do</span> i=isq-1,ieq+2</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;    cs%DX2h(i,j) = g%dxT(i,j)*g%dxT(i,j) ; cs%DY2h(i,j) = g%dyT(i,j)*g%dyT(i,j)</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;    cs%DX_dyT(i,j) = g%dxT(i,j)*g%IdyT(i,j) ; cs%DY_dxT(i,j) = g%dyT(i,j)*g%IdxT(i,j)</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;  <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    cs%reduction_xx(i,j) = 1.0</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    <span class="keywordflow">if</span> ((g%dy_Cu(i,j) &gt; 0.0) .and. (g%dy_Cu(i,j) &lt; g%dyCu(i,j)) .and. &amp;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        (g%dy_Cu(i,j) &lt; g%dyCu(i,j) * cs%reduction_xx(i,j))) &amp;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;      cs%reduction_xx(i,j) = g%dy_Cu(i,j) / g%dyCu(i,j)</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <span class="keywordflow">if</span> ((g%dy_Cu(i-1,j) &gt; 0.0) .and. (g%dy_Cu(i-1,j) &lt; g%dyCu(i-1,j)) .and. &amp;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        (g%dy_Cu(i-1,j) &lt; g%dyCu(i-1,j) * cs%reduction_xx(i,j))) &amp;</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;      cs%reduction_xx(i,j) = g%dy_Cu(i-1,j) / g%dyCu(i-1,j)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <span class="keywordflow">if</span> ((g%dx_Cv(i,j) &gt; 0.0) .and. (g%dx_Cv(i,j) &lt; g%dxCv(i,j)) .and. &amp;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        (g%dx_Cv(i,j) &lt; g%dxCv(i,j) * cs%reduction_xx(i,j))) &amp;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;      cs%reduction_xx(i,j) = g%dx_Cv(i,j) / g%dxCv(i,j)</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keywordflow">if</span> ((g%dx_Cv(i,j-1) &gt; 0.0) .and. (g%dx_Cv(i,j-1) &lt; g%dxCv(i,j-1)) .and. &amp;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        (g%dx_Cv(i,j-1) &lt; g%dxCv(i,j-1) * cs%reduction_xx(i,j))) &amp;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;      cs%reduction_xx(i,j) = g%dx_Cv(i,j-1) / g%dxCv(i,j-1)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    cs%reduction_xy(i,j) = 1.0</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    <span class="keywordflow">if</span> ((g%dy_Cu(i,j) &gt; 0.0) .and. (g%dy_Cu(i,j) &lt; g%dyCu(i,j)) .and. &amp;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        (g%dy_Cu(i,j) &lt; g%dyCu(i,j) * cs%reduction_xy(i,j))) &amp;</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;      cs%reduction_xy(i,j) = g%dy_Cu(i,j) / g%dyCu(i,j)</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keywordflow">if</span> ((g%dy_Cu(i,j+1) &gt; 0.0) .and. (g%dy_Cu(i,j+1) &lt; g%dyCu(i,j+1)) .and. &amp;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        (g%dy_Cu(i,j+1) &lt; g%dyCu(i,j+1) * cs%reduction_xy(i,j))) &amp;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;      cs%reduction_xy(i,j) = g%dy_Cu(i,j+1) / g%dyCu(i,j+1)</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <span class="keywordflow">if</span> ((g%dx_Cv(i,j) &gt; 0.0) .and. (g%dx_Cv(i,j) &lt; g%dxCv(i,j)) .and. &amp;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        (g%dx_Cv(i,j) &lt; g%dxCv(i,j) * cs%reduction_xy(i,j))) &amp;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;      cs%reduction_xy(i,j) = g%dx_Cv(i,j) / g%dxCv(i,j)</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    <span class="keywordflow">if</span> ((g%dx_Cv(i+1,j) &gt; 0.0) .and. (g%dx_Cv(i+1,j) &lt; g%dxCv(i+1,j)) .and. &amp;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        (g%dx_Cv(i+1,j) &lt; g%dxCv(i+1,j) * cs%reduction_xy(i,j))) &amp;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;      cs%reduction_xy(i,j) = g%dx_Cv(i+1,j) / g%dxCv(i+1,j)</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;   <span class="comment">! The 0.3 below was 0.4 in MOM1.10.  The change in hq requires</span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;   <span class="comment">! this to be less than 1/3, rather than 1/2 as before.</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="keywordflow">if</span> (cs%bound_Kh .or. cs%bound_Ah) kh_limit = 0.3 / (dt*4.0)</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;      grid_sp_h2 = (2.0*cs%DX2h(i,j)*cs%DY2h(i,j)) / (cs%DX2h(i,j) + cs%DY2h(i,j))</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;      grid_sp_h3 = grid_sp_h2*sqrt(grid_sp_h2)</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;      <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) cs%LAPLAC_CONST_xx(i,j) = smag_lap_const * grid_sp_h2</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;      <span class="keywordflow">if</span> (cs%Leith_Kh) cs%LAPLAC3_CONST_xx(i,j) = leith_lap_const * grid_sp_h3</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;      cs%Kh_bg_xx(i,j) = max(kh, kh_vel_scale * sqrt(grid_sp_h2))</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;      <span class="keywordflow">if</span> (cs%use_Kh_bg_2d) cs%Kh_bg_xx(i,j) = max(cs%Kh_bg_2d(i,j), cs%Kh_bg_xx(i,j))</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Kh .and. .not.cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        cs%Kh_Max_xx(i,j) = kh_limit * grid_sp_h2</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        cs%Kh_bg_xx(i,j) = min(cs%Kh_bg_xx(i,j), cs%Kh_Max_xx(i,j))</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;      grid_sp_q2 = (2.0*cs%DX2q(i,j)*cs%DY2q(i,j)) / (cs%DX2q(i,j) + cs%DY2q(i,j))</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;      grid_sp_q3 = grid_sp_q2*sqrt(grid_sp_q2)</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;      <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) cs%LAPLAC_CONST_xy(i,j) = smag_lap_const * grid_sp_q2</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;      <span class="keywordflow">if</span> (cs%Leith_Kh) cs%LAPLAC3_CONST_xy(i,j) = leith_lap_const * grid_sp_q3</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;      cs%Kh_bg_xy(i,j) = max(kh, kh_vel_scale * sqrt(grid_sp_q2))</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;      <span class="keywordflow">if</span> (cs%use_Kh_bg_2d) cs%Kh_bg_xy(i,j) = max(cs%Kh_bg_2d(i,j), cs%Kh_bg_xy(i,j))</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Kh .and. .not.cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        cs%Kh_Max_xy(i,j) = kh_limit * grid_sp_q2</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        cs%Kh_bg_xy(i,j) = min(cs%Kh_bg_xy(i,j), cs%Kh_Max_xy(i,j))</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq+1 ; <span class="keywordflow">do</span> i=isq-1,ieq+1</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;      cs%IDX2dyCu(i,j) = (g%IdxCu(i,j)*g%IdxCu(i,j)) * g%IdyCu(i,j)</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;      cs%IDXDY2u(i,j) = g%IdxCu(i,j) * (g%IdyCu(i,j)*g%IdyCu(i,j))</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordflow">do</span> j=jsq-1,jeq+1 ; <span class="keywordflow">do</span> i=is-1,ieq+1</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;      cs%IDX2dyCv(i,j) = (g%IdxCv(i,j)*g%IdxCv(i,j)) * g%IdyCv(i,j)</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;      cs%IDXDY2v(i,j) = g%IdxCv(i,j) * (g%IdyCv(i,j)*g%IdyCv(i,j))</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;    cs%Ah_bg_xy(:,:) = 0.0</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;   <span class="comment">! The 0.3 below was 0.4 in MOM1.10.  The change in hq requires</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;   <span class="comment">! this to be less than 1/3, rather than 1/2 as before.</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    ah_limit = 0.3 / (dt*64.0)</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    <span class="keywordflow">if</span> (cs%Smagorinsky_Ah .and. cs%bound_Coriolis) &amp;</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;      boundcorconst = 1.0 / (5.0*(bound_cor_vel*bound_cor_vel))</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;      grid_sp_h2 = (2.0*cs%DX2h(i,j)*cs%DY2h(i,j)) / (cs%DX2h(i,j)+cs%DY2h(i,j))</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;      grid_sp_h3 = grid_sp_h2*sqrt(grid_sp_h2)</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;      <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        cs%BIHARM_CONST_xx(i,j) = smag_bi_const * (grid_sp_h2 * grid_sp_h2)</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;          fmax = max(abs(g%CoriolisBu(i-1,j-1)), abs(g%CoriolisBu(i,j-1)), &amp;</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                     abs(g%CoriolisBu(i-1,j)),   abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;          cs%Biharm_Const2_xx(i,j) = (grid_sp_h2 * grid_sp_h2 * grid_sp_h2) * &amp;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                                  (fmax * boundcorconst)</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;      <span class="keywordflow">if</span> (cs%Leith_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        cs%BIHARM5_CONST_xx(i,j) = leith_bi_const * (grid_sp_h2 * grid_sp_h3)</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;      cs%Ah_bg_xx(i,j) = max(ah, ah_vel_scale * grid_sp_h2 * sqrt(grid_sp_h2))</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Ah .and. .not.cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        cs%Ah_Max_xx(i,j) = ah_limit * (grid_sp_h2 * grid_sp_h2)</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        cs%Ah_bg_xx(i,j) = min(cs%Ah_bg_xx(i,j), cs%Ah_Max_xx(i,j))</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;      grid_sp_q2 = (2.0*cs%DX2q(i,j)*cs%DY2q(i,j)) / (cs%DX2q(i,j)+cs%DY2q(i,j))</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;      grid_sp_q3 = grid_sp_q2*sqrt(grid_sp_q2)</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;      <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        cs%BIHARM_CONST_xy(i,j) = smag_bi_const * (grid_sp_q2 * grid_sp_q2)</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;          cs%Biharm_Const2_xy(i,j) = (grid_sp_q2 * grid_sp_q2 * grid_sp_q2) * &amp;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                                      (abs(g%CoriolisBu(i,j)) * boundcorconst)</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;      <span class="keywordflow">if</span> (cs%Leith_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        cs%BIHARM5_CONST_xy(i,j) = leith_bi_const * (grid_sp_q2 * grid_sp_q3)</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;      cs%Ah_bg_xy(i,j) = max(ah, ah_vel_scale * grid_sp_q2 * sqrt(grid_sp_q2))</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;      <span class="keywordflow">if</span> (cs%bound_Ah .and. .not.cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        cs%Ah_Max_xy(i,j) = ah_limit * (grid_sp_q2 * grid_sp_q2)</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        cs%Ah_bg_xy(i,j) = min(cs%Ah_bg_xy(i,j), cs%Ah_Max_xy(i,j))</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="comment">! The Laplacian bounds should avoid overshoots when CS%bound_coef &lt; 1.</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian .and. cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    idt = 1.0 / dt</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;      denom = max( &amp;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;         (cs%DY2h(i,j) * cs%DY_dxT(i,j) * (g%IdyCu(i,j) + g%IdyCu(i-1,j)) * &amp;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;          max(g%IdyCu(i,j)*g%IareaCu(i,j), g%IdyCu(i-1,j)*g%IareaCu(i-1,j)) ), &amp;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;         (cs%DX2h(i,j) * cs%DX_dyT(i,j) * (g%IdxCv(i,j) + g%IdxCv(i,j-1)) * &amp;</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;          max(g%IdxCv(i,j)*g%IareaCv(i,j), g%IdxCv(i,j-1)*g%IareaCv(i,j-1)) ) )</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;      cs%Kh_Max_xx(i,j) = 0.0</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;      <span class="keywordflow">if</span> (denom &gt; 0.0) &amp;</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;        cs%Kh_Max_xx(i,j) = cs%bound_coef * 0.25 * idt / denom</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;      denom = max( &amp;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;         (cs%DX2q(i,j) * cs%DX_dyBu(i,j) * (g%IdxCu(i,j+1) + g%IdxCu(i,j)) * &amp;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;          max(g%IdxCu(i,j)*g%IareaCu(i,j), g%IdxCu(i,j+1)*g%IareaCu(i,j+1)) ), &amp;</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;         (cs%DY2q(i,j) * cs%DY_dxBu(i,j) * (g%IdyCv(i+1,j) + g%IdyCv(i,j)) * &amp;</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;          max(g%IdyCv(i,j)*g%IareaCv(i,j), g%IdyCv(i+1,j)*g%IareaCv(i+1,j)) ) )</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;      cs%Kh_Max_xy(i,j) = 0.0</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;      <span class="keywordflow">if</span> (denom &gt; 0.0) &amp;</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        cs%Kh_Max_xy(i,j) = cs%bound_coef * 0.25 * idt / denom</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;  <span class="comment">! The biharmonic bounds should avoid overshoots when CS%bound_coef &lt; 0.5, but</span></div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="comment">! empirically work for CS%bound_coef &lt;~ 1.0</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic .and. cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    idt = 1.0 / dt</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq+1 ; <span class="keywordflow">do</span> i=isq-1,ieq+1</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;      u0u(i,j) = cs%IDXDY2u(i,j)*(cs%DY2h(i+1,j)*cs%DY_dxT(i+1,j)*(g%IdyCu(i+1,j) + g%IdyCu(i,j))   + &amp;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                                  cs%DY2h(i,j) * cs%DY_dxT(i,j) * (g%IdyCu(i,j) + g%IdyCu(i-1,j)) ) + &amp;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                 cs%IDX2dyCu(i,j)*(cs%DX2q(i,j) * cs%DX_dyBu(i,j) * (g%IdxCu(i,j+1) + g%IdxCu(i,j)) + &amp;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                                  cs%DX2q(i,j-1)*cs%DX_dyBu(i,j-1)*(g%IdxCu(i,j) + g%IdxCu(i,j-1)) )</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;      u0v(i,j) = cs%IDXDY2u(i,j)*(cs%DY2h(i+1,j)*cs%DX_dyT(i+1,j)*(g%IdxCv(i+1,j) + g%IdxCv(i+1,j-1)) + &amp;</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                                  cs%DY2h(i,j) * cs%DX_dyT(i,j) * (g%IdxCv(i,j) + g%IdxCv(i,j-1)) )   + &amp;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;                 cs%IDX2dyCu(i,j)*(cs%DX2q(i,j) * cs%DY_dxBu(i,j) * (g%IdyCv(i+1,j) + g%IdyCv(i,j))   + &amp;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                                  cs%DX2q(i,j-1)*cs%DY_dxBu(i,j-1)*(g%IdyCv(i+1,j-1) + g%IdyCv(i,j-1)) )</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    <span class="keywordflow">do</span> j=jsq-1,jeq+1 ; <span class="keywordflow">do</span> i=is-1,ieq+1</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;      v0u(i,j) = cs%IDXDY2v(i,j)*(cs%DY2q(i,j) * cs%DX_dyBu(i,j) * (g%IdxCu(i,j+1) + g%IdxCu(i,j))       + &amp;</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                                  cs%DY2q(i-1,j)*cs%DX_dyBu(i-1,j)*(g%IdxCu(i-1,j+1) + g%IdxCu(i-1,j)) ) + &amp;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                 cs%IDX2dyCv(i,j)*(cs%DX2h(i,j+1)*cs%DY_dxT(i,j+1)*(g%IdyCu(i,j+1) + g%IdyCu(i-1,j+1))   + &amp;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                                  cs%DX2h(i,j) * cs%DY_dxT(i,j) * (g%IdyCu(i,j) + g%IdyCu(i-1,j)) )</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;      v0v(i,j) = cs%IDXDY2v(i,j)*(cs%DY2q(i,j) * cs%DY_dxBu(i,j) * (g%IdyCv(i+1,j) + g%IdyCv(i,j))   + &amp;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                                  cs%DY2q(i-1,j)*cs%DY_dxBu(i-1,j)*(g%IdyCv(i,j) + g%IdyCv(i-1,j)) ) + &amp;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                 cs%IDX2dyCv(i,j)*(cs%DX2h(i,j+1)*cs%DX_dyT(i,j+1)*(g%IdxCv(i,j+1) + g%IdxCv(i,j))   + &amp;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                                  cs%DX2h(i,j) * cs%DX_dyT(i,j) * (g%IdxCv(i,j) + g%IdxCv(i,j-1)) )</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;      denom = max( &amp;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;         (cs%DY2h(i,j) * &amp;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;          (cs%DY_dxT(i,j)*(g%IdyCu(i,j)*u0u(i,j) + g%IdyCu(i-1,j)*u0u(i-1,j))  + &amp;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;           cs%DX_dyT(i,j)*(g%IdxCv(i,j)*v0u(i,j) + g%IdxCv(i,j-1)*v0u(i,j-1))) * &amp;</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;          max(g%IdyCu(i,j)*g%IareaCu(i,j), g%IdyCu(i-1,j)*g%IareaCu(i-1,j)) ),   &amp;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;         (cs%DX2h(i,j) * &amp;</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;          (cs%DY_dxT(i,j)*(g%IdyCu(i,j)*u0v(i,j) + g%IdyCu(i-1,j)*u0v(i-1,j))  + &amp;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;           cs%DX_dyT(i,j)*(g%IdxCv(i,j)*v0v(i,j) + g%IdxCv(i,j-1)*v0v(i,j-1))) * &amp;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;          max(g%IdxCv(i,j)*g%IareaCv(i,j), g%IdxCv(i,j-1)*g%IareaCv(i,j-1)) ) )</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;      cs%Ah_Max_xx(i,j) = 0.0</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;      <span class="keywordflow">if</span> (denom &gt; 0.0) &amp;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;        cs%Ah_Max_xx(i,j) = cs%bound_coef * 0.5 * idt / denom</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;      denom = max( &amp;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;         (cs%DX2q(i,j) * &amp;</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;          (cs%DX_dyBu(i,j)*(u0u(i,j+1)*g%IdxCu(i,j+1) + u0u(i,j)*g%IdxCu(i,j))  + &amp;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;           cs%DY_dxBu(i,j)*(v0u(i+1,j)*g%IdyCv(i+1,j) + v0u(i,j)*g%IdyCv(i,j))) * &amp;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;          max(g%IdxCu(i,j)*g%IareaCu(i,j), g%IdxCu(i,j+1)*g%IareaCu(i,j+1)) ),    &amp;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;         (cs%DY2q(i,j) * &amp;</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;          (cs%DX_dyBu(i,j)*(u0v(i,j+1)*g%IdxCu(i,j+1) + u0v(i,j)*g%IdxCu(i,j))  + &amp;</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;           cs%DY_dxBu(i,j)*(v0v(i+1,j)*g%IdyCv(i+1,j) + v0v(i,j)*g%IdyCv(i,j))) * &amp;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;          max(g%IdyCv(i,j)*g%IareaCv(i,j), g%IdyCv(i+1,j)*g%IareaCv(i+1,j)) ) )</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;      cs%Ah_Max_xy(i,j) = 0.0</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;      <span class="keywordflow">if</span> (denom &gt; 0.0) &amp;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        cs%Ah_Max_xy(i,j) = cs%bound_coef * 0.5 * idt / denom</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  <span class="comment">! Register fields for output from this module.</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;  cs%id_diffu = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;diffu&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;      <span class="stringliteral">&#39;Zonal Acceleration from Horizontal Viscosity&#39;</span>, <span class="stringliteral">&#39;meter second-2&#39;</span>)</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;  cs%id_diffv = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;diffv&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;      <span class="stringliteral">&#39;Meridional Acceleration from Horizontal Viscosity&#39;</span>, <span class="stringliteral">&#39;meter second-2&#39;</span>)</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    cs%id_Ah_h = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Ahh&#39;</span>, diag%axesTL, time,    &amp;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;        <span class="stringliteral">&#39;Biharmonic Horizontal Viscosity at h Points&#39;</span>, <span class="stringliteral">&#39;meter4 second-1&#39;</span>,        &amp;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;        cmor_field_name=<span class="stringliteral">&#39;difmxybo&#39;</span>, cmor_units=<span class="stringliteral">&#39;m4 s-1&#39;</span>,                        &amp;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;        cmor_long_name=<span class="stringliteral">&#39;Ocean lateral biharmonic viscosity&#39;</span>,                     &amp;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;        cmor_standard_name=<span class="stringliteral">&#39;ocean_momentum_xy_biharmonic_diffusivity&#39;</span>)</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    cs%id_Ah_q = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Ahq&#39;</span>, diag%axesBL, time, &amp;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        <span class="stringliteral">&#39;Biharmonic Horizontal Viscosity at q Points&#39;</span>, <span class="stringliteral">&#39;meter4 second-1&#39;</span>)</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;    cs%id_Kh_h = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Khh&#39;</span>, diag%axesTL, time,   &amp;</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;        <span class="stringliteral">&#39;Laplacian Horizontal Viscosity at h Points&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>,        &amp;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        cmor_field_name=<span class="stringliteral">&#39;difmxylo&#39;</span>, cmor_units=<span class="stringliteral">&#39;m2 s-1&#39;</span>,                        &amp;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;        cmor_long_name=<span class="stringliteral">&#39;Ocean lateral Laplacian viscosity&#39;</span>,                     &amp;</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;        cmor_standard_name=<span class="stringliteral">&#39;ocean_momentum_xy_laplacian_diffusivity&#39;</span>)</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    cs%id_Kh_q = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;Khq&#39;</span>, diag%axesBL, time, &amp;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;        <span class="stringliteral">&#39;Laplacian Horizontal Viscosity at q Points&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  cs%id_FrictWork = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;FrictWork&#39;</span>,diag%axesTL,time,&amp;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;      <span class="stringliteral">&#39;Integral work done by lateral friction terms&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>)</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;  cs%id_FrictWorkIntz = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;FrictWorkIntz&#39;</span>,diag%axesT1,time,      &amp;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;      <span class="stringliteral">&#39;Depth integrated work done by lateral friction&#39;</span>, <span class="stringliteral">&#39;Watt meter-2&#39;</span>,                          &amp;</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;      cmor_field_name=<span class="stringliteral">&#39;dispkexyfo&#39;</span>, cmor_units=<span class="stringliteral">&#39;W m-2&#39;</span>,                                          &amp;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;      cmor_long_name=<span class="stringliteral">&#39;Depth integrated ocean kinetic energy dissipation due to lateral friction&#39;</span>,&amp;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;      cmor_standard_name=<span class="stringliteral">&#39;ocean_kinetic_energy_dissipation_per_unit_area_due_to_xy_friction&#39;</span>)</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;  <span class="keywordflow">if</span> (cs%Laplacian .or. get_all) <span class="keywordflow">then</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__hor__visc_a15121289da182e9ecb4561f10de335a5_cgraph.svg" width="578" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a9f553282bddb798335a3c7aa8f49bd76"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f553282bddb798335a3c7aa8f49bd76">&#9670;&nbsp;</a></span>horizontal_viscosity()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_hor_visc::horizontal_viscosity </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(out)&#160;</td>
          <td class="paramname"><em>diffu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(out)&#160;</td>
          <td class="paramname"><em>diffv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(varmix_cs), pointer&#160;</td>
          <td class="paramname"><em>VarMix</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__hor__visc_1_1hor__visc__cs.html">hor_visc_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_obc_type), optional, pointer&#160;</td>
          <td class="paramname"><em>OBC</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine determines the acceleration due to the horizontal viscosity. A combination of biharmonic and Laplacian forms can be used. The coefficient may either be a constant or a shear-dependent form. The biharmonic is determined by twice taking the divergence of an appropriately defined stress tensor. The Laplacian is determined by doing so once. To work, the following fields must be set outside of the usual is to ie range before this subroutine is called: v[is-2,is-1,ie+1,ie+2], u[is-2,is-1,ie+1,ie+2], and h[is-1,ie+1], with a similarly sized halo in the y-direction. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">diffu</td><td>Zonal acceleration due to convergence of</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">diffv</td><td>Meridional acceleration due to convergence</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>Pointer to a structure containing fields related to Mesoscale Eddy Kinetic Energy.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">varmix</td><td>Pointer to a structure with fields that specify the spatially variable viscosities</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Pontrol structure returned by a previous call to hor_visc_init.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">obc</td><td>Pointer to an open boundary condition type </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__hor__visc_8F90_source.html#l00232">232</a> of file <a class="el" href="MOM__hor__visc_8F90_source.html">MOM_hor_visc.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__open__boundary_8F90_source.html#l00049">mom_open_boundary::obc_direction_n</a>, and <a class="el" href="MOM__open__boundary_8F90_source.html#l00050">mom_open_boundary::obc_direction_s</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__dynamics__split__RK2_8F90_source.html#l00205">mom_dynamics_split_rk2::step_mom_dyn_split_rk2()</a>, <a class="el" href="MOM__dynamics__unsplit_8F90_source.html#l00186">mom_dynamics_unsplit::step_mom_dyn_unsplit()</a>, and <a class="el" href="MOM__dynamics__unsplit__RK2_8F90_source.html#l00192">mom_dynamics_unsplit_rk2::step_mom_dyn_unsplit_rk2()</a>.</p>
<div class="fragment"><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),         <span class="keywordtype">intent(in)</span>  :: g<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),       <span class="keywordtype">intent(in)</span>  :: gv<span class="comment">     !&lt; The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                                 <span class="keywordtype">intent(in)</span>  :: u<span class="comment">      !&lt; The zonal velocity, in m s-1.</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                                 <span class="keywordtype">intent(in)</span>  :: v<span class="comment">      !&lt; The meridional velocity, in m s-1.</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  &amp;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                                 <span class="keywordtype">intent(in)</span>  :: h<span class="comment">      !&lt; Layer thicknesses, in H</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">                                                       !! (usually m or kg m-2).</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                                 <span class="keywordtype">intent(out)</span> :: diffu<span class="comment">  !&lt; Zonal acceleration due to convergence of</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">                                                       !! along-coordinate stress tensor (m/s2)</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, &amp;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                 <span class="keywordtype">intent(out)</span> :: diffv<span class="comment">  !&lt; Meridional acceleration due to convergence</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">                                                       !! of along-coordinate stress tensor (m/s2).</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keywordtype">type</span>(meke_type),               <span class="keywordtype">pointer</span>     :: meke<span class="comment">   !&lt; Pointer to a structure containing fields</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">                                                       !! related to Mesoscale Eddy Kinetic Energy.</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="keywordtype">type</span>(varmix_cs),               <span class="keywordtype">pointer</span>     :: varmix<span class="comment"> !&lt; Pointer to a structure with fields that</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">                                                       !! specify the spatially variable viscosities</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordtype">type</span>(hor_visc_cs),             <span class="keywordtype">pointer</span>     :: cs<span class="comment">     !&lt; Pontrol structure returned by a previous</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">                                                       !! call to hor_visc_init.</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keywordtype">type</span>(ocean_obc_type), <span class="keywordtype">pointer</span>, <span class="keywordtype">optional</span>    :: obc<span class="comment">    !&lt; Pointer to an open boundary condition type</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">! Arguments:</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">!  (in)      u      - zonal velocity (m/s)</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">!  (in)      v      - meridional velocity (m/s)</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">!  (in)      h      - layer thickness (m or kg m-2); h units are referred to as H.</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">!  (out)     diffu  - zonal acceleration due to convergence of</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">!                     along-coordinate stress tensor (m/s2)</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">!  (out)     diffv  - meridional acceleration due to convergence of</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">!                     along-coordinate stress tensor (m/s2)</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">!  (inout)   MEKE   - pointer to a structure containing fields related to</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">!                     Mesoscale Eddy Kinetic Energy</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">!  (in)      VarMix - pointer to a structure with fields that specify the</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">!                     spatially variable viscosities</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">!  (in)      G      - ocean grid structure</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">!  (in)      GV     - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">!  (in)      CS     - control structure returned by a previous call to</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">!                     hor_visc_init</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">!  (in)      OBC    - pointer to an open boundary condition type</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">!  By R. Hallberg, August 1998 - November 1998.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">!    This subroutine determines the acceleration due to the</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">!  horizontal viscosity.  A combination of biharmonic and Laplacian</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">!  forms can be used.  The coefficient may either be a constant or</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">!  a shear-dependent form.  The biharmonic is determined by twice</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">!  taking the divergence of an appropriately defined stress tensor.</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">!  The Laplacian is determined by doing so once.</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">!    To work, the following fields must be set outside of the usual</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">!  is to ie range before this subroutine is called:</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">!   v[is-2,is-1,ie+1,ie+2], u[is-2,is-1,ie+1,ie+2], and h[is-1,ie+1],</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">!  with a similarly sized halo in the y-direction.</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    u0, &amp;   <span class="comment">! Laplacian of u (m-1 s-1)</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    h_u     <span class="comment">! Thickness interpolated to u points, in H.</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    v0, &amp;   <span class="comment">! Laplacian of v (m-1 s-1)</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    h_v     <span class="comment">! Thickness interpolated to v points, in H.</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    sh_xx, &amp;      <span class="comment">! horizontal tension (du/dx - dv/dy) (1/sec) including metric terms</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    str_xx,&amp;      <span class="comment">! str_xx is the diagonal term in the stress tensor (H m2 s-2)</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    bhstr_xx,&amp;    <span class="comment">! A copy of str_xx that only contains the biharmonic contribution (H m2 s-2)</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    div_xx, &amp;     <span class="comment">! horizontal divergence (du/dx + dv/dy) (1/sec) including metric terms</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    frictworkintz <span class="comment">! depth integrated energy dissipated by lateral friction (W/m2)</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    dvdx, dudy, &amp; <span class="comment">! components in the shearing strain (s-1)</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    sh_xy,  &amp;     <span class="comment">! horizontal shearing strain (du/dy + dv/dx) (1/sec) including metric terms</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    str_xy, &amp;     <span class="comment">! str_xy is the cross term in the stress tensor (H m2 s-2)</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    bhstr_xy, &amp;   <span class="comment">! A copy of str_xy that only contains the biharmonic contribution (H m2 s-2)</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    vort_xy       <span class="comment">! vertical vorticity (dv/dx - du/dy) (1/sec) including metric terms</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    vort_xy_dx, &amp; <span class="comment">! x-derivative of vertical vorticity (d/dx(dv/dx - du/dy)) (m-1 sec-1) including metric terms</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    div_xx_dy     <span class="comment">! y-derivative of horizontal divergence (d/dy(du/dx + dv/dy)) (m-1 sec-1) including metric terms</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    vort_xy_dy, &amp; <span class="comment">! y-derivative of vertical vorticity (d/dy(dv/dx - du/dy)) (m-1 sec-1) including metric terms</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    div_xx_dx     <span class="comment">! x-derivative of horizontal divergence (d/dx(du/dx + dv/dy)) (m-1 sec-1) including metric terms</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJB_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    ah_q, &amp;   <span class="comment">! biharmonic viscosity at corner points (m4/s)</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    kh_q      <span class="comment">! Laplacian viscosity at corner points (m2/s)</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    ah_h, &amp;          <span class="comment">! biharmonic viscosity at thickness points (m4/s)</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    kh_h, &amp;          <span class="comment">! Laplacian viscosity at thickness points (m2/s)</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    frictwork        <span class="comment">! energy dissipated by lateral friction (W/m2)</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="keywordtype">real</span> :: ah         <span class="comment">! biharmonic viscosity (m4/s)</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordtype">real</span> :: kh         <span class="comment">! Laplacian  viscosity (m2/s)</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="keywordtype">real</span> :: ahsm       <span class="comment">! Smagorinsky biharmonic viscosity (m4/s)</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  <span class="keywordtype">real</span> :: khsm       <span class="comment">! Smagorinsky Laplacian viscosity  (m2/s)</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keywordtype">real</span> :: ahlth      <span class="comment">! 2D Leith biharmonic viscosity (m4/s)</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="keywordtype">real</span> :: khlth      <span class="comment">! 2D Leith Laplacian viscosity  (m2/s)</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <span class="keywordtype">real</span> :: mod_leith  <span class="comment">! nondimensional coefficient for divergence part of modified Leith</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                     <span class="comment">! viscosity. Here set equal to nondimensional Laplacian Leith constant.</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                     <span class="comment">! This is set equal to zero if modified Leith is not used.</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  <span class="keywordtype">real</span> :: shear_mag  <span class="comment">! magnitude of the shear (1/s)</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordtype">real</span> :: vort_mag   <span class="comment">! magnitude of the vorticity (1/s)</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="keywordtype">real</span> :: h2uq, h2vq <span class="comment">! temporary variables in units of H^2 (i.e. m2 or kg2 m-4).</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordtype">real</span> :: hu, hv     <span class="comment">! Thicknesses interpolated by arithmetic means to corner</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                     <span class="comment">! points; these are first interpolated to u or v velocity</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                     <span class="comment">! points where masks are applied, in units of H (i.e. m or kg m-2).</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <span class="keywordtype">real</span> :: hq         <span class="comment">! harmonic mean of the harmonic means of the u- &amp; v-</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                     <span class="comment">! point thicknesses, in H; This form guarantees that hq/hu &lt; 4.</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  <span class="keywordtype">real</span> :: h_neglect  <span class="comment">! thickness so small it can be lost in roundoff and so neglected (H)</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordtype">real</span> :: h_neglect3 <span class="comment">! h_neglect^3, in H3</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordtype">real</span> :: hrat_min   <span class="comment">! minimum thicknesses at the 4 neighboring</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                     <span class="comment">! velocity points divided by the thickness at the stress</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                     <span class="comment">! point (h or q point) (nondimensional)</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordtype">real</span> :: visc_bound_rem <span class="comment">! fraction of overall viscous bounds that</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                         <span class="comment">! remain to be applied (nondim)</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  <span class="keywordtype">real</span> :: kh_scale  <span class="comment">! A factor between 0 and 1 by which the horizontal</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    <span class="comment">! Laplacian viscosity is rescaled</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  <span class="keywordtype">real</span> :: roscl     <span class="comment">! The scaling function for MEKE source term</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keywordtype">real</span> :: fath      <span class="comment">! abs(f) at h-point for MEKE source term (s-1)</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordtype">logical</span> :: rescale_kh</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="keywordtype">logical</span> :: find_frictwork</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordtype">logical</span> :: apply_obc = .false.</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordtype">logical</span> :: use_meke_ku</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordtype">integer</span> :: is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, n</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  is  = g%isc  ; ie  = g%iec  ; js  = g%jsc  ; je  = g%jec ; nz = g%ke</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  h_neglect  = gv%H_subroundoff</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  h_neglect3 = h_neglect**3</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(obc)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%OBC_pe) <span class="keywordflow">then</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    apply_obc = obc%Flather_u_BCs_exist_globally .or. obc%Flather_v_BCs_exist_globally</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    apply_obc = .true.</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;         <span class="stringliteral">&quot;MOM_hor_visc: Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="keywordflow">if</span> (.not.(cs%Laplacian .or. cs%biharmonic)) <span class="keywordflow">return</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  find_frictwork = (cs%id_FrictWork &gt; 0)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordflow">if</span> (cs%id_FrictWorkIntz &gt; 0)    find_frictwork = .true.</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke)) <span class="keywordflow">then</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%mom_src)) find_frictwork = .true.</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  rescale_kh = .false.</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(varmix)) <span class="keywordflow">then</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    rescale_kh = varmix%Resoln_scaled_Kh</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">if</span> (rescale_kh .and. &amp;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    (.not.<span class="keyword">associated</span>(varmix%Res_fn_h) .or. .not.<span class="keyword">associated</span>(varmix%Res_fn_q))) &amp;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_hor_visc: VarMix%Res_fn_h and &quot;</span> //&amp;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        <span class="stringliteral">&quot;VarMix%Res_fn_q both need to be associated with Resoln_scaled_Kh.&quot;</span>)</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="comment">! Toggle whether to use a Laplacian viscosity derived from MEKE</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  use_meke_ku = <span class="keyword">associated</span>(meke%Ku)</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(Isq,Ieq,Jsq,Jeq,nz,CS,G,GV,u,v,is,js,ie,je,h,  &amp;</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">!$OMP                                  rescale_Kh,VarMix,h_neglect,h_neglect3,        &amp;</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">!$OMP                                  Kh_h,Ah_h,Kh_q,Ah_q,diffu,apply_OBC,OBC,diffv, &amp;</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">!$OMP                                  find_FrictWork,FrictWork,use_MEKE_Ku,MEKE)     &amp;</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">!$OMP                          private(u0, v0, sh_xx, str_xx, visc_bound_rem,         &amp;</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">!$OMP                                  sh_xy, str_xy, Ah, Kh, AhSm, KhSm, dvdx, dudy, &amp;</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">!$OMP                                  bhstr_xx, bhstr_xy,FatH,RoScl, hu, hv, h_u, h_v, &amp;</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">!$OMP                                  vort_xy,vort_xy_dx,vort_xy_dy,Vort_mag,AhLth,KhLth, &amp;</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">!$OMP                                  div_xx, div_xx_dx, div_xx_dy, mod_Leith,       &amp;</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">!$OMP                                  Shear_mag, h2uq, h2vq, hq, Kh_scale, hrat_min)</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">!    This code uses boundary conditions that are consistent with</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">!  free slip and no normal flow boundary conditions.  The boundary</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!  conditions for the western boundary, for example, are:</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">!    dv/dx = 0,  d^3v/dx^3 = 0,    u = 0,     d^2u/dx^2 = 0 .</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">!  The overall scheme is second order accurate.</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">!    All of the metric terms are retained, and the repeated use of</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">!  the symmetric stress tensor insures that no stress is applied with</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">!  no flow or solid-body rotation, even with non-constant values of</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">!  of the biharmonic viscosity.</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">!  The following are the forms of the horizontal tension and hori-</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">!  shearing strain advocated by Smagorinsky (1993) and discussed in</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">!  Griffies and Hallberg (MWR, 2000).</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">do</span> j=jsq-1,jeq+2 ; <span class="keywordflow">do</span> i=isq-1,ieq+2</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;      sh_xx(i,j) = (cs%DY_dxT(i,j)*(g%IdyCu(i,j) * u(i,j,k) - &amp;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                                    g%IdyCu(i-1,j) * u(i-1,j,k)) - &amp;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                    cs%DX_dyT(i,j)*(g%IdxCv(i,j) * v(i,j,k) - &amp;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                                    g%IdxCv(i,j-1)*v(i,j-1,k)))</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      div_xx(i,j) = 0.5*((g%dyCu(i,j) * u(i,j,k) * (h(i+1,j,k)+h(i,j,k)) - &amp;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                          g%dyCu(i-1,j) * u(i-1,j,k) * (h(i-1,j,k)+h(i,j,k)) ) + &amp;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                         (g%dxCv(i,j) * v(i,j,k) * (h(i,j,k)+h(i,j+1,k)) - &amp;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                          g%dxCv(i,j-1)*v(i,j-1,k)*(h(i,j,k)+h(i,j-1,k))))*g%IareaT(i,j)/ &amp;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                    (h(i,j,k) + h_neglect)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">! Components for the shearing strain</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      dvdx(i,j) = cs%DY_dxBu(i,j)*(v(i+1,j,k)*g%IdyCv(i+1,j) - v(i,j,k)*g%IdyCv(i,j))</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;      dudy(i,j) = cs%DX_dyBu(i,j)*(u(i,j+1,k)*g%IdxCu(i,j+1) - u(i,j,k)*g%IdxCu(i,j))</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">! Interpolate the thicknesses to velocity points.</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">! The extra wide halos are to accomodate the cross-corner-point projections</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="comment">! in OBCs, which are not ordinarily be necessary, and might not be necessary</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="comment">! even with OBCs if the accelerations are zeroed at OBC points, in which</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="comment">! case the j-loop for h_u could collapse to j=js=1,je+1. -RWH</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keywordflow">do</span> j=js-2,je+2 ; <span class="keywordflow">do</span> i=isq-1,ieq+1</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      h_u(i,j) = 0.5 * (h(i,j,k) + h(i+1,j,k))</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordflow">do</span> j=jsq-1,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ie+2</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      h_v(i,j) = 0.5 * (h(i,j,k) + h(i,j+1,k))</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="comment">! Adjust contributions to shearing strain and interpolated values of</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="comment">! thicknesses on open boundaries.</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keywordflow">if</span> (apply_obc) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      j = obc%segment(n)%HI%JsdB ; i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordflow">if</span> (obc%zero_strain .or. obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S .and. (j &gt;= js-2) .and. (j &lt;= jeq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;          <span class="keywordflow">do</span> i=obc%segment(n)%HI%IsdB,obc%segment(n)%HI%IedB</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="keywordflow">if</span> (obc%zero_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;              dvdx(i,j) = 0. ; dudy(i,j) = 0.</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            <span class="keywordflow">elseif</span> (obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;              dudy(i,j) = 0.</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="keywordflow">elseif</span> (obc%segment(n)%is_E_or_W .and. (i &gt;= is-2) .and. (i &lt;= ieq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;          <span class="keywordflow">do</span> j=obc%segment(n)%HI%JsdB,obc%segment(n)%HI%JedB</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            <span class="keywordflow">if</span> (obc%zero_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;              dvdx(i,j) = 0. ; dudy(i,j) = 0.</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;            <span class="keywordflow">elseif</span> (obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;              dvdx(i,j) = 0.</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      <span class="keywordflow">if</span> (obc%segment(n)%direction == obc_direction_n) <span class="keywordflow">then</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="comment">! There are extra wide halos here to accomodate the cross-corner-point</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="comment">! OBC projections, but they might not be necessary if the accelerations</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="comment">! are always zeroed out at OBC points, in which case the i-loop below</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="comment">! becomes do i=is-1,ie+1. -RWH</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">if</span> ((j &gt;= jsq-1) .and. (j &lt;= jeq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;          <span class="keywordflow">do</span> i = max(is-2,obc%segment(n)%HI%isd), min(ie+2,obc%segment(n)%HI%ied)</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;            h_v(i,j) = h(i,j,k)</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_s) <span class="keywordflow">then</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <span class="keywordflow">if</span> ((j &gt;= jsq-1) .and. (j &lt;= jeq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;          <span class="keywordflow">do</span> i = max(is-2,obc%segment(n)%HI%isd), min(ie+2,obc%segment(n)%HI%ied)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;            h_v(i,j) = h(i,j+1,k)</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_e) <span class="keywordflow">then</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">if</span> ((i &gt;= isq-1) .and. (i &lt;= ieq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;          <span class="keywordflow">do</span> j = max(js-2,obc%segment(n)%HI%jsd), min(je+2,obc%segment(n)%HI%jed)</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;            h_u(i,j) = h(i,j,k)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_w) <span class="keywordflow">then</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        <span class="keywordflow">if</span> ((i &gt;= isq-1) .and. (i &lt;= ieq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;          <span class="keywordflow">do</span> j = max(js-2,obc%segment(n)%HI%jsd), min(je+2,obc%segment(n)%HI%jed)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            h_u(i,j) = h(i+1,j,k)</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">! Now project thicknesses across corner points on OBCs.</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">if</span> (apply_obc) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      j = obc%segment(n)%HI%JsdB ; i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      <span class="keywordflow">if</span> (obc%segment(n)%direction == obc_direction_n) <span class="keywordflow">then</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">if</span> ((j &gt;= js-2) .and. (j &lt;= je)) <span class="keywordflow">then</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;          <span class="keywordflow">do</span> i = max(isq-1,obc%segment(n)%HI%IsdB), min(ieq+1,obc%segment(n)%HI%IedB)</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;            h_u(i,j+1) = h_u(i,j)</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_s) <span class="keywordflow">then</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="keywordflow">if</span> ((j &gt;= js-1) .and. (j &lt;= je+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;          <span class="keywordflow">do</span> i = max(isq-1,obc%segment(n)%HI%isd), min(ieq+1,obc%segment(n)%HI%ied)</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            h_u(i,j) = h_u(i,j+1)</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_e) <span class="keywordflow">then</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="keywordflow">if</span> ((i &gt;= is-2) .and. (i &lt;= ie)) <span class="keywordflow">then</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;          <span class="keywordflow">do</span> j = max(jsq-1,obc%segment(n)%HI%jsd), min(jeq+1,obc%segment(n)%HI%jed)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            h_v(i+1,j) = h_v(i,j)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      <span class="keywordflow">elseif</span> (obc%segment(n)%direction == obc_direction_w) <span class="keywordflow">then</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">if</span> ((i &gt;= is-1) .and. (i &lt;= ie+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;          <span class="keywordflow">do</span> j = max(jsq-1,obc%segment(n)%HI%jsd), min(jeq+1,obc%segment(n)%HI%jed)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;            h_v(i,j) = h_v(i+1,j)</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">if</span> (cs%no_slip) <span class="keywordflow">then</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        sh_xy(i,j) = (2.0-g%mask2dBu(i,j)) * ( dvdx(i,j) + dudy(i,j) )</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        sh_xy(i,j) = g%mask2dBu(i,j) * ( dvdx(i,j) + dudy(i,j) )</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">if</span> (cs%no_slip) <span class="keywordflow">then</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        vort_xy(i,j) = (2.0-g%mask2dBu(i,j)) * ( dvdx(i,j) - dudy(i,j) )</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        vort_xy(i,j) = g%mask2dBu(i,j) * ( dvdx(i,j) - dudy(i,j) )</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">! Vorticity gradient</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=is-1,ieq+1</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      vort_xy_dx(i,j) = cs%DY_dxBu(i,j)*(vort_xy(i,j)*g%IdyCu(i,j) - vort_xy(i-1,j)*g%IdyCu(i-1,j))</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq+1 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      vort_xy_dy(i,j) = cs%DX_dyBu(i,j)*(vort_xy(i,j)*g%IdxCv(i,j) - vort_xy(i,j-1)*g%IdxCv(i,j-1))</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment">! Divergence gradient</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">do</span> j=jsq-1,jeq+2 ; <span class="keywordflow">do</span> i=is-2,ieq+1</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      div_xx_dx(i,j) = g%IdxCu(i,j)*(div_xx(i+1,j) - div_xx(i,j))</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">do</span> j=js-2,jeq+1 ; <span class="keywordflow">do</span> i=isq-1,ieq+2</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      div_xx_dy(i,j) = g%IdyCv(i,j)*(div_xx(i,j+1) - div_xx(i,j))</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">! Coefficient for modified Leith</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keywordflow">if</span> (cs%Modified_Leith) <span class="keywordflow">then</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      mod_leith = 1.0</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;      mod_leith = 0.0</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="comment">!  Evaluate u0 = x.Div(Grad u) and v0 = y.Div( Grad u)</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">do</span> j=js-1,jeq+1 ; <span class="keywordflow">do</span> i=isq-1,ieq+1</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        u0(i,j) = cs%IDXDY2u(i,j)*(cs%DY2h(i+1,j)*sh_xx(i+1,j) - cs%DY2h(i,j)*sh_xx(i,j)) + &amp;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                  cs%IDX2dyCu(i,j)*(cs%DX2q(i,j)*sh_xy(i,j) - cs%DX2q(i,j-1)*sh_xy(i,j-1))</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      <span class="keywordflow">do</span> j=jsq-1,jeq+1 ; <span class="keywordflow">do</span> i=is-1,ieq+1</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        v0(i,j) = cs%IDXDY2v(i,j)*(cs%DY2q(i,j)*sh_xy(i,j) - cs%DY2q(i-1,j)*sh_xy(i-1,j)) - &amp;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                  cs%IDX2dyCv(i,j)*(cs%DX2h(i,j+1)*sh_xx(i,j+1) - cs%DX2h(i,j)*sh_xx(i,j))</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      <span class="keywordflow">if</span> (apply_obc .and. obc%zero_biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          i = obc%segment(n)%HI%IsdB ; j = obc%segment(n)%HI%JsdB</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;          <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S .and. (j &gt;= jsq-1) .and. (j &lt;= jeq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            <span class="keywordflow">do</span> i=obc%segment(n)%HI%isd,obc%segment(n)%HI%ied</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;              v0(i,j) = 0.</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;          <span class="keywordflow">elseif</span> (obc%segment(n)%is_E_or_W .and. (i &gt;= isq-1) .and. (i &lt;= ieq+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            <span class="keywordflow">do</span> j=obc%segment(n)%HI%jsd,obc%segment(n)%HI%jed</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;              u0(i,j) = 0.</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      <span class="keywordflow">if</span> ((cs%Smagorinsky_Kh) .or. (cs%Smagorinsky_Ah)) <span class="keywordflow">then</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        shear_mag = sqrt(sh_xx(i,j)*sh_xx(i,j) + &amp;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;          0.25*((sh_xy(i-1,j-1)*sh_xy(i-1,j-1) + sh_xy(i,j)*sh_xy(i,j)) + &amp;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                (sh_xy(i-1,j)*sh_xy(i-1,j) + sh_xy(i,j-1)*sh_xy(i,j-1))))</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="keywordflow">if</span> ((cs%Leith_Kh) .or. (cs%Leith_Ah)) <span class="keywordflow">then</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        vort_mag = sqrt( &amp;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;          0.5*((vort_xy_dx(i,j-1)*vort_xy_dx(i,j-1) + vort_xy_dx(i,j)*vort_xy_dx(i,j)) + &amp;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                (vort_xy_dy(i-1,j)*vort_xy_dy(i-1,j) + vort_xy_dy(i,j)*vort_xy_dy(i,j))) + &amp;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;          mod_leith*0.5*((div_xx_dx(i,j)*div_xx_dx(i,j) + div_xx_dx(i-1,j)*div_xx_dx(i-1,j)) + &amp;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;                (div_xx_dy(i,j)*div_xx_dy(i,j) + div_xx_dy(i,j-1)*div_xx_dy(i,j-1))))</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="keywordflow">if</span> (cs%better_bound_Ah .or. cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        hrat_min = min(1.0, min(h_u(i,j), h_u(i-1,j), h_v(i,j), h_v(i,j-1)) / &amp;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                            (h(i,j,k) + h_neglect) )</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        visc_bound_rem = 1.0</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="comment">! Determine the Laplacian viscosity at h points, using the</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="comment">! largest value from several parameterizations.</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        kh_scale = 1.0 ; <span class="keywordflow">if</span> (rescale_kh) kh_scale = varmix%Res_fn_h(i,j)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        khsm = 0.0; khlth = 0.0</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <span class="keywordflow">if</span> ((cs%Smagorinsky_Kh) .or. (cs%Leith_Kh)) <span class="keywordflow">then</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) &amp;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            khsm = cs%LAPLAC_CONST_xx(i,j) * shear_mag</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;          <span class="keywordflow">if</span> (cs%Leith_Kh) &amp;</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            khlth = cs%LAPLAC3_CONST_xx(i,j) * vort_mag</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;          kh = kh_scale * max(khlth, max(cs%Kh_bg_xx(i,j), khsm))</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;          <span class="keywordflow">if</span> (cs%bound_Kh .and. .not.cs%better_bound_Kh) &amp;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            kh = min(kh, cs%Kh_Max_xx(i,j))</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;          kh = kh_scale * cs%Kh_bg_xx(i,j)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="keywordflow">if</span> (use_meke_ku) <span class="keywordflow">then</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;          kh = kh + meke%Ku(i,j)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keywordflow">if</span> (cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;          <span class="keywordflow">if</span> (kh &gt;= hrat_min*cs%Kh_Max_xx(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            visc_bound_rem = 0.0</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;            kh = hrat_min*cs%Kh_Max_xx(i,j)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;           <span class="comment">!visc_bound_rem = 1.0 - abs(Kh) / (hrat_min*CS%Kh_Max_xx(i,j))</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            visc_bound_rem = 1.0 - kh / (hrat_min*cs%Kh_Max_xx(i,j))</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordflow">if</span> (cs%id_Kh_h&gt;0) kh_h(i,j,k) = kh</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        str_xx(i,j) = -kh * sh_xx(i,j)</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      <span class="keywordflow">else</span>   <span class="comment">! not Laplacian</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        str_xx(i,j) = 0.0</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! Laplacian</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="comment">!       Determine the biharmonic viscosity at h points, using the</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">!       largest value from several parameterizations.</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        ahsm = 0.0; ahlth = 0.0</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <span class="keywordflow">if</span> ((cs%Smagorinsky_Ah) .or. (cs%Leith_Ah)) <span class="keywordflow">then</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;          <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;            <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;              ahsm =  shear_mag * (cs%BIHARM_CONST_xx(i,j) + &amp;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                                 cs%Biharm_Const2_xx(i,j)*shear_mag)</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;              ahsm = cs%BIHARM_CONST_xx(i,j) * shear_mag</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          <span class="keywordflow">if</span> (cs%Leith_Ah) &amp;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            ahlth = vort_mag * (cs%BIHARM_CONST_xx(i,j))</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;          ah = max(max(cs%Ah_bg_xx(i,j), ahsm),ahlth)</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;          <span class="keywordflow">if</span> (cs%bound_Ah .and. .not.cs%better_bound_Ah) &amp;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;            ah = min(ah, cs%Ah_Max_xx(i,j))</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;       <span class="keywordflow">else</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;         ah = cs%Ah_bg_xx(i,j)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordflow">       endif</span> <span class="comment">! Smagorinsky_Ah or Leith_Ah</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="keywordflow">if</span> (cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;          ah = min(ah, visc_bound_rem*hrat_min*cs%Ah_Max_xx(i,j))</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        <span class="keywordflow">if</span> (cs%id_Ah_h&gt;0) ah_h(i,j,k) = ah</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        str_xx(i,j) = str_xx(i,j) + ah * &amp;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;          (cs%DY_dxT(i,j)*(g%IdyCu(i,j)*u0(i,j) - g%IdyCu(i-1,j)*u0(i-1,j)) - &amp;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;           cs%DX_dyT(i,j) *(g%IdxCv(i,j)*v0(i,j) - g%IdxCv(i,j-1)*v0(i,j-1)))</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="comment">! Keep a copy of the biharmonic contribution for backscatter parameterization</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        bhstr_xx(i,j) =             ah * &amp;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;          (cs%DY_dxT(i,j)*(g%IdyCu(i,j)*u0(i,j) - g%IdyCu(i-1,j)*u0(i-1,j)) - &amp;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;           cs%DX_dyT(i,j) *(g%IdxCv(i,j)*v0(i,j) - g%IdxCv(i,j-1)*v0(i,j-1)))</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        bhstr_xx(i,j) = bhstr_xx(i,j) * (h(i,j,k) * cs%reduction_xx(i,j))</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="keywordflow">      endif</span>  <span class="comment">! biharmonic</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      str_xx(i,j) = str_xx(i,j) * (h(i,j,k) * cs%reduction_xx(i,j))</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      <span class="comment">! Gradient of Laplacian, for use in bi-harmonic term</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        dvdx(i,j) = cs%DY_dxBu(i,j)*(v0(i+1,j)*g%IdyCv(i+1,j) - v0(i,j)*g%IdyCv(i,j))</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        dudy(i,j) = cs%DX_dyBu(i,j)*(u0(i,j+1)*g%IdxCu(i,j+1) - u0(i,j)*g%IdxCu(i,j))</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      <span class="comment">! Adjust contributions to shearing strain on open boundaries.</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;      <span class="keywordflow">if</span> (apply_obc) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (obc%zero_strain .or. obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;          j = obc%segment(n)%HI%JsdB ; i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;          <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S .and. (j &gt;= js-1) .and. (j &lt;= jeq)) <span class="keywordflow">then</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            <span class="keywordflow">do</span> i=obc%segment(n)%HI%IsdB,obc%segment(n)%HI%IedB</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;              <span class="keywordflow">if</span> (obc%zero_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                dvdx(i,j) = 0. ; dudy(i,j) = 0.</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;              <span class="keywordflow">elseif</span> (obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                dudy(i,j) = 0.</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;          <span class="keywordflow">elseif</span> (obc%segment(n)%is_E_or_W .and. (i &gt;= is-1) .and. (i &lt;= ieq)) <span class="keywordflow">then</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;            <span class="keywordflow">do</span> j=obc%segment(n)%HI%JsdB,obc%segment(n)%HI%JedB</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;              <span class="keywordflow">if</span> (obc%zero_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                dvdx(i,j) = 0. ; dudy(i,j) = 0.</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;              <span class="keywordflow">elseif</span> (obc%freeslip_strain) <span class="keywordflow">then</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                dvdx(i,j) = 0.</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordflow">do</span> j=js-1,jeq ; <span class="keywordflow">do</span> i=is-1,ieq</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <span class="keywordflow">if</span> ((cs%Smagorinsky_Kh) .or. (cs%Smagorinsky_Ah)) <span class="keywordflow">then</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        shear_mag = sqrt(sh_xy(i,j)*sh_xy(i,j) + &amp;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            0.25*((sh_xx(i,j)*sh_xx(i,j) + sh_xx(i+1,j+1)*sh_xx(i+1,j+1)) + &amp;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                  (sh_xx(i,j+1)*sh_xx(i,j+1) + sh_xx(i+1,j)*sh_xx(i+1,j))))</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      <span class="keywordflow">if</span> ((cs%Leith_Kh) .or. (cs%Leith_Ah)) &amp;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        vort_mag = sqrt( &amp;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;          0.5*((vort_xy_dx(i,j)*vort_xy_dx(i,j) + vort_xy_dx(i+1,j)*vort_xy_dx(i+1,j)) + &amp;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                (vort_xy_dy(i,j)*vort_xy_dy(i,j) + vort_xy_dy(i,j+1)*vort_xy_dy(i,j+1))) + &amp;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;          mod_leith*0.5*((div_xx_dx(i,j)*div_xx_dx(i,j) + div_xx_dx(i,j+1)*div_xx_dx(i,j+1)) + &amp;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                (div_xx_dy(i,j)*div_xx_dy(i,j) + div_xx_dy(i+1,j)*div_xx_dy(i+1,j))))</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      h2uq = 4.0 * h_u(i,j) * h_u(i,j+1)</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;      h2vq = 4.0 * h_v(i,j) * h_v(i+1,j)</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment">!      hq = 2.0 * h2uq * h2vq / (h_neglect3 + (h2uq + h2vq) * &amp;</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">!          ((h(i,j,k) + h(i+1,j+1,k)) + (h(i,j+1,k) + h(i+1,j,k))))</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;      hq = 2.0 * h2uq * h2vq / (h_neglect3 + (h2uq + h2vq) * &amp;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;          ((h_u(i,j) + h_u(i,j+1)) + (h_v(i,j) + h_v(i+1,j))))</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;      <span class="keywordflow">if</span> (cs%better_bound_Ah .or. cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        hrat_min = min(1.0, min(h_u(i,j), h_u(i,j+1), h_v(i,j), h_v(i+1,j)) / &amp;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;                            (hq + h_neglect) )</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        visc_bound_rem = 1.0</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      <span class="keywordflow">if</span> (cs%no_slip .and. (g%mask2dBu(i,j) &lt; 0.5)) <span class="keywordflow">then</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        <span class="keywordflow">if</span> ((g%mask2dCu(i,j) + g%mask2dCu(i,j+1)) + &amp;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;            (g%mask2dCv(i,j) + g%mask2dCv(i+1,j)) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;          <span class="comment">! This is a coastal vorticity point, so modify hq and hrat_min.</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;          hu = g%mask2dCu(i,j) * h_u(i,j) + g%mask2dCu(i,j+1) * h_u(i,j+1)</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;          hv = g%mask2dCv(i,j) * h_v(i,j) + g%mask2dCv(i+1,j) * h_v(i+1,j)</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;          <span class="keywordflow">if</span> ((g%mask2dCu(i,j) + g%mask2dCu(i,j+1)) * &amp;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;              (g%mask2dCv(i,j) + g%mask2dCv(i+1,j)) == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            <span class="comment">! Only one of hu and hv is nonzero, so just add them.</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            hq = hu + hv</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;            hrat_min = 1.0</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;            <span class="comment">! Both hu and hv are nonzero, so take the harmonic mean.</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;            hq = 2.0 * (hu * hv) / ((hu + hv) + h_neglect)</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;            hrat_min = min(1.0, min(hu, hv) / (hq + h_neglect) )</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      <span class="keywordflow">if</span> (cs%Laplacian) <span class="keywordflow">then</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="comment">! Determine the Laplacian viscosity at q points, using the</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="comment">! largest value from several parameterizations.</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        kh_scale = 1.0 ; <span class="keywordflow">if</span> (rescale_kh) kh_scale = varmix%Res_fn_q(i,j)</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        khsm = 0.0; khlth = 0.0</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="keywordflow">if</span> ((cs%Smagorinsky_Kh) .or. (cs%Leith_Kh)) <span class="keywordflow">then</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;          <span class="keywordflow">if</span> (cs%Smagorinsky_Kh) &amp;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;            khsm = cs%LAPLAC_CONST_xy(i,j) * shear_mag</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;          <span class="keywordflow">if</span> (cs%Leith_Kh) &amp;</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;            khlth = cs%LAPLAC3_CONST_xy(i,j) * vort_mag</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;          kh = kh_scale * max(max(cs%Kh_bg_xy(i,j), khsm), khlth)</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;          <span class="keywordflow">if</span> (cs%bound_Kh .and. .not.cs%better_bound_Kh) &amp;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            kh = min(kh, cs%Kh_Max_xy(i,j))</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;          kh = kh_scale * cs%Kh_bg_xy(i,j)</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        <span class="keywordflow">if</span> (use_meke_ku) <span class="keywordflow">then</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;          kh = kh + 0.25*( (meke%Ku(i,j)+meke%Ku(i+1,j+1))    &amp;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                          +(meke%Ku(i+1,j)+meke%Ku(i,j+1)) )</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="comment">! Place a floor on the viscosity, if desired.</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        kh = max(kh,cs%Kh_bg_min)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordflow">if</span> (cs%better_bound_Kh) <span class="keywordflow">then</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;          <span class="keywordflow">if</span> (kh &gt;= hrat_min*cs%Kh_Max_xy(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            visc_bound_rem = 0.0</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;            kh = hrat_min*cs%Kh_Max_xy(i,j)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;          <span class="keywordflow">elseif</span> (cs%Kh_Max_xy(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;           <span class="comment">!visc_bound_rem = 1.0 - abs(Kh) / (hrat_min*CS%Kh_Max_xy(I,J))</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;            visc_bound_rem = 1.0 - kh / (hrat_min*cs%Kh_Max_xy(i,j))</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <span class="keywordflow">if</span> (cs%id_Kh_q&gt;0) kh_q(i,j,k) = kh</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        str_xy(i,j) = -kh * sh_xy(i,j)</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;      <span class="keywordflow">else</span>   <span class="comment">! not Laplacian</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        str_xy(i,j) = 0.0</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! Laplacian</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;      <span class="keywordflow">if</span> (cs%biharmonic) <span class="keywordflow">then</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;      <span class="comment">! Determine the biharmonic viscosity at q points, using the</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;      <span class="comment">! largest value from several parameterizations.</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;      ahsm = 0.0; ahlth = 0.0</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        <span class="keywordflow">if</span> (cs%Smagorinsky_Ah .or. cs%Leith_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;          <span class="keywordflow">if</span> (cs%Smagorinsky_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;            <span class="keywordflow">if</span> (cs%bound_Coriolis) <span class="keywordflow">then</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;              ahsm =  shear_mag * (cs%BIHARM_CONST_xy(i,j) + &amp;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                                 cs%Biharm_Const2_xy(i,j)*shear_mag)</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;              ahsm = cs%BIHARM_CONST_xy(i,j) * shear_mag</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;          <span class="keywordflow">if</span> (cs%Leith_Ah) &amp;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;            ahlth =  vort_mag * (cs%BIHARM5_CONST_xy(i,j))</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;          ah = max(max(cs%Ah_bg_xy(i,j), ahsm),ahlth)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;          <span class="keywordflow">if</span> (cs%bound_Ah .and. .not.cs%better_bound_Ah) &amp;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;            ah = min(ah, cs%Ah_Max_xy(i,j))</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;          ah = cs%Ah_bg_xy(i,j)</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="keywordflow">        endif</span> <span class="comment">! Smagorinsky_Ah or Leith_Ah</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        <span class="keywordflow">if</span> (cs%better_bound_Ah) <span class="keywordflow">then</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;          ah = min(ah, visc_bound_rem*hrat_min*cs%Ah_Max_xy(i,j))</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="keywordflow">if</span> (cs%id_Ah_q&gt;0) ah_q(i,j,k) = ah</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        str_xy(i,j) = str_xy(i,j) + ah * ( dvdx(i,j) + dudy(i,j) )</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        <span class="comment">! Keep a copy of the biharmonic contribution for backscatter parameterization</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        bhstr_xy(i,j) = ah * ( dvdx(i,j) + dudy(i,j) ) * &amp;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                        (hq * g%mask2dBu(i,j) * cs%reduction_xy(i,j))</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="keywordflow">      endif</span>  <span class="comment">! biharmonic</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      <span class="keywordflow">if</span> (cs%no_slip) <span class="keywordflow">then</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        str_xy(i,j) = str_xy(i,j) * (hq * cs%reduction_xy(i,j))</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        str_xy(i,j) = str_xy(i,j) * (hq * g%mask2dBu(i,j) * cs%reduction_xy(i,j))</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="comment">!  Evaluate 1/h x.Div(h Grad u) or the biharmonic equivalent.</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      diffu(i,j,k) = ((g%IdyCu(i,j)*(cs%DY2h(i,j) *str_xx(i,j) - &amp;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;                                    cs%DY2h(i+1,j)*str_xx(i+1,j)) + &amp;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                       g%IdxCu(i,j)*(cs%DX2q(i,j-1)*str_xy(i,j-1) - &amp;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                                    cs%DX2q(i,j) *str_xy(i,j))) * &amp;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;                     g%IareaCu(i,j)) / (h_u(i,j) + h_neglect)</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <span class="keywordflow">if</span> (apply_obc) <span class="keywordflow">then</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;      <span class="comment">! This is not the right boundary condition. If all the masking of tendencies are done</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="comment">! correctly later then eliminating this block should not change answers.</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;      <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_E_or_W) <span class="keywordflow">then</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;          i = obc%segment(n)%HI%IsdB</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;          <span class="keywordflow">do</span> j=obc%segment(n)%HI%jsd,obc%segment(n)%HI%jed</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;            diffu(i,j,k) = 0.</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="comment">!  Evaluate 1/h y.Div(h Grad u) or the biharmonic equivalent.</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      diffv(i,j,k) = ((g%IdyCv(i,j)*(cs%DY2q(i-1,j)*str_xy(i-1,j) - &amp;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                                    cs%DY2q(i,j) *str_xy(i,j)) - &amp;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                       g%IdxCv(i,j)*(cs%DX2h(i,j) *str_xx(i,j) - &amp;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                                    cs%DX2h(i,j+1)*str_xx(i,j+1))) * &amp;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                     g%IareaCv(i,j)) / (h_v(i,j) + h_neglect)</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">if</span> (apply_obc) <span class="keywordflow">then</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;      <span class="comment">! This is not the right boundary condition. If all the masking of tendencies are done</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;      <span class="comment">! correctly later then eliminating this block should not change answers.</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;      <span class="keywordflow">do</span> n=1,obc%number_of_segments</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="keywordflow">if</span> (obc%segment(n)%is_N_or_S) <span class="keywordflow">then</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;          j = obc%segment(n)%HI%JsdB</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;          <span class="keywordflow">do</span> i=obc%segment(n)%HI%isd,obc%segment(n)%HI%ied</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            diffv(i,j,k) = 0.</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="keywordflow">if</span> (find_frictwork) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="comment">! Diagnose   str_xx*d_x u - str_yy*d_y v + str_xy*(d_y u + d_x v)</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      frictwork(i,j,k) = gv%H_to_kg_m2 * ( &amp;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;              (str_xx(i,j)*(u(i,j,k)-u(i-1,j,k))*g%IdxT(i,j)     &amp;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;              -str_xx(i,j)*(v(i,j,k)-v(i,j-1,k))*g%IdyT(i,j))    &amp;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;       +0.25*((str_xy(i,j)*(                                     &amp;</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                   (u(i,j+1,k)-u(i,j,k))*g%IdyBu(i,j)            &amp;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                  +(v(i+1,j,k)-v(i,j,k))*g%IdxBu(i,j) )          &amp;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;              +str_xy(i-1,j-1)*(                                 &amp;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                   (u(i-1,j,k)-u(i-1,j-1,k))*g%IdyBu(i-1,j-1)    &amp;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                  +(v(i,j-1,k)-v(i-1,j-1,k))*g%IdxBu(i-1,j-1) )) &amp;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;             +(str_xy(i-1,j)*(                                   &amp;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                   (u(i-1,j+1,k)-u(i-1,j,k))*g%IdyBu(i-1,j)      &amp;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                  +(v(i,j,k)-v(i-1,j,k))*g%IdxBu(i-1,j) )        &amp;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;              +str_xy(i,j-1)*(                                   &amp;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                   (u(i,j,k)-u(i,j-1,k))*g%IdyBu(i,j-1)          &amp;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                  +(v(i+1,j-1,k)-v(i,j-1,k))*g%IdxBu(i,j-1) )) ) )</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="comment">! Make a similar calculation as for FrictWork above but accumulating into</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">! the vertically integrated MEKE source term, and adjusting for any</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="comment">! energy loss seen as a reduction in the [biharmonic] frictional source term.</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keywordflow">if</span> (find_frictwork .and. <span class="keyword">associated</span>(meke)) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%mom_src)) <span class="keywordflow">then</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;      <span class="keywordflow">if</span> (k==1) <span class="keywordflow">then</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;          meke%mom_src(i,j) = 0.</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      <span class="keywordflow">if</span> (meke%backscatter_Ro_c /= 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;          fath = 0.25*( (abs(g%CoriolisBu(i-1,j-1)) + abs(g%CoriolisBu(i,j))) &amp;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                       +(abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j-1))) )</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;          shear_mag = sqrt(sh_xx(i,j)*sh_xx(i,j) + &amp;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;            0.25*((sh_xy(i-1,j-1)*sh_xy(i-1,j-1) + sh_xy(i,j)*sh_xy(i,j)) + &amp;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                  (sh_xy(i-1,j)*sh_xy(i-1,j) + sh_xy(i,j-1)*sh_xy(i,j-1))))</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;          fath = fath ** meke%backscatter_Ro_pow <span class="comment">! f^n</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;          shear_mag = ( ( shear_mag ** meke%backscatter_Ro_pow ) + 1.e-30 ) &amp;</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                      * meke%backscatter_Ro_c <span class="comment">! c * D^n</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;          <span class="comment">! The Rossby number function is g(Ro) = 1/(1+c.Ro^n)</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;          <span class="comment">! RoScl = 1 - g(Ro)</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;          roscl = shear_mag / ( fath + shear_mag ) <span class="comment">! = 1 - f^n/(f^n+c*D^n)</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;          meke%mom_src(i,j) = meke%mom_src(i,j) + gv%H_to_kg_m2 * (                   &amp;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                ((str_xx(i,j)-roscl*bhstr_xx(i,j))*(u(i,j,k)-u(i-1,j,k))*g%IdxT(i,j)  &amp;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                -(str_xx(i,j)-roscl*bhstr_xx(i,j))*(v(i,j,k)-v(i,j-1,k))*g%IdyT(i,j)) &amp;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;         +0.25*(((str_xy(i,j)-roscl*bhstr_xy(i,j))*(                                  &amp;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;                     (u(i,j+1,k)-u(i,j,k))*g%IdyBu(i,j)                               &amp;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                    +(v(i+1,j,k)-v(i,j,k))*g%IdxBu(i,j) )                             &amp;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                +(str_xy(i-1,j-1)-roscl*bhstr_xy(i-1,j-1))*(                          &amp;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                     (u(i-1,j,k)-u(i-1,j-1,k))*g%IdyBu(i-1,j-1)                       &amp;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                    +(v(i,j-1,k)-v(i-1,j-1,k))*g%IdxBu(i-1,j-1) ))                    &amp;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;               +((str_xy(i-1,j)-roscl*bhstr_xy(i-1,j))*(                              &amp;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                     (u(i-1,j+1,k)-u(i-1,j,k))*g%IdyBu(i-1,j)                         &amp;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                    +(v(i,j,k)-v(i-1,j,k))*g%IdxBu(i-1,j) )                           &amp;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                +(str_xy(i,j-1)-roscl*bhstr_xy(i,j-1))*(                              &amp;</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                     (u(i,j,k)-u(i,j-1,k))*g%IdyBu(i,j-1)                             &amp;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                    +(v(i+1,j-1,k)-v(i,j-1,k))*g%IdxBu(i,j-1) )) ) )</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;         meke%mom_src(i,j) = meke%mom_src(i,j) + frictwork(i,j,k)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! end of k loop</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="comment">! Offer fields for diagnostic averaging.</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  <span class="keywordflow">if</span> (cs%id_diffu&gt;0)     <span class="keyword">call </span>post_data(cs%id_diffu, diffu, cs%diag)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="keywordflow">if</span> (cs%id_diffv&gt;0)     <span class="keyword">call </span>post_data(cs%id_diffv, diffv, cs%diag)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;  <span class="keywordflow">if</span> (cs%id_FrictWork&gt;0) <span class="keyword">call </span>post_data(cs%id_FrictWork, frictwork, cs%diag)</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ah_h&gt;0)      <span class="keyword">call </span>post_data(cs%id_Ah_h, ah_h, cs%diag)</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordflow">if</span> (cs%id_Ah_q&gt;0)      <span class="keyword">call </span>post_data(cs%id_Ah_q, ah_q, cs%diag)</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kh_h&gt;0)      <span class="keyword">call </span>post_data(cs%id_Kh_h, kh_h, cs%diag)</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  <span class="keywordflow">if</span> (cs%id_Kh_q&gt;0)      <span class="keyword">call </span>post_data(cs%id_Kh_q, kh_q, cs%diag)</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <span class="keywordflow">if</span> (cs%id_FrictWorkIntz &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; frictworkintz(i,j) = frictwork(i,j,1) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;      <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        frictworkintz(i,j) = frictworkintz(i,j) + frictwork(i,j,k)</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="keyword">call </span>post_data(cs%id_FrictWorkIntz, frictworkintz, cs%diag)</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__hor__visc_a9f553282bddb798335a3c7aa8f49bd76_cgraph.svg" width="560" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__hor__visc_a9f553282bddb798335a3c7aa8f49bd76_icgraph.svg" width="444" height="183"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__hor__visc.html">mom_hor_visc</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
