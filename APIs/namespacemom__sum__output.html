<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_sum_output Module Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('namespacemom__sum__output.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_sum_output Module Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__sum__output_1_1depth__list.html">depth_list</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:ab1d2eb6c53a3cdd079ff60f82691fccb"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#ab1d2eb6c53a3cdd079ff60f82691fccb">mom_sum_output_init</a> (G, param_file, directory, ntrnc, Input_start_time, CS)</td></tr>
<tr class="separator:ab1d2eb6c53a3cdd079ff60f82691fccb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae54994f461b38198510274dadbce8fb5"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#ae54994f461b38198510274dadbce8fb5">mom_sum_output_end</a> (CS)</td></tr>
<tr class="separator:ae54994f461b38198510274dadbce8fb5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef94e597f85f3ee439b2ddc2b46a043a"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#aef94e597f85f3ee439b2ddc2b46a043a">write_energy</a> (u, v, h, tv, day, n, G, GV, CS, tracer_CSp)</td></tr>
<tr class="memdesc:aef94e597f85f3ee439b2ddc2b46a043a"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine calculates and writes the total model energy, the energy and mass of each layer, and other globally integrated physical quantities.  <a href="#aef94e597f85f3ee439b2ddc2b46a043a">More...</a><br /></td></tr>
<tr class="separator:aef94e597f85f3ee439b2ddc2b46a043a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae7c7909f04b1590f65a853f4e07e29ea"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#ae7c7909f04b1590f65a853f4e07e29ea">accumulate_net_input</a> (fluxes, state, dt, G, CS)</td></tr>
<tr class="memdesc:ae7c7909f04b1590f65a853f4e07e29ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine accumates the net input of volume, and perhaps later salt and heat, through the ocean surface for use in diagnosing conservation.  <a href="#ae7c7909f04b1590f65a853f4e07e29ea">More...</a><br /></td></tr>
<tr class="separator:ae7c7909f04b1590f65a853f4e07e29ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6be0bb6885b7df65618f4039d493f5c7"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a6be0bb6885b7df65618f4039d493f5c7">depth_list_setup</a> (G, CS)</td></tr>
<tr class="memdesc:a6be0bb6885b7df65618f4039d493f5c7"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine sets up an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. This might be read from a previously created file or it might be created anew. (For now only new creation occurs.  <a href="#a6be0bb6885b7df65618f4039d493f5c7">More...</a><br /></td></tr>
<tr class="separator:a6be0bb6885b7df65618f4039d493f5c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1db5001777c2171a7f3f16122b4bacd1"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a1db5001777c2171a7f3f16122b4bacd1">create_depth_list</a> (G, CS)</td></tr>
<tr class="memdesc:a1db5001777c2171a7f3f16122b4bacd1"><td class="mdescLeft">&#160;</td><td class="mdescRight">create_depth_list makes an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth.  <a href="#a1db5001777c2171a7f3f16122b4bacd1">More...</a><br /></td></tr>
<tr class="separator:a1db5001777c2171a7f3f16122b4bacd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0dc24305437100a7d073a489ff531ec1"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a0dc24305437100a7d073a489ff531ec1">write_depth_list</a> (G, CS, filename, list_size)</td></tr>
<tr class="memdesc:a0dc24305437100a7d073a489ff531ec1"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine writes out the depth list to the specified file.  <a href="#a0dc24305437100a7d073a489ff531ec1">More...</a><br /></td></tr>
<tr class="separator:a0dc24305437100a7d073a489ff531ec1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a451f9101467634477df735d1699b538c"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a451f9101467634477df735d1699b538c">read_depth_list</a> (G, CS, filename)</td></tr>
<tr class="memdesc:a451f9101467634477df735d1699b538c"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine reads in the depth list to the specified file and allocates and sets up CSDL and CSlist_size .  <a href="#a451f9101467634477df735d1699b538c">More...</a><br /></td></tr>
<tr class="separator:a451f9101467634477df735d1699b538c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a5191c3198dcd24f50da9279ce7ebbc60"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemom__sum__output.html#a5191c3198dcd24f50da9279ce7ebbc60">num_fields</a> = 17</td></tr>
<tr class="separator:a5191c3198dcd24f50da9279ce7ebbc60"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="ae7c7909f04b1590f65a853f4e07e29ea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae7c7909f04b1590f65a853f4e07e29ea">&#9670;&nbsp;</a></span>accumulate_net_input()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::accumulate_net_input </td>
          <td>(</td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(surface), intent(in)&#160;</td>
          <td class="paramname"><em>state</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine accumates the net input of volume, and perhaps later salt and heat, through the ocean surface for use in diagnosing conservation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>A structure containing pointers to any possible forcing fields. Unused fields are unallocated.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>The amount of time over which to average, in s.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00890">890</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  <span class="keywordtype">type</span>(forcing),         <span class="keywordtype">intent(in)</span> :: fluxes<span class="comment"> !&lt; A structure containing pointers to any possible forcing fields.  Unused fields are unallocated.</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  <span class="keywordtype">type</span>(surface),         <span class="keywordtype">intent(in)</span> :: state</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span> :: dt<span class="comment">     !&lt; The amount of time over which to average, in s.</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span> :: g<span class="comment">      !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),   <span class="keywordtype">pointer</span>    :: cs<span class="comment">     !&lt; The control structure returned by a previous call to MOM_sum_output_init.</span></div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment">! This subroutine accumates the net input of volume, and perhaps later salt and</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="comment">! heat, through the ocean surface for use in diagnosing conservation.</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="comment">! Arguments: fluxes - A structure containing pointers to any possible</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;<span class="comment">!                     forcing fields.  Unused fields are unallocated.</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;<span class="comment">!  (in)      dt - The amount of time over which to average.</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="comment">!                 MOM_sum_output_init.</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    fw_in, &amp;   <span class="comment">! The net fresh water input, integrated over a timestep in kg.</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    salt_in, &amp; <span class="comment">! The total salt added by surface fluxes, integrated</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;               <span class="comment">! over a time step in ppt*kg.</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    heat_in    <span class="comment">! The total heat added by surface fluxes, integrated</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;               <span class="comment">! over a time step in Joules.</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;  <span class="keywordtype">real</span> :: fw_input   <span class="comment">! The net fresh water input, integrated over a timestep</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                     <span class="comment">! and summed over space, in kg.</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="keywordtype">real</span> :: salt_input <span class="comment">! The total salt added by surface fluxes, integrated</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                     <span class="comment">! over a time step and summed over space, in ppt * kg.</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  <span class="keywordtype">real</span> :: heat_input <span class="comment">! The total heat added by boundary fluxes, integrated</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                     <span class="comment">! over a time step and summed over space, in Joules.</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;  <span class="keywordtype">real</span> :: c_p        <span class="comment">! The heat capacity of seawater, in J K-1 kg-1.</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordtype">type</span>(efp_type) :: &amp;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    fw_in_efp,      &amp;  <span class="comment">! Extended fixed point versions of FW_input, salt_input, and</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    salt_in_efp,    &amp;  <span class="comment">! heat_input, in kg, ppt*kg, and Joules.</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    heat_in_efp</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  <span class="keywordtype">real</span> :: inputs(3)   <span class="comment">! A mixed array for combining the sums</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keywordtype">integer</span> :: i, j, is, ie, js, je</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  c_p = fluxes%C_p</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  fw_in(:,:) = 0.0 ; fw_input = 0.0</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%evap)) <span class="keywordflow">then</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%lprec) .and. <span class="keyword">ASSOCIATED</span>(fluxes%fprec)) <span class="keywordflow">then</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        fw_in(i,j) = dt*g%areaT(i,j)*(fluxes%evap(i,j) + &amp;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;            (((fluxes%lprec(i,j) + fluxes%vprec(i,j)) + fluxes%lrunoff(i,j)) + &amp;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;              (fluxes%fprec(i,j) + fluxes%frunoff(i,j))))</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;      <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <span class="stringliteral">&quot;accumulate_net_input called with associated evap field, but no precip field.&quot;</span>)</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  salt_in(:,:) = 0.0 ; heat_in(:,:) = 0.0</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%sw)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;      heat_in(i,j) = heat_in(i,j) + dt*g%areaT(i,j) * (fluxes%sw(i,j) + &amp;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;             (fluxes%lw(i,j) + (fluxes%latent(i,j) + fluxes%sens(i,j))))</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">! smg: new code</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">! include heat content from water transport across ocean surface</span></div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment">!    if (ASSOCIATED(fluxes%heat_content_lprec)) then ; do j=js,je ; do i=is,ie</span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="comment">!      heat_in(i,j) = heat_in(i,j) + dt*G%areaT(i,j) *                          &amp;</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;<span class="comment">!         (fluxes%heat_content_lprec(i,j)   + (fluxes%heat_content_fprec(i,j)   &amp;</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="comment">!       + (fluxes%heat_content_lrunoff(i,j) + (fluxes%heat_content_frunoff(i,j) &amp;</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment">!       + (fluxes%heat_content_cond(i,j)    + (fluxes%heat_content_vprec(i,j)   &amp;</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="comment">!       +  fluxes%heat_content_massout(i,j)))))))</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment">!    enddo ; enddo ; endif</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="comment">! smg: old code</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(state%TempxPmE)) <span class="keywordflow">then</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * g%areaT(i,j)) * state%TempxPmE(i,j)</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keywordflow">elseif</span> (<span class="keyword">ASSOCIATED</span>(fluxes%evap)) <span class="keywordflow">then</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * state%SST(i,j)) * fw_in(i,j)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="comment">! The following heat sources may or may not be used.</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(state%internal_heat)) <span class="keywordflow">then</span></div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        heat_in(i,j) = heat_in(i,j) + (c_p * g%areaT(i,j)) * &amp;</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                     state%internal_heat(i,j)</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(state%frazil)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;      heat_in(i,j) = heat_in(i,j) + g%areaT(i,j) * state%frazil(i,j)</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%heat_added)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;      heat_in(i,j) = heat_in(i,j) + dt*g%areaT(i,j)*fluxes%heat_added(i,j)</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment">!    if (ASSOCIATED(state%sw_lost)) then ; do j=js,je ; do i=is,ie</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">!      heat_in(i,j) = heat_in(i,j) - G%areaT(i,j) * state%sw_lost(i,j)</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">!    enddo ; enddo ; endif</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">ASSOCIATED</span>(fluxes%salt_flux)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;      <span class="comment">! convert salt_flux from kg (salt)/(m^2 s) to ppt * (m/s).</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;      salt_in(i,j) = dt*g%areaT(i,j)*(1000.0*fluxes%salt_flux(i,j))</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <span class="keywordflow">if</span> ((cs%use_temperature) .or. <span class="keyword">ASSOCIATED</span>(fluxes%lprec) .or. &amp;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;      <span class="keyword">ASSOCIATED</span>(fluxes%evap)) <span class="keywordflow">then</span></div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    fw_input   = reproducing_sum(fw_in,   efp_sum=fw_in_efp)</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    heat_input = reproducing_sum(heat_in, efp_sum=heat_in_efp)</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    salt_input = reproducing_sum(salt_in, efp_sum=salt_in_efp)</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    cs%fresh_water_input = cs%fresh_water_input + fw_input</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    cs%net_salt_input    = cs%net_salt_input    + salt_input</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    cs%net_heat_input    = cs%net_heat_input    + heat_input</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    cs%fresh_water_in_EFP = cs%fresh_water_in_EFP + fw_in_efp</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    cs%net_salt_in_EFP    = cs%net_salt_in_EFP    + salt_in_efp</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    cs%net_heat_in_EFP    = cs%net_heat_in_EFP    + heat_in_efp</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_ae7c7909f04b1590f65a853f4e07e29ea_cgraph.svg" width="591" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_ae7c7909f04b1590f65a853f4e07e29ea_icgraph.svg" width="347" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1db5001777c2171a7f3f16122b4bacd1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1db5001777c2171a7f3f16122b4bacd1">&#9670;&nbsp;</a></span>create_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::create_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>create_depth_list makes an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure set up in MOM_sum_output_init, in which the ordered depth list is stored. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01050">1050</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01018">depth_list_setup()</a>.</p>
<div class="fragment"><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span> :: g<span class="comment">  !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),   <span class="keywordtype">pointer</span>    :: cs<span class="comment"> !&lt; The control structure set up in MOM_sum_output_init,</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">                                          !! in which the ordered depth list is stored.</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(G%Domain%niglobal*G%Domain%njglobal + 1)</span> :: &amp;</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    dlist, &amp;  !&lt; The global list of bottom depths, in m.</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    arealist<span class="comment">  !&lt; The global list of cell areas, in m2.</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(G%Domain%niglobal*G%Domain%njglobal+1)</span> :: &amp;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    indx2<span class="comment">     !&lt; The position of an element in the original unsorted list.</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  <span class="keywordtype">real</span>    :: dnow<span class="comment">  !&lt; The depth now being considered for sorting, in m.</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  <span class="keywordtype">real</span>    :: dprev<span class="comment"> !&lt; The most recent depth that was considered, in m.</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  <span class="keywordtype">real</span>    :: vol<span class="comment">   !&lt; The running sum of open volume below a deptn, in m3.</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordtype">real</span>    :: area<span class="comment">  !&lt; The open area at the current depth, in m2.</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  <span class="keywordtype">real</span>    :: d_list_prev<span class="comment"> !&lt; The most recent depth added to the list, in m.</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordtype">logical</span> :: add_to_list<span class="comment"> !&lt; This depth should be included as an entry on the list.</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;  <span class="keywordtype">integer</span> :: ir, indxt</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  <span class="keywordtype">integer</span> :: mls, list_size</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  <span class="keywordtype">integer</span> :: list_pos, i_global, j_global</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, kl</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  mls = g%Domain%niglobal*g%Domain%njglobal</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="comment">! Need to collect the global data from compute domains to a 1D array for sorting.</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  dlist(:) = 0.0</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  arealist(:) = 0.0</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  <span class="keywordflow">do</span> j=g%jsc,g%jec ; <span class="keywordflow">do</span> i=g%isc,g%iec</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;    <span class="comment">! Set global indices that start the global domain at 1 (Fortran convention).</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    j_global = j + g%jdg_offset - (g%jsg-1)</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    i_global = i + g%idg_offset - (g%isg-1)</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    list_pos = (j_global-1)*g%Domain%niglobal + i_global</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    dlist(list_pos) = g%bathyT(i,j)</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    arealist(list_pos) = g%mask2dT(i,j)*g%areaT(i,j)</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <span class="comment">! These sums reproduce across PEs because the arrays are only nonzero on one PE.</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  <span class="keyword">call </span>sum_across_pes(dlist, mls+1)</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;  <span class="keyword">call </span>sum_across_pes(arealist, mls+1)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;  <span class="keywordflow">do</span> j=1,mls+1 ; indx2(j) = j ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;  k = mls / 2  + 1 ; ir = mls</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;  <span class="keywordflow">do</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="keywordflow">if</span> (k &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;      k = k - 1</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;      indxt = indx2(k)</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;      dnow = dlist(indxt)</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;      indxt = indx2(ir)</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      dnow = dlist(indxt)</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      indx2(ir) = indx2(1)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;      ir = ir - 1</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      <span class="keywordflow">if</span> (ir == 1) <span class="keywordflow">then</span> ; indx2(1) = indxt ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    i=k ; j=k*2</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keywordflow">do</span> ; <span class="keywordflow">if</span> (j &gt; ir) <span class="keywordflow">exit</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      <span class="keywordflow">if</span> (j &lt; ir .AND. dlist(indx2(j)) &lt; dlist(indx2(j+1))) j = j + 1</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      <span class="keywordflow">if</span> (dnow &lt; dlist(indx2(j))) <span class="keywordflow">then</span> ; indx2(i) = indx2(j) ; i = j ; j = j + i</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;      <span class="keywordflow">else</span> ; j = ir+1 ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    indx2(i) = indxt</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;<span class="comment">!  At this point, the lists should perhaps be culled to save memory.</span></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="comment">! Culling: (1) identical depths (e.g. land) - take the last one.</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="comment">!          (2) the topmost and bottommost depths are always saved.</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;<span class="comment">!          (3) very close depths</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="comment">!          (4) equal volume changes.</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="comment">! Count the unique elements in the list.</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  d_list_prev = dlist(indx2(mls))</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  list_size = 2</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keywordflow">do</span> k=mls-1,1,-1</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> (dlist(indx2(k)) &lt; d_list_prev-cs%D_list_min_inc) <span class="keywordflow">then</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;      list_size = list_size + 1</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;      d_list_prev = dlist(indx2(k))</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;  cs%list_size = list_size</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="keyword">allocate</span>(cs%DL(cs%list_size+1))</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;  vol = 0.0 ; area = 0.0</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;  dprev = dlist(indx2(mls))</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;  d_list_prev = dprev</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  kl = 0</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordflow">do</span> k=mls,1,-1</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    i = indx2(k)</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    vol = vol + area * (dprev - dlist(i))</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    area = area + arealist(i)</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    add_to_list = .false.</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    <span class="keywordflow">if</span> ((kl == 0) .or. (k==1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      add_to_list = .true.</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    <span class="keywordflow">elseif</span> (dlist(indx2(k-1)) &lt; d_list_prev-cs%D_list_min_inc) <span class="keywordflow">then</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      add_to_list = .true.</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      d_list_prev = dlist(indx2(k-1))</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <span class="keywordflow">if</span> (add_to_list) <span class="keywordflow">then</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      kl = kl+1</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      cs%DL(kl)%depth = dlist(i)</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;      cs%DL(kl)%area = area</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      cs%DL(kl)%vol_below = vol</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    dprev = dlist(i)</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  <span class="keywordflow">do</span> <span class="keywordflow">while</span> (kl &lt; list_size)</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="comment">! I don&#39;t understand why this is needed... RWH</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    kl = kl+1</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    cs%DL(kl)%vol_below = cs%DL(kl-1)%vol_below * 1.000001</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    cs%DL(kl)%area = cs%DL(kl-1)%area</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    cs%DL(kl)%depth = cs%DL(kl-1)%depth</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  cs%DL(cs%list_size+1)%vol_below = cs%DL(cs%list_size)%vol_below * 1000.0</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  cs%DL(cs%list_size+1)%area = cs%DL(cs%list_size)%area</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  cs%DL(cs%list_size+1)%depth = cs%DL(cs%list_size)%depth</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a1db5001777c2171a7f3f16122b4bacd1_icgraph.svg" width="100%" height="378"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a6be0bb6885b7df65618f4039d493f5c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6be0bb6885b7df65618f4039d493f5c7">&#9670;&nbsp;</a></span>depth_list_setup()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::depth_list_setup </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine sets up an ordered list of depths, along with the cross sectional areas at each depth and the volume of fluid deeper than each depth. This might be read from a previously created file or it might be created anew. (For now only new creation occurs. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01018">1018</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l01050">create_depth_list()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00049">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, <a class="el" href="MOM__sum__output_8F90_source.html#l01257">read_depth_list()</a>, and <a class="el" href="MOM__sum__output_8F90_source.html#l01175">write_depth_list()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l00164">mom_sum_output_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),   <span class="keywordtype">pointer</span>    :: cs</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="comment">!  This subroutine sets up an ordered list of depths, along with the</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="comment">! cross sectional areas at each depth and the volume of fluid deeper</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="comment">! than each depth.  This might be read from a previously created file</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="comment">! or it might be created anew.  (For now only new creation occurs.</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;  <span class="keywordflow">if</span> (cs%read_depth_list) <span class="keywordflow">then</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="keywordflow">if</span> (file_exists(cs%depth_list_file)) <span class="keywordflow">then</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;      <span class="keyword">call </span>read_depth_list(g, cs, cs%depth_list_file)</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="keywordflow">if</span> (is_root_pe()) <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;depth_list_setup: &quot;</span>// &amp;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        trim(cs%depth_list_file)//<span class="stringliteral">&quot; does not exist.  Creating a new file.&quot;</span>)</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      <span class="keyword">call </span>create_depth_list(g, cs)</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;      <span class="keyword">call </span>write_depth_list(g, cs, cs%depth_list_file, cs%list_size+1)</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <span class="keyword">call </span>create_depth_list(g, cs)</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;  <span class="keywordflow">do</span> k=1,g%ke</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    cs%lH(k) = cs%list_size</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a6be0bb6885b7df65618f4039d493f5c7_cgraph.svg" width="100%" height="514"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a6be0bb6885b7df65618f4039d493f5c7_icgraph.svg" width="611" height="104"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ae54994f461b38198510274dadbce8fb5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae54994f461b38198510274dadbce8fb5">&#9670;&nbsp;</a></span>mom_sum_output_end()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::mom_sum_output_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00286">286</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs), <span class="keywordtype">pointer</span> :: cs</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">!   This subroutine deallocates the memory owned by this module.</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">! Argument: CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">!                MOM_sum_output_init.</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      dealloc_(cs%lH)</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keyword">deallocate</span>(cs%DL)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordflow">  endif</span></div></div><!-- fragment -->
</div>
</div>
<a id="ab1d2eb6c53a3cdd079ff60f82691fccb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab1d2eb6c53a3cdd079ff60f82691fccb">&#9670;&nbsp;</a></span>mom_sum_output_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::mom_sum_output_init </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>directory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout), target&#160;</td>
          <td class="paramname"><em>ntrnc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Input_start_time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>A structure to parse for run-time parameters.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">directory</td><td>The directory where the energy file goes.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ntrnc</td><td>The integer that stores the number of times the velocity has been truncated since the last call to write_energy.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_start_time</td><td>The start time of the simulation.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>A pointer that is set to point to the control structure for this module. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00164">164</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__sum__output_8F90_source.html#l01018">depth_list_setup()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>, and <a class="el" href="ocean__model__MOM_8F90_source.html#l00203">ocean_model_mod::ocean_model_init()</a>.</p>
<div class="fragment"><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),  <span class="keywordtype">intent(in)</span>    :: g<span class="comment">          !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordtype">type</span>(param_file_type),  <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; A structure to parse for run-time</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">                                                      !! parameters.</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordtype">character(len=*)</span>,       <span class="keywordtype">intent(in)</span>    :: directory<span class="comment">  !&lt; The directory where the energy file goes.</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>,        <span class="keywordtype">intent(inout)</span> :: ntrnc<span class="comment">      !&lt; The integer that stores the number of times</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">                                                      !! the velocity has been truncated since the</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">                                                      !! last call to write_energy.</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keywordtype">type</span>(time_type),        <span class="keywordtype">intent(in)</span>    :: input_start_time<span class="comment"> !&lt; The start time of the simulation.</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),    <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; A pointer that is set to point to the</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">                                                      !! control structure for this module.</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">! Arguments: G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">!  (in)      param_file - A structure indicating the open file to parse for</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">!                         model parameter values.</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">!  (in)      directory - The directory where the energy file goes.</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">!  (in/out)  ntrnc - The integer that stores the number of times the velocity</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">!                     has been truncated since the last call to write_energy.</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">!  (in)      Input_start_time - The start time of the simulation.</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">!  (in/out)  CS - A pointer that is set to point to the control structure</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">!                 for this module</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordtype">real</span> :: rho_0, maxvel</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mdl = <span class="stringliteral">&quot;MOM_sum_output&quot;</span> <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordtype">character(len=200)</span> :: energyfile  <span class="comment">! The name of the energy file.</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keywordtype">character(len=32)</span> :: filename_appendix = <span class="stringliteral">&#39;&#39;</span> <span class="comment">!fms appendix to filename for ensemble runs</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;MOM_sum_output_init called with associated control structure.&quot;</span>)</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keyword">call </span>log_version(param_file, mdl, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;CALCULATE_APE&quot;</span>, cs%do_APE_calc, &amp;</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                 <span class="stringliteral">&quot;If true, calculate the available potential energy of \n&quot;</span>//&amp;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                 <span class="stringliteral">&quot;the interfaces.  Setting this to false reduces the \n&quot;</span>//&amp;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                 <span class="stringliteral">&quot;memory footprint of high-PE-count models dramatically.&quot;</span>, &amp;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                 default=.true.)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;WRITE_STOCKS&quot;</span>, cs%write_stocks, &amp;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                 <span class="stringliteral">&quot;If true, write the integrated tracer amounts to stdout \n&quot;</span>//&amp;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                 <span class="stringliteral">&quot;when the energy files are written.&quot;</span>, default=.true.)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENABLE_THERMODYNAMICS&quot;</span>, cs%use_temperature, &amp;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                 <span class="stringliteral">&quot;If true, Temperature and salinity are used as state \n&quot;</span>//&amp;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                 <span class="stringliteral">&quot;variables.&quot;</span>, default=.true.)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DT&quot;</span>, cs%dt, &amp;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                 <span class="stringliteral">&quot;The (baroclinic) dynamics time step.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>, &amp;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                 fail_if_missing=.true.)</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXTRUNC&quot;</span>, cs%maxtrunc, &amp;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                 <span class="stringliteral">&quot;The run will be stopped, and the day set to a very \n&quot;</span>//&amp;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                 <span class="stringliteral">&quot;large value if the velocity is truncated more than \n&quot;</span>//&amp;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                 <span class="stringliteral">&quot;MAXTRUNC times between energy saves.  Set MAXTRUNC to 0 \n&quot;</span>//&amp;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                 <span class="stringliteral">&quot;to stop if there is any truncation of velocities.&quot;</span>, &amp;</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                 units=<span class="stringliteral">&quot;truncations save_interval-1&quot;</span>, default=0)</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAX_ENERGY&quot;</span>, cs%max_Energy, &amp;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                 <span class="stringliteral">&quot;The maximum permitted average energy per unit mass; the \n&quot;</span>//&amp;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                 <span class="stringliteral">&quot;model will be stopped if there is more energy than \n&quot;</span>//&amp;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;                 <span class="stringliteral">&quot;this.  If zero or negative, this is set to 10*MAXVEL^2.&quot;</span>, &amp;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-2&quot;</span>, default=0.0)</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordflow">if</span> (cs%max_Energy &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;MAXVEL&quot;</span>, maxvel, &amp;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                 <span class="stringliteral">&quot;The maximum velocity allowed before the velocity \n&quot;</span>//&amp;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                 <span class="stringliteral">&quot;components are truncated.&quot;</span>, units=<span class="stringliteral">&quot;m s-1&quot;</span>, default=3.0e8)</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    cs%max_Energy = 10.0 * maxvel**2</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keyword">call </span>log_param (param_file, mdl, <span class="stringliteral">&quot;MAX_ENERGY as used&quot;</span>, cs%max_Energy)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;ENERGYFILE&quot;</span>, energyfile, &amp;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                 <span class="stringliteral">&quot;The file to use to write the energies and globally \n&quot;</span>//&amp;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                 <span class="stringliteral">&quot;summed diagnostics.&quot;</span>, default=<span class="stringliteral">&quot;ocean.stats&quot;</span>)</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="comment">!query fms_io if there is a filename_appendix (for ensemble runs)</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="keyword">call </span>get_filename_appendix(filename_appendix)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordflow">if</span>(len_trim(filename_appendix) &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;     energyfile = trim(energyfile) //<span class="stringliteral">&#39;.&#39;</span>//trim(filename_appendix)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  cs%energyfile = trim(slasher(directory))//trim(energyfile)</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="keyword">call </span>log_param(param_file, mdl, <span class="stringliteral">&quot;output_path/ENERGYFILE&quot;</span>, cs%energyfile)</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="preprocessor">#ifdef STATSLABEL</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="preprocessor"></span>  cs%energyfile = trim(cs%energyfile)//<span class="stringliteral">&quot;.&quot;</span>//trim(adjustl(statslabel))</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DATE_STAMPED_STDOUT&quot;</span>, cs%date_stamped_output, &amp;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                 <span class="stringliteral">&quot;If true, use dates (not times) in messages to stdout&quot;</span>, &amp;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                 default=.true.)</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;TIMEUNIT&quot;</span>, cs%Timeunit, &amp;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                 <span class="stringliteral">&quot;The time unit in seconds a number of input fields&quot;</span>, &amp;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                 units=<span class="stringliteral">&quot;s&quot;</span>, default=86400.0)</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="keywordflow">if</span> (cs%Timeunit &lt; 0.0) cs%Timeunit = 86400.0</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;READ_DEPTH_LIST&quot;</span>, cs%read_depth_list, &amp;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                   <span class="stringliteral">&quot;Read the depth list from a file if it exists or \n&quot;</span>//&amp;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                   <span class="stringliteral">&quot;create that file otherwise.&quot;</span>, default=.false.)</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEPTH_LIST_MIN_INC&quot;</span>, cs%D_list_min_inc, &amp;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                   <span class="stringliteral">&quot;The minimum increment between the depths of the \n&quot;</span>//&amp;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                   <span class="stringliteral">&quot;entries in the depth-list file.&quot;</span>, units=<span class="stringliteral">&quot;m&quot;</span>, &amp;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                   default=1.0e-10)</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordflow">if</span> (cs%read_depth_list) <span class="keywordflow">then</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;      <span class="keyword">call </span>get_param(param_file, mdl, <span class="stringliteral">&quot;DEPTH_LIST_FILE&quot;</span>, cs%depth_list_file, &amp;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                   <span class="stringliteral">&quot;The name of the depth list file.&quot;</span>, default=<span class="stringliteral">&quot;Depth_list.nc&quot;</span>)</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      <span class="keywordflow">if</span> (scan(cs%depth_list_file,<span class="stringliteral">&#39;/&#39;</span>) == 0) &amp;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        cs%depth_list_file = trim(slasher(directory))//trim(cs%depth_list_file)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    alloc_(cs%lH(g%ke))</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keyword">call </span>depth_list_setup(g, cs)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    cs%list_size = 0</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  cs%Huge_time = set_time(int(1e9),0)</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  cs%Start_time = input_start_time</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  cs%ntrunc =&gt; ntrnc</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_ab1d2eb6c53a3cdd079ff60f82691fccb_cgraph.svg" width="100%" height="496"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_ab1d2eb6c53a3cdd079ff60f82691fccb_icgraph.svg" width="396" height="104"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a451f9101467634477df735d1699b538c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a451f9101467634477df735d1699b538c">&#9670;&nbsp;</a></span>read_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::read_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>filename</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine reads in the depth list to the specified file and allocates and sets up CSDL and CSlist_size . </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01257">1257</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01018">depth_list_setup()</a>.</p>
<div class="fragment"><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),   <span class="keywordtype">pointer</span>    :: cs</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span> :: filename</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="comment">! This subroutine reads in the depth list to the specified file</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="comment">! and allocates and sets up CS%DL and CS%list_size .</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  <span class="keywordtype">character(len=32)</span> :: mdl</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="keywordtype">character(len=240)</span> :: var_name, var_msg</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">allocatable</span> :: tmp(:)</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="keywordtype">integer</span> :: ncid, status, varid, list_size, k</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;  <span class="keywordtype">integer</span> :: ndim, len, var_dim_ids(nf90_max_var_dims)</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;  mdl = <span class="stringliteral">&quot;MOM_sum_output read_depth_list:&quot;</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  status = nf90_open(filename, nf90_nowrite, ncid);</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; Difficulties opening &quot;</span>//trim(filename)// &amp;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <span class="stringliteral">&quot; - &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  var_name = <span class="stringliteral">&quot;depth&quot;</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  status = nf90_inquire_variable(ncid, varid, ndims=ndim, dimids=var_dim_ids)</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; cannot inquire about &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;  <span class="keywordflow">elseif</span> (ndim &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="keyword">call </span>mom_error(fatal,mdl//<span class="stringliteral">&quot; &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;         <span class="stringliteral">&quot; has too many or too few dimensions.&quot;</span>)</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  <span class="comment">! Get the length of the list.</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  status = nf90_inquire_dimension(ncid, var_dim_ids(1), len=list_size)</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="stringliteral">&quot; cannot inquire about dimension(1) of &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;  cs%list_size = list_size-1</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;  <span class="keyword">allocate</span>(cs%DL(list_size))</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;  <span class="keyword">allocate</span>(tmp(list_size))</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%depth = tmp(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;  var_name = <span class="stringliteral">&quot;area&quot;</span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%area = tmp(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;  var_name = <span class="stringliteral">&quot;vol_below&quot;</span></div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  var_msg = trim(var_name)//<span class="stringliteral">&quot; in &quot;</span>//trim(filename)</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  status = nf90_inq_varid(ncid, var_name, varid)</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <span class="stringliteral">&quot; Difficulties finding variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  status = nf90_get_var(ncid, varid, tmp)</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(fatal,mdl// &amp;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="stringliteral">&quot; Difficulties reading variable &quot;</span>//trim(var_msg)//&amp;</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        trim(nf90_strerror(status)))</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; cs%DL(k)%vol_below = tmp(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  status = nf90_close(ncid)</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, mdl// &amp;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    <span class="stringliteral">&quot; Difficulties closing &quot;</span>//trim(filename)//<span class="stringliteral">&quot; - &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;  <span class="keyword">deallocate</span>(tmp)</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a451f9101467634477df735d1699b538c_cgraph.svg" width="548" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a451f9101467634477df735d1699b538c_icgraph.svg" width="100%" height="378"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="a0dc24305437100a7d073a489ff531ec1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0dc24305437100a7d073a489ff531ec1">&#9670;&nbsp;</a></span>write_depth_list()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_sum_output::write_depth_list </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>filename</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>list_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine writes out the depth list to the specified file. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l01175">1175</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__error__handler_8F90_source.html#l00049">mom_error_handler::is_root_pe()</a>, and <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__sum__output_8F90_source.html#l01018">depth_list_setup()</a>.</p>
<div class="fragment"><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>), <span class="keywordtype">intent(in)</span> :: g<span class="comment">    !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),   <span class="keywordtype">pointer</span>    :: cs</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span> :: filename</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span> :: list_size</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="comment">! This subroutine writes out the depth list to the specified file.</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">allocatable</span> :: tmp(:)</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  <span class="keywordtype">integer</span> :: ncid, dimid(1), did, aid, vid, status, k</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="keywordflow">if</span> (.not.is_root_pe()) <span class="keywordflow">return</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keyword">allocate</span>(tmp(list_size)) ; tmp(:) = 0.0</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  status = nf90_create(filename, 0, ncid)</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keywordflow">then</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keyword">call </span>mom_error(warning, filename//trim(nf90_strerror(status)))</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  status = nf90_def_dim(ncid, <span class="stringliteral">&quot;list&quot;</span>, list_size, dimid(1))</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;      filename//trim(nf90_strerror(status)))</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;depth&quot;</span>, nf90_double, dimid, did)</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  status = nf90_put_att(ncid, did, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Sorted depth&quot;</span>)</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;  status = nf90_put_att(ncid, did, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m&quot;</span>)</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;area&quot;</span>, nf90_double, dimid, aid)</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;  status = nf90_put_att(ncid, aid, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Open area at depth&quot;</span>)</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;  status = nf90_put_att(ncid, aid, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m2&quot;</span>)</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  status = nf90_def_var(ncid, <span class="stringliteral">&quot;vol_below&quot;</span>, nf90_double, dimid, vid)</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  status = nf90_put_att(ncid, vid, <span class="stringliteral">&quot;long_name&quot;</span>, <span class="stringliteral">&quot;Open volume below depth&quot;</span>)</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;   <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;  status = nf90_put_att(ncid, vid, <span class="stringliteral">&quot;units&quot;</span>, <span class="stringliteral">&quot;m3&quot;</span>)</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  status = nf90_enddef(ncid)</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;      filename//trim(nf90_strerror(status)))</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = cs%DL(k)%depth ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  status = nf90_put_var(ncid, did, tmp)</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;      filename//<span class="stringliteral">&quot; depth &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = cs%DL(k)%area ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  status = nf90_put_var(ncid, aid, tmp)</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;      filename//<span class="stringliteral">&quot; area &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="keywordflow">do</span> k=1,list_size ; tmp(k) = cs%DL(k)%vol_below ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  status = nf90_put_var(ncid, vid, tmp)</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;      filename//<span class="stringliteral">&quot; vol_below &quot;</span>//trim(nf90_strerror(status)))</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  status = nf90_close(ncid)</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  <span class="keywordflow">if</span> (status /= nf90_noerr) <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;      filename//trim(nf90_strerror(status)))</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a0dc24305437100a7d073a489ff531ec1_cgraph.svg" width="552" height="82"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_a0dc24305437100a7d073a489ff531ec1_icgraph.svg" width="100%" height="378"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="aef94e597f85f3ee439b2ddc2b46a043a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aef94e597f85f3ee439b2ddc2b46a043a">&#9670;&nbsp;</a></span>write_energy()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_sum_output::write_energy </td>
          <td>(</td>
          <td class="paramtype">real, dimension( g %isdb: g %iedb, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsdb: g %jedb, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension( g %isd: g %ied, g %jsd: g %jed, g %ke), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(time_type), intent(inout)&#160;</td>
          <td class="paramname"><em>day</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="structmom__sum__output_1_1sum__output__cs.html">sum_output_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_flow_control_cs), optional, pointer&#160;</td>
          <td class="paramname"><em>tracer_CSp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine calculates and writes the total model energy, the energy and mass of each layer, and other globally integrated physical quantities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>The ocean's grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>The ocean's vertical grid structure.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">u</td><td>The zonal velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">v</td><td>The meridional velocity, in m s-1.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H (usually m or kg m-2).</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure pointing to various thermodynamic variables.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">day</td><td>The current model time.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n</td><td>The time step number of the current execution.</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>The control structure returned by a previous call to MOM_sum_output_init. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00305">305</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>

<p class="reference">References <a class="el" href="MOM__tracer__flow__control_8F90_source.html#l00587">mom_tracer_flow_control::call_tracer_stocks()</a>, <a class="el" href="MOM__coms_8F90_source.html#l00582">mom_coms::efp_to_real()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00049">mom_error_handler::is_root_pe()</a>, <a class="el" href="MOM__error__handler_8F90_source.html#l00073">mom_error_handler::mom_error()</a>, and <a class="el" href="MOM__coms_8F90_source.html#l00601">mom_coms::real_to_efp()</a>.</p>

<p class="reference">Referenced by <a class="el" href="MOM__driver_8F90_source.html#l00001">mom_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmom__grid_1_1ocean__grid__type.html">ocean_grid_type</a>),                     <span class="keywordtype">intent(in)</span>    :: g<span class="comment">   !&lt; The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">  !&lt; The ocean&#39;s vertical grid</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">                                                                  !! structure.</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: u<span class="comment">   !&lt; The zonal velocity, in m s-1.</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: v<span class="comment">   !&lt; The meridional velocity,</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">                                                                  !! in m s-1.</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(in)</span>    :: h<span class="comment">   !&lt; Layer thicknesses, in H</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">                                                                  !! (usually m or kg m-2).</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                     <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">  !&lt; A structure pointing to various</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">                                                                  !! thermodynamic variables.</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keywordtype">type</span>(time_type),                           <span class="keywordtype">intent(inout)</span> :: day<span class="comment"> !&lt; The current model time.</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keywordtype">integer</span>,                                   <span class="keywordtype">intent(in)</span>    :: n<span class="comment">   !&lt; The time step number of the</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">                                                                  !! current execution.</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keywordtype">type</span>(sum_output_cs),                       <span class="keywordtype">pointer</span>       :: cs<span class="comment">  !&lt; The control structure returned</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">                                                                  !! by a previous call to</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">                                                                  !! MOM_sum_output_init.</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  <span class="keywordtype">type</span>(tracer_flow_control_cs),    <span class="keywordtype">optional</span>, <span class="keywordtype">pointer</span>       :: tracer_csp</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">!  This subroutine calculates and writes the total model energy, the</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">! energy and mass of each layer, and other globally integrated</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">! physical quantities.</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">! Arguments: u - Zonal velocity, in m s-1.</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">!  (in)      v - Meridional velocity, in m s-1.</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">!  (in)      h - Layer thickness, in m.</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">!  (in)      tv - A structure containing pointers to any available</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">!                 thermodynamic fields, including potential temperature and</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">!                 salinity or mixed layer density. Absent fields have NULL ptrs.</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">!  (in/out)  day - The current model time.</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">!  (in)      n - The time step number of the current execution.</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">!  (in)      G - The ocean&#39;s grid structure.</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">!  (in)      GV - The ocean&#39;s vertical grid structure.</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">!  (in)      CS - The control structure returned by a previous call to</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">!                 MOM_sum_output_init.</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordtype">real</span> :: eta(szi_(g),szj_(g),szk_(g)+1) <span class="comment">! The height of interfaces, in m.</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordtype">real</span> :: areatm(szi_(g),szj_(g)) <span class="comment">! A masked version of areaT, in m2.</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  <span class="keywordtype">real</span> :: ke(szk_(g))  <span class="comment">! The total kinetic energy of a layer, in J.</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordtype">real</span> :: pe(szk_(g)+1)<span class="comment">! The available potential energy of an interface, in J.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordtype">real</span> :: ke_tot       <span class="comment">! The total kinetic energy, in J.</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordtype">real</span> :: pe_tot       <span class="comment">! The total available potential energy, in J.</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  <span class="keywordtype">real</span> :: h_0ape(szk_(g)+1) <span class="comment">! The uniform depth which overlies the same</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                       <span class="comment">! volume as is below an interface, in m.</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                       <span class="comment">! H is usually positive.</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keywordtype">real</span> :: toten        <span class="comment">! The total kinetic &amp; potential energies of</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                       <span class="comment">! all layers, in Joules (i.e. kg m2 s-2).</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="keywordtype">real</span> :: en_mass      <span class="comment">! The total kinetic and potential energies divided by</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                       <span class="comment">! the total mass of the ocean, in m2 s-2.</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;  <span class="keywordtype">real</span> :: vol_lay(szk_(g))  <span class="comment">! The volume of fluid in a layer, in m3.</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordtype">real</span> :: volbelow     <span class="comment">! The volume of all layers beneath an interface in m3.</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="keywordtype">real</span> :: mass_lay(szk_(g)) <span class="comment">! The mass of fluid in a layer, in kg.</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="keywordtype">real</span> :: mass_tot     <span class="comment">! The total mass of the ocean in kg.</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="keywordtype">real</span> :: vol_tot      <span class="comment">! The total ocean volume in m3.</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  <span class="keywordtype">real</span> :: mass_chg     <span class="comment">! The change in total ocean mass of fresh water since</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                       <span class="comment">! the last call to this subroutine, in kg.</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  <span class="keywordtype">real</span> :: mass_anom    <span class="comment">! The change in fresh water that cannot be accounted for</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                       <span class="comment">! by the surface fluxes, in kg.</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="keywordtype">real</span> :: salt         <span class="comment">! The total amount of salt in the ocean, in PSU kg.</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keywordtype">real</span> :: salt_chg     <span class="comment">! The change in total ocean salt since the last call</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                       <span class="comment">! to this subroutine, in PSU kg.</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordtype">real</span> :: salt_anom    <span class="comment">! The change in salt that cannot be accounted for by</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                       <span class="comment">! the surface fluxes, in PSU kg.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordtype">real</span> :: salin        <span class="comment">! The mean salinity of the ocean, in PSU.</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <span class="keywordtype">real</span> :: salin_chg    <span class="comment">! The change in total salt since the last call</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                       <span class="comment">! to this subroutine divided by total mass, in PSU.</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  <span class="keywordtype">real</span> :: salin_anom   <span class="comment">! The change in total salt that cannot be accounted for by</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                       <span class="comment">! the surface fluxes divided by total mass in PSU.</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordtype">real</span> :: salin_mass_in <span class="comment">! The mass of salt input since the last call, kg.</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordtype">real</span> :: heat         <span class="comment">! The total amount of Heat in the ocean, in Joules.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keywordtype">real</span> :: heat_chg     <span class="comment">! The change in total ocean heat since the last call</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                       <span class="comment">! to this subroutine, in Joules.</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordtype">real</span> :: heat_anom    <span class="comment">! The change in heat that cannot be accounted for by</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                       <span class="comment">! the surface fluxes, in Joules.</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordtype">real</span> :: temp         <span class="comment">! The mean potential temperature of the ocean, in C.</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordtype">real</span> :: temp_chg     <span class="comment">! The change in total heat divided by total heat capacity</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                       <span class="comment">! of the ocean since the last call to this subroutine, C.</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordtype">real</span> :: temp_anom    <span class="comment">! The change in total heat that cannot be accounted for</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                       <span class="comment">! by the surface fluxes, divided by the total heat</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                       <span class="comment">! capacity of the ocean, in C.</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordtype">real</span> :: hint         <span class="comment">! The deviation of an interface from H, in m.</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="keywordtype">real</span> :: hbot         <span class="comment">! 0 if the basin is deeper than H, or the</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                       <span class="comment">! height of the basin depth over H otherwise,</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                       <span class="comment">! in m. This makes PE only include real fluid.</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordtype">real</span> :: hbelow       <span class="comment">! The depth of fluid in all layers beneath</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                       <span class="comment">! an interface, in m.</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="keywordtype">type</span>(efp_type) :: &amp;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    mass_efp, &amp;        <span class="comment">! Extended fixed point sums of total mass, etc.</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    salt_efp, heat_efp, salt_chg_efp, heat_chg_efp, mass_chg_efp, &amp;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    mass_anom_efp, salt_anom_efp, heat_anom_efp</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordtype">real</span> :: cfl_trans    <span class="comment">! A transport-based definition of the CFL number, nondim.</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordtype">real</span> :: cfl_lin      <span class="comment">! A simpler definition of the CFL number, nondim.</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  <span class="keywordtype">real</span> :: max_cfl(2)   <span class="comment">! The maxima of the CFL numbers, nondim.</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  <span class="keywordtype">real</span> :: irho0</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    tmp1</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G)+1)</span> :: &amp;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    pe_pt</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    temp_int, salt_int</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="keywordtype">real</span> :: h_to_m, h_to_kg_m2  <span class="comment">! Local copies of unit conversion factors.</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  <span class="keywordtype">integer</span> :: num_nc_fields  <span class="comment">! The number of fields that will actually go into</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                            <span class="comment">! the NetCDF file.</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz, m, isq, ieq, jsq, jeq</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordtype">integer</span> :: l, lbelow, labove   <span class="comment">! indices of deep_area_vol, used to find</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                                 <span class="comment">! H.  lbelow &amp; labove are lower &amp; upper</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                                 <span class="comment">! limits for l in the search for lH.</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">integer</span> :: start_of_day, num_days</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordtype">real</span>    :: reday, var</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordtype">character(len=240)</span> :: energypath_nc</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordtype">character(len=200)</span> :: mesg</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keywordtype">character(len=32)</span>  :: mesg_intro, time_units, day_str, n_str, date_str</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">logical</span> :: date_stamped</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordtype">real</span> :: tr_stocks(max_fields_)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordtype">real</span> :: tr_min(max_fields_),tr_max(max_fields_)</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordtype">real</span> :: tr_min_x(max_fields_), tr_min_y(max_fields_), tr_min_z(max_fields_)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keywordtype">real</span> :: tr_max_x(max_fields_), tr_max_y(max_fields_), tr_max_z(max_fields_)</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordtype">logical</span> :: tr_minmax_got(max_fields_) = .false.</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordtype">character(len=40)</span>, <span class="keywordtype">dimension(MAX_FIELDS_)</span> :: &amp;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    tr_names, tr_units</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keywordtype">integer</span> :: ntr_stocks</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">allocatable</span> :: toten_pe(:)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordtype">integer</span> :: pe_num</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordtype">integer</span> :: iyear, imonth, iday, ihour, iminute, isecond, itick <span class="comment">! For call to get_date()</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160; <span class="comment">! A description for output of each of the fields.</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keywordtype">type</span>(vardesc) :: vars(num_fields+max_fields_)</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  num_nc_fields = 17</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">if</span> (.not.cs%use_temperature) num_nc_fields = 11</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  vars(1) = var_desc(<span class="stringliteral">&quot;Ntrunc&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Number of Velocity Truncations&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  vars(2) = var_desc(<span class="stringliteral">&quot;En&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Energy&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  vars(3) = var_desc(<span class="stringliteral">&quot;APE&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Interface APE&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;i&#39;</span>)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  vars(4) = var_desc(<span class="stringliteral">&quot;KE&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Layer KE&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;L&#39;</span>)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  vars(5) = var_desc(<span class="stringliteral">&quot;H0&quot;</span>,<span class="stringliteral">&quot;meter&quot;</span>,<span class="stringliteral">&quot;Zero APE Depth of Interface&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;i&#39;</span>)</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  vars(6) = var_desc(<span class="stringliteral">&quot;Mass_lay&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Layer Mass&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;L&#39;</span>)</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  vars(7) = var_desc(<span class="stringliteral">&quot;Mass&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Mass&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  vars(8) = var_desc(<span class="stringliteral">&quot;Mass_chg&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Mass Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  vars(9) = var_desc(<span class="stringliteral">&quot;Mass_anom&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Mass Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  vars(10) = var_desc(<span class="stringliteral">&quot;max_CFL_trans&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Maximum finite-volume CFL&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  vars(11) = var_desc(<span class="stringliteral">&quot;max_CFL_lin&quot;</span>,<span class="stringliteral">&quot;Nondim&quot;</span>,<span class="stringliteral">&quot;Maximum finite-difference CFL&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    vars(12) = var_desc(<span class="stringliteral">&quot;Salt&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Salt&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    vars(13) = var_desc(<span class="stringliteral">&quot;Salt_chg&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Total Salt Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    vars(14) = var_desc(<span class="stringliteral">&quot;Salt_anom&quot;</span>,<span class="stringliteral">&quot;kg&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Salt Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    vars(15) = var_desc(<span class="stringliteral">&quot;Heat&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Heat&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    vars(16) = var_desc(<span class="stringliteral">&quot;Heat_chg&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Total Heat Change between Entries&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    vars(17) = var_desc(<span class="stringliteral">&quot;Heat_anom&quot;</span>,<span class="stringliteral">&quot;Joules&quot;</span>,<span class="stringliteral">&quot;Anomalous Total Heat Change&quot;</span>,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = g%ke</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  h_to_m = gv%H_to_m ; h_to_kg_m2 = gv%H_to_kg_m2</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;         <span class="stringliteral">&quot;write_energy: Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    areatm(i,j) = g%mask2dT(i,j)*g%areaT(i,j)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    tmp1(:,:,:) = 0.0</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      tmp1(i,j,k) = h(i,j,k) * (h_to_kg_m2*areatm(i,j))</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    mass_tot = reproducing_sum(tmp1, sums=mass_lay, efp_sum=mass_efp)</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; vol_lay(k) = (h_to_m/h_to_kg_m2)*mass_lay(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    tmp1(:,:,:) = 0.0</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        tmp1(i,j,k) = h_to_kg_m2 * h(i,j,k) * areatm(i,j)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      mass_tot = reproducing_sum(tmp1, sums=mass_lay, efp_sum=mass_efp)</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      <span class="keyword">call </span>find_eta(h, tv, gv%g_Earth, g, gv, eta)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        tmp1(i,j,k) = (eta(i,j,k)-eta(i,j,k+1)) * areatm(i,j)</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;      vol_tot = h_to_m*reproducing_sum(tmp1, sums=vol_lay)</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        tmp1(i,j,k) = h_to_kg_m2 * h(i,j,k) * areatm(i,j)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      mass_tot = reproducing_sum(tmp1, sums=mass_lay, efp_sum=mass_efp)</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; vol_lay(k) = mass_lay(k) / gv%Rho0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="keywordflow">  endif</span> <span class="comment">! Boussinesq</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  ntr_stocks = 0</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(tracer_csp)) <span class="keywordflow">then</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keyword">call </span>call_tracer_stocks(h, tr_stocks, g, gv, tracer_csp, stock_names=tr_names, &amp;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                            stock_units=tr_units, num_stocks=ntr_stocks,&amp;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                            got_min_max=tr_minmax_got, global_min=tr_min, global_max=tr_max, &amp;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                            xgmin=tr_min_x, ygmin=tr_min_y, zgmin=tr_min_z,&amp;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                            xgmax=tr_max_x, ygmax=tr_max_y, zgmax=tr_max_z)</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">if</span> (ntr_stocks &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;      <span class="keywordflow">do</span> m=1,ntr_stocks</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        vars(num_nc_fields+m) = var_desc(tr_names(m), units=tr_units(m), &amp;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                      longname=tr_names(m), hor_grid=<span class="stringliteral">&#39;1&#39;</span>, z_grid=<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;      num_nc_fields = num_nc_fields + ntr_stocks</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <span class="keywordflow">if</span> (cs%previous_calls == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    cs%mass_prev = mass_tot ; cs%fresh_water_input = 0.0</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    cs%mass_prev_EFP = mass_efp</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    cs%fresh_water_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <span class="comment">!  Reopen or create a text output file, with an explanatory header line.</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      <span class="keywordflow">if</span> (day &gt; cs%Start_time) <span class="keywordflow">then</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keyword">call </span>open_file(cs%fileenergy_ascii, trim(cs%energyfile), &amp;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                       action=append_file, form=ascii_file, nohdrs=.true.)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="keyword">call </span>open_file(cs%fileenergy_ascii, trim(cs%energyfile), &amp;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                       action=writeonly_file, form=ascii_file, nohdrs=.true.)</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="keywordflow">if</span> (abs(cs%timeunit - 86400.0) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;          <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Day,  Truncs,      &amp;</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean Sea Level,  Total Mass,  Mean Salin, &amp;</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Mean Temp, Frac Mass Err,   Salin Err,    Temp Err&quot;)&#39;</span>)</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(12x,&quot;[days]&quot;,17x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,7x,&quot;[m]&quot;,13x,&amp;</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,9x,&quot;[PSU]&quot;,6x,&quot;[degC]&quot;,7x,&quot;[Nondim]&quot;,8x,&quot;[PSU]&quot;,8x,&quot;[degC]&quot;)&#39;</span>)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Day,  Truncs,      &amp;</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean sea level,   Total Mass,    Frac Mass Err&quot;)&#39;</span>)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(12x,&quot;[days]&quot;,17x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,8x,&quot;[m]&quot;,13x,&amp;</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,11x,&quot;[Nondim]&quot;)&#39;</span>)</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;          <span class="keywordflow">if</span> ((cs%timeunit &gt;= 0.99) .and. (cs%timeunit &lt; 1.01)) <span class="keywordflow">then</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            time_units = <span class="stringliteral">&quot;           [seconds]     &quot;</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cs%timeunit &gt;= 3599.0) .and. (cs%timeunit &lt; 3601.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            time_units = <span class="stringliteral">&quot;            [hours]      &quot;</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cs%timeunit &gt;= 86399.0) .and. (cs%timeunit &lt; 86401.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;            time_units = <span class="stringliteral">&quot;             [days]      &quot;</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cs%timeunit &gt;= 3.0e7) .and. (cs%timeunit &lt; 3.2e7)) <span class="keywordflow">then</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            time_units = <span class="stringliteral">&quot;            [years]      &quot;</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;            <span class="keyword">write</span>(time_units,<span class="stringliteral">&#39;(9x,&quot;[&quot;,es8.2,&quot; s]    &quot;)&#39;</span>) cs%timeunit</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;          <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Time, Truncs,      &amp;</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean Sea Level,  Total Mass,  Mean Salin, &amp;</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Mean Temp, Frac Mass Err,   Salin Err,    Temp Err&quot;)&#39;</span>)</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A25,10x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,7x,&quot;[m]&quot;,13x,&amp;</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,9x,&quot;[PSU]&quot;,6x,&quot;[degC]&quot;,7x,&quot;[Nondim]&quot;,8x,&quot;[PSU]&quot;,6x,&amp;</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[degC]&quot;)&#39;</span>) time_units</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(&quot;  Step,&quot;,7x,&quot;Time, Truncs,      &amp;</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;Energy/Mass,      Maximum CFL,  Mean sea level,   Total Mass,    Frac Mass Err&quot;)&#39;</span>)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A25,10x,&quot;[m2 s-2]&quot;,11x,&quot;[Nondim]&quot;,8x,&quot;[m]&quot;,13x,&amp;</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp;&quot;[kg]&quot;,11x,&quot;[Nondim]&quot;)&#39;</span>) time_units</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    energypath_nc = trim(cs%energyfile) // <span class="stringliteral">&quot;.nc&quot;</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">if</span> (day &gt; cs%Start_time) <span class="keywordflow">then</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      <span class="keyword">call </span>reopen_file(cs%fileenergy_nc, trim(energypath_nc), vars, &amp;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                       num_nc_fields, cs%fields, single_file, cs%timeunit, &amp;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                       g=g, gv=gv)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      <span class="keyword">call </span>create_file(cs%fileenergy_nc, trim(energypath_nc), vars, &amp;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                       num_nc_fields, cs%fields, single_file, cs%timeunit, &amp;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                       g=g, gv=gv)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    lbelow = 1 ; volbelow = 0.0</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;      volbelow = volbelow + vol_lay(k)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      <span class="keywordflow">if</span> ((volbelow &gt;= cs%DL(cs%lH(k))%vol_below) .and. &amp;</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;          (volbelow &lt; cs%DL(cs%lH(k)+1)%vol_below)) <span class="keywordflow">then</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        l = cs%lH(k)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        labove=cs%list_size+1</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        l = (labove + lbelow) / 2</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        <span class="keywordflow">do</span> <span class="keywordflow">while</span> (l &gt; lbelow)</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;          <span class="keywordflow">if</span> (volbelow &lt; cs%DL(l)%vol_below) <span class="keywordflow">then</span> ; labove = l</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;          <span class="keywordflow">else</span> ; lbelow = l ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;          l = (labove + lbelow) / 2</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        cs%lH(k) = l</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      lbelow = l</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      h_0ape(k) = cs%DL(l)%depth - (volbelow - cs%DL(l)%vol_below) / cs%DL(l)%area</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    h_0ape(nz+1) = cs%DL(2)%depth</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; h_0ape(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">! Calculate the Kinetic Energy integrated over each layer.</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  tmp1(:,:,:) = 0.0</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    tmp1(i,j,k) = (0.25 * h_to_kg_m2 * (areatm(i,j) * h(i,j,k))) * &amp;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            (u(i-1,j,k)**2 + u(i,j,k)**2 + v(i,j-1,k)**2 + v(i,j,k)**2)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="comment">!   Calculate the Available Potential Energy integrated over each</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment">! interface.  With a nonlinear equation of state or with a bulk</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">! mixed layer this calculation is only approximate.</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keywordflow">do</span> k=1,nz+1 ; pe(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) <span class="keywordflow">then</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    pe_pt(:,:,:) = 0.0</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        hbelow = 0.0</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;          hbelow = hbelow + h(i,j,k) * h_to_m</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;          hint = (h_0ape(k) + hbelow - g%bathyT(i,j))</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;          hbot = h_0ape(k) - g%bathyT(i,j)</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          hbot = (hbot + abs(hbot)) * 0.5</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;          pe_pt(i,j,k) = 0.5 * areatm(i,j) * (gv%Rho0*gv%g_prime(k)) * &amp;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                  (hint * hint - hbot * hbot)</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        hbelow = 0.0</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;          hint = h_0ape(k) + eta(i,j,k)  <span class="comment">! eta and H_0 have opposite signs.</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;          hbot = max(h_0ape(k) - g%bathyT(i,j), 0.0)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;          pe_pt(i,j,k) = 0.5 * (areatm(i,j) * (gv%Rho0*gv%g_prime(k))) * &amp;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                  (hint * hint - hbot * hbot)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  ke_tot = reproducing_sum(tmp1, sums=ke)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  pe_tot = 0.0</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="keywordflow">if</span> (cs%do_APE_calc) &amp;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    pe_tot = reproducing_sum(pe_pt, sums=pe)</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  toten = ke_tot + pe_tot</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  salt = 0.0 ; heat = 0.0</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    temp_int(:,:) = 0.0 ; salt_int(:,:) = 0.0</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      salt_int(i,j) = salt_int(i,j) + tv%S(i,j,k) * &amp;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                      (h(i,j,k)*(h_to_kg_m2 * areatm(i,j)))</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      temp_int(i,j) = temp_int(i,j) + (tv%C_p * tv%T(i,j,k)) * &amp;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                      (h(i,j,k)*(h_to_kg_m2 * areatm(i,j)))</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    salt = reproducing_sum(salt_int, efp_sum=salt_efp)</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    heat = reproducing_sum(temp_int, efp_sum=heat_efp)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">! Calculate the maximum CFL numbers.</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  max_cfl(1:2) = 0.0</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <span class="keywordflow">if</span> (u(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      cfl_trans = (-u(i,j,k) * cs%dt) * (g%dy_Cu(i,j) * g%IareaT(i+1,j))</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;      cfl_trans = (u(i,j,k) * cs%dt) * (g%dy_Cu(i,j) * g%IareaT(i,j))</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    cfl_lin = abs(u(i,j,k) * cs%dt) * g%IdxCu(i,j)</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    max_cfl(1) = max(max_cfl(1), cfl_trans)</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    max_cfl(2) = max(max_cfl(2), cfl_lin)</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">if</span> (v(i,j,k) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;      cfl_trans = (-v(i,j,k) * cs%dt) * (g%dx_Cv(i,j) * g%IareaT(i,j+1))</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;      cfl_trans = (v(i,j,k) * cs%dt) * (g%dx_Cv(i,j) * g%IareaT(i,j))</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    cfl_lin = abs(v(i,j,k) * cs%dt) * g%IdyCv(i,j)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    max_cfl(1) = max(max_cfl(1), cfl_trans)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    max_cfl(2) = max(max_cfl(2), cfl_lin)</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keyword">call </span>sum_across_pes(cs%ntrunc)</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  <span class="comment">!   Sum the various quantities across all the processors.  This sum is NOT</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  <span class="comment">! guaranteed to be bitwise reproducible, even on the same decomposition.</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  <span class="comment">!   The sum of Tr_stocks should be reimplemented using the reproducing sums.</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  <span class="keywordflow">if</span> (ntr_stocks &gt; 0) <span class="keyword">call </span>sum_across_pes(tr_stocks,ntr_stocks)</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  <span class="keyword">call </span>max_across_pes(max_cfl(1))</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="keyword">call </span>max_across_pes(max_cfl(2))</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature .and. cs%previous_calls == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    cs%salt_prev = salt ; cs%net_salt_input = 0.0</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    cs%heat_prev = heat ; cs%net_heat_input = 0.0</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    cs%salt_prev_EFP = salt_efp ; cs%net_salt_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    cs%heat_prev_EFP = heat_efp ; cs%net_heat_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  irho0 = 1.0/gv%Rho0</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    salt_chg_efp = salt_efp - cs%salt_prev_EFP</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    salt_anom_efp = salt_chg_efp - cs%net_salt_in_EFP</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    salt_chg = efp_to_real(salt_chg_efp) ; salt_anom = efp_to_real(salt_anom_efp)</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    heat_chg_efp = heat_efp - cs%heat_prev_EFP</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    heat_anom_efp = heat_chg_efp - cs%net_heat_in_EFP</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    heat_chg = efp_to_real(heat_chg_efp) ; heat_anom = efp_to_real(heat_anom_efp)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  mass_chg_efp = mass_efp - cs%mass_prev_EFP</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  salin_mass_in = 0.0</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    mass_anom_efp = mass_chg_efp - cs%fresh_water_in_EFP</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="comment">! net_salt_input needs to be converted from psu m s-1 to kg m-2 s-1.</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    mass_anom_efp = mass_chg_efp - cs%fresh_water_in_EFP</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) &amp;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      salin_mass_in = 0.001*efp_to_real(cs%net_salt_in_EFP)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  mass_chg = efp_to_real(mass_chg_efp)</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  mass_anom = efp_to_real(mass_anom_efp) - salin_mass_in</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    salin = salt / mass_tot ; salin_anom = salt_anom / mass_tot</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;   <span class="comment">! salin_chg = Salt_chg / mass_tot</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    temp = heat / (mass_tot*tv%C_p) ; temp_anom = heat_anom / (mass_tot*tv%C_p)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  en_mass = toten / mass_tot</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="keyword">call </span>get_time(day, start_of_day, num_days)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  date_stamped = (cs%date_stamped_output .and. (get_calendar_type() /= no_calendar))</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  <span class="keywordflow">if</span> (date_stamped) &amp;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keyword">call </span>get_date(day, iyear, imonth, iday, ihour, iminute, isecond, itick)</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="keywordflow">if</span> (abs(cs%timeunit - 86400.0) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    reday = <span class="keywordtype">REAL</span>(num_days)+ (<span class="keywordtype">REAL</span>(start_of_day)/86400.0)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    mesg_intro = <span class="stringliteral">&quot;MOM Day &quot;</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    reday = <span class="keywordtype">REAL</span>(num_days)*(86400.0/cs%timeunit) + &amp;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;            <span class="keywordtype">REAL</span>(start_of_day)/abs(cs%timeunit)</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    mesg_intro = <span class="stringliteral">&quot;MOM Time &quot;</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <span class="keywordflow">if</span> (reday &lt; 1.0e8) <span class="keywordflow">then</span> ;      <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(F12.3)&#39;</span>) reday</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordflow">elseif</span> (reday &lt; 1.0e11) <span class="keywordflow">then</span> ; <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(F15.3)&#39;</span>) reday</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  <span class="keywordflow">else</span> ;                         <span class="keyword">write</span>(day_str, <span class="stringliteral">&#39;(ES15.9)&#39;</span>) reday ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordflow">if</span>     (n &lt; 1000000)   <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I6)&#39;</span>)  n</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  <span class="keywordflow">elseif</span> (n &lt; 10000000)  <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I7)&#39;</span>)  n</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  <span class="keywordflow">elseif</span> (n &lt; 100000000) <span class="keywordflow">then</span> ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I8)&#39;</span>)  n</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="keywordflow">else</span>                        ; <span class="keyword">write</span>(n_str, <span class="stringliteral">&#39;(I10)&#39;</span>) n ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keywordflow">if</span> (date_stamped) <span class="keywordflow">then</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keyword">write</span>(date_str,<span class="stringliteral">&#39;(&quot;MOM Date&quot;,i7,2(&quot;/&quot;,i2.2),&quot; &quot;,i2.2,2(&quot;:&quot;,i2.2))&#39;</span>) &amp;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;       iyear, imonth, iday, ihour, iminute, isecond</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    date_str = trim(mesg_intro)//trim(day_str)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; &quot;,A,&quot;: En &quot;,ES12.6, &quot;, MaxCFL &quot;, F8.5, &quot;, Mass &quot;, &amp;</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp; ES18.12, &quot;, Salt &quot;, F15.11,&quot;, Temp &quot;, F15.11)&#39;</span>) &amp;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;          trim(date_str), trim(n_str), en_mass, max_cfl(1), mass_tot, salin, temp</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; &quot;,A,&quot;: En &quot;,ES12.6, &quot;, MaxCFL &quot;, F8.5, &quot;, Mass &quot;, &amp;</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                &amp; ES18.12)&#39;</span>) &amp;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;          trim(date_str), trim(n_str), en_mass, max_cfl(1), mass_tot</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A,&quot;,&quot;,A,&quot;,&quot;, I6,&quot;, En &quot;,ES18.12, &amp;</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;&quot;, CFL &quot;, F8.5, &quot;, SL &quot;,&amp;</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;es11.4,&quot;, M &quot;,ES11.5,&quot;, S&quot;,f8.4,&quot;, T&quot;,f8.4,&amp;</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                               &amp;&quot;, Me &quot;,ES9.2,&quot;, Se &quot;,ES9.2,&quot;, Te &quot;,ES9.2)&#39;</span>) &amp;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            trim(n_str), trim(day_str), cs%ntrunc, en_mass, max_cfl(1), &amp;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            -h_0ape(1), mass_tot, salin, temp, mass_anom/mass_tot, salin_anom, &amp;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            temp_anom</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      <span class="keyword">write</span>(cs%fileenergy_ascii,<span class="stringliteral">&#39;(A,&quot;,&quot;,A,&quot;,&quot;, I6,&quot;, En &quot;,ES18.12, &amp;</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                                &amp;&quot;, CFL &quot;, F8.5, &quot;, SL &quot;,&amp;</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="stringliteral"></span><span class="stringliteral">                                  &amp;ES11.4,&quot;, Mass &quot;,ES11.5,&quot;, Me &quot;,ES9.2)&#39;</span>) &amp;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;            trim(n_str), trim(day_str), cs%ntrunc, en_mass, max_cfl(1), &amp;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;            -h_0ape(1), mass_tot, mass_anom/mass_tot</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <span class="keywordflow">if</span> (cs%ntrunc &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(A,&quot; Energy/Mass:&quot;,ES12.5,&quot; Truncations &quot;,I0)&#39;</span>) &amp;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        trim(date_str), en_mass, cs%ntrunc</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="keywordflow">if</span> (cs%write_stocks) <span class="keywordflow">then</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Energy: &quot;,Z16.16,ES24.16)&#39;</span>) toten, toten</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;      <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Mass: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;            mass_tot, mass_chg, mass_anom, mass_anom/mass_tot</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;      <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="keywordflow">if</span> (salt == 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Salt: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5)&#39;</span>) &amp;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;              salt*0.001, salt_chg*0.001, salt_anom*0.001</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Salt: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;              salt*0.001, salt_chg*0.001, salt_anom*0.001, salt_anom/salt</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <span class="keywordflow">if</span> (heat == 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Heat: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5)&#39;</span>) &amp;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;              heat, heat_chg, heat_anom</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;          <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;    Total Heat: &quot;,ES24.16,&quot;, Change: &quot;,ES24.16,&quot; Error: &quot;,ES12.5,&quot; (&quot;,ES8.1,&quot;)&quot;)&#39;</span>) &amp;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;              heat, heat_chg, heat_anom, heat_anom/heat</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;      <span class="keywordflow">do</span> m=1,ntr_stocks</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;         <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(&quot;      Total &quot;,a,&quot;: &quot;,ES24.16,X,a)&#39;</span>) &amp;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;              trim(tr_names(m)), tr_stocks(m), trim(tr_units(m))</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;         <span class="keywordflow">if</span>(tr_minmax_got(m)) <span class="keywordflow">then</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;           <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(64X,&quot;Global Min:&quot;,ES24.16,X,&quot;at: (&quot;, f7.2,&quot;,&quot;f7.2,&quot;,&quot;f8.2,&quot;)&quot;  )&#39;</span>) &amp;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                tr_min(m),tr_min_x(m),tr_min_y(m),tr_min_z(m)</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;           <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(64X,&quot;Global Max:&quot;,ES24.16,X,&quot;at: (&quot;, f7.2,&quot;,&quot;f7.2,&quot;,&quot;f8.2,&quot;)&quot;  )&#39;</span>) &amp;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                tr_max(m),tr_max_x(m),tr_max_y(m),tr_max_z(m)</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  var = <span class="keywordtype">real</span>(cs%ntrunc)</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(1), var, reday)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(2), toten, reday)</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(3), pe, reday)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(4), ke, reday)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(5), h_0ape, reday)</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(6), mass_lay, reday)</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(7), mass_tot, reday)</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(8), mass_chg, reday)</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(9), mass_anom, reday)</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(10), max_cfl(1), reday)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(11), max_cfl(1), reday)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(12), 0.001*salt, reday)</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(13), 0.001*salt_chg, reday)</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(14), 0.001*salt_anom, reday)</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(15), heat, reday)</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(16), heat_chg, reday)</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(17), heat_anom, reday)</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="keywordflow">do</span> m=1,ntr_stocks</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;      <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(17+m), tr_stocks(m), reday)</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keywordflow">do</span> m=1,ntr_stocks</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      <span class="keyword">call </span>write_field(cs%fileenergy_nc, cs%fields(11+m), tr_stocks(m), reday)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  <span class="keyword">call </span>flush_file(cs%fileenergy_nc)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <span class="comment">! The second (impossible-looking) test looks for a NaN in En_mass.</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  <span class="keywordflow">if</span> ((en_mass&gt;cs%max_Energy) .or. &amp;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;     ((en_mass&gt;cs%max_Energy) .and. (en_mass&lt;cs%max_Energy))) <span class="keywordflow">then</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    day = cs%Huge_time</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="keyword">write</span>(mesg,<span class="stringliteral">&#39;(&quot;Energy per unit mass of &quot;,ES11.4,&quot; exceeds &quot;,ES11.4)&#39;</span>) &amp;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                  en_mass, cs%max_Energy</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;write_energy : &quot;</span>//trim(mesg))</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keyword">call </span>mom_error(warning, &amp;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      <span class="stringliteral">&quot;write_energy : Time set to a large value to force model termination.&quot;</span>)</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="keywordflow">if</span> (cs%ntrunc&gt;cs%maxtrunc) <span class="keywordflow">then</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    day = cs%Huge_time</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;write_energy : Ocean velocity has been truncated too many times.&quot;</span>)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  cs%ntrunc = 0</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  cs%previous_calls = cs%previous_calls + 1</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  cs%mass_prev = mass_tot ; cs%fresh_water_input = 0.0</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    cs%salt_prev = salt ; cs%net_salt_input = 0.0</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    cs%heat_prev = heat ; cs%net_heat_input = 0.0</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  cs%mass_prev_EFP = mass_efp ; cs%fresh_water_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;  <span class="keywordflow">if</span> (cs%use_temperature) <span class="keywordflow">then</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    cs%salt_prev_EFP = salt_efp ; cs%net_salt_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    cs%heat_prev_EFP = heat_efp ; cs%net_heat_in_EFP = real_to_efp(0.0)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="keywordflow">  endif</span></div><div class="ttc" id="structmom__grid_1_1ocean__grid__type_html"><div class="ttname"><a href="structmom__grid_1_1ocean__grid__type.html">mom_grid::ocean_grid_type</a></div><div class="ttdoc">Ocean grid type. See mom_grid for details. </div><div class="ttdef"><b>Definition:</b> <a href="MOM__grid_8F90_source.html#l00019">MOM_grid.F90:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_aef94e597f85f3ee439b2ddc2b46a043a_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="namespacemom__sum__output_aef94e597f85f3ee439b2ddc2b46a043a_icgraph.svg" width="308" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a5191c3198dcd24f50da9279ce7ebbc60"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5191c3198dcd24f50da9279ce7ebbc60">&#9670;&nbsp;</a></span>num_fields</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_sum_output::num_fields = 17</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="MOM__sum__output_8F90_source.html#l00085">85</a> of file <a class="el" href="MOM__sum__output_8F90_source.html">MOM_sum_output.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: num_fields = 17</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemom__sum__output.html">mom_sum_output</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
