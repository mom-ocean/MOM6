<?xml version="1.0"?>
<!-- FRE Usage documentation: http://www.gfdl.noaa.gov/fms/fre -->
<!-- $Id: OM4.xml,v 1.1.2.12.2.6.2.3 2014/05/23 19:37:49 Niki.Zadeh Exp $ -->
<!DOCTYPE setup [
<!ENTITY ROOT_LOCATION "/lustre/f1/unswept">
<!ENTITY ARCH_LOCATION "/lustre/f1">
]>

<!--
Quick start guide

module load fre/bronx-7
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_libs_compile -no-link
   To run with SIS
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS_baseline -r basic 
   To run with SIS2
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS2_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS2_baseline -r basic 


-->

<experimentSuite rtsVersion="4" xmlns:xi="http://www.w3.org/2001/XInclude">
   <property name="RELEASE"      value="tikal_201409"/> <!-- CVS tag for shared source code -->
   <property name="MOM6_DATE"    value="2014.09.23"/>     <!-- git tag date for MOM6 source code -->
     <property name="FRE_STEM"  value="testing_mom6_20141008"/>
   <!--property name="FRE_STEM"     value="$(RELEASE)_mom6_$(MOM6_DATE)"/-->
   <property name="MOM6_GIT_TAG" value="dev/master/$(MOM6_DATE)"/> <!-- git tag for MOM6 source code -->
   <property name="SIS2_GIT_TAG" value="dev/master/$(MOM6_DATE)"/> <!-- git tag for SIS2 source code -->
   <property name="FRE_VERSION"  value="fre/bronx-7"/>

   <!--Production run properties. Users can modify these according to their need and/or performance analysis-->
   <property name="PROD_SIMTIME"   value="4"/>
   <!-- Post-processing start date and chunk lengths -->
   <property name="PP_START_YEAR"  value="1900"/>
   <property name="PP_END_YEAR"    value="1919"/>
   <property name="CHUNK_LENGTH_A" value="2yr"/>
   <property name="CHUNK_LENGTH_B" value="4yr"/>
   <property name="ANALYSIS_SWITCH" value="on"/>

   <property name="PROD_RUNTIME"         value="16:00:00"/>
   <property name="PROD_SEGTIME"         value="03:45:00"/>
   <property name="PROD_NPES"            value="2997"/> 
<!-- Not used anymore
   <property name="MASK_TABLE"           value="mask_table.1053.90x45"/>
   <property name="OCN_PROD_LAYOUT"      value="90,45"/>
   <property name="OCN_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="ICE_PROD_LAYOUT"      value="90,45"/>
   <property name="ICE_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="LND_PROD_LAYOUT"      value="90,45"/>
   <property name="FV_PROD_LAYOUT"       value="90,45"/>
-->  


   <!--Users need not change the following properties -->
   <property name="reference_tag"  value="tikal_201406"/> <!-- Reference release tag for existing files in the archives for answer comparison. Used in "REFERENCE" property. -->
   <property name="PROG_MAIN"   value="coupler/coupler_main.o"/>
   <property name="LIBS_ROOT"   value="MOM6_SIS_libs_compile"/>
   <property name="FMS_LIB_DIR" value="./$(LIBS_ROOT)/$(platform)-$(target)/exec"/>
   <property name="MOM6_SRC"    value="$root/$(LIBS_ROOT)/src/mom6"/> 

   <!-- The following properties are for testing/debugging purposes and should normally be empty-->
   <property name="MODIFIER"     value=""/>  
   <property name="DEBUGLEVEL"   value=""/>

   <setup>
    <!-- MDBI -->
    <fmsRelease>fmsversion</fmsRelease>
    <!-- /MDBI -->

<!-- ncrc platforms -->
	
    <platform name="ncrc2.intel">
      <project>gfdl_f</project>
      <directory stem="$(FRE_STEM)"/>
         <directory>
            <!--unswept locations-->
            <root>&ROOT_LOCATION;/$USER/$(FRE_STEM)</root>
            <scripts>&ROOT_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/scripts</scripts>
            <state>&ROOT_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/state</state>
            <!--swept locations (including the staged archive location)-->
            <archive>&ARCH_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)</archive>
            <stdout>&ARCH_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/stdout</stdout>
            <work>&ARCH_LOCATION;/$USER/work/$(FRE_STEM)/$FRE_JOBID</work>
         </directory>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands
          module load PrgEnv-intel
          module swap intel intel/12.0.5.220
          module load git
          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
     ]]></csh>

     <property name="NCRC_PLATFORM"    value="$(platform)"/>
     <property name="GFDL_PLATFORM"    value="gfdl"/>
     <property name="SGI_FLAGS"        value=""/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -g -traceback"/> <!-- -g -traceback -->
     <property name="TAREXT"           value="tar"/>
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>

    <platform name="ncrc2.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='ncrc2.intel']/node())" />
    </platform>

    <platform name="ncrc2.pgi">
      <project>gfdl_o</project>
      <directory stem="$(FRE_STEM)"/>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands
          module load git
          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
     ]]></csh>

     <property name="NCRC_PLATFORM"    value="$(platform)"/>
     <property name="GFDL_PLATFORM"    value="gfdl"/>
     <property name="SGI_FLAGS"        value=""/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -g -traceback"/> <!-- -g -traceback -->
     <property name="TAREXT"           value="tar"/>
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>
<!-- gfdl platforms -->

    <platform name="gfdl.ncrc2-intel">
     <property name="NB_ROOT"      value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
     <directory stem="$(FRE_STEM)">
     <!-- MDBI requires these to be listed in order to show the path under "Platform Environment" -->
        <archive>$ARCHIVE/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)</archive>
        <analysis>$(NB_ROOT)</analysis>
        <ptmp>/ptmp/$USER</ptmp>
     <!-- /MDBI -->
     </directory>
     <property name="F2003_FLAGS"   value=""/>
     <property name="TAREXT"        value="tar"/>
     <property name="GFDL_PLATFORM" value="gfdl"/>
     <property name="NCRC_PLATFORM" value="ncrc2"/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
        <csh><![CDATA[
           source $MODULESHOME/init/csh
           module use -a /home/John.Krasting/local/modulefiles
           module purge
           module load jpk-analysis/0.0.4
           module load $(FRE_VERSION)
           module load git
           #Some tricks to use the refineDiag and analysis scripts from a checkout of MOM6 at gfdl 
           setenv FREVERSION $(FRE_VERSION)           
           setenv NBROOT $(NB_ROOT)
           mkdir -p $NBROOT
           cd $NBROOT
/home/Niki.Zadeh/bin/git_clone_mom6_fix.csh 
         ]]></csh>
<!--The following are not used, but needed by fre -->
     <property name="SGI_FLAGS" value=""/>
     <property name="REFERENCE" value=""/>
    </platform>

    <platform name="gfdl.ncrc2-default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.ncrc2-intel']/node())" />
    </platform>
    <platform name="gfdl.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.ncrc2-intel']/node())" />
    </platform>

</setup>

   <property name="MY_LIBS"     value="$(MY_ROOT)/$(FMS_LIB_DIR)"/>

   <experiment name="MOM6_SIS_libs_compile">
      <description>
Make the executable for ocean-ice experiments.
      </description>
      <component name="fms" paths="shared" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <source>
            <codeBase version="$(RELEASE)"> shared </codeBase>
         </source>
         <compile>
            <cppDefs>-Duse_libMPI -Duse_netCDF $(F2003_FLAGS)</cppDefs>
         </compile>
         <!-- MDBI --> 
         <description domainName="infrastructure" communityName="FMS" communityVersion="$(RELEASE)" communityGrid="NA"/>
      </component>

      <component name="mom6" requires="fms" paths="mom6/config_src/dynamic mom6/config_src/coupled_driver mom6/src/*/ mom6/src/*/*/">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/github_mirror">
            <codeBase version="$(MOM6_GIT_TAG)"> noaa-gfdl-mom6.git </codeBase>
            <csh> mv noaa-gfdl-mom6 mom6 </csh>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]> </cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="Ocean" communityName="GFDL-MOM6" communityVersion="$(MOM6_GIT_TAG)" communityGrid="Tripolar"/>
      </component>

<!--Since SIS2 needs ice_param there is a dependency that may damage the compile if bith ice_sis and sis2 try to cvs co ice_params at the same time. We should put ice_param files under sis2 git 
-->
      <component name="sis2" paths="sis2/ ice_param" requires="fms mom6" includeDir="$root/$(LIBS_ROOT)/src/mom6/src/framework" > 
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/github_mirror">
	   <codeBase version="$(SIS2_GIT_TAG)"> noaa-gfdl-sis2.git </codeBase> 
            <csh> mv noaa-gfdl-sis2 sis2 ; cvs co -r $(RELEASE) ice_param </csh> 
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]>
            </cppDefs>
         </compile>
      </component>

      <component name="ice_sis" paths="ice_param ice_sis" requires="fms">   
         <source>
            <codeBase version="$(RELEASE)"> ice_param ice_sis </codeBase>
         </source>
         <compile>
            <cppDefs>$(F2003_FLAGS)</cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="Sea Ice SIS" communityName="GFDL-SIS" communityVersion="$(RELEASE)" communityGrid="Tripolar"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <source>
            <codeBase version="$(RELEASE)"> land_null </codeBase>
         </source>
         <!-- MDBI -->
         <description domainName="NA" communityName="NA" communityVersion="NA" communityGrid="NA"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
         <source>
            <codeBase version="$(RELEASE)"> atmos_null atmos_param/{monin_obukhov,diag_integral} </codeBase>
         </source>
         <!-- MDBI -->
         <description domainName="NA" communityName="NA" communityVersion="NA" communityGrid="NA"/>
      </component>
   </experiment>

   <experiment name="MOM6_SIS_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="mom6" requires="fms" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="ice_sis" requires="fms" name="ice_sis">
         <library path="$(MY_LIBS)/ice_sis/libice_sis.a" headerDir="$(MY_LIBS)/ice_sis"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null ice_sis mom6">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/>      </component>
   </experiment>
    <experiment name="MOM6_SIS2_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="mom6" requires="fms" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="sis2" requires="fms" name="sis2">
         <library path="$(MY_LIBS)/sis2/libsis2.a" headerDir="$(MY_LIBS)/sis2"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null sis2 mom6">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
            <csh>
              #(cd coupler; git checkout user/nnz/merge_bobs_into_tikal) !not needed in ulm
            </csh>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/>      </component>
   </experiment>


<experiment name="OM4_SIS_baseline" inherit="MOM6_SIS_compile">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z test case
</description>  
<!-- MDBI --> 
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
<!-- /MDBI -->

     <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

      <!--MOM6 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_data']/input/node())"/>
      <!--SIS Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='SIS_data']/input/node())"/>
      <!--OM4 gridSpec mosaic datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_grid']/input/node())"/>
      <!--CORE forcing datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='CORE_data']/input/node())"/>

      <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/input.nml</dataSource>
      </dataFile>
      <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/field_table</dataSource>
      </dataFile>


      <diagTable>
$name
$baseDate
      </diagTable>


      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>

     <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = $domains_stack_size
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .true. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>

     <namelist name="atmos_model_nml" >
       layout=$fv_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$land_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>

   
   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"  npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
         <run days="10"   npes="576"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="timing">
         <run days="10"   npes="576"   runTimePerJob="00:30:00"/>
         <run days="10"   npes="1152"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="2304"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="3240"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="2432"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="36days">
         <run days="36"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2997pe/restart/19000111.$(TAREXT)"/>

   </runtime>
    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>

  </experiment>

  <experiment name="OM4_domain_decomp">
    <input>
      <csh><![CDATA[
set domains_stack_size = "3097152"

if ( "$npes" == "288" ) then
  set fv_layout    =   "24,12"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,12"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,12"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "24,12"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "288"

else if ( "$npes" == "512" ) then
  set fv_layout    =   "32,16"; set fv_io_layout    =  "8,4"
  set land_layout  =   "32,16"; set land_io_layout  =  "8,4"
  set ice_layout   =   "32,16"; set ice_io_layout   =  "8,4"
  set ocn_layout   =   "0,0"  ; set ocn_io_layout   =  "1,1"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "512"

else if ( "$npes" == "576" ) then
  set fv_layout    =   "24,24"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,24"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,24"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "0,0"  ; set ocn_io_layout   =  "1,1"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "576"

else if ( "$npes" == "1152" ) then
  set fv_layout    =   "32,36"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,36"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,36"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,36"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "1152"
#npes= 1152  main_loop= 1085.141626  ATM= 47.583859  OCN= 1036.583676  SYPD= 2.1814

else if ( "$npes" == "2304" ) then
  set fv_layout    =   "32,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "2304"
#npes= 2304  main_loop= 603.878142  ATM= 37.217106  OCN= 565.590432  SYPD= 3.91987


else if ( "$npes" == "3240" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "3240"
#npes= 3240  main_loop= 464.708698  ATM= 39.759137  OCN= 423.801078  SYPD= 5.09378

else if ( "$npes" == "2432" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "mask_table.808.45x72"
  set do_ocean = "true"
  set ocean_npes   = "2432"
#npes= 2432  main_loop= 458.382556  ATM= 33.484085  OCN= 423.827549  SYPD= 5.16408

else if ( "$npes" == "4050" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "4050"

else if ( "$npes" == "2997" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "mask_table.1053.90x45"
  set do_ocean = "true"
  set ocean_npes   = "2997"
#npes= 2997  main_loop= 395.756260  ATM= 33.947977  OCN= 361.032958  SYPD= 5.98127

else
  if ( $echoOn ) unset echo
  echo "*ERROR*: npes == '$npes' is not supported in this xml."
  if ( $echoOn ) set echo
  exit 1
endif

cat > $work/INPUT/MOM_layout << LAYOUT_EOF
#override undef NIPROC
#override undef NJPROC
#override undef NIPROC_IO
#override undef NJPROC_IO
#override LAYOUT = $ocn_layout
#override IO_LAYOUT = $ocn_io_layout
MASKTABLE = $ocn_mask_table
LAYOUT_EOF

cat > $work/INPUT/SIS_layout << LAYOUT_EOF
#override undef NIPROC
#override undef NJPROC
#override undef NIPROC_IO
#override undef NJPROC_IO
#override LAYOUT = $ice_layout
#override IO_LAYOUT = $ice_io_layout
MASKTABLE = $ocn_mask_table
LAYOUT_EOF

# runCommand:
  alias runCommand "aprun -n $ocean_npes -d 1 ./$executable:t"
      ]]></csh>

    </input>
  </experiment>

  <experiment name="OM4_grid">
    <input>
      <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/OM4_025/mosaic.v20140610.unpacked/grid_spec.nc</dataSource> 
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/land_mask.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_hgrid.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_mask.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_mosaic.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_topog.nc</dataSource>
       <!--hsmget cannot get this  <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/topog.nc</dataSource> -->
      </dataFile>
    </input>
  </experiment>

      <!--OM4 CORE forcing datasets-->
  <experiment name="CORE_data">
    <input>
      <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/data_table</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ncar_precip.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ncar_rad.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/q_10_mod.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/runoff.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/salt_restore.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/slp.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/t_10_mod.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/u_10_mod.clim.nc</dataSource>
      </dataFile>      
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/v_10_mod.clim.nc</dataSource>
      </dataFile>
    </input>
  </experiment>
  
  <experiment name="OM4_data">
    <input>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/MOM_input</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/MOM_saltrestore</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/layer_coord.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/seawifs_1998-2006_smoothed_2X.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/tidal_amplitude.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/MOM_channels_global_025</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/vgrid_75_2m.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/WOA05_pottemp_salt.nc </dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/mask_table.808.45x72</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/mask_table.1053.90x45</dataSource>
      </dataFile>      
      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
      </dataFile>

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_saltrestore','INPUT/MOM_override'
     </namelist>

     <csh type="always"><![CDATA[
if ( $ireload == 1 ) then
 if ( $irun == 1 ) then
  set restart_flag = 'n'
 else
  set restart_flag = 'r'
 endif
else
  set restart_flag = 'r'
endif


ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc 

touch $work/INPUT/MOM_override
touch $work/INPUT/SIS_override

      ]]></csh>
 
     </input>

  </experiment>

  <experiment name="SIS_data">
    <input>

     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/diag_table.SIS</dataSource>
     </dataFile>

     <dataFile label="input" target="INPUT/ice_model.res.nc" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/.datasets/OM4_025/INPUT/ice_model.res.v20140620.nc</dataSource>
     </dataFile>
      
     <namelist name="ice_model_nml">
           layout = $ice_layout
           io_layout = $ice_io_layout
           mask_table='INPUT/$ocn_mask_table'
           nsteps_dyn=144
           nsteps_adv=2
           num_part = 6
           wd_turn = 0.0
           spec_ice=.false.
           ice_bulk_salin = 0.05
           alb_sno = 0.85                    ! keep CM2 setting
           alb_ice = 0.65                    ! keep CM2 setting
           t_range_melt = 1.0                ! NOTE: CM2 uses 1.0
           heat_rough_ice = 5.0e-4
           cm2_bugs = .false.
           do_icebergs = .false.
           add_diurnal_sw = .true.
           do_ice_limit=.false.
           max_ice_limit=4.0
           channel_viscosity=5.e5
           h_lo_lim = 1.e-10
      </namelist>

     </input>
  </experiment>

  <experiment name="SIS2_data">
    <input>

     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS2/OM4_025/diag_table.SIS</dataSource>
     </dataFile>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/OM4_025/SIS_input</dataSource>
     </dataFile>

<!-- No init ice yet
     <dataFile label="input" target="INPUT/ice_model.res.nc" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/.datasets/OM4_025/INPUT/ice_model.res.v20140620.nc</dataSource>
     </dataFile>
-->
     <namelist name="SIS_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/SIS_input','INPUT/SIS_layout','INPUT/SIS_override'
     </namelist>

     </input>
  </experiment>

  <!-- OCEAN  and ICE post-processing-->
  <experiment name="OM4_postprocess">

      <postProcess> 
         <csh><![CDATA[
         cd $work/RESTART
         ncrcat icebergs.res.nc.* icebergs.res.nc
         if(-e icebergs.res.nc) rm -f icebergs.res.nc.*
         cd $work
         ncrcat iceberg_trajectories.nc.* iceberg_trajectories.nc
         rm -f iceberg_trajectories.nc.* 
         #Save the last line of timestats without the first (step number) column as a signature of MOM6 answers
         tail -1 timestats | cut -c8- > RESTART/$enddate.timestats.res
         #Save the whole timestats under ascii/
         mv timestats $enddate.timestats
         mv timestats.nc $enddate.timestats.nc

         #Make a directory to trick FRE to pick up and archive in ascii
         mkdir extra.results

         mv *velocity_truncations CPU_stats MOM_parameter_doc* extra.results/

         ]]></csh>

      <!--REFINE DIAG SCRIP -->
      <!--By default a refineDiag script causes the annual data to be unpacked and saved in /ptmp/$USER-->
      <!--MOM6_refineDiag.csh is currently empty and is here only to cause the unpack annual history files in /ptmp-->
      <refineDiag script="$(NB_ROOT)/mom6/tools/analysis/MOM6_refineDiag.csh"/>
      <!--PostProcessing component models-->
      <component type="ocean_monthly"   start="$(PP_START_YEAR)" source="ocean_month">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)" source="ocean_month">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_monthly.frepp"/>
        </timeSeries>
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)" source="ocean_month">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_monthly.frepp"/>
        </timeSeries>
      </component>

      <component type="ocean_annual_z" start="$(PP_START_YEAR)" source="ocean_annual_z">
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_A)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_annual_z.frepp"/>
        </timeAverage>
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_B)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_annual_z.frepp"/>
        </timeAverage>

        <timeSeries freq="annual" chunkLength="$(CHUNK_LENGTH_B)" source="ocean_annual_z"/>
	
      </component>

      <component type="ocean_annual" start="$(PP_START_YEAR)"  source="ocean_annual"> 
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_A)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_annual.frepp"/>
        </timeAverage>
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_B)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/ocn_annual.frepp"/>
        </timeAverage>
      </component>

      <component type="ice"  start="$(PP_START_YEAR)"  source="ice_month">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)"  source="ice_month">
	   <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
	</timeSeries>   
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)"  source="ice_month">
           <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
        </timeSeries>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_A)"/>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_B)"/>
      </component>

      <!--The following mdbi_logger component is a trial to make the db ingestor run when the yearly data arrives
	  in order to update the "Monitoring" section of the DB.
	  The intention was not to do anything besides that update. We do not really want an annual timeseries.
	  But unfortunately frepp still tries to create a timeseries. -->
      <component type="mdbi_logger"   start="$(PP_START_YEAR)">  
        <timeSeries freq="annual"  chunkLength="1yr" source="ocean_annual">
         <variables>salt_flux</variables>
         <analysis switch="on" cumulative="no" script="$FRE_CURATOR_HOME/share/bin/database_ingestor.csh"/>
        </timeSeries>
      </component>

     </postProcess>

</experiment>

<experiment name="OM4_SIS_baseline_TEST" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="TEST" communityModel="OM4_SIS_baseline_TEST $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>
</experiment>

<experiment name="OM4_SIS2_baseline" inherit="MOM6_SIS2_compile">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS2 $(FRE_STEM)" communityModelID="OWG_OM4_SIS2" communityExperimentName="$(name)" >
 global 1/4 degree z test case
</description>  
<!-- MDBI --> 
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
<!-- /MDBI -->

     <input>

      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

      <!--MOM6 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_data']/input/node())"/>
      <!--SIS2 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='SIS2_data']/input/node())"/>
      <!--OM4 gridSpec mosaic datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_grid']/input/node())"/>
      <!--CORE forcing datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='CORE_data']/input/node())"/>

     
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/OM4_025/input.nml</dataSource>
     </dataFile>
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/OM4_025/field_table</dataSource>
     </dataFile>
      
      <diagTable>
$name
$baseDate
      </diagTable>

      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>


    <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = 8000000
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .true. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>

     <namelist name="atmos_model_nml" >
       layout=$fv_layout
!       mask_table='INPUT/$ocn_mask_table'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$land_layout
!       mask_table='INPUT/$ocn_mask_table'
     </namelist>

   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
         <run days="10"   npes="576"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="scaling">
         <run days="10"   npes="576"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="restart">
         <run days="14 14"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2996pe/restart/19000111.$(TAREXT)"/>

   </runtime>

    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>


</experiment>

<experiment name="OM4_SIS_noBG" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)">
 global 1/4 degree z  no background mixing , as in the CM2.5 
</description>
<!-- MDBI -->
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override HENYEY_IGW_BACKGROUND = False
#override KD = 1.0E-07
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p01" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.01
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.01
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p03" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.03
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.03
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p1" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.1  - really push the gustiness, 10x
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.1
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_linear" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z  KPP shape linear
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override KPP%NLT_SHAPE = "LINEAR"
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_200" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = default
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
#override RESOLN_SCALED_KHTH = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_res7_200" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = 0.7101
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
KH_RES_FN_POWER = 100
KH_RES_SCALE_COEF = 0.7101
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_res1_200" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = 1.0
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
KH_RES_FN_POWER = 100
KH_RES_SCALE_COEF = 1.0
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>


<experiment name="OM4_SIS_restrat_test" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>

   <input>
     
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh type="always">
        <![CDATA[
#===Have to repeat whatever is in the parent experiment===
if ( $ireload == 1 ) then
 if ( $irun == 1 ) then
  set restart_flag = 'n'
 else
  set restart_flag = 'r'
 endif
else
  set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

touch $work/INPUT/MOM_override

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
MIXEDLAYER_RESTRAT = True
FOX_KEMPER_ML_RESTRAT_COEF = 20.
OVERRIDE_EOF


#=========================================================
#Append to diag_table
#=======================
if ( $irun == 1 ) then
cat >> $work/diag_table << DIAG_EOF
#================
# Additional DIAGNOSTICS
#================
 "ocean_model", "MLD_restrat",      "MLD_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "uml_restrat",      "uml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "vml_restrat",      "vml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "udml_restrat",     "udml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "vdml_restrat",     "vdml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "uhml",             "uhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "vhml",             "vhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLu_restrat_time", "MLu_restrat_time", "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLv_restrat_time", "MLv_restrat_time", "ocean_month", "all", "mean", "none",2
DIAG_EOF

endif

       ]]>
      </csh>


   </input>
</experiment>


</experimentSuite>
